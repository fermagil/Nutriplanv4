**CONTEXTO CRÍTICO: PROYECTO WEB APP**

Acabas de cargar mi proyecto de Web App, que consta de 10 archivos HTML, CSS y JavaScript (algunos archivos HTML tienen el CSS y el JS embebidos).

**1. MI OBJETIVO PRINCIPAL:**
Mi objetivo principal es la **depuración, optimización y refactorización** de este código para prepararlo para producción.

**2. TU ROL:**
Tu rol es actuar como un **Ingeniero de Software Senior especializado en desarrollo Full-Stack con foco en rendimiento (performance) y seguridad web**.

**3. ESTADO ACTUAL Y REQUISITOS:**
* **Refactorización CRÍTICA:** Debes priorizar la **separación del código CSS y JavaScript** incrustado en los archivos HTML en sus propios archivos externos (`.css` y `.js` separados), para mejorar la **mantenibilidad** y el **caching** del navegador.
* **HTML/CSS:** Es la estructura visual. Busca errores de semántica y optimización de carga.
* **JavaScript:** Contiene la lógica principal de la aplicación.
* **Seguridad:** El proyecto usa AJAX y manipulación del DOM. Es crítico revisar vulnerabilidades comunes (especialmente XSS e inyección de datos).
* **Lenguaje:** Las respuestas deben ser siempre en español y mantener un tono profesional, claro y conciso.

**4. TAREA INICIAL (Tu primera respuesta):**
Antes de que te haga cualquier otra pregunta, quiero que me des un informe inicial de alto nivel (máximo 3 puntos) basado en la revisión de los 10 archivos. Enfócate en:

1.  **Potencial "smell code" (código con malos olores) / Redundancia:** ¿Ves alguna sección de código extremadamente redundante o que sugiera una estructura que necesita refactorizarse?
2.  **Riesgo de Seguridad Inmediato:** ¿Algún punto obvio de riesgo en la manipulación de datos de usuario en los JS?
Reglas Firestore: rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function estaAutenticado() { return request.auth != null; }

    // Funciona con custom claim O con UID → NUNCA FALLA
    function esEscolar() {
      return estaAutenticado() && (
        request.auth.uid == 'ojcP3xaAooOSqgxOA54ccRzXlZc2' ||
        request.auth.token.rol == 'salud_escolar'
      );
    }

    function esAdmin() {
      return estaAutenticado() && (
        request.auth.uid in ['jcgXyqse88bmO7DJ77sVAWKTq0y1', 'bohW6sxrEUWQtFJlkfv4InFfvKP2'] ||
        request.auth.token.rol == 'salud_escolar'
      );
    }

    match /{document=**} { allow read, write: if false; }

    match /clientes/{clienteId} {
      allow read, write: if estaAutenticado() && request.auth.uid == clienteId;
    }
    match /clientes/{clienteId}/tomas/{tomaId} {
      allow read, write: if estaAutenticado() && request.auth.uid == clienteId;
    }
    match /clientes/{clienteId}/fichaMedica/{document=**} {
      allow read, write: if estaAutenticado() && (request.auth.uid == clienteId || esAdmin());
    }
    match /usuarios/{usuarioId} {
      allow read: if estaAutenticado() && (request.auth.uid == usuarioId || esAdmin());
      allow write: if estaAutenticado() && request.auth.uid == usuarioId;
    }
    match /emails/{document=**} { allow read, write: if estaAutenticado(); }

    // SECURE FIX: Restricted write access to specific roles
    match /{surveyCollection}/{doc} {
      allow create, update: if esAdmin() || esEscolar();
      allow read: if estaAutenticado() || esEscolar();
      allow delete: if esAdmin();
    }

    match /{allPaths=**} {
      allow read, write, delete: if esAdmin();
    }
  }
}

SDK: // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyChC7s5NN-z-dSjqeXDaks7gaNaVCJAu7Q",
  authDomain: "nutriplanv2.firebaseapp.com",
  databaseURL: "https://nutriplanv2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "nutriplanv2",
  storageBucket: "nutriplanv2.firebasestorage.app",
  messagingSenderId: "653707489758",
  appId: "1:653707489758:web:9133d1d1620825c385ed4f",
  measurementId: "G-NWER69E8B6"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
3.  **Primeros pasos para la Separación:** Dada la estructura del código, ¿cuál es el **primer archivo HTML** que debo abordar para extraer el CSS y el JS?

**Confirma que has entendido el rol y estás listo para empezar el análisis con tu informe inicial.**



NutriPlan_v2/
├── index.html (archivo principal limpio)
├── assets/
│   ├── css/
│   │   ├── main.css
│   │   ├── components/
│   │   │   ├── modals.css
│   │   │   ├── tables.css
│   │   │   ├── forms.css
│   │   │   └── responsive.css
│   ├── js/
│   │   ├── core/
│   │   │   ├── auth.js
│   │   │   ├── calculations.js
│   │   │   ├── charts.js
│   │   │   └── utils.js
│   │   ├── modules/
│   │   │   ├── nutrition-plan.js
│   │   │   ├── macros-calculator.js
│   │   │   └── time-estimator.js
│   │   └── main.js




NutriPlan_v2/                          # RAÍZ DEL PROYECTO
├── index.html                         # Página principal (renombrado desde Inicio_NutriPlan_v2.html)
├── Valoracion_Antropometrica_1.html   # Mantener nombre original
├── Nutri_Plan_Advanced_v2.html        # Mantener nombre original  
├── Calculadora_keto_recetas.html      # Mantener nombre original
├── (otros 6 archivos HTML)            # Los demás archivos del proyecto
│
├── assets/                            # RECURSOS COMPARTIDOS POR TODOS LOS HTML
│   ├── css/
│   │   ├── main.css                   # Estilos globales y comunes
│   │   ├── components/                # Componentes reutilizables
│   │   │   ├── modals.css
│   │   │   ├── tables.css
│   │   │   ├── forms.css
│   │   │   ├── navigation.css
│   │   │   └── cards.css
│   │   └── pages/                     # Estilos específicos por página
│   │       ├── advanced-plan.css      # Para Nutri_Plan_Advanced_v2.html
│   │       ├── anthropometric.css     # Para Valoracion_Antropometrica_1.html
│   │       ├── calculator.css         # Para Calculadora_keto_recetas.html
│   │       └── (otros archivos).css
│   │
│   ├── js/
│   │   ├── core/                      # Librerías centrales compartidas
│   │   │   ├── auth.js                # Autenticación Firebase
│   │   │   ├── calculations.js        # Cálculos nutricionales
│   │   │   ├── charts.js              # Gráficos y visualizaciones
│   │   │   ├── utils.js               # Utilidades y sanitización
│   │   │   └── firebase-config.js     # Configuración Firebase
│   │   │
│   │   ├── modules/                   # Módulos específicos de funcionalidad
│   │   │   ├── nutrition-plan.js      # Planificación nutricional
│   │   │   ├── macros-calculator.js   # Cálculo de macronutrientes
│   │   │   ├── time-estimator.js      # Estimación temporal
│   │   │   ├── anthropometric-calc.js # Cálculos antropométricos
│   │   │   └── recipe-calculator.js   # Calculadora de recetas
│   │   │
│   │   └── pages/                     # Scripts específicos por página
│   │       ├── advanced-plan.js       # Para Nutri_Plan_Advanced_v2.html
│   │       ├── anthropometric.js      # Para Valoracion_Antropometrica_1.html
│   │       ├── calculator.js          # Para Calculadora_keto_recetas.html
│   │       └── (otros archivos).js
│   │
│   └── img/                           # Imágenes compartidas
│       ├── icons/
│       ├── charts/
│       └── backgrounds/

