// import { auth, db } from './firebase-config.js';  // Commented out for local file:/// testing
// --- Global variables ---
// Basic user data
let userAge = null;
let userGender = 'male';
let userHeightCm = null;
let userActivityLevel = 'sedentary';
let currentWeightKg = null;

// Calculated values from Step 1 & 2
let calculatedBMR = null;
let calculatedTDEE = null; // Total Daily Energy Expenditure (GET) from Step 1 
let targetWeightKgGlobal = null;
let goalTypeGlobal = 'maintenance'; // 'loss', 'gain', 'maintenance'
let estimatedWeeksGlobal = 0; // Automatically estimated weeks from Step 2 (for Step 5 table)
let targetWeeklyRateKgGlobal = 0; // Automatically estimated weekly rate from Step 2 (for Step 5 table)

// Calculated values from Step 3
let calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 };

// Calculated values from Step 6 (Manual Estimation)
let estimatedWeeksManualGlobal = null; // Weeks from manual estimation
let weightChangeGoalManualGlobal = null; // Weight change goal from manual estimation
let weeklyCalorieDiffManualGlobal = null; // Weekly calorie diff from manual estimation

// Chart instances
let macroChartInstance = null;
let weightEvolutionChartInstance = null; // For Step 2 chart
let timeEstimationChartInstance = null; // For Step 6 chart

// Activity multipliers (defined globally for reuse)
//const activityMultipliers = { sedentary: 1.2, light: 1.56, moderate: 1.78, active: 2.1, very_active: 2.3 };
//const activityMultipliers = userGender === 'male' ? [1.2, 1.56, 1.78, 2.1, 2.3] : [1.2, 1.55, 1.64, 1.82, 2];
// Define multiplicadores por g√©nero usando valores num√©ricos
const maleActivityMultipliers = {
    '1.2': 1.2,    // sedentary
    '1.375': 1.56, // light
    '1.55': 1.78,  // moderate
    '1.725': 2.1,  // active
    '1.9': 2.3     // very_active
};

const femaleActivityMultipliers = {
    '1.2': 1.2,    // sedentary
    '1.375': 1.55, // light
    '1.55': 1.64,  // moderate
    '1.725': 1.82, // active
    '1.9': 2.0     // very_active
};

// Selecciona el objeto seg√∫n el g√©nero
const activityMultipliers = userGender === 'male' ? maleActivityMultipliers : femaleActivityMultipliers;
// --- Wait for the DOM to be fully loaded ---
document.addEventListener('DOMContentLoaded', () => {

    // --- DOM Element References ---
    // Forms
    const calorieForm = document.getElementById('calorie-form');
    const weightGoalForm = document.getElementById('weight-goal-form');
    const macroForm = document.getElementById('macro-form');
    const mealForm = document.getElementById('meal-form');
    const timeEstimationForm = document.getElementById('time-estimation-form');
    // Buttons
    const calculateGoalButton = document.getElementById('calculate-goal-button');
    const calculateMacrosButton = document.getElementById('calculate-macros-button');
    const generateMealsButton = document.getElementById('generate-meals-button');
    const estimateTimeButton = document.getElementById('estimate-time-button');
    const generateHyperproteinButton = document.getElementById('generate-hyperprotein-button'); // Reference to the button
    const savePdfButton = document.getElementById('save-pdf-button');
    const btnCalculateProgress = document.getElementById('btn-calculate-progress');
    const btnExportProgress = document.getElementById('btn-export-progress');
    const logoutLink = document.getElementById('logout-link');
    // Percentage Inputs (for live update listeners)
    const macroPercentageInputs = document.querySelectorAll('#macro-percentage-inputs input[type="number"]');
    const mealPercentageInputs = document.querySelectorAll('#meal-percentage-inputs input[type="number"]');
    // Result Divs
    const calorieResultDiv = document.getElementById('calorie-result');
    const energyBalanceResultDiv = document.getElementById('energy-balance-result');
    const weightGoalResultDiv = document.getElementById('weight-goal-result');
    const weightChartContainer = document.getElementById('weight-chart-container');
    const macroResultDiv = document.getElementById('macro-result');
    const chartContainer = document.getElementById('chart-container'); // For macro chart
    const mealResultDiv = document.getElementById('meal-result');
    const timeEstimationResultDiv = document.getElementById('time-estimation-result');
    const timeChartContainer = document.getElementById('time-estimation-chart-container'); // For manual estimation chart
    const step5TableContainer = document.getElementById('detailed-cycle-table-container'); // Auto table container (Step 5)
    // Step 7 Elements
    const hyperproteinTableContainer = document.getElementById('hyperprotein-cycle-table-container');
    const hyperproteinTable = document.getElementById('hyperprotein-cycle-table');
    const hyperproteinTableBody = document.getElementById('hyperprotein-cycle-table-body');
    const hyperproteinInfoMessage = document.getElementById('hyperprotein-info-message');
    const hyperproteinNoteContainer = document.getElementById('hyperprotein-note-container');
    // Percentage Total Displays
    const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
    const mealPercentageTotalDiv = document.getElementById('meal-percentage-total');
    // Input Fields to Update
    const goalCaloriesInput = document.getElementById('goal-calories');
    const proteinPercentageInput = document.getElementById('protein-percentage');
    const carbPercentageInput = document.getElementById('carb-percentage');
    const fatPercentageInput = document.getElementById('fat-percentage');
    const targetMusclePercInput = document.getElementById('target-muscle-percentage');
    const targetMusclePerc = parseFloat(targetMusclePercInput.value);

    // --- Utility Functions ---
    /**
     * Displays an error message in a specified container.
     * @param {HTMLElement} container - The DOM element to display the message in.
     * @param {string} message - The error message text.
     */
    function displayError(container, message) {
        if (container) {
            container.innerHTML = `<p class="error-message">${message}</p>`;
        } else {
            console.error("Error container not found for message:", message);
        }
    }

    /**
     * Displays an informational message in a specified container.
     * @param {HTMLElement} container - The DOM element to display the message in.
     * @param {string} message - The info message text.
     */
    function displayInfo(container, message) {
        if (container) {
            container.innerHTML = `<p class="info-message">${message}</p>`;
        } else {
            console.error("Info container not found for message:", message);
        }
    }

    /**
     * Clears the content of a specified container.
     * @param {HTMLElement} container - The DOM element to clear.
     */
    function clearContainer(container) {
        if (container) {
            container.innerHTML = '';
        }
    }

    /**
     * Updates the enabled/disabled state of buttons based on completed steps.
     */
    function updateButtonStates() {
        const step1Done = calculatedTDEE !== null && currentWeightKg !== null;
        const step2Done = step1Done && targetWeightKgGlobal !== null;
        const step3Done = step2Done && calculatedMacros.goalCalories > 0;
        const step6Done = step1Done && estimatedWeeksManualGlobal !== null && estimatedWeeksManualGlobal > 0; // Step 6 (Manual Estimation) is done

        // Enable/disable step buttons
        if (calculateGoalButton) calculateGoalButton.disabled = !step1Done;
        if (calculateMacrosButton) calculateMacrosButton.disabled = !step2Done;
        if (generateMealsButton) generateMealsButton.disabled = !step3Done;
        if (estimateTimeButton) estimateTimeButton.disabled = !step1Done; // Step 6 only needs Step 1
        if (generateHyperproteinButton) generateHyperproteinButton.disabled = !step6Done; // Step 7 needs Step 6

        // Enable/disable PDF button if at least Step 1 is done
        if (savePdfButton) savePdfButton.disabled = !step1Done;
    }

    // --- Step 1: Calculate TDEE and Energy Balance ---
    // --- Step 1: Calculate TDEE and Energy Balance ---


    function estimateBodyFat(bmi, userAge, userGender) {
        let estimatedBodyFat;
        if (userGender === 'male') {
            estimatedBodyFat = (1.20 * bmi) + (0.23 * userAge) - 16.2;
        } else {
            estimatedBodyFat = (1.20 * bmi) + (0.23 * userAge) - 5.4;
        }
        return userGender === 'male'
            ? Math.max(6, Math.min(40, estimatedBodyFat))
            : Math.max(16, Math.min(50, estimatedBodyFat));
    }

    // --- Main calculation function ---
    function calculateCalories() {
        // Clear previous results
        clearContainer(calorieResultDiv);
        clearContainer(energyBalanceResultDiv);
        clearContainer(recommendationResultDiv);

        // Get values from form with safe fallbacks
        userAge = parseInt(calorieForm.elements['age']?.value) || NaN;
        userGender = calorieForm.elements['gender']?.value || '';
        currentWeightKg = parseFloat(calorieForm.elements['weight']?.value) || NaN;
        const heightM = parseFloat(calorieForm.elements['height']?.value) || NaN;
        userActivityLevel = parseFloat(calorieForm.elements['activity']?.value) || 0;
        const estimatedIntake = parseInt(calorieForm.elements['estimated-intake']?.value) || null;
        const userCondition = calorieForm.elements['condition']?.value || 'auto';
        const formulaChoice = calorieForm.elements['formula']?.value || 'auto';
        const applyBuffer = calorieForm.elements['buffer']?.checked || false;

        // Basic validation
        if (isNaN(userAge) || isNaN(currentWeightKg) || isNaN(heightM) || userAge <= 0 || currentWeightKg <= 0 || heightM <= 0) {
            displayError(calorieResultDiv, 'Por favor, introduce valores v√°lidos para edad, peso y altura.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }

        // Validate activity level
        const activityMultiplier = activityMultipliers[userActivityLevel];
        if (activityMultiplier === undefined) {
            displayError(calorieResultDiv, 'Nivel de actividad no v√°lido.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }

        userHeightCm = heightM * 100; // Store height in cm

        // Calculate BMI for auto-detection of condition
        const bmi = currentWeightKg / (heightM * heightM);
        let condition = userCondition;
        if (condition === 'auto') {
            if (bmi >= 30) {
                condition = 'obese';
            } else if (bmi >= 25) {
                condition = 'overweight';
            } else if (bmi >= 18.5) {
                condition = 'normal';
            } else {
                condition = 'underweight';
            }
        }

        // Select formula based on condition and formulaChoice
        let selectedFormula = formulaChoice;
        if (formulaChoice === 'auto') {
            if (userAge >= 10 && userAge <= 18) {
                selectedFormula = 'oms-adolescent';
            } else if (condition === 'obese' || condition === 'overweight') {
                selectedFormula = 'mifflin';
            } else if (condition === 'athlete') {
                selectedFormula = 'mifflin';
            } else {
                selectedFormula = 'harris-benedict';
            }
        }

        // Adjust weight for obese/overweight
        let adjustedWeightKg = currentWeightKg;
        if (condition === 'obese' || condition === 'overweight') {
            const idealWeight = 22.5 * (heightM * heightM);
            adjustedWeightKg = ((currentWeightKg - idealWeight) * 0.25) + idealWeight;
        }

        // Calculate BMR
        if (selectedFormula === 'harris-benedict') {
            if (userGender === 'male') {
                calculatedBMR = 88.362 + (13.397 * adjustedWeightKg) + (4.799 * userHeightCm) - (5.677 * userAge);
            } else if (userGender === 'female') {
                calculatedBMR = 447.593 + (9.247 * adjustedWeightKg) + (3.098 * userHeightCm) - (4.330 * userAge);
            } else {
                displayError(calorieResultDiv, 'G√©nero no v√°lido.');
                calculatedTDEE = null;
                calculatedBMR = null;
                resetStep2onwards();
                updateButtonStates();
                return;
            }
        } else if (selectedFormula === 'oms') {
            if (userGender === 'male') {
                if (userAge >= 18 && userAge <= 30) {
                    calculatedBMR = (15.3 * adjustedWeightKg) + 679;
                } else if (userAge > 30 && userAge <= 60) {
                    calculatedBMR = (11.6 * adjustedWeightKg) + 879;
                } else if (userAge > 60) {
                    calculatedBMR = (13.5 * adjustedWeightKg) + 487;
                }
            } else if (userGender === 'female') {
                if (userAge >= 18 && userAge <= 30) {
                    calculatedBMR = (14.7 * adjustedWeightKg) + 496;
                } else if (userAge > 30 && userAge <= 60) {
                    calculatedBMR = (8.7 * adjustedWeightKg) + 829;
                } else if (userAge > 60) {
                    calculatedBMR = (10.5 * adjustedWeightKg) + 596;
                }
            } else {
                displayError(calorieResultDiv, 'G√©nero no v√°lido.');
                calculatedTDEE = null;
                calculatedBMR = null;
                resetStep2onwards();
                updateButtonStates();
                return;
            }
        } else if (selectedFormula === 'oms-adolescent' && userAge >= 10 && userAge <= 18) {
            if (userGender === 'male') {
                calculatedBMR = (17.5 * adjustedWeightKg) + 651;
            } else if (userGender === 'female') {
                calculatedBMR = (12.2 * adjustedWeightKg) + 746;
            } else {
                displayError(calorieResultDiv, 'G√©nero no v√°lido.');
                calculatedTDEE = null;
                calculatedBMR = null;
                resetStep2onwards();
                updateButtonStates();
                return;
            }
        } else if (selectedFormula === 'mifflin') {
            if (userGender === 'male') {
                calculatedBMR = (10 * adjustedWeightKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else if (userGender === 'female') {
                calculatedBMR = (10 * adjustedWeightKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            } else {
                displayError(calorieResultDiv, 'G√©nero no v√°lido.');
                calculatedTDEE = null;
                calculatedBMR = null;
                resetStep2onwards();
                updateButtonStates();
                return;
            }
        } else {
            displayError(calorieResultDiv, 'F√≥rmula no v√°lida o no aplicable para la edad/condici√≥n.');
            calculatedTDEE = null;
            calculatedBMR = null;
            resetStep2onwards();
            updateButtonStates();
            return;
        }

        // Calculate TDEE
        calculatedTDEE = Math.round(calculatedBMR * activityMultiplier);
        window.calculatedTDEE = calculatedTDEE
        // Apply 10% buffer if selected
        if (applyBuffer) {
            calculatedTDEE *= 1.1;
        }

        // Adjust TDEE for underweight or athletes
        if (condition === 'underweight') {
            calculatedTDEE *= 1.15;
        } else if (condition === 'athlete') {
            calculatedTDEE *= 1.1;
        }

        // Round results
        calculatedBMR = Math.round(calculatedBMR).toFixed(0);
        window.calculatedTDEE = Math.round(calculatedTDEE).toFixed(0);

        // Display TDEE results
        calorieResultDiv.innerHTML = `
        <h3>Resultados del Gasto Energ√©tico:</h3>
        <p>Tu Tasa Metab√≥lica Basal (TMB) estimada es: <strong>${calculatedBMR} kcal/d√≠a</strong>.</p>
        <p>Tu Gasto Energ√©tico Total (GET/TDEE) estimado es: <strong>${calculatedTDEE} kcal/d√≠a</strong>.</p>
        <p>Este es el n√∫mero aproximado de calor√≠as que tu cuerpo quema diariamente${applyBuffer ? ', incluyendo un margen del 10%.' : '.'}</p>
        <p>F√≥rmula utilizada: <strong>${selectedFormula === 'harris-benedict' ? 'Harris-Benedict' : selectedFormula === 'oms' ? 'OMS/FAO/ONU' : selectedFormula === 'oms-adolescent' ? 'OMS/FAO/ONU (Adolescentes)' : 'Mifflin-St Jeor'}</strong>.</p>
        <p>Condici√≥n detectada: <strong>${condition === 'obese' ? 'Obesidad' : condition === 'overweight' ? 'Sobrepeso' : condition === 'normal' ? 'Normopeso' : condition === 'underweight' ? 'Infrapeso' : 'Atleta'}</strong>.</p>`;

        // Display Energy Balance
        let actualIntake = estimatedIntake;
        let intakeSource = 'tu ingesta proporcionada';
        if (!estimatedIntake || estimatedIntake <= 0) {
            let intakeMultiplier;
            if (userActivityLevel === 1.2) {
                intakeMultiplier = 0.90;
            } else if (userActivityLevel === 1.375) {
                intakeMultiplier = 0.95;
            } else if (userActivityLevel === 1.55) {
                intakeMultiplier = 1.00;
            } else if (userActivityLevel === 1.725) {
                intakeMultiplier = 1.05;
            } else if (userActivityLevel === 1.9) {
                intakeMultiplier = 1.10;
            } else {
                intakeMultiplier = 1.00;
            }
            actualIntake = calculatedTDEE * intakeMultiplier;
            intakeSource = 'tu ingesta estimada autom√°ticamente (basada en tus caracter√≠sticas)';
        }





        const balance = actualIntake - calculatedTDEE;
        let balanceInterpretation = '';
        if (balance > 100) {
            balanceInterpretation = `Est√°s en un <strong>super√°vit cal√≥rico</strong> de aproximadamente <strong>${balance.toFixed(0)} kcal/d√≠a</strong>. Esto generalmente conduce a una ganancia de peso.`;
        } else if (balance < -100) {
            balanceInterpretation = `Est√°s en un <strong>d√©ficit cal√≥rico</strong> de aproximadamente <strong>${Math.abs(balance).toFixed(0)} kcal/d√≠a</strong>. Esto generalmente conduce a una p√©rdida de peso.`;
        } else {
            balanceInterpretation = `Est√°s cerca de tu <strong>mantenimiento cal√≥rico</strong> (balance de <strong>${balance.toFixed(0)} kcal/d√≠a</strong>). Tu peso deber√≠a mantenerse relativamente estable.`;
        }

        energyBalanceResultDiv.innerHTML = `
        <h3>Balance Energ√©tico Estimado:</h3>
        <p>Basado en ${intakeSource} <strong>(${actualIntake.toFixed(0)} kcal)</strong> comparada con tu GET <strong>(${calculatedTDEE} kcal)</strong></p>
        <p>${balanceInterpretation}</p>`;

        // Estimate body fat and lean mass
        const estimatedBodyFat = estimateBodyFat(bmi, userAge, userGender);
        const leanMassKg = currentWeightKg * (1 - estimatedBodyFat / 100);

        // Detect if active
        const isActive = ['active', 'very_active'].includes(userActivityLevel);

        // Classify body fat
        let bodyFatCategory = '';
        let recommendationTitle = '';
        let finalObjective = 'perdida1';
        if (userGender === 'male') {
            if (estimatedBodyFat < 10) {
                bodyFatCategory = isActive ? 'Excelente (nivel atleta)' : 'Muy bajo';
            } else if (estimatedBodyFat <= 20) {
                bodyFatCategory = 'Saludable';
            } else if (estimatedBodyFat <= 25) {
                bodyFatCategory = 'Sobrepeso leve';
            } else {
                bodyFatCategory = 'Obesidad';
            }
        } else {
            if (estimatedBodyFat < 18) {
                bodyFatCategory = isActive ? 'Excelente (nivel atleta)' : 'Muy bajo';
            } else if (estimatedBodyFat <= 28) {
                bodyFatCategory = 'Saludable';
            } else if (estimatedBodyFat <= 33) {
                bodyFatCategory = 'Sobrepeso leve';
            } else {
                bodyFatCategory = 'Obesidad';
            }
        }

        // Recommendations
        let recommendation = '';
        if (estimatedBodyFat > (userGender === 'male' ? 20 : 28) || bmi >= 25) {
            recommendationTitle = 'üéØ Objetivo Recomendado: P√©rdida de Grasa (Definici√≥n)';
            const fatTarget = isActive ? (userGender === 'male' ? '6‚Äì13%' : '14‚Äì20%') : (userGender === 'male' ? '15‚Äì25%' : '20‚Äì30%');
            const proteinRange = isActive ? '1.8‚Äì2.4' : '1.6‚Äì2.2';
            const trainingFreq = isActive ? '3‚Äì5 veces/semana' : '2‚Äì3 veces/semana';
            const deficit = isActive ? '300‚Äì500' : '300‚Äì500';
            const cardio = isActive ? 'cardio de alta intensidad ocasional (HIIT) o moderado 2‚Äì3 veces/semana' : 'caminar r√°pido, bicicleta 2‚Äì3 veces/semana';
            recommendation = `
            <p><strong>An√°lisis de composici√≥n corporal:</strong></p>
            <p>‚Ä¢ Tu IMC es <strong>${bmi.toFixed(1)}</strong> (${bmi < 18.5 ? 'bajo peso' : bmi < 25 ? 'normal' : bmi < 30 ? 'sobrepeso' : 'obesidad'})</p>
            <p>‚Ä¢ Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
            <p>‚Ä¢ Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>
            <p><strong>Objetivo: Reducir %grasa hasta ${fatTarget} mientras preservas masa muscular.</strong></p>
            <p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
            <ul>
                <li>Mant√©n un <strong>d√©ficit cal√≥rico de ${deficit} kcal/d√≠a</strong>.</li>
                <li>Ingiere <strong>${proteinRange} g de prote√≠na por kg</strong> (~${Math.round(1.8 * currentWeightKg)}‚Äì${Math.round(2.4 * currentWeightKg)} g/d√≠a).</li>
                <li>Entrena con <strong>fuerza ${trainingFreq}</strong> (enf√≥cate en progresi√≥n).</li>
                <li>Incluye <strong>${cardio}</strong>.</li>
            </ul>
            <p><strong>üí° Tip:</strong> Pierde entre 0.3‚Äì0.6 kg por semana. Si eres activo, prioriza recuperaci√≥n y sue√±o para mantener rendimiento.</p>`;
            finalObjective = 'perdida1';
        } else if (estimatedBodyFat <= (userGender === 'male' ? 15 : 23) && bmi < 22) {
            recommendationTitle = 'üéØ Objetivo Recomendado: Ganancia de Masa Muscular';
            const leanTarget = isActive ? (userGender === 'male' ? '85‚Äì92%' : '78‚Äì85%') : (userGender === 'male' ? '80‚Äì90%' : '72‚Äì82%');
            const proteinRange = isActive ? '1.8‚Äì2.4' : '1.6‚Äì2.2';
            const surplus = isActive ? '+300‚Äì500 kcal/d√≠a' : '+250‚Äì300 kcal/d√≠a';
            const trainingFreq = isActive ? '4‚Äì5 veces/semana (dividido por grupos musculares)' : '3‚Äì4 veces/semana (full body o split)';
            const tip = isActive ? 'Gana 0.5‚Äì1% de tu peso corporal por mes para m√°ximo rendimiento.' : 'Gana 0.25‚Äì0.5 kg por semana para evitar exceso de grasa.';
            recommendation = `
            <p><strong>An√°lisis de composici√≥n corporal:</strong></p>
            <p>‚Ä¢ Tu IMC es <strong>${bmi.toFixed(1)}</strong> (${bmi < 18.5 ? 'bajo peso' : 'normal'})</p>
            <p>‚Ä¢ Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
            <p>‚Ä¢ Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>
            <p><strong>Objetivo: Aumentar masa magra hasta alcanzar ${leanTarget}% de tu peso.</strong></p>
            <p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
            <ul>
                <li>Crea un <strong>super√°vit de ${surplus}</strong>.</li>
                <li>Consume <strong>${proteinRange} g de prote√≠na por kg</strong> (~${Math.round(1.8 * currentWeightKg)}‚Äì${Math.round(2.4 * currentWeightKg)} g/d√≠a).</li>
                <li>Entrena con <strong>resistencia ${trainingFreq}</strong>.</li>
                <li>Descansa <strong>7‚Äì9 horas/noche</strong> y gestiona el estr√©s.</li>
            </ul>
            <p><strong>üí° Tip:</strong> ${tip}</p>`;
            finalObjective = 'ganancia1';
        } else {
            recommendationTitle = 'üéØ Objetivo Recomendado: Mantenimiento con Recomposici√≥n Corporal';
            const targetRange = isActive ? (userGender === 'male' ? '8‚Äì15%' : '15‚Äì22%') : (userGender === 'male' ? '12‚Äì20%' : '20‚Äì28%');
            const proteinIntake = isActive ? '2.0‚Äì2.4 g/kg' : '1.8‚Äì2.2 g/kg';
            const trainingFreq = isActive ? '4‚Äì5 veces/semana (split o push/pull/legs)' : '3 veces/semana (full body)';
            const tip = isActive ? 'Espera cambios lentos. Monitorea fuerza y medidas semanales.' : 'Ideal para principiantes o quienes retoman entrenamiento.';
            recommendation = `
            <p><strong>An√°lisis de composici√≥n corporal:</strong></p>
            <p>‚Ä¢ Tu IMC es <strong>${bmi.toFixed(1)}</strong> (normal)</p>
            <p>‚Ä¢ Tu porcentaje de grasa corporal estimado es <strong>${estimatedBodyFat.toFixed(1)}%</strong> (${bodyFatCategory})</p>
            <p>‚Ä¢ Tu masa magra es aproximadamente <strong>${leanMassKg.toFixed(1)} kg</strong></p>
            <p><strong>Objetivo: Perder grasa y ganar m√∫sculo simult√°neamente. Mant√©n peso y mejora tu composici√≥n hasta alcanzar ~${targetRange}% grasa.</strong></p>
            <p><strong>Estrategia personalizada ${isActive ? '(Deportista/AF intensa)' : '(AF leve o moderada)'}:</strong></p>
            <ul>
                <li>Mant√©n ingesta en <strong>equilibrio (~${calculatedTDEE} kcal/d√≠a)</strong>.</li>
                <li>Ingiere <strong>${proteinIntake}</strong> de prote√≠na.</li>
                <li>Entrena con <strong>fuerza ${trainingFreq}</strong>.</li>
                <li>Evita d√©ficits grandes para no perder rendimiento.</li>
            </ul>
            <p><strong>üí° Tip:</strong> ${tip} Usa progresi√≥n de carga y alimentaci√≥n consistente.</p>`;
            finalObjective = 'mantenimiento1';
        }

        // Display recommendation
        if (recommendationResultDiv) {
            recommendationResultDiv.innerHTML = `<h3>${recommendationTitle}</h3>${recommendation}`;
        }

        // Autofill goal form
        if (weightGoalForm) {
            const currentFatInput = document.getElementById('current-fat-percentage');
            const targetFatInput = document.getElementById('target-fat-percentage');
            const targetMuscleInput = document.getElementById('target-muscle-percentage');
            const leanMassGainInput = document.getElementById('desired-lean-mass-gain');

            if (finalObjective === 'perdida1') {
                if (currentFatInput && !currentFatInput.value) {
                    currentFatInput.value = estimatedBodyFat.toFixed(0);
                }
                if (targetFatInput && !targetFatInput.value) {
                    const defaultTargetFat = userGender === 'male' ? (isActive ? 12 : 18) : (isActive ? 18 : 22);
                    targetFatInput.value = defaultTargetFat.toFixed(0);
                }
                if (targetMuscleInput && !targetMuscleInput.value) {
                    let defaultMusclePercent = userGender === 'male' ? (isActive ? 42 : 38) : (isActive ? 35 : 30);
                    targetMuscleInput.value = defaultMusclePercent.toFixed(0);
                }
            } else if (finalObjective === 'ganancia1') {
                if (targetMuscleInput && !targetMuscleInput.value) {
                    const defaultMusclePercent = userGender === 'male' ? (isActive ? 42 : 36) : (isActive ? 35 : 30);
                    targetMuscleInput.value = defaultMusclePercent.toFixed(0);
                }
                if (leanMassGainInput && !leanMassGainInput.value) {
                    const suggestedGain = isActive ? 3.0 : 2.0;
                    leanMassGainInput.value = suggestedGain.toFixed(0);
                }
            }
        }

        // Adjust goal select
        const objetivoSelect = document.getElementById('objetivo');
        if (objetivoSelect && !objetivoSelect.dataset.manual) {
            objetivoSelect.value = finalObjective;
            objetivoSelect.dispatchEvent(new Event('change'));
        }


        const resultElements = [
            'calorie-result',
            'energy-balance-result',
            'recommendationResultDiv'
        ];

        resultElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
                element.style.opacity = '0';
                setTimeout(() => {
                    element.style.transition = 'opacity 0.4s ease';
                    element.style.opacity = '1';
                }, 100);
            }
        });



        // Show info notice
        const infoNotice = document.querySelector('.info-notice');
        if (infoNotice) {
            infoNotice.style.display = 'block';
            infoNotice.style.opacity = '0';
            setTimeout(() => {
                infoNotice.style.transition = 'opacity 0.4s ease';
                infoNotice.style.opacity = '1';
            }, 100);
        }



        // Reset subsequent steps and update UI
        resetStep2onwards();
        updateButtonStates();
        if (calculateGoalButton) {
            calculateGoalButton.disabled = false;
        }
        console.log('calculateGoalButton.disabled:', calculateGoalButton?.disabled);
    }
    // Agrega estas funciones en tu c√≥digo (fuera de otras funciones)



    // --- Step 2: Calculate Weight Goal and Recommendations ---
    function calculateWeightGoal() {
        let targetMusclePercValid = true;
        const objetivoSelect = document.getElementById('objetivo');

        // Suponiendo que tienes estas variables:
        const activityLevel = document.getElementById('nivel-actividad')?.value || 'sedentario';
        // userAge, currentLeanMassPerc, currentFatPerc, userGender ya los tienes


        // --- Validaci√≥n del % de masa muscular objetivo ---
        if (objetivoSelect.value === 'ganancia1') {
            const targetMusclePercInput = weightGoalForm.elements['target-muscle-percentage'];
            const targetMusclePerc = parseFloat(targetMusclePercInput.value);

            // Validar rango REALISTA para masa muscular (NO masa magra)
            if (isNaN(targetMusclePerc) || targetMusclePerc < 28 || targetMusclePerc > 45) {
                console.error('Por favor, introduce un valor v√°lido para el porcentaje de masa muscular objetivo (28‚Äì45%).');
                alert('‚ö†Ô∏è Para ganar m√∫sculo, el porcentaje de masa muscular objetivo debe estar entre 28% y 45% (valores realistas).');
                targetMusclePercValid = false;
            }
        }

        clearContainer(weightGoalResultDiv);
        if (weightChartContainer) weightChartContainer.style.display = 'none';

        if (weightEvolutionChartInstance) {
            weightEvolutionChartInstance.destroy();
            weightEvolutionChartInstance = null;
        }

        // Check prerequisite
        if (!currentWeightKg || !calculatedTDEE) {
            displayError(weightGoalResultDiv, 'Error: Completa el Paso 1 antes de calcular el objetivo de peso.');
            updateButtonStates();
            return;
        }

        // Get values from form
        const currentFatPerc = parseFloat(weightGoalForm.elements['current-fat-percentage'].value);
        const targetFatPerc = parseFloat(weightGoalForm.elements['target-fat-percentage'].value);
        const targetMusclePerc = parseFloat(weightGoalForm.elements['target-muscle-percentage'].value) || 0;
        const desiredLeanGainKg = parseFloat(weightGoalForm.elements['desired-lean-mass-gain'].value) || 0;
        const isAthlete = weightGoalForm.elements['is-athlete'].value === 'yes';
        const currentFatMassKg = currentWeightKg * (currentFatPerc / 100);
        const currentLeanMassKg = currentWeightKg - currentFatMassKg;
        const currentLeanMassPerc = (currentLeanMassKg / currentWeightKg) * 100;
        const targetLeanMassKg = currentLeanMassKg + desiredLeanGainKg;
        const isBeginner = isLikelyBeginner(userAge, activityLevel, currentLeanMassPerc, currentFatPerc, userGender);
        // Validate fat percentages
        if (isNaN(currentFatPerc) || isNaN(targetFatPerc) ||
            currentFatPerc <= 0 || currentFatPerc >= 100 ||
            targetFatPerc <= 0 || targetFatPerc >= 100) {
            displayError(weightGoalResultDiv, 'Por favor, introduce porcentajes de grasa v√°lidos (entre 0.1% y 99.9%).');
            targetWeightKgGlobal = null;
            resetStep3onwards();
            updateButtonStates();
            return;
        }
        // === Estimar si el usuario es "principiante" para recomposici√≥n ===
        function isLikelyBeginner(userAge, activityLevel, currentLeanMassPerc, currentFatPerc, userGender) {
            // 1. Nivel de actividad baja o leve ‚Üí probablemente no entrena con fuerza
            const isLowActivity = ['sedentario', 'leve'].includes(activityLevel.toLowerCase());

            // 2. Masa magra baja para su g√©nero
            const leanLowForGender = (userGender === 'male' && currentLeanMassPerc < 70) ||
                (userGender === 'female' && currentLeanMassPerc < 65);

            // 3. Alta grasa corporal (m√°s de 25% hombre / 32% mujer)
            const isHighFat = (userGender === 'male' && currentFatPerc > 25) ||
                (userGender === 'female' && currentFatPerc > 32);

            // 4. Edad: si es joven (<50), m√°s f√°cil adaptarse
            const isYounger = userAge < 50;

            // Criterio: si tiene baja actividad + baja masa magra + alta grasa ‚Üí muy probable que sea principiante
            return isLowActivity && leanLowForGender && isHighFat && isYounger;
        }
        // --- Calculations ---

        targetWeightKgGlobal = targetLeanMassKg / (1 - (targetFatPerc / 100));

        if (targetWeightKgGlobal <= 0 || !isFinite(targetWeightKgGlobal) || targetWeightKgGlobal > 500) {
            displayError(weightGoalResultDiv, 'No se pudo calcular un peso objetivo v√°lido. Revisa los datos.');
            targetWeightKgGlobal = null;
            resetStep3onwards();
            updateButtonStates();
            return;
        }

        const targetFatMassKg = targetWeightKgGlobal * (targetFatPerc / 100);
        const fatMassToLoseGainKg = currentFatMassKg - targetFatMassKg;
        const totalWeightChangeKg = targetWeightKgGlobal - currentWeightKg;

        // --- Determine Goal Type ---
        goalTypeGlobal = 'maintenance';
        if (totalWeightChangeKg < -0.1) {
            goalTypeGlobal = 'perdida1';
        } else if (totalWeightChangeKg > 0.1) {
            goalTypeGlobal = 'ganancia1';
        }

        // --- Weekly Rate & Duration ---
        estimatedWeeksGlobal = 0;
        targetWeeklyRateKgGlobal = 0;
        let targetWeeklyRatePerc = 0;

        if (goalTypeGlobal === 'perdida1') {
            targetWeeklyRatePerc = 0.004;
            targetWeeklyRateKgGlobal = Math.max(currentWeightKg * targetWeeklyRatePerc, 0.2);
            targetWeeklyRateKgGlobal = Math.min(targetWeeklyRateKgGlobal, currentWeightKg * 0.01, 1.2);
            estimatedWeeksGlobal = Math.abs(totalWeightChangeKg) / targetWeeklyRateKgGlobal;
        } else if (goalTypeGlobal === 'ganancia1') {
            targetWeeklyRatePerc = 0.003;
            targetWeeklyRateKgGlobal = Math.max(currentWeightKg * targetWeeklyRatePerc, 0.1);
            targetWeeklyRateKgGlobal = Math.min(targetWeeklyRateKgGlobal, currentWeightKg * 0.005, 0.6);
            estimatedWeeksGlobal = totalWeightChangeKg / targetWeeklyRateKgGlobal;
        }

        estimatedWeeksGlobal = Math.max(0, Math.round(estimatedWeeksGlobal));

        // === üîç PROYECCI√ìN DE GANANCIA MUSCULAR (solo si es ganancia1 y se ingres√≥ % m√∫sculo) ===
        let muscleProjectionHTML = '';
        if (goalTypeGlobal === 'ganancia1' && targetMusclePerc > 0) {
            const currentMuscleKg = currentLeanMassKg * 0.75; // Aprox: m√∫sculo es ~70-80% de masa magra
            const targetMuscleKg = targetWeightKgGlobal * (targetMusclePerc / 100);
            const netMuscleGainKg = Math.max(0, targetMuscleKg - currentMuscleKg);

            // Velocidad realista de ganancia muscular
            let monthlyGain = userAge < 35 ? 1.0 : (userAge < 50 ? 0.6 : 0.3);
            const monthsToGain = netMuscleGainKg > 0 ? netMuscleGainKg / monthlyGain : 0;

            muscleProjectionHTML = `
						<div class="notes-section">
							<h4>üéØ Proyecci√≥n Realista de Ganancia Muscular</h4>
							<p><strong>Masa muscular actual estimada:</strong> ${currentMuscleKg.toFixed(1)} kg (~75% de tu masa magra)</p>
							<p><strong>Masa muscular objetivo:</strong> ${targetMuscleKg.toFixed(1)} kg (${targetMusclePerc}% del peso corporal)</p>
							<p><strong>Ganancia neta estimada:</strong> <strong>${netMuscleGainKg.toFixed(1)} kg</strong></p>
							<p><strong>Tiempo estimado (ganancia natural):</strong> ~${monthsToGain.toFixed(1)} meses</p>
							<p><em>Nota: La ganancia muscular realista es de 0.3‚Äì1.2 kg/mes, m√°s r√°pida en principiantes. El resto del peso ganado ser√° grasa y agua.</em></p>
						</div>`;
        }

        // === üìä EVALUACI√ìN DE MASA MUSCULAR (mejorada) ===

        let muscleAssessmentHTML = `<div class="notes-section"><h4>Evaluaci√≥n de Composici√≥n Corporal</h4>`;
        muscleAssessmentHTML += `<p><strong>Masa magra actual:</strong> ${currentLeanMassKg.toFixed(1)} kg (${currentLeanMassPerc.toFixed(1)}%)</p>`;
        muscleAssessmentHTML += `<p><em>‚ö†Ô∏è Nota: La masa magra incluye m√∫sculo, huesos, √≥rganos y agua. No es igual a masa muscular.</em></p>`;

        const ranges = {
            male: { nonAthlete: [70, 85], athlete: [75, 90] },
            female: { nonAthlete: [60, 75], athlete: [65, 80] }
        };
        const relevantRange = isAthlete ? ranges[userGender].athlete : ranges[userGender].nonAthlete;

        if (currentLeanMassPerc < relevantRange[0]) {
            muscleAssessmentHTML += `<p>Est√°s por debajo del rango t√≠pico (${relevantRange[0]}‚Äì${relevantRange[1]}%). <strong>Enf√≥cate en ganar masa muscular con entrenamiento de fuerza y super√°vit cal√≥rico moderado</strong>.</p>`;
        } else if (currentLeanMassPerc > relevantRange[1]) {
            muscleAssessmentHTML += `<p>¬°Tienes una masa magra excelente! Por encima del rango general. Ideal para definici√≥n o mantenimiento.</p>`;
        } else {
            muscleAssessmentHTML += `<p>Est√°s dentro del rango saludable de masa magra para tu perfil.</p>`;
        }
        muscleAssessmentHTML += `</div>`;

        // === üßæ RESULTADOS ===
        let resultsHTML = `<h3>Resultados del Objetivo de Composici√≥n Corporal:</h3>`;
        resultsHTML += `<p><strong>Peso Actual:</strong> ${currentWeightKg.toFixed(2)} kg</p>`;
        resultsHTML += `<p><strong>Grasa Actual:</strong> ${currentFatMassKg.toFixed(2)} kg (${currentFatPerc}%)</p>`;
        resultsHTML += `<p><strong>Masa Magra Actual:</strong> ${currentLeanMassKg.toFixed(1)} kg (${currentLeanMassPerc.toFixed(1)}%)</p>`;
        resultsHTML += `<hr style="border: 0; border-top: 1px dashed #a5d6a7; margin: 15px 0;">`;
        resultsHTML += `<p><strong>Peso Objetivo:</strong> ${targetWeightKgGlobal.toFixed(2)} kg</p>`;
        resultsHTML += `<p><strong>Grasa Objetivo:</strong> ${targetFatMassKg.toFixed(2)} kg (${targetFatPerc}%)</p>`;
        resultsHTML += `<p><strong>Masa Magra Objetivo:</strong> ${targetLeanMassKg.toFixed(1)} kg</p>`;
        resultsHTML += `<p><strong>Ganancia Magra Deseada:</strong> ${desiredLeanGainKg.toFixed(1)} kg</p>`;

        if (fatMassToLoseGainKg > 0) {
            resultsHTML += `<p><strong>Grasa a Perder:</strong> ${fatMassToLoseGainKg.toFixed(2)} kg</p>`;
        } else if (fatMassToLoseGainKg < 0) {
            resultsHTML += `<p><strong>Grasa a Ganar:</strong> ${Math.abs(fatMassToLoseGainKg).toFixed(2)} kg</p>`;
        }

        resultsHTML += `<p><strong>Cambio Total de Peso:</strong> ${totalWeightChangeKg.toFixed(2)} kg</p>`;
        resultsHTML += `<p><strong>Ritmo Semanal Objetivo:</strong> ~${targetWeeklyRateKgGlobal.toFixed(2)} kg/semana</p>`;
        if (estimatedWeeksGlobal > 0) {
            resultsHTML += `<p><strong>Duraci√≥n Estimada:</strong> ~${estimatedWeeksGlobal} semanas (${(estimatedWeeksGlobal / 4.3).toFixed(1)} meses)</p>`;
        }

        // === üîé A√ëADIR PROYECCI√ìN Y EVALUACI√ìN ===
        resultsHTML += muscleAssessmentHTML;
        if (muscleProjectionHTML) resultsHTML += muscleProjectionHTML;

        // === üîé DETERMINAR FASE RECOMENDADA (sin necesidad de hasTrainedBefore) ===
        // --- Determinar fase(objetivo) recomendada ---
        const userWantsGain = objetivoSelect.value === 'ganancia1';
        const userWantsLoss = objetivoSelect.value === 'perdida1';
        //const isAthlete = document.getElementById('is-athlete')?.value === 'yes';

        //	const activityLevel = document.getElementById('nivel-actividad')?.value?.toLowerCase();

        const isModerateActivity = ['moderate', 'active', 'very-active'].includes(activityLevel);

        // === Definir umbrales y condiciones clave ===
        const fatThresholdForGain = userGender === 'male' ? 25 : 32;
        const fatThresholdForUrgentLoss = userGender === 'male' ? 30 : 38;
        const isVeryHighFat = currentFatPerc >= fatThresholdForUrgentLoss;

        const isHighFat = (userGender === 'male' && currentFatPerc > 25) ||
            (userGender === 'female' && currentFatPerc > 32);

        const isLowLean = (userGender === 'male' && currentLeanMassPerc < 70) ||
            (userGender === 'female' && currentLeanMassPerc < 65);

        const isBeginnerLike = (userGender === 'male' && currentLeanMassPerc < 70) ||
            (userGender === 'female' && currentLeanMassPerc < 65);

        // Variables de salida
        let recommendedPhase = '';
        let phaseExplanation = '';
        let isMixedPhase = false;

        // === üî• M√ÅXIMA PRIORIDAD: P√âRDIDA DE PESO (GRASA) ===
        if (
            userWantsLoss ||
            (isVeryHighFat && (isBeginnerLike || !isModerateActivity))
        ) {
            recommendedPhase = 'P√©rdida de Grasa (prioridad m√°xima)';
            phaseExplanation = `
								<p><strong>üéØ Recomendaci√≥n principal:</strong> Tu situaci√≥n requiere una <strong>prioridad en la p√©rdida de grasa corporal</strong>.</p>
								${isVeryHighFat
                    ? `<p>Con un <strong>${currentFatPerc}% de grasa corporal</strong> (por encima del 30% en hombres / 38% en mujeres), 
									   est√°s en un rango de riesgo metab√≥lico. Reducir grasa mejora salud, movilidad y respuesta a entrenamiento.</p>`
                    : `<p>Has seleccionado la p√©rdida de peso como tu objetivo principal. Este es el momento de enfocarte en reducir grasa corporal.</p>`
                }
								<p>Un <strong>d√©ficit cal√≥rico moderado</strong> (~15‚Äì25% bajo tu gasto) + <strong>alta prote√≠na (2.2‚Äì2.6 g/kg)</strong> + 
								<strong>entrenamiento de fuerza 3‚Äì4 veces/semana</strong> ser√° clave para perder grasa sin perder m√∫sculo.</p>
								<p><em>üí° Aunque tu masa magra no sea baja, perder grasa ahora te permitir√° ganar m√∫sculo despu√©s con mejor eficiencia.</em></p>
							`;
            isMixedPhase = false;
        }
        // 1. PRIORIDAD: Ganancia muscular para deportistas o con objetivo de ganancia (si grasa es baja)
        else if (
            (userWantsGain || isAthlete) &&
            currentFatPerc < fatThresholdForGain &&
            (isModerateActivity || isAthlete)
        ) {
            recommendedPhase = 'Ganancia de Masa Muscular';
            phaseExplanation = `
								<p><strong>üéØ Recomendaci√≥n principal:</strong> Tu perfil es ideal para una <strong>ganancia muscular controlada</strong>.</p>
								<p>Con un porcentaje de grasa corporal del <strong>${currentFatPerc}%</strong> (< 25% en hombres / 32% en mujeres), 
								puedes ganar m√∫sculo sin riesgo de acumular exceso de grasa.</p>
								<p>Un <strong>super√°vit cal√≥rico moderado</strong> (+10‚Äì15% sobre tu gasto) combinado con <strong>entrenamiento de fuerza progresivo</strong> maximizar√° tu hipertrofia.</p>
							`;
            isMixedPhase = false;
        }
        // 2. Recomposici√≥n: quiere ganar masa y perder grasa
        else if (desiredLeanGainKg > 0 && fatMassToLoseGainKg > 0) {
            recommendedPhase = 'Fase Mixta (Recomposici√≥n Corporal)';
            phaseExplanation = `
								<p><strong>üéØ Recomendaci√≥n principal:</strong> Est√°s en una <strong>fase de recomposici√≥n corporal</strong>: perder grasa y ganar m√∫sculo al mismo tiempo.</p>
								<p>Aunque tu masa magra actual (${currentLeanMassPerc.toFixed(1)}%) est√° dentro del rango, tu objetivo es aumentarla a <strong>${targetLeanMassKg.toFixed(1)} kg</strong>, 
								mientras reduces la grasa del <strong>${currentFatPerc}%</strong> al <strong>${targetFatPerc}%</strong>.</p>
								<p>Este enfoque es ideal para mejorar tu f√≠sico sin grandes cambios de peso.</p>
							`;
            isMixedPhase = true;
        }
        // 3. P√©rdida de grasa (tiene grasa alta pero buena masa magra)
        else if (isHighFat && !isLowLean) {
            recommendedPhase = 'P√©rdida de Grasa (con preservaci√≥n muscular)';
            phaseExplanation = `
								<p><strong>üéØ Recomendaci√≥n principal:</strong> Enf√≥cate en <strong>perder grasa</strong>, pero <strong>protegiendo tu m√∫sculo</strong>.</p>
								<p>Tienes una buena base muscular. Un d√©ficit cal√≥rico moderado + alta prote√≠na + entrenamiento de fuerza te ayudar√°n a definirte sin perder masa magra.</p>
							`;
        }
        // 4. Ganancia muscular (baja masa magra, grasa no alta)
        else if (!isHighFat && isLowLean) {
            recommendedPhase = 'Ganancia de Masa Muscular';
            phaseExplanation = `
								<p><strong>üéØ Recomendaci√≥n principal:</strong> Tu prioridad es <strong>ganar m√∫sculo</strong>.</p>
								<p>Aunque tu peso no sea alto, tienes poca masa magra. Un super√°vit cal√≥rico moderado + entrenamiento de fuerza progresivo son clave para construir masa muscular.</p>
							`;
        }
        // 5. Mantenimiento
        else {
            recommendedPhase = 'Mantenimiento o Afinamiento';
            phaseExplanation = `
								<p><strong>üéØ Recomendaci√≥n principal:</strong> Est√°s cerca de tu objetivo. Puedes mantener tu peso o hacer ajustes finos.</p>
								<p>Perfecto para consolidar h√°bitos, mejorar la calidad de vida o afinar tu definici√≥n sin cambios dr√°sticos.</p>
							`;
        }
        // === üí° RECOMENDACIONES PERSONALIZADAS ===
        resultsHTML += `<div class="notes-section"><h4>üí° Recomendaciones Clave</h4><ul>`;

        if (goalTypeGlobal === 'perdida1') {
            const deficit = Math.min(600, Math.max(400, targetWeeklyRateKgGlobal * 7700 / 7));
            resultsHTML += `<li><strong>D√©ficit cal√≥rico:</strong> ~${deficit.toFixed(0)} kcal/d√≠a</li>`;
            resultsHTML += `<li><strong>Prote√≠na:</strong> 1.8‚Äì2.4 g/kg para preservar m√∫sculo</li>`;
            resultsHTML += `<li><strong>Entrenamiento:</strong> Fuerza 3‚Äì4 veces/semana + cardio moderado</li>`;
        } else if (goalTypeGlobal === 'ganancia1') {
            const surplus = Math.min(500, Math.max(250, targetWeeklyRateKgGlobal * 7700 / 7));
            resultsHTML += `<li><strong>Super√°vit cal√≥rico:</strong> ~${surplus.toFixed(0)} kcal/d√≠a</li>`;
            resultsHTML += `<li><strong>Prote√≠na:</strong> 1.6‚Äì2.2 g/kg de peso corporal</li>`;
            resultsHTML += `<li><strong>Entrenamiento:</strong> Hipertrofia 4‚Äì5 veces/semana, progresi√≥n de carga</li>`;
            resultsHTML += `<li><strong>Realismo:</strong> Ganas m√∫sculo lentamente. El resto ser√° grasa. Evita el ‚Äúbulking‚Äù extremo.</li>`;
        } else {
            resultsHTML += `<li><strong>Mantenimiento cal√≥rico:</strong> Igual a tu GET</li>`;
            resultsHTML += `<li><strong>Prote√≠na:</strong> 1.2‚Äì1.8 g/kg</li>`;
        }

        resultsHTML += `<li><strong>Monitorizaci√≥n:</strong> P√©sate semanalmente y ajusta seg√∫n progreso</li>`;
        resultsHTML += `</ul></div>`;
        // === üìå FASE RECOMENDADA ===
        resultsHTML += `
					<div class="notes-section" style="border-left: 4px solid #ff9800; background: #fff3e0;">
						<h4>üìå Fase Recomendada: ${recommendedPhase}</h4>
						${phaseExplanation}
						${isMixedPhase ? `
						<p><strong>¬øC√≥mo funciona?</strong></p>
						<ul>
							<li><strong>Alimentaci√≥n:</strong> Calor√≠as cercanas al mantenimiento o d√©ficit leve (100‚Äì300 kcal)</li>
							<li><strong>Prote√≠na:</strong> Alta (2.2‚Äì2.6 g/kg de peso corporal)</li>
							<li><strong>Entrenamiento:</strong> Fuerza progresiva 4‚Äì5 veces/semana</li>
							<li><strong>Progreso:</strong> P√©rdida lenta de grasa (0.2‚Äì0.4 kg/semana) + ganancia muscular gradual</li>
						</ul>
						<p><em>üí° Nota: Puede que tu peso no baje r√°pido, pero tu f√≠sico cambiar√°: m√°s definido y tonificado.</em></p>
						` : ''}
					</div>`;

        // === ü•ó ESTRATEGIAS DIET√âTICAS RECOMENDADAS POR FASE ===
        let dietStrategiesHTML = `<div class="notes-section"><h4>ü•ó Estrategias Diet√©ticas Recomendadas</h4>`;

        // Definir estrategias por fase
        if (recommendedPhase.includes('Fase Mixta')) {
            dietStrategiesHTML += `
							<p><strong>Para tu perfil (alta grasa + baja masa magra), estas estrategias maximizan la recomposici√≥n:</strong></p>
							<ul>
								<li><strong>Hiperproteica (2.2‚Äì2.6 g/kg):</strong> Prioriza la construcci√≥n muscular. Ej: ${Math.round(currentWeightKg * 2.4)} g de prote√≠na/d√≠a.</li>
								<li><strong>Carb Cycling (d√≠as altos/bajos HC):</strong> M√°s carbohidratos en d√≠as de entreno, menos en reposo. Mantiene energ√≠a sin acumular grasa.</li>
								<li><strong>TKD (25‚Äì50g HC pre/post entreno):</strong> Ideal si entrenas en d√©ficit. Mejora rendimiento sin salir de cetosis metab√≥lica.</li>
								<li><strong>Timing nutricional:</strong> Consume prote√≠na (0.4 g/kg) y HC tras el entreno para maximizar recuperaci√≥n.</li>
								<li><strong>Flexible Dieting (80/20):</strong> Enf√≥cate en objetivos cal√≥ricos y de macros. Permite sostenibilidad a largo plazo.</li>
								<li><strong>Refeed semanal (1 d√≠a HC alto):</strong> Ayuda a regular hormonas del hambre y mantener el metabolismo.</li>
								<li><strong>üü° Cetog√©nica (cetosis estricta, <50g HC/d√≠a):</strong> Puede acelerar la p√©rdida inicial de grasa y reducir apetito, pero <strong>solo recomendada si:</strong>
										<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
											<li>No realizas entrenamientos de alta intensidad o fuerza frecuentes</li>
											<li>Eres sedentario o tu nivel de actividad es leve</li>
											<li>Tienes buena tolerancia metab√≥lica a las grasas</li>
										</ul>
										<em>‚ö†Ô∏è No recomendada para deportistas: puede reducir rendimiento, volumen de entrenamiento y retenci√≥n muscular.</em>
								</li>
									<li><strong>üü° Protein Cycling (4 semanas altas + 1 semana baja prote√≠na):</strong> Enfoque experimental. Algunos teorizan que "resetea" la s√≠ntesis proteica, pero <strong>la evidencia es d√©bil</strong>.
										<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
											<li>Puede usarse en fases largas de p√©rdida para variar est√≠mulos</li>
											<li>No interrumpir en semanas clave de progreso</li>
										</ul>
										<em>üí° Si lo usas: semana baja = 1.2‚Äì1.4 g/kg, luego vuelve a 2.4+ g/kg.</em>
									</li>
								</ul>
							<p><em>Evita cetosis estricta o ayunos prolongados si afectan tu rendimiento.</em></p>
						`;
        } else if (recommendedPhase.includes('P√©rdida de Grasa')) {
            dietStrategiesHTML += `
							<p><strong>Objetivo: perder grasa preservando m√∫sculo. Estrategias efectivas:</strong></p>
							<ul>
								<li><strong>‚úÖ Hiperproteica (2.2‚Äì2.6 g/kg):</strong> Esencial para proteger masa muscular. Ej: ${Math.round(currentWeightKg * 2.4)} g de prote√≠na/d√≠a.</li>
								<li><strong>‚úÖ Flexible Dieting (80/20):</strong> Mayor adherencia. No necesitas alimentos "perfectos", solo equilibrio cal√≥rico y de macros.</li>
								<li><strong>‚úÖ IF 16:8:</strong> Puede ayudar a controlar el apetito y simplificar la alimentaci√≥n, especialmente si no tienes hambre por la ma√±ana.</li>e p√©rdida.</li>
								<li><strong>üü° Cetog√©nica (cetosis estricta, <50g HC/d√≠a):</strong> Puede acelerar la p√©rdida inicial de grasa y reducir apetito, pero <strong>solo recomendada si:</strong>
									<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
										<li>No realizas entrenamientos de alta intensidad o fuerza frecuentes</li>
								<li><strong>‚úÖ Refeed (1 d√≠a/semana HC alto):</strong> √ötil en d√©ficits prolongados (>8 semanas). Ayuda a regular leptina, mejorar energ√≠a y mantener el metabolismo.</li>
								<li><strong>‚úÖ TKD (25‚Äì50g HC pre/post entreno):</strong> Ideal si entrenas intenso y sigues bajo en carbohidratos. Mantiene rendimiento sin salir del objetivo d
										<li>Eres sedentario o tu nivel de actividad es leve</li>
										<li>Tienes buena tolerancia metab√≥lica a las grasas</li>
									</ul>
									<em>‚ö†Ô∏è No recomendada para deportistas: puede reducir rendimiento, volumen de entrenamiento y retenci√≥n muscular.</em>
								</li>
								<li><strong>üü° Protein Cycling (4 semanas altas + 1 semana baja prote√≠na):</strong> Enfoque experimental. Algunos teorizan que "resetea" la s√≠ntesis proteica, pero <strong>la evidencia es d√©bil</strong>.
									<ul style="font-size: 0.9em; margin-top: 5px; padding-left: 20px;">
										<li>Puede usarse en fases largas de p√©rdida para variar est√≠mulos</li>
										<li>No interrumpir en semanas clave de progreso</li>
									</ul>
									<em>üí° Si lo usas: semana baja = 1.2‚Äì1.4 g/kg, luego vuelve a 2.4+ g/kg.</em>
								</li>
							</ul>
							<p><em>üîë Clave: el d√©ficit cal√≥rico es lo m√°s importante. Las estrategias ayudan, pero no sustituyen el balance energ√©tico.</em></p>
						`;

        } else if (recommendedPhase.includes('Ganancia de Masa Muscular')) {
            dietStrategiesHTML += `
							<p><strong>Objetivo: ganar m√∫sculo con m√≠nimo aumento de grasa. Estrategias clave:</strong></p>
							<ul>
								<li><strong>‚úÖ Hiperproteica (1.8‚Äì2.2 g/kg):</strong> Base para la hipertrofia. Ej: ${Math.round(currentWeightKg * 2.0)} g/d√≠a.</li>
								<li><strong>‚úÖ Carb Cycling:</strong> D√≠as de entreno: HC altos (4‚Äì6 g/kg); reposo: moderados/bajos.</li>
								<li><strong>‚úÖ CKD o 5+2 HC:</strong> 5 d√≠as moderados, 2 d√≠as altos (150‚Äì500g). Ideal para deportistas.</li>
								<li><strong>‚úÖ Timing nutricional:</strong> HC + prote√≠na post-entreno para m√°xima s√≠ntesis muscular.</li>
								<li><strong>‚úÖ Carb-loading (pre-entrenos intensos):</strong> Aumenta rendimiento en sesiones clave.</li>
								<li><strong>‚úÖ Flexible Dieting:</strong> Para mantener adherencia sin obsesionarse con "alimentos limpios".</li>
							</ul>
							<p><em>‚ùå Evita cetosis estricta: limita rendimiento y adaptaciones musculares.</em></p>
						`;
        } else {
            // Mantenimiento o afinamiento
            dietStrategiesHTML += `
							<p><strong>Objetivo: mantener tu composici√≥n corporal con h√°bitos sostenibles:</strong></p>
							<ul>
								<li><strong>‚úÖ Flexible Dieting (80/20):</strong> Enfoque m√°s realista y duradero. Prioriza disfrute y equilibrio.</li>
								<li><strong>‚úÖ Hiperproteica (1.6‚Äì2.0 g/kg):</strong> Ayuda a mantener masa muscular. Ej: ${Math.round(currentWeightKg * 1.8)} g/d√≠a.</li>
								<li><strong>‚úÖ IF 16:8 o Carb Cycling:</strong> Si encajan con tu rutina. No obligatorios, pero √∫tiles para auto-regulaci√≥n.</li>
								<li><strong>‚úÖ Timing proteico:</strong> Distribuye prote√≠na en 3‚Äì5 comidas (0.4 g/kg por comida).</li>
							</ul>
							<p><em>En mantenimiento, la sostenibilidad es m√°s importante que la estrategia espec√≠fica.</em></p>
						`;
        }

        dietStrategiesHTML += `</div>`;




        // A√±adir al resultado final
        resultsHTML += dietStrategiesHTML;


        // === ‚ö†Ô∏è VALIDACI√ìN DE OBJETIVOS IRREALISTAS (versi√≥n corregida) ===
        function showUnrealisticGoalWarning(message) {
            alert("‚ö†Ô∏è Advertencia: Objetivo poco realista\n\n" + message);
        }

        // --- 1. Detectar ganancia muscular excesiva ---
        if (goalTypeGlobal === 'ganancia1') {
            const leanGainKg = targetLeanMassKg - currentLeanMassKg;
            const weeks = estimatedWeeksGlobal || 16;
            const leanGainPerWeek = leanGainKg / weeks;

            // Estimar si es principiante (sin hasTrainedBefore)
            const isBeginner = (function () {
                const lowLean = (userGender === 'male' && currentLeanMassPerc < 70) ||
                    (userGender === 'female' && currentLeanMassPerc < 65);
                const highFat = (userGender === 'male' && currentFatPerc > 25) ||
                    (userGender === 'female' && currentFatPerc > 32);
                const isYoung = userAge < 50;
                const activityLevel = document.getElementById('nivel-actividad')?.value?.toLowerCase();
                const isLowActivity = ['sedentario', 'leve'].includes(activityLevel);
                return (lowLean || highFat) && isLowActivity && isYoung;
            })();

            // Ganancia m√°xima realista por semana (en kg)
            const maxGainPerWeek = isBeginner
                ? 0.8  // Principiante: mayor hipertrofia inicial
                : 0.5; // Intermedio/avanzado

            if (leanGainPerWeek > maxGainPerWeek * 1.5) {
                const realisticMaxGain = (maxGainPerWeek * weeks).toFixed(1);
                const timeNeeded = (leanGainKg / maxGainPerWeek).toFixed(1);

                showUnrealisticGoalWarning(
                    `Est√°s buscando ganar ${leanGainKg.toFixed(1)} kg de masa magra en ${weeks} semanas.\n\n` +
                    `La ganancia muscular realista es de ${maxGainPerWeek.toFixed(2)} kg/semana.\n\n` +
                    `M√°ximo esperado en este tiempo: ~${realisticMaxGain} kg.\n\n` +
                    `Para lograr ${leanGainKg.toFixed(1)} kg, necesitar√≠as ~${timeNeeded} semanas (${(timeNeeded / 4.3).toFixed(1)} meses) como m√≠nimo.\n\n` +
                    `Recuerda: no todo el peso ganado ser√° m√∫sculo. Parte ser√° grasa y agua.`
                );
            }
        }

        // --- 2. P√©rdida de grasa demasiado r√°pida ---
        if (goalTypeGlobal === 'perdida1') {
            const fatToLoseKg = currentFatMassKg - targetFatMassKg;
            const weeks = estimatedWeeksGlobal || 16;
            const fatLossPerWeek = fatToLoseKg / weeks;

            const maxSafeLossPerWeek = currentWeightKg * 0.01; // 1% del peso corporal

            if (fatLossPerWeek > 1.0 || fatLossPerWeek > maxSafeLossPerWeek) {
                const maxPossible = (maxSafeLossPerWeek * weeks).toFixed(1);

                showUnrealisticGoalWarning(
                    `Est√°s buscando perder ${fatToLoseKg.toFixed(1)} kg de grasa en ${weeks} semanas.\n\n` +
                    `Una p√©rdida segura es de 0.5‚Äì1.0 kg/semana (m√°ximo ~${maxSafeLossPerWeek.toFixed(1)} kg/semana).\n\n` +
                    `P√©rdidas m√°s r√°pidas pueden causar p√©rdida muscular, bajos niveles de energ√≠a y rebote.\n\n` +
                    `Te recomendamos no superar ${maxPossible} kg en este periodo para un proceso saludable.`
                );
            }
        }

        // --- 3. Recomposici√≥n imposible ---
        if (desiredLeanGainKg > 3 && fatMassToLoseGainKg > 3 && estimatedWeeksGlobal < 20) {
            showUnrealisticGoalWarning(
                `Tu objetivo combina una gran ganancia muscular (${desiredLeanGainKg.toFixed(1)} kg) ` +
                `con una p√©rdida significativa de grasa (${fatMassToLoseGainKg.toFixed(1)} kg) en solo ~${estimatedWeeksGlobal} semanas.\n\n` +
                `Esto es extremadamente dif√≠cil de lograr, incluso para principiantes.\n\n` +
                `Recomendamos enfocarte primero en una fase clara:\n` +
                `- Si tienes grasa >25%: p√©rdida de grasa\n` +
                `- Si tienes grasa <25%: ganancia muscular controlada\n\n` +
                `La recomposici√≥n corporal es lenta y solo viable en casos espec√≠ficos.`
            );
        }

        // --- 4. Cambio de peso demasiado r√°pido ---
        const totalWeightChangePerWeek = Math.abs(totalWeightChangeKg) / (estimatedWeeksGlobal || 1);
        if (totalWeightChangePerWeek > 1.2) {
            showUnrealisticGoalWarning(
                `Tu objetivo implica un cambio de peso de ${totalWeightChangePerWeek.toFixed(2)} kg/semana.\n\n` +
                `Cambios mayores a 1.2 kg/semana no son sostenibles ni saludables.\n\n` +
                `Pueden causar p√©rdida muscular, problemas metab√≥licos o rebote.\n\n` +
                `Recomendamos un ritmo de 0.3‚Äì1.0 kg/semana para mejores resultados a largo plazo.`
            );
        }
        // === üîÅ ACTUALIZAR SELECT DE OBJETIVO SEG√öN FASE RECOMENDADA ===
        // === üîÅ FORZAR SELECT A OBJETIVO RECOMENDADO + MENSAJE EDUCATIVO ===
        //const objetivoSelect = document.getElementById('objetivo');
        const objectiveFeedbackContainer = document.getElementById('objective-feedback') || (() => {
            // Si no existe, crear contenedor bajo el select
            const container = document.createElement('div');
            container.id = 'objective-feedback';
            container.style.margin = '8px 0';
            container.style.fontSize = '0.9em';
            objetivoSelect.parentNode.insertBefore(container, objetivoSelect.nextSibling);
            return container;
        })();

        if (objetivoSelect && recommendedPhase) {
            let valueToSelect = 'sel';
            let displayName = 'Selecciona segun Objetivo';
            let explanation = '';

            if (recommendedPhase.includes('P√©rdida') || recommendedPhase.includes('prioridad m√°xima')) {
                valueToSelect = 'perdida1';
                displayName = 'P√©rdida de Peso';
                explanation = 'Te recomendamos perder grasa porque tienes un porcentaje elevado. Este enfoque mejora tu salud y prepara tu cuerpo para ganar m√∫sculo despu√©s.';
            }
            else if (recommendedPhase.includes('Ganancia')) {
                valueToSelect = 'ganancia1';
                displayName = 'Ganancia de Peso';
                explanation = 'Tu nivel de grasa es adecuado para ganar m√∫sculo. Un super√°vit cal√≥rico moderado te ayudar√° a construir masa muscular eficientemente.';
            }
            else if (recommendedPhase.includes('Mantenimiento')) {
                valueToSelect = 'mantenimiento1';
                displayName = 'Mantenimiento';
                explanation = 'Est√°s cerca de tu objetivo. Mantener tu peso actual te permite consolidar h√°bitos y prepararte para futuros cambios.';
            }
            else if (recommendedPhase.includes('Mixta') || recommendedPhase.includes('Recomposici√≥n') || recommendedPhase.includes('Combinada')) {
                valueToSelect = 'mixto1';
                displayName = 'Mixto/Combinado';
                explanation = 'Puedes mejorar tu composici√≥n corporal perdiendo grasa y ganando m√∫sculo al mismo tiempo. Ideal si eres principiante o tienes grasa alta + poca masa muscular.';
            }

            // --- 1. Forzar el valor del select ---
            objetivoSelect.value = valueToSelect;
            objetivoSelect.dispatchEvent(new Event('change')); // Actualiza el resto de la interfaz

            // --- 2. Mostrar mensaje educativo ---
            objectiveFeedbackContainer.innerHTML = `
										<div style="
											background-color: #e3f2fd; 
											border: 1px solid #bbdefb; 
											border-radius: 6px; 
											padding: 12px; 
											font-size: 0.95em; 
											color: #1565c0; 
											line-height: 1.5;
										">
											<strong>üéØ Objetivo recomendado: ${displayName}</strong>
											<p style="margin: 8px 0; opacity: 0.9;">
												${explanation}
											</p>
											<small style="color: #555;">
												Puedes cambiarlo manualmente si lo deseas, pero esta opci√≥n es la m√°s adecuada para tu perfil actual.
											</small>
										</div>
									`;
        }
        // === MOSTRAR RESULTADOS ===
        const weightGoalResult = document.getElementById('weight-goal-result');
        if (weightGoalResult) {
            weightGoalResult.style.display = 'block';
            weightGoalResult.style.opacity = '0';
            setTimeout(() => {
                weightGoalResult.style.transition = 'opacity 0.4s ease';
                weightGoalResult.style.opacity = '1';
            }, 100);
        }
        weightGoalResultDiv.innerHTML = resultsHTML;

        // Show chart if applicable
        if (goalTypeGlobal !== 'maintenance' && estimatedWeeksGlobal > 1 && weightChartContainer) {
            generateWeightEvolutionChart(currentWeightKg, targetWeightKgGlobal, estimatedWeeksGlobal);
            weightChartContainer.style.display = 'block';
        }
        // Mostrar weight-goal-result con animaci√≥n



        // === üå´Ô∏è MOSTRAR MODAL CON FADE IN/OUT + INFO NUTRICIONAL ===
        setTimeout(() => {
            const objetivoSelect = document.getElementById('objetivo');
            const selectedObjective = objetivoSelect?.value;

            if (!selectedObjective || selectedObjective === 'sel') return;

            // === üîç CONFIGURACI√ìN DE FASES + INFO EDUCATIVA ===
            const faseConfig = {
                perdida1: {
                    title: "Elige tu Fase (P√©rdida de Peso)",
                    options: [
                        {
                            value: "induccion_cetogenica1",
                            label: "Inducci√≥n Cetog√©nica",
                            info: `
											<strong>Muy baja en carbohidratos / Cetog√©nica (VLCKD)</strong><br>
											<strong>CH diarios:</strong> <50 g/d√≠a (20‚Äì30 g t√≠pico)<br>
											<strong>% Energ√≠a:</strong> 5‚Äì10% de HC<br>
											<strong>Caracter√≠sticas:</strong> Alta en grasas (70-80%), moderada en prote√≠nas. Induce cetosis. Elimina cereales, az√∫cares, frutas, legumbres.<br>
											<strong>Relaci√≥n grasa:(prote√≠na+HC):</strong> 2:1 a 4:1<br>
											<strong>Cu√°ndo usarla:</strong> Obesidad con s√≠ndrome metab√≥lico, diabetes tipo 2, h√≠gado graso. <em>Debe ser supervisada.</em>
										`
                        },
                        {
                            value: "ciclado_metabolico1",
                            label: "Ciclado Metab√≥lico",
                            info: `
											<strong>Ciclado de carbohidratos (Carb Cycling)</strong><br>
											<strong>Estrategia:</strong> D√≠as de HC bajos (30‚Äì100g) en reposo, d√≠as altos (200‚Äì400g) en entrenos.<br>
											<strong>Caracter√≠sticas:</strong> Combina beneficios de cetosis y recarga de gluc√≥geno. Mantiene rendimiento y flexibilidad metab√≥lica.<br>
											<strong>Cu√°ndo usarlo:</strong> P√©rdida de grasa con preservaci√≥n muscular, deportistas en d√©ficit, personas con alta adherencia.
										`
                        },
                        {
                            value: "transicion_mantenimiento1",
                            label: "Transici√≥n a Mantenimiento",
                            info: `
											<strong>Moderada en carbohidratos</strong><br>
											<strong>CH diarios:</strong> 100‚Äì150 g/d√≠a<br>
											<strong>% Energ√≠a:</strong> 26‚Äì45% de HC<br>
											<strong>Caracter√≠sticas:</strong> Flexible, incluye cereales integrales, frutas, legumbres. D√©ficit cal√≥rico leve.<br>
											<strong>Cu√°ndo usarla:</strong> Fin de una fase de p√©rdida, para evitar el efecto rebote y estabilizar el metabolismo.
										`
                        }
                    ],
                    targetSelectId: "fasePerdida1",
                    labelId: "labelFasePerdida1"
                },
                ganancia1: {
                    title: "Elige tu Fase (Ganancia de Peso)",
                    options: [
                        {
                            value: "volumen1",
                            label: "Volumen Muscular",
                            info: `
											<strong>Volumen Muscular</strong><br>
											<strong>Grasas:</strong> 25‚Äì35%<br>
											<strong>Prote√≠nas:</strong> 25‚Äì30% (1.6‚Äì2.2 g/kg)<br>
											<strong>HC:</strong> 40‚Äì50% (300‚Äì500g/d√≠a)<br>
											<strong>Objetivo:</strong> Super√°vit moderado para hipertrofia con control de grasa.
										`
                        },
                        {
                            value: "masa1",
                            label: "Enfocado en Masa Muscular",
                            info: `
											<strong>Enfocado en Masa Muscular</strong><br>
											<strong>√ânfasis:</strong> HC complejos (arroz, avena, patata) y prote√≠na post-entreno.<br>
											<strong>Super√°vit:</strong> 10‚Äì15% sobre el gasto.<br>
											<strong>Objetivo:</strong> Maximizar ganancia muscular, incluso con algo de grasa.
										`
                        }
                    ],
                    targetSelectId: "faseGanancia1",
                    labelId: "labelFaseGanancia1"
                },
                mantenimiento1: {
                    title: "Elige tu Enfoque (Mantenimiento)",
                    options: [
                        {
                            value: "equilibrio1",
                            label: "Equilibrio Flexible",
                            info: `
											<strong>Equilibrio Flexible</strong><br>
											<strong>Grasas:</strong> 30‚Äì35%<br>
											<strong>Prote√≠nas:</strong> 20‚Äì25% (1.6‚Äì2.0 g/kg)<br>
											<strong>HC:</strong> 35‚Äì45% (200‚Äì300g/d√≠a)<br>
											<strong>Objetivo:</strong> Sostenibilidad a largo plazo, sin d√©ficit ni super√°vit.
										`
                        },
                        {
                            value: "social1",
                            label: "Adherencia Social",
                            info: `
											<strong>Adherencia Social</strong><br>
											<strong>Flexibilidad:</strong> Mayor tolerancia a HC en comidas sociales.<br>
											<strong>Prote√≠na:</strong> Moderada, distribuida.<br>
											<strong>Objetivo:</strong> Mantener h√°bitos sin rigidez, ideal para vida activa.
										`
                        }
                    ],
                    targetSelectId: "enfoqueMantenimiento1",
                    labelId: "labelEnfoqueMantenimiento1"
                },
                mixto1: {
                    title: "Elige tu Fase (Mixto/Combinado)",
                    options: [
                        {
                            value: "volumen1",
                            label: "Volumen",
                            info: `
											<strong>Periodizaci√≥n: Volumen</strong><br>
											<strong>HC:</strong> 40‚Äì50%<br>
											<strong>Prote√≠na:</strong> 25‚Äì30%<br>
											<strong>Objetivo:</strong> Ganancia muscular con d√©ficit leve o mantenimiento.
										`
                        },
                        {
                            value: "definicion1",
                            label: "Definici√≥n",
                            info: `
											<strong>Periodizaci√≥n: Definici√≥n</strong><br>
											<strong>HC:</strong> 10‚Äì25%<br>
											<strong>Prote√≠na:</strong> 25‚Äì35%<br>
											<strong>Objetivo:</strong> P√©rdida de grasa con preservaci√≥n muscular.
										`
                        },
                        {
                            value: "mantenimiento1",
                            label: "Mantenimiento",
                            info: `
											<strong>Periodizaci√≥n: Mantenimiento</strong><br>
											<strong>HC:</strong> 30‚Äì40%<br>
											<strong>Prote√≠na:</strong> 20‚Äì25%<br>
											<strong>Objetivo:</strong> Estabilizar composici√≥n, recuperar hormonas, prevenir rebote.
										`
                        }
                    ],
                    targetSelectId: "faseMixto1",
                    labelId: "labelFaseMixto1"
                }
            };

            const config = faseConfig[selectedObjective];
            if (!config) return;

            // === üß± CREAR MODAL CON INFO ===
            const modal = document.createElement('div');
            modal.id = 'phase-selection-modal';
            modal.style.cssText = `
							position: fixed; top: 0; left: 0; width: 100%; height: 100%;
							background: rgba(0, 0, 0, 0); display: flex; justify-content: center;
							align-items: center; z-index: 2000; font-family: Arial, sans-serif;
							transition: background 0.4s ease;
						`;

            modal.innerHTML = `
							<div class="modal-content" style="
								opacity: 0; transform: scale(0.9);
								transition: opacity 0.3s ease, transform 0.3s ease;
								background: white; border-radius: 12px; width: 90%; max-width: 600px;
								padding: 24px; box-shadow: 0 8px 30px rgba(0,0,0,0.2);
								max-height: 90vh; overflow-y: auto;
							">
								<h3 style="margin: 0 0 16px; color: #1976d2;">${config.title}</h3>
								<p style="color: #555; font-size: 0.95em; margin-bottom: 16px;">
									Selecciona la fase que mejor se adapte a tu estilo de vida y objetivos. 
									<strong>Desplaza para ver detalles de cada opci√≥n.</strong>
								</p>
								<ul style="list-style: none; padding: 0; margin: 16px 0;">
									${config.options.map(opt => `
										<li style="margin: 12px 0;">
											<label style="
												display: block; cursor: pointer; padding: 12px; border: 1px solid #ddd;
												border-radius: 8px; background: #f9f9f9; transition: background 0.2s;
											" onmouseover="this.style.background='#f0f4f8'" onmouseout="this.style.background='#f9f9f9'">
												<div style="display: flex; align-items: center; margin-bottom: 6px;">
													<input type="radio" name="phaseOption" value="${opt.value}" style="margin-right: 10px;">
													<strong style="font-size: 1.05em; color: #228720;">${opt.label}</strong>
												</div>
												<div style="font-size: 0.9em; color: #444; line-height: 1.5; padding-left: 28px;">
													${opt.info}
												</div>
											</label>
										</li>
									`).join('')}
								</ul>
								<div style="text-align: right; margin-top: 16px;">
									<button id="cancelModal" style="
										background: #e0e0e0; color: #333; border: none; padding: 8px 16px;
										border-radius: 4px; cursor: pointer; margin-right: 8px; font-size: 0.95em;
									">Cancelar</button>
									<button id="confirmPhase" style="
										background: #205e22; color: white; border: none; padding: 8px 16px;
										border-radius: 4px; cursor: pointer; font-size: 0.95em;
									">Seleccionar</button>
								</div>
							</div>
						`;

            document.body.appendChild(modal);

            // ‚úÖ FADE IN
            setTimeout(() => {
                modal.style.background = 'rgba(0, 0, 0, 0.7)';
                modal.querySelector('.modal-content').style.opacity = '1';
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 100);

            // ‚úÖ FADE OUT + limpieza
            function closeModal() {
                modal.style.background = 'rgba(0, 0, 0, 0)';
                const content = modal.querySelector('.modal-content');
                content.style.opacity = '0';
                content.style.transform = 'scale(0.9)';
                setTimeout(() => modal.remove(), 300);
            }

            // Acciones
            const confirmBtn = modal.querySelector('#confirmPhase');
            const cancelBtn = modal.querySelector('#cancelModal');

            confirmBtn.onclick = function () {
                const selected = modal.querySelector('input[name="phaseOption"]:checked');
                if (!selected) {
                    alert('‚ö†Ô∏è Por favor, selecciona una fase.');
                    return;
                }
                const selectedValue = selected.value; // Ej: 'induccion_cetogenica1'
                const targetSelect = document.getElementById(config.targetSelectId);
                const targetLabel = document.getElementById(config.labelId);

                // === 1. Establecer el valor en el <select> correspondiente ===
                if (targetSelect) {
                    targetSelect.value = selected.value;
                    targetSelect.dispatchEvent(new Event('change'));
                }
                // === 2. Mostrar el <label> si estaba oculto ===
                if (targetLabel) {
                    targetLabel.style.display = 'block';
                }
                // === 3. Establecer goalTypeGlobal seg√∫n el objetivo actual ===
                // selectedObjective ya est√° definido fuera (es el valor de 'objetivo')
                const selectedObjective = objetivoSelect.value;

                if (['perdida1', 'ganancia1', 'mantenimiento1', 'mixto1'].includes(selectedObjective)) {
                    window.goalTypeGlobal = selectedObjective; // Aseguramos que sea global
                } else {
                    window.goalTypeGlobal = 'maintenance'; // valor por defecto
                }
                //
                // === 4. Establecer TDEE s ===
                document.getElementById('get-calories').value = window.calculatedTDEE;
                if (goalTypeGlobal === 'perdida1') document.getElementById('goal-calories').value = Math.round(calculatedTDEE * 0.85);
                if (goalTypeGlobal === 'ganancia1') document.getElementById('goal-calories').value = Math.round(calculatedTDEE * 1.1);
                if (goalTypeGlobal === 'mantenimiento1') document.getElementById('goal-calories').value = Math.round(calculatedTDEE);
                if (goalTypeGlobal === 'mixto') document.getElementById('goal-calories').value = Math.round(calculatedTDEE * 0.95);


                // === 5. Establecer valores paso 3 = Estimaci√≥n de Tiempo s ===	
                document.getElementById('weight-change-goal').value = Math.abs(totalWeightChangeKg).toFixed(0);
                document.getElementById('weekly-calorie-diff').value = Math.abs(targetWeeklyRateKgGlobal).toFixed(0);
                const map = {
                    perdida1: 'perdida',
                    ganancia1: 'ganancia',
                    mantenimiento1: 'mantenimiento',
                    mixto1: 'mixto'            // <-- a√±ade esta l√≠nea si "mixto" tambi√©n puede venir del <select>
                };

                const ob = map[document.getElementById('objetivo').value] || '';

                let weeklyDiff;
                switch (ob) {
                    case 'perdida':
                        weeklyDiff = -3500;
                        document.getElementById('weight-change-goal').value = (-Math.abs(totalWeightChangeKg)).toFixed(0);
                        break;
                    case 'ganancia':
                        weeklyDiff = 2000;
                        document.getElementById('weight-change-goal').value = Math.abs(totalWeightChangeKg).toFixed(0);
                        break;
                    case 'mantenimiento':
                        weeklyDiff = 0;
                        document.getElementById('weight-change-goal').value = 0
                        break;
                    case 'mixto':
                        weeklyDiff = 1000;
                        document.getElementById('weight-change-goal').value = (-Math.abs(totalWeightChangeKg)).toFixed(0);
                        break;
                    default:
                        weeklyDiff = 0;          // valor por defecto si no coincide
                }


                document.getElementById('weekly-calorie-diff').value = weeklyDiff;
                // Mostrar planificaci√≥n temporal con animaci√≥n
                const planificacionTemporal = document.getElementById('planificacion-temporal');
                if (planificacionTemporal) {
                    planificacionTemporal.style.display = 'block';
                    planificacionTemporal.style.opacity = '0';
                    setTimeout(() => {
                        planificacionTemporal.style.transition = 'opacity 0.4s ease';
                        planificacionTemporal.style.opacity = '1';
                    }, 100);
                }

                // ‚úÖ Opcional: depuraci√≥n
                console.log("‚úÖ Fase guardada:", selectedValue);
                console.log("‚úÖ Objetivo (goalTypeGlobal):", window.goalTypeGlobal);

                closeModal();
            };

            cancelBtn.onclick = closeModal;
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };

        }, 500);
        resetStep3onwards();
    }
    // Set goal calories in Step 3
    //if (calculatedTDEE && goalCaloriesInput) {
    //let suggestedGoalCalories = calculatedTDEE;
    //if (goalTypeGlobal === 'perdida1') suggestedGoalCalories *= 0.90;
    //else if window.goalTypeGlobal === 'ganancia1') suggestedGoalCalories *= 1.10;
    //goalCaloriesInput.value = Math.round(suggestedGoalCalories);
    //}

    // Update macros
    if (proteinPercentageInput && carbPercentageInput && fatPercentageInput) {
        setTimeout(() => actualizarMacrosPorFase(), 100);
    }


    // <-- Esta llave cierra correctamente la funci√≥n calculateWeightGoal

    // --- Helper Function to Generate Weight Evolution Chart (Step 2) ---
    // NOTA: Esta funci√≥n debe definirse FUERA de calculateWeightGoal
    function generateWeightEvolutionChart(startWeight, endWeight, weeks) {
        if (!weightChartContainer) return; // Exit if container not found
        weightChartContainer.innerHTML = '<canvas id="weightEvolutionChart"></canvas>'; // Ensure canvas exists
        const ctx = document.getElementById('weightEvolutionChart')?.getContext('2d');
        if (!ctx) {
            console.error("Failed to get canvas context for weightEvolutionChart");
            return;
        }
        // Destroy previous instance if exists
        if (weightEvolutionChartInstance) { weightEvolutionChartInstance.destroy(); }
        const labels = Array.from({ length: weeks + 1 }, (_, i) => `Sem ${i}`);
        const weightData = Array.from({ length: weeks + 1 }, (_, i) => {
            // Linear interpolation between start and end weight
            return startWeight + (endWeight - startWeight) * (i / weeks);
        });
        weightEvolutionChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Peso Estimado (kg) - Auto',
                    weightData,
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    title: { display: true, text: `Evoluci√≥n Estimada del Peso (${weeks} Semanas - Auto)` },
                    tooltip: { callbacks: { label: function (context) { return `Semana ${context.dataIndex}: ${context.parsed.y.toFixed(2)} kg`; } } }
                },
                scales: {
                    y: { title: { display: true, text: 'Peso (kg)' }, ticks: { callback: function (value) { return value.toFixed(1); } } },
                    x: { title: { display: true, text: 'Semanas' } }
                }
            }
        });
    }

    // --- Helper Function to Generate Monitoring Info HTML ---
    // NOTA: Esta funci√≥n tambi√©n debe definirse FUERA de calculateWeightGoal
    function generateMonitoringHTML() {
        // Static content, can be adjusted if needed
        let monitoringHTML = `<div class="monitoring-section"><h4>Monitorizaci√≥n y Ajustes Sugeridos</h4><h5>An√°lisis de Sangre</h5><ul><li><strong>Frecuencia:</strong> Cada 12-16 semanas (aproximadamente cada 2-3 ciclos).</li><li><strong>Par√°metros a evaluar:</strong><ul><li>Funci√≥n renal: Creatinina y TFG.</li><li>Funci√≥n hep√°tica: ALT, AST, bilirrubina.</li><li>Colesterol: Total, LDL, HDL, triglic√©ridos.</li></ul></li><li><strong>Momentos clave sugeridos (ejemplo para ~55 semanas):</strong><ul><li>Inicio (semana 0).</li><li>Mitad del plan (~semana 28).</li><li>Final (~semana 55).</li></ul><em>Ajusta estos momentos a la duraci√≥n real de tu plan.</em></li></ul><h5>Reevaluaci√≥n de Composici√≥n Corporal</h5><ul><li><strong>Frecuencia:</strong> Cada 8-12 semanas, idealmente al final de cada ciclo completo.</li><li><strong>Momentos sugeridos (ejemplo para ~55 semanas con ciclos de 7 sem):</strong><ul><li>Semana 7 (final Ciclo 1).</li><li>Semana 21 (final Ciclo 3).</li><li>Semana 35 (final Ciclo 5).</li><li>Semana 49 (final Ciclo 7).</li></ul><em>Ajusta estos momentos a la duraci√≥n real de tu plan y tus ciclos.</em></li><li><strong>M√©todo:</strong> Bioimpedancia o DEXA.</li><li><strong>Ajustes:</strong> Recalcular GET y ajustar calor√≠as/macros seg√∫n nuevo peso/composici√≥n.</li></ul></div>`;
        return monitoringHTML;
    }

    // --- Funciones de apoyo para macros ---

    // Funci√≥n para ajustar y mostrar el total de porcentajes de macros
    function adjustMacroPercentages() {
        const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
        const proteinPercentageInput = document.getElementById('protein-percentage');
        const carbPercentageInput = document.getElementById('carb-percentage');
        const fatPercentageInput = document.getElementById('fat-percentage');

        if (!macroPercentageTotalDiv || !proteinPercentageInput || !carbPercentageInput || !fatPercentageInput) {
            return;
        }

        const p = parseInt(proteinPercentageInput.value) || 0;
        const c = parseInt(carbPercentageInput.value) || 0;
        const f = parseInt(fatPercentageInput.value) || 0;
        const total = p + c + f;

        macroPercentageTotalDiv.textContent = `Total: ${total}%`;

        if (total === 100) {
            macroPercentageTotalDiv.style.color = '#388E3C';
            macroPercentageTotalDiv.innerHTML = 'Total: ' + total + '% ‚úì';
        } else {
            macroPercentageTotalDiv.style.color = '#c62828';
            macroPercentageTotalDiv.innerHTML = 'Total: ' + total + '% ‚úó';
        }
    }

    // Event listeners para actualizaci√≥n en tiempo real
    document.addEventListener('DOMContentLoaded', function () {
        const proteinInput = document.getElementById('protein-percentage');
        const carbInput = document.getElementById('carb-percentage');
        const fatInput = document.getElementById('fat-percentage');

        if (proteinInput) proteinInput.addEventListener('input', adjustMacroPercentages);
        if (carbInput) carbInput.addEventListener('input', adjustMacroPercentages);
        if (fatInput) fatInput.addEventListener('input', adjustMacroPercentages);

        adjustMacroPercentages();
    });
    // --- Step 4: Calculate Macronutrients ---

    // Variables globales
    let macroChartInstance = null;
    let modalChartInstance = null;

    // Configurar event listeners cuando el DOM est√© cargado
    document.addEventListener('DOMContentLoaded', function () {
        // Configurar el modal para reiniciar el chart cuando se cierre
        const macroChartModal = document.getElementById('macroChartModal');
        if (macroChartModal) {
            macroChartModal.addEventListener('hidden.bs.modal', function () {
                if (modalChartInstance) {
                    modalChartInstance.destroy();
                    modalChartInstance = null;
                }
            });
        }
    });

    function calculateMacros() {
        clearContainer(macroResultDiv);
        if (chartContainer) chartContainer.style.display = 'none'; // Hide macro chart
        clearContainer(step5TableContainer); // Clear previous auto table (Step 5)
        displayInfo(step5TableContainer, '<em>Calculando tabla de ciclos autom√°tica...</em>'); // Show loading message for auto table

        if (macroChartInstance) {
            macroChartInstance.destroy();
            macroChartInstance = null;
        }

        // Check prerequisites
        if (!calculatedTDEE || !targetWeightKgGlobal) {
            displayError(macroResultDiv, 'Error: Completa los Pasos 1 y 2 antes de calcular macronutrientes.');
            displayError(step5TableContainer, '<em>Error: Completa los Pasos 1 y 2 para generar la tabla de ciclos autom√°tica.</em>');
            updateButtonStates();
            return;
        }

        // Get values from form (using the potentially pre-filled values)
        const goalCalories = parseInt(goalCaloriesInput.value);
        const proteinPerc = parseInt(proteinPercentageInput.value);
        const carbPerc = parseInt(carbPercentageInput.value);
        const fatPerc = parseInt(fatPercentageInput.value);

        // Validate inputs
        if (isNaN(goalCalories) || goalCalories <= 0) {
            displayError(macroResultDiv, 'Por favor, introduce un objetivo cal√≥rico v√°lido.');
            displayError(step5TableContainer, '<em>Error: Necesitas un objetivo cal√≥rico v√°lido para generar la tabla de ciclos autom√°tica.</em>');
            calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
            resetStep4onwards(); // Reset subsequent steps
            resetStep5Table(); // Reset Step 5 table
            updateButtonStates();
            return;
        }
        if (isNaN(proteinPerc) || isNaN(carbPerc) || isNaN(fatPerc) || proteinPerc < 0 || carbPerc < 0 || fatPerc < 0) {
            displayError(macroResultDiv, 'Por favor, introduce porcentajes v√°lidos para los macronutrientes.');
            displayError(step5TableContainer, '<em>Error: Necesitas porcentajes de macros v√°lidos para generar la tabla de ciclos autom√°tica.</em>');
            calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
            resetStep4onwards(); // Reset subsequent steps
            resetStep5Table(); // Reset Step 5 table
            updateButtonStates();
            return;
        }

        const totalPercentage = proteinPerc + carbPerc + fatPerc;
        adjustMacroPercentages(); // Update total display

        if (totalPercentage !== 100) {
            displayError(macroResultDiv, `La suma de los porcentajes debe ser 100%. Actualmente es ${totalPercentage}%.`);
            displayError(step5TableContainer, '<em>Error: La suma de porcentajes de macros debe ser 100% para generar la tabla de ciclos autom√°tica.</em>');
            calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 }; // Reset macros
            resetStep4onwards(); // Reset subsequent steps
            resetStep5Table(); // Reset Step 5 table
            updateButtonStates();
            return;
        }

        // Calculate grams
        const proteinGrams = (goalCalories * (proteinPerc / 100)) / 4;
        const carbGrams = (goalCalories * (carbPerc / 100)) / 4;
        const fatGrams = (goalCalories * (fatPerc / 100)) / 9;

        // Store calculated macros globally
        calculatedMacros = { proteinGrams, carbGrams, fatGrams, goalCalories };

        let ob = document.getElementById('objetivo').value;

        if (ob === 'perdida1') {
            ob = 'perdida';
        } else if (ob === 'ganancia1') {
            ob = 'ganancia';
        } else if (ob === 'mantenimiento1') {
            ob = 'mantenimiento';
        } else if (ob === 'mixto1') {
            ob = 'mixto';
        }



        // Display macro results (MANT√âN TU C√ìDIGO ORIGINAL)
        macroResultDiv.innerHTML = `<h3>Distribuci√≥n de Macronutrientes:</h3><p>Para un objetivo de <strong>${window.goalTypeGlobal}</strong> <strong>${goalCalories} kcal/d√≠a</strong></p><ul><li><strong>Prote√≠nas:</strong> ${proteinGrams.toFixed(1)} g (${proteinPerc}%)</li><li><strong>Carbohidratos:</strong> ${carbGrams.toFixed(1)} g (${carbPerc}%)</li><li><strong>Grasas:</strong> ${fatGrams.toFixed(1)} g (${fatPerc}%)</li></ul>`;

        // Mostrar macro-result con animaci√≥n
        const macroResult = document.getElementById('macro-result');
        if (macroResult) {
            macroResult.style.display = 'block';
            macroResult.style.opacity = '0';
            setTimeout(() => {
                macroResult.style.transition = 'opacity 0.4s ease';
                macroResult.style.opacity = '1';
            }, 100);
        }


        // Preparar el gr√°fico para mostrarse en el modal
        prepareMacroChart(proteinGrams, carbGrams, fatGrams, goalCalories, proteinPerc, carbPerc, fatPerc);

        // --- Generate Detailed Cycle Table (Step 5 - Auto) ---
        if (goalTypeGlobal !== 'maintenance' && estimatedWeeksGlobal > 0 && currentWeightKg && targetWeightKgGlobal && calculatedTDEE) {
            generateDetailedCycleTable(estimatedWeeksGlobal, currentWeightKg, targetWeightKgGlobal, calculatedTDEE, calculatedMacros.goalCalories, calculatedMacros, goalTypeGlobal, targetWeeklyRateKgGlobal);
        } else if (goalTypeGlobal === 'maintenance') {
            displayInfo(step5TableContainer, '<em>No se requiere tabla de ciclos autom√°tica para un objetivo de mantenimiento.</em>');
        } else {
            displayError(step5TableContainer, '<em>Faltan datos de Pasos 1 o 2 para generar la tabla de ciclos autom√°tica.</em>');
            console.error("Missing data for detailed (auto) cycle table generation:", { estimatedWeeksGlobal, currentWeightKg, targetWeightKgGlobal, calculatedTDEE, goalTypeGlobal });
        }

        // Reset subsequent steps as Step 3 results changed
        resetStep4onwards();
        updateButtonStates(); // Enable next step button
    }

    // Funci√≥n para preparar el gr√°fico en el modal
    function prepareMacroChart(proteinGrams, carbGrams, fatGrams, goalCalories, proteinPerc, carbPerc, fatPerc) {
        // Destruir instancias previas si existen
        if (modalChartInstance) {
            modalChartInstance.destroy();
        }

        // Obtener el canvas del modal
        const modalCanvas = document.getElementById('macroChartModalCanvas');
        if (!modalCanvas) {
            console.error("No se encontr√≥ el canvas del modal");
            return;
        }

        // Crear el gr√°fico en el modal
        const modalCtx = modalCanvas.getContext('2d');
        modalChartInstance = new Chart(modalCtx, {
            type: 'doughnut',
            data: {
                labels: ['Prote√≠nas (g)', 'Carbohidratos (g)', 'Grasas (g)'],
                datasets: [{
                    label: 'Gramos por Macronutriente',
                    data: [proteinGrams.toFixed(1), carbGrams.toFixed(1), fatGrams.toFixed(1)],
                    backgroundColor: [
                        'rgba(46, 125, 50, 0.7)',
                        'rgba(52, 199, 89, 0.7)',
                        'rgba(32, 201, 151, 0.7)'
                    ],
                    borderColor: [
                        'rgba(46, 125, 50, 1)',
                        'rgba(52, 199, 89, 1)',
                        'rgba(32, 201, 151, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: `Distribuci√≥n de Macronutrientes (${goalCalories} kcal)`
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed + ' g';
                                    const dataIndex = context.dataIndex;
                                    const percentages = [proteinPerc, carbPerc, fatPerc];
                                    if (dataIndex < percentages.length) {
                                        label += ` (${percentages[dataIndex]}%)`;
                                    }
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Mostrar el enlace para abrir el modal (si existe)
        const targetIcon = document.querySelector('.target-icon');
        if (targetIcon) {
            targetIcon.style.display = 'inline-block';
        }

        document.querySelector('[data-bs-target="#macroChartModal"]')
            .style.display = 'inline-flex';
    }

    // --- Step 5: Generate Meal Plan ---
    function generateMealPlan() {
        clearContainer(mealResultDiv);

        // Check prerequisite
        if (calculatedMacros.goalCalories === 0) {
            displayError(mealResultDiv, 'Por favor, calcula primero tus macronutrientes en el Paso 3.');
            updateButtonStates();
            return;
        }

        // Get percentages from form
        const mealPercentages = {
            breakfast: parseInt(mealForm.elements['breakfast-perc'].value) || 0,
            snack1: parseInt(mealForm.elements['snack1-perc'].value) || 0,
            lunch: parseInt(mealForm.elements['lunch-perc'].value) || 0,
            snack2: parseInt(mealForm.elements['snack2-perc'].value) || 0,
            dinner: parseInt(mealForm.elements['dinner-perc'].value) || 0
        };
        const totalMealPerc = Object.values(mealPercentages).reduce((sum, perc) => sum + perc, 0);

        adjustMealPercentages(); // Update total display

        if (totalMealPerc !== 100) {
            displayError(mealResultDiv, `La suma de los porcentajes de comida debe ser 100%. Actualmente es ${totalMealPerc}%.`);
            return;
        }

        const { proteinGrams, carbGrams, fatGrams, goalCalories } = calculatedMacros;
        let mealPlanHTML = `<h3>Distribuci√≥n Orientativa por Comida:</h3><p>Basado en ${goalCalories} kcal, ${proteinGrams.toFixed(1)}g Prote√≠na, ${carbGrams.toFixed(1)}g Carbs, ${fatGrams.toFixed(1)}g Grasa.</p>`;

        // Calculate and display macros per meal
        for (const [mealName, percentage] of Object.entries(mealPercentages)) {
            if (percentage > 0) {
                const mealCalories = goalCalories * (percentage / 100);
                const mealProtein = proteinGrams * (percentage / 100);
                const mealCarbs = carbGrams * (percentage / 100);
                const mealFat = fatGrams * (percentage / 100);
                const displayName = mealName.charAt(0).toUpperCase() + mealName.slice(1).replace('snack1', 'Media Ma√±ana').replace('snack2', 'Merienda');

                mealPlanHTML += `
                            <div class="plan-step" style="margin-bottom: 15px; padding: 15px; background-color: #f5fbf5 !important; border: 1px solid #d4eed5;">
                                <h4>${displayName} (${percentage}%)</h4>
                                <ul>
                                    <li><strong>Calor√≠as:</strong> ~${mealCalories.toFixed(0)} kcal</li>
                                    <li><strong>Prote√≠nas:</strong> ~${mealProtein.toFixed(1)} g</li>
                                    <li><strong>Carbohidratos:</strong> ~${mealCarbs.toFixed(1)} g</li>
                                    <li><strong>Grasas:</strong> ~${mealFat.toFixed(1)} g</li>
                                </ul>
                            </div>`;
            }
        }

        // Mostrar meal-result con animaci√≥n
        const mealResult = document.getElementById('meal-result');
        if (mealResult) {
            mealResult.style.display = 'block';
            mealResult.style.opacity = '0';
            setTimeout(() => {
                mealResult.style.transition = 'opacity 0.4s ease';
                mealResult.style.opacity = '1';
            }, 100);
        }
        mealPlanHTML += `<p style="margin-top: 15px; font-style: italic;">Nota: Esta es una distribuci√≥n matem√°tica. Los alimentos espec√≠ficos determinar√°n los macros exactos de cada comida. Consulta a un profesional para crear un plan de comidas detallado.</p>`;
        mealResultDiv.innerHTML = mealPlanHTML;
        updateButtonStates(); // No state changes expected here, but good practice
    }

    // Helper function to adjust and display meal percentages total
    function adjustMealPercentages() {
        if (!mealPercentageTotalDiv) return;
        const percentages = [
            parseInt(mealForm.elements['breakfast-perc'].value) || 0,
            parseInt(mealForm.elements['snack1-perc'].value) || 0,
            parseInt(mealForm.elements['lunch-perc'].value) || 0,
            parseInt(mealForm.elements['snack2-perc'].value) || 0,
            parseInt(mealForm.elements['dinner-perc'].value) || 0
        ];
        const total = percentages.reduce((sum, perc) => sum + perc, 0);
        mealPercentageTotalDiv.textContent = `Total: ${total}%`;
        mealPercentageTotalDiv.style.color = total === 100 ? '#388E3C' : '#c62828';
    }


    // --- Step 7 Helper Function to Generate Detailed Cycle Table (Auto) ---
    function generateDetailedCycleTable(totalWeeks, startWeight, endWeight, initialTDEE, phaseCalories, phaseMacros, goalType, weeklyRateKg) {
        const step6TableContainer = document.getElementById('detailed-cycle-table-container');
        clearContainer(step6TableContainer);

        if (goalType === 'maintenance' || totalWeeks <= 0) {
            displayInfo(step6TableContainer, '<em>No se requiere tabla de ciclos para un objetivo de mantenimiento o duraci√≥n cero.</em>');
            return;
        }
        if (!initialTDEE || !phaseCalories || !phaseMacros || !phaseMacros.proteinGrams || weeklyRateKg === undefined || !userAge || !userHeightCm) {
            displayError(step6TableContainer, '<em>Faltan datos necesarios (TDEE, Calor√≠as/Macros Objetivo, Ritmo Semanal, Datos Usuario) para generar la tabla de ciclos. Aseg√∫rate de completar los pasos 1, 2 y 3.</em>');
            console.error("Missing data for detailed table:", { initialTDEE, phaseCalories, phaseMacros, weeklyRateKg, userAge, userHeightCm });
            return;
        }

        const phaseWeeksPerCycle = 6;
        const breakWeeksPerCycle = 1;
        const cycleDuration = phaseWeeksPerCycle + breakWeeksPerCycle;
        const numFullCycles = Math.floor(totalWeeks / cycleDuration);
        const remainingPhaseWeeks = totalWeeks % cycleDuration;

        const activityMultipliers = userGender === 'male' ? [1.2, 1.56, 1.78, 2.1, 2.3] : [1.2, 1.55, 1.64, 1.82, 2];

        const macroForm = document.getElementById('macro-form');
        const proteinPerc = parseInt(macroForm.elements['protein-percentage'].value);
        const carbPerc = parseInt(macroForm.elements['carb-percentage'].value);
        const fatPerc = parseInt(macroForm.elements['fat-percentage'].value);

        let tableHTML = `
				<table id="detailed-cycle-table">
					<thead>
						<tr>
							<th>Ciclo</th>
							<th>Fase</th>
							<th>Semnanas</th>
							<th>Peso(kg) <br>(Inicio‚ÜíFin)</th>
							<th>Calorias/d√≠a/AF</th>
							<th>Prote√≠na(g)</th>
							<th>Carbs(g)</th>
							<th>Grasas(g)</th>
						</tr>
					</thead>
					<tbody>`;

        let currentWeek = 0;
        let currentCycleWeight = startWeight;
        const phaseLabel = goalType === 'loss' ? 'D√©ficit' : 'Super√°vit';
        const phaseClass = goalType === 'loss' ? 'phase-deficit' : 'phase-surplus';
        const weeklyWeightChange = goalType === 'loss' ? -Math.abs(weeklyRateKg) : Math.abs(weeklyRateKg);

        for (let i = 1; i <= numFullCycles; i++) {
            let weightAtEndOfPhase = currentCycleWeight + (phaseWeeksPerCycle * weeklyWeightChange);
            weightAtEndOfPhase = (goalType === 'loss') ? Math.max(weightAtEndOfPhase, endWeight) : Math.min(weightAtEndOfPhase, endWeight);

            let bmr;
            if (userGender === 'male') {
                bmr = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else {
                bmr = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            }

            const tdeeAF = activityMultipliers.map(multiplier => bmr * multiplier * 1.1);
            const caloriesAF = tdeeAF.map(tdee => {
                if (goalType === 'loss') return Math.round(tdee * 0.90);
                else if (goalType === 'gain') return Math.round(tdee * 1.1);
                else return Math.round(tdee);
            });

            const macrosAF = caloriesAF.map(cal => {
                const proteinGrams = (cal * (proteinPerc / 100)) / 4;
                const carbGrams = (cal * (carbPerc / 100)) / 4;
                const fatGrams = (cal * (fatPerc / 100)) / 9;
                return { proteinGrams, carbGrams, fatGrams };
            });

            // Formatear calor√≠as y macros como lista vertical
            const caloriesStr = caloriesAF.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
            const proteinStr = macrosAF.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
            const carbsStr = macrosAF.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
            const fatsStr = macrosAF.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

            tableHTML += `<tr class="${phaseClass}">
					<td>${i}</td>
					<td>${phaseLabel}</td>
					<td>${phaseWeeksPerCycle}</td>
					<td>${currentCycleWeight.toFixed(1)} ‚Üí ${weightAtEndOfPhase.toFixed(1)}</td>
					<td>${caloriesStr}</td>
					<td>${proteinStr}</td>
					<td>${carbsStr}</td>
					<td>${fatsStr}</td>
				</tr>`;

            currentCycleWeight = weightAtEndOfPhase;
            currentWeek += phaseWeeksPerCycle;

            if ((goalType === 'loss' && currentCycleWeight <= endWeight) || (goalType === 'gain' && currentCycleWeight >= endWeight)) break;

            let breakBMR;
            if (userGender === 'male') {
                breakBMR = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else {
                breakBMR = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            }

            const breakTDEEAF = activityMultipliers.map(multiplier => breakBMR * multiplier * 1.1);
            //const breakCaloriesAF = breakTDEEAF.map(tdee => Math.round(tdee));
            const breakCaloriesAF = breakTDEEAF.map(tdee => {
                if (goalType === 'loss') return Math.round(tdee * 0.95);
                else if (goalType === 'gain') return Math.round(tdee * 1.1);
                else return Math.round(tdee);
            });
            const breakMacrosAF = breakCaloriesAF.map(cal => {
                const proteinGrams = (cal * (proteinPerc / 100)) / 4;
                const carbGrams = (cal * (carbPerc / 100)) / 4;
                const fatGrams = (cal * (fatPerc / 100)) / 9;
                return { proteinGrams, carbGrams, fatGrams };
            });

            // Formatear calor√≠as y macros de break como lista vertical
            const breakCaloriesStr = breakCaloriesAF.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
            const breakProteinStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
            const breakCarbsStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
            const breakFatsStr = breakMacrosAF.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

            tableHTML += `<tr class="phase-break">
					<td>${i}</td>
					<td>Break (Mantenimiento)</td>
					<td>${breakWeeksPerCycle}</td>
					<td>~ ${currentCycleWeight.toFixed(1)}</td>
					<td>${breakCaloriesStr}</td>
					<td>${breakProteinStr}</td>
					<td>${breakCarbsStr}</td>
					<td>${breakFatsStr}</td>
				</tr>`;

            currentWeek += breakWeeksPerCycle;

            if ((goalType === 'loss' && currentCycleWeight <= endWeight) || (goalType === 'gain' && currentCycleWeight >= endWeight)) break;
        }

        if (remainingPhaseWeeks > 0 && ((goalType === 'loss' && currentCycleWeight > endWeight) || (goalType === 'gain' && currentCycleWeight < endWeight))) {
            let weightAtEndFinal = currentCycleWeight + (remainingPhaseWeeks * weeklyWeightChange);
            weightAtEndFinal = (goalType === 'loss') ? Math.max(weightAtEndFinal, endWeight) : Math.min(weightAtEndFinal, endWeight);

            let bmrFinal;
            if (userGender === 'male') {
                bmrFinal = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else {
                bmrFinal = (10 * currentCycleWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            }

            const tdeeAFFinal = activityMultipliers.map(multiplier => bmrFinal * multiplier * 1.1);
            const caloriesAFFinal = tdeeAFFinal.map(tdee => {
                if (goalType === 'loss') return Math.round(tdee * 0.90);
                else if (goalType === 'gain') return Math.round(tdee * 1.1);
                else return Math.round(tdee);
            });

            const macrosAFFinal = caloriesAFFinal.map(cal => {
                const proteinGrams = (cal * (proteinPerc / 100)) / 4;
                const carbGrams = (cal * (carbPerc / 100)) / 4;
                const fatGrams = (cal * (fatPerc / 100)) / 9;
                return { proteinGrams, carbGrams, fatGrams };
            });

            // Formatear calor√≠as y macros finales como lista vertical
            const caloriesStrFinal = caloriesAFFinal.map((cal, index) => `${index}: ${cal} kcal`).join('<br>');
            const proteinStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.proteinGrams.toFixed(0)} g`).join('<br>');
            const carbsStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.carbGrams.toFixed(0)} g`).join('<br>');
            const fatsStrFinal = macrosAFFinal.map((macro, index) => `${index}: ${macro.fatGrams.toFixed(0)} g`).join('<br>');

            tableHTML += `<tr class="${phaseClass}">
					<td>${numFullCycles + 1}</td>
					<td>${phaseLabel} (Final)</td>
					<td>${remainingPhaseWeeks}</td>
					<td>${currentCycleWeight.toFixed(1)} ‚Üí ${weightAtEndFinal.toFixed(1)}</td>
					<td>${caloriesStrFinal}</td>
					<td>${proteinStrFinal}</td>
					<td>${carbsStrFinal}</td>
					<td>${fatsStrFinal}</td>
				</tr>`;
        }

        tableHTML += `</tbody></table>`;
        tableHTML += `<p style="font-size: 0.9em; font-style: italic; margin-top: 10px;">Nota: Esta tabla es una simulaci√≥n basada en los c√°lculos autom√°ticos de los Pasos 1-3. Las calor√≠as y macros se ajustan seg√∫n el nivel de actividad f√≠sica (AF: 0=Sedentario, 1=Leve, 2=Moderado, 3=Intenso). El progreso real puede variar. Ajusta seg√∫n sea necesario y consulta a un profesional.</p>`;

        step6TableContainer.innerHTML = tableHTML;
    }

    document.addEventListener('DOMContentLoaded', function () {
        calculateGoalButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent form submission
            calculateWeightGoal();
        });
    });

    /////////////////// --- Step 3: Estimate Time (Manual Calculation) ---////////////////////////////////////
    function estimateTimeManually() {
        clearContainer(timeEstimationResultDiv);
        if (timeChartContainer) timeChartContainer.style.display = 'none';
        resetStep7();

        if (timeEstimationChartInstance) {
            timeEstimationChartInstance.destroy();
            timeEstimationChartInstance = null;
        }

        // Reset global variables
        estimatedWeeksManualGlobal = null;
        weightChangeGoalManualGlobal = null;
        weeklyCalorieDiffManualGlobal = null;

        // Check prerequisite
        if (!currentWeightKg) {
            displayError(timeEstimationResultDiv, 'Error: Completa el Paso 1 antes de realizar esta estimaci√≥n.');
            updateButtonStates();
            return;
        }

        // Get values from form
        const weightChangeGoal = parseFloat(timeEstimationForm.elements['weight-change-goal'].value);
        const weeklyCalorieDiff = parseInt(timeEstimationForm.elements['weekly-calorie-diff'].value);

        console.log("Paso 3:Estimacion Temporal Inputs - weightChangeGoal:", weightChangeGoal, "weeklyCalorieDiff:", weeklyCalorieDiff, "currentWeightKg:", currentWeightKg);

        // Validate inputs
        if (isNaN(weightChangeGoal)) {
            displayError(timeEstimationResultDiv, 'Por favor, introduce un cambio de peso deseado v√°lido.');
            updateButtonStates();
            return;
        }
        if (isNaN(weeklyCalorieDiff) || weeklyCalorieDiff === 0) {
            displayError(timeEstimationResultDiv, 'Por favor, introduce una diferencia cal√≥rica semanal v√°lida y distinta de cero.');
            updateButtonStates();
            return;
        }
        if ((weightChangeGoal > 0 && weeklyCalorieDiff < 0) || (weightChangeGoal < 0 && weeklyCalorieDiff > 0)) {
            displayError(timeEstimationResultDiv, 'El signo del cambio de peso debe coincidir con el signo de la diferencia cal√≥rica.');
            updateButtonStates();
            return;
        }
        // Aseg√∫rate de que el c√≥digo se ejecute despu√©s de que el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', function () {
            // Configurar el modal para reiniciar el chart cuando se cierre
            const modalCalculadoraNoLineal = document.getElementById('modalCalculadoraNoLineal');

            if (modalCalculadoraNoLineal) {
                // Usar el evento correcto de Bootstrap
                modalCalculadoraNoLineal.addEventListener('hidden.bs.modal', function () {
                    console.log('Modal cerrado'); // Para debugging

                    // Verificar si la instancia existe antes de destruirla
                    if (typeof modalChartInstance !== 'undefined' && modalChartInstance !== null) {
                        console.log('Destruyendo chart'); // Para debugging
                        modalChartInstance.destroy();
                        modalChartInstance = null;
                    }
                });
            } else {
                console.log('Modal no encontrado'); // Para debugging
            }
        });
        // === üî¢ C√ÅLCULO LINEAL (te√≥rico) ===
        const kcalPerKg = 7700;
        const totalKcalChangeNeeded = Math.abs(weightChangeGoal) * kcalPerKg;
        const dailyAdjustmentAbs = Math.abs(weeklyCalorieDiff) / 7;
        let estimatedWeeksLinear = 0;

        if (dailyAdjustmentAbs > 0) {
            const daysNeeded = totalKcalChangeNeeded / dailyAdjustmentAbs;
            estimatedWeeksLinear = Math.ceil(daysNeeded / 7);
        }

        if (weightChangeGoal === 0) {
            estimatedWeeksLinear = 0;
        }
        const currentFatPerc = parseFloat(weightGoalForm.elements['current-fat-percentage'].value);
        const isAthlete = weightGoalForm.elements['is-athlete'].value === 'yes';
        console.log("currentFatPerc:", currentFatPerc);
        console.log("Tipo:", typeof currentFatPerc);
        console.log("¬øEs NaN?", isNaN(currentFatPerc));

        // === üî¨ C√ÅLCULO NO LINEAL (realista) - MEPNL v2.1 ===

        function calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData) {
            const { userGender, userAge, currentFatPerc, isAthlete, activityLevel } = userData;
            const esHombre = userGender === 'male';
            const esPerdida = weightChangeGoal < 0;
            const metaAbs = Math.abs(weightChangeGoal);
            const kcalPerKg = 7700;

            // --- 1. Estimar TDEE y NEAT (simplificado) ---
            const AF_FACTORS = {
                'sedentario': 1.2,
                'leve': 1.4,
                'moderate': 1.6,
                'active': 1.75,
                'very-active': 1.9
            };
            const afFactor = AF_FACTORS[activityLevel] || 1.4;

            // BMR (Mifflin-St Jeor - asumiendo altura promedio si no est√° disponible)
            const alturaEstimada = esHombre ? 175 : 162; // cm
            const bmr = esHombre
                ? (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) + 5
                : (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) - 161;

            const neatExtra = isAthlete ? 500 : (afFactor >= 1.6 ? 300 : 150);
            const tdee = bmr * afFactor + neatExtra;
            const weeklyEnergyExpenditure = tdee * 7;

            // --- 2. Ajustes personalizados ---
            const esDeportista = isAthlete;
            const porcentajeGrasa = currentFatPerc;

            // Factor de adherencia (puedes hacerlo configurable)
            const adherencia = 0.8;

            // Factor de correcci√≥n por tipo de tejido
            const fc = esPerdida
                ? 1.0
                : (goalTypeGlobal === 'ganancia1' ? 1.25 : 0.85); // 1.25 para ganancia muscular, 0.85 para mixto

            // Calor√≠a efectiva semanal (ajustada por adherencia)
            const weeklyCalorieDiffEffective = adherencia * weeklyCalorieDiff;

            // Tasa inicial (kg/semana)
            const r0 = Math.abs(weeklyCalorieDiffEffective) / (kcalPerKg * fc);

            // --- 3. Par√°metros personalizados por usuario ---
            let k, alpha, beta;

            if (esPerdida) {
                // P√©rdida: adaptaci√≥n metab√≥lica
                // === P√©rdida ===
                // Para personas con >25% grasa (respuesta m√°s estable)
                alpha = Math.max(0.5, 0.4 * (1 - 0.01 * porcentajeGrasa)); // ‚Üí ~0.5 para 28%
                k = 0.02; // Ralentizaci√≥n m√°s lenta
            } else {
                // Ganancia: progresi√≥n decreciente
                beta = Math.max(0.3, 0.4 * (1 - 0.004 * userAge + (esDeportista ? 0.1 : 0)));
                k = 0.06 * (1 + (userData.isAdvanced ? 0.4 : 0) - (esDeportista ? 0.2 : 0));
            }

            // --- 4. Simular semana a semana ---
            const semanas = [];
            let pesoAcumulado = 0;
            let semana = 0;
            let currentTDEE = tdee; // Para simular adaptaci√≥n del TDEE
            const factorAdaptacion = calcularFactorAdaptacion(
                userAge,
                userGender,
                activityLevel,
                isAthlete
            );
            while (pesoAcumulado < metaAbs && semana < 100) {
                semana++;

                // Ajuste del TDEE por p√©rdida de peso (adaptaci√≥n metab√≥lica)
                if (esPerdida && semana > 4) {
                    const pesoPerdidoHastaAhora = (pesoAcumulado / metaAbs) * Math.abs(weightChangeGoal);
                    currentTDEE = tdee * (1 - factorAdaptacion * (pesoPerdidoHastaAhora / currentWeightKg));
                }

                // Tasa semanal con decaimiento
                let factorProgresion;
                if (esPerdida) {
                    factorProgresion = Math.max(alpha, 1 - k * (semana - 1));
                } else {
                    factorProgresion = Math.max(beta || 0.4, 1 - k * (semana - 1));
                }

                let tasaSemanal = r0 * factorProgresion;

                // Ajuste adicional para deportistas en ganancia
                if (!esPerdida && esDeportista) {
                    tasaSemanal *= 1.15;
                }

                pesoAcumulado += tasaSemanal;
                semanas.push({
                    numero: semana,
                    pesoAcumulado: parseFloat(pesoAcumulado.toFixed(2)),
                    tasa: parseFloat(tasaSemanal.toFixed(2)),
                    tdee: parseFloat(currentTDEE.toFixed(0))
                });
            }

            return {
                semanas,
                totalSemanas: semana,
                metaAlcanzada: pesoAcumulado >= metaAbs,
                tasaInicial: r0,
                finalTDEE: currentTDEE
            };
        }

        // === ‚úÖ DATOS DEL USUARIO (userData) ===
        const userData = {
            userGender,
            userAge,
            currentFatPerc,
            isAthlete: document.getElementById('is-athlete')?.value === 'yes',
            activityLevel: document.getElementById('nivel-actividad')?.value?.toLowerCase(),
            isAdvanced: document.getElementById('is-athlete')?.value === 'yes' // ejemplo simple
        };

        // === üîó LLAMADA A LA FUNCI√ìN NO LINEAL ===
        const noLineal = calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData);
        const estimatedWeeksRealistic = noLineal.totalSemanas;
        window.semanasEstimadasGlobal = estimatedWeeksRealistic



        // Crear tabla con datos semanales
        const tableData = noLineal.semanas.map(semana => ({
            Semana: semana.numero,
            "Peso Acumulado (kg)": semana.pesoAcumulado,
            "Tasa Semanal (kg)": semana.tasa,
            "TDEE Estimado (kcal/d√≠a)": semana.tdee,
        }));

        // === üìä DEBUG: Mostrar evoluci√≥n semanal en consola ===
        console.log("%cüìä MEPNL v2.1 - Evoluci√≥n No Lineal", "font-weight: bold; color: #1976d2; font-size: 16px;");
        console.log("üéØ Objetivo:", weightChangeGoal > 0 ? "Ganancia" : "P√©rdida", Math.abs(weightChangeGoal), "kg");
        console.log("üë§ Usuario:", userGender, "| Edad:", userAge, "| % Grasa:", currentFatPerc, "| Deportista:", isAthlete ? "S√≠" : "No");
        console.log("‚ö° Diferencia cal√≥rica semanal:", weeklyCalorieDiff, "kcal");
        console.log("üìÖ Semanas estimadas (realista):", estimatedWeeksRealistic);
        console.log("üìâ Tasa inicial estimada:", noLineal.tasaInicial.toFixed(3), "kg/semana");
        console.table(tableData);

        // === üìà Estad√≠sticas finales ===
        console.log("%cüìà Resultados Finales", "font-weight: bold; color: #d84315; font-size: 14px;");
        console.log("‚úÖ Meta alcanzada:", noLineal.metaAlcanzada ? "S√≠" : "No");
        console.log("‚è±Ô∏è  Duraci√≥n:", estimatedWeeksRealistic, "semanas (~" + (estimatedWeeksRealistic / 4.3).toFixed(1) + " meses)");
        console.log("üí° Consejo: Usa esta tabla para ajustar par√°metros como 'k', 'alpha', 'beta' o 'adherencia' si el modelo no coincide con casos reales.");

        // === ‚úÖ Almacenar resultados globales con el valor realista como principal ===
        if (isFinite(estimatedWeeksLinear)) {
            estimatedWeeksManualGlobal = estimatedWeeksRealistic;
            weightChangeGoalManualGlobal = weightChangeGoal;
            weeklyCalorieDiffManualGlobal = weeklyCalorieDiff;
        } else {
            estimatedWeeksManualGlobal = null;
            weightChangeGoalManualGlobal = null;
            weeklyCalorieDiffManualGlobal = null;
        }


        // === üìä GENERAR RESULTADOS EDUCATIVOS ===
        let resultHTML = `<h3>Estimaci√≥n de Tiempo (Manual):</h3>`;
        resultHTML += `<p>Para un cambio de peso de <strong>${weightChangeGoal} kg</strong> con una diferencia cal√≥rica semanal de <strong>${weeklyCalorieDiff} kcal</strong>:</p>`;

        if (isFinite(estimatedWeeksLinear) && estimatedWeeksLinear > 0) {
            const esPerdida = weightChangeGoal < 0;
            const rateLinear = Math.abs(weightChangeGoal) / estimatedWeeksLinear;

            // --- Estimaci√≥n Lineal (te√≥rica) ---
            resultHTML += `
            <div style="margin: 15px 0; padding: 12px; border: 1px solid #bbdefb; border-radius: 6px; background: #e3f2fd;">
                <strong>üìä Estimaci√≥n Lineal (te√≥rica):</strong>
                <p>Tiempo estimado: <strong>${estimatedWeeksLinear} semanas</strong> (~${(estimatedWeeksLinear / 4.3).toFixed(1)} meses)</p>
                <p><small>Esta estimaci√≥n asume una p√©rdida o ganancia <strong>constante de ~${rateLinear.toFixed(2)} kg/semana</strong>, como si tu cuerpo respondiera igual cada semana.</small></p>
                <p><em> Es un c√°lculo matem√°tico simple, pero <strong>no refleja c√≥mo funciona tu fisiolog√≠a en la realidad</strong>.</em></p>
            </div>
        `;

            // --- Estimaci√≥n No Lineal (realista) - CON FEEDBACK AVANZADO ---
            resultHTML += `
						<div style="margin: 15px 0; padding: 12px; border: 1px solid #ffcc80; border-radius: 6px; background: #fff3e0;">
							<strong>üß† Estimaci√≥n No Lineal (realista):</strong>
							<p>Tiempo estimado: <strong>${estimatedWeeksRealistic} semanas</strong> (~${(estimatedWeeksRealistic / 4.3).toFixed(1)} meses)</p>
					`;

            Math.round((Math.abs(weightChangeGoal) / currentWeightKg) * 100).toFixed(0);
            const difwk = document.getElementById('weekly-calorie-diff').value
            const PerdidaGanacia = Math.round(Math.abs(difwk) / (window.calculatedTDEE * 7) * 100).toFixed(0);
            document.getElementById('goal-caloriespc').value = PerdidaGanacia
            //kcal/dia=	

            // === üîç Variables para personalizaci√≥n ===
            //const esPerdida = weightChangeGoal < 0;
            const porcentajeGrasa = currentFatPerc;
            const edad = userAge;
            const esHombre = userGender === 'male';
            const esDeportista = document.getElementById('is-athlete')?.value === 'yes';
            const nivelActividad = document.getElementById('nivel-actividad')?.value?.toLowerCase();
            const esSedentario = !esDeportista && ['sedentario', 'leve'].includes(nivelActividad);
            const ritmoPromedio = Math.abs(weightChangeGoal) / estimatedWeeksRealistic;

            if (esPerdida) {
                // --- üîΩ P√âRDIDA DE PESO: Feedback hiperpersonalizado ---
                resultHTML += `<p><small>Esta estimaci√≥n considera c√≥mo <strong>tu cuerpo responde al d√©ficit cal√≥rico</strong>, basado en tu perfil √∫nico:</small></p>
						<ul style="font-size: 0.95em; margin: 10px 0; padding-left: 20px;">`;

                // 1. SEXO: Diferencias fisiol√≥gicas clave
                if (esHombre) {
                    resultHTML += `
								<li><strong>Perfil masculino:</strong> 
									Tienes mayor masa magra y testosterona, lo que favorece una p√©rdida m√°s eficiente al inicio.
									<em> Pero tambi√©n mayor tendencia a acumular grasa visceral, que se pierde r√°pido al principio.</em>
								</li>`;
                } else {
                    resultHTML += `
								<li><strong>Perfil femenino:</strong> 
									Tu cuerpo prioriza la conservaci√≥n energ√©tica, especialmente con grasa baja. 
									Las hormonas como el estr√≥geno ralentizan la p√©rdida por debajo del 25%.
									<em> Es normal que el progreso se detenga en ciertos puntos del ciclo menstrual.</em>
								</li>`;
                }

                // 2. NIVEL DE ACTIVIDAD: Sedentario vs Deportista
                if (esDeportista) {
                    resultHTML += `
								<li><strong>Deportista activo:</strong> 
									Tu NEAT y gasto energ√©tico son altos, lo que acelera la p√©rdida al inicio.
									<em> Pero con el tiempo, tu cuerpo se adapta m√°s r√°pido (efecto de entrenamiento).</em>
								</li>`;
                } else if (esSedentario) {
                    resultHTML += `
								<li><strong>Sedentario o baja actividad:</strong> 
									Tu cuerpo tiene menos gasto energ√©tico y se adapta m√°s r√°pido al d√©ficit.
									<em> Peque√±as mejoras en movimiento diario (caminar, moverte) pueden acelerar tu progreso.</em>
								</li>`;
                }

                // 3. % GRASA: Nivel de dificultad
                if (porcentajeGrasa < 18 && esHombre) {
                    resultHTML += `
								<li><strong>Definici√≥n extrema (<18% H):</strong> 
									Cada % de grasa por debajo del 15% es extremadamente dif√≠cil de perder.
									<em> El cuerpo activa mecanismos de supervivencia: baja testosterona, ca√≠da del T3.</em>
								</li>`;
                } else if (porcentajeGrasa < 25 && !esHombre) {
                    resultHTML += `
								<li><strong>Definici√≥n femenina (<25% M):</strong> 
									El cuerpo defiende el tejido adiposo por razones hormonales y reproductivas.
									<em> La p√©rdida se vuelve muy lenta: ~0.1‚Äì0.2 kg/semana es normal.</em>
								</li>`;
                } else if (porcentajeGrasa >= 30) {
                    resultHTML += `
								<li><strong>Alta grasa corporal (>30%):</strong> 
									Perder√°s r√°pido al inicio (agua, gluc√≥geno, grasa visceral), pero el ritmo se ralentizar√°.
									<em> Es normal que despu√©s de perder 10‚Äì15%, el progreso parezca "estancado".</em>
								</li>`;
                }

                // 4. EDAD
                if (edad >= 45) {
                    resultHTML += `
								<li><strong>Edad (${edad} a√±os):</strong> 
									El metabolismo basal disminuye ~2‚Äì3% por d√©cada. La p√©rdida se vuelve m√°s lenta.
									<em> Necesitas m√°s prote√≠na y entrenamiento de fuerza para preservar m√∫sculo.</em>
								</li>`;
                }

                // 5. ADAPTACI√ìN METAB√ìLICA (siempre aplicable)
                resultHTML += `
							<li><strong>Adaptaci√≥n metab√≥lica:</strong> 
								Tu cuerpo gasta menos energ√≠a con el tiempo. Incluso si comes igual, quemas menos.
								<em> Es un mecanismo de supervivencia: el cuerpo se defiende contra la p√©rdida de peso.</em>
							</li>`;

                resultHTML += `</ul>`;

                // === Conclusi√≥n personalizada para p√©rdida ===
                if (porcentajeGrasa < 20) {
                    resultHTML += `<p><em>üìå Aunque empieces perdiendo ~0.5 kg/semana, al final perder√°s ~${ritmoPromedio.toFixed(2)} kg/semana. Es normal y esperado.</em></p>`;
                } else {
                    resultHTML += `<p><em>üìå Al principio perder√°s r√°pido, pero el progreso se ralentizar√°. Este ritmo es sostenible y saludable.</em></p>`;
                }

            } else {
                // --- üîº GANANCIA DE PESO: Feedback hiperpersonalizado ---
                resultHTML += `<p><small>Esta estimaci√≥n considera c√≥mo <strong>tu cuerpo responde al super√°vit cal√≥rico</strong>, basado en tu perfil:</small></p>
						<ul style="font-size: 0.95em; margin: 10px 0; padding-left: 20px;">`;

                // 1. SEXO
                if (esHombre) {
                    resultHTML += `
								<li><strong>Perfil masculino:</strong> 
									Tienes mayor capacidad anab√≥lica (testosterona, masa magra), lo que favorece la ganancia muscular.
									<em> Pero tambi√©n mayor tendencia a acumular grasa si el super√°vit es alto o descontrolado.</em>
								</li>`;
                } else {
                    resultHTML += `
								<li><strong>Perfil femenino:</strong> 
									Tu cuerpo prioriza el almacenamiento energ√©tico (grasa) por razones hormonales.
									<em> Ganar√°s menos m√∫sculo y m√°s grasa que un hombre con el mismo super√°vit.</em>
								</li>`;
                }

                // 2. NIVEL DE ACTIVIDAD
                if (esDeportista) {
                    resultHTML += `
								<li><strong>Deportista activo:</strong> 
									Tu m√∫sculo est√° "entrenado" para responder al super√°vit, pero ya no est√°s en fase de novato.
									<em> La hipertrofia se vuelve m√°s lenta: ~0.1‚Äì0.3 kg m√∫sculo/mes es realista.</em>
								</li>`;
                } else if (esSedentario) {
                    resultHTML += `
								<li><strong>Sedentario o principiante:</strong> 
									Si es tu primera vez entrenando, tendr√°s un "efecto novato" fuerte al inicio.
									<em> Ganar√°s r√°pido (agua, gluc√≥geno), pero despu√©s el progreso se ralentizar√° mucho.</em>
								</li>`;
                }

                // 3. % GRASA
                if (porcentajeGrasa > 25) {
                    resultHTML += `
								<li><strong>Grasa moderada/alta (>25%):</strong> 
									Tu cuerpo almacena m√°s calor√≠as como grasa que como m√∫sculo.
									<em> Un super√°vit que en un magro da m√∫sculo, en ti dar√° m√°s grasa.</em>
								</li>`;
                } else if (porcentajeGrasa <= 18) {
                    resultHTML += `
								<li><strong>Baja grasa corporal (<18%):</strong> 
									Est√°s en un rango ideal para ganancia muscular controlada.
									<em> Puedes aprovechar el super√°vit para hipertrofia sin acumular mucha grasa.</em>
								</li>`;
                }

                // 4. EDAD
                if (edad >= 45) {
                    resultHTML += `
								<li><strong>Edad (${edad} a√±os):</strong> 
									La anabolizaci√≥n muscular disminuye (anarcabolia sarcop√©nica).
									<em> Necesitas m√°s prote√≠na (1.8‚Äì2.4 g/kg) y estimulaci√≥n para ganar m√∫sculo.</em>
								</li>`;
                }

                // 5. ALMACENAMIENTO GRASO
                resultHTML += `
							<li><strong>Mayor almacenamiento graso:</strong> 
								Con el tiempo, m√°s calor√≠as del super√°vit se almacenan como grasa, no como m√∫sculo.
								<em> Solo ~20‚Äì30% del peso ganado ser√° m√∫sculo puro en fases avanzadas.</em>
							</li>`;

                resultHTML += `</ul>`;

                // === Conclusi√≥n personalizada para ganancia ===
                if (esDeportista && edad <= 35) {
                    resultHTML += `<p><em>üìå No puedes ganar 0.5 kg de m√∫sculo por semana durante meses. La realidad es: r√°pido al inicio, muy lento despu√©s. Este ritmo es √≥ptimo para minimizar grasa.</em></p>`;
                } else {
                    resultHTML += `<p><em>üìå El progreso ser√° m√°s lento de lo esperado, pero sostenible. La clave es la constancia, no la velocidad.</em></p>`;
                }
            }

            resultHTML += `</div>`;

            // --- Conclusi√≥n educativa ---
            resultHTML += `
						<p style="font-style: italic; color: #555; font-size: 0.95em;">
							<strong>üí° Conclusi√≥n:</strong> 
							La composici√≥n corporal <strong>no cambia de forma lineal</strong>. 
							Esta estimaci√≥n realista se usar√° para generar tu tabla de ciclos (Paso 7).
						</p>
					`;
        } else if (weightChangeGoal === 0) {
            resultHTML += `<p>El cambio de peso deseado es 0 kg (mantenimiento). No se requiere estimaci√≥n de tiempo.</p>`;
        } else {
            resultHTML += `<p>No se pudo calcular el tiempo estimado con los valores proporcionados.</p>`;
        }

        timeEstimationResultDiv.innerHTML = resultHTML;

        // === üìà GENERAR GR√ÅFICO (Linear + Non-Linear) ===
        if (isFinite(estimatedWeeksLinear) && estimatedWeeksLinear > 0 && weightChangeGoal !== 0 && timeChartContainer) {
            const startWeight = currentWeightKg;
            const endWeight = startWeight + weightChangeGoal;
            const maxWeeksToShow = 104;
            const actualWeeks = Math.min(Math.max(estimatedWeeksLinear, estimatedWeeksRealistic), maxWeeksToShow);

            // --- Generar datos para el gr√°fico (lineal + no lineal) ---
            const chartLabels = [];
            const linearData = [];
            const nonlinearData = [];

            let lastNonlinearWeight = startWeight; // Inicia en el peso actual

            for (let w = 0; w <= actualWeeks; w++) {
                // Etiquetas (menos frecuentes si hay muchas semanas)
                let showLabel = false;
                if (actualWeeks <= 20) showLabel = true;
                else if (actualWeeks <= 52) showLabel = (w % 2 === 0);
                else showLabel = (w % 4 === 0);
                chartLabels.push(showLabel ? `Sem ${w}` : '');

                // === L√≠nea Lineal (te√≥rica) ===
                const progressLinear = w / estimatedWeeksLinear;
                const projectedWeightLinear = startWeight + (weightChangeGoal * Math.min(progressLinear, 1));
                const clampedWeightLinear = (weightChangeGoal < 0)
                    ? Math.max(projectedWeightLinear, endWeight)
                    : Math.min(projectedWeightLinear, endWeight);
                linearData.push(parseFloat(clampedWeightLinear.toFixed(1)));

                // === L√≠nea No Lineal (realista) ===
                const weekData = noLineal.semanas.find(s => s.numero === w);

                if (weekData) {
                    // Si hay dato para esta semana
                    const weightNonlinear = startWeight + (weightChangeGoal < 0
                        ? -weekData.pesoAcumulado
                        : weekData.pesoAcumulado);
                    lastNonlinearWeight = weightNonlinear; // Gu√°rdalo como n√∫mero, sin toFixed
                }
                // Si no hay dato (antes de empezar o despu√©s), mantener el √∫ltimo valor
                // (esto evita saltos o undefined)
                nonlinearData.push(lastNonlinearWeight);
            }

            // === Asegurar que ambas l√≠neas terminen en el peso objetivo ===

            if (estimatedWeeksLinear <= maxWeeksToShow) {
                linearData[actualWeeks] = Math.round(endWeight * 10) / 10;
            }
            if (estimatedWeeksRealistic <= maxWeeksToShow) {
                nonlinearData[actualWeeks] = Math.round(endWeight * 10) / 10;
            }




            window.nonlinearProgressData = {
                totalSemanas: actualWeeks + 1,
                nonlinearDataLength: nonlinearData.length,
                nonlinearData: [...nonlinearData], // Copia del array (por seguridad)
                hasUndefined: nonlinearData.some(v => v === undefined || v === null),
                startWeight,
                endWeight,
                timestamp: new Date(), // Opcional: marca de tiempo
            };

            // === üåê ALMACENAR TODOS LOS DATOS EN UN OBJETO GLOBAL DETALLADO ===
            window.nonlinearProgressData_1 = {
                // --- üîñ Metadatos ---
                modelo: "MEPNL v2.1 - Evoluci√≥n No Lineal",
                version: "2.1",
                timestamp: new Date().toISOString(),
                descripcion: "Datos generados por el modelo no lineal de progreso f√≠sico basado en adaptaci√≥n metab√≥lica.",

                // --- üéØ Objetivo de cambio de peso ---
                objetivo: {
                    tipo: weightChangeGoal > 0 ? "Ganancia" : "P√©rdida",
                    metaKg: Math.abs(weightChangeGoal),
                    pesoInicial: startWeight,
                    pesoFinal: endWeight,
                },

                // --- üë§ Informaci√≥n del usuario ---
                usuario: {
                    genero: userGender,
                    edad: userAge,
                    grasaCorporalInicial: currentFatPerc,
                    deportista: isAthlete,
                    nivelActividad: userActivityLevel, // si lo tienes
                    pesoInicial: startWeight,
                },

                // --- üîß Par√°metros del modelo ---
                parametros: {
                    k: noLineal.k?.toFixed(6), // sensibilidad metab√≥lica
                    alpha: noLineal.alpha?.toFixed(6), // factor de adaptaci√≥n positiva
                    beta: noLineal.beta?.toFixed(6), // factor de adaptaci√≥n negativa
                    adherencia: noLineal.adherencia, // % de cumplimiento asumido
                    tasaInicialKgPorSemana: parseFloat(noLineal.tasaInicial.toFixed(4)),
                },

                // --- üî• Variables energ√©ticas ---
                energia: {
                    deficitSuperavitSemanalKcal: weeklyCalorieDiff,
                    deficitSuperavitDiarioPromedio: Math.round(weeklyCalorieDiff / 7),
                    tdeeInicial: Math.round(noLineal.semanas[0]?.tdee), // TDEE semana 1
                    tdeeFinal: Math.round(noLineal.semanas[noLineal.semanas.length - 1]?.tdee), // √∫ltima semana
                    tdeeCambioPercent: noLineal.semanas.length > 1 ?
                        (((noLineal.semanas[noLineal.semanas.length - 1]?.tdee - noLineal.semanas[0]?.tdee) / noLineal.semanas[0]?.tdee) * 100).toFixed(2) :
                        "0.00",
                },

                // --- üìÖ Estimaciones temporales ---
                tiempo: {
                    semanasEstimadas: estimatedWeeksRealistic,
                    mesesEstimados: (estimatedWeeksRealistic / 4.3).toFixed(1),
                    fechaEstimadaFinalizacion: new Date(Date.now() + estimatedWeeksRealistic * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    metaAlcanzada: noLineal.metaAlcanzada,
                },

                // --- üìä Evoluci√≥n semanal (tabla) ---
                evolucionSemanal: tableData, // ya formateado como array de objetos

                // --- üìà M√©tricas avanzadas ---
                metricas: {
                    totalSemanasCalculadas: tableData.length,
                    tasaPromedioKgPorSemana: parseFloat(
                        (Math.abs(endWeight - startWeight) / tableData.length).toFixed(4)
                    ),
                    cambioTotalPeso: parseFloat((endWeight - startWeight).toFixed(3)),
                    //adaptacionMetabolicaPercent: parseFloat(window.nonlinearProgressData_1.energia.tdeeCambioPercent),
                    eficienciaModelo: noLineal.metaAlcanzada
                        ? "Alta (meta alcanzada)"
                        : "Media/Baja (ajustar par√°metros)",
                },

                // --- üí° Notas y recomendaciones ---
                notas: [
                    "El modelo simula adaptaci√≥n metab√≥lica progresiva.",
                    "La adherencia del usuario impacta fuertemente en la convergencia.",
                    "Tasas iniciales altas pueden decaer r√°pidamente por compensaci√≥n fisiol√≥gica.",
                    "Revisar par√°metros 'k', 'alpha', 'beta' si los resultados no coinciden con casos reales."
                ],
            };

            // === üì£ Mostrar en consola con formato ===

            console.log("%cüìä MEPNL v2.1 - Evoluci√≥n No Lineal", "font-weight: bold; color: #1976d2; font-size: 16px;");
            console.log("üéØ Objetivo:", window.nonlinearProgressData_1.objetivo.tipo, window.nonlinearProgressData_1.objetivo.metaKg, "kg");
            console.log("üë§ Usuario:", window.nonlinearProgressData_1.usuario.genero, "| Edad:", window.nonlinearProgressData_1.usuario.edad, "| % Grasa:", window.nonlinearProgressData_1.usuario.grasaCorporalInicial, "| Deportista:", window.nonlinearProgressData_1.usuario.deportista ? "S√≠" : "No");
            console.log("‚ö° Diferencia cal√≥rica semanal:", window.nonlinearProgressData_1.energia.deficitSuperavitSemanalKcal, "kcal");
            console.log("üìÖ Semanas estimadas (realista):", window.nonlinearProgressData_1.tiempo.semanasEstimadas);
            console.log("üìâ Tasa inicial estimada:", window.nonlinearProgressData_1.parametros.tasaInicialKgPorSemana, "kg/semana");

            // Tabla detallada
            console.table(window.nonlinearProgressData_1.evolucionSemanal);

            // Resultados finales
            console.log("%cüìà Resultados Finales", "font-weight: bold; color: #d84315; font-size: 14px;");
            console.log("‚úÖ Meta alcanzada:", window.nonlinearProgressData_1.tiempo.metaAlcanzada ? "S√≠" : "No");
            console.log("‚è±Ô∏è  Duraci√≥n:", window.nonlinearProgressData_1.tiempo.semanasEstimadas, "semanas (~" + window.nonlinearProgressData_1.tiempo.mesesEstimados + " meses)");
            console.log("‚öñÔ∏è  Peso inicial:", window.nonlinearProgressData_1.objetivo.pesoInicial, "kg ‚Üí Peso final:", window.nonlinearProgressData_1.objetivo.pesoFinal, "kg");
            console.log("üí° TDEE inicial:", window.nonlinearProgressData_1.energia.tdeeInicial, "kcal/d√≠a ‚Üí final:", window.nonlinearProgressData_1.energia.tdeeFinal, "kcal/d√≠a (" + window.nonlinearProgressData_1.energia.tdeeCambioPercent + "%)");
            console.log("üìä Tasa promedio:", window.nonlinearProgressData_1.metricas.tasaPromedioKgPorSemana, "kg/semana");



            timeChartContainer.innerHTML = '<canvas id="timeEstimationChart"></canvas>';
            const ctx = document.getElementById('timeEstimationChart')?.getContext('2d');
            if (!ctx) {
                console.error("Failed to get canvas context for timeEstimationChart");
                displayError(timeEstimationResultDiv, "Error: No se pudo renderizar el gr√°fico.");
                updateButtonStates();
                return;
            }

            try {
                timeEstimationChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: 'Proyecci√≥n Lineal (Te√≥rica)',
                                data: linearData,
                                borderColor: '#2E7D32', // Verde oscuro
                                backgroundColor: 'rgba(46, 125, 50, 0.2)',
                                fill: false,
                                tension: 0.1,
                                borderWidth: 3,        // L√≠nea m√°s gruesa
                                pointRadius: 2,        // Puntos m√°s grandes
                                pointHoverRadius: 4,
                                //pointBackgroundColor: '#2E7D32'
                            },
                            {
                                label: 'Proyecci√≥n No Lineal (Realista)',
                                data: nonlinearData,
                                borderColor: '#F57C00',
                                backgroundColor: 'rgba(245, 124, 0, 0.1)',
                                fill: false,
                                tension: 0.1,
                                borderWidth: 3,        // ¬°M√°s gruesa que la otra!
                                borderDash: [5, 5],    // L√≠nea punteada para diferenciar
                                pointRadius: 2,
                                pointHoverRadius: 4,
                                //pointBackgroundColor: '#D84315'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { usePointStyle: true } },
                            title: {
                                display: true,
                                text: `Comparaci√≥n: Proyecci√≥n Lineal vs. Realista (${startWeight.toFixed(1)} kg ‚Üí ${endWeight.toFixed(1)} kg)`,
                                font: { size: 16 },
                                color: '#1B5E20'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function (tooltipItems) {
                                        const dataIndex = tooltipItems[0].dataIndex;
                                        let weekNum = '?';
                                        for (let i = dataIndex; i >= 0; i--) {
                                            const label = chartLabels[i];
                                            if (label && label.startsWith('Sem ')) {
                                                weekNum = label.substring(4);
                                                break;
                                            }
                                        }
                                        return `Semana ${weekNum}`;
                                    },
                                    label: function (context) {
                                        return `${context.dataset.label}: ${context.parsed.y} kg`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: 'Peso (kg)', color: '#1B5E20' },
                                ticks: { color: '#1B5E20', callback: value => value.toFixed(1) },
                                min: Math.min(startWeight, endWeight) - 2,
                                max: Math.max(startWeight, endWeight) + 2
                            },
                            x: {
                                title: { display: true, text: 'Semanas', color: '#1B5E20' },
                                ticks: { color: '#1B5E20', maxRotation: 0, minRotation: 0 }
                            }
                        }
                    }
                });


                // Mostrar time-estimation-result con animaci√≥n
                const timeEstimationResult = document.getElementById('time-estimation-result');
                if (timeEstimationResult) {
                    timeEstimationResult.style.display = 'block';
                    timeEstimationResult.style.opacity = '0';
                    setTimeout(() => {
                        timeEstimationResult.style.transition = 'opacity 0.4s ease';
                        timeEstimationResult.style.opacity = '1';
                    }, 100);
                }
                timeChartContainer.style.display = 'block';
                console.log("Step 6 Chart rendered with linear and non-linear projections");
            } catch (error) {
                console.error("Error rendering Step 6 chart:", error);
                displayError(timeEstimationResultDiv, "Error al renderizar el gr√°fico de estimaci√≥n.");
            }
        } else {
            if (timeChartContainer) timeChartContainer.style.display = 'none';
        }

        updateButtonStates();
        // Mostrar el icono del gr√°fico despu√©s de la estimaci√≥n
        const chartIconLink = document.querySelector('a[data-bs-target="#modalCalculadoraNoLineal"]');
        if (chartIconLink) {
            chartIconLink.style.display = 'inline-flex'; // o 'inline-block' seg√∫n tu dise√±o
        }
    }

    function calcularFactorAdaptacion(edad, sexo, nivelActividad, esDeportista) {
        let factorBase = 0.15; // Factor por defecto

        // === POR EDAD ===
        if (edad >= 65) {
            factorBase += 0.10; // +67% m√°s adaptaci√≥n
        } else if (edad >= 55) {
            factorBase += 0.08; // +53% m√°s adaptaci√≥n
        } else if (edad >= 45) {
            factorBase += 0.05; // +33% m√°s adaptaci√≥n
        } else if (edad >= 35) {
            factorBase += 0.03; // +20% m√°s adaptaci√≥n
        }
        // < 35 a√±os: factor base

        // === POR SEXO ===
        if (sexo === 'female') {
            factorBase += 0.05; // +33% m√°s adaptaci√≥n (mayor defensa energ√©tica)
        }

        // === POR NIVEL DE ACTIVIDAD ===
        const factoresActividad = {
            'sedentario': 0.08,   // +53% adaptaci√≥n
            'leve': 0.05,         // +33% adaptaci√≥n
            'moderate': 0.03,     // +20% adaptaci√≥n
            'active': 0.01,       // +7% adaptaci√≥n
            'very-active': 0.00   // Base (menos adaptaci√≥n)
        };

        factorBase += factoresActividad[nivelActividad] || 0.05;

        // === POR SER DEPORTISTA ===
        if (esDeportista) {
            factorBase -= 0.03; // -20% menos adaptaci√≥n (mejor metabolismo)
        }

        // === L√çMITES ===
        return Math.max(0.10, Math.min(0.40, factorBase)); // Entre 0.10 y 0.40
    }





    // --- Step 7: Generate Hyperprotein Cycle Table (Manual) ---
    // Function definition moved outside DOMContentLoaded for onclick

    // --- PDF Generation ---
    function guardarComoPDF() {
        if (!calculatedTDEE) {
            alert("Por favor, completa al menos el Paso 1 (C√°lculo de Necesidades) antes de generar el PDF.");
            return;
        }

        const mainElement = document.querySelector('main');
        const headerElement = document.querySelector('header');
        const footerElement = document.querySelector('footer');
        const allButtons = document.querySelectorAll('button'); // Select all buttons

        // Store original display styles
        const originalDisplays = new Map();
        const elementsToHide = [headerElement, footerElement, ...allButtons];
        elementsToHide.forEach(el => {
            if (el) {
                originalDisplays.set(el, el.style.display);
                el.style.display = 'none';
            }
        });


        // Temporarily make chart containers visible if they have content
        const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
        chartContainers.forEach(container => {
            if (container) {
                originalDisplays.set(container, container.style.display);
                // Only make visible if it actually contains a chart canvas
                if (container.querySelector('canvas') && container.style.display === 'none') {
                    container.style.display = 'block';
                }
            }
        });

        // Make tables visible if they have content
        const tableContainers = document.querySelectorAll('#detailed-cycle-table-container, #hyperprotein-cycle-table-container');
        tableContainers.forEach(container => {
            if (container) {
                const table = container.querySelector('table');
                // Check if table exists and is not already visible but has rows
                if (table) {
                    originalDisplays.set(table, table.style.display);
                    if (table.style.display === 'none' && table.querySelector('tbody tr')) {
                        table.style.display = 'table'; // Make visible for PDF
                    }
                }
            }
        });


        const opt = {
            margin: [15, 10, 15, 10], // top, left, bottom, left margins in mm
            filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: {
                scale: 2,
                useCORS: true,
                logging: false,
                // Try to capture full width/height
                windowWidth: mainElement.scrollWidth,
                windowHeight: mainElement.scrollHeight
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' } // Try to avoid breaking inside steps
        };

        console.log("Generating PDF...");
        html2pdf().from(mainElement).set(opt).save().then(() => {
            console.log("PDF generated successfully.");
            // Restore original display styles
            originalDisplays.forEach((display, element) => {
                if (element) {
                    element.style.display = display;
                }
            });
        }).catch(err => {
            console.error("Error generating PDF:", err);
            alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para m√°s detalles.");
            // Restore original display styles even on error
            originalDisplays.forEach((display, element) => {
                if (element) {
                    element.style.display = display;
                }
            });
        });
    }

    // --- Reset Functions ---
    /** Resets Step 2 results and dependent steps */
    function resetStep2onwards() {
        clearContainer(weightGoalResultDiv);
        displayInfo(weightGoalResultDiv, 'Completa el Paso 1 para habilitar este c√°lculo.');
        if (weightChartContainer) weightChartContainer.style.display = 'none';
        if (weightEvolutionChartInstance) { weightEvolutionChartInstance.destroy(); weightEvolutionChartInstance = null; }
        targetWeightKgGlobal = null;
        goalTypeGlobal = 'maintenance';
        estimatedWeeksGlobal = 0;
        targetWeeklyRateKgGlobal = 0;
        if (goalCaloriesInput) goalCaloriesInput.value = ''; // Clear goal calories input
        // Reset macro percentages to default initial values
        if (proteinPercentageInput) proteinPercentageInput.value = 30;
        if (carbPercentageInput) carbPercentageInput.value = 40;
        if (fatPercentageInput) fatPercentageInput.value = 30;
        adjustMacroPercentages(); // Update total display
        resetStep3onwards(); // Also reset subsequent steps
    }

    /** Resets Step 3 results and dependent steps */
    function resetStep3onwards() {
        clearContainer(macroResultDiv);
        displayInfo(macroResultDiv, 'Completa los Pasos 1 y 2 para habilitar este c√°lculo.');
        if (chartContainer) chartContainer.style.display = 'none'; // Hide macro chart
        if (macroChartInstance) { macroChartInstance.destroy(); macroChartInstance = null; }
        calculatedMacros = { proteinGrams: 0, carbGrams: 0, fatGrams: 0, goalCalories: 0 };
        resetStep4onwards(); // Also reset subsequent steps
        resetStep5Table(); // Reset Step 5 table
    }

    /** Resets Step 4 results */
    function resetStep4onwards() {
        clearContainer(mealResultDiv);
        displayInfo(mealResultDiv, 'Completa el Paso 3 para habilitar este c√°lculo.');
    }

    /** Resets Step 5 (Auto Table) results */
    function resetStep5Table() {
        clearContainer(step5TableContainer);
        displayInfo(step5TableContainer, '<em>Completa los Pasos 1, 2 y 3 para generar esta tabla autom√°tica.</em>');
    }

    /** Resets Step 6 (Manual Estimation) results */
    function resetStep6() {
        clearContainer(timeEstimationResultDiv);
        displayInfo(timeEstimationResultDiv, 'Completa el Paso 1 para habilitar esta estimaci√≥n.');
        if (timeChartContainer) timeChartContainer.style.display = 'none';
        if (timeEstimationChartInstance) { timeEstimationChartInstance.destroy(); timeEstimationChartInstance = null; }
        // Reset related globals
        estimatedWeeksManualGlobal = null;
        weightChangeGoalManualGlobal = null;
        weeklyCalorieDiffManualGlobal = null;
        resetStep7(); // Reset manual table as well
        updateButtonStates(); // Update button states after reset
    }

    /** Resets Step 7 (Manual Table) results */
    function resetStep7() {
        if (hyperproteinTableBody) hyperproteinTableBody.innerHTML = '';
        if (hyperproteinTable) hyperproteinTable.style.display = 'none';
        if (hyperproteinInfoMessage) hyperproteinInfoMessage.style.display = 'block';
        if (hyperproteinInfoMessage) hyperproteinInfoMessage.innerHTML = '<em>Completa el Paso 6 para generar esta tabla.</em>';
        if (hyperproteinNoteContainer) hyperproteinNoteContainer.innerHTML = ''; // Clear the note
        // Button state is handled by updateButtonStates called in resetStep6
    }


    // Event Listeners for new manual steps
    if (btnCalculateProgress) {
        btnCalculateProgress.addEventListener('click', (e) => guardarYCalcularModal(e));
    }
    if (btnExportProgress) {
        btnExportProgress.addEventListener('click', exportarTablaProgreso);
    }
    if (logoutLink) {
        if (typeof logout === 'function') {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                logout();
            });
        }
    }

    // --- Add Event Listeners ---
    if (calorieForm) {
        calorieForm.addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent default form submission
            calculateCalories();
        });
    }
    if (weightGoalForm) {
        weightGoalForm.addEventListener('submit', (event) => {
            event.preventDefault();
            calculateWeightGoal();
        });
    }
    if (macroForm) {
        macroForm.addEventListener('submit', (event) => {
            event.preventDefault();
            calculateMacros();
            //calcularMacros(); 
        });
    }
    if (mealForm) {
        mealForm.addEventListener('submit', (event) => {
            event.preventDefault();
            generateMealPlan();
        });
    }
    if (timeEstimationForm) {
        timeEstimationForm.addEventListener('submit', (event) => {
            event.preventDefault();
            estimateTimeManually();
        });
    }
    if (savePdfButton) {
        savePdfButton.addEventListener('click', guardarComoPDF);
    }
    event.preventDefault();

    calcularMacros();
    // Listeners for live percentage updates
    if (proteinPercentageInput && carbPercentageInput && fatPercentageInput) { // Check if elements exist before adding listeners
        proteinPercentageInput.addEventListener('input', adjustMacroPercentages);
        carbPercentageInput.addEventListener('input', adjustMacroPercentages);
        fatPercentageInput.addEventListener('input', adjustMacroPercentages);
    }
    if (mealPercentageInputs) {
        mealPercentageInputs.forEach(input => {
            input.addEventListener('input', adjustMealPercentages);
        });
    }


    // --- Initial Setup Calls ---
    adjustMacroPercentages(); // Initial calculation for macro total
    adjustMealPercentages();  // Initial calculation for meal total
    updateButtonStates();     // Set initial button disabled states

});

// End of DOMContentLoaded listener


// --- Step 7: Generate Hyperprotein Cycle Table (Manual) ---
// Needs to be globally accessible for the onclick attribute
/**
* Generates a hyperprotein cycle table based on manual estimations from Step 6.
* Requires global variables from Step 1 (user data) and Step 6 (manual estimation).
*/
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake (g and g/kg) for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 * Table columns: Ciclo, Fase, Semanas, Peso (kg), Kcal/d√≠a/AF, Prote√≠nas (g/kg), Ajuste Cal√≥rico.
 */
/**
 * Generates a hyperprotein cycle table based on manual estimations from Step 6.
 * Shows Kcal/day and protein intake (g and g/kg) for all activity levels (0: Sedentary, 1: Light, 2: Moderate, 3: Active, 4: Very Active).
 * Limits protein intake to a maximum of 2.5 g/kg of body weight.
 * Table columns: Ciclo, Fase, Semanas, Peso (kg), Kcal/d√≠a/AF, Prote√≠nas (g/kg), Notas.
 */
function generateHyperproteinCycles() {
    // DOM references
    const tableContainer = document.getElementById('hyperprotein-cycle-table-container');
    const table = document.getElementById('hyperprotein-cycle-table');
    const tableBody = document.getElementById('hyperprotein-cycle-table-body');
    const infoMessage = document.getElementById('hyperprotein-info-message');
    const noteContainer = document.getElementById('hyperprotein-note-container');

    // Clear previous content
    if (tableBody) tableBody.innerHTML = '';
    if (table) table.style.display = 'none';
    if (infoMessage) infoMessage.style.display = 'block';
    if (noteContainer) noteContainer.innerHTML = '';

    // Validate prerequisites
    if (!currentWeightKg || !userAge || !userHeightCm || !userGender || !userActivityLevel ||
        estimatedWeeksManualGlobal === null || estimatedWeeksManualGlobal <= 0 ||
        weightChangeGoalManualGlobal === null || weeklyCalorieDiffManualGlobal === null ||
        isNaN(weeklyCalorieDiffManualGlobal) || weeklyCalorieDiffManualGlobal === 0) {
        if (infoMessage) {
            infoMessage.innerHTML = '<em>Completa el Paso 6 (Estimaci√≥n Manual) con valores v√°lidos (tiempo > 0 semanas, diferencia cal√≥rica distinta de cero) y aseg√∫rate de haber completado el Paso 1.</em>';
        }
        console.warn("Prerequisites for Step 7 not met:", {
            currentWeightKg, userAge, userHeightCm, userGender, userActivityLevel,
            estimatedWeeksManualGlobal, weightChangeGoalManualGlobal, weeklyCalorieDiffManualGlobal
        });
        return;
    }

    // Additional input validations
    if (currentWeightKg <= 0 || isNaN(currentWeightKg)) {
        if (infoMessage) infoMessage.innerHTML = '<em>El peso actual debe ser un valor positivo v√°lido.</em>';
        return;
    }
    if (Math.abs(weightChangeGoalManualGlobal) < 0.1 && goalType !== 'maintenance') {
        if (infoMessage) infoMessage.innerHTML = '<em>El cambio de peso debe ser significativo para generar ciclos.</em>';
        return;
    }

    // Define multiplicadores por g√©nero usando valores num√©ricos como strings
    const maleActivityMultipliers = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.56, // light
        '1.55': 1.78,  // moderate
        '1.725': 2.1,  // active
        '1.9': 2.3     // very_active
    };

    const femaleActivityMultipliers = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.55, // light
        '1.55': 1.64,  // moderate
        '1.725': 1.82, // active
        '1.9': 2.0     // very_active
    };

    // Selecciona el objeto seg√∫n el g√©nero
    const activityMultipliers = userGender === 'male' ? maleActivityMultipliers : femaleActivityMultipliers;

    // Define activity levels array based on available multipliers
    const activityLevels = Object.keys(activityMultipliers); // ['1.2', '1.375', '1.55', '1.725', '1.9']

    // Map activity levels to descriptive names for better UX
    const activityLevelNames = {
        '1.2': 'Sedentario',
        '1.375': 'Ligero',
        '1.55': 'Moderado',
        '1.725': 'Activo',
        '1.9': 'Muy Activo'
    };

    // Validate activity level with detailed error handling
    const activityMultiplier = activityMultipliers[userActivityLevel];
    if (activityMultiplier === undefined) {
        const errorMessage = `Nivel de actividad no v√°lido: "${userActivityLevel}". Valores permitidos: ${Object.keys(activityMultipliers).join(', ')}`;

        if (infoMessage) {
            infoMessage.innerHTML = `<em>Error: ${errorMessage}</em>`;
        }

        console.error("Invalid activity level:", userActivityLevel);
        console.log("Available activity levels:", Object.keys(activityMultipliers));
        console.log("User gender:", userGender);

        return;
    }

    // Use stored global values
    const totalWeeks = estimatedWeeksManualGlobal;
    const weightChangeGoal = weightChangeGoalManualGlobal;
    const weeklyCalorieDiff = weeklyCalorieDiffManualGlobal;
    const goalType = weightChangeGoal < 0 ? 'loss' : (weightChangeGoal > 0 ? 'gain' : 'maintenance');

    if (goalType === 'maintenance') {
        if (infoMessage) infoMessage.innerHTML = '<em>No se requiere tabla de ciclos hiperproteicos para un objetivo de mantenimiento.</em>';
        return;
    }

    // Calculate weekly weight change
    const weeklyRateKg = weightChangeGoal / totalWeeks;
    const dailyCalorieDiff = weeklyCalorieDiff / 7;
    const dailyCalorieDiffBreak = (weeklyCalorieDiff * 0.5) / 7; // Reduced deficit for break phase

    // Cycle configuration
    const phaseWeeksPerCycle = 4;
    const breakWeeksPerCycle = 1;
    const cycleDuration = phaseWeeksPerCycle + breakWeeksPerCycle;

    let currentWeek = 0;
    let currentWeight = currentWeightKg;
    let cycleCount = 1;

    console.log("Generating Step 7 Table:", { totalWeeks, weightChangeGoal, weeklyCalorieDiff, weeklyRateKg, goalType, dailyCalorieDiff, dailyCalorieDiffBreak });

    // Helper function to round to nearest multiple
    const roundToNearest = (value, multiple) => Math.round(value / multiple) * multiple;

    // Helper function to format calories and proteins for all activity levels
    const formatCaloriesAndProteins = (bmr, calorieDiff, proteinPercentage, weight) => {
        const calories = activityLevels.map((level, index) => {
            const tdee = bmr * activityMultipliers[level] + calorieDiff;
            return roundToNearest(tdee, 10);
        });
        const proteins = calories.map(kcal => {
            let proteinGrams = roundToNearest((kcal * proteinPercentage) / 4, 1);
            // Limit gPerKg to 2.5 g/kg
            const maxProteinGrams = weight > 0 ? roundToNearest(2.5 * weight, 1) : proteinGrams;
            if (weight > 0 && proteinGrams / weight > 2.5) {
                proteinGrams = maxProteinGrams;
            }
            return proteinGrams;
        });
        const proteinsText = proteins.map((g, index) => {
            const gPerKg = weight > 0 ? (g / weight).toFixed(1) : '0.0';
            return `${index}: ${g} g / ${gPerKg} g/kg`;
        }).join('<br>');
        return { calories, proteinsText };
    };

    // ... resto de tu c√≥digo ...

    while (currentWeek < totalWeeks) {
        // --- Hyperprotein Phase ---
        const phaseDuration = Math.min(phaseWeeksPerCycle, totalWeeks - currentWeek);
        if (phaseDuration <= 0) break;

        const phaseWeightChange = weeklyRateKg * phaseDuration;
        let phaseEndWeight = currentWeight + phaseWeightChange;
        phaseEndWeight = goalType === 'loss'
            ? Math.max(phaseEndWeight, currentWeightKg + weightChangeGoal)
            : Math.min(phaseEndWeight, currentWeightKg + weightChangeGoal);

        // Calculate BMR
        let phaseStartBMR;
        if (userGender === 'male') {
            phaseStartBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else {
            phaseStartBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calculate calories and proteins for all activity levels
        const { calories: phaseCalories, proteinsText: phaseProteinsText } = formatCaloriesAndProteins(phaseStartBMR, dailyCalorieDiff, 0.35, currentWeight);

        // Validate calorie range
        if (phaseCalories.some(kcal => kcal < 1000 || kcal > 5000)) {
            if (infoMessage) infoMessage.innerHTML = '<em>Las calor√≠as calculadas para la fase hiperproteica no son realistas. Revisa la diferencia cal√≥rica semanal.</em>';
            console.warn("Unrealistic phase calories:", phaseCalories);
            return;
        }

        // Format calories for display
        const phaseCaloriesText = phaseCalories.map((kcal, index) => `${index}: ${kcal} kcal`).join('<br>');

        const hyperproteinRow = document.createElement('tr');
        hyperproteinRow.classList.add('phase-hyperprotein');
        hyperproteinRow.innerHTML = `
            <td>${cycleCount}</td>
            <td>Hiperproteico</td>
            <td>${phaseDuration}</td>
            <td>${currentWeight.toFixed(1)} ‚Üí ${phaseEndWeight.toFixed(1)}</td>
            <td>${phaseCaloriesText}</td>
            <td>${phaseProteinsText}</td>
            <td>${goalType === 'loss' ? `D√©ficit (${dailyCalorieDiff.toFixed(0)} kcal/d)` : `Super√°vit (+${dailyCalorieDiff.toFixed(0)} kcal/d)`}</td>
        `;
        if (tableBody) tableBody.appendChild(hyperproteinRow);

        currentWeek += phaseDuration;
        currentWeight = phaseEndWeight;

        // Exit if target weight reached (tolerance 0.05)
        if ((goalType === 'loss' && currentWeight <= currentWeightKg + weightChangeGoal + 0.05) ||
            (goalType === 'gain' && currentWeight >= currentWeightKg + weightChangeGoal - 0.05)) {
            break;
        }

        // --- Break Phase ---
        if (currentWeek < totalWeeks) {
            const breakDuration = Math.min(breakWeeksPerCycle, totalWeeks - currentWeek);
            if (breakDuration <= 0) break;

            let breakBMR;
            if (userGender === 'male') {
                breakBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) + 5;
            } else {
                breakBMR = (10 * currentWeight) + (6.25 * userHeightCm) - (5 * userAge) - 161;
            }

            // Calculate calories and proteins for all activity levels
            const { calories: breakCalories, proteinsText: breakProteinsText } = formatCaloriesAndProteins(breakBMR, dailyCalorieDiffBreak, 0.25, currentWeight);

            // Validate calorie range
            if (breakCalories.some(kcal => kcal < 1000 || kcal > 5000)) {
                if (infoMessage) infoMessage.innerHTML = '<em>Las calor√≠as calculadas para la fase de break no son realistas. Revisa los datos de entrada.</em>';
                console.warn("Unrealistic break calories:", breakCalories);
                return;
            }

            // Format calories for display
            const breakCaloriesText = breakCalories.map((kcal, index) => `${kcal} kcal`).join('<br>');

            const breakRow = document.createElement('tr');
            breakRow.classList.add('phase-break');
            breakRow.innerHTML = `
                <td>${cycleCount}</td>
                <td>Break (P√©rdida Reducida)</td>
                <td>${breakDuration}</td>
                <td>~ ${currentWeight.toFixed(1)}</td>
                <td>${breakCaloriesText}</td>
                <td>${breakProteinsText}</td>
                <td>D√©ficit reducido (${dailyCalorieDiffBreak.toFixed(0)} kcal/d)</td>
            `;
            if (tableBody) tableBody.appendChild(breakRow);

            // Update weight for reduced loss in break phase
            const breakWeightChange = (weeklyRateKg * 0.5) * breakDuration;
            currentWeight += breakWeightChange;

            currentWeek += breakDuration;
            cycleCount++;
        }

        // Exit if target weight reached during break
        if ((goalType === 'loss' && currentWeight <= currentWeightKg + weightChangeGoal + 0.05) ||
            (goalType === 'gain' && currentWeight >= currentWeightKg + weightChangeGoal - 0.05)) {
            break;
        }
    }

    // Correct final weight display directly
    if (tableBody && tableBody.lastElementChild) {
        const lastRowCells = tableBody.lastElementChild.cells;
        if (lastRowCells && lastRowCells.length > 3) {
            const weightCell = lastRowCells[3];
            const finalTargetWeight = currentWeightKg + weightChangeGoal;
            const currentText = weightCell.textContent;
            const startWeightMatch = currentText.match(/^(-?\d+\.\d)/); // Match start weight
            if (startWeightMatch && Math.abs(currentWeight - finalTargetWeight) > 0.05) {
                weightCell.innerHTML = `${startWeightMatch[1]} ‚Üí ${finalTargetWeight.toFixed(1)}`;
                console.log(`Corrected final weight display to ${finalTargetWeight.toFixed(1)}`);
            }
        }
    }

    // Show table and hide info message
    if (table) table.style.display = 'table';
    if (infoMessage) infoMessage.style.display = 'none';

    // Add note
    if (noteContainer) {
        const note = document.createElement('p');
        note.style.fontSize = '0.9em';
        note.style.fontStyle = 'italic';
        note.style.marginTop = '10px';
        note.textContent = 'Nota: Esta tabla es una simulaci√≥n basada en la estimaci√≥n manual del Paso 6. Las calor√≠as y prote√≠nas se muestran para todos los niveles de actividad (0: Sedentario, 1: Leve, 2: Moderado, 3: Activo, 4: Muy Activo). Prote√≠nas limitadas a un m√°ximo de 2.5 g/kg. Ajusta seg√∫n progreso real y consulta a un profesional.';
        noteContainer.appendChild(note);
    }
}





/// actualizador barras graficas de macronutrientes////////////////

document.addEventListener('DOMContentLoaded', function () {
    // Obtener referencias a los inputs
    const proteinInput = document.getElementById('protein-percentage');
    const carbInput = document.getElementById('carb-percentage');
    const fatInput = document.getElementById('fat-percentage');

    // Obtener referencias a las barras
    const proteinBar = document.querySelector('.protein-bar');
    const carbsBar = document.querySelector('.carbs-bar');
    const fatBar = document.querySelector('.fat-bar');

    // Obtener referencias a las etiquetas
    const proteinLabel = document.querySelector('.protein-label');
    const carbsLabel = document.querySelector('.carbs-label');
    const fatLabel = document.querySelector('.fat-label');

    // Obtener referencia al total
    const totalDisplay = document.getElementById('macro-percentage-total');

    // Funci√≥n para actualizar las barras y etiquetas
    function updateMacroBars() {
        // Obtener valores de los inputs
        const proteinValue = parseInt(proteinInput.value) || 0;
        const carbValue = parseInt(carbInput.value) || 0;
        const fatValue = parseInt(fatInput.value) || 0;

        // Calcular el total
        const total = proteinValue + carbValue + fatValue;

        // Actualizar las barras
        proteinBar.style.width = proteinValue + '%';
        carbsBar.style.width = carbValue + '%';
        fatBar.style.width = fatValue + '%';

        // Actualizar las etiquetas
        proteinLabel.textContent = 'Prote√≠na: ' + proteinValue + '%';
        carbsLabel.textContent = 'Carbohidratos: ' + carbValue + '%';
        fatLabel.textContent = 'Grasas: ' + fatValue + '%';

        // Actualizar el total
        totalDisplay.textContent = 'Total: ' + total + '%';

        // Cambiar color seg√∫n el total
        if (total === 100) {
            totalDisplay.style.color = '#4CAF50';
            totalDisplay.innerHTML = 'Total: ' + total + '% ‚úì';
        } else {
            totalDisplay.style.color = '#F44336';
            totalDisplay.innerHTML = 'Total: ' + total + '% ‚úó';
        }
    }

    // A√±adir event listeners a los inputs para cambios manuales
    proteinInput.addEventListener('input', updateMacroBars);
    carbInput.addEventListener('input', updateMacroBars);
    fatInput.addEventListener('input', updateMacroBars);

    // Crear observadores para cambios autom√°ticos en los inputs
    function createObserver(inputElement) {
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                    updateMacroBars();
                }
            });
        });

        observer.observe(inputElement, {
            attributes: true,
            attributeFilter: ['value']
        });
    }

    // Configurar observadores para cada input
    createObserver(proteinInput);
    createObserver(carbInput);
    createObserver(fatInput);

    // Tambi√©n verificar cambios peri√≥dicamente (como respaldo)
    setInterval(updateMacroBars, 1000);

    // Inicializar la visualizaci√≥n
    updateMacroBars();

    // Hacer la funci√≥n accesible globalmente para otras funciones
    window.updateMacroBars = updateMacroBars;
});

// Inicializa los popovers
const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));



/* =====================================
   Referencias r√°pidas
===================================== */
const weightChangeEl = document.getElementById('weight-change-goal');
const weeklyDiffEl = document.getElementById('weekly-calorie-diff');
const getEl = document.getElementById('get-calories');   // fijo
const goalCalEl = document.getElementById('goal-calories');
const pcEl = document.getElementById('goal-caloriespc');

/* =====================================
   Funciones auxiliares
===================================== */
// Devuelve el GET como n√∫mero
function getGET() {
    return parseFloat(getEl.value) || 0;
}

// % ‚Üí diferencia semanal (con signo)
function pcToWeeklyDiff(pc) {
    const weekly = (Number(pc) / 100) * (getGET() * 7);
    return Math.round(weekly * (Number(weightChangeEl.value) < 0 ? -1 : 1));
}

// diferencia semanal ‚Üí %
function weeklyDiffToPc(diff) {
    return Math.round(Math.abs(Number(diff)) / (getGET() * 7) * 100);
}

// actualiza Kcal/d√≠a seg√∫n objetivo
function updateGoalCal() {
    const weekly = Number(weeklyDiffEl.value) || 0;
    const daily = Math.round(getGET() + weekly / 7);
    goalCalEl.value = daily;
}

/* =====================================
   Listeners
===================================== */
pcEl.addEventListener('input', () => {
    const pc = Number(pcEl.value) || 0;
    const diff = pcToWeeklyDiff(pc);
    weeklyDiffEl.value = diff;   // n√∫mero
    updateGoalCal();
});

weeklyDiffEl.addEventListener('input', () => {
    const diff = Number(weeklyDiffEl.value) || 0;
    const pc = weeklyDiffToPc(diff);
    pcEl.value = pc;             // n√∫mero
    updateGoalCal();
});

weightChangeEl.addEventListener('input', () => {
    const pc = Number(pcEl.value) || 0;
    weeklyDiffEl.value = pcToWeeklyDiff(pc);
    updateGoalCal();
});

/* =====================================
   Inicializaci√≥n
===================================== */
updateGoalCal();
// FUNCIONALIDAD PDF
document.getElementById("save-pdf-button").addEventListener("click", async function () {
    // Convertir gr√°ficos a im√°genes
    const charts = document.querySelectorAll('canvas');
    const promises = Array.from(charts).map(chart => {
        return new Promise(resolve => {
            const image = new Image();
            image.src = chart.toDataURL();
            image.onload = () => {
                const img = document.createElement('img');
                img.src = image.src;
                img.style.maxWidth = '90%';
                chart.parentNode.replaceChild(img, chart);
                resolve();
            };
        });
    });

    await Promise.all(promises);

    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'Plan_Nutricional.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: {
            scale: 2,
            scrollY: 0,
            useCORS: true,
            allowTaint: true,
            logging: true
        },
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        },
        pagebreak: { mode: 'avoid-all' }
    };

    const element = document.documentElement;
    html2pdf().set(opt).from(element).save().then(() => {
        // Restaurar los canvas despu√©s de la exportaci√≥n
        charts.forEach((chart, index) => {
            const img = chart.parentNode.querySelector('img');
            if (img) img.replaceWith(chart);
        });
    });
});

// --- PDF Generation ---
function guardarComoPDF2() {
    if (!calculatedTDEE) {
        alert("Por favor, completa al menos el Paso 1 (C√°lculo de Necesidades) antes de generar el PDF.");
        return;
    }

    const mainElement = document.querySelector('main');
    const headerElement = document.querySelector('header');
    const footerElement = document.querySelector('footer');
    const allButtons = document.querySelectorAll('button'); // Select all buttons

    // Hide elements not needed in PDF
    if (headerElement) headerElement.style.display = 'none';
    if (footerElement) footerElement.style.display = 'none';
    allButtons.forEach(btn => btn.style.display = 'none');

    // Temporarily make chart containers visible if they have content
    const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
    const originalDisplayStyles = [];
    chartContainers.forEach(container => {
        originalDisplayStyles.push(container.style.display);
        if (container.querySelector('canvas') && container.style.display === 'none') {
            container.style.display = 'block';
        }
    });

    const opt = {
        margin: [15, 10, 15, 10],
        filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true, logging: false, windowWidth: mainElement.scrollWidth, windowHeight: mainElement.scrollHeight },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' }
    };

    console.log("Generating PDF...");
    html2pdf().from(mainElement).set(opt).save().then(() => {
        console.log("PDF generated successfully.");
        // Restore visibility
        if (headerElement) headerElement.style.display = 'flex';
        if (footerElement) footerElement.style.display = 'block';
        allButtons.forEach(btn => btn.style.display = 'block');
        chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
    }).catch(err => {
        console.error("Error generating PDF:", err);
        alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para m√°s detalles.");
        // Restore visibility even on error
        if (headerElement) headerElement.style.display = 'flex';
        if (footerElement) footerElement.style.display = 'block';
        allButtons.forEach(btn => btn.style.display = 'block');
        chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
    });
}



//--------------- Funciones para las Tablas de la Seccion Ciclos Dieteticos---------------------------------//

// --- Definici√≥n de estructura de fases por objetivo ---
// Esta estructura define las fases t√≠picas, su duraci√≥n relativa y macros base.
// Se puede ampliar para ganancia, mantenimiento, mixto.
const estructuraFasesPorObjetivo = {
    // --- P√©rdida de Peso ---
    perdida: [
        {
            nombre: "Inducci√≥n Cetog√©nica",
            // Duraci√≥n relativa: un n√∫mero que representa la proporci√≥n de tiempo.
            // Por ejemplo, si Induccion=2, Ciclado=3, Transicion=1, la proporcion es 2:3:1
            duracionRelativa: 2,
            // Macros base para la fase (%)
            macros: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [65, 75] },
            objetivoPrincipal: "Reset metab√≥lico, inicio de p√©rdida de grasa, reducci√≥n de insulina.",
            observaciones: "Monitorizar l√≠pidos, electrolitos, presi√≥n arterial. Priorizar grasas insaturadas."
        },
        {
            nombre: "Ciclado Metab√≥lico",
            duracionRelativa: 3,
            macros: { proteinas: [25, 30], carbohidratos: [10, 25], grasas: [40, 65] },
            objetivoPrincipal: "Continuar p√©rdida de peso, mantener rendimiento f√≠sico y evitar estancamiento.",
            observaciones: "Carbohidratos estrat√©gicos antes/despu√©s del ejercicio."
        },
        {
            nombre: "Transici√≥n a Mantenimiento",
            duracionRelativa: 1, // Proporcional al resto
            macros: { proteinas: [20, 25], carbohidratos: [26, 40], grasas: [30, 45] },
            objetivoPrincipal: "Mantener peso, favorecer adherencia social y equilibrio nutricional.",
            observaciones: "Seguir entrenando, ajustar seg√∫n objetivos. Revaluar anal√≠ticas y composici√≥n corporal."
        }
    ],
    // --- Ganancia de Peso (Volumen Muscular) ---
    ganancia: [
        {
            nombre: "Volumen Muscular Inicial",
            duracionRelativa: 2,
            macros: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [20, 30] },
            objetivoPrincipal: "Establecer base cal√≥rica alta, favorecer s√≠ntesis proteica.",
            observaciones: "Priorizar calidad de alimentos. Monitorizar digesti√≥n."
        },
        {
            nombre: "Volumen Muscular Avanzado",
            duracionRelativa: 3,
            macros: { proteinas: [25, 35], carbohidratos: [45, 55], grasas: [15, 25] },
            objetivoPrincipal: "Maximizar aporte energ√©tico para entrenos intensos, ganar masa muscular.",
            observaciones: "Ajustar calor√≠as seg√∫n progreso. Timing post-entreno."
        },
        {
            nombre: "Definici√≥n/Recomposici√≥n Corporal",
            duracionRelativa: 1,
            macros: { proteinas: [30, 35], carbohidratos: [20, 30], grasas: [35, 45] },
            objetivoPrincipal: "Reducir ganancia de grasa mientras se mantiene/masa muscular ganada.",
            observaciones: "Control m√°s estricto de HC. Posible inclusi√≥n de ciclos de d√©ficit ligero."
        }
    ],
    // --- Mantenimiento ---
    mantenimiento: [
        {
            nombre: "Estabilizaci√≥n",
            duracionRelativa: 1, // En mantenimiento, el tiempo es m√°s lineal o c√≠clico
            macros: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
            objetivoPrincipal: "Consolidar h√°bitos, equilibrar energ√≠a.",
            observaciones: "Flexible Dieting (80/20). Monitoreo de peso y sensaci√≥n de saciedad."
        }
        // Se podr√≠a a√±adir un ciclo anual aqu√≠ si se desea
    ],
    // --- Mixto/Combinado ---
    mixto: [
        // El mixto puede ser una combinaci√≥n de bloques de las otras fases
        // Por ejemplo: 3 meses de Volumen, 2 meses de Definici√≥n, 1 mes de Mantenimiento
        // Lo definiremos m√°s espec√≠ficamente cuando se genere la tabla, bas√°ndonos en estimatedWeeksManualGlobal
        // y posiblemente en weightChangeGoalManualGlobal para determinar la proporci√≥n.
        {
            nombre: "Fase Variable (Mixta)",
            duracionRelativa: 1, // Placeholder
            macros: { proteinas: [20, 35], carbohidratos: [10, 55], grasas: [15, 45] }, // Rango muy amplio
            objetivoPrincipal: "Alternar entre objetivos de volumen, definici√≥n y mantenimiento.",
            observaciones: "Planificaci√≥n c√≠clica. Ajustar macros y calor√≠as seg√∫n fase del ciclo."
        }
    ]
    // Se pueden a√±adir m√°s objetivos si es necesario
};

/**
 * Calcula la distribuci√≥n de semanas para cada fase bas√°ndose en el tiempo total y la estructura.
 * @param {number} totalWeeks - Las semanas totales estimadas (estimatedWeeksManualGlobal).
 * @param {string} objetivo - El objetivo del usuario ('perdida', 'ganancia', 'mantenimiento', 'mixto').
 * @returns {ArrayObject>} Un array de objetos, cada uno representando una fase con su nombre, semanas asignadas, etc.
 */
function calcularDistribucionSemanas(totalWeeks, objetivo) {
    const estructura = estructuraFasesPorObjetivo[objetivo];
    if (!estructura || totalWeeks <= 0) {
        console.error("Datos insuficientes para calcular distribuci√≥n de semanas.");
        return [];
    }

    // Calcular la suma total de las duraciones relativas
    const sumaDuracionesRelativas = estructura.reduce((suma, fase) => suma + fase.duracionRelativa, 0);

    // Si la suma es 0, evitar divisi√≥n por cero
    if (sumaDuracionesRelativas === 0) {
        console.warn("Suma de duraciones relativas es 0. Asignando tiempo igualitariamente.");
        return estructura.map(fase => ({
            ...fase,
            semanasAsignadas: Math.ceil(totalWeeks / estructura.length)
        }));
    }

    // Calcular semanas para cada fase
    let semanasAsignadasAcumuladas = 0;
    const fasesConSemanas = estructura.map((fase, index) => {
        // Calcular semanas proporcionales
        let semanasParaEstaFase = Math.round((fase.duracionRelativa / sumaDuracionesRelativas) * totalWeeks);

        // Ajuste para el √∫ltimo elemento: asegurar que la suma sea exactamente totalWeeks
        // Esto corrige errores de redondeo.
        if (index === estructura.length - 1) {
            semanasParaEstaFase = totalWeeks - semanasAsignadasAcumuladas;
        }
        semanasAsignadasAcumuladas += semanasParaEstaFase;

        return {
            ...fase,
            semanasAsignadas: semanasParaEstaFase
        };
    });

    return fasesConSemanas;
}
/**
 * Calcula el cambio de peso estimado para una fase dada su duraci√≥n y la diferencia cal√≥rica semanal.
 * @param {number} semanasEnFase - N√∫mero de semanas que dura la fase.
 * @param {number} weeklyCalorieDiff - Diferencia cal√≥rica semanal estimada (puede ser negativa para p√©rdida).
 * @returns {number} El cambio de peso estimado en kg para esa fase.
 */
function calcularCambioPesoPorFase(semanasEnFase, weeklyCalorieDiff) {
    const KCAL_POR_KG_GRASA = 7700;
    // Cambio de peso por semana = (Diferencia semanal en kcal) / (kcal por kg)
    const cambioPorSemanaKg = weeklyCalorieDiff / KCAL_POR_KG_GRASA;
    // Cambio total de peso en la fase = cambio por semana * n√∫mero de semanas
    return cambioPorSemanaKg * semanasEnFase;
}

/**
 * Genera un array con el peso estimado al inicio y al final de cada fase.
 * @param {ArrayObject>} fasesConSemanas - Array de fases con semanas asignadas.
 * @param {number} pesoInicial - Peso inicial del usuario (currentWeightKg).
 * @param {number} weeklyCalorieDiff - Diferencia cal√≥rica semanal (weeklyCalorieDiffManualGlobal).
 * @returns {ArrayObject>} Array de fases con propiedades adicionales: pesoInicioFase, pesoFinFase.
 */
function calcularPesosPorFase(fasesConSemanas, pesoInicial, weeklyCalorieDiff) {
    let pesoActual = pesoInicial;
    return fasesConSemanas.map(fase => {
        const cambioPesoEnFase = calcularCambioPesoPorFase(fase.semanasAsignadas, weeklyCalorieDiff);
        const pesoInicioFase = pesoActual;
        const pesoFinFase = pesoActual + cambioPesoEnFase;
        pesoActual = pesoFinFase; // Actualizar para la siguiente fase

        return {
            ...fase,
            pesoInicioFase: pesoInicioFase,
            pesoFinFase: pesoFinFase
        };
    });
}
function calcularPesosPorFaseGanacia(fases, pesoInicial, cambioTotal) {
    const distribucion = [0.4, 0.3, 0.2, 0.1]; // Mayor ganancia al inicio
    let pesoActual = pesoInicial;
    return fases.map((fase, index) => {
        const cambio = cambioTotal * distribucion[index];
        const pesoFin = pesoActual + cambio;
        const faseData = { ...fase, pesoInicioFase: pesoActual, pesoFinFase: pesoFin };
        pesoActual = pesoFin;
        return faseData;
    });
}
///////////////////////funciones aux modal tabla general fases/////
//////////////////////  FUNCIONES DE UTILIDAD ////////////////////
function mostrarCarga(contenedorId, mensaje = 'Generando detalles...') {
    const contenedor = document.getElementById(contenedorId);
    if (contenedor) {
        contenedor.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h4 class="text-primary">${mensaje}</h4>
                <p class="text-muted mt-2">Esto puede tardar unos segundos...</p>
            </div>
        `;
    }
}
function mostrarError(mensaje, contenedorId = 'detailed-phase-container') {
    const contenedor = document.getElementById(contenedorId);
    if (contenedor) {
        contenedor.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${mensaje}
            </div>
        `;
    }
}

// Cat√°logo de estrategias avanzadas
// Cat√°logo de estrategias avanzadas
const catalogoEstrategias = {
    cetogenicas: [
        {
            id: "tkd",
            title: "Targeted Ketogenic Diet (TKD)",
            description: "Carbohidratos estrat√©gicos solo alrededor del entreno",
            features: [
                "25-50g HC 30-60 min antes/despu√©s del entreno",
                "Mantener cetosis el resto del d√≠a (cetona >0.5 mmol/L)",
                "PROP√ìSITO: Solo v√°lido para RENDIMIENTO (fuerza intermitente)",
                "INCOMPATIBILIDAD: No recomendado para salud general ni est√©tica",
                "VALIDACI√ìN CIENT√çFICA: [JISSN, 2022] - √ìptimo para CrossFit, no para deportes >90% VO2max"
            ],
            aplicable: ["perdida"],
            macros: {
                proteinPct: "20-25% (salud/est√©tica) | 25-30% (rendimiento)",
                fatPct: "65-75% (todas)",
                carbPct: "5-10% + 25-50g HC peri-entreno",
                proteinGr: "1.8-2.2 g/kg/d√≠a (salud) | 2.2-2.6 g/kg/d√≠a (rendimiento)",
                carbinGr: "0.3-0.7 g/kg/d√≠a + 0.4-0.7g/kg peri-entreno",
                fatinGr: "1.5-2.0 g/kg/d√≠a"
            }
        },
        {
            id: "ckd",
            title: "Cyclic Ketogenic Diet (CKD)",
            description: "Ciclo de d√≠as cetosis y d√≠as de recarga",
            features: [
                "5-6 d√≠as cetosis + 1-2 d√≠as carb-loading (3-4g/kg HC)",
                "Refeed completo de gluc√≥geno muscular",
                "PROP√ìSITO: Solo v√°lido para RENDIMIENTO (fuerza pura)",
                "INCOMPATIBILIDAD: No recomendado para salud ni est√©tica",
                "VALIDACI√ìN CIENT√çFICA: [Sports Med, 2021] - Superior en powerlifting vs. dieta est√°ndar"
            ],
            aplicable: ["perdida", "mixto"],
            macros: {
                proteinPct: "20-25% (cetosis) | 15-20% (carb-loading)",
                fatPct: "70-75% (cetosis) | 20-25% (carb-loading)",
                carbPct: "5-10% (cetosis) | 60-65% (carb-loading)",
                proteinGr: "2.0-2.4 g/kg/d√≠a (constante)",
                carbinGr: "0.3-0.6 g/kg/d√≠a (cetosis) | 3.0-4.0 g/kg/d√≠a (carb-loading)",
                fatinGr: "1.8-2.2 g/kg/d√≠a (cetosis) | 0.5-0.8 g/kg/d√≠a (carb-loading)"
            }
        },
        {
            id: "restricted",
            title: "Restricted Ketogenic Diet",
            description: "Cetosis estricta con restricci√≥n cal√≥rica intensa",
            features: [
                "80-85% grasas, d√©ficit severo (25-30% TMB)",
                "Cetosis estricta (cetona >1.5 mmol/L)",
                "PROP√ìSITO: Solo v√°lido para SALUD (casos m√©dicos bajo supervisi√≥n)",
                "INCOMPATIBILIDAD: No recomendado para est√©tica ni rendimiento",
                "VALIDACI√ìN CIENT√çFICA: [Nutrients, 2021] - Solo para NAFLD grave o epilepsia"
            ],
            aplicable: ["perdida"],
            macros: {
                proteinPct: "15-20% (m√°x 1.2g/kg/d√≠a)",
                fatPct: "80-85%",
                carbPct: "3-5% (‚â§20g/d√≠a)",
                proteinGr: "0.8-1.2 g/kg/d√≠a",
                carbinGr: "0.1-0.3 g/kg/d√≠a",
                fatinGr: "2.5-3.0 g/kg/d√≠a"
            }
        },
        {
            id: "modified",
            title: "Modified Ketogenic Diet",
            description: "Cetosis moderada con flexibilidad selectiva",
            features: [
                "60-70% grasas, m√°s prote√≠na (1.8-2.2g/kg/d√≠a)",
                "Cetosis moderada (cetona 0.5-1.5 mmol/L)",
                "PROP√ìSITO: V√°lido para SALUD y EST√âTICA",
                "INCOMPATIBILIDAD: No recomendado para rendimiento de alta intensidad",
                "VALIDACI√ìN CIENT√çFICA: [Front Nutr, 2020] - 60-70% grasas √≥ptimo para sostenibilidad"
            ],
            aplicable: ["perdida", "mantenimiento"],
            macros: {
                proteinPct: "20-25% (fase inicial) | 25-30% (fase avanzada)",
                fatPct: "60-70%",
                carbPct: "5-10% (50-80g/d√≠a)",
                proteinGr: "1.8-2.2 g/kg/d√≠a (salud) | 2.2-2.6 g/kg/d√≠a (est√©tica)",
                carbinGr: "0.7-1.1 g/kg/d√≠a",
                fatinGr: "1.3-1.8 g/kg/d√≠a"
            }
        }
    ],
    ciclado: [
        {
            id: "carb-cycling",
            title: "Carb Cycling",
            description: "Variaci√≥n de carbohidratos seg√∫n entrenamiento",
            features: [
                "D√≠as altos/bajos HC seg√∫n entrenamiento",
                "Entreno: alto HC, descanso: bajo HC",
                "PROP√ìSITO: V√°lido para todos los prop√≥sitos",
                "HIGH CARB: 65-75% HC en d√≠as de alta carga (>90' entrenamiento)",
                "EST√ÅNDAR: 50-60% HC en mantenimiento salud",
                "VALIDACI√ìN CIENT√çFICA: [Obesity Rev, 2022] - √ìptimo para prevenir adaptaci√≥n metab√≥lica"
            ],
            aplicable: ["perdida", "ganancia", "mixto"],
            macros: {
                proteinPct: "20-25% (salud) | 25-30% (est√©tica/rendimiento)",
                fatPct: "40-55% (d√≠as descanso) | 25-35% (d√≠as entrenamiento)",
                carbPct: "Salud: 3-4g/kg (entreno) | Est√©tica: 5-7g/kg (entreno) | Rendimiento: 4-8g/kg (entreno)",
                proteinGr: "1.6-2.0 g/kg/d√≠a (salud) | 2.0-2.4 g/kg/d√≠a (est√©tica/rendimiento)",
                carbinGr: "Salud: 3-4g/kg (entreno) | Est√©tica: 5-7g/kg (entreno) | Rendimiento: 4-8g/kg (entreno)",
                fatinGr: "Salud: 0.8-1.2g/kg (entreno) | Est√©tica: 0.6-0.9g/kg (entreno)"
            }
        },
        {
            id: "high-carb-resistance",
            title: "High Carb Resistencia",
            description: "Enfoque espec√≠fico para deportes de resistencia prolongada",
            features: [
                "65-75% HC en d√≠as de alta carga (>90' entrenamiento)",
                "5-6g/kg HC para optimizar gluc√≥geno muscular",
                "PROP√ìSITO: Solo v√°lido para RENDIMIENTO (deportes de resistencia)",
                "INCOMPATIBILIDAD: Contraindicado en salud general y est√©tica",
                "VALIDACI√ìN CIENT√çFICA: [ISSN Pos Stand, 2018] - 6-10g/kg HC √≥ptimo para marat√≥n/ciclismo"
            ],
            aplicable: ["ganancia", "mixto"],
            macros: {
                proteinPct: "15-20%",
                fatPct: "15-20%",
                carbPct: "D√≠as alta carga: 65-75% | D√≠as descanso: 30-40%",
                proteinGr: "1.6-2.0 g/kg/d√≠a",
                carbinGr: "D√≠as alta carga: 5.0-6.0 g/kg/d√≠a | D√≠as descanso: 2.0-2.5 g/kg/d√≠a",
                fatinGr: "D√≠as alta carga: 0.4-0.5 g/kg/d√≠a | D√≠as descanso: 0.6-0.8 g/kg/d√≠a"
            }
        },
        {
            id: "protein-cycling",
            title: "Protein Cycling",
            description: "Variaci√≥n de prote√≠na en ciclos",
            features: [
                "4 semanas alta prote√≠na + 1 semana moderada",
                "Prevenci√≥n de adaptaci√≥n metab√≥lica renal",
                "PROP√ìSITO: Solo v√°lido para EST√âTICA y RENDIMIENTO (>12 semanas)",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales (<12 semanas)",
                "VALIDACI√ìN CIENT√çFICA: [Obesity Rev, 2023] - 4 semanas alta + 1 semana moderada √≥ptimo"
            ],
            aplicable: ["perdida", "ganancia", "mixto"],
            macros: {
                proteinPct: "25-30% (semanas alta) | 18-22% (semana moderada)",
                fatPct: "25-30% (semanas alta) | 35-40% (semana moderada)",
                carbPct: "40-45% (semanas alta) | 45-50% (semana moderada)",
                proteinGr: "2.2-2.6 g/kg/d√≠a (semanas alta) | 1.6-1.8 g/kg/d√≠a (semana moderada)",
                carbinGr: "1.8-2.2 g/kg/d√≠a (semanas alta) | 2.2-2.5 g/kg/d√≠a (semana moderada)",
                fatinGr: "0.7-0.9 g/kg/d√≠a (semanas alta) | 0.9-1.1 g/kg/d√≠a (semana moderada)"
            }
        },
        {
            id: "calorie-cycling",
            title: "Calorie Cycling",
            description: "Ciclo de d√©ficit y super√°vit cal√≥rico",
            features: [
                "3 d√≠as d√©ficit + 2 d√≠as super√°vit (mantenimiento o +100-200kcal)",
                "Mantiene TMB y adherencia",
                "PROP√ìSITO: V√°lido para todos los prop√≥sitos",
                "EST√ÅNDAR: 50-60% HC en mantenimiento salud",
                "VALIDACI√ìN CIENT√çFICA: [AJCN, 2020] - MATADOR Study: 3d d√©ficit + 2d super√°vit superior a d√©ficit continuo"
            ],
            aplicable: ["perdida", "mixto", "mantenimiento"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "30-40% (d√©ficit) | 25-35% (super√°vit)",
                carbPct: "30-40% (d√©ficit) | 45-55% (super√°vit)",
                proteinGr: "1.8-2.4 g/kg/d√≠a (constante)",
                carbinGr: "1.2-1.8 g/kg/d√≠a (d√©ficit) | 2.2-2.8 g/kg/d√≠a (super√°vit)",
                fatinGr: "0.7-1.0 g/kg/d√≠a (d√©ficit) | 0.6-0.8 g/kg/d√≠a (super√°vit)"
            }
        },
        {
            id: "metabolic-flexibility",
            title: "Metabolic Flexibility Training",
            description: "Rotaci√≥n de macronutrientes para mejorar flexibilidad metab√≥lica",
            features: [
                "Semanal: cetosis ‚Üí moderate carb ‚Üí high carb",
                "Mejora flexibilidad metab√≥lica y previene plateaus",
                "PROP√ìSITO: Solo v√°lido para fases avanzadas (>24 semanas)",
                "HIGH CARB: 65-75% HC en fase 'high carb' para deportes de resistencia",
                "EST√ÅNDAR: 50-60% HC en fase 'moderate' para salud",
                "VALIDACI√ìN CIENT√çFICA: [Obesity Rev, 2023] - Rotaci√≥n semanal esencial tras 24 semanas"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "65-70% (cetosis) | 35-40% (moderate) | 25-30% (high carb)",
                carbPct: "5-10% (cetosis) | 30-40% (moderate) | 50-60% (high carb)",
                proteinGr: "1.8-2.2 g/kg/d√≠a (constante)",
                carbinGr: "0.3-0.6 g/kg/d√≠a (cetosis) | 1.5-2.0 g/kg/d√≠a (moderate) | 3.5-4.5 g/kg/d√≠a (high carb)",
                fatinGr: "1.8-2.2 g/kg/d√≠a (cetosis) | 0.9-1.2 g/kg/d√≠a (moderate) | 0.6-0.8 g/kg/d√≠a (high carb)"
            }
        }
    ],
    timing: [
        {
            id: "refeed",
            title: "Refeed Strategy",
            description: "D√≠as estrat√©gicos de alta ingesta cal√≥rica",
            features: [
                "Mensuales o seg√∫n avance (1-2 d√≠as)",
                "Optimiza leptina y T3 post-d√©ficit",
                "PROP√ìSITO: Solo v√°lido para EST√âTICA y MIXTO (post-corte)",
                "INCOMPATIBILIDAD: No recomendado durante ganancia activa",
                "VALIDACI√ìN CIENT√çFICA: [Obesity Rev, 2022] - 4-5g/kg HC √≥ptimo para normalizar hormonas"
            ],
            aplicable: ["perdida", "mixto"],
            macros: {
                proteinPct: "15-20% (d√≠a refeed)",
                fatPct: "15-20% (d√≠a refeed)",
                carbPct: "60-70% (4-5g/kg HC)",
                proteinGr: "1.6-1.8 g/kg/d√≠a (d√≠a refeed)",
                carbinGr: "4.0-5.0 g/kg/d√≠a (d√≠a refeed)",
                fatinGr: "0.4-0.6 g/kg/d√≠a (d√≠a refeed)"
            }
        },
        {
            id: "flexible-dieting",
            title: "Flexible Dieting (80/20 rule)",
            description: "80% alimentos nutrientes + 20% flexibilidad",
            features: [
                "Aumenta adherencia en 65%",
                "Mantiene composici√≥n corporal",
                "PROP√ìSITO: V√°lido para EST√âTICA y MANTENIMIENTO",
                "EST√ÅNDAR: 50-60% HC para mantenimiento salud",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales de p√©rdida/ganancia",
                "VALIDACI√ìN CIENT√çFICA: [Int J Obesity, 2019] - 80/20 rule superior a dietas r√≠gidas"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "25-30% (salud) | 25-35% (est√©tica)",
                fatPct: "25-35% (salud) | 20-25% (est√©tica)",
                carbPct: "35-45% (salud) | 40-50% (est√©tica)",
                proteinGr: "1.6-2.0 g/kg/d√≠a (salud) | 2.0-2.4 g/kg/d√≠a (est√©tica)",
                carbinGr: "1.5-2.0 g/kg/d√≠a (salud) | 2.2-2.8 g/kg/d√≠a (est√©tica)",
                fatinGr: "0.7-1.0 g/kg/d√≠a (salud) | 0.5-0.7 g/kg/d√≠a (est√©tica)"
            }
        },
        {
            id: "dieta-estandar",
            title: "Dieta Est√°ndar/Equilibrada",
            description: "Enfoque alineado con recomendaciones OMS para salud general",
            features: [
                "15-20% prote√≠na | 25-35% grasas | 50-60% HC",
                "Requiere >30g fibra/d√≠a y HC complejos",
                "PROP√ìSITO: Solo v√°lido para SALUD (mantenimiento)",
                "INCOMPATIBILIDAD: No recomendado para est√©tica ni rendimiento",
                "VALIDACI√ìN CIENT√çFICA: [Dietary Guidelines, 2020-2025] - Reduce riesgo CV en 25%"
            ],
            aplicable: ["mantenimiento"],
            macros: {
                proteinPct: "15-20%",
                fatPct: "25-35%",
                carbPct: "50-60%",
                proteinGr: "1.2-1.6 g/kg/d√≠a",
                carbinGr: "2.5-3.0 g/kg/d√≠a",
                fatinGr: "0.7-1.0 g/kg/d√≠a"
            }
        },
        {
            id: "intermittent-fasting",
            title: "Intermittent Fasting + Cycling",
            description: "Ayuno intermitente combinado con ciclado metab√≥lico",
            features: [
                "5 d√≠as IF 16:8 + 2 d√≠as alimentaci√≥n normal",
                "Potencia cetosis y autofagia",
                "PROP√ìSITO: Solo v√°lido para SALUD (fases medias >12 semanas)",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales ni para rendimiento",
                "VALIDACI√ìN CIENT√çFICA: [Obesity Rev, 2022] - Solo efectivo tras 12 semanas de estabilidad"
            ],
            aplicable: ["perdida", "mantenimiento"],
            macros: {
                proteinPct: "25-30% (ventana alimentaci√≥n)",
                fatPct: "40-50% (ventana alimentaci√≥n)",
                carbPct: "20-30% (ventana alimentaci√≥n)",
                proteinGr: "2.0-2.5 g/kg/d√≠a (ventana alimentaci√≥n)",
                carbinGr: "0.9-1.3 g/kg/d√≠a (ventana alimentaci√≥n)",
                fatinGr: "1.1-1.5 g/kg/d√≠a (ventana alimentaci√≥n)"
            }
        },
        {
            id: "meal-timing",
            title: "Meal Timing Optimization",
            description: "Optimizaci√≥n del timing de comidas",
            features: [
                "Ventana de alimentaci√≥n ajustada",
                "Pre/post-entreno espec√≠fico",
                "PROP√ìSITO: V√°lido para todos los prop√≥sitos",
                "EST√ÅNDAR: 50-60% HC en distribuci√≥n equilibrada",
                "VALIDACI√ìN CIENT√çFICA: [ISSN Pos Stand, 2018] - 0.8g/kg HC + 0.4g/kg prote√≠na post-entreno √≥ptimo"
            ],
            aplicable: ["perdida", "ganancia", "mixto"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "25-35% (constante)",
                carbPct: "35-45% (constante)",
                proteinGr: "1.8-2.4 g/kg/d√≠a (distribuido en 4-5 comidas)",
                carbinGr: "Salud: 1.5-2.0 g/kg/d√≠a | Rendimiento: 3.0-5.0 g/kg/d√≠a (d√≠as entrenamiento)",
                fatinGr: "0.6-0.9 g/kg/d√≠a"
            }
        },
        {
            id: "neat-optimization",
            title: "NEAT Optimization",
            description: "Aumentar actividad no planeada para compensar adaptaci√≥n metab√≥lica",
            features: [
                "+5,000 pasos/d√≠a",
                "Actividades espont√°neas (subir escaleras, caminar)",
                "PROP√ìSITO: Solo v√°lido para SALUD y P√âRDIDA",
                "INCOMPATIBILIDAD: No recomendado en fases de ganancia activa",
                "VALIDACI√ìN CIENT√çFICA: [Br J Sports Med, 2022] - Compensa 15-20% gasto energ√©tico post-p√©rdida"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "25-30% (salud) | 30-35% (est√©tica)",
                fatPct: "30-35% (salud) | 25-30% (est√©tica)",
                carbPct: "35-40% (salud) | 40-45% (est√©tica)",
                proteinGr: "1.6-2.0 g/kg/d√≠a (salud) | 2.0-2.4 g/kg/d√≠a (est√©tica)",
                carbinGr: "1.5-1.8 g/kg/d√≠a (salud) | 2.0-2.4 g/kg/d√≠a (est√©tica)",
                fatinGr: "0.8-1.0 g/kg/d√≠a (salud) | 0.6-0.8 g/kg/d√≠a (est√©tica)"
            }
        },
        {
            id: "hydration-strategy",
            title: "Hydration Strategy",
            description: "Hidrataci√≥n estrat√©gica para evitar fluctuaciones",
            features: [
                "1.5-2L agua/d√≠a",
                "500-700mg sodio/d√≠a en entrenamientos",
                "PROP√ìSITO: Solo v√°lido para RENDIMIENTO",
                "INCOMPATIBILIDAD: No recomendado para salud general sin supervisi√≥n",
                "VALIDACI√ìN CIENT√çFICA: [Br J Sports Med, 2023] - 500-700mg sodio previene retenci√≥n h√≠drica"
            ],
            aplicable: ["perdida", "mantenimiento", "mixto"],
            macros: {
                proteinPct: "20-25% (rendimiento fuerza) | 15-20% (rendimiento resistencia)",
                fatPct: "20-25% (rendimiento fuerza) | 25-30% (rendimiento resistencia)",
                carbPct: "55-60% (rendimiento fuerza) | 60-65% (rendimiento resistencia)",
                proteinGr: "1.8-2.2 g/kg/d√≠a (fuerza) | 1.6-2.0 g/kg/d√≠a (resistencia)",
                carbinGr: "4.5-5.5 g/kg/d√≠a (fuerza) | 6.0-7.0 g/kg/d√≠a (resistencia)",
                fatinGr: "0.5-0.7 g/kg/d√≠a (fuerza) | 0.7-0.9 g/kg/d√≠a (resistencia)"
            }
        },
        {
            id: "targeted-carb-timing",
            title: "Targeted Carb Timing",
            description: "HC estrat√©gicos para mantener rendimiento en d√©ficit",
            features: [
                "25-50g HC 30 min pre-entreno",
                "0.8g/kg HC post-entreno",
                "PROP√ìSITO: Solo v√°lido para RENDIMIENTO",
                "INCOMPATIBILIDAD: No recomendado para salud general ni est√©tica",
                "VALIDACI√ìN CIENT√çFICA: [ISSN Pos Stand, 2018] - 0.8g/kg HC post-entreno mantiene rendimiento en d√©ficit"
            ],
            aplicable: ["ganancia", "mixto"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "20-25% (constante)",
                carbPct: "45-55% (d√≠as entrenamiento) | 30-40% (d√≠as descanso)",
                proteinGr: "2.0-2.4 g/kg/d√≠a (constante)",
                carbinGr: "3.0-4.0 g/kg/d√≠a (d√≠as entrenamiento) | 1.5-2.0 g/kg/d√≠a (d√≠as descanso)",
                fatinGr: "0.5-0.7 g/kg/d√≠a (d√≠as entrenamiento) | 0.7-0.9 g/kg/d√≠a (d√≠as descanso)"
            }
        },

        {
            id: "protein-pacing",
            title: "Protein Pacing",
            description: "Distribuci√≥n √≥ptima de prote√≠na a lo largo del d√≠a",
            features: [
                "0.4-0.5g/kg prote√≠na cada 3-4 horas",
                "Maximiza la s√≠ntesis proteica muscular",
                "PROP√ìSITO: V√°lido para EST√âTICA y RENDIMIENTO",
                "INCOMPATIBILIDAD: No recomendado en fases iniciales (<8 semanas) para salud",
                "VALIDACI√ìN CIENT√çFICA: [JISSN, 2022] - Distribuci√≥n √≥ptima: 4-5 comidas con 0.4-0.5g/kg"
            ],
            aplicable: ["perdida", "ganancia", "mixto", "mantenimiento"],
            macros: {
                proteinPct: "25-30% (constante)",
                fatPct: "25-35% (constante)",
                carbPct: "35-45% (constante)",
                proteinGr: "Distribuci√≥n: 0.4-0.5g/kg cada 3-4h",
                carbinGr: "1.8-2.4 g/kg/d√≠a (distribuido en 4-5 comidas)",
                fatinGr: "0.7-0.9 g/kg/d√≠a (distribuido en 4-5 comidas)"
            }
        },

    ]
};
// Configuraci√≥n de estrategias base por objetivo y fase (ESTRUCTURA EXACTA)
const estrategiasBaseConfig = {
    perdida: {
        "Fase 1 (0-12 sem)": [
            {
                id: "mkd-inicial",
                title: "Modified Ketogenic Diet",
                description: "Modified Ketogenic Diet para inicio seguro",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "60-70%",
                        carbPct: "5-10%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "0.7-1.1 g/kg/d√≠a",
                        fatinGr: "1.3-1.8 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "50-65%",
                        carbPct: "5-8%",
                        proteinGr: "2.0-2.4 g/kg/d√≠a",
                        carbinGr: "0.5-0.8 g/kg/d√≠a",
                        fatinGr: "1.1-1.5 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "25-30%",
                        fatPct: "40-50%",
                        carbPct: "10-15%",
                        proteinGr: "2.0-2.4 g/kg/d√≠a",
                        carbinGr: "1.0-1.5 g/kg/d√≠a",
                        fatinGr: "0.9-1.2 g/kg/d√≠a"
                    }
                },
                details: "Esta fase establece una cetosis metab√≥lica moderada (no estricta) para reducir la resistencia a la insulina y comenzar la quema de grasa corporal, priorizando la preservaci√≥n muscular mediante una ingesta proteica adecuada. Es ideal para la primera fase de p√©rdida de grasa, especialmente en personas con mayor porcentaje de grasa corporal (>25% en hombres, >32% en mujeres). A diferencia de la Restricted Ketogenic Diet (RKD), esta estrategia evita el d√©ficit cal√≥rico severo y mantiene una ingesta proteica suficiente para minimizar la p√©rdida muscular. Basado en evidencia de Frontiers in Nutrition (2020), es m√°s sostenible y segura para la mayor√≠a de las personas que inician un proceso de p√©rdida de peso con prop√≥sito de salud."
            },
            {
                id: "hiperproteica",
                title: "Fase de Ciclado Metab√≥lico inicial",
                description: "Ciclado metab√≥lico inicial con enfoque hiperproteico",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "50-65%",
                        carbPct: "10-15%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "1.0-1.5 g/kg/d√≠a",
                        fatinGr: "1.1-1.5 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "50-65%",
                            carbPct: "5-8%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "0.5-0.8 g/kg",
                            fatinGr: "1.1-1.5 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "50-65%",
                            carbPct: "15-20%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "1.3-1.8 g/kg",
                            fatinGr: "0.9-1.2 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "40-50%",
                            carbPct: "10-15%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "1.0-1.5 g/kg",
                            fatinGr: "0.9-1.2 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "40-50%",
                            carbPct: "25-35%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.2-2.8 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        }
                    }
                },
                details: "Esta fase combina d√≠as de bajo y alto consumo de carbohidratos seg√∫n el entrenamiento para mantener la masa muscular durante la p√©rdida de grasa, con un enfoque proteico elevado. Es ideal para atletas o personas con menor porcentaje de grasa corporal que necesitan preservar m√∫sculo mientras reducen grasa. Los d√≠as de entrenamiento incluyen un rango controlado de carbohidratos (15-20% de calor√≠as) para optimizar el rendimiento y la recuperaci√≥n, mientras que los d√≠as de descanso mantienen un nivel bajo (5-8%) para potenciar la oxidaci√≥n de grasas. Basado en Journal of the International Society of Sports Nutrition (2021), este enfoque es superior a dietas cetog√©nicas estrictas para la preservaci√≥n muscular en individuos con prop√≥sitos est√©ticos."
            },


            {
                id: "low-carb-general",
                title: "Dieta Low Carb General",
                description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
                aplicable: ["perdida", "mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "45-55%",
                        carbPct: "20-30%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "1.5-2.0 g/kg/d√≠a",
                        fatinGr: "1.0-1.2 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "50-60%",
                        carbPct: "10-20%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "1.0-1.5 g/kg/d√≠a",
                        fatinGr: "1.0-1.3 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "40-50%",
                        carbPct: "30-40%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    }
                },
                details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/d√≠a) que se adapta a diversos objetivos. En p√©rdida de peso, induce un d√©ficit cal√≥rico con mayor quema de grasa y control gluc√©mico. En mantenimiento, promueve la estabilidad metab√≥lica y previene la recuperaci√≥n de peso. Para ganancia muscular, requiere ciclado de carbohidratos y super√°vit controlado para optimizar el gluc√≥geno muscular. En recomposici√≥n corporal, combina alta prote√≠na con entrenamiento de resistencia para perder grasa y ganar m√∫sculo simult√°neamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad f√≠sica regular cuando se ajustan los macros seg√∫n el prop√≥sito."
            }
        ],
        "Fase 2 (12-24 sem)": [
            {
                id: "cicladoMetabolico",
                title: "Fase de Ciclado Metab√≥lico",
                description: "Ciclado metab√≥lico avanzado",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "45-55%",
                        carbPct: "20-25%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "1.5-1.8 g/kg/d√≠a",
                        fatinGr: "1.0-1.3 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "40-50%",
                            carbPct: "10-20%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "1.0-1.8 g/kg",
                            fatinGr: "0.9-1.2 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "40-50%",
                            carbPct: "30-40%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.2-2.8 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "35-45%",
                            carbPct: "15-25%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "1.5-2.0 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "35-45%",
                            carbPct: "40-50%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "3.0-4.0 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    }
                },
                details: "Esta fase implementa un ciclado avanzado de carbohidratos para optimizar el rendimiento y la recuperaci√≥n mientras se mantiene la p√©rdida de grasa. Los d√≠as de entrenamiento incluyen un rango m√°s elevado de carbohidratos (30-40% de calor√≠as) para maximizar el rendimiento y la s√≠ntesis proteica, mientras que los d√≠as de descanso mantienen un nivel moderado-bajo (10-20%) para continuar con la oxidaci√≥n de grasas. La prote√≠na se mantiene alta (2.0-2.4 g/kg/d√≠a) para preservar la masa muscular, especialmente cr√≠tica en fases medias de p√©rdida de peso donde el riesgo de p√©rdida muscular aumenta. Basado en Obesity Reviews (2022), este enfoque previene la adaptaci√≥n metab√≥lica que ocurre tras 12 semanas de d√©ficit continuo, manteniendo la tasa metab√≥lica basal (TMB) y mejorando la adherencia al plan nutricional."
            },
            {
                id: "low-carb-general2",
                title: "Dieta Low Carb Ciclada",
                description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
                aplicable: ["perdida", "mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "45-55%",
                        carbPct: "20-30%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "1.5-2.0 g/kg/d√≠a",
                        fatinGr: "1.0-1.2 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "50-60%",
                        carbPct: "10-20%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "1.0-1.5 g/kg/d√≠a",
                        fatinGr: "1.0-1.3 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "40-50%",
                        carbPct: "30-40%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    }
                },
                details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/d√≠a) que se adapta a diversos objetivos. En p√©rdida de peso, induce un d√©ficit cal√≥rico con mayor quema de grasa y control gluc√©mico. En mantenimiento, promueve la estabilidad metab√≥lica y previene la recuperaci√≥n de peso. Para ganancia muscular, requiere ciclado de carbohidratos y super√°vit controlado para optimizar el gluc√≥geno muscular. En recomposici√≥n corporal, combina alta prote√≠na con entrenamiento de resistencia para perder grasa y ganar m√∫sculo simult√°neamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad f√≠sica regular cuando se ajustan los macros seg√∫n el prop√≥sito."
            }
        ],
        "Fase 3 Avanzada (>24 sem)": [
            {
                id: "metabolic-flex",
                title: "Fase de Ajuste Metab√≥lico",
                description: "Metabolic Flexibility Training para superar plateaus",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "35-45%",
                        carbPct: "30-40%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.0-2.5 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        semanaLow: {
                            proteinPct: "25-30%",
                            fatPct: "35-60%",
                            carbPct: "5-10%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "0.5-1.0 g/kg/d√≠a",
                            fatinGr: "1.3-1.7 g/kg/d√≠a"
                        },
                        semanaModerate: {
                            proteinPct: "25-30%",
                            fatPct: "35-45%",
                            carbPct: "30-40%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "0.9-1.2 g/kg/d√≠a"
                        },
                        semanaHigh: {
                            proteinPct: "25-30%",
                            fatPct: "35-45%",
                            carbPct: "50-60%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "3.5-4.5 g/kg/d√≠a",
                            fatinGr: "0.6-0.8 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        semanaLow: {
                            proteinPct: "25-30%",
                            fatPct: "45-60%",
                            carbPct: "10-15%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "1.0-1.5 g/kg/d√≠a",
                            fatinGr: "1.3-1.8 g/kg/d√≠a"
                        },
                        semanaModerate: {
                            proteinPct: "25-30%",
                            fatPct: "30-40%",
                            carbPct: "35-45%",
                            proteinGr: "2.0-2.2 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        },
                        semanaHigh: {
                            proteinPct: "25-30%",
                            fatPct: "30-40%",
                            carbPct: "55-65%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "4.5-5.5 g/kg/d√≠a",
                            fatinGr: "0.5-0.7 g/kg/d√≠a"
                        }
                    }
                },
                details: "Esta fase avanzada implementa una rotaci√≥n semanal de macronutrientes para superar plateaus metab√≥licos tras 24 semanas de d√©ficit continuo. La rotaci√≥n semanal (cetosis ‚Üí moderate carb ‚Üí high carb) mejora la flexibilidad metab√≥lica, permitiendo al cuerpo adaptarse a diferentes fuentes de energ√≠a y previniendo la adaptaci√≥n que ralentiza la p√©rdida de peso. Los d√≠as de high carb (40-50% de calor√≠as en HC) ayudan a normalizar hormonas como la leptina y la T3, que tienden a disminuir en d√©ficit prolongado. Basado en Obesity Reviews (2023), esta estrategia es cr√≠tica para evitar el 'efecto yoy√≥' y mantener la adherencia a largo plazo, especialmente en individuos que han estado en d√©ficit cal√≥rico durante m√°s de 6 meses."
            },
            {
                id: "equilibrada",
                title: "Fase de Transici√≥n a Mantenimiento",
                description: "Dieta equilibrada para estabilizaci√≥n metab√≥lica",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "1.8-2.2 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.2-2.6 g/kg/d√≠a",
                        fatinGr: "0.6-0.8 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "25-30%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "2.8-3.5 g/kg/d√≠a",
                        fatinGr: "0.5-0.7 g/kg/d√≠a"
                    }
                },
                details: "Esta fase prepara la transici√≥n hacia el mantenimiento sostenible mediante un equilibrio adecuado de macronutrientes. El aumento controlado de carbohidratos (40-45% de calor√≠as) ayuda a estabilizar las hormonas metab√≥licas (leptina, grelina, T3) que se ven afectadas durante el d√©ficit cal√≥rico prolongado. La prote√≠na se reduce ligeramente (1.6-2.0 g/kg/d√≠a) pero se mantiene por encima de niveles est√°ndar para preservar la masa muscular ganada. Basado en American Journal of Clinical Nutrition (2020), este enfoque gradual previene la recuperaci√≥n r√°pida de peso (efecto rebote) y permite una adaptaci√≥n metab√≥lica m√°s suave, siendo esencial para la sostenibilidad a largo plazo del peso perdido."
            }
        ],
        "Fase 4 Ajuste Metab√≥lico (>32 sem)": [
            {
                id: "metabolic-adaptation-protocol",
                title: "Protocolo de Adaptaci√≥n Metabolica",
                description: "Protocolo especializado para superar plateaus metab√≥licos avanzados",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "35-45%",
                        carbPct: "25-35%",
                        proteinGr: "2.0-2.4 g/kg/d√≠a",
                        carbinGr: "1.8-2.2 g/kg/d√≠a",
                        fatinGr: "0.9-1.1 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "30-35%",
                            fatPct: "45-55%",
                            carbPct: "10-15%",
                            proteinGr: "2.2-2.6 g/kg/d√≠a",
                            carbinGr: "0.8-1.2 g/kg/d√≠a",
                            fatinGr: "1.2-1.5 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "30-35%",
                            fatPct: "30-40%",
                            carbPct: "30-40%",
                            proteinGr: "2.2-2.6 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "40-50%",
                            carbPct: "20-30%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "1.5-2.0 g/kg/d√≠a",
                            fatinGr: "1.0-1.3 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "40-50%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "3.0-3.8 g/kg/d√≠a",
                            fatinGr: "0.7-0.9 g/kg/d√≠a"
                        }
                    }
                },
                details: "Protocolo especializado para individuos que han alcanzado un plateau metab√≥lico despu√©s de 32 semanas de d√©ficit cal√≥rico. Implementa una rotaci√≥n estrat√©gica de macros y calor√≠as para reactivar la respuesta metab√≥lica y hormonal. Incluye periodos de recarga metab√≥lica (3-5 d√≠as con aumento cal√≥rico del 15-20%) seguidos de periodos de d√©ficit controlado. Basado en Obesity Reviews (2023), este enfoque es cr√≠tico para superar la adaptaci√≥n metab√≥lica avanzada y continuar con la p√©rdida de grasa en individuos con alta resistencia a la p√©rdida de peso."
            },
            {
                id: "transicion-mantenimiento-avanzada",
                title: "Fase de Transici√≥n a Mantenimiento",
                description: "Transici√≥n avanzada hacia el mantenimiento con ajuste metab√≥lico",
                aplicable: ["perdida"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "2.0-2.5 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "2.0-2.4 g/kg/d√≠a",
                        carbinGr: "2.2-2.8 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "3.0-3.8 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    }
                },
                details: "Fase avanzada de transici√≥n que prepara el metabolismo para el mantenimiento a largo plazo despu√©s de un per√≠odo prolongado de p√©rdida de peso. Implementa un aumento gradual de calor√≠as (100-150 kcal/semana) hasta alcanzar el mantenimiento, con especial atenci√≥n al balance de macronutrientes para optimizar la leptina y hormonas tiroideas. Incluye monitorizaci√≥n de adaptaciones metab√≥licas y ajustes basados en biofeedback. Basado en American Journal of Clinical Nutrition (2020), este enfoque reduce el riesgo de recuperaci√≥n de peso en un 60% comparado con transiciones abruptas, especialmente en personas que han perdido m√°s del 15% de su peso corporal."
            }
        ]
    },
    ganancia: {
        "Fase 1 (0-8 sem)": [
            {
                id: "lean-bulk",
                title: "Fase Lean Bulk Controlado",
                description: "Super√°vit cal√≥rico moderado para ganancia muscular",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.2-2.8 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.6-0.8 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-65%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "3.5-4.5 g/kg/d√≠a",
                        fatinGr: "0.5-0.7 g/kg/d√≠a"
                    }
                },
                details: "Esta fase establece un super√°vit cal√≥rico moderado (300-500 kcal por encima del mantenimiento) para construir masa muscular sin ganancia excesiva de grasa. La ingesta proteica (1.8-2.2 g/kg/d√≠a) est√° optimizada para maximizar la s√≠ntesis proteica sin sobrecargar el sistema renal, mientras que los carbohidratos (45-55% de calor√≠as) proporcionan energ√≠a para los entrenamientos y ayudan a reponer el gluc√≥geno muscular. Las grasas se mantienen en un rango saludable (25-30%) para apoyar la producci√≥n hormonal. Basado en Journal of the International Society of Sports Nutrition (2019), este enfoque de 'Lean Bulk' es superior al 'Dirty Bulk' tradicional, ya que limita la ganancia de grasa corporal a menos del 30% de la ganancia total de peso, comparado con hasta el 50% en enfoques no controlados."
            },
            {
                id: "cicladoMetabolico2",
                title: "Fase de Ciclado Metab√≥lico Ganancia",
                description: "Ciclado para optimizar ganancia muscular",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.0-2.4 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.6-3.0 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.2-2.6 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "50-55%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.8-3.2 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.6-0.7 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "60-65%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "4.0-5.0 g/kg",
                            fatinGr: "0.5-0.6 g/kg"
                        }
                    }
                },
                details: "Esta fase implementa un ciclado metab√≥lico para maximizar la ganancia muscular mientras se controla la acumulaci√≥n de grasa. Los d√≠as de entrenamiento intenso incluyen un mayor porcentaje de carbohidratos (50-55% de calor√≠as) para maximizar el rendimiento y la recuperaci√≥n, mientras que los d√≠as de menor intensidad o descanso reducen ligeramente los HC (40-45%) para mantener la sensibilidad a la insulina. La prote√≠na se mantiene alta (2.0-2.4 g/kg/d√≠a) para optimizar la s√≠ntesis proteica, especialmente en el contexto de un super√°vit cal√≥rico moderado. Basado en Sports Medicine (2021), este enfoque es particularmente efectivo para atletas y personas con prop√≥sitos est√©ticos, ya que permite una ganancia muscular m√°s neta con menor ganancia de grasa comparado con enfoques de super√°vit constante."
            }
        ],
        "Fase 2 (8-20 sem)": [
            {
                id: "hiperproteica2",
                title: "Fase de Volumen Hiperproteico",
                description: "Super√°vit controlado con √©nfasis en prote√≠na",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-65%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "3.0-3.8 g/kg/d√≠a",
                        fatinGr: "0.5-0.7 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "20-25%",
                        carbPct: "45-55%",
                        proteinGr: "2.0-2.4 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.5-0.7 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "15-20%",
                        carbPct: "60-65%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "4.0-5.0 g/kg/d√≠a",
                        fatinGr: "0.4-0.5 g/kg/d√≠a"
                    }
                },
                details: "Esta fase principal de volumen mantiene un super√°vit cal√≥rico controlado (300-500 kcal) con un enfoque en prote√≠na para maximizar la hipertrofia muscular mientras se limita la ganancia de grasa. La ingesta proteica elevada (2.0-2.4 g/kg/d√≠a) se distribuye en 4-5 comidas para optimizar la s√≠ntesis proteica a lo largo del d√≠a, aprovechando el 'muscle full signal' que limita los beneficios de m√°s de 40g de prote√≠na por comida. Los carbohidratos (45-55% de calor√≠as) se ajustan seg√∫n la intensidad del entrenamiento, siendo m√°s altos en d√≠as de mayor demanda. Basado en Sports Medicine (2022), este enfoque es especialmente efectivo para individuos con prop√≥sitos est√©ticos, ya que maximiza la relaci√≥n m√∫sculo-grasa durante la fase de volumen, con una ganancia muscular estimada del 70-80% del peso total ganado."
            },
            {
                id: "altaHc",
                title: "Fase de Volumen con alto en HC",
                description: "Super√°vit con enfoque en carbohidratos",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "15-20%",
                        fatPct: "15-20%",
                        carbPct: "65-70%",
                        proteinGr: "1.2-1.6 g/kg/d√≠a",
                        carbinGr: "4.0-5.0 g/kg/d√≠a",
                        fatinGr: "0.4-0.5 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-60%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "3.0-3.5 g/kg/d√≠a",
                        fatinGr: "0.5-0.7 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        diasEntreno: {
                            // Usa fuerza
                            proteinPct: "15-20%",
                            fatPct: "20-25%",
                            carbPct: "55-60%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.5-0.6 g/kg"
                        },
                        diasDescanso: {
                            // Usa resistencia
                            proteinPct: "15-20%",
                            fatPct: "20-25%",
                            carbPct: "60-65%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "4.0-5.0 g/kg",
                            fatinGr: "0.6-0.7 g/kg"
                        }
                    }
                },
                details: "Esta fase est√° dise√±ada espec√≠ficamente para atletas de alto rendimiento, con un enfoque en carbohidratos para maximizar el rendimiento y el crecimiento muscular. Para atletas de fuerza, los HC representan el 55-60% de las calor√≠as, optimizando el gluc√≥geno muscular para sesiones de alta intensidad. Para deportes de resistencia, el rango aumenta al 60-65% para soportar la demanda energ√©tica prolongada. La prote√≠na se mantiene en 1.8-2.2 g/kg/d√≠a, suficiente para la hipertrofia sin desplazar HC necesarios para el rendimiento. Basado en el Position Stand de la International Society of Sports Nutrition (2018), este enfoque es cr√≠tico para atletas competitivos, ya que el gluc√≥geno muscular es el limitante principal en deportes de alta intensidad y la recuperaci√≥n entre sesiones."
            },
            {
                id: "carb-cycling-protein-pacing",
                title: "Carb Cycling / Protein Pacing",
                description: "Combinaci√≥n de ciclado de carbohidratos y distribuci√≥n optimizada de prote√≠na",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "2.0-2.5 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "20-25%",
                            carbPct: "45-50%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "30-35%",
                            fatPct: "30-35%",
                            carbPct: "30-35%",
                            proteinGr: "2.2-2.6 g/kg",
                            carbinGr: "2.0-2.4 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "30-35%",
                            fatPct: "20-25%",
                            carbPct: "40-45%",
                            proteinGr: "2.2-2.6 g/kg",
                            carbinGr: "2.8-3.2 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "2.5-3.0 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "15-20%",
                            carbPct: "50-55%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "4.0-4.8 g/kg",
                            fatinGr: "0.5-0.7 g/kg"
                        }
                    }
                },
                details: "Estrategia combinada que optimiza la ganancia muscular mediante ciclado de carbohidratos seg√∫n la actividad y distribuci√≥n de prote√≠na en 4-6 comidas diarias (protein pacing). Los d√≠as de entrenamiento priorizan carbohidratos para rendimiento y recuperaci√≥n, mientras los d√≠as de descanso moderan los HC para minimizar ganancia de grasa. La prote√≠na se distribuye en dosis de 0.4-0.55 g/kg cada 3-4 horas para maximizar la s√≠ntesis proteica muscular. Basado en Journal of the International Society of Sports Nutrition (2021), este enfoque produce un 25% m√°s de ganancia muscular magra comparado con enfoques tradicionales de super√°vit constante."
            }
        ],
        "Fase 3 (20+ sem)": [
            {
                id: "mantenimiento_reausjuste",
                title: "Fase de Mantenimiento y Reajuste",
                description: "Ciclado para consolidar ganancias",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.0-2.4 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.6-3.0 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "1.8-2.2 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "20-25%",
                            carbPct: "45-50%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "2.3-2.8 g/kg",
                            fatinGr: "0.5-0.7 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "45-50%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "2.5-3.0 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "15-20%",
                            carbPct: "55-60%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "3.0-3.8 g/kg",
                            fatinGr: "0.4-0.6 g/kg"
                        }
                    }
                },
                details: "Esta fase de mantenimiento post-ganancia implementa ciclado metab√≥lico para consolidar las ganancias musculares y prevenir el exceso de grasa. El super√°vit cal√≥rico se reduce a niveles de mantenimiento, con ligeros ajustes seg√∫n el progreso (¬±100-200 kcal). Los carbohidratos se ajustan seg√∫n la actividad (40-50% de calor√≠as), manteniendo la sensibilidad a la insulina y el rendimiento. La prote√≠na se mantiene elevada (1.8-2.2 g/kg/d√≠a) para proteger la masa muscular ganada. Adem√°s, se incorpora NEAT Optimization (+5,000 pasos/d√≠a) para compensar la adaptaci√≥n metab√≥lica que ocurre tras per√≠odos prolongados de super√°vit. Basado en British Journal of Sports Medicine (2022), este enfoque es esencial para la sostenibilidad a largo plazo de las ganancias musculares, evitando la recuperaci√≥n de grasa que ocurre en muchos enfoques de 'hardgainer' tradicionales."
            }
        ],
        "Fase 4 (>28 sem)": [
            {
                id: "metabolic-flexibility-training-ganancia",
                title: "Metabolic Flexibility Training",
                description: "Entrenamiento de flexibilidad metab√≥lica para optimizar composici√≥n corporal",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-50%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "3.0-3.5 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        semanasBajasHC: {
                            proteinPct: "30-35%",
                            fatPct: "35-40%",
                            carbPct: "25-30%",
                            proteinGr: "2.2-2.6 g/kg/d√≠a",
                            carbinGr: "1.8-2.2 g/kg/d√≠a",
                            fatinGr: "1.0-1.2 g/kg/d√≠a"
                        },
                        semanasAltasHC: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "3.0-3.5 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        semanasBajasHC: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.9-1.1 g/kg/d√≠a"
                        },
                        semanasAltasHC: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "4.0-4.8 g/kg/d√≠a",
                            fatinGr: "0.6-0.8 g/kg/d√≠a"
                        }
                    }
                },
                details: "Fase avanzada de entrenamiento de la flexibilidad metab√≥lica para atletas experimentados. Implementa rotaciones peri√≥dicas (2-3 semanas) entre periodos de moderado y alto contenido de carbohidratos para mejorar la capacidad del organismo de utilizar diferentes sustratos energ√©ticos eficientemente. Mejora la sensibilidad insulinica, la capacidad oxidativa mitocondrial y previene la adaptaci√≥n metab√≥lica que limita las ganancias a largo plazo. Basado en Sports Medicine (2022), este enfoque permite continuar con ganancias musculares de calidad mientras se mantiene un porcentaje de grasa corporal bajo en atletas avanzados."
            },
            {
                id: "lean-bulk-controlado-avanzado",
                title: "Fase Lean Bulk Controlado",
                description: "Enfoque avanzado de super√°vit controlado para ganancia muscular magra",
                aplicable: ["ganancia"],
                macros: {
                    macrosSalud: {
                        proteinPct: "25-30%",
                        fatPct: "25-30%",
                        carbPct: "40-45%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "2.8-3.2 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "30-35%",
                        fatPct: "25-30%",
                        carbPct: "35-40%",
                        proteinGr: "2.2-2.6 g/kg/d√≠a",
                        carbinGr: "2.5-2.8 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "50-55%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "3.8-4.5 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    }
                },
                details: "Versi√≥n avanzada del enfoque Lean Bulk, optimizada para atletas con varios a√±os de experiencia. Utiliza un super√°vit cal√≥rico muy controlado (200-300 kcal) con distribuci√≥n estrat√©gica de nutrientes alrededor de los entrenamientos. Incorpora periodos de mantenimiento cada 8-12 semanas para resetear la sensibilidad metab√≥lica y minimizar la ganancia de grasa. Basado en Journal of the International Society of Sports Nutrition (2022), este enfoque produce una relaci√≥n m√∫sculo:grasa de 4:1 en atletas avanzados, comparado con 2:1 en enfoques tradicionales de volumen."
            }
        ]

    },
    mantenimiento: {
        "Fase 1 (0-6 meses)": [
            {
                id: "equilibrada",
                title: "Fase de Dieta Equilibrada",
                description: "Dieta equilibrada para mantenimiento",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.4-1.8 g/kg/d√≠a",
                        carbinGr: "2.0-2.5 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "1.8-2.2 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.6-0.8 g/kg/d√≠a"
                    }
                },
                details: "Esta fase inicial de mantenimiento establece un equilibrio adecuado de macronutrientes para mantener el peso de forma sostenible sin estr√©s metab√≥lico. La prote√≠na se mantiene ligeramente por encima de los niveles est√°ndar (1.6-2.2 g/kg/d√≠a) para preservar la masa muscular, especialmente cr√≠tica tras per√≠odos de p√©rdida o ganancia de peso. Los carbohidratos (35-45% de calor√≠as) provienen principalmente de fuentes complejas y ricas en fibra (>30g/d√≠a), mientras que las grasas saludables (30-35%) apoyan la producci√≥n hormonal. Basado en International Journal of Obesity (2019), este enfoque equilibrado es superior a dietas extremas para el mantenimiento a largo plazo, ya que minimiza las fluctuaciones hormonales que conducen al 'efecto yoy√≥'."
            },
            {
                id: "flexible-dieting",
                title: "Fase de Flexible Dieting",
                description: "80/20 rule para adherencia a largo plazo",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.4-1.8 g/kg/d√≠a",
                        carbinGr: "2.0-2.5 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "30-35%",
                        carbPct: "35-45%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "1.8-2.2 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.6-0.8 g/kg/d√≠a"
                    }
                },
                details: "Esta fase implementa la regla 80/20 (80% alimentos nutrientes + 20% flexibilidad) para aumentar la adherencia al plan nutricional a largo plazo. Los macronutrientes se mantienen en rangos saludables (prote√≠na 25-30%, grasas 30-35%, HC 35-45%), pero con espacio para alimentos preferidos que mejoran la calidad de vida y reducen el estr√©s psicol√≥gico asociado a dietas r√≠gidas. La prote√≠na se mantiene en 1.6-2.0 g/kg/d√≠a, suficiente para preservar la masa muscular en mantenimiento. Basado en International Journal of Obesity (2019), este enfoque aumenta la adherencia en un 65% comparado con dietas estrictas, siendo esencial para el √©xito a largo plazo en el mantenimiento de peso, especialmente en individuos con prop√≥sitos est√©ticos o de salud general."
            },
            {
                id: "low-carb-general",
                title: "Dieta Low Carb Mantenimiento",
                description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
                aplicable: ["perdida", "mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "45-55%",
                        carbPct: "20-30%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "1.5-2.0 g/kg/d√≠a",
                        fatinGr: "1.0-1.2 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "50-60%",
                        carbPct: "10-20%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "1.0-1.5 g/kg/d√≠a",
                        fatinGr: "1.0-1.3 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "40-50%",
                        carbPct: "30-40%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    }
                },
                details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/d√≠a) que se adapta a diversos objetivos. En p√©rdida de peso, induce un d√©ficit cal√≥rico con mayor quema de grasa y control gluc√©mico. En mantenimiento, promueve la estabilidad metab√≥lica y previene la recuperaci√≥n de peso. Para ganancia muscular, requiere ciclado de carbohidratos y super√°vit controlado para optimizar el gluc√≥geno muscular. En recomposici√≥n corporal, combina alta prote√≠na con entrenamiento de resistencia para perder grasa y ganar m√∫sculo simult√°neamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad f√≠sica regular cuando se ajustan los macros seg√∫n el prop√≥sito."
            }
        ],
        "Fase 2 (6+ meses)": [
            {
                id: "calorie-cycling",
                title: "Calorie Cycling Din√°mico",
                description: "Ciclo de mantenimiento y ligero d√©ficit/super√°vit",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            // Usa d√≠as de d√©ficit
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.4-1.8 g/kg",
                            carbinGr: "1.8-2.0 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            // Usa d√≠as de super√°vit
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "45-50%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.2-2.5 g/kg",
                            fatinGr: "0.7-0.8 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            // Usa d√≠as de d√©ficit
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "1.8-2.0 g/kg",
                            fatinGr: "0.8-0.9 g/kg"
                        },
                        diasEntreno: {
                            // Usa d√≠as de super√°vit
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "45-50%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.2-2.5 g/kg",
                            fatinGr: "0.7-0.8 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            // Usa d√≠as de d√©ficit
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.2-2.5 g/kg",
                            fatinGr: "0.7-0.8 g/kg"
                        },
                        diasEntreno: {
                            // Usa d√≠as de super√°vit
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "55-60%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.6-0.7 g/kg"
                        }
                    }
                },
                details: "Esta fase avanzada implementa Calorie Cycling Din√°mico (3 d√≠as mantenimiento + 2 d√≠as ligero d√©ficit/super√°vit de ¬±100 kcal) para prevenir la adaptaci√≥n metab√≥lica que ocurre tras 6 meses de mantenimiento constante. El ligero d√©ficit en algunos d√≠as compensa la reducci√≥n natural de la tasa metab√≥lica basal (TMB) post-p√©rdida de peso (5-8%), mientras que el ligero super√°vit en otros d√≠as mantiene la funci√≥n hormonal y la adherencia psicol√≥gica. Los macronutrientes se mantienen estables en rangos saludables, con especial atenci√≥n a la calidad de los alimentos. Basado en el MATADOR Study Extension (American Journal of Clinical Nutrition, 2020), este enfoque es cr√≠tico para el mantenimiento sostenible, ya que previene el 'efecto rebote' que afecta al 80% de las personas que intentan mantener la p√©rdida de peso con enfoques est√°ticos."
            },
            {
                id: "metabolic-flexibility",
                title: "Fase de Metabolic Flexibility Training",
                description: "Rotaci√≥n avanzada para mantener flexibilidad metab√≥lica",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            // Usa semanasBajasHC
                            proteinPct: "20-25%",
                            fatPct: "25-35%",
                            carbPct: "35-45%",
                            proteinGr: "1.4-1.8 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            // Usa semanasAltasHC
                            proteinPct: "20-25%",
                            fatPct: "25-35%",
                            carbPct: "50-60%",
                            proteinGr: "1.4-1.8 g/kg/d√≠a",
                            carbinGr: "2.8-3.5 g/kg/d√≠a",
                            fatinGr: "0.6-0.8 g/kg/d√≠a"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            // Usa semanasBajasHC
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "35-45%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "1.8-2.2 g/kg/d√≠a",
                            fatinGr: "0.7-0.9 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            // Usa semanasAltasHC
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "50-60%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.6-0.7 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            // Usa semanasBajasHC
                            proteinPct: "20-25%",
                            fatPct: "20-30%",
                            carbPct: "45-55%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.6-0.8 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            // Usa semanasAltasHC
                            proteinPct: "20-25%",
                            fatPct: "20-30%",
                            carbPct: "60-70%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "3.5-4.5 g/kg/d√≠a",
                            fatinGr: "0.5-0.6 g/kg/d√≠a"
                        }
                    }
                },
                details: "Esta fase de mantenimiento avanzado implementa una rotaci√≥n semanal de macronutrientes para mantener la flexibilidad metab√≥lica y prevenir la adaptaci√≥n a largo plazo. La rotaci√≥n (moderate carb ‚Üí high carb) mejora la capacidad del cuerpo para utilizar diferentes fuentes de energ√≠a, manteniendo la sensibilidad a la insulina y la funci√≥n mitocondrial. Los d√≠as de high carb (45-55% de calor√≠as en HC) ayudan a normalizar hormonas como la leptina, que pueden verse afectadas en mantenimiento prolongado. Basado en Obesity Reviews (2021), esta estrategia es esencial para individuos que han mantenido su peso por m√°s de 18 meses, ya que previene la reducci√≥n gradual de la tasa metab√≥lica y mantiene la adherencia al plan nutricional mediante variabilidad controlada."
            }
        ],
        "Fase 3 (18+ meses)": [
            {
                id: "metabolic-flexibility-mantenimiento",
                title: "Fase de Metabolic Flexibility Training",
                description: "Mantenimiento avanzado con enfoque en flexibilidad metab√≥lica",
                aplicable: ["mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "30-35%",
                        carbPct: "40-45%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.9-1.1 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        semanasBajasHC: {
                            proteinPct: "25-30%",
                            fatPct: "35-40%",
                            carbPct: "30-35%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "1.0-1.2 g/kg/d√≠a"
                        },
                        semanasAltasHC: {
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "45-50%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "3.0-3.5 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        semanasBajasHC: {
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "2.8-3.2 g/kg/d√≠a",
                            fatinGr: "0.9-1.1 g/kg/d√≠a"
                        },
                        semanasAltasHC: {
                            proteinPct: "15-20%",
                            fatPct: "20-25%",
                            carbPct: "55-60%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "4.0-4.5 g/kg/d√≠a",
                            fatinGr: "0.7-0.9 g/kg/d√≠a"
                        }
                    }
                },
                details: "Estrategia avanzada de mantenimiento para quienes han sostenido su composici√≥n corporal por m√°s de 18 meses. Implementa variaci√≥n peri√≥dica de macronutrientes (rotaciones cada 2-4 semanas) para mantener la flexibilidad metab√≥lica y prevenir adaptaciones que podr√≠an llevar a gradual aumento de peso. Incluye periodos de moderado d√©ficit y super√°vit cal√≥rico (¬±10-15%) para mantener el set point metab√≥lico. Basado en Obesity Reviews (2021), este enfoque es esencial para el mantenimiento a muy largo plazo, especialmente en personas con predisposici√≥n a recuperar peso, ya que mantiene activas las v√≠as metab√≥licas de regulaci√≥n del peso corporal."
            }
        ]

    },
    mixto: {
        "Fase 1 Volume (0-12 sem)": [
            {
                id: "lean-bulk",
                title: "Fase de Volumen Controlado",
                description: "Super√°vit moderado para construir base muscular",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.6-2.0 g/kg/d√≠a",
                        carbinGr: "2.2-2.8 g/kg/d√≠a",
                        fatinGr: "0.7-0.9 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "20-25%",
                        fatPct: "25-30%",
                        carbPct: "45-55%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.6-0.8 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "20-25%",
                        carbPct: "55-65%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "3.5-4.5 g/kg/d√≠a",
                        fatinGr: "0.5-0.7 g/kg/d√≠a"
                    }
                },
                details: "Esta fase inicial de recomposici√≥n corporal establece un super√°vit cal√≥rico moderado (100-300 kcal) para construir masa muscular antes de la fase de definici√≥n, evitando una ganancia excesiva de grasa. La ingesta proteica (1.8-2.2 g/kg/d√≠a) est√° optimizada para maximizar la s√≠ntesis proteica, mientras que los carbohidratos (45-55% de calor√≠as) proporcionan energ√≠a para los entrenamientos y ayudan a reponer el gluc√≥geno muscular. Las grasas se mantienen en un rango saludable (25-30%) para apoyar la producci√≥n hormonal. Basado en Journal of the International Society of Sports Nutrition (2021), este enfoque es fundamental para la recomposici√≥n corporal exitosa, ya que establece una base muscular que permitir√° una mayor tasa metab√≥lica durante la fase de d√©ficit posterior, mejorando la relaci√≥n m√∫sculo-grasa a largo plazo."
            },
            {
                id: "cicladoMetabolico4",
                title: "Fase de Ciclado Metab√≥lico Ganancia",
                description: "Ciclado para optimizar ganancia muscular",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.0-2.4 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.6-3.0 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "2.2-2.6 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "50-55%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "2.8-3.2 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "50-55%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "3.0-3.5 g/kg",
                            fatinGr: "0.6-0.7 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "20-25%",
                            carbPct: "60-65%",
                            proteinGr: "1.8-2.2 g/kg",
                            carbinGr: "4.0-5.0 g/kg",
                            fatinGr: "0.5-0.6 g/kg"
                        }
                    }
                },
                details: "Esta fase implementa un ciclado metab√≥lico para maximizar la ganancia muscular con control de grasa durante la fase de volume en recomposici√≥n. Los d√≠as de entrenamiento intenso incluyen un mayor porcentaje de carbohidratos (50-55% de calor√≠as) para maximizar el rendimiento y la recuperaci√≥n, mientras que los d√≠as de menor intensidad o descanso reducen ligeramente los HC (40-45%) para mantener la sensibilidad a la insulina. La prote√≠na se mantiene alta (2.0-2.4 g/kg/d√≠a) para optimizar la s√≠ntesis proteica, especialmente en el contexto de un super√°vit cal√≥rico moderado. Basado en Sports Medicine (2021), este enfoque es particularmente efectivo para la recomposici√≥n corporal, ya que permite una ganancia muscular neta incluso en d√©ficit cal√≥rico leve cuando se combina con entrenamiento de fuerza intenso."
            }
        ],
        "Fase 2 Definici√≥n (12-24 sem)": [
            {

                id: "calorie-cycling",
                title: "Fase de Calorie Cycling Din√°mico",
                description: "Ciclo de d√©ficit y ligero super√°vit",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "50-55%",
                            carbPct: "20-25%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "1.5-1.8 g/kg",
                            fatinGr: "1.1-1.3 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "40-45%",
                            carbPct: "30-35%",
                            proteinGr: "1.6-2.0 g/kg",
                            carbinGr: "2.0-2.4 g/kg",
                            fatinGr: "0.9-1.1 g/kg"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "45-50%",
                            carbPct: "10-20%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "1.0-1.8 g/kg",
                            fatinGr: "0.9-1.2 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "35-40%",
                            carbPct: "30-40%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "2.2-2.8 g/kg",
                            fatinGr: "0.7-0.9 g/kg"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "40-45%",
                            carbPct: "15-25%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "1.5-2.0 g/kg",
                            fatinGr: "0.8-1.0 g/kg"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "40-50%",
                            proteinGr: "2.0-2.4 g/kg",
                            carbinGr: "3.0-4.0 g/kg",
                            fatinGr: "0.6-0.8 g/kg"
                        }
                    }
                },
                details: "Esta fase de definici√≥n implementa Calorie Cycling Din√°mico (3 d√≠as d√©ficit de 200-300 kcal + 2 d√≠as ligero super√°vit de 100-200 kcal + 2 d√≠as mantenimiento) para optimizar la p√©rdida de grasa mientras se preserva la masa muscular ganada en la fase 1. Los d√≠as de entrenamiento incluyen un rango controlado de carbohidratos (30-40% de calor√≠as) para mantener el rendimiento y la s√≠ntesis proteica, mientras que los d√≠as de descanso reducen los HC (10-20%) para potenciar la oxidaci√≥n de grasas. La prote√≠na se mantiene elevada (2.0-2.4 g/kg/d√≠a) para proteger la masa muscular. Basado en Sports Medicine (2022), este enfoque es superior al d√©ficit cal√≥rico constante para la recomposici√≥n corporal, ya que previene la adaptaci√≥n metab√≥lica y mantiene la tasa de p√©rdida de grasa a lo largo del tiempo, especialmente en individuos con prop√≥sitos est√©ticos."
            },
            {
                id: "low-carb-general",
                title: "Dieta Low Carb Ciclada",
                description: "Enfoque bajo en HC para inicio seguro y adaptable segun variabilidad.",
                aplicable: ["perdida", "mantenimiento"],
                macros: {
                    macrosSalud: {
                        proteinPct: "20-25%",
                        fatPct: "45-55%",
                        carbPct: "20-30%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "1.5-2.0 g/kg/d√≠a",
                        fatinGr: "1.0-1.2 g/kg/d√≠a"
                    },
                    macrosEstetica: {
                        proteinPct: "25-30%",
                        fatPct: "50-60%",
                        carbPct: "10-20%",
                        proteinGr: "1.8-2.2 g/kg/d√≠a",
                        carbinGr: "1.0-1.5 g/kg/d√≠a",
                        fatinGr: "1.0-1.3 g/kg/d√≠a"
                    },
                    macrosRendimiento: {
                        proteinPct: "20-25%",
                        fatPct: "40-50%",
                        carbPct: "30-40%",
                        proteinGr: "1.6-1.8 g/kg/d√≠a",
                        carbinGr: "2.5-3.0 g/kg/d√≠a",
                        fatinGr: "0.8-1.0 g/kg/d√≠a"
                    }
                },
                details: "La dieta low carb (LCD) es una estrategia flexible con ingestas moderadas de carbohidratos (50-150 g/d√≠a) que se adapta a diversos objetivos. En p√©rdida de peso, induce un d√©ficit cal√≥rico con mayor quema de grasa y control gluc√©mico. En mantenimiento, promueve la estabilidad metab√≥lica y previene la recuperaci√≥n de peso. Para ganancia muscular, requiere ciclado de carbohidratos y super√°vit controlado para optimizar el gluc√≥geno muscular. En recomposici√≥n corporal, combina alta prote√≠na con entrenamiento de resistencia para perder grasa y ganar m√∫sculo simult√°neamente. Basada en evidencia de Nutrition Reviews (2021), es sostenible a largo plazo y compatible con actividad f√≠sica regular cuando se ajustan los macros seg√∫n el prop√≥sito."
            }
        ],
        "Fase 3 Mantenimiento Metab√≥lico (24-32 sem)": [
            {
                id: "metabolic-flexibility2",
                title: "Fase de Mantenimiento Metab√≥lico",
                description: "Rotaci√≥n para estabilizar TMB",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            // Usa semanasBajasHC
                            proteinPct: "20-25%",
                            fatPct: "35-45%",
                            carbPct: "30-40%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            // Usa semanasAltasHC
                            proteinPct: "20-25%",
                            fatPct: "30-40%",
                            carbPct: "40-50%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.7-0.9 g/kg/d√≠a"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            // Usa semanasBajasHC
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "30-40%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "0.8-1.0 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            // Usa semanasAltasHC
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "50-60%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "3.5-4.5 g/kg/d√≠a",
                            fatinGr: "0.6-0.8 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            // Usa semanasBajasHC
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "35-45%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.5-3.0 g/kg/d√≠a",
                            fatinGr: "0.7-0.9 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            // Usa semanasAltasHC
                            proteinPct: "25-30%",
                            fatPct: "25-35%",
                            carbPct: "55-65%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "4.5-5.5 g/kg/d√≠a",
                            fatinGr: "0.5-0.7 g/kg/d√≠a"
                        }
                    }
                },
                details: "Esta fase de mantenimiento metab√≥lico implementa una rotaci√≥n semanal de macronutrientes para estabilizar la tasa metab√≥lica basal (TMB) tras 24 semanas de d√©ficit cal√≥rico intermitente. La rotaci√≥n (moderate carb ‚Üí high carb) mejora la flexibilidad metab√≥lica, permitiendo al cuerpo adaptarse a diferentes fuentes de energ√≠a y previniendo la adaptaci√≥n que ralentiza la recomposici√≥n corporal. Los d√≠as de high carb (40-50% de calor√≠as en HC) ayudan a normalizar hormonas como la leptina y la T3, que tienden a disminuir en d√©ficit prolongado. Basado en Obesity Reviews (2022), esta estrategia es cr√≠tica para mantener la progresi√≥n en recomposici√≥n corporal avanzada, especialmente en individuos que han estado en d√©ficit intermitente durante m√°s de 6 meses y necesitan estabilizar su metabolismo antes de la fase final de ajuste."
            }
        ],
        "Fase 4 Ajuste Metab√≥lico (>32 sem)": [
            {
                id: "metabolic-adaptation",
                title: "Fase de Ajuste Metab√≥lico",
                description: "Protocolo para superar plateaus avanzados",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "25-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "0.8-0.9 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.5-2.8 g/kg/d√≠a",
                            fatinGr: "0.7-0.8 g/kg/d√≠a"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "2.2-2.6 g/kg/d√≠a",
                            fatinGr: "0.8-0.9 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "50-60%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "3.5-4.5 g/kg/d√≠a",
                            fatinGr: "0.6-0.7 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "45-50%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.8-3.5 g/kg/d√≠a",
                            fatinGr: "0.7-0.8 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "20-25%",
                            carbPct: "55-65%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "4.5-5.5 g/kg/d√≠a",
                            fatinGr: "0.5-0.6 g/kg/d√≠a"
                        }
                    }
                },
                details: "Esta fase avanzada implementa el Metabolic Adaptation Protocol con ajustes espec√≠ficos para d√≠as de entrenamiento y descanso. En d√≠as de descanso se prioriza un moderado d√©ficit cal√≥rico y mayor aporte de grasas, mientras los d√≠as de entrenamiento maximizan la carga de carbohidratos para rendimiento y recuperaci√≥n. La prote√≠na se mantiene alta (1.8-2.4 g/kg/d√≠a) consistentemente para proteger masa muscular. La rotaci√≥n avanzada de macronutrientes seg√∫n la actividad f√≠sica mantiene la flexibilidad metab√≥lica y optimiza la recomposici√≥n corporal en atletas avanzados."
            },
            {
                id: "cicladoMetabolico5",
                title: "Fase de Ciclado Metab√≥lico Avanzado",
                description: "Ciclado avanzado para optimizaci√≥n",
                aplicable: ["mixto"],
                macros: {
                    macrosSalud: {
                        diasDescanso: {
                            proteinPct: "20-25%",
                            fatPct: "30-35%",
                            carbPct: "35-40%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.0-2.5 g/kg/d√≠a",
                            fatinGr: "0.8-0.9 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "20-25%",
                            fatPct: "25-30%",
                            carbPct: "40-45%",
                            proteinGr: "1.6-2.0 g/kg/d√≠a",
                            carbinGr: "2.5-2.8 g/kg/d√≠a",
                            fatinGr: "0.7-0.8 g/kg/d√≠a"
                        }
                    },
                    macrosEstetica: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "30-35%",
                            carbPct: "40-45%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "2.2-2.6 g/kg/d√≠a",
                            fatinGr: "0.8-0.9 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "50-60%",
                            proteinGr: "1.8-2.2 g/kg/d√≠a",
                            carbinGr: "3.0-3.5 g/kg/d√≠a",
                            fatinGr: "0.6-0.7 g/kg/d√≠a"
                        }
                    },
                    macrosRendimiento: {
                        diasDescanso: {
                            proteinPct: "25-30%",
                            fatPct: "25-30%",
                            carbPct: "45-50%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "2.8-3.5 g/kg/d√≠a",
                            fatinGr: "0.6-0.8 g/kg/d√≠a"
                        },
                        diasEntreno: {
                            proteinPct: "25-30%",
                            fatPct: "20-25%",
                            carbPct: "50-60%",
                            proteinGr: "2.0-2.4 g/kg/d√≠a",
                            carbinGr: "3.5-4.5 g/kg/d√≠a",
                            fatinGr: "0.5-0.6 g/kg/d√≠a"
                        }
                    }
                },
                details: "Esta fase implementa un ciclado metab√≥lico avanzado espec√≠ficamente dise√±ado para atletas intermedios/avanzados que buscan optimizar su composici√≥n corporal y rendimiento. Para prop√≥sitos est√©ticos, los carbohidratos se mantienen en un rango controlado (40-45% de calor√≠as) para maximizar la definici√≥n muscular, mientras que para prop√≥sitos de rendimiento, el rango aumenta (45-50%) para soportar la demanda energ√©tica de los entrenamientos. La prote√≠na se distribuye en 4-5 comidas (0.4-0.5g/kg cada 3-4h) para maximizar la s√≠ntesis proteica a lo largo del d√≠a. Basado en Journal of the International Society of Sports Nutrition (2022), este enfoque avanzado es cr√≠ticamente importante para superar plateaus en recomposici√≥n corporal prolongada, especialmente en individuos que han estado en d√©ficit intermitente por m√°s de 8 meses y necesitan ajustes finos para continuar progresando."
            }
        ]
    }
};
// Matriz de compatibilidad basada en tu tabla
// Matriz de compatibilidad completa para todas las estrategias
const matrizCompatibilidad = {
    perdida: {
        "Fase 1 (0-12 sem)": {
            "Modified Ketogenic Diet": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Protein Cycling": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Metabolic Flexibility Training": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "mo recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "on recomendada", "estetica": "no recomendada", "rendimiento": "no recomedada" },
                "Hydration Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
            },
            "Fase de Ciclado Metab√≥lico inicial": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "neutral", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Cycling": { "salud": "no recomendado", "estetica": "no recomendada", "rendimiento": "neutral" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
            },
            "Dieta Low Carb General": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "neutral", "rendimiento": "recomendada" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Protein Cycling": { "salud": "no recomendado", "estetica": "no recomendada", "rendimiento": " no recomendada" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
                "Intermittent Fasting + Cycling": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
            }
        },
        "Fase 2 (12-24 sem)": {
            "Fase de Ciclado Metab√≥lico": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "neutral", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Cycling": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "no recomendada" },
                "High Carb Resistencia": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Metabolic Flexibility Training": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" }
            },
            "Dieta Low Carb Ciclada": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "neutral", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Protein Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
                "Refeed Strategy": { "salud": "no recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
                "Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "no RECOMENDADA" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" }
            }
        },
        "Fase 3 Avanzada (>24 sem)": {
            "Fase de Ajuste Metab√≥lico": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Calorie Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "neutral", "rendimiento": "neutral" },
                "Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" }
            },
            "Fase de Transici√≥n a Mantenimiento": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
            }
        },
        "Fase 4 Ajuste Metab√≥lico (>32 sem)": {
            "Protocolo de Adaptaci√≥n Metabolica": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Calorie Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
            },
            "Fase de Transici√≥n a Mantenimiento": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Carb Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Dieta Low Carb General": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" }
            }
        }
    },
    ganancia: {
        "Fase 1 (0-8 sem)": {
            "Fase Lean Bulk Controlado": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }


            },
            "Fase de Ciclado Metab√≥lico Ganancia": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }

            }
        },
        "Fase 2 (8-20 sem)": {
            "Carb Cycling / Protein Pacing": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }

            },
            "Fase de Volumen Hiperproteico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }

            },
            "Fase de Volumen con alto en HC": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" }

            }
        },
        "Fase 3 (20-28 sem)": {
            "Fase de Mantenimiento y Reajuste": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "neutal" }

            }
        },
        "Fase 4 (>28 sem)": {
            "Metabolic Flexibility Training": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" }

            },

            "Fase Lean Bulk Controlado": {
            }
        }
    },
    mantenimiento: {
        "Fase 1 (0-6 meses)": {
            "Fase de Flexible Dieting": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Fase de Dieta Equilibrada": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Dieta Low Carb General": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "neutral", "estetica": "neutral", "rendimiento": "neutral" },
                "Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "neutral", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" }
            }
        },
        "Fase 2 (6-18 meses)": {
            "Dieta Equilibrada": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Calorie Cycling Din√°mico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            }
        },
        "Fase 3 (18+ meses)": {
            "Fase de Metabolic Flexibility Training": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "neutral", rendimiento: "recomendada" }

            }
        }
    },
    mixto: {
        "Fase 1 Volumen (0-12 sem)": {
            "Fase de Volumen Controlado": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Calorie Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Fase de Ciclado Metab√≥lico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            }
        },
        "Fase 2 Definici√≥n (12-24 sem)": {
            "Fase de Calorie Cycling Din√°mico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Refeed Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Fase deCalorie Cycling Din√°mico + Carb Cycling": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "no recomendada" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Dieta Low Carb Ciclada": {
                "Targeted Ketogenic Diet (TKD)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Cyclic Ketogenic Diet (CKD)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Restricted Ketogenic Diet (RKD)": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Modified Ketogenic Diet": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Carb Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "High Carb Resistencia": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Protein Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Calorie Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Metabolic Flexibility Training": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Refeed Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Flexible Dieting (80/20 rule)": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Dieta Est√°ndar/Equilibrada": { "salud": "no recomendada", "estetica": "no recomendada", "rendimiento": "no recomendada" },
                "Intermittent Fasting + Cycling": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "neutral" },
                "Meal Timing Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "NEAT Optimization": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Hydration Strategy": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" },
                "Targeted Carb Timing": { "salud": "neutral", "estetica": "neutral", "rendimiento": "recomendada" },
                "Protein Pacing": { "salud": "recomendada", "estetica": "recomendada", "rendimiento": "recomendada" }
            }

        },
        "Fase 3 Mantenimiento Metab√≥lico (24-32 sem)": {
            "Fase de Mantenimiento Metab√≥lico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "neutral", rendimiento: "neutral" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" }

            }
        },
        "Fase 4 Ajuste Metab√≥lico (>32 sem)": {
            "Fase de Ajuste Metab√≥lico": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "neutral", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "neutral", estetica: "neutral", rendimiento: "neutral" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" }

            },
            "Fase de Ciclado Metab√≥lico Avanzado": {
                "Targeted Ketogenic Diet (TKD)": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "neutral" },
                "Cyclic Ketogenic Diet (CKD)": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Carb Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "High Carb Resistencia": { salud: "no recomendada", estetica: "no recomendada", rendimiento: "recomendada" },
                "Protein Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Calorie Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Metabolic Flexibility Training": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Refeed Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Flexible Dieting (80/20 rule)": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Est√°ndar/Equilibrada": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Intermittent Fasting + Cycling": { salud: "recomendada", estetica: "recomendada", rendimiento: "neutral" },
                "Meal Timing Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "NEAT Optimization": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Hydration Strategy": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Targeted Carb Timing": { salud: "neutral", estetica: "neutral", rendimiento: "recomendada" },
                "Protein Pacing": { salud: "recomendada", estetica: "recomendada", rendimiento: "recomendada" },
                "Dieta Low Carb General": { salud: "neutral", estetica: "recomendada", rendimiento: "neutral" }

            }
        }
    }
};
const recomendacionesBaseMatriz = {
    "perdida": {
        "Fase 1 (0-12 sem)": {
            "Modified Ketogenic Diet": [
                "Inicia con 50-100g de carbohidratos netos diarios para inducir cetosis suave (1.5-3.0 mmol/L de beta-hidroxibutirato), respaldado por estudios de Paoli et al. (2019) que demuestran eficacia en p√©rdida de grasa sin comprometer masa muscular.",
                "Monitorea electrolitos (sodio 5-7g, potasio 3-4.5g, magnesio 400mg diarios) para prevenir el 'keto flu' y mantener funci√≥n muscular, seg√∫n evidencia de Masood et al. (2020) en Journal of the American College of Nutrition.",
                "Limita el d√©ficit cal√≥rico a 300-500 kcal/d√≠a (15-20% por debajo de mantenimiento) para preservar masa muscular, basado en meta-an√°lisis de Helms et al. (2014) que muestra que d√©ficits mayores (>25%) aumentan riesgo de sarcopenia.",
                "Prioriza grasas monoinsaturadas y omega-3 (aceite de oliva, aguacate, pescado graso) para reducir inflamaci√≥n sist√©mica, respaldado por estudios de Santos et al. (2012) en Nutrici√≥n Journal.",
                "Incorpora fibra soluble (psyllium, ch√≠a) 15-20g/d√≠a para mantener salud intestinal durante la transici√≥n cetog√©nica, seg√∫n evidencia de Reddel et al. (2019) en Nutrients."
            ],
            "Fase de Ciclado Metab√≥lico inicial": [
                "Implementa ciclos semanales de carbohidratos (5 d√≠as bajos HC: 30-50g, 2 d√≠as moderados: 100-150g) para mejorar flexibilidad metab√≥lica, respaldado por estudios de de Luis et al. (2017) que muestran mejoras en sensibilidad a la insulina.",
                "Combina con ayuno intermitente (14-16h) solo despu√©s de 8 semanas de estabilidad, basado en evidencia de Patterson et al. (2015) que indica que la implementaci√≥n prematura puede aumentar cortisol y estr√©s metab√≥lico.",
                "Enf√≥cate en hidrataci√≥n √≥ptima (30-35ml/kg/d√≠a) con electrolitos para mantener volumen plasm√°tico y funci√≥n renal, respaldado por estudios de Perrier et al. (2020) en European Journal of Clinical Nutrition.",
                "Incorpora 1-2 sesiones semanales de entrenamiento de fuerza de alta intensidad para preservar masa muscular durante la adaptaci√≥n, seg√∫n meta-an√°lisis de Schoenfeld et al. (2017) en Sports Medicine.",
                "Monitorea indicadores de estr√©s metab√≥lico (cortisol matutino, HRV) para ajustar intensidad del protocolo, basado en recomendaciones de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
            ],
            "Dieta Low Carb General": [
                "Mant√©n carbohidratos en 80-120g diarios para p√©rdida de grasa sostenida, con evidencia de Hall et al. (2015) en Cell Metabolism mostrando superioridad sobre dietas altas en HC para reducci√≥n de grasa visceral.",
                "Incorpora protein pacing (0.4-0.55g/kg por comida, 4-5 comidas) para maximizar s√≠ntesis proteica y saciedad, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Optimiza NEAT incrementando 2,000-4,000 pasos diarios adicionales para elevar gasto energ√©tico 150-300kcal/d√≠a, basado en evidencia de Levine et al. (2006) en PLOS Medicine.",
                "Prioriza vegetales de hoja verde y cruc√≠feras (2-3 tazas diarias) para fibra y micronutrientes, respaldado por estudios de Hruby et al. (2016) en American Journal of Clinical Nutrition.",
                "Incluye 1-2 d√≠as semanales de mayor ingesta (80-90% de mantenimiento) para prevenir adaptaci√≥n metab√≥lica temprana, seg√∫n evidencia de Tremblay et al. (2018) en Obesity Reviews."
            ]
        },
        "Fase 2 (12-24 sem)": {
            "Fase de Ciclado Metab√≥lico": [
                "Alterna ciclos semanales de carbohidratos (3 d√≠as bajos HC: 50g, 2 d√≠as medios HC: 100g, 2 d√≠as altos HC: 150-200g) para prevenir adaptaci√≥n, respaldado por estudios de Thiel et al. (2020) en Nutrients que muestran mejoras en oxidaci√≥n de grasas.",
                "Incluye refeeds moderados (1 d√≠a cada 10-14 d√≠as con 110-120% de mantenimiento) para restaurar leptina y evitar desaceleraci√≥n metab√≥lica, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
                "Ajusta timing de comidas: distribuye prote√≠nas en 4-6 ingestas con 0.4-0.5g/kg por comida para maximizar MPS, respaldado por estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
                "Implementa 1-2 sesiones semanales de entrenamiento HIIT para mejorar flexibilidad metab√≥lica, seg√∫n meta-an√°lisis de Viana et al. (2019) en Sports Medicine.",
                "Monitorea marcadores de salud (HbA1c, perfil lip√≠dico) cada 8-12 semanas para ajustes personalizados, basado en recomendaciones de Santos et al. (2018) en Journal of Clinical Lipidology."
            ],
            "Dieta Low Carb Ciclada": [
                "Cicla bajos carbohidratos (40-60g) con 1-2 d√≠as targeted (100-150g) alrededor de entrenamientos para sostener rendimiento, respaldado por estudios de Zinn et al. (2017) en Journal of the International Society of Sports Nutrition.",
                "Limita d√©ficits a 200-300kcal/d√≠a en plateau, con monitoreo de DEXA cada 12 semanas para ajustes, basado en evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
                "Incorpora flexibilidad diet√©tica (80/20) con enfoque en alimentos integrales, respaldado por estudios de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
                "Ajusta grasa total seg√∫n ingesta de HC (60-70% de calor√≠as en d√≠as bajos HC, 50-60% en d√≠as altos HC) para mantener balance energ√©tico, basado en recomendaciones de Krieger et al. (2018) en Nutrients.",
                "Implementa estrategias de manejo del estr√©s (meditaci√≥n, sue√±o √≥ptimo) para regular cortisol y hambre, respaldado por estudios de Tomiyama et al. (2014) en Obesity."
            ]
        },
        "Fase 3 Avanzada (>24 sem)": {
            "Fase de Ajuste Metab√≥lico": [
                "Introduce entrenamiento de flexibilidad metab√≥lica con rotaciones de macronutrientes (3 d√≠as cetog√©nicos, 2 d√≠as carbos moderados, 2 d√≠as carbos altos) para optimizar uso de combustibles, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
                "Usa refeeds estrat√©gicos (cada 4-6 semanas, 24-48h con 110-130% de mantenimiento) para mitigar adaptaci√≥n metab√≥lica, basado en evidencia de M√ºller et al. (2019) en Obesity Reviews.",
                "Enf√≥cate en protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) y timing de carbohidratos targeted (20-40g pre-entrenamiento) para rendimiento, respaldado por estudios de Areta et al. (2013) en Journal of Physiology.",
                "Incorpora periodizaci√≥n nutricional alineada con entrenamiento (semanas de volumen vs. intensidad), seg√∫n evidencia de Tinsley et al. (2018) en Sports Medicine.",
                "Monitorea RMR cada 8-12 semanas para ajustar d√©ficit y prevenir plateau, basado en recomendaciones de M√ºller et al. (2020) en European Journal of Clinical Nutrition."
            ],
            "Fase de Transici√≥n a Mantenimiento": [
                "Transita gradualmente aumentando carbohidratos 10-15g cada 3-4 d√≠as hasta 150-200g/d√≠a, con evidencia de Hall et al. (2019) en Cell Metabolism mostrando mejoras en salud metab√≥lica post-p√©rdida.",
                "Incorpora ayuno intermitente 14-16h m√°ximo 3-4 d√≠as/semana para control de apetito, basado en estudios de de Cabo et al. (2019) en New England Journal of Medicine.",
                "Optimiza hidrataci√≥n (35ml/kg/d√≠a) y NEAT (aumento progresivo a 10,000 pasos/d√≠a) para mantenimiento sin rebote, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
                "Implementa 'cheat meals' controlados (1-2 veces/semana, 20-30% sobre mantenimiento) para adherencia, basado en evidencia de Klem et al. (2018) en Obesity Science & Practice.",
                "Establece protocolo de monitoreo continuo (peso semanal, medidas corporales, an√°lisis sangu√≠neos trimestrales) para ajustes proactivos, seg√∫n recomendaciones del American College of Sports Medicine (2020)."
            ]
        },
        "Fase 4 Ajuste Metab√≥lico (>32 sem)": {
            "Protocolo de Adaptaci√≥n Metabolica": [
                "Entrena flexibilidad metab√≥lica con ciclos avanzados (semanas alternas de 50-70g HC y 150-200g HC) para eficiencia energ√©tica, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
                "Monitorea marcadores avanzados (HOMA-IR, adiponectina, perfil lip√≠dico completo) cada 12 semanas, con beneficios respaldados en estudios de Volek et al. (2016) en Nutritional Metabolism.",
                "Ajusta calorie cycling (5 d√≠as d√©ficit 200kcal, 2 d√≠as mantenimiento) para prevenir estancamiento, enfocando en rendimiento y est√©tica, basado en evidencia de Campbell et al. (2019) en Journal of the International Society of Sports Nutrition.",
                "Incorpora periodizaci√≥n de suplementos (creatina en d√≠as de fuerza, beta-alanina en d√≠as de resistencia) para optimizar rendimiento, respaldado por estudios de Trexler et al. (2015) en Journal of the International Society of Sports Nutrition.",
                "Implementa estrategias de recuperaci√≥n avanzadas (crioterapia, terapia de compresi√≥n) para optimizar adaptaciones metab√≥licas, seg√∫n evidencia de Leeder et al. (2012) en British Journal of Sports Medicine."
            ],
            "Fase de Transici√≥n a Mantenimiento": [
                "Aumenta gradualmente ingesta cal√≥rica 50-100kcal cada 3-4 d√≠as hasta mantenimiento, incorporando flexible dieting para adherencia, basado en estudios de Klem et al. (2020) en International Journal of Obesity.",
                "Usa meal timing optimization (ventana de alimentaci√≥n 10-12h) para maximizar recuperaci√≥n y control de peso, respaldado por evidencia de Patterson et al. (2017) en Nutrients.",
                "Incluye estrategias de hidrataci√≥n personalizada (30-35ml/kg/d√≠a con ajuste por clima) y protein pacing (1.8-2.2g/kg distribuidos) para salud general, seg√∫n recomendaciones de J√§ger et al. (2017) en Journal of the International Society of Sports Nutrition.",
                "Implementa 'micro-cycles' de 3-4 d√≠as de ligero d√©ficit (100-200kcal) mensuales para prevenir ganancia de grasa, basado en evidencia de Helms et al. (2021) en Sports Medicine.",
                "Establece protocolo de monitoreo de composici√≥n corporal mediante DEXA cada 12-16 semanas para ajustes precisos, respaldado por recomendaciones de Heymsfield et al. (2014) en Obesity."
            ]
        }
    },
    "ganancia": {
        "Fase 1 (0-8 sem)": {
            "Fase Lean Bulk Controlado": [
                "Mant√©n super√°vit cal√≥rico moderado (300-500 kcal) con √©nfasis en prote√≠nas 1.6-2.2g/kg para ganancia muscular limpia, respaldado por meta-an√°lisis de Morton et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Incorpora carb cycling (d√≠as de entrenamiento: 4-6g/kg HC, d√≠as de descanso: 2-3g/kg HC) para optimizar rendimiento y recuperaci√≥n, basado en estudios de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
                "Enf√≥cate en protein pacing (0.4-0.55g/kg por comida, 4-6 comidas) para s√≠ntesis proteica m√°xima, respaldado por evidencia de Mamerow et al. (2014) en Journal of Nutrition.",
                "Prioriza carbohidratos de absorci√≥n lenta (avena, batata, arroz integral) en 60-65% de las comidas para estabilidad gluc√©mica, seg√∫n estudios de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
                "Incluye 1-2 d√≠as semanales de 'maintenance' para prevenir adaptaci√≥n metab√≥lica temprana, basado en evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition."
            ],
            "Fase de Ciclado Metab√≥lico Ganancia": [
                "Cicla carbohidratos altos (5-7g/kg) en d√≠as de entrenamiento para apoyar hipertrofia, con evidencia de Aragon et al. (2017) en Journal of the International Society of Sports Nutrition mostrando mejoras en s√≠ntesis proteica.",
                "Combina con calorie cycling (5 d√≠as super√°vit 300-500kcal, 2 d√≠as mantenimiento) para controlar ganancia de grasa, respaldado por estudios de Helms et al. (2016) en Journal of the International Society of Sports Nutrition.",
                "Asegura hidrataci√≥n √≥ptima (35-40ml/kg/d√≠a) para volumen celular y performance, basado en recomendaciones de Shirreffs et al. (2004) en Journal of Sports Sciences.",
                "Incorpora 1-2 sesiones semanales de cardio de baja intensidad para mejorar capacidad aer√≥bica sin interferir con ganancia muscular, seg√∫n evidencia de Schoenfeld et al. (2017) en Sports Medicine.",
                "Monitorea relaci√≥n grasa/m√∫sculo mediante DEXA cada 8-12 semanas para ajustar protocolo, respaldado por estudios de Heymsfield et al. (2014) en Obesity."
            ]
        },
        "Fase 2 (8-20 sem)": {
            "Carb Cycling / Protein Pacing": [
                "Alterna d√≠as altos HC (5-7g/kg) y bajos HC (2-3g/kg) con protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) para maximizar ganancia muscular, respaldado por estudios de Churchward-Venne et al. (2014) en Journal of Physiology.",
                "Usa targeted carb timing (30-50g HC 30-60 min pre-entrenamiento) para boost en rendimiento, respaldado por meta-an√°lisis de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Incluye refeeds semanales (1 d√≠a con 110-120% de mantenimiento) para mantener motivaci√≥n y adherencia, basado en evidencia de Krieger (2017) en Journal of the International Society of Sports Nutrition.",
                "Implementa periodizaci√≥n nutricional alineada con mesociclos de entrenamiento (volumen vs. intensidad), seg√∫n recomendaciones de Tinsley et al. (2018) en Sports Medicine.",
                "Monitorea indicadores de estr√©s metab√≥lico (cortisol, HRV) para ajustar intensidad del protocolo, basado en estudios de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
            ],
            "Fase de Volumen Hiperproteico": [
                "Eleva prote√≠nas a 2.3-2.6g/kg con calorie cycling (super√°vit 300-500kcal en d√≠as de entrenamiento, mantenimiento en d√≠as de descanso) para hipertrofia √≥ptima, respaldado por meta-an√°lisis de Morton et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Enf√≥cate en meal timing post-entreno (20-40g prote√≠na + 0.8g/kg HC dentro de 45 min) para s√≠ntesis proteica m√°xima, basado en estudios de Areta et al. (2013) en Journal of Physiology.",
                "Monitorea NEAT y ajusta ingesta para mantener ganancia de grasa <0.5kg/mes, respaldado por evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
                "Incorpora 1-2 d√≠as semanales de 'recovery nutrition' con mayor ingesta de grasas saludables (30-35% de calor√≠as) para reducir inflamaci√≥n, seg√∫n estudios de Goto et al. (2018) en Nutrients.",
                "Implementa monitoreo de marcadores renales (creatinina, BUN) cada 12 semanas para seguridad, basado en recomendaciones de Devries et al. (2018) en Journal of the International Society of Sports Nutrition."
            ],
            "Fase de Volumen con alto en HC": [
                "Usa dieta alta en carbohidratos (6-8g/kg) para deportes de resistencia, mejorando rendimiento y recuperaci√≥n, respaldado por estudios de Burke et al. (2011) en Medicine & Science in Sports & Exercise.",
                "Cicla calor√≠as (super√°vit 400-600kcal en d√≠as de entrenamiento intenso, 200-300kcal en d√≠as de descanso) para bulk controlado, seg√∫n evidencia de Tinsley et al. (2018) en Sports Medicine.",
                "Incorpora protein pacing (1.8-2.2g/kg distribuidos en 5-6 comidas) para balance y preservaci√≥n de est√©tica, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Prioriza carbohidratos de alta calidad (frutas, vegetales, granos integrales) para fibra y micronutrientes, seg√∫n recomendaciones de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
                "Incluye estrategias de hidrataci√≥n personalizada (1.5L/hora de ejercicio intenso) para rendimiento √≥ptimo, basado en estudios de Sawka et al. (2007) en Medicine & Science in Sports & Exercise."
            ]
        },
        "Fase 3 (20-28 sem)": {
            "Fase de Mantenimiento y Reajuste": [
                "Ajusta a mantenimiento con flexibilidad diet√©tica (80/20 rule) para consolidar ganancias, con evidencia de Krieger (2017) en Journal of the International Society of Sports Nutrition mostrando mejor adherencia a largo plazo.",
                "Incluye metabolic flexibility training (ciclos semanales de HC) para eficiencia en uso de combustibles, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
                "Optimiza hydration (35-40ml/kg/d√≠a) y targeted carb timing (20-30g HC pre-entrenamiento) para sostenibilidad, basado en recomendaciones de Shirreffs et al. (2004) en Journal of Sports Sciences.",
                "Implementa 1-2 d√≠as semanales de 'metabolic reset' con ligero d√©ficit (200-300kcal) para prevenir adaptaci√≥n, respaldado por evidencia de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
                "Monitorea composici√≥n corporal mediante DEXA cada 12 semanas para ajustes precisos, seg√∫n recomendaciones de Heymsfield et al. (2014) en Obesity."
            ]
        },
        "Fase 4 (>28 sem)": {
            "Metabolic Flexibility Training": [
                "Entrena alternando combustibles con ciclos avanzados (semanas alternas de 3-4g/kg y 6-7g/kg HC) para ganancias avanzadas, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
                "Combina con intermittent fasting 14-16h m√°ximo 2-3 d√≠as/semana para control de composici√≥n corporal, basado en evidencia de Patterson et al. (2017) en Nutrients.",
                "Enf√≥cate en protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) y meal timing para rendimiento √≥ptimo, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Incorpora periodizaci√≥n de suplementos (creatina en d√≠as de fuerza, beta-alanina en d√≠as de resistencia) para optimizar adaptaciones, seg√∫n estudios de Trexler et al. (2015) en Journal of the International Society of Sports Nutrition.",
                "Implementa monitoreo de marcadores avanzados (HOMA-IR, perfil lip√≠dico completo) cada 12 semanas para salud metab√≥lica, basado en recomendaciones de Volek et al. (2016) en Nutritional Metabolism."
            ],
            "Fase Lean Bulk Controlado": [
                "Mant√©n bulk lean con super√°vit controlado (200-400kcal) y flexible dieting para adherencia, respaldado por estudios de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
                "Usa NEAT optimization (aumento progresivo a 10,000 pasos/d√≠a) para balance energ√©tico, basado en evidencia de Pontzer et al. (2016) en Current Biology.",
                "Incorpora refeed strategy (1 d√≠a cada 10-14 d√≠as con 110-120% de mantenimiento) para prevenir fatiga metab√≥lica, respaldado por estudios de Doucet et al. (2009) en International Journal of Obesity.",
                "Implementa estrategias de recuperaci√≥n avanzadas (crioterapia, terapia de compresi√≥n) para optimizar adaptaciones, seg√∫n evidencia de Leeder et al. (2012) en British Journal of Sports Medicine.",
                "Monitorea relaci√≥n grasa/m√∫sculo mediante DEXA cada 8-12 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
            ]
        }
    },
    "mantenimiento": {
        "Fase 1 (0-6 meses)": {
            "Fase de Flexible Dieting": [
                "Aplica regla 80/20 con enfoque en alimentos integrales para sostenibilidad, respaldado por estudios de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
                "Optimiza meal timing (ventana de alimentaci√≥n 10-12h) para estabilidad energ√©tica, basado en evidencia de Patterson et al. (2017) en Nutrients.",
                "Enf√≥cate en hidrataci√≥n √≥ptima (30-35ml/kg/d√≠a) y NEAT (8,000-10,000 pasos/d√≠a) para mantenimiento de composici√≥n corporal, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
                "Incorpora protein pacing (1.6-2.2g/kg distribuidos en 4-5 comidas) para preservaci√≥n muscular, seg√∫n estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Implementa 'micro-cycles' mensuales (3-4 d√≠as de ligero d√©ficit 100-200kcal) para prevenir ganancia de grasa, respaldado por evidencia de Helms et al. (2021) en Sports Medicine."
            ],
            "Fase de Dieta Equilibrada": [
                "Mant√©n balance de macronutrientes est√°ndar (45-55% HC, 25-35% grasas, 15-25% prote√≠nas) para salud general, respaldado por recomendaciones de American College of Sports Medicine (2020).",
                "Incorpora protein pacing (0.3-0.4g/kg por comida, 4-5 comidas) para saciedad y preservaci√≥n muscular, basado en estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Usa calorie cycling leve (¬±100-200kcal diarios) para evitar adaptaci√≥n metab√≥lica, respaldado por evidencia de Helms et al. (2021) en Sports Medicine.",
                "Prioriza alimentos ricos en fibra (25-38g/d√≠a) para salud intestinal y saciedad, seg√∫n recomendaciones de Slavin (2013) en Nutrition Reviews.",
                "Incluye 1-2 d√≠as semanales de 'metabolic challenge' (variaci√≥n de 200-300kcal) para mantener flexibilidad metab√≥lica, basado en estudios de de Luis et al. (2021) en Nutrients."
            ],
            "Dieta Low Carb General": [
                "Mant√©n carbohidratos en 50-100g diarios para estabilidad metab√≥lica, con evidencia de Volek et al. (2016) en Nutritional Metabolism mostrando mejoras en sensibilidad a la insulina.",
                "Cicla prote√≠nas (1.8-2.2g/kg) y refeeds semanales (1 d√≠a con 105-110% de mantenimiento) para variedad y adherencia, respaldado por estudios de de Luis et al. (2017) en Nutrients.",
                "Monitorea rendimiento con targeted carb timing (20-30g HC pre-entrenamiento) si es necesario, basado en evidencia de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Incorpora grasas saludables (40-50% de calor√≠as) con √©nfasis en omega-3 (1-2g EPA/DHA diarios) para reducir inflamaci√≥n, seg√∫n estudios de Goto et al. (2018) en Nutrients.",
                "Implementa monitoreo de electrolitos y marcadores renales cada 12 semanas para seguridad, respaldado por recomendaciones de Devries et al. (2018) en Journal of the International Society of Sports Nutrition."
            ]
        },
        "Fase 2 (6-18 meses)": {
            "Dieta Equilibrada": [
                "Sost√©n dieta equilibrada con flexibilidad para largo plazo, enfocando en salud est√©tica y rendimiento, respaldado por estudios de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
                "Incluye intermittent fasting 14-16h m√°ximo 2-3 d√≠as/semana para beneficios en control de peso, basado en evidencia de Patterson et al. (2017) en Nutrients.",
                "Optimiza NEAT (aumento progresivo a 10,000 pasos/d√≠a) y hydration (35ml/kg/d√≠a) para equilibrio energ√©tico, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
                "Incorpora protein pacing avanzado (0.4-0.5g/kg por comida, 5 comidas) para salud muscular, seg√∫n estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
                "Implementa 'macro cycling' mensual (variaci√≥n de 10-15% en HC y grasas) para prevenir adaptaci√≥n, basado en evidencia de Helms et al. (2021) en Sports Medicine."
            ],
            "Calorie Cycling Din√°mico": [
                "Cicla calor√≠as din√°micamente (¬±200-400kcal diarios) para mantenimiento sin estancamiento, respaldado por estudios de Helms et al. (2021) en Sports Medicine.",
                "Combina con carb cycling (variaci√≥n de 30-50g HC diarios) para variedad metab√≥lica, basado en evidencia de de Luis et al. (2021) en Nutrients.",
                "Enf√≥cate en protein pacing (1.8-2.2g/kg distribuidos) para salud muscular, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Incorpora 1-2 d√≠as semanales de 'metabolic reset' con ligero d√©ficit (200kcal) para mantener sensibilidad, seg√∫n estudios de M√ºller et al. (2019) en Obesity Reviews.",
                "Monitorea composici√≥n corporal mediante DEXA cada 16 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
            ]
        },
        "Fase 3 (18+ meses)": {
            "Fase de Metabolic Flexibility Training": [
                "Entrena flexibilidad con rotaciones avanzadas de macronutrientes (semanas alternas de 3-4g/kg y 5-6g/kg HC) para salud avanzada, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
                "Incorpora refeeds estrat√©gicos (cada 4-6 semanas, 24-48h con 110-130% de mantenimiento) y fasting 14-16h 2-3 d√≠as/semana para optimizaci√≥n metab√≥lica, basado en evidencia de Patterson et al. (2017) en Nutrients.",
                "Usa meal timing personalizado y targeted carbs (20-40g HC pre-entrenamiento) para performance sostenida, respaldado por estudios de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Implementa monitoreo de marcadores avanzados (HOMA-IR, perfil lip√≠dico completo) cada 12 semanas, seg√∫n recomendaciones de Volek et al. (2016) en Nutritional Metabolism.",
                "Incluye estrategias de recuperaci√≥n avanzadas (crioterapia, terapia de compresi√≥n) para optimizar adaptaciones, basado en evidencia de Leeder et al. (2012) en British Journal of Sports Medicine."
            ]
        }
    },
    "mixto": {
        "Fase 1 Volumen (0-12 sem)": {
            "Fase de Volumen Controlado": [
                "Controla super√°vit con dieting flexible (300-500kcal) para ganancia muscular y control de grasa, respaldado por estudios de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
                "Cicla carbohidratos (d√≠as de entrenamiento: 4-6g/kg HC, d√≠as de descanso: 2-3g/kg HC) para fases de volumen mixto, basado en evidencia de Thomas et al. (2016) en Journal of the International Society of Sports Nutrition.",
                "Enf√≥cate en protein pacing (0.4-0.55g/kg por comida, 4-6 comidas) para hipertrofia y recuperaci√≥n, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Incorpora 1-2 d√≠as semanales de 'metabolic reset' con ligero d√©ficit (200-300kcal) para prevenir adaptaci√≥n, seg√∫n evidencia de Helms et al. (2021) en Sports Medicine.",
                "Monitorea relaci√≥n grasa/m√∫sculo mediante DEXA cada 8-12 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
            ],
            "Fase de Ciclado Metab√≥lico": [
                "Cicla metab√≥licamente (3 d√≠as volumen: super√°vit 300-500kcal, 2 d√≠as mantenimiento, 2 d√≠as ligero d√©ficit 200kcal) para balance entre ganancia y definici√≥n, respaldado por estudios de Helms et al. (2021) en Sports Medicine.",
                "Usa calorie cycling para ajustes din√°micos seg√∫n respuesta individual, basado en evidencia de Krieger (2017) en Journal of the International Society of Sports Nutrition.",
                "Optimiza hydration (35ml/kg/d√≠a) y NEAT (aumento progresivo a 10,000 pasos/d√≠a) para equilibrio, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
                "Incluye estrategias de manejo del estr√©s (meditaci√≥n, sue√±o √≥ptimo) para regular cortisol, seg√∫n estudios de Tomiyama et al. (2014) en Obesity.",
                "Implementa monitoreo de marcadores de estr√©s metab√≥lico (cortisol, HRV) cada 4 semanas para ajustes, basado en recomendaciones de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
            ]
        },
        "Fase 2 Definici√≥n (12-24 sem)": {
            "Fase de Calorie Cycling Din√°mico": [
                "Cicla calor√≠as (5 d√≠as d√©ficit 300-500kcal, 2 d√≠as mantenimiento) para definici√≥n mientras se mantiene m√∫sculo, respaldado por estudios de Helms et al. (2020) en Journal of the International Society of Sports Nutrition.",
                "Incluye refeeds estrat√©gicos (cada 8-12 semanas, 24-48h con 110-120% de mantenimiento) para rendimiento, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
                "Monitorea meal timing para optimizaci√≥n (distribuci√≥n de prote√≠nas en 4-6 comidas), respaldado por estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
                "Incorpora 1-2 sesiones semanales de entrenamiento HIIT para mejorar flexibilidad metab√≥lica, seg√∫n meta-an√°lisis de Viana et al. (2019) en Sports Medicine.",
                "Implementa monitoreo de RMR cada 8 semanas para ajustar d√©ficit y prevenir plateau, basado en recomendaciones de M√ºller et al. (2020) en European Journal of Clinical Nutrition."
            ],
            "Fase de Calorie Cycling Din√°mico + Carb Cycling": [
                "Combina ciclados (d√≠as bajos HC: 50-80g, d√≠as medios HC: 100-150g) para definici√≥n efectiva, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
                "Usa targeted carb timing (20-30g HC pre-entrenamiento) para workouts, basado en evidencia de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Incorpora protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) para preservaci√≥n muscular, respaldado por estudios de Mamerow et al. (2014) en Journal of Nutrition.",
                "Implementa 'micro-cycles' de 3-4 d√≠as de ligero d√©ficit (100-200kcal) mensuales para prevenir adaptaci√≥n, seg√∫n evidencia de Helms et al. (2021) en Sports Medicine.",
                "Monitorea indicadores de estr√©s metab√≥lico (cortisol, HRV) para ajustar intensidad del protocolo, basado en estudios de Campbell et al. (2018) en Journal of the International Society of Sports Nutrition."
            ],
            "Dieta Low Carb Ciclada": [
                "Cicla low carb (4 d√≠as 50-70g HC, 2 d√≠as 100-150g HC, 1 d√≠a 200-250g HC) para definici√≥n mixta, con beneficios en p√©rdida de grasa, respaldado por estudios de Zinn et al. (2017) en Journal of the International Society of Sports Nutrition.",
                "Ajusta con refeeds estrat√©gicos (cada 4-6 semanas) para sostenibilidad, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
                "Enf√≥cate en flexibilidad metab√≥lica con rotaciones semanales, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
                "Incorpora protein pacing avanzado (1.8-2.2g/kg distribuidos) para preservaci√≥n muscular, seg√∫n estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
                "Implementa monitoreo de electrolitos y marcadores de estr√©s cada 8 semanas para ajustes precisos, basado en recomendaciones de Devries et al. (2018) en Journal of the International Society of Sports Nutrition."
            ]
        },
        "Fase 3 Mantenimiento Metab√≥lico (24-32 sem)": {
            "Fase de Mantenimiento Metab√≥lico": [
                "Mantiene con flexibilidad metab√≥lica (ciclos semanales de HC) para equilibrio a largo plazo, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
                "Usa intermittent fasting 14-16h m√°ximo 3-4 d√≠as/semana + cycling para control, basado en evidencia de Patterson et al. (2017) en Nutrients.",
                "Optimiza protein pacing (1.8-2.2g/kg distribuidos en 5-6 comidas) y hydration (35ml/kg/d√≠a), respaldado por estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
                "Incorpora 'metabolic challenges' semanales (variaci√≥n de 200-300kcal) para mantener flexibilidad, seg√∫n estudios de M√ºller et al. (2019) en Obesity Reviews.",
                "Monitorea composici√≥n corporal mediante DEXA cada 12 semanas para ajustes precisos, basado en recomendaciones de Heymsfield et al. (2014) en Obesity."
            ]
        },
        "Fase 4 Ajuste Metab√≥lico (>32 sem)": {
            "Fase de Ajuste Metab√≥lico": [
                "Ajusta metab√≥licamente con ciclos avanzados (semanas alternas de 3-4g/kg y 5-6g/kg HC) para objetivos mixtos, respaldado por estudios de Thiel et al. (2021) en Nutrients.",
                "Incluye refeed strategy (cada 4-6 semanas, 24-48h con 110-130% de mantenimiento) para salud, basado en evidencia de Doucet et al. (2009) en International Journal of Obesity.",
                "Enf√≥cate en meal timing personalizado y NEAT (10,000-12,000 pasos/d√≠a) para optimizaci√≥n, respaldado por estudios de Pontzer et al. (2016) en Current Biology.",
                "Implementa monitoreo de marcadores avanzados (HOMA-IR, perfil lip√≠dico completo) cada 12 semanas, seg√∫n recomendaciones de Volek et al. (2016) en Nutritional Metabolism.",
                "Incorpora periodizaci√≥n de suplementos (creatina en d√≠as de fuerza, beta-alanina en d√≠as de resistencia) para optimizar rendimiento, basado en estudios de Trexler et al. (2015) en Journal of the International Society of Sports Nutrition."
            ],
            "Fase de Ciclado Metab√≥lico Avanzado": [
                "Cicla avanzado (3 d√≠as cetog√©nicos, 2 d√≠as carbos moderados, 2 d√≠as carbos altos) para optimizaci√≥n continua, respaldado por estudios de de Luis et al. (2021) en Nutrients.",
                "Combina con dieting flexible (80/20 rule) para adherencia, basado en evidencia de Dunn et al. (2016) en Journal of the Academy of Nutrition and Dietetics.",
                "Usa targeted carbs (20-40g HC pre-entrenamiento) para rendimiento, respaldado por estudios de Grgic et al. (2018) en Journal of the International Society of Sports Nutrition.",
                "Incorpora protein pacing avanzado (0.4-0.55g/kg por comida, 5-6 comidas) para salud muscular, seg√∫n estudios de Witard et al. (2014) en American Journal of Clinical Nutrition.",
                "Implementa monitoreo de RMR y composici√≥n corporal cada 8 semanas para ajustes precisos, basado en recomendaciones de M√ºller et al. (2020) en European Journal of Clinical Nutrition."
            ]
        }
    }
}
// Definir recomendaciones espec√≠ficas seg√∫n objetivo y prop√≥sito
const estrategiaCompleta = {
    perdida: {
        salud: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-sync-alt",
                    title: "Metabolic Flexibility Training",
                    text: "Implementa rotaci√≥n semanal de HC (50-100g) tras 8-12 semanas para evitar adaptaci√≥n metab√≥lica"
                },
                {
                    icon: "fas fa-clock",
                    title: "Ayuno Intermitente",
                    text: "Solo tras 12 semanas de estabilidad con MKD, nunca al inicio"
                },
                {
                    icon: "fas fa-balance-scale",
                    title: "D√©ficit Moderado",
                    text: "Limita el d√©ficit a 300-500 kcal/d√≠a para preservar masa muscular"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "RKD (Dieta Cetog√©nica Estricta) en salud general: Solo para casos m√©dicos espec√≠ficos (epilepsia, c√°ncer). En obesidad, aumenta riesgo de hipercolesterolem√≠a. [NEJM, 2022]",
                    "No recomendado para personas con trastornos alimentarios o historial de atracones",
                    "Requiere supervisi√≥n m√©dica en personas con diabetes tipo 1 o insuficiencia renal"
                ],
                conclusion: "Prioriza MKD (Dieta Cetog√©nica Modificada) + Carb Cycling + Calorie Cycling para salud.",
                ejemplosPracticos: [
                    "Fases iniciales: MKD con 20-25% prote√≠nas, 60-70% grasas, 5-10% HC",
                    "Fases medias: Carb Cycling (5 d√≠as cetosis + 2 d√≠as 50-100g HC)"
                ],
                erroresCriticos: [
                    {
                        titulo: "RKD en salud general",
                        descripcion: "Solo para casos m√©dicos (ej.: epilepsia, c√°ncer). En obesidad, aumenta riesgo de hipercolesterolem√≠a.",
                        fuente: "[NEJM, 2022]"
                    },
                    {
                        titulo: "Ignorar adaptaci√≥n metab√≥lica",
                        descripcion: "Sin ciclado, la TMB ‚Üì un 10-15% tras 24 semanas.",
                        fuente: "[Obesity, 2021]"
                    },
                    {
                        titulo: "Exceso de restricci√≥n",
                        descripcion: "D√©ficit >500 kcal/d√≠a acelera p√©rdida muscular y disminuye T3.",
                        fuente: "[AJCN, 2020]"
                    }
                ]
            }
        },
        estetica: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-fire",
                    title: "Refeed Estrat√©gico",
                    text: "1 d√≠a/semana HC alto (150-200g) tras 2 semanas de d√©ficit o al notar estancamiento"
                },
                {
                    icon: "fas fa-protein",
                    title: "Protein Cycling",
                    text: "4 semanas 2.4g/kg + 1 semana 1.6g/kg. Solo tras >12 semanas de d√©ficit continuo"
                },
                {
                    icon: "fas fa-chart-line",
                    title: "Evita el D√©ficit Est√°tico",
                    text: "Sin ciclado, la TMB ‚Üì un 8-12% tras 12 semanas, frenando la recomposici√≥n"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "RKD: P√©rdida de masa muscular por d√©ficit cal√≥rico extremo y limitaci√≥n de prote√≠nas",
                    "Protein Cycling en fases iniciales: En d√©ficit cal√≥rico agudo, >2.2g/kg no aporta beneficios adicionales y estresa ri√±ones [AJCN, 2020]",
                    "Refeed sin sincronizaci√≥n con entrenamiento: HC alto en d√≠as de descanso ‚Üë grasa corporal en sujetos con historia de obesidad [International Journal of Obesity, 2022]"
                ],
                conclusion: "Fases iniciales: MKD + Carb Cycling (d√≠as de entrenamiento intenso). Fases avanzadas (>12 semanas): Protein Cycling + Refeed estrat√©gico (1 d√≠a/semana HC alto).",
                ejemplosPracticos: [
                    "D√≠a de entrenamiento: 2.4g/kg prote√≠na, 1.2g/kg HC, 0.8g/kg grasas",
                    "D√≠a de refeed: 2.0g/kg prote√≠na, 3.5g/kg HC, 0.6g/kg grasas"
                ],
                erroresCriticos: [
                    {
                        titulo: "Protein Cycling en fases iniciales",
                        descripcion: "En d√©ficit cal√≥rico agudo, >2.2g/kg no aporta beneficios adicionales y estresa ri√±ones.",
                        fuente: "[AJCN, 2020]"
                    },
                    {
                        titulo: "Refeed sin base cient√≠fica",
                        descripcion: "HC alto en d√≠as de descanso ‚Üë grasa corporal en sujetos con historia de obesidad.",
                        fuente: "[International Journal of Obesity, 2022]"
                    },
                    {
                        titulo: "D√©ficit est√°tico",
                        descripcion: "Sin ciclado, la TMB ‚Üì un 8-12% tras 12 semanas, frenando la recomposici√≥n.",
                        fuente: "[Obesity, 2019]"
                    }
                ]
            }
        },
        rendimiento: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-dumbbell",
                    title: "CKD para Fuerza",
                    text: "5 d√≠as cetosis + 1-2 d√≠as carb-loading. Ideal para powerlifting en fase precompetitiva"
                },
                {
                    icon: "fas fa-running",
                    title: "TKD para Deportes Intermittentes",
                    text: "25-50g HC solo alrededor de entrenamientos clave. Ideal para artes marciales y CrossFit"
                },
                {
                    icon: "fas fa-brain",
                    title: "Metabolic Flexibility Training",
                    text: "Rotar semanas de alto volumen (6g/kg HC) con semanas de recuperaci√≥n (3g/kg HC)"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "TKD en deportes de alta intensidad: Los atletas de sprint pierden rendimiento por d√©ficit de gluc√≥geno [Medicine & Science in Sports & Exercise, 2021]",
                    "CKD sin adecuada carga de carbohidratos: Reduce rendimiento en actividades de alta intensidad",
                    "TKD solo recomendado para deportes de intensidad moderada (no para esprints puros)"
                ],
                conclusion: "Deportes de resistencia: Carb Cycling + Timing post-entreno. Fuerza/hipertrofia: CKD + Refeed completo.",
                ejemplosPracticos: [
                    "Deportes de fuerza: 5 d√≠as cetosis + 2 d√≠as carb-loading (8-10g/kg HC)",
                    "Deportes intermitentes: 25-50g HC 30-60 min antes/despu√©s del entreno"
                ],
                erroresCriticos: [
                    {
                        titulo: "TKD en deportes de alta intensidad",
                        descripcion: "Los atletas de sprint pierden rendimiento por d√©ficit de gluc√≥geno.",
                        fuente: "[Medicine & Science in Sports & Exercise, 2021]"
                    },
                    {
                        titulo: "Ignorar la fase deportiva",
                        descripcion: "En lucha, mantener d√©ficit constante ‚Üì fuerza explosiva.",
                        fuente: "[Journal of Strength and Conditioning Research, 2022]"
                    },
                    {
                        titulo: "Exceso de HC en d√≠as de baja intensidad",
                        descripcion: "Reduce eficiencia metab√≥lica y ‚Üë riesgo de grasa visceral.",
                        fuente: "[European Journal of Applied Physiology, 2022]"
                    }
                ]
            }
        }
    },
    ganancia: {
        salud: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-weight",
                    title: "Lean Bulk Controlado",
                    text: "Super√°vit 300-500 kcal/d√≠a. Evita 'Dirty Bulk' que incrementa grasa visceral"
                },
                {
                    icon: "fas fa-utensils",
                    title: "Calorie Cycling",
                    text: "4 d√≠as super√°vit + 3 d√≠as mantenimiento. Ideal para individuos que ganan grasa f√°cilmente"
                },
                {
                    icon: "fas fa-leaf",
                    title: "Nutrient Density Prioritizada",
                    text: "Fibra >30g/d√≠a reduce inflamaci√≥n y mejora salud metab√≥lica"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "\"Dirty Bulk\": Exceso de calor√≠as (>700 kcal/d√≠a) incrementa grasa visceral y riesgo metab√≥lico [Obesity Reviews, 2019]",
                    "Baja ingesta proteica (<1.2g/kg): Asociado a ganancia de peso mayoritariamente grasa [AJCN, 2019]",
                    "Suplementos hipercal√≥ricos no regulados (ej.: 'mass gainers' con alto az√∫car)"
                ],
                conclusion: "Estrategia base: Lean Bulk + Nutrient Timing + Suplementaci√≥n con creatina.",
                ejemplosPracticos: [
                    "Desayuno - Avena (60g) + claras de huevo (6) + aguacate (50g)",
                    "Post-entreno - Suero (30g) + pl√°tano (100g)"
                ],
                erroresCriticos: [
                    {
                        titulo: "\"Dirty Bulk\" en salud",
                        descripcion: "Exceso de calor√≠as (>700 kcal/d√≠a) incrementa grasa visceral y riesgo metab√≥lico.",
                        fuente: "[Obesity Reviews, 2019]"
                    },
                    {
                        titulo: "Baja ingesta proteica",
                        descripcion: "<1.2g/kg asociado a ganancia de peso mayoritariamente grasa.",
                        fuente: "[AJCN, 2019]"
                    },
                    {
                        titulo: "Ignorar densidad nutricional",
                        descripcion: "Prioriza alimentos ricos en nutrientes sobre calor√≠as vac√≠as.",
                        fuente: ""
                    }
                ]
            }
        },
        estetica: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-trophy",
                    title: "Refeed Post-Corte",
                    text: "1-2 d√≠as/semana HC alto (6-8g/kg) tras fase de definici√≥n para normalizar leptina"
                },
                {
                    icon: "fas fa-protein",
                    title: "Protein Cycling Avanzado",
                    text: "4 semanas 2.4-2.6g/kg + 1 semana 1.8g/kg. Solo en fases avanzadas (>20 semanas)"
                },
                {
                    icon: "fas fa-chart-line",
                    title: "Super√°vit Moderado",
                    text: "Limita a 200-300 kcal/d√≠a. Super√°vit >500 kcal: 50% de la ganancia es grasa"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "Super√°vit excesivo (>500 kcal/d√≠a): 50% de la ganancia es grasa [International Journal of Sport Nutrition, 2019]",
                    "Ignorar el 'muscle full signal': M√°s de 40g prote√≠na en una comida no aumenta s√≠ntesis proteica adicional [AJCN, 2020]",
                    "Protein Cycling en fases iniciales: En ganancia inicial, <1.6g/kg prote√≠na reduce la hipertrofia en un 20% [Sports Medicine, 2021]"
                ],
                conclusion: "Fases iniciales: Lean Bulk + Protein Pacing. Fases avanzadas: Carb Cycling + Refeed post-corte.",
                ejemplosPracticos: [
                    "D√≠a de d√©ficit: 2.5g/kg HC + 2.4g/kg prote√≠na",
                    "D√≠a de ligero super√°vit: 3.5g/kg HC + 2.6g/kg prote√≠na"
                ],
                erroresCriticos: [
                    {
                        titulo: "Super√°vit excesivo",
                        descripcion: ">500 kcal/d√≠a incrementa grasa corporal en un 50% de la ganancia total.",
                        fuente: "[JISSN, 2019]"
                    },
                    {
                        titulo: "Ignorar l√≠mite de s√≠ntesis proteica",
                        descripcion: "M√°s de 40g prote√≠na en una sola ingesti√≥n no mejora la hipertrofia.",
                        fuente: "[AJCN, 2020]"
                    },
                    {
                        titulo: "Protein Cycling en fases iniciales",
                        descripcion: "En ganancia inicial, <1.6g/kg prote√≠na reduce la hipertrofia en un 20%.",
                        fuente: "[Sports Medicine, 2021]"
                    }
                ]
            }
        },
        rendimiento: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-calendar-alt",
                    title: "Periodizaci√≥n Cal√≥rica",
                    text: "Alinea super√°vit con fases deportivas espec√≠ficas. Cr√≠tico para evitar p√©rdida de rendimiento"
                },
                {
                    icon: "fas fa-dumbbell",
                    title: "CKD para Fuerza",
                    text: "5 d√≠as cetosis + 2 d√≠as carb-loading. Mejor recuperaci√≥n que dieta est√°ndar en fuerza pura"
                },
                {
                    icon: "fas fa-hydrate",
                    title: "Targeted Carb Timing",
                    text: "25-50g HC alrededor de la sesi√≥n de entrenamiento. Esencial para rendimiento sin exceso de HC"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "Ignorar la relaci√≥n fuerza-peso: En deportes como gimnasia, ganar peso sin control afecta movilidad [Journal of Strength and Conditioning Research, 2021]",
                    "Exceso de HC en d√≠as de baja intensidad: Reduce eficiencia metab√≥lica [European Journal of Applied Physiology, 2022]",
                    "Carb Loading sin justificaci√≥n deportiva: En powerlifting, reduce eficiencia metab√≥lica [European Journal of Applied Physiology, 2022]"
                ],
                conclusion: "Deportes de fuerza pura (ej.: powerlifting): Periodizaci√≥n cal√≥rica + Carb Loading. Deportes de potencia (ej.: saltos): Nutrient Timing pre/post-entreno + Protein Cycling.",
                ejemplosPracticos: [
                    "Fase pre-competici√≥n: 8-10g/kg HC 24-48h antes de competici√≥n",
                    "D√≠a de entrenamiento intenso: 25-50g HC 30-60 min antes/despu√©s del entreno"
                ],
                erroresCriticos: [
                    {
                        titulo: "Ignorar relaci√≥n fuerza-peso",
                        descripcion: "En deportes como gimnasia, ganar peso sin control afecta movilidad.",
                        fuente: "[Journal of Strength and Conditioning Research, 2021]"
                    },
                    {
                        titulo: "Exceso de HC en d√≠as de baja intensidad",
                        descripcion: "Reduce eficiencia metab√≥lica.",
                        fuente: "[European Journal of Applied Physiology, 2022]"
                    },
                    {
                        titulo: "Carb Loading sin justificaci√≥n",
                        descripcion: "En powerlifting, el exceso de HC en d√≠as no clave reduce eficiencia metab√≥lica.",
                        fuente: "[European Journal of Applied Physiology, 2022]"
                    }
                ]
            }
        }
    },
    mantenimiento: {
        salud: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-sync-alt",
                    title: "Metabolic Flexibility Training",
                    text: "Rotar ingesta de HC semanalmente (3g/kg ‚Üí 5g/kg ‚Üí 4g/kg) para entrenar el metabolismo"
                },
                {
                    icon: "fas fa-clock",
                    title: "Ayuno Intermitente Moderado",
                    text: "14:10, 2-3 d√≠as/semana para mantener sensibilidad a la insulina sin d√©ficit inadvertido"
                },
                {
                    icon: "fas fa-walking",
                    title: "NEAT Optimization",
                    text: "Compensa adaptaci√≥n metab√≥lica post-p√©rdida con +5,000 pasos/d√≠a"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "Ignorar la adaptaci√≥n metab√≥lica: Tras p√©rdida de peso, la TMB se reduce un 5-15% [Obesity, 2018]",
                    "Baja ingesta de fibra (<25g/d√≠a): Asociado a ‚Üë riesgo de s√≠ndrome metab√≥lico [AJCN, 2020]",
                    "Dietas hiperproteicas (>2.2g/kg) sin justificaci√≥n cl√≠nica (riesgo renal)"
                ],
                conclusion: "Estrategia base: Flexible Dieting + Calorie Cycling + NEAT Optimization.",
                ejemplosPracticos: [
                    "Desayuno - Avena (50g) + frutos rojos (100g) + almendras (20g)",
                    "Merienda - Yogur griego (200g) + semillas de ch√≠a (10g)"
                ],
                erroresCriticos: [
                    {
                        titulo: "Ignorar adaptaci√≥n metab√≥lica",
                        descripcion: "La TMB se reduce un 5-15% tras p√©rdida de peso.",
                        fuente: "[Obesity, 2018]"
                    },
                    {
                        titulo: "Baja ingesta de fibra",
                        descripcion: "<25g/d√≠a asociado a ‚Üë riesgo de s√≠ndrome metab√≥lico.",
                        fuente: "[AJCN, 2020]"
                    },
                    {
                        titulo: "Dietas hiperproteicas",
                        descripcion: ">2.2g/kg sin justificaci√≥n cl√≠nica aumenta riesgo renal.",
                        fuente: ""
                    }
                ]
            }
        },
        estetica: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-fire",
                    title: "Refeed Estrat√©gico",
                    text: "1 d√≠a/semana HC alto (4-5g/kg) para regular leptina y estado de √°nimo en % grasa bajo"
                },
                {
                    icon: "fas fa-protein",
                    title: "Protein Cycling",
                    text: "4 semanas 2.2g/kg + 1 semana 1.8g/kg. Solo para atletas avanzados (>2 a√±os experiencia)"
                },
                {
                    icon: "fas fa-chart-line",
                    title: "Evita Refeed Excesivo",
                    text: "Refeed >6g/kg HC ‚Üë grasa en sujetos con historia de d√©ficit prolongado"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "Ignorar el 'muscle full signal': M√°s de 40g prote√≠na en una comida no aporta beneficios adicionales [AJCN, 2020]",
                    "Refeed excesivo (>6g/kg HC): Genera ganancia de grasa en sujetos con historia de d√©ficit prolongado [International Journal of Sport Nutrition, 2021]",
                    "Dietas cetog√©nicas estrictas en mantenimiento (‚Üì s√≠ntesis proteica)"
                ],
                conclusion: "Estrategia base: Protein Pacing + Refeed semanal + Carb Cycling.",
                ejemplosPracticos: [
                    "D√≠a de entrenamiento - 4g/kg HC + 2.2g/kg prote√≠na",
                    "D√≠a de refeed - 5g/kg HC + 1.8g/kg prote√≠na"
                ],
                erroresCriticos: [
                    {
                        titulo: "Ignorar el 'muscle full signal'",
                        descripcion: "M√°s de 40g prote√≠na en una comida no aporta beneficios adicionales.",
                        fuente: "[AJCN, 2020]"
                    },
                    {
                        titulo: "Refeed excesivo",
                        descripcion: ">5g/kg HC en refeed post-d√©ficit incrementa grasa corporal.",
                        fuente: "[International Journal of Obesity, 2021]"
                    },
                    {
                        titulo: "Dietas cetog√©nicas estrictas",
                        descripcion: "En mantenimiento, reducen s√≠ntesis proteica.",
                        fuente: ""
                    }
                ]
            }
        },
        rendimiento: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-calendar-alt",
                    title: "Periodizaci√≥n Nutricional",
                    text: "Ajusta HC seg√∫n calendario deportivo (temporada vs. off-season) para optimizar rendimiento"
                },
                {
                    icon: "fas fa-hydrate",
                    title: "Carb Loading Ocasional",
                    text: "24-48h pre-competici√≥n: 8-10g/kg HC. ‚Üë rendimiento en un 3-5% en deportes de resistencia"
                },
                {
                    icon: "fas fa-balance-scale",
                    title: "Hydration Strategy",
                    text: "1.5L agua + 500-700mg sodio diario. Clave para evitar fluctuaciones por retenci√≥n h√≠drica"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "Ignorar la variabilidad estacional: En deportes como el boxeo, mantener peso bajo en √©pocas no competitivas reduce resistencia [Journal of Sports Sciences, 2021]",
                    "Exceso de HC en d√≠as de baja intensidad: Reduce eficiencia metab√≥lica y ‚Üë riesgo de grasa visceral [European Journal of Applied Physiology, 2022]",
                    "Falta de periodizaci√≥n nutricional: No alinear con ciclos de entrenamiento y competici√≥n"
                ],
                conclusion: "Deportes de resistencia: Periodizaci√≥n nutricional + Carb Loading pre-competici√≥n. Deportes de fuerza: Protein Pacing + Nutrient Timing post-entreno.",
                ejemplosPracticos: [
                    "Fase pre-competici√≥n: 8-10g/kg HC 24-48h antes de competici√≥n",
                    "D√≠a de baja intensidad: 3g/kg HC + 2.2g/kg prote√≠na"
                ],
                erroresCriticos: [
                    {
                        titulo: "Ignorar variabilidad estacional",
                        descripcion: "En boxeo, mantener peso bajo en √©pocas no competitivas reduce resistencia.",
                        fuente: "[Journal of Sports Sciences, 2021]"
                    },
                    {
                        titulo: "Falta de periodizaci√≥n",
                        descripcion: "Mantener HC altos en d√≠as de baja intensidad reduce eficiencia metab√≥lica.",
                        fuente: "[European Journal of Applied Physiology, 2022]"
                    },
                    {
                        titulo: "Ignorar la fase deportiva",
                        descripcion: "En lucha, mantener d√©ficit constante ‚Üì fuerza explosiva.",
                        fuente: "[Journal of Strength and Conditioning Research, 2022]"
                    }
                ]
            }
        }
    },
    mixto: {
        salud: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-sync-alt",
                    title: "Calorie Cycling Din√°mico",
                    text: "3 d√≠as d√©ficit + 2 d√≠as mantenimiento + 2 d√≠as ligero super√°vit. Permite ganancia muscular en sedentarios"
                },
                {
                    icon: "fas fa-protein",
                    title: "MKD en D√≠as de Descanso",
                    text: "40g HC en d√≠as de descanso para enfatizar oxidaci√≥n de grasas"
                },
                {
                    icon: "fas fa-brain",
                    title: "Inflamaci√≥n Cr√≥nica",
                    text: "Asegura >1.5g/d√≠a de omega-3 para mejorar eficacia de la recomposici√≥n"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "D√©ficit excesivo (>500 kcal/d√≠a): Acelera p√©rdida muscular y disminuye T3 [AJCN, 2020]",
                    "Ignorar la inflamaci√≥n cr√≥nica: Baja ingesta de omega-3 (<1.5g/d√≠a) reduce eficacia [Nutrients, 2021]",
                    "Dietas cetog√©nicas estrictas (‚Üì s√≠ntesis proteica en sujetos no adaptados)"
                ],
                conclusion: "Estrategia base: D√©ficit moderado + Protein Pacing + Metabolic Flexibility Training.",
                ejemplosPracticos: [
                    "Desayuno - Avena (40g) + claras (4) + espinacas (100g)",
                    "Post-entreno - Suero (25g) + pl√°tano (75g)"
                ],
                erroresCriticos: [
                    {
                        titulo: "D√©ficit excesivo",
                        descripcion: ">500 kcal/d√≠a acelera p√©rdida muscular y disminuye T3.",
                        fuente: "[AJCN, 2020]"
                    },
                    {
                        titulo: "Ignorar inflamaci√≥n cr√≥nica",
                        descripcion: "Baja ingesta de omega-3 (<1.5g/d√≠a) reduce eficacia.",
                        fuente: "[Nutrients, 2021]"
                    },
                    {
                        titulo: "D√©ficit est√°tico",
                        descripcion: "Sin ciclado, la TMB ‚Üì un 10-15% tras 24 semanas.",
                        fuente: "[Obesity, 2021]"
                    }
                ]
            }
        },
        estetica: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-chart-line",
                    title: "Protocolo de Adaptaci√≥n Metab√≥lica",
                    text: "1 semana mantenimiento cada 8 semanas. Previene adaptaci√≥n renal y mantiene progresi√≥n"
                },
                {
                    icon: "fas fa-fire",
                    title: "Refeed Post-Entreno",
                    text: "25-50g HC post-entreno intenso. Maximiza recarga de gluc√≥geno sin impacto en grasa"
                },
                {
                    icon: "fas fa-balance-scale",
                    title: "Evita Super√°vit en D√≠as de Descanso",
                    text: "Rompe d√©ficit neto necesario para la recomposici√≥n"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "D√©ficit est√°tico: Sin ciclado, la TMB ‚Üì un 8-12% tras 12 semanas [Obesity, 2019]",
                    "Refeed sin sincronizaci√≥n con entrenamiento: HC alto en d√≠as de descanso ‚Üë grasa corporal [International Journal of Obesity, 2022]",
                    "Super√°vit cal√≥rico en d√≠as de descanso (rompe d√©ficit neto)"
                ],
                conclusion: "Estrategia base: Calorie Cycling + Protein Cycling + Refeed post-entreno.",
                ejemplosPracticos: [
                    "D√≠a de d√©ficit - 2.5g/kg HC + 2.4g/kg prote√≠na",
                    "D√≠a de ligero super√°vit - 3.5g/kg HC + 2.6g/kg prote√≠na"
                ],
                erroresCriticos: [
                    {
                        titulo: "D√©ficit est√°tico",
                        descripcion: "Sin ciclado, la TMB ‚Üì un 8-12% tras 12 semanas.",
                        fuente: "[Obesity, 2019]"
                    },
                    {
                        titulo: "Refeed sin sincronizaci√≥n",
                        descripcion: "HC alto en d√≠as de descanso ‚Üë grasa corporal.",
                        fuente: "[International Journal of Obesity, 2022]"
                    },
                    {
                        titulo: "Super√°vit en d√≠as de descanso",
                        descripcion: "Rompe d√©ficit neto necesario para la recomposici√≥n.",
                        fuente: ""
                    }
                ]
            }
        },
        rendimiento: {
            resumenEjecutivo: [
                {
                    icon: "fas fa-dumbbell",
                    title: "CKD para Recomposici√≥n",
                    text: "5 d√≠as cetosis + 2 d√≠as carb-loading. Mantiene fuerza en d√©ficit para atletas de fuerza"
                },
                {
                    icon: "fas fa-brain",
                    title: "Metabolic Flexibility Avanzado",
                    text: "Alternar periodos cetog√©nicos con periodos altos en HC seg√∫n calendario deportivo"
                },
                {
                    icon: "fas fa-hydrate",
                    title: "Electrolitos y Hidrataci√≥n",
                    text: "Asegura adecuada ingesta de electrolitos para evitar calambres y mantener rendimiento"
                }
            ],
            analisisCompleto: {
                contraindicaciones: [
                    "Ignorar la carga de entrenamiento: HC altos en d√≠as de baja intensidad ‚Üì eficiencia metab√≥lica [Journal of Sports Sciences, 2021]",
                    "Baja ingesta de electrolitos: Aumenta riesgo de calambres y ‚Üì rendimiento en d√©ficit [Sports Medicine, 2020]",
                    "Falta de alineaci√≥n con fase deportiva espec√≠fica"
                ],
                conclusion: "Deportes de fuerza: Periodizaci√≥n nutricional + Targeted Carb Timing. Deportes de resistencia: Carb Cycling + Creatina.",
                ejemplosPracticos: [
                    "Deportes de fuerza: 5 d√≠as cetosis + 2 d√≠as carb-loading",
                    "D√≠a de entrenamiento intenso: 25-50g HC 30-60 min antes/despu√©s del entreno"
                ],
                erroresCriticos: [
                    {
                        titulo: "Ignorar carga de entrenamiento",
                        descripcion: "HC altos en d√≠as de baja intensidad ‚Üì eficiencia metab√≥lica.",
                        fuente: "[Journal of Sports Sciences, 2021]"
                    },
                    {
                        titulo: "Baja ingesta de electrolitos",
                        descripcion: "Aumenta riesgo de calambres y ‚Üì rendimiento en d√©ficit.",
                        fuente: "[Sports Medicine, 2020]"
                    },
                    {
                        titulo: "Ignorar la fase deportiva",
                        descripcion: "En lucha, mantener d√©ficit constante ‚Üì fuerza explosiva.",
                        fuente: "[Journal of Strength and Conditioning Research, 2022]"
                    }
                ]
            }
        }
    }
};

const nombreEstrategiaBaseMap = {
    // Para P√©rdida
    "Fase MKD Inicial": "Modified Ketogenic Diet",
    //"Fase de Ciclado Metab√≥lico inicial": "Metabolic Flexibility Training",
    "Dieta Low Carb General": "Dieta Low Carb General",
    "Fase de Transici√≥n a Mantenimiento": "Metabolic Flexibility Training",

    // Variaciones comunes para P√©rdida
    "Fase MKD": "Modified Ketogenic Diet",
    "MKD Inicial": "Modified Ketogenic Diet",
    "Ciclado Metab√≥lico": "Metabolic Flexibility Training",
    "Ciclado Metab√≥lico inicial": "Metabolic Flexibility Training",
    "Low Carb": "Low Carb Diet",
    "Dieta Low Carb": "Low Carb Diet",
    "Dieta Low Carb": "Dieta Low Carb General",

    // Para Ganancia
    "Lean Bulk Controlado": "Super√°vit Controlado con √ânfasis en Prote√≠na",
    //"Fase de Ciclado Metab√≥lico para Ganancia": "Metabolic Flexibility Training",
    //"Fase de Ajuste Metab√≥lico para Ganancia": "Super√°vit con Enfoque en Carbohidratos",

    // Variaciones comunes para Ganancia
    "Bulk Controlado": "Super√°vit Controlado con √ânfasis en Prote√≠na",
    "Lean Bulk": "Super√°vit Controlado con √ânfasis en Prote√≠na",
    "Ciclado Metab√≥lico Ganancia": "Metabolic Flexibility Training",

    // Para Mantenimiento
    "Flexible Dieting + Dieta Equilibrada": "Flexible Dieting + Dieta Equilibrada",
    "Metabolic Flexibility Training": "Metabolic Flexibility Training",
    "Fase de Ajuste Metab√≥lico para Mantenimiento": "Flexible Dieting + Calorie Cycling",

    // Variaciones comunes para Mantenimiento
    "Flexible Dieting": "Flexible Dieting + Dieta Equilibrada",
    "Dieta Equilibrada": "Flexible Dieting + Dieta Equilibrada",
    "Ajuste Metab√≥lico Mantenimiento": "Flexible Dieting + Calorie Cycling",

    // Para Mixto
    "D√©ficit Moderado + Protein Pacing": "D√©ficit Moderado + Protein Pacing",
    "Calorie Cycling Din√°mico": "Calorie Cycling Din√°mico",
    "Fase de Ajuste Metab√≥lico para Mixto": "Metabolic Flexibility Training",

    // Variaciones comunes para Mixto
    "D√©ficit + Protein Pacing": "D√©ficit Moderado + Protein Pacing",
    "Ciclo Cal√≥rico Din√°mico": "Calorie Cycling Din√°mico",
    "Ajuste Metab√≥lico Mixto": "Metabolic Flexibility Training",


    // Para P√©rdida
    "Fase MKD Inicial": "Modified Ketogenic Diet",
    //"Fase de Ciclado Metab√≥lico inicial": "Fase de Ciclado Metab√≥lico inicial",
    //"Fase de Ciclado Metab√≥lico": "Fase de Ciclado Metab√≥lico inicial",

    "Dieta Low Carb Ciclada": "Dieta Low Carb Ciclada",
    "Fase de Transici√≥n a Mantenimiento": "Fase de Transici√≥n a Mantenimiento",
    //"Fase de Ajuste Metab√≥lico":"Metabolic Adaptation Protocol",

    // Para Ganancia
    "Fase Lean Bulk Controlado": "Fase Lean Bulk Controlado",
    //"Fase de Ciclado Metab√≥lico": "Fase de Ciclado Metab√≥lico Ganancia",
    "Fase de Ajuste Metab√≥lico para Ganancia": "Super√°vit con Enfoque en Carbohidratos",
    "Fase de Volumen Hiperproteico": "Super√°vit Controlado con √ânfasis en Prote√≠na",
    "Fase de Volumen con alto en HC": "Super√°vit con Enfoque en Carbohidratos",
    "Fase de Mantenimiento y Reajuste": "Fase de Mantenimiento y Reajuste",
    "Fase Lean Bulk Controlado": "",
    //"Fase de Ciclado Metab√≥lico":"Metabolic Flexibility Training",


    // Para Mantenimiento
    "Fase de Flexible Dieting": "Fase de Flexible Dieting",
    "Fase de Metabolic Flexibility Training": "Metabolic Flexibility Training",
    "Fase de Dieta Equilibrada": "Fase de Dieta Equilibrada",
    "Fase de Ajuste Metab√≥lico para Mantenimiento": "Flexible Dieting + Calorie Cycling",


    "Fase de Calorie Cycling Din√°mico": "",

    // Para Mixto
    "Fase de Volumen Controlado": "Lean Bulk Controlado2",
    "Fase de Ciclado Metab√≥lico": "Fase de Ciclado Metab√≥lico",
    "Fase de Calorie Cycling Din√°mico": "Calorie Cycling Din√°mico + Carb Cycling",

    "Fase de Mantenimiento Metab√≥lico": "Metabolic Flexibility Training",
    //"Fase de Ajuste Metab√≥lico":"Metabolic Adaptation Protocol",
    "Fase de Ciclado Metab√≥lico Avanzado": "Metabolic Adaptation Protocol + Ciclado Avanzado",
};

// Matriz de informaci√≥n organizada por bloque, objetivo y prop√≥sito
const infoMatrix = {
    "cetogenicas": {
        "perdida": {
            "salud": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "P√©rdida acelerada de peso, control gluc√©mico superior, reducci√≥n de inflamaci√≥n y triglic√©ridos, prevenci√≥n de diabetes tipo 2 y mejora en marcadores cardiometab√≥licos como presi√≥n arterial",
                "recomendada": "Fases iniciales (0-12 semanas)",
                "justificacion": "Inducen cetosis para r√°pida p√©rdida de grasa y mejora en insulina/triglic√©ridos; TKD/CKD para sostenibilidad, respaldado por meta-an√°lisis con ~1-2 kg/semana inicial sin impacto significativo en masa magra si se combina con entrenamiento de fuerza, seg√∫n RCTs en poblaciones con sobrepeso"
            },
            "estetica": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Definici√≥n muscular mejorada, reducci√≥n de grasa visceral y abdominal, mejora en composici√≥n corporal con preservaci√≥n de masa magra",
                "recomendada": "Fases intermedias (12-24 semanas)",
                "justificacion": "TKD/CKD optimizan composici√≥n corporal sin p√©rdida muscular, con evidencia de estudios mostrando mejor adherencia y prevenci√≥n de plateaus, resultando en ~5-10% mayor p√©rdida de grasa vs. dietas lineales"
            },
            "rendimiento": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Optimizaci√≥n de fuerza y resistencia sin fatiga, mejora en recuperaci√≥n muscular y eficiencia energ√©tica durante entrenamientos",
                "recomendada": "Fases avanzadas (>24 semanas)",
                "justificacion": "TKD/CKD mejoran recuperaci√≥n y NEAT para gasto energ√©tico sostenido, respaldado por RCTs mostrando ~15-20% mejora en VO2 max adaptado en atletas en cetosis moderada"
            }
        },
        "ganancia": {
            "salud": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Equilibrio metab√≥lico, prevenci√≥n de exceso de grasa acumulada, mejora en sensibilidad a insulina durante super√°vit cal√≥rico",
                "recomendada": "Fases intermedias (8-20 semanas)",
                "justificacion": "CKD equilibra insulina y previene exceso de grasa, con evidencia en atletas mostrando menor acumulaci√≥n de grasa visceral (~20% menos vs. dietas altas en carbs)"
            },
            "estetica": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Ganancia muscular con m√≠nima grasa, mejora en hipertrofia est√©tica y definici√≥n en bulk lean",
                "recomendada": "Fases iniciales (0-8 semanas)",
                "justificacion": "CKD/TKD permiten ganancia muscular con m√≠nima grasa (~0.5-1 kg m√∫sculo/semana), respaldado por estudios en bodybuilders"
            },
            "rendimiento": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Optimizaci√≥n de recuperaci√≥n, fuerza y resistencia en entrenamientos de hipertrofia",
                "recomendada": "Fases avanzadas (>20 semanas)",
                "justificacion": "TKD optimiza recuperaci√≥n post-entreno, con meta-an√°lisis mostrando ~20% mejora en performance anaer√≥bica en cetosis"
            }
        },
        "mantenimiento": {
            "salud": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Mantenimiento de homeostasis, reducci√≥n de riesgos cardiovasculares, estabilizaci√≥n metab√≥lica post-p√©rdida",
                "recomendada": "Fases avanzadas (18+ meses)",
                "justificacion": "MKD mantiene homeostasis y reduce riesgos CVD, con estudios longitudinales mostrando ~20% menor riesgo de diabetes"
            },
            "estetica": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Mantenimiento de composici√≥n corporal, prevenci√≥n de fluctuaciones de grasa y preservaci√≥n de definici√≥n",
                "recomendada": "Fases intermedias (6-18 meses)",
                "justificacion": "MKD evita fluctuaciones de grasa, con RCTs mostrando ~10% mejor retenci√≥n de masa magra"
            },
            "rendimiento": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Mantenimiento de energ√≠a para entrenamiento sin exceso cal√≥rico, optimizaci√≥n de VO2 max",
                "recomendada": "Fases iniciales (0-6 meses)",
                "justificacion": "MKD/CKD mantienen energ√≠a para entrenamiento, con ~15% mejora en eficiencia energ√©tica en atletas"
            }
        },
        "mixto": {
            "salud": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Equilibrio en recomposici√≥n, mejora en uso de combustibles mixtos y sensibilidad insulina",
                "recomendada": "Fases intermedias (12-24 semanas)",
                "justificacion": "TKD/CKD mejoran homeostasis en recomposici√≥n, con ~25% mejor equilibrio metab√≥lico"
            },
            "estetica": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Optimizaci√≥n de definici√≥n muscular sin p√©rdida de masa magra, mejora en recomposici√≥n lean",
                "recomendada": "Fases avanzadas (>24 semanas)",
                "justificacion": "TKD optimiza definici√≥n, con meta-an√°lisis mostrando ~1-2% ganancia LBM y ~3% p√©rdida grasa simult√°nea"
            },
            "rendimiento": {
                "fin": "Enfocadas en cetosis (quema de grasa como energ√≠a principal), ideales para fases cortas de restricci√≥n de carbs (~20-100 g/d√≠a). Recomendadas para p√©rdida agresiva o control gluc√©mico, pero con riesgos como fatiga inicial si no se adaptan",
                "proposito": "Recuperaci√≥n en entrenamientos mixtos (fuerza/resistencia), optimizaci√≥n de gluc√≥geno",
                "recomendada": "Fases iniciales (0-12 semanas)",
                "justificacion": "TKD/CKD permiten recuperaci√≥n en entrenamientos mixtos, con ~20% mejor recuperaci√≥n post-ejercicio"
            }
        }
    },
    "ciclado": {
        "perdida": {
            "salud": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Control gluc√©mico sostenido, reducci√≥n de riesgos metab√≥licos, prevenci√≥n de estancamientos en dietas restrictivas y mejora en marcadores inflamatorios",
                "recomendada": "Fases intermedias (12-24 semanas)",
                "justificacion": "Carb/Calorie Cycling previene adaptaciones y optimiza composici√≥n corporal sin p√©rdida muscular, con RCTs mostrando ~15% menor riesgo de estancamiento metab√≥lico"
            },
            "estetica": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Optimizaci√≥n de definici√≥n y reducci√≥n de grasa sin plateaus, mejora en est√©tica corporal",
                "recomendada": "Fases iniciales (0-12 semanas)",
                "justificacion": "Carb Cycling permite definici√≥n sin p√©rdida muscular, con evidencia mostrando ~5-10% mayor p√©rdida de grasa vs. dietas lineales"
            },
            "rendimiento": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Mejora en recuperaci√≥n y gasto energ√©tico sostenido, optimizaci√≥n de fuerza/resistencia",
                "recomendada": "Fases avanzadas (>24 semanas)",
                "justificacion": "Metabolic Flexibility Training mejora uso combustibles, con RCTs mostrando ~15% mejora en VO2 max"
            }
        },
        "ganancia": {
            "salud": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Equilibrio insulina, prevenci√≥n exceso grasa en super√°vit, mejora sensibilidad insulina",
                "recomendada": "Fases intermedias (8-20 semanas)",
                "justificacion": "Calorie/Protein Cycling equilibra insulina, con evidencia en atletas mostrando ~20% menos acumulaci√≥n grasa visceral"
            },
            "estetica": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Ganancia muscular con m√≠nima grasa, mejora en hipertrofia est√©tica",
                "recomendada": "Fases iniciales (0-8 semanas)",
                "justificacion": "Carb Cycling permite bulk lean, con estudios mostrando ~0.5-1 kg m√∫sculo/semana"
            },
            "rendimiento": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Optimizaci√≥n recuperaci√≥n y fuerza, mejora en rendimiento anaer√≥bico",
                "recomendada": "Fases avanzadas (>20 semanas)",
                "justificacion": "Metabolic Flexibility Training mejora uso combustibles en entrenamiento prolongado, con ~20% mejor recuperaci√≥n"
            }
        },
        "mantenimiento": {
            "salud": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Estabilizaci√≥n metab√≥lica, reducci√≥n riesgos CVD, prevenci√≥n regain",
                "recomendada": "Fases avanzadas (18+ meses)",
                "justificacion": "Calorie Cycling mantiene homeostasis, con evidencia longitudinal mostrando ~20% menor riesgo de regain"
            },
            "estetica": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Prevenci√≥n fluctuaciones grasa corporal, mantenimiento definici√≥n",
                "recomendada": "Fases intermedias (6-18 meses)",
                "justificacion": "Metabolic Flexibility Training evita fluctuaciones, con RCTs mostrando ~10% mejor retenci√≥n masa magra"
            },
            "rendimiento": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Mantenimiento energ√≠a entrenamiento, optimizaci√≥n VO2 max",
                "recomendada": "Fases iniciales (0-6 meses)",
                "justificacion": "Protein Cycling mantiene performance estable, con ~15% mejora en eficiencia energ√©tica"
            }
        },
        "mixto": {
            "salud": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Mejora uso combustibles mixtos, equilibrio en recomposici√≥n",
                "recomendada": "Fases intermedias (12-24 semanas)",
                "justificacion": "Metabolic Flexibility Training y Carb Cycling para homeostasis, con ~25% mejor equilibrio metab√≥lico"
            },
            "estetica": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Optimizaci√≥n definici√≥n sin p√©rdida masa, mejora recomposici√≥n lean",
                "recomendada": "Fases avanzadas (>24 semanas)",
                "justificacion": "Calorie Cycling optimiza definici√≥n, con meta-an√°lisis mostrando ~1-2% ganancia LBM y ~3% p√©rdida grasa"
            },
            "rendimiento": {
                "fin": "Alternan nutrientes para evitar adaptaciones metab√≥licas y plateaus. √ötiles para recomposici√≥n y rendimiento, mejorando el uso de grasas/carbs como combustible",
                "proposito": "Recuperaci√≥n entrenamientos mixtos (fuerza/resistencia)",
                "recomendada": "Fases iniciales (0-12 semanas)",
                "justificacion": "Protein Cycling para performance dual, con ~20% mejor recuperaci√≥n post-ejercicio"
            }
        }
    },
    "timing": {
        "perdida": {
            "salud": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Mejora en control gluc√©mico, reducci√≥n inflamaci√≥n, optimizaci√≥n metab√≥lica y manejo de apetito",
                "recomendada": "Fases avanzadas (>24 semanas)",
                "justificacion": "IF + Cycling y Meal Timing mejoran recuperaci√≥n y NEAT para gasto energ√©tico sostenido, con RCTs mostrando ~20% mayor adherencia en mantenimiento de peso perdido"
            },
            "estetica": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Reducci√≥n grasa visceral, mejora composici√≥n corporal, definici√≥n sostenible",
                "recomendada": "Fases intermedias (12-24 semanas)",
                "justificacion": "Refeed Strategy y Flexible Dieting 80/20 optimizan definici√≥n, con evidencia mostrando ~5-10% mayor p√©rdida grasa localizada"
            },
            "rendimiento": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Optimizaci√≥n fuerza/resistencia sin fatiga, mejora recuperaci√≥n inmediata",
                "recomendada": "Fases iniciales (0-12 semanas)",
                "justificacion": "Protein Pacing y Meal Timing para recuperaci√≥n inmediata, con ~20% mejora en fuerza post-entreno"
            }
        },
        "ganancia": {
            "salud": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Prevenci√≥n exceso grasa, mejora sensibilidad insulina en super√°vit",
                "recomendada": "Fases avanzadas (>20 semanas)",
                "justificacion": "NEAT Optimization y Hydration Strategy para equilibrio, con ~20% menor acumulaci√≥n grasa visceral"
            },
            "estetica": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Ganancia muscular con m√≠nima grasa, mejora hipertrofia est√©tica",
                "recomendada": "Fases intermedias (8-20 semanas)",
                "justificacion": "Intermittent Fasting + Cycling para definici√≥n en bulk, con ~0.5-1 kg m√∫sculo/semana"
            },
            "rendimiento": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Mejora recuperaci√≥n y fuerza, optimizaci√≥n rendimiento anaer√≥bico",
                "recomendada": "Fases iniciales (0-8 semanas)",
                "justificacion": "Meal Timing Optimization para post-entreno, con ~20% mejora en recuperaci√≥n"
            }
        },
        "mantenimiento": {
            "salud": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Reducci√≥n riesgos CVD, estabilizaci√≥n metab√≥lica, prevenci√≥n regain",
                "recomendada": "Fases avanzadas (18+ meses)",
                "justificacion": "Flexible Dieting 80/20 y Hydration para homeostasis, con ~20% menor riesgo de regain"
            },
            "estetica": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Prevenci√≥n fluctuaciones grasa, mantenimiento definici√≥n",
                "recomendada": "Fases intermedias (6-18 meses)",
                "justificacion": "Refeed Strategy para mantenimiento composici√≥n, con ~10% mejor retenci√≥n masa magra"
            },
            "rendimiento": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Mantenimiento energ√≠a entrenamiento, optimizaci√≥n VO2 max",
                "recomendada": "Fases iniciales (0-6 meses)",
                "justificacion": "Protein Pacing para performance estable, con ~15% mejora en eficiencia energ√©tica"
            }
        },
        "mixto": {
            "salud": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Mejora uso combustibles mixtos, equilibrio en recomposici√≥n",
                "recomendada": "Fases intermedias (12-24 semanas)",
                "justificacion": "Intermittent Fasting + Cycling para homeostasis, con ~25% mejor equilibrio metab√≥lico"
            },
            "estetica": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Optimizaci√≥n definici√≥n sin p√©rdida masa, mejora recomposici√≥n lean",
                "recomendada": "Fases avanzadas (>24 semanas)",
                "justificacion": "Refeed y NEAT para definici√≥n sostenida, con ~1-2% ganancia LBM y ~3% p√©rdida grasa"
            },
            "rendimiento": {
                "fin": "Optimizan el 'cu√°ndo' comer/moverse para maximizar saciedad, recuperaci√≥n y gasto energ√©tico. Ideales para sostenibilidad y rendimiento a largo plazo",
                "proposito": "Recuperaci√≥n entrenamientos mixtos (fuerza/resistencia)",
                "recomendada": "Fases iniciales (0-12 semanas)",
                "justificacion": "Meal Timing Optimization para performance dual, con ~20% mejor recuperaci√≥n post-ejercicio"
            }
        }
    }
};

// ===== DATOS ESTRUCTURADOS PARA SECCIONES DIN√ÅMICAS =====
const estrategiasEspecificasPorObjetivoProposito = {
    perdida: {
        salud: {
            recomendaciones: [
                "Metabolic Flexibility Training (rotaci√≥n semanal HC)",
                "Intermittent Fasting + Cycling (5 d√≠as 16:8 + 2 d√≠as normales)",
                "Meal Timing Optimization (ventana 12h, post-entreno prioritario)"
            ],
            advertencias: [
                "MKD > RKD: Evita d√©ficit severo en salud general (AJCN, 2021).",
                "IF solo en fases medias: En inicio, prioriza regularidad alimentaria (Obesity Reviews, 2022)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Refeed Strategy (1 d√≠a/semana HC alto: 150-200g)",
                "Protein Cycling (4 semanas 2.4g/kg + 1 semana 1.6g/kg)",
                "Modified Ketogenic Diet + Timing Post-Entreno (30g prote√≠na + 25g HC)"
            ],
            advertencias: [
                "Refeed post-entreno: Mejor que refeed aleatorio (JISSN, 2021).",
                "Evita RKD: P√©rdida muscular en d√©ficit severo (Sports Medicine, 2020)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Cyclic Ketogenic Diet (CKD) (5 d√≠as cetosis + 1-2 d√≠as carb-loading)",
                "Targeted Ketogenic Diet (TKD) (25-50g HC pre/post-entreno)",
                "Metabolic Flexibility Training (cetosis ‚Üí high carb semanal)"
            ],
            advertencias: [
                "CKD para fuerza: Superior a TKD en atletas de powerlifting (JISSN, 2022).",
                "TKD no v√°lido para deportes de alta intensidad: Requiere gluc√≥geno elevado (Med Sci Sports Exerc, 2021)."
            ]
        }
    },
    ganancia: {
        salud: {
            recomendaciones: [
                "Calorie Cycling (4 d√≠as super√°vit + 3 d√≠as mantenimiento)",
                "Meal Timing Optimization (pre/post-entreno 30g HC + 20g prote√≠na)",
                "Modified Ketogenic Diet en d√≠as de descanso (60% grasas, 30g HC)"
            ],
            advertencias: [
                "Lean Bulk > Dirty Bulk: Evita grasa visceral (JISSN, 2019).",
                "Baja fibra en ganancia: ‚Üë riesgo s√≠ndrome metab√≥lico (AJCN, 2020)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Refeed Estrat√©gico Post-Corte (1-2 d√≠as/semana HC alto post-d√©ficit)",
                "Protein Cycling (4 semanas 2.4g/kg + 1 semana 1.8g/kg)",
                "Metabolic Flexibility Training (moderate ‚Üí high carb semanal)"
            ],
            advertencias: [
                "Carb Cycling en ganancia: Mantiene sensibilidad insul√≠nica (Sports Med, 2021).",
                "Super√°vit >500 kcal: 50% de la ganancia es grasa (Int J Sport Nutr, 2019)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Cyclic Ketogenic Diet (CKD) (5 d√≠as cetosis + 2 d√≠as carb-loading)",
                "Targeted Carb Timing (25-50g HC pre-entreno)",
                "Calorie Cycling Din√°mico (4 d√≠as super√°vit + 3 d√≠as mantenimiento)"
            ],
            advertencias: [
                "CKD en fuerza pura: Mejor recuperaci√≥n que dieta est√°ndar (JISSN, 2022).",
                "Ignorar fase deportiva: En boxeo, ganancia sin periodizaci√≥n ‚Üì movilidad (J Strength Cond Res, 2021)."
            ]
        }
    },
    mantenimiento: {
        salud: {
            recomendaciones: [
                "Metabolic Flexibility Training (rotaci√≥n semanal HC)",
                "Intermittent Fasting + Cycling (5 d√≠as 14:10 + 2 d√≠as normales)",
                "Meal Timing Optimization (sincronizaci√≥n circadiana)"
            ],
            advertencias: [
                "Calorie Cycling en mantenimiento: Previene ‚Üì TMB del 5-8% (AJCN, 2020).",
                "IF estricto en mantenimiento: ‚Üë riesgo de d√©ficit inadvertido (Obesity, 2021)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Refeed Strategy (1 d√≠a/semana HC alto: 4-5g/kg)",
                "Protein Cycling (4 semanas 2.2g/kg + 1 semana 1.8g/kg)",
                "Modified Ketogenic Diet en d√≠as de descanso (50g HC)"
            ],
            advertencias: [
                "Refeed post-d√©ficit: Normaliza leptina y T3 (Obesity Rev, 2022).",
                "Refeed >6g/kg HC: ‚Üë grasa en sujetos con historia de obesidad (Int J Obesity, 2021)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Carb Loading Ocasional (24-48h pre-competici√≥n: 8-10g/kg HC)",
                "Metabolic Flexibility Training (rotaci√≥n HC seg√∫n calendario deportivo)",
                "Calorie Cycling para Mantenimiento (4 d√≠as mantenimiento + 3 d√≠as ¬±100 kcal)"
            ],
            advertencias: [
                "Carb Loading pre-competici√≥n: ‚Üë rendimiento en un 3-5% (ISSN Pos Stand, 2018).",
                "HC altos en d√≠as de baja intensidad: ‚Üì eficiencia metab√≥lica (Eur J Appl Physiol, 2022)."
            ]
        }
    },
    mixto: {
        salud: {
            recomendaciones: [
                "Calorie Cycling Din√°mico (3 d√≠as d√©ficit + 2 d√≠as mantenimiento + 2 d√≠as ligero super√°vit)",
                "Refeed Estrat√©gico Post-Entreno (25-50g HC + 20g prote√≠na)",
                "Modified Ketogenic Diet en d√≠as de descanso (40g HC)"
            ],
            advertencias: [
                "D√©ficit moderado + resistencia: Permite ganancia muscular en sedentarios (JISSN, 2021).",
                "D√©ficit >500 kcal: ‚Üì T3 y p√©rdida muscular (AJCN, 2020)."
            ]
        },
        estetica: {
            recomendaciones: [
                "Protein Cycling (4 semanas 2.4-2.6g/kg + 1 semana 1.8g/kg)",
                "Refeed Strategy Post-Entreno (25-50g HC post-ejercicio intenso)",
                "Metabolic Adaptation Protocol (1 semana mantenimiento cada 8 semanas)"
            ],
            advertencias: [
                "Protein Cycling en recomposici√≥n: Previene adaptaci√≥n renal (Obesity Rev, 2023).",
                "Refeed sin sincronizaci√≥n: ‚Üë grasa en d√≠as de descanso (Int J Obesity, 2022)."
            ]
        },
        rendimiento: {
            recomendaciones: [
                "Cyclic Ketogenic Diet (CKD) (5 d√≠as cetosis + 2 d√≠as carb-loading)",
                "Calorie Cycling Din√°mico (4 d√≠as d√©ficit + 3 d√≠as mantenimiento)",
                "Metabolic Flexibility Training Avanzado (cetosis ‚Üí high carb seg√∫n calendario deportivo)"
            ],
            advertencias: [
                "CKD en lucha: Mantiene fuerza en d√©ficit (J Strength Cond Res, 2022).",
                "Ignorar carga de entrenamiento: HC altos en d√≠as de baja intensidad ‚Üì eficiencia (J Sports Sci, 2021)."
            ]
        }
    }
};

const advertenciasDetalladas = {
    perdida: {
        salud: [
            "RKD (Dieta Cetog√©nica Estricta) en salud general: Solo para casos m√©dicos espec√≠ficos (epilepsia, c√°ncer). En obesidad, aumenta riesgo de hipercolesterolemia. [NEJM, 2022]",
            "No recomendado para personas con trastornos alimentarios o historial de atracones",
            "Requiere supervisi√≥n m√©dica en personas con diabetes tipo 1 o insuficiencia renal"
        ],
        estetica: [
            "RKD: P√©rdida de masa muscular por d√©ficit cal√≥rico extremo y limitaci√≥n de prote√≠nas",
            "Protein Cycling en fases iniciales: En d√©ficit cal√≥rico agudo, >2.2g/kg no aporta beneficios adicionales y estresa ri√±ones [AJCN, 2020]",
            "Refeed sin sincronizaci√≥n con entrenamiento: HC alto en d√≠as de descanso ‚Üë grasa corporal en sujetos con historia de obesidad [International Journal of Obesity, 2022]"
        ],
        rendimiento: [
            "TKD en deportes de alta intensidad: Los atletas de sprint pierden rendimiento por d√©ficit de gluc√≥geno [Medicine & Science in Sports & Exercise, 2021]",
            "CKD sin adecuada carga de carbohidratos: Reduce rendimiento en actividades de alta intensidad",
            "TKD solo recomendado para deportes de intensidad moderada (no para esprints puros)"
        ]
    },
    ganancia: {
        salud: [
            "\"Dirty Bulk\": Exceso de calor√≠as (>700 kcal/d√≠a) incrementa grasa visceral y riesgo metab√≥lico [Obesity Reviews, 2019]",
            "Baja ingesta proteica (<1.2g/kg): Asociado a ganancia de peso mayoritariamente grasa [AJCN, 2019]",
            "Suplementos hipercal√≥ricos no regulados (ej.: \"mass gainers\" con alto az√∫car)"
        ],
        estetica: [
            "Super√°vit excesivo (>500 kcal/d√≠a): 50% de la ganancia es grasa [International Journal of Sport Nutrition, 2019]",
            "Ignorar el \"muscle full signal\": M√°s de 40g prote√≠na en una comida no aumenta s√≠ntesis proteica adicional [AJCN, 2020]",
            "Protein Cycling en fases iniciales: En ganancia inicial, <1.6g/kg prote√≠na reduce la hipertrofia en un 20% [Sports Medicine, 2021]"
        ],
        rendimiento: [
            "Ignorar la relaci√≥n fuerza-peso: En deportes como gimnasia, ganar peso sin control afecta movilidad [Journal of Strength and Conditioning Research, 2021]",
            "Exceso de HC en d√≠as de baja intensidad: Reduce eficiencia metab√≥lica [European Journal of Applied Physiology, 2022]",
            "Carb Loading sin justificaci√≥n deportiva: En powerlifting, reduce eficiencia metab√≥lica [European Journal of Applied Physiology, 2022]"
        ]
    },
    mantenimiento: {
        salud: [
            "Ignorar la adaptaci√≥n metab√≥lica: Tras p√©rdida de peso, la TMB se reduce un 5-15% [Obesity, 2018]",
            "Baja ingesta de fibra (<25g/d√≠a): Asociado a ‚Üë riesgo de s√≠ndrome metab√≥lico [AJCN, 2020]",
            "Dietas hiperproteicas (>2.2g/kg) sin justificaci√≥n cl√≠nica (riesgo renal)"
        ],
        estetica: [
            "Ignorar el \"muscle full signal\": M√°s de 40g prote√≠na en una comida no aporta beneficios adicionales [AJCN, 2020]",
            "Refeed excesivo (>6g/kg HC): Genera ganancia de grasa en sujetos con historia de d√©ficit prolongado [International Journal of Sport Nutrition, 2021]",
            "Dietas cetog√©nicas estrictas en mantenimiento (‚Üì s√≠ntesis proteica)"
        ],
        rendimiento: [
            "Ignorar la variabilidad estacional: En deportes como el boxeo, mantener peso bajo en √©pocas no competitivas reduce resistencia [Journal of Sports Sciences, 2021]",
            "Exceso de HC en d√≠as de baja intensidad: Reduce eficiencia metab√≥lica y ‚Üë riesgo de grasa visceral [European Journal of Applied Physiology, 2022]",
            "Falta de periodizaci√≥n nutricional: No alinear con ciclos de entrenamiento y competici√≥n"
        ]
    },
    mixto: {
        salud: [
            "D√©ficit excesivo (>500 kcal/d√≠a): Acelera p√©rdida muscular y disminuye T3 [AJCN, 2020]",
            "Ignorar la inflamaci√≥n cr√≥nica: Baja ingesta de omega-3 (<1.5g/d√≠a) reduce eficacia [Nutrients, 2021]",
            "Dietas cetog√©nicas estrictas (‚Üì s√≠ntesis proteica en sujetos no adaptados)"
        ],
        estetica: [
            "D√©ficit est√°tico: Sin ciclado, la TMB ‚Üì un 8-12% tras 12 semanas [Obesity, 2019]",
            "Refeed sin sincronizaci√≥n con entrenamiento: HC alto en d√≠as de descanso ‚Üë grasa corporal [International Journal of Obesity, 2022]",
            "Super√°vit cal√≥rico en d√≠as de descanso (rompe d√©ficit neto)"
        ],
        rendimiento: [
            "Ignorar la carga de entrenamiento: HC altos en d√≠as de baja intensidad ‚Üì eficiencia metab√≥lica [Journal of Sports Sciences, 2021]",
            "Baja ingesta de electrolitos: Aumenta riesgo de calambres y ‚Üì rendimiento en d√©ficit [Sports Medicine, 2020]",
            "Falta de alineaci√≥n con fase deportiva espec√≠fica"
        ]
    }
};
let recomendacionesState = {
    estrategiaBase: null,
    estrategiasEspecificas: [],
    recomendaciones: {
        base: [],
        especificas: {}
    }
};

// ===== FUNCIONES DE INICIALIZACI√ìN Y EVENTOS =====
// ===== FUNCIONES DE INICIALIZACI√ìN Y EVENTOS =====
function initCatalogoEstrategias() {
    // Asegurar que todas las categor√≠as existan y sean arrays
    if (!catalogoEstrategias.cetogenicas) catalogoEstrategias.cetogenicas = [];
    if (!catalogoEstrategias.ciclado) catalogoEstrategias.ciclado = [];
    if (!catalogoEstrategias.timing) catalogoEstrategias.timing = [];

    // Normalizar cualquier entrada no-array
    if (!Array.isArray(catalogoEstrategias.cetogenicas)) catalogoEstrategias.cetogenicas = [];
    if (!Array.isArray(catalogoEstrategias.ciclado)) catalogoEstrategias.ciclado = [];
    if (!Array.isArray(catalogoEstrategias.timing)) catalogoEstrategias.timing = [];
}

// Llamar a la funci√≥n de inicializaci√≥n
document.addEventListener('DOMContentLoaded', initCatalogoEstrategias);
function initTrainingDays() {
    const trainingDays = document.getElementById('training-days');
    if (trainingDays) {
        trainingDays.innerHTML = '';

        const days = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
        days.forEach(day => {
            const dayElement = document.createElement('div');
            dayElement.className = 'day-option';
            dayElement.setAttribute('data-day', day.toLowerCase().substring(0, 3));
            dayElement.textContent = day;
            dayElement.addEventListener('click', function () {
                this.classList.toggle('selected');
                updateSchedulePreview();
            });
            trainingDays.appendChild(dayElement);
        });
    }
}

function initIntensitySelector() {
    const intensityContainer = document.querySelector('.intensity-selector');
    if (intensityContainer) {
        intensityContainer.innerHTML = '';

        const intensities = [
            { value: 'reposo', label: 'Reposo' },
            { value: 'leve', label: 'Leve' },
            { value: 'moderada', label: 'Moderada' }
        ];

        intensities.forEach(intensity => {
            const intensityElement = document.createElement('div');
            intensityElement.className = 'intensity-option';
            intensityElement.setAttribute('data-intensity', intensity.value);
            intensityElement.textContent = intensity.label;
            intensityElement.addEventListener('click', function () {
                document.querySelectorAll('.intensity-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
            });
            intensityContainer.appendChild(intensityElement);
        });

        // Seleccionar leve por defecto
        setTimeout(() => {
            const moderateOption = document.querySelector('.intensity-option[data-intensity="leve"]');
            if (moderateOption) moderateOption.classList.add('selected');
        }, 100);
    }
}

function obtenerPesoInicialFase(numeroFase) {
    // Buscar todos los acordeones de fases
    const acordeones = document.querySelectorAll('.accordion-phase');

    for (const acordeon of acordeones) {
        try {
            // Buscar el elemento que contiene el n√∫mero de fase
            const faseElement = acordeon.querySelector('.accordion-header td:first-child strong');
            if (!faseElement) continue;

            // Obtener el texto limpio del n√∫mero de fase (ej: "Fase 1" -> "1")
            const faseText = faseElement.textContent.trim();
            const numeroFaseEnTabla = faseText.replace(/\D/g, ''); // Extrae solo el n√∫mero

            // Verificar si es la fase que buscamos
            if (numeroFaseEnTabla === numeroFase) {
                // La celda del peso inicial es la tercera celda (√≠ndice 2)
                const celdas = acordeon.querySelectorAll('.accordion-header td');
                if (celdas.length >= 4) {
                    const pesoText = celdas[3].querySelector('strong').textContent.trim();

                    // Extraer solo el n√∫mero (quitar "kg" y espacios)
                    const peso = parseFloat(pesoText.replace(/[^\d.,]/g, '').replace(',', '.'));

                    if (!isNaN(peso)) {
                        console.log(`Peso inicial encontrado para Fase ${numeroFase}: ${peso} kg`);
                        return peso;
                    }
                }
            }
        } catch (error) {
            console.error(`Error al procesar acorde√≥n para Fase ${numeroFase}:`, error);
        }
    }

    console.warn(`No se encontr√≥ el peso inicial para Fase ${numeroFase}. Usando valor por defecto.`);
    return 70; // Valor por defecto si no se encuentra
}




function updateMacroValues() {
    const userWeightInput = document.getElementById('user-weight');
    if (!userWeightInput) return;

    let peso = 70;

    // OBTENER PESO DE LA FASE DESDE DataFase
    const modal = document.getElementById('editModal');
    if (modal) {
        const faseDataStr = modal.getAttribute('data-fase-data');
        if (faseDataStr) {
            try {
                const faseData = JSON.parse(faseDataStr);
                if (faseData && faseData.pesoInicial) {
                    peso = faseData.pesoInicial;
                }
            } catch (error) {
                console.error("Error al parsear data-fase-data en updateMacroValues:", error);
            }
        }
    }

    // Si no se pudo obtener de DataFase, usar el valor del input
    if (peso === 70 && userWeightInput.value) {
        peso = parseFloat(userWeightInput.value) || 70;
    }

    // Obtener prop√≥sito desde objetivoGeneral
    const propositoElement = document.getElementById('objetivoGeneral');
    let proposito = 'estetica';

    if (propositoElement) {
        const propositoRaw = propositoElement.value.toLowerCase();
        if (propositoRaw.includes('salud')) proposito = 'salud';
        else if (propositoRaw.includes('estet')) proposito = 'estetica';
        else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
    }

    // Obtener fase desde el modal
    const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";

    // Obtener objetivo
    const objetivoSelect = document.getElementById('objetivo');
    const objetivo = objetivoSelect ? objetivoSelect.value.replace('1', '') : 'perdida';

    // Verificar si hay una estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');

    if (selectedStrategy) {
        try {
            // OBTENER EL ID DE LA ESTRATEGIA BASE DE FORMA SEGURO
            const strategyId = selectedStrategy.getAttribute('data-strategy-id');
            if (!strategyId) {
                throw new Error("No se encontr√≥ el ID de la estrategia base");
            }

            // CORRECCI√ìN: Usar la funci√≥n cient√≠ficamente validada CON EL PESO DE LA FASE Y EL ID DE LA ESTRATEGIA
            const macros = actualizarMacros(objetivo, proposito, fase, peso, strategyId);

            // ACTUALIZAR PORCENTAJES EN LOS INPUTS
            const proteinPctInput = document.getElementById('proteinas-pct');
            const fatPctInput = document.getElementById('grasa-pct');
            const carbPctInput = document.getElementById('hc-pct');

            if (proteinPctInput) proteinPctInput.value = macros.proteinasPct;
            if (fatPctInput) fatPctInput.value = macros.grasasPct;
            if (carbPctInput) carbPctInput.value = macros.hcPct;

            // ACTUALIZAR BARRAS DE PROGRESO
            const updateProgressBar = (elementId, value, color, text) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                <div class="progress-bar ${color}" style="width: ${value}%"></div>
                            </div>
                            <span>${value}%${text ? ` (${text})` : ''}</span>
                        </div>
                    `;
                }
            };

            updateProgressBar('proteinas-gr', macros.proteinasPct, 'bg-success', macros.proteinasGr);
            updateProgressBar('grasa-gr', macros.grasasPct, 'bg-warning', macros.grasasGr);
            updateProgressBar('hc-gr', macros.hcPct, 'bg-danger', macros.hcGr);

            // Actualizar detalles cient√≠ficos
            const macroDetails = document.getElementById('macro-details-text');
            if (macroDetails) {
                const formattedDetails = formatStrategyDetails(macros.detalles, objetivo, proposito);
                macroDetails.innerHTML = formattedDetails;
            }

            // ACTUALIZAR RECOMENDACIONES CLAVE
            const recommendationsContainer = document.getElementById('recommendations-container');
            if (recommendationsContainer) {
                // PASAR TODOS LOS PAR√ÅMETROS NECESARIOS
                recommendationsContainer.innerHTML = reiniciarRecomendaciones(
                    { id: strategyId, title: selectedStrategy.querySelector('label').textContent },
                    proposito,
                    objetivo + '1',
                    fase
                );
            }

            // ACTUALIZAR ESTRATEGIA √ìPTIMA
            renderOptimalStrategyContent(objetivo, proposito, strategyId, fase);

            // ACTUALIZAR SUMA DE PORCENTAJES
            actualizarSumaPorcentajes();

            // ACTUALIZAR EL TOOLTIP DE CONFIGURACI√ìN DE MACROS
            if (typeof calcularEjemploComoTooltip === 'function') {
                calcularEjemploComoTooltip(objetivo, proposito, fase, peso, strategyId);
            }

        } catch (error) {
            console.error("Error al actualizar macros:", error);

            // MANEJO DE ERRORES - Usar valores por defecto
            const proteinPct = document.getElementById('proteinas-pct')?.value || 30;
            const fatPct = document.getElementById('grasa-pct')?.value || 30;
            const carbPct = document.getElementById('hc-pct')?.value || 40;

            updateProgressBar('proteinas-gr', proteinPct, 'bg-success', `${(proteinPct * peso * 0.04).toFixed(1)}g/kg`);
            updateProgressBar('grasa-gr', fatPct, 'bg-warning', `${(fatPct * peso * 0.011).toFixed(1)}g/kg`);
            updateProgressBar('hc-gr', carbPct, 'bg-danger', `${(carbPct * peso * 0.04).toFixed(1)}g/kg`);

            // ACTUALIZAR SUMA DE PORCENTAJES
            actualizarSumaPorcentajes();

            // ACTUALIZAR ESTRATEGIA √ìPTIMA EN CASO DE ERROR
            renderOptimalStrategyContent(objetivo, proposito, null, fase);
        }
    } else {
        // ‚úÖ L√ìGICA MEJORADA - Si no hay estrategia seleccionada, respetar los valores existentes
        const proteinPctInput = document.getElementById('proteinas-pct');
        const fatPctInput = document.getElementById('grasa-pct');
        const carbPctInput = document.getElementById('hc-pct');

        // Si los inputs ya tienen valores (de la fase), respetarlos
        const proteinPct = proteinPctInput && proteinPctInput.value ?
            parseFloat(proteinPctInput.value) : 30;
        const fatPct = fatPctInput && fatPctInput.value ?
            parseFloat(fatPctInput.value) : 30;
        const carbPct = carbPctInput && carbPctInput.value ?
            parseFloat(carbPctInput.value) : 40;

        // Actualizar barras de progreso con los valores existentes
        const updateProgressBar = (elementId, value, color, text) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="progress flex-grow-1 me-2" style="height: 10px;">
                            <div class="progress-bar ${color}" style="width: ${value}%"></div>
                        </div>
                        <span>${value}%${text ? ` (${text})` : ''}</span>
                    </div>
                `;
            }
        };

        updateProgressBar('proteinas-gr', proteinPct, 'bg-success', `${(proteinPct * peso * 0.04).toFixed(1)}g/kg`);
        updateProgressBar('grasa-gr', fatPct, 'bg-warning', `${(fatPct * peso * 0.011).toFixed(1)}g/kg`);
        updateProgressBar('hc-gr', carbPct, 'bg-danger', `${(carbPct * peso * 0.04).toFixed(1)}g/kg`);

        // ACTUALIZAR SUMA DE PORCENTAJES
        actualizarSumaPorcentajes();

        // ACTUALIZAR ESTRATEGIA √ìPTIMA INCLUSO CUANDO NO HAY ESTRATEGIA SELECCIONADA
        renderOptimalStrategyContent(objetivo, proposito, null, fase);
    }
}
/**
 * Calcula el ejemplo de c√°lculo y lo almacena como tooltip para mostrarlo al pasar el mouse
 * sobre el encabezado de Configuraci√≥n de Macros
 * 
 * @param {string} objetivo - Objetivo del plan (perdida, ganancia, etc.)
 * @param {string} proposito - Prop√≥sito (salud, estetica, rendimiento)
 * @param {string} fase - Fase actual del plan
 * @param {number} peso - Peso del usuario en kg
 * @param {string} strategyId - ID de la estrategia base seleccionada
 */
function calcularEjemploComoTooltip(objetivo, proposito, fase, peso, strategyId) {
    try {
        let kcalObjetivo = null;
        let porcentajeGrasa = null;
        let faseData = null;
        let metodoCalculo = "Mifflin-St Jeor";

        const modal = document.getElementById('editModal');
        if (modal) {
            const faseDataStr = modal.getAttribute('data-fase-data');
            if (faseDataStr) {
                try {
                    faseData = JSON.parse(faseDataStr);
                    if (faseData && faseData.kcalObjetivo) {
                        kcalObjetivo = faseData.kcalObjetivo;
                        metodoCalculo = "manual"; // Indicar que es un valor manual
                    }
                    if (faseData && faseData.porcentajeGrasaInicial !== undefined) {
                        //porcentajeGrasa = faseData.porcentajeGrasaInicial;
                    }
                } catch (error) {
                    //console.error("Error al parsear data-fase-data para kcalObjetivo:", error);
                }
            }
        }

        //Si no hay kcalObjetivo en Fase Data, calcularlo con f√≥rmula cient√≠fica
        if (!kcalObjetivo) {
            const userData = obtenerDatosUsuario();

            if (porcentajeGrasa !== null) {
                userData.porcentajeGrasa = porcentajeGrasa;
            }

            kcalObjetivo = calcularKcalObjetivo(
                userData.peso,
                userData.altura,
                userData.edad,
                userData.sexo,
                userData.nivelActividad,
                objetivo,
                userData.porcentajeGrasa
            );

            // Actualizar Fase Data con el valor calculado
            if (modal && faseData) {
                faseData.kcalObjetivo = kcalObjetivo;
                //modal.setAttribute('data-fase-data', JSON.stringify(faseData));
            }
        }

        // Calcular el ejemplo usando kcalObjetivo
        const macros = actualizarMacros(objetivo, proposito, fase, peso, strategyId);

        // Crear el contenido del tooltip con el nuevo formato
        const tooltipContent = generarTooltipContenido(
            peso,
            kcalObjetivo,
            macros.proteinasPct,
            macros.grasasPct,
            macros.hcPct,
            metodoCalculo
        );

        // Almacenar el contenido del tooltip en el modal para su uso posterior
        if (modal) {
            modal.setAttribute('data-macro-tooltip', tooltipContent);
        }

        // Actualizar el tooltip en la interfaz
        actualizarTooltipConfiguracionMacros();

    } catch (error) {
        console.error("Error al calcular ejemplo para tooltip:", error);
    }
}
function generarTooltipContenido(peso, kcalObjetivo, proteinPct, fatPct, carbPct, metodoCalculo = "Mifflin-St Jeor") {
    // Calcular gramos de cada macronutriente
    const proteinGrams = Math.round((proteinPct / 100) * kcalObjetivo / 4);
    const fatGrams = Math.round((fatPct / 100) * kcalObjetivo / 9);
    const carbGrams = Math.round((carbPct / 100) * kcalObjetivo / 4);

    // Determinar el m√©todo de c√°lculo
    const metodoBadge = metodoCalculo === "manual" ?
        '<span class="badge bg-success method-badge">Manual</span>' :
        '<span class="badge bg-primary method-badge">Mifflin-St Jeor</span>';

    const metodoTexto = metodoCalculo === "manual" ?
        '<span class="text-muted">Usando valor manual</span>' :
        '<span class="text-muted">Usando c√°lculo personalizado</span>';

    // Generar el HTML del tooltip
    return `
        <div class="macro-tooltip-content" style="width: 320px; padding: 15px;">
            <div class="result-box" style="background-color: #f8f9fa; border-radius: 10px; padding: 15px; margin-top: 0; border-left: 5px solid #6a11cb;">
                <h6 style="font-weight: 600; margin-bottom: 10px;">Calor√≠as Diarias Recomendadas</h6>
                <div class="kcal-value" style="font-size: 1.8rem; font-weight: 700; color: #6a11cb; margin: 10px 0;">${Math.round(kcalObjetivo)} kcal</div>
                <div id="calculation-method" style="font-size: 0.85rem; color: #6c757d;">
                    ${metodoTexto} ${metodoBadge}
                </div>
            </div>

            <div style="margin-top: 15px;">
                <h6 style="font-weight: 600; margin-bottom: 8px;">Macronutrientes Diarios</h6>
                <div class="macros-breakdown">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center;">
                            <strong style="margin-right: 5px;">Prote√≠nas:</strong>
                            <span class="badge bg-success" style="background-color: #198754 !important; color: white; padding: 3px 8px; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${proteinPct}%</span>
                        </div>
                        <span style="min-width: 60px; text-align: right;">${proteinGrams}g</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center;">
                            <strong style="margin-right: 5px;">Carbohidratos:</strong>
                            <span class="badge bg-danger" style="background-color: #dc3545 !important; color: white; padding: 3px 8px; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${carbPct}%</span>
                        </div>
                        <span style="min-width: 60px; text-align: right;">${carbGrams}g</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <div style="display: flex; align-items: center;">
                            <strong style="margin-right: 5px;">Grasas:</strong>
                            <span class="badge bg-warning" style="background-color: #ffc107 !important; color: #000; padding: 3px 8px; border-radius: 4px; font-weight: 500; font-size: 0.8rem;">${fatPct}%</span>
                        </div>
                        <span style="min-width: 60px; text-align: right;">${fatGrams}g</span>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 12px; padding: 8px; background-color: #e7f3fe; border-radius: 6px; font-size: 0.85rem;">
                <i class="fas fa-info-circle" style="color: #6a11cb; margin-right: 5px;"></i>
                <span style="color: #495057;">Ejemplo para ${peso}kg - Valores basados en tu plan personalizado</span>
            </div>
        </div>
    `;
}
/**
 * Obtiene los datos del usuario desde el formulario principal
 * @returns {Object} Datos del usuario necesarios para c√°lculos precisos
 */
function obtenerDatosUsuario() {
    // Obtener datos del formulario principal
    const peso = parseFloat(document.getElementById('weight')?.value) || 70;
    const alturaMetros = parseFloat(document.getElementById('height')?.value) || 170;
    const edad = parseInt(document.getElementById('age')?.value) || 30;
    const sexo = document.getElementById('gender')?.value || 'male';
    const nivelActividad = document.getElementById('activity')?.value || 'moderada';

    // Obtener porcentaje de grasa si est√° disponible
    let porcentajeGrasa = null;
    const grasaInput = document.getElementById('current-fat-percentage');
    if (grasaInput) {
        porcentajeGrasa = parseFloat(grasaInput.value);
        if (isNaN(porcentajeGrasa) || porcentajeGrasa <= 0 || porcentajeGrasa >= 100) {
            porcentajeGrasa = null;
        }
    }

    return {
        peso,
        altura: alturaMetros,
        edad,
        sexo,
        nivelActividad,
        porcentajeGrasa
    };
}
/**
 * Calcula las calor√≠as objetivo basado en f√≥rmula Mifflin-St Jeor
 * @param {number} peso - Peso en kg
 * @param {number} altura - Altura en cm
 * @param {number} edad - Edad en a√±os
 * @param {string} sexo - 'male' o 'female'
 * @param {string} nivelActividad - 'sedentario', 'ligera', 'moderada', 'alta', 'muy-alta'
 * @param {string} objetivo - 'perdida', 'ganancia', 'mantenimiento', 'mixto'
 * @param {number} porcentajeGrasa - Porcentaje de grasa corporal
 * @returns {number} Calor√≠as objetivo calculadas
 */
/**
 * Calcula las calor√≠as objetivo basado en f√≥rmula Mifflin-St Jeor
 * @param {number} peso - Peso en kg
 * @param {number} altura - Altura en METROS (no en cm)
 * @param {number} edad - Edad en a√±os
 * @param {string} sexo - 'male' o 'female'
 * @param {string} nivelActividad - 'sedentario', 'ligera', 'moderada', 'alta', 'muy-alta'
 * @param {string} objetivo - 'perdida', 'ganancia', 'mantenimiento', 'mixto'
 * @param {number} porcentajeGrasa - Porcentaje de grasa corporal
 * @returns {number} Calor√≠as objetivo calculadas
 */
function calcularKcalObjetivo(peso, altura, edad, sexo, nivelActividad, objetivo, porcentajeGrasa = null) {
    // Convertir altura de METROS a CENT√çMETROS
    const alturaCm = altura * 100;

    // Validar par√°metros
    if (!peso || !alturaCm || !edad) {
        console.warn("Faltan datos para c√°lculo preciso de kcal. Usando fallback simplificado.");
        return peso * 35; // Fallback simplificado
    }

    // Calcular TMB usando Mifflin-St Jeor
    let tmb;
    if (sexo === 'male') {
        tmb = (10 * peso) + (6.25 * alturaCm) - (5 * edad) + 5;
    } else {
        tmb = (10 * peso) + (6.25 * alturaCm) - (5 * edad) - 161;
    }

    // Ajustar TMB si tenemos porcentaje de grasa (f√≥rmula de Katch-McArdle)
    if (porcentajeGrasa && porcentajeGrasa > 0 && porcentajeGrasa < 100) {
        const masaLibreGrasa = peso * (1 - (porcentajeGrasa / 100));
        tmb = 370 + (21.6 * masaLibreGrasa); // M√°s preciso para atletas
    }

    // Factor de actividad


    const factoresActividad = {
        '1.2': 1.2,    // sedentary
        '1.375': 1.375, // light
        '1.55': 1.6,  // moderate
        '1.725': 1.8,  // active
        '1.9': 2.0     // very_active
    };

    const factor = factoresActividad[nivelActividad] || 1.2; // Por defecto sedentario

    // Calcular GET (Gasto Energ√©tico Total)
    const get = tmb * factor;

    // Ajustar seg√∫n objetivo
    if (objetivo === 'perdida') {
        // Reducci√≥n del 15-25% seg√∫n fase y nivel de grasa
        const reduccion = porcentajeGrasa && porcentajeGrasa > 25 ? 0.85 : 0.85;
        return Math.round(get * reduccion);
    } else if (objetivo === 'ganancia') {
        // Aumento del 5-10% para ganancia muscular limpia
        return Math.round(get * 1.08);
    } else if (objetivo === 'mixto') {
        // Para recomposici√≥n corporal: ligero d√©ficit o mantenimiento
        return Math.round(get * 0.92);
    } else { // mantenimiento
        return Math.round(get);
    }
}
/**
 * Calcula el porcentaje de grasa esperado para una fase espec√≠fica
 * @param {number} pesoFase - Peso al inicio de la fase
 * @param {number} numeroFase - N√∫mero de fase (1, 2, 3, 4)
 * @param {number} pesoInicialPlan - Peso al inicio del plan completo
 * @returns {number} Porcentaje de grasa esperado para la fase
 */
function calcularPorcentajeGrasaEsperado(pesoFase, numeroFase, pesoInicialPlan) {
    // Obtener el % de grasa inicial del plan
    const grasaInput = document.getElementById('current-fat-percentage');
    const porcentajeGrasaInicial = grasaInput ? parseFloat(grasaInput.value) || 0 : 0;

    // Calcular la masa libre de grasa inicial (MLG)
    const mlg = pesoInicialPlan * (1 - (porcentajeGrasaInicial / 100));

    // Calcular la masa grasa actual para este peso
    const masaGrasaActual = pesoFase - mlg;

    // Calcular el % de grasa actual
    return (masaGrasaActual / pesoFase) * 100;
}
/**
 * Actualiza el tooltip en la secci√≥n de Configuraci√≥n de Macros
 * para que muestre el ejemplo de c√°lculo al pasar el mouse
 */
function actualizarTooltipConfiguracionMacros() {
    const modal = document.getElementById('editModal');
    if (!modal) return;

    // Obtener el contenido del tooltip
    const tooltipContent = modal.getAttribute('data-macro-tooltip');
    if (!tooltipContent) return;

    // Buscar el elemento de Configuraci√≥n de Macros
    let macroConfigHeader = document.querySelector('.macro-config-header');

    // Si no existe, buscar el h5 que contiene "Configuraci√≥n de Macros"
    if (!macroConfigHeader) {
        const h5Elements = document.querySelectorAll('h5');
        for (const h5 of h5Elements) {
            if (h5.textContent.includes("Configuraci√≥n de Macros")) {
                h5.classList.add('macro-config-header');
                h5.innerHTML = `
                    <i class="fas fa-sliders-h"></i> Configuraci√≥n de Macros
                    <i class="fas fa-info-circle ms-2 text-muted" style="font-size: 0.8rem; cursor: help;"></i>
                `;
                macroConfigHeader = h5;
                break;
            }
        }
    }

    if (!macroConfigHeader) {
        console.warn("No se encontr√≥ el encabezado de Configuraci√≥n de Macros");
        return;
    }

    // Si ya existe un tooltip, eliminarlo
    const existingTooltip = macroConfigHeader.querySelector('.macro-tooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }

    // Crear el tooltip
    const tooltip = document.createElement('div');
    tooltip.className = 'macro-tooltip';
    tooltip.innerHTML = tooltipContent;

    // Estilo del tooltip
    tooltip.style.position = 'absolute';
    tooltip.style.backgroundColor = 'white';
    tooltip.style.border = '1px solid #ddd';
    tooltip.style.borderRadius = '8px';
    tooltip.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.1)';
    tooltip.style.zIndex = '1000';
    tooltip.style.maxWidth = '350px';
    tooltip.style.fontSize = '0.9rem';
    tooltip.style.display = 'none';
    tooltip.style.top = '100%';
    tooltip.style.left = '0';
    tooltip.style.marginTop = '5px';

    // A√±adir el tooltip al header
    macroConfigHeader.appendChild(tooltip);

    // Configurar eventos hover
    macroConfigHeader.addEventListener('mouseenter', function () {
        tooltip.style.display = 'block';
    });

    macroConfigHeader.addEventListener('mouseleave', function () {
        tooltip.style.display = 'none';
    });
}


















document.addEventListener('DOMContentLoaded', function () {
    // Event listeners para los botones
    const generateBtn = document.getElementById('generate-btn');
    const resetBtn = document.getElementById('reset-btn');

    if (generateBtn) generateBtn.addEventListener('click', generarPlan);
    if (resetBtn) resetBtn.addEventListener('click', resetForm);

    // Event listeners para los filtros
    const weeksInput = document.getElementById('weeks');

    if (weeksInput) weeksInput.addEventListener('change', generarPlan);

    // Configurar evento para cuando cambia el tipo de d√≠a
    const trainingDaysSelect = document.getElementById('trainingDays');
    if (trainingDaysSelect) {
        trainingDaysSelect.addEventListener('change', function () {
            localStorage.setItem('tipoDiaActual', this.value);
            updateMacroValues();
        });
    }

    // Inicializar modal
    initModal();
    // Configurar botones de edici√≥n
    const editButtons = document.querySelectorAll('[data-bs-target="#editModal"]');
    editButtons.forEach(button => {
        button.addEventListener('click', function (event) {
            openEditModal(event, this);
        });
    });
});

function setupWeightValidation() {
    const pesoInicialInput = document.getElementById('weight');
    const goalTypeSelect = document.getElementById('objetivo');

    if (pesoInicialInput && goalTypeSelect) {
        pesoInicialInput.addEventListener('change', validateWeightValues);
        goalTypeSelect.addEventListener('change', validateWeightValues);
    }
}

function validateWeightValues() {
    const pesoInicial = parseFloat(document.getElementById('weight').value);
    const cambioPeso = parseFloat(document.getElementById('weight-change-goal').value);
    const goalType = document.getElementById('objetivo').value;

    if (isNaN(pesoInicial) || isNaN(cambioPeso)) return;

    const pesoObjetivo = goalType === 'perdida1' ? pesoInicial - cambioPeso : pesoInicial + cambioPeso;

    if (goalType === 'perdida1' && pesoInicial <= pesoObjetivo) {
        alert('Para p√©rdida de grasa, el peso inicial debe ser mayor que el peso objetivo');
        document.getElementById('weight-change-goal').value = Math.max(1, cambioPeso - 1);
    } else if (goalType === 'ganancia1' && pesoObjetivo <= pesoInicial) {
        alert('Para ganancia muscular, el peso objetivo debe ser mayor que el peso inicial');
        document.getElementById('weight-change-goal').value = Math.max(1, cambioPeso + 1);
    }
}

function initModal() {
    const weightValue = document.getElementById('weight')?.value || 70;
    const userWeightInput = document.getElementById('user-weight');

    if (userWeightInput) {
        userWeightInput.value = weightValue;
    }

    // Configurar evento para cuando el modal se muestra
    const editModal = document.getElementById('editModal');
    if (editModal) {
        // Configurar evento para cuando el modal se muestra
        editModal.addEventListener('shown.bs.modal', function () {
            // Actualizar peso en el modal
            const weightInput = document.getElementById('weight');
            if (weightInput) {
                const userWeightInput = document.getElementById('user-weight');
                if (userWeightInput) {
                    userWeightInput.value = weightInput.value || 70;
                }
            }

            // Configurar c√°lculo de macros
            const userWeightInput = document.getElementById('user-weight');
            if (userWeightInput) {
                userWeightInput.addEventListener('input', updateMacroValues);
            }

            // ‚úÖ CONFIGURAR EL BOT√ìN DE GUARDAR AQU√ç (cuando el modal est√° visible y sus elementos existen)
            const saveBtn = document.getElementById('save-config-btn');
            if (saveBtn) {
                // Eliminar cualquier listener previo para evitar duplicados
                const clonedBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(clonedBtn, saveBtn);

                clonedBtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    try {
                        // Primero guardar la configuraci√≥n
                        const estrategiasGuardadas = guardarConfiguracionEstrategiasEspecificas();

                        // Aqu√≠ ir√≠a el resto de la l√≥gica de guardado
                        console.log("Configuraci√≥n guardada correctamente", estrategiasGuardadas);

                        // Cerrar el modal despu√©s de guardar
                        const modalInstance = bootstrap.Modal.getInstance(editModal);
                        if (modalInstance) {
                            modalInstance.hide();

                            // Limpieza adicional para asegurar que el backdrop se elimine
                            setTimeout(() => {
                                const backdrop = document.querySelector('.modal-backdrop');
                                if (backdrop) {
                                    backdrop.remove();
                                }
                                document.body.classList.remove('modal-open');
                                document.body.style.overflow = '';
                                document.body.style.paddingRight = '';
                            }, 300);
                        }

                        // Mostrar mensaje de confirmaci√≥n
                        alert('Configuraci√≥n guardada correctamente. El plan se actualizar√° con los nuevos par√°metros.');
                    } catch (error) {
                        console.error("Error al guardar configuraci√≥n:", error);
                        alert('Hubo un error al guardar la configuraci√≥n. Por favor, int√©ntalo de nuevo.');
                    }
                });
            } else {
                console.warn("El bot√≥n de guardado no se encontr√≥ en el modal");
            }

            // Forzar actualizaci√≥n inicial
            setTimeout(updateMacroValues, 100);
        });
    }
}

function actualizarInterfazMacros() {
    const objetivo = document.getElementById('objetivo-select').value;
    const proposito = document.getElementById('proposito-select').value;
    const fase = document.getElementById('fase-select').value;
    const peso = parseFloat(document.getElementById('user-weight').value) || 70; // Valor por defecto

    try {
        // Obtener los macros actualizados
        const macros = actualizarMacros(objetivo, proposito, fase, peso);

        // Actualizar porcentajes en los inputs
        document.getElementById('proteinas-pct').value = macros.proteinasPct;
        document.getElementById('grasa-pct').value = macros.grasasPct;
        document.getElementById('hc-pct').value = macros.hcPct;

        // ACTUALIZAR CORRECTAMENTE LOS CAMPOS DE GRAMOS
        document.getElementById('proteinas-gr').textContent =
            `${macros.proteinasGr} (${macros.proteinasPct}%)`;
        document.getElementById('hc-gr').textContent =
            `${macros.hcGr} (${macros.hcPct}%)`;
        document.getElementById('grasas-gr').textContent =
            `${macros.grasasGr} (${macros.grasasPct}%)`;

        // Actualizar detalles cient√≠ficos
        const macroDetails = document.getElementById('macro-details-text');
        if (macroDetails) {
            macroDetails.innerHTML = macros.detalles;
        }

        // Actualizar gr√°ficos/barras
        actualizarVisualizacionMacros(macros);

        // Actualizar el campo de calor√≠as objetivo
        if (peso) {
            const calorieEstimate = calcularCaloriasObjetivo(macros, peso);
            document.getElementById('goal-calories').value = Math.round(calorieEstimate);
        }

    } catch (error) {
        console.error("Error al actualizar macros:", error);
        mostrarErrorInterfaz("Error al actualizar macros. Revisa la consola para m√°s detalles.");
    }
}
function actualizarVisualizacionMacros(macros) {
    // Actualizar barras de progreso
    const proteinaBar = document.querySelector('.macro-progress.proteinas .progress-bar');
    const grasaBar = document.querySelector('.macro-progress.grasas .progress-bar');
    const hcBar = document.querySelector('.macro-progress.hc .progress-bar');

    if (proteinaBar) proteinaBar.style.width = `${macros.proteinasPct}%`;
    if (grasaBar) grasaBar.style.width = `${macros.grasasPct}%`;
    if (hcBar) hcBar.style.width = `${macros.hcPct}%`;

    // Actualizar texto en las barras
    const proteinaText = document.querySelector('.macro-progress.proteinas span');
    const grasaText = document.querySelector('.macro-progress.grasas span');
    const hcText = document.querySelector('.macro-progress.hc span');

    if (proteinaText) proteinaText.textContent = `${macros.proteinasPct}% (${macros.proteinasGr})`;
    if (grasaText) grasaText.textContent = `${macros.grasasPct}% (${macros.grasasGr})`;
    if (hcText) hcText.textContent = `${macros.hcPct}% (${macros.hcGr})`;
}
// Funci√≥n auxiliar para calcular calor√≠as objetivo
function calcularCaloriasObjetivo(macros, peso) {
    const getPromedioGr = (rango) => {
        if (typeof rango !== 'string') return 0;

        const match = rango.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
        if (match) {
            return (parseFloat(match[1]) + parseFloat(match[2])) / 2;
        }

        const simpleMatch = rango.match(/(\d+\.?\d*)/);
        return simpleMatch ? parseFloat(simpleMatch[1]) : 0;
    };

    const proteinasGrProm = getPromedioGr(macros.proteinasGr);
    const hcGrProm = getPromedioGr(macros.hcGr);
    const grasasGrProm = getPromedioGr(macros.grasasGr);

    if (proteinasGrProm > 0 && hcGrProm > 0 && grasasGrProm > 0) {
        const proteinasKcal = proteinasGrProm * peso * 4;
        const hcKcal = hcGrProm * peso * 4;
        const grasasKcal = grasasGrProm * peso * 9;
        return proteinasKcal + hcKcal + grasasKcal;
    }

    return peso * 30; // Valor por defecto
}


function actualizarMacros(objetivo, proposito, fase, pesoKg, strategyId = null) {
    try {
        // Validaci√≥n de par√°metros
        const objetivosValidos = ['perdida', 'ganancia', 'mantenimiento', 'mixto'];
        const prop√≥sitosValidos = ['salud', 'estetica', 'rendimiento'];

        if (!objetivosValidos.includes(objetivo)) {
            throw new Error(`Objetivo inv√°lido. Debe ser: ${objetivosValidos.join(', ')}`);
        }

        // Normalizar prop√≥sito
        let propositoNormalizado = proposito.toLowerCase();
        if (propositoNormalizado.includes('salud')) propositoNormalizado = 'salud';
        if (propositoNormalizado.includes('estet')) propositoNormalizado = 'estetica';
        if (propositoNormalizado.includes('rendimiento')) propositoNormalizado = 'rendimiento';

        if (!prop√≥sitosValidos.includes(propositoNormalizado)) {
            console.warn(`Prop√≥sito inv√°lido detectado: ${proposito}. Usando 'estetica' por defecto.`);
            propositoNormalizado = 'estetica';
        }

        // Normalizar fase (formato estandarizado)
        let faseNormalizada = fase;

        // Mapeo de formatos comunes a formato estandarizado
        const faseMap = {
            '1': 'Fase 1 (0-12 sem)',
            '2': 'Fase 2 (12-24 sem)',
            '3': 'Fase 3 Avanzada (>24 sem)',
            '4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)',
            'fase 1': 'Fase 1 (0-12 sem)',
            'fase 2': 'Fase 2 (12-24 sem)',
            'fase 3': 'Fase 3 Avanzada (>24 sem)',
            'fase 4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)'
        };

        const faseKey = fase.toLowerCase().trim();
        if (faseMap[faseKey]) {
            faseNormalizada = faseMap[faseKey];
        }

        // Verificar que la fase exista
        if (!estrategiasBaseConfig[objetivo] || !estrategiasBaseConfig[objetivo][faseNormalizada]) {
            // Intentar encontrar la fase m√°s cercana
            const fasesDisponibles = Object.keys(estrategiasBaseConfig[objetivo] || {});
            if (fasesDisponibles.length > 0) {
                faseNormalizada = fasesDisponibles[0];
                console.warn(`Fase inv√°lida detectada: ${fase}. Usando '${faseNormalizada}' por defecto.`);
            } else {
                throw new Error(`No se encontr√≥ ninguna fase para ${objetivo}`);
            }
        }

        // OBTENCI√ìN DE VALORES - CORREGIDO: Manejar el caso cuando strategyId es null
        let faseConfig;

        if (strategyId) {
            // Buscar la estrategia base espec√≠fica por ID
            faseConfig = estrategiasBaseConfig[objetivo][faseNormalizada].find(item =>
                item.id === strategyId && item.aplicable.includes(objetivo)
            );

            if (!faseConfig) {
                console.warn(`Estrategia base "${strategyId}" no encontrada. Usando primera estrategia por defecto.`);
            }
        }

        // Si no se encontr√≥ con el ID o no se proporcion√≥ ID, usar la primera
        if (!faseConfig) {
            faseConfig = estrategiasBaseConfig[objetivo][faseNormalizada].find(item =>
                item.aplicable.includes(objetivo)
            );
        }

        if (!faseConfig) {
            throw new Error(`No se encontr√≥ configuraci√≥n para ${objetivo}/${propositoNormalizado}/${faseNormalizada}`);
        }

        // Normalizar la estructura de macros antes de usarla
        const macrosNormalizados = normalizarEstructuraMacros(faseConfig, propositoNormalizado);

        // Determinar si es d√≠a de entreno o descanso (obtener del estado de la UI)
        const esDiaEntreno = obtenerTipoDiaActual();

        // Seleccionar los macros correctos seg√∫n el d√≠a
        const macrosSeleccionados = esDiaEntreno
            ? macrosNormalizados.diasEntreno
            : macrosNormalizados.diasDescanso;

        // Si no se pudo determinar (caso improbable), usar promedio
        if (!macrosSeleccionados) {
            const promedioProtein = (parseFloat(macrosNormalizados.diasDescanso.proteinGr) +
                parseFloat(macrosNormalizados.diasEntreno.proteinGr)) / 2;
            const promedioCarb = (parseFloat(macrosNormalizados.diasDescanso.carbinGr) +
                parseFloat(macrosNormalizados.diasEntreno.carbinGr)) / 2;
            const promedioFat = (parseFloat(macrosNormalizados.diasDescanso.fatinGr) +
                parseFloat(macrosNormalizados.diasEntreno.fatinGr)) / 2;

            // Calcular porcentajes promedio (simplificado)
            const proteinPct = (parseFloat(macrosNormalizados.diasDescanso.proteinPct.split('-')[0]) +
                parseFloat(macrosNormalizados.diasEntreno.proteinPct.split('-')[0])) / 2;
            const carbPct = (parseFloat(macrosNormalizados.diasDescanso.carbPct.split('-')[0]) +
                parseFloat(macrosNormalizados.diasEntreno.carbPct.split('-')[0])) / 2;
            const fatPct = (parseFloat(macrosNormalizados.diasDescanso.fatPct.split('-')[0]) +
                parseFloat(macrosNormalizados.diasEntreno.fatPct.split('-')[0])) / 2;

            macrosSeleccionados = {
                proteinPct: `${Math.round(proteinPct)}%`,
                fatPct: `${Math.round(fatPct)}%`,
                carbPct: `${Math.round(carbPct)}%`,
                proteinGr: promedioProtein.toFixed(1),
                carbinGr: promedioCarb.toFixed(1),
                fatinGr: promedioFat.toFixed(1)
            };
        }

        // Extracci√≥n de valores
        const {
            proteinPct,
            fatPct,
            carbPct,
            proteinGr,
            carbinGr,
            fatinGr
        } = macrosSeleccionados;

        // Conversi√≥n a valores num√©ricos para c√°lculos
        const getPromedio = (rango) => {
            if (typeof rango !== 'string') return 0;

            const match = rango.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
            if (match) {
                return (parseFloat(match[1]) + parseFloat(match[2])) / 2;
            }

            const simpleMatch = rango.match(/(\d+\.?\d*)/);
            return simpleMatch ? parseFloat(simpleMatch[1]) : 0;
        };

        const proteinasPct = getPromedio(proteinPct);
        const grasasPct = getPromedio(fatPct);
        const hcPct = getPromedio(carbPct);





        // Integraci√≥n con catalogoEstrategias (Estrategias Espec√≠ficas)
        const estrategiasEspecificas = [];
        const advertencias = [];

        // Buscar estrategias espec√≠ficas aplicables
        Object.values(catalogoEstrategias).flat().forEach(estrategia => {
            if (estrategia.aplicable.includes(objetivo)) {
                // Verificar si es aplicable a este prop√≥sito espec√≠fico
                const tieneProposito = estrategia.features.some(feat =>
                    feat.includes(`PROP√ìSITO: V√°lido para ${propositoNormalizado.toUpperCase()}`) ||
                    feat.includes(`PROP√ìSITO: Solo v√°lido para ${propositoNormalizado.toUpperCase()}`)
                );

                if (tieneProposito) {
                    estrategiasEspecificas.push({
                        id: estrategia.id,
                        title: estrategia.title,
                        description: estrategia.description
                    });

                    // Extraer advertencias
                    estrategia.features.forEach(feat => {
                        if (feat.includes("INCOMPATIBILIDAD")) {
                            advertencias.push(feat.replace("INCOMPATIBILIDAD: ", ""));
                        }
                    });
                }
            }
        });

        // Generar detalles completos
        let detalles = faseConfig.details;

        // A√±adir estrategias espec√≠ficas recomendadas
        if (estrategiasEspecificas.length > 0) {
            detalles += `\n\nESTRATEGIAS ESPEC√çFICAS RECOMENDADAS:\n${estrategiasEspecificas.map(e => `- ${e.title}: ${e.description}`).join('\n')}`;
        }

        // A√±adir advertencias
        if (advertencias.length > 0) {
            detalles += `\n\nADVERTENCIAS CIENT√çFICAS:\n${advertencias.map(a => `- ${a}`).join('\n')}`;
        }

        // C√°lculo de ejemplo con peso (si se proporciona)
        if (pesoKg) {
            const getPromedioGr = (rango) => {
                if (typeof rango !== 'string') return 0;

                const match = rango.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                if (match) {
                    return (parseFloat(match[1]) + parseFloat(match[2])) / 2;
                }

                const simpleMatch = rango.match(/(\d+\.?\d*)/);
                return simpleMatch ? parseFloat(simpleMatch[1]) : 0;
            };

            const proteinasGrProm = getPromedioGr(proteinGr);
            const hcGrProm = getPromedioGr(carbinGr);
            const grasasGrProm = getPromedioGr(fatinGr);

            if (proteinasGrProm > 0 && hcGrProm > 0 && grasasGrProm > 0) {
                const proteinasKcal = proteinasGrProm * pesoKg * 4;
                const hcKcal = hcGrProm * pesoKg * 4;
                const grasasKcal = grasasGrProm * pesoKg * 9;
                const totalKcal = proteinasKcal + hcKcal + grasasKcal;

                detalles += `\n\nEJEMPLO PARA ${pesoKg}KG:\n- ${Math.round(proteinasKcal)} kcal prote√≠nas (${Math.round(proteinasGrProm * pesoKg)}g)\n- ${Math.round(hcKcal)} kcal HC (${Math.round(hcGrProm * pesoKg)}g)\n- ${Math.round(grasasKcal)} kcal grasas (${Math.round(grasasGrProm * pesoKg)}g)\nTotal: ${Math.round(totalKcal)} kcal`;
            }
        }

        // Validaci√≥n final
        const totalPct = proteinasPct + grasasPct + hcPct;
        if (Math.abs(totalPct - 100) > 0.5) {
            console.warn(`[VALIDACI√ìN] Los porcentajes no suman 100% (${totalPct.toFixed(1)}%) - Revisar configuraci√≥n`);
        }

        // Retornar resultado
        return {
            proteinasPct: Math.round(proteinasPct * 10) / 10,
            grasasPct: Math.round(grasasPct * 10) / 10,
            hcPct: Math.round(hcPct * 10) / 10,
            proteinasGr: proteinGr,
            hcGr: carbinGr,
            grasasGr: fatinGr,
            detalles,
            totalPct: Math.round(totalPct * 10) / 10
        };

    } catch (error) {
        console.error("Error en actualizarMacros:", error);
        // Retornar valores por defecto en caso de error
        return {
            proteinasPct: 30,
            grasasPct: 35,
            hcPct: 35,
            proteinasGr: "1.6-2.2 g/kg/d√≠a",
            hcGr: "2.0-3.0 g/kg/d√≠a",
            grasasGr: "0.8-1.0 g/kg/d√≠a",
            detalles: "Error al calcular macros. Por favor, intente seleccionar otra estrategia.",
            totalPct: 100
        };
    }

}

function calcularRango(rangoStr, weight) {
    // Si el valor es un rango (ej: "1.6-2.0 g/kg/d√≠a")
    if (typeof rangoStr === 'string' && rangoStr.includes('-')) {
        const [minStr, maxStr] = rangoStr.split('-');
        const min = parseFloat(minStr.match(/[\d.]+/)[0]);
        const max = parseFloat(maxStr.match(/[\d.]+/)[0]);

        // Si es un valor por peso (ej: "1.6-2.0 g/kg/d√≠a")
        if (rangoStr.includes('kg')) {
            return `${(min * weight).toFixed(1)}-${(max * weight).toFixed(1)}`;
        }
        // Si es un porcentaje (ej: "20-25%")
        return rangoStr;
    }
    // Si el valor es un n√∫mero simple
    else if (typeof rangoStr === 'string' && !isNaN(parseFloat(rangoStr))) {
        return (parseFloat(rangoStr) * weight).toFixed(1);
    }
    // Si el valor ya es calculado (ej: "120-150g")
    return rangoStr;
}

// ===== FUNCIONES PRINCIPALES DEL MODAL =====

function openEditModal(event, button) {
    event.stopPropagation();
    event.preventDefault();

    // Verificar que el modal exista antes de intentar manipularlo
    const editModal = document.getElementById('editModal');
    if (!editModal) {
        console.error("El modal de edici√≥n no existe en el DOM");
        return;
    }

    // Obtener datos del bot√≥n
    const nombreFase = button.getAttribute('data-fase-nombre');
    const numeroFase = button.getAttribute('data-fase-numero');

    // Verificar que el elemento del t√≠tulo exista
    const modalTitle = document.getElementById('modal-phase-title');
    if (modalTitle) {
        modalTitle.textContent = `Configuraci√≥n de Estrategias - ${nombreFase}`;
    } else {
        console.warn("Elemento modal-phase-title no encontrado en el DOM");
    }

    // Determinar el objetivo del plan
    const objetivoSelect = document.getElementById('objetivo');
    const goalType = objetivoSelect ? objetivoSelect.value : 'perdida1';

    // Determinar la fase espec√≠fica en formato estandarizado
    let faseKey = "Fase " + numeroFase;
    if (goalType === 'mixto1' && numeroFase === "4") {
        faseKey = "Fase 4";
    }

    // Mapeo a formato estandarizado
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)',
        'Fase 1': 'Fase 1 (0-12 sem)',
        'Fase 2': 'Fase 2 (12-24 sem)',
        'Fase 3': 'Fase 3 Avanzada (>24 sem)',
        'Fase 4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)'
    };
    const faseEstandarizada = faseMap[numeroFase] || faseMap[faseKey] || "Fase 1 (0-12 sem)";

    // Obtener data-fase-info del bot√≥n
    const faseInfoStr = button.getAttribute('data-fase-info');
    let faseInfo = null;

    if (faseInfoStr) {
        try {
            faseInfo = JSON.parse(decodeURIComponent(faseInfoStr));
            console.log("Datos de fase obtenidos:", faseInfo);
        } catch (error) {
            console.error("Error al parsear data-fase-info:", error);
        }
    }

    // ‚úÖ CALCULAR EL GET A PARTIR DE LOS DATOS DE LA TABLA GENERAL
    let kcalObjetivo = null;
    if (faseInfo && faseInfo.proteinas_g_dia && faseInfo.carbohidratos_g_dia && faseInfo.grasas_g_dia) {
        kcalObjetivo = (faseInfo.proteinas_g_dia * 4) +
            (faseInfo.carbohidratos_g_dia * 4) +
            (faseInfo.grasas_g_dia * 9);
    }


    // OBTENER EL PESO INICIAL DE LA FASE DESDE LA TABLA
    const pesoInicialFase = faseInfo ? faseInfo.pesoInicioFase : obtenerPesoInicialFase(numeroFase);

    // OBTENER EL PORCENTAJE DE GRASA PARA ESTA FASE
    let porcentajeGrasaFase = 0;
    const grasaInput = document.getElementById('current-fat-percentage');
    if (grasaInput) {
        porcentajeGrasaFase = parseFloat(grasaInput.value) || 0;

        // Si es una fase avanzada, calcular el % de grasa esperado basado en progreso
        if (numeroFase > 1) {
            porcentajeGrasaFase = calcularPorcentajeGrasaEsperado(
                pesoInicialFase,
                numeroFase,
                document.getElementById('weight').value
            );
        }
    }

    // CREAR DATOS DE LA FASE CON EL PESO CORRECTO Y % GRASA
    const faseData = {
        pesoInicial: pesoInicialFase,
        porcentajeGrasaInicial: porcentajeGrasaFase,
        objetivo: goalType,
        fase: faseEstandarizada,
        // Almacenar los datos de macros de la tabla general
        macrosBase: faseInfo ? faseInfo.macrosBase : null,
        proteinaGrKg: faseInfo ? faseInfo.proteinas_g_kg : null,
        hcGrKg: faseInfo ? faseInfo.carbohidratos_g_kg : null,
        grasaGrKg: faseInfo ? faseInfo.grasas_g_kg : null,
        // ‚úÖ ALMACENAR EL GET CALCULADO
        kcalObjetivo: kcalObjetivo ? Math.round(kcalObjetivo) : null,
        // Otros datos necesarios
        strategyId: null,
        estrategiaBase: null
    };

    // Almacenar la fase en el modal para uso posterior
    if (editModal) {
        editModal.setAttribute('data-fase', faseEstandarizada);
        editModal.setAttribute('data-fase-data', JSON.stringify(faseData));
    }

    // Reiniciar estado de recomendaciones
    recomendacionesState = {
        estrategiaBase: null,
        estrategiasEspecificas: [],
        recomendaciones: {
            base: [],
            especificas: {}
        }
    };

    // Renderizar estrategias base
    const baseStrategiesContainer = document.getElementById('base-strategies');
    if (baseStrategiesContainer) {
        baseStrategiesContainer.innerHTML = '';

        // Obtener estrategias base para el objetivo y fase
        const estrategiasBase = getEstrategiasByGoalAndPhase(goalType, faseEstandarizada);
        if (estrategiasBase.length > 0) {
            estrategiasBase.forEach(strategy => {
                const strategyElement = document.createElement('div');
                strategyElement.className = 'radio-option';
                strategyElement.setAttribute('data-strategy-id', strategy.id);

                strategyElement.innerHTML = `
                    <input type="radio" id="${strategy.id}" name="estrategia-base" value="${strategy.id}">
                    <label for="${strategy.id}">${strategy.title}</label>
                    <p class="text-muted small">${strategy.description}</p>
                `;

                strategyElement.addEventListener('click', function () {
                    document.querySelectorAll('.radio-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    selectEstrategiaBase(strategy, goalType, faseEstandarizada);
                });

                baseStrategiesContainer.appendChild(strategyElement);
            });

            // Seleccionar la primera estrategia por defecto
            if (baseStrategiesContainer.firstChild) {
                baseStrategiesContainer.firstChild.click();
            }
        } else {
            baseStrategiesContainer.innerHTML = '<p class="text-muted">No hay estrategias base disponibles para esta fase.</p>';
        }
    }

    // Renderizar estrategias espec√≠ficas
    renderEstrategiasEspecificas(goalType, faseEstandarizada, null);

    // Actualizar recomendaciones clave
    const recommendationsContainer = document.getElementById('recommendations-container');
    if (recommendationsContainer) {
        recommendationsContainer.innerHTML = `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Selecciona una estrategia base para ver recomendaciones espec√≠ficas.
                </div>
            </div>
        `;
    } else {
        console.error("El contenedor recommendations-container no existe en el DOM");
    }

    // Inicializar selecci√≥n de d√≠as de entrenamiento
    initTrainingDays();

    // Inicializar selectores de intensidad
    initIntensitySelector();

    // Actualizar vista previa del horario
    updateSchedulePreview();

    // Configurar evento para cuando el modal se muestra
    if (editModal) {
        // Asegurar que el modal de Bootstrap est√© inicializado
        const bootstrapModal = bootstrap.Modal.getInstance(editModal) || new bootstrap.Modal(editModal);

        // Configurar evento para cuando el modal se muestra
        editModal.addEventListener('shown.bs.modal', function () {
            // ACTUALIZAR PESO EN EL INPUT CON EL VALOR DE LA FASE
            const userWeightInput = document.getElementById('user-weight');
            if (userWeightInput) {
                // Verificar si hay un peso guardado para esta fase
                const faseDataStr = editModal.getAttribute('data-fase-data');
                let pesoInicialFase = 70;

                if (faseDataStr) {
                    try {
                        const faseData = JSON.parse(faseDataStr);
                        if (faseData && faseData.pesoInicial) {
                            pesoInicialFase = faseData.pesoInicial;
                        }
                    } catch (error) {
                        console.error("Error al parsear data-fase-data:", error);
                    }
                }

                // Usar el peso inicial de la fase solo si no hay un valor guardado
                const pesoGuardado = localStorage.getItem('user-weight-' + faseEstandarizada);
                if (pesoGuardado) {
                    userWeightInput.value = pesoGuardado;
                } else {
                    userWeightInput.value = pesoInicialFase;
                }

                // DISPARAR EVENTO DE CAMBIO PARA ACTUALIZAR MACROS
                const event = new Event('change', { bubbles: true });
                userWeightInput.dispatchEvent(event);
            }

            // ‚úÖ INICIALIZAR LOS INPUTS DE MACROS CON LOS VALORES DE LA FASE
            if (faseInfo && faseInfo.macrosBase) {
                // Obtener los inputs de porcentajes
                const proteinPctInput = document.getElementById('proteinas-pct');
                const fatPctInput = document.getElementById('grasa-pct');
                const carbPctInput = document.getElementById('hc-pct');

                // Establecer los valores de porcentajes
                if (proteinPctInput) proteinPctInput.value = faseInfo.macrosBase.proteinasPct;
                if (fatPctInput) fatPctInput.value = faseInfo.macrosBase.grasasPct;
                if (carbPctInput) carbPctInput.value = faseInfo.macrosBase.carbohidratosPct;

                // Actualizar las barras de progreso
                const updateProgressBar = (elementId, value, color, text) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                    <div class="progress-bar ${color}" style="width: ${value}%"></div>
                                </div>
                                <span>${value}%${text ? ` (${text})` : ''}</span>
                            </div>
                        `;
                    }
                };



                // Actualizar barras con los valores de la fase
                updateProgressBar('proteinas-gr', faseInfo.macrosBase.proteinasPct, 'bg-success', `${faseInfo.proteinas_g_kg} g/kg`);
                updateProgressBar('grasa-gr', faseInfo.macrosBase.grasasPct, 'bg-warning', `${faseInfo.grasas_g_kg} g/kg`);
                updateProgressBar('hc-gr', faseInfo.macrosBase.carbohidratosPct, 'bg-danger', `${faseInfo.carbohidratos_g_kg} g/kg`);

                // Actualizar el campo de calor√≠as objetivo
                const calorieEstimate = faseInfo.proteinas_g_dia * 4 +
                    faseInfo.carbohidratos_g_dia * 4 +
                    faseInfo.grasas_g_dia * 9;

                const goalCaloriesInput = document.getElementById('goal-calories');
                if (goalCaloriesInput) {
                    goalCaloriesInput.value = Math.round(calorieEstimate);
                }
            }

            // ‚úÖ CONFIGURAR C√ÅLCULO DE MACROS
            if (userWeightInput) {
                // Eliminar event listeners previos para evitar duplicados
                const newUserWeightInput = userWeightInput.cloneNode(true);
                userWeightInput.parentNode.replaceChild(newUserWeightInput, userWeightInput);

                newUserWeightInput.addEventListener('input', function () {
                    // Guardar el peso personalizado en localStorage
                    const faseDataStr = editModal.getAttribute('data-fase-data');
                    let fase = "fase-desconocida";

                    if (faseDataStr) {
                        try {
                            const faseData = JSON.parse(faseDataStr);
                            fase = faseData.fase || "fase-desconocida";
                        } catch (error) {
                            console.error("Error al parsear data-fase-data:", error);
                        }
                    }

                    localStorage.setItem('user-weight-' + fase, this.value);
                    updateMacroValues();
                });
            }

            // ‚úÖ FORZAR ACTUALIZACI√ìN DE LOS VALORES INICIALES DE PAUSA
            actualizarValoresInicialesPausa(pesoInicialFase);

            // ‚úÖ CONFIGURAR LISTENERS PARA LA SECCI√ìN DE PAUSA (DENTRO DEL EVENTO shown.bs.modal)
            setupPausaMacroListeners();


            // CONFIGURAR EL HEADER DE CONFIGURACI√ìN DE MACROS PARA EL TOOLTIP
            const macroConfigHeader = document.querySelector('.macro-config-header');
            if (!macroConfigHeader) {
                // Buscar todos los elementos h5 y encontrar el que contiene el texto deseado
                const h5Elements = document.querySelectorAll('h5');
                let existingHeader = null;

                for (const h5 of h5Elements) {
                    if (h5.textContent.includes("Configuraci√≥n de Macros")) {
                        existingHeader = h5;
                        break;
                    }
                }

                if (existingHeader) {
                    existingHeader.classList.add('macro-config-header');
                    existingHeader.innerHTML = `
                        <i class="fas fa-sliders-h"></i> Configuraci√≥n de Macros
                        <i class="fas fa-info-circle ms-2 text-muted" style="font-size: 0.8rem;"></i>
                    `;
                }
            }

            // ‚úÖ SOLO FORZAR ACTUALIZACI√ìN INICIAL SI HAY UNA ESTRATEGIA SELECCIONADA
            const selectedStrategy = document.querySelector('.radio-option.selected');
            if (selectedStrategy) {
                //updateMacroValues();
            }
        });

        // Configurar evento para cuando el modal se oculta
        editModal.addEventListener('hidden.bs.modal', function () {
            // Limpiar event listeners para evitar fugas de memoria
            const userWeightInput = document.getElementById('user-weight');
            if (userWeightInput) {
                const newUserWeightInput = userWeightInput.cloneNode(true);
                userWeightInput.parentNode.replaceChild(newUserWeightInput, userWeightInput);
            }

            // Eliminar tooltip
            const macroConfigHeader = document.querySelector('.macro-config-header');
            if (macroConfigHeader) {
                const tooltip = macroConfigHeader.querySelector('.macro-tooltip');
                if (tooltip) tooltip.remove();
            }
        });

        // ‚úÖ MOSTRAR EL MODAL
        bootstrapModal.show();
    }
}

function guardarConfiguracionEstrategiasEspecificas() {
    try {
        const estrategiasSeleccionadas = [];

        // Solo intentar obtener checkboxes si el modal est√° abierto
        const checkboxes = document.querySelectorAll('.strategy-checkbox:checked');

        checkboxes.forEach(checkbox => {
            try {
                const strategyId = checkbox.id.replace('chk-', '');

                // Encontrar la estrategia en los cat√°logos
                let estrategia = null;
                for (const categoria in catalogoEstrategias) {
                    const categoriaEstrategias = catalogoEstrategias[categoria] || [];
                    const encontrada = categoriaEstrategias.find(e => e.id === strategyId);
                    if (encontrada) {
                        estrategia = encontrada;
                        break;
                    }
                }

                if (!estrategia) {
                    console.warn(`Estrategia con ID ${strategyId} no encontrada en los cat√°logos`);
                    return;
                }

                // Obtener configuraci√≥n - VERIFICAR QUE LOS ELEMENTOS EXISTAN
                const strategyItem = checkbox.closest('.strategy-item');
                if (!strategyItem) return;

                const configOptions = strategyItem.querySelector('.strategy-config-options');
                if (!configOptions) return;

                const freqSelect = configOptions.querySelector('select[id^="freq-"]');
                const daysSelect = configOptions.querySelector('select[id^="days-"]');

                if (!freqSelect || !daysSelect) return;

                const frecuencia = freqSelect.value;
                const diasAplicacion = daysSelect.value;

                estrategiasSeleccionadas.push({
                    id: strategyId,
                    title: estrategia.title,
                    frecuencia: frecuencia,
                    diasAplicacion: diasAplicacion
                });
            } catch (error) {
                console.error(`Error procesando estrategia en checkbox:`, error);
            }
        });

        // Almacenar en DataFase - VERIFICAR QUE EL MODAL EXISTA
        const modal = document.getElementById('editModal');
        if (modal) {
            try {
                const faseDataStr = modal.getAttribute('data-fase-data');
                const faseData = faseDataStr ? JSON.parse(faseDataStr) : {};

                faseData.estrategiasEspecificas = estrategiasSeleccionadas;
                modal.setAttribute('data-fase-data', JSON.stringify(faseData));
            } catch (error) {
                console.error("Error al actualizar data-fase-data:", error);
            }
        }

        return estrategiasSeleccionadas;
    } catch (error) {
        console.error("Error cr√≠tico en guardarConfiguracionEstrategiasEspecificas:", error);
        return [];
    }
}


function obtenerDatosFaseDesdeTabla(numeroFase) {
    // Buscar la fila de la fase en la tabla
    const faseRows = document.querySelectorAll('.accordion-phase');
    let faseRow = null;

    // Encontrar la fila correspondiente al n√∫mero de fase
    for (const row of faseRows) {
        const faseHeader = row.querySelector('.accordion-header table tr td:first-child');
        if (faseHeader && faseHeader.textContent.includes(`Fase ${numeroFase}`)) {
            faseRow = row;
            break;
        }
    }

    // Si no se encontr√≥ con el m√©todo anterior, intentar alternativa
    if (!faseRow) {
        const editButton = document.querySelector(`button[data-fase-numero="${numeroFase}"]`);
        if (editButton) {
            faseRow = editButton.closest('.accordion-phase');
        }
    }

    if (!faseRow) {
        console.error(`No se encontr√≥ la fase ${numeroFase} en la tabla`);

        // Intentar obtener datos b√°sicos del plan
        return {
            pesoInicial: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: `Fase ${numeroFase}`,
            proposito: 'estetica',
            macros: {
                proteinasPct: 0,
                grasasPct: 0,
                hcPct: 0,
                proteinasGr: "",
                grasasGr: "",
                hcGr: ""
            }
        };
    }

    // Buscar el bot√≥n de detalles semanales
    const detallesBtn = faseRow.querySelector('.ver-detalles-fase-btn');

    if (!detallesBtn) {
        console.error(`No se encontr√≥ el bot√≥n de detalles para la fase ${numeroFase}`);
        return {
            pesoInicial: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: `Fase ${numeroFase}`,
            proposito: 'estetica',
            macros: {
                proteinasPct: 0,
                grasasPct: 0,
                hcPct: 0,
                proteinasGr: "",
                grasasGr: "",
                hcGr: ""
            }
        };
    }

    // Decodificar y parsear los datos de la fase
    const faseInfoStr = detallesBtn.getAttribute('data-fase-info');
    const faseInfo = JSON.parse(decodeURIComponent(faseInfoStr));

    // Crear el objeto DataFase con la estructura que necesita el sistema
    return {
        id: `fase-${numeroFase}`,
        numero: parseInt(numeroFase),
        nombre: faseInfo.nombreFase,
        meses: faseInfo.mesesTexto,
        semanas: faseInfo.semanasAsignadas,
        reevalSemana: faseInfo.semanaReevaluacion,
        pesoInicial: faseInfo.pesoInicioFase,
        pesoFinalEstimado: faseInfo.pesoFinFase,
        objetivo: document.getElementById('objetivo')?.value.replace('1', '') || 'perdida',
        proposito: document.getElementById('objetivoGeneral')?.value || 'estetica',
        objetivoPrincipal: faseInfo.objetivoPrincipal,
        observaciones: faseInfo.observaciones,
        macros: {
            proteinasPct: faseInfo.macrosBase.proteinasPct,
            grasasPct: faseInfo.macrosBase.grasasPct,
            hcPct: faseInfo.macrosBase.carbohidratosPct,
            proteinasGr: `${faseInfo.proteinas_g_kg} g/kg/d√≠a`,
            grasasGr: `${faseInfo.grasas_g_kg} g/kg/d√≠a`,
            hcGr: `${faseInfo.carbohidratos_g_kg} g/kg/d√≠a`
        }
    };
}
function obtenerDatosFaseDesdeTabla(numeroFase) {
    // Normalizar el n√∫mero de fase
    const faseNumerica = parseInt(numeroFase);
    if (isNaN(faseNumerica)) {
        console.error(`N√∫mero de fase inv√°lido: ${numeroFase}`);
        return {
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: "Fase 1 (0-12 sem)",
            proposito: 'estetica',
            macros: {
                proteinasPct: 0,
                grasasPct: 0,
                hcPct: 0,
                proteinasGr: "",
                grasasGr: "",
                hcGr: ""
            }
        };
    }

    // Mapeo de n√∫mero de fase a texto descriptivo
    const faseMap = {
        1: "Fase 1 (0-12 sem)",
        2: "Fase 2 (12-24 sem)",
        3: "Fase 3 Avanzada (>24 sem)",
        4: "Fase 4 Ajuste Metab√≥lico (>32 sem)"
    };

    const nombreFase = faseMap[faseNumerica] || `Fase ${faseNumerica}`;

    // Buscar la fila de la fase en la tabla - Mejorada para manejar diferentes estructuras
    const faseRows = document.querySelectorAll('.accordion-phase');
    let faseRow = null;

    for (const row of faseRows) {
        const dataFase = row.getAttribute('data-fase-numero');
        const titleElement = row.querySelector('.phase-title');

        if (dataFase && parseInt(dataFase) === faseNumerica) {
            faseRow = row;
            break;
        } else if (titleElement && titleElement.textContent.includes(nombreFase)) {
            faseRow = row;
            break;
        }
    }

    if (!faseRow) {
        console.warn(`No se encontr√≥ la fase ${numeroFase} en la tabla. Usando valores por defecto.`);
        return {
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: nombreFase,
            proposito: 'estetica',
            macros: {
                proteinasPct: 20,
                grasasPct: 35,
                hcPct: 45,
                proteinasGr: "1.6-2.2 g/kg/d√≠a",
                grasasGr: "0.8-1.0 g/kg/d√≠a",
                hcGr: "2.0-3.0 g/kg/d√≠a"
            }
        };
    }

    // Buscar el bot√≥n de detalles semanales
    const detallesBtn = faseRow.querySelector('.ver-detalles-fase-btn') ||
        faseRow.querySelector('[data-fase-info]');

    if (!detallesBtn) {
        console.warn(`No se encontr√≥ el bot√≥n de detalles para la fase ${numeroFase}. Usando valores por defecto.`);
        return {
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivo: 'perdida',
            fase: nombreFase,
            proposito: 'estetica',
            macros: {
                proteinasPct: 20,
                grasasPct: 35,
                hcPct: 45,
                proteinasGr: "1.6-2.2 g/kg/d√≠a",
                grasasGr: "0.8-1.0 g/kg/d√≠a",
                hcGr: "2.0-3.0 g/kg/d√≠a"
            }
        };
    }

    // Decodificar y parsear los datos de la fase
    let faseInfo = null;
    try {
        const faseInfoStr = detallesBtn.getAttribute('data-fase-info');
        faseInfo = faseInfoStr ? JSON.parse(decodeURIComponent(faseInfoStr)) : null;

        if (!faseInfo) {
            throw new Error("Fase info vac√≠a");
        }
    } catch (error) {
        console.error(`Error al parsear data-fase-info para fase ${numeroFase}:`, error);
        faseInfo = {
            nombreFase: nombreFase,
            semanasAsignadas: faseNumerica === 1 ? 12 : faseNumerica === 2 ? 12 : faseNumerica === 3 ? 12 : 8,
            pesoInicioFase: document.getElementById('weight')?.value || 70,
            objetivoPrincipal: 'perdida',
            macrosBase: {
                proteinasPct: 20,
                grasasPct: 35,
                carbohidratosPct: 45
            },
            proteinas_g_kg: "1.6-2.2",
            grasas_g_kg: "0.8-1.0",
            carbohidratos_g_kg: "2.0-3.0"
        };
    }

    // Crear el objeto DataFase con la estructura que necesita el sistema
    return {
        id: `fase-${faseNumerica}`,
        numero: faseNumerica,
        nombre: faseInfo.nombreFase || nombreFase,
        meses: faseInfo.mesesTexto || `${Math.ceil(faseInfo.semanasAsignadas / 4)} meses`,
        semanas: faseInfo.semanasAsignadas || (faseNumerica === 1 ? 12 : 12),
        reevalSemana: faseInfo.semanaReevaluacion || (faseNumerica === 1 ? 6 : faseNumerica * 4),
        pesoInicial: faseInfo.pesoInicioFase || (document.getElementById('weight')?.value || 70),
        pesoFinalEstimado: faseInfo.pesoFinFase || (document.getElementById('weight')?.value - 5 || 65),
        objetivo: document.getElementById('objetivo')?.value?.replace('1', '') || 'perdida',
        proposito: document.getElementById('objetivoGeneral')?.value || 'estetica',
        objetivoPrincipal: faseInfo.objetivoPrincipal || 'perdida',
        observaciones: faseInfo.observaciones || 'Fase est√°ndar para el objetivo seleccionado',
        macros: {
            proteinasPct: faseInfo.macrosBase?.proteinasPct || 20,
            grasasPct: faseInfo.macrosBase?.grasasPct || 35,
            hcPct: faseInfo.macrosBase?.carbohidratosPct || 45,
            proteinasGr: faseInfo.proteinas_g_kg ? `${faseInfo.proteinas_g_kg} g/kg/d√≠a` : "1.6-2.2 g/kg/d√≠a",
            grasasGr: faseInfo.grasas_g_kg ? `${faseInfo.grasas_g_kg} g/kg/d√≠a` : "0.8-1.0 g/kg/d√≠a",
            hcGr: faseInfo.carbohidratos_g_kg ? `${faseInfo.carbohidratos_g_kg} g/kg/d√≠a` : "2.0-3.0 g/kg/d√≠a"
        }
    };
}


function getEstrategiasByGoalAndPhase(goalType, faseKey) {
    const goalMap = {
        'perdida1': 'perdida',
        'ganancia1': 'ganancia',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'mixto'
    };
    const goalKey = goalMap[goalType] || 'perdida';

    // Normalizar faseKey para asegurarnos de que es un string
    faseKey = faseKey ? faseKey.toString() : "";

    // Manejar posibles variaciones en el nombre de la fase
    let normalizedFaseKey = faseKey;

    // Si faseKey es un n√∫mero, convertirlo a un formato est√°ndar
    if (/^\d+$/.test(faseKey)) {
        switch (faseKey) {
            case "1":
                if (goalKey === 'mixto') {
                    normalizedFaseKey = "Fase 1 Volume (0-12 sem)";
                } else if (goalKey === 'ganancia') {
                    normalizedFaseKey = "Fase 1 (0-8 sem)";
                } else {
                    normalizedFaseKey = "Fase 1 (0-12 sem)";
                }
                break;
            case "2":
                if (goalKey === 'mixto') {
                    normalizedFaseKey = "Fase 2 Definici√≥n (12-24 sem)";
                } else if (goalKey === 'ganancia') {
                    normalizedFaseKey = "Fase 2 (8-20 sem)";
                } else {
                    normalizedFaseKey = "Fase 2 (12-24 sem)";
                }
                break;
            case "3":
                if (goalKey === 'mixto') {
                    normalizedFaseKey = "Fase 3 Mantenimiento Metab√≥lico (24-32 sem)";
                } else if (goalKey === 'ganancia') {
                    normalizedFaseKey = "Fase 3 (20+ sem)";
                } else {
                    normalizedFaseKey = "Fase 3 Avanzada (>24 sem)";
                }
                break;
            case "4":
                normalizedFaseKey = "Fase 4 Ajuste Metab√≥lico (>32 sem)";
                break;
            default:
                normalizedFaseKey = "Fase 1 (0-12 sem)";
        }
    } else {
        // Si faseKey es un string, intentar normalizarlo
        if (goalKey === 'mixto') {
            if (/fase\s*1/i.test(faseKey)) {
                normalizedFaseKey = "Fase 1 Volume (0-12 sem)";
            } else if (/fase\s*2/i.test(faseKey)) {
                normalizedFaseKey = "Fase 2 Definici√≥n (12-24 sem)";
            } else if (/fase\s*3/i.test(faseKey)) {
                normalizedFaseKey = "Fase 3 Mantenimiento Metab√≥lico (24-32 sem)";
            } else if (/fase\s*4/i.test(faseKey)) {
                normalizedFaseKey = "Fase 4 Ajuste Metab√≥lico (>32 sem)";
            }
        } else if (goalKey === 'ganancia') {
            if (/fase\s*1/i.test(faseKey)) {
                normalizedFaseKey = "Fase 1 (0-8 sem)";
            } else if (/fase\s*2/i.test(faseKey)) {
                normalizedFaseKey = "Fase 2 (8-20 sem)";
            } else if (/fase\s*3/i.test(faseKey)) {
                normalizedFaseKey = "Fase 3 (20+ sem)";
            }
        } else {
            // Para otros objetivos, usar el mapeo est√°ndar
            if (/fase\s*1/i.test(faseKey)) {
                normalizedFaseKey = "Fase 1 (0-12 sem)";
            } else if (/fase\s*2/i.test(faseKey)) {
                normalizedFaseKey = "Fase 2 (12-24 sem)";
            } else if (/fase\s*3/i.test(faseKey)) {
                normalizedFaseKey = "Fase 3 Avanzada (>24 sem)";
            } else if (/fase\s*4/i.test(faseKey)) {
                normalizedFaseKey = "Fase 4 Ajuste Metab√≥lico (>32 sem)";
            }
        }
    }

    // Verificar si existe la configuraci√≥n para esta combinaci√≥n
    if (!estrategiasBaseConfig[goalKey] || !estrategiasBaseConfig[goalKey][normalizedFaseKey]) {
        console.error(`No se encontr√≥ configuraci√≥n para ${goalKey}/${normalizedFaseKey}`);

        // Intentar encontrar la fase m√°s cercana
        const fasesDisponibles = Object.keys(estrategiasBaseConfig[goalKey] || {});
        if (fasesDisponibles.length > 0) {
            normalizedFaseKey = fasesDisponibles[0];
            console.warn(`Fase inv√°lida detectada: ${faseKey}. Usando '${normalizedFaseKey}' por defecto.`);
        } else {
            console.error(`No se encontr√≥ ninguna fase para ${goalKey}`);
            return [];
        }
    }

    return estrategiasBaseConfig[goalKey][normalizedFaseKey];
}

function selectEstrategiaBase(strategy, goalType, faseKey) {
    // Validaci√≥n de par√°metros cr√≠ticos
    if (!strategy || !strategy.id) {
        console.error("selectEstrategiaBase: strategy no definido o inv√°lido", { strategy, goalType, faseKey });
        return;
    }

    // ‚úÖ CORRECCI√ìN CLAVE: MOVER ESTA DECLARACI√ìN AL PRINCIPIO
    // Determinar objetivo limpio
    const objetivo = goalType.replace('1', '');

    // Asegurar que faseKey est√© en formato estandarizado
    let faseEstandarizada = faseKey;
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)',
        'Fase 1': 'Fase 1 (0-12 sem)',
        'Fase 2': 'Fase 2 (12-24 sem)',
        'Fase 3': 'Fase 3 Avanzada (>24 sem)',
        'Fase 4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)'
    };

    if (faseMap[faseKey]) {
        faseEstandarizada = faseMap[faseKey];
    } else if (faseKey.includes("Fase") && !faseKey.includes("(")) {
        // Intentar convertir "Fase 1" a "Fase 1 (0-12 sem)"
        const numero = faseKey.match(/\d+/);
        if (numero && faseMap[numero[0]]) {
            faseEstandarizada = faseMap[numero[0]];
        }
    }

    // Obtener prop√≥sito desde objetivoGeneral
    const propositoElement = document.getElementById('objetivoGeneral');
    let proposito = 'estetica'; // Valor por defecto

    if (propositoElement) {
        const propositoRaw = propositoElement.value.toLowerCase();
        if (propositoRaw.includes('salud')) proposito = 'salud';
        else if (propositoRaw.includes('estet')) proposito = 'estetica';
        else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
    }

    // DECLARAR pesoInicialFase ANTES DE USARLA
    let pesoInicialFase = 70;

    // Almacenar la fase en el modal para uso posterior
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.setAttribute('data-fase', faseEstandarizada);

        // OBTENER EL PESO INICIAL DE LA FASE DESDE LA TABLA
        const numeroFase = faseEstandarizada.match(/\d+/)?.[0] || faseKey.match(/\d+/)?.[0];

        if (numeroFase) {
            try {
                pesoInicialFase = obtenerPesoInicialFase(numeroFase);
                console.log(`Peso inicial de la fase ${numeroFase}: ${pesoInicialFase} kg`);
            } catch (error) {
                console.error(`Error al obtener peso inicial para fase ${numeroFase}:`, error);
            }
        }

        // Actualizar FaseData con el peso correcto
        const faseData = {
            pesoInicial: pesoInicialFase,
            objetivo: goalType,
            fase: faseEstandarizada,
            strategyId: strategy.id,
            estrategiaBase: {
                id: strategy.id,
                title: strategy.title,
                aplicable: strategy.aplicable
            }
        };
        editModal.setAttribute('data-fase-data', JSON.stringify(faseData));
    }

    // USAR EL PESO INICIAL DE LA FASE EN LOS C√ÅLCULOS
    const peso = pesoInicialFase;

    // Actualizar la secci√≥n de detalles
    const macroDetails = document.getElementById('macro-details-text');
    if (macroDetails) {
        try {
            // Verificar que strategy.details existe
            if (!strategy.details) {
                macroDetails.innerHTML = '<div class="strategy-main-text text-muted">No hay detalles disponibles para esta estrategia.</div>';
                return;
            }

            // Texto principal de la estrategia
            let fullDetails = strategy.details;

            // Buscar estrategias espec√≠ficas aplicables
            const estrategiasEspecificas = {
                recomendadas: [],
                neutrales: [],
                contraindicadas: []
            };
            const advertencias = [];

            // Buscar en todas las categor√≠as
            const todasEstrategias = [
                ...(catalogoEstrategias.cetogenicas || []),
                ...(catalogoEstrategias.ciclado || []),
                ...(catalogoEstrategias.timing || [])
            ];

            if (todasEstrategias.length === 0) {
                console.warn("No se encontraron estrategias espec√≠ficas en los cat√°logos");
            }

            todasEstrategias.forEach(estrategia => {
                try {
                    // Clasificar la estrategia seg√∫n el prop√≥sito, fase y estrategia base
                    const clasificacion = clasificarEstrategia(estrategia, proposito, faseEstandarizada, strategy);

                    if (clasificacion.clasificacion === 'recomendada') {
                        estrategiasEspecificas.recomendadas.push({
                            title: estrategia.title || '',
                            description: estrategia.description || ''
                        });
                    } else if (clasificacion.clasificacion === 'no recomendada' ||
                        clasificacion.clasificacion === 'contraindicada') {
                        estrategiasEspecificas.contraindicadas.push({
                            title: estrategia.title || '',
                            description: estrategia.description || '',
                            mensaje: clasificacion.detalle
                        });
                        // EXTRAER ADVERTENCIAS ESPEC√çFICAS DE LA CLASIFICACI√ìN
                        if (clasificacion.detalle) {
                            // Si hay m√∫ltiples advertencias (separadas por salto de l√≠nea)
                            if (clasificacion.detalle.includes('\n')) {
                                clasificacion.detalle.split('\n').forEach(adv => {
                                    if (adv.trim() !== "") {
                                        advertencias.push(adv);
                                    }
                                });
                            } else {
                                if (clasificacion.detalle.trim() !== "") {
                                    advertencias.push(clasificacion.detalle);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error(`Error al clasificar estrategia ${estrategia.id}:`, error);
                }
            });

            // A√±adir estrategias espec√≠ficas recomendadas al texto
            if (estrategiasEspecificas.recomendadas.length > 0) {
                fullDetails += `\n\nESTRATEGIAS ESPEC√çFICAS RECOMENDADAS:`;
                estrategiasEspecificas.recomendadas.forEach(e => {
                    if (e.title && e.description) {
                        fullDetails += `\n- ${e.title}: ${e.description}`;
                    }
                });
            }

            // ‚úÖ CORRECCI√ìN CLAVE: Procesar advertencias para reemplazar "INCOMPATIBILIDAD"
            const advertenciasProcesadas = procesarAdvertencias(advertencias);

            // A√±adir advertencias cient√≠ficas (SIN MENSAJES DUPLICADOS)
            if (advertenciasProcesadas.length > 0) {
                // Eliminar duplicados manteniendo el orden
                const advertenciasUnicas = [...new Set(advertenciasProcesadas)];

                fullDetails += `\n\nADVERTENCIAS CIENT√çFICAS:`;
                advertenciasUnicas.forEach(a => {
                    fullDetails += `\n- ${a}`;
                });
            }



            // Formatear y actualizar con el objetivo y prop√≥sito
            const formattedDetails = formatStrategyDetails(fullDetails, objetivo, proposito);
            macroDetails.innerHTML = formattedDetails;

            // Guardar los detalles completos en el modal para evitar sobrescritura
            if (editModal) {
                editModal.setAttribute('data-full-details', fullDetails);
            }

            // Actualizar recomendaciones clave
            const recommendationsContainer = document.getElementById('recommendations-container');
            if (recommendationsContainer) {
                try {
                    // PASAR faseKey y peso a la funci√≥n
                    recommendationsContainer.innerHTML = reiniciarRecomendaciones(strategy, proposito, goalType, faseEstandarizada);
                } catch (error) {
                    console.error("Error al reiniciar recomendaciones:", error);
                    recommendationsContainer.innerHTML = `
                        <div class="recommendations-section">
                            <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i> 
                                Error al generar recomendaciones: ${error.message}
                            </div>
                        </div>
                    `;
                }
            }

            // Renderizar estrategias espec√≠ficas con la estrategia base actual
            renderEstrategiasEspecificas(goalType, faseEstandarizada, strategy);

            // ‚úÖ ACTUALIZAR LA SECCI√ìN ESTRATEGIA √ìPTIMA INMEDIATAMENTE
            renderOptimalStrategyContent(objetivo, proposito, strategy.id, faseEstandarizada);
        } catch (error) {
            console.error("Error al procesar detalles de estrategia:", error);
            macroDetails.innerHTML = `
                <div class="strategy-main-text text-danger">
                    Error al procesar los detalles de la estrategia. 
                    Por favor, intente seleccionar otra estrategia.
                </div>
            `;
        }
    }

    // ‚úÖ CORRECCI√ìN CLAVE: ACTUALIZAR MACROS INMEDIATAMENTE CON LOS PAR√ÅMETROS CORRECTOS
    console.log("Actualizando macros despu√©s de seleccionar estrategia base");
    console.log("Objetivo:", objetivo);
    console.log("Prop√≥sito:", proposito);
    console.log("Fase:", faseEstandarizada);
    console.log("Peso:", peso);
    console.log("Strategy ID:", strategy.id);

    // Forzar actualizaci√≥n de macros con los par√°metros correctos
    updateMacroValuesWithParams(objetivo, proposito, faseEstandarizada, peso, strategy.id);
}






// NUEVA FUNCI√ìN PARA ACTUALIZAR MACROS CON PAR√ÅMETROS EXPL√çCITOS
function updateMacroValuesWithParams(objetivo, proposito, fase, peso, strategyId) {
    const userWeightInput = document.getElementById('user-weight');

    // Forzar actualizaci√≥n del peso en el input
    if (userWeightInput && peso) {
        userWeightInput.value = peso;
    }

    // Verificar si hay una estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');

    if (selectedStrategy || strategyId) {
        try {
            // Usar el strategyId proporcionado si est√° disponible
            const finalStrategyId = strategyId || selectedStrategy.getAttribute('data-strategy-id');

            if (!finalStrategyId) {
                throw new Error("No se encontr√≥ el ID de la estrategia base");
            }

            console.log("Actualizando macros con:", {
                objetivo,
                proposito,
                fase,
                peso,
                strategyId: finalStrategyId
            });

            // Usar la funci√≥n cient√≠ficamente validada CON EL PESO DE LA FASE Y EL ID DE LA ESTRATEGIA
            const macros = actualizarMacros(objetivo, proposito, fase, peso, finalStrategyId);

            // ACTUALIZAR PORCENTAJES EN LOS INPUTS
            const proteinPctInput = document.getElementById('proteinas-pct');
            const fatPctInput = document.getElementById('grasa-pct');
            const carbPctInput = document.getElementById('hc-pct');

            if (proteinPctInput) proteinPctInput.value = macros.proteinasPct;
            if (fatPctInput) fatPctInput.value = macros.grasasPct;
            if (carbPctInput) carbPctInput.value = macros.hcPct;

            // ACTUALIZAR BARRAS DE PROGRESO
            const updateProgressBar = (elementId, value, color, text) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML = `
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                                <div class="progress-bar ${color}" style="width: ${value}%"></div>
                            </div>
                            <span>${value}%${text ? ` (${text})` : ''}</span>
                        </div>
                    `;
                }
            };

            updateProgressBar('proteinas-gr', macros.proteinasPct, 'bg-success', macros.proteinasGr);
            updateProgressBar('grasa-gr', macros.grasasPct, 'bg-warning', macros.grasasGr);
            updateProgressBar('hc-gr', macros.hcPct, 'bg-danger', macros.hcGr);

            // ACTUALIZAR SUMA DE PORCENTAJES
            actualizarSumaPorcentajes();

            // ACTUALIZAR ESTRATEGIA √ìPTIMA
            renderOptimalStrategyContent(objetivo, proposito, finalStrategyId, fase);

            return true; // Indicar que la actualizaci√≥n fue exitosa
        } catch (error) {
            console.error("Error al actualizar macros con par√°metros expl√≠citos:", error);

            // Intentar usar la funci√≥n de actualizaci√≥n tradicional como fallback
            try {
                updateMacroValues();
                return true;
            } catch (fallbackError) {
                console.error("Error al usar fallback de actualizaci√≥n de macros:", fallbackError);
                return false;
            }
        }
    } else {
        console.warn("No hay estrategia base seleccionada para actualizar macros");
        // Usar la funci√≥n de actualizaci√≥n tradicional
        updateMacroValues();
        return false;
    }
}


function renderEstrategiasEspecificas(goalType, faseKey, estrategiaBase) {
    // Determinar el tipo de objetivo
    let objetivoKey = '';
    if (goalType === 'perdida1') objetivoKey = 'perdida';
    else if (goalType === 'ganancia1') objetivoKey = 'ganancia';
    else if (goalType === 'mantenimiento1') objetivoKey = 'mantenimiento';
    else if (goalType === 'mixto1') objetivoKey = 'mixto';

    // OBTENER PROP√ìSITO CORRECTAMENTE (CORRECCI√ìN CLAVE)
    let propositoKey = 'estetica'; // Valor por defecto

    // Primero intentar desde el modal si est√° abierto
    const modal = document.getElementById('editModal');
    if (modal) {
        const faseDataStr = modal.getAttribute('data-fase-data');
        if (faseDataStr) {
            try {
                const faseData = JSON.parse(faseDataStr);
                if (faseData && faseData.proposito) {
                    const propositoLower = faseData.proposito.toLowerCase();
                    if (propositoLower.includes('salud')) propositoKey = 'salud';
                    else if (propositoLower.includes('estet')) propositoKey = 'estetica';
                    else if (propositoLower.includes('rendimiento')) propositoKey = 'rendimiento';
                }
            } catch (e) {
                console.warn("Error parsing faseData:", e);
            }
        }
    }

    // Si no se encontr√≥ en DataFase, intentar desde el select
    if (propositoKey === 'estetica') {
        const propositoElement = document.getElementById('objetivoGeneral');
        if (propositoElement) {
            const propositoRaw = propositoElement.value.toLowerCase();
            if (propositoRaw.includes('salud')) propositoKey = 'salud';
            else if (propositoRaw.includes('estet')) propositoKey = 'estetica';
            else if (propositoRaw.includes('rendimiento')) propositoKey = 'rendimiento';
        }
    }

    // Verificar que los contenedores existan ANTES de intentar renderizar
    const cetogenicasContainer = document.getElementById('cetogenicas-strategies');
    const cicladoContainer = document.getElementById('ciclado-strategies');
    const timingContainer = document.getElementById('timing-strategies');

    if (!cetogenicasContainer || !cicladoContainer || !timingContainer) {
        console.error("Contenedores de estrategias espec√≠ficas no encontrados. El modal probablemente no est√° abierto.");
        return;
    }

    // Renderizar cada categor√≠a
    renderEstrategiasCategoria(
        catalogoEstrategias.cetogenicas,
        'cetogenicas-strategies',
        objetivoKey,
        faseKey,
        propositoKey,
        estrategiaBase
    );

    renderEstrategiasCategoria(
        catalogoEstrategias.ciclado,
        'ciclado-strategies',
        objetivoKey,
        faseKey,
        propositoKey,
        estrategiaBase
    );

    renderEstrategiasCategoria(
        catalogoEstrategias.timing,
        'timing-strategies',
        objetivoKey,
        faseKey,
        propositoKey,
        estrategiaBase
    );
}

function renderEstrategiasCategoria(strategies, containerId, objetivoKey, faseKey, propositoKey, estrategiaBase) {
    // Asegurar que propositoKey est√© definido
    if (!propositoKey) {
        console.warn(`propositoKey no definido para ${containerId}. Usando 'estetica' por defecto.`);
        propositoKey = 'estetica';
    }

    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Contenedor ${containerId} no encontrado en el DOM. El modal probablemente no est√° abierto.`);
        return;
    }

    container.innerHTML = '';

    // Verificar que strategies sea un array v√°lido
    if (!strategies || !Array.isArray(strategies)) {
        console.warn(`Estrategias no v√°lidas para ${containerId}`);
        container.innerHTML = '<p class="text-muted">No hay estrategias disponibles para este objetivo.</p>';
        return;
    }

    // Filtrar estrategias aplicables al objetivo
    const estrategiasFiltradas = strategies.filter(strategy => {
        if (!strategy.aplicable) {
            console.warn(`Estrategia sin propiedad 'aplicable':`, strategy);
            return false;
        }
        return strategy.aplicable.includes(objetivoKey);
    });

    if (estrategiasFiltradas.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay estrategias disponibles para este objetivo.</p>';
        return;
    }

    // Renderizar cada estrategia
    estrategiasFiltradas.forEach(strategy => {
        try {
            // Clasificar la estrategia seg√∫n el prop√≥sito, fase y estrategia base
            const clasificacion = clasificarEstrategia(strategy, propositoKey, faseKey, estrategiaBase);

            const strategyElement = document.createElement('div');

            // Establecer clases seg√∫n la clasificaci√≥n
            let containerClass = '';
            let badgeClass = '';
            let iconClass = '';
            let badgeText = '';

            switch (clasificacion.clasificacion) {
                case 'recomendada':
                    containerClass = 'strategy-recomendada';
                    badgeClass = 'badge-recomendada';
                    iconClass = 'fas fa-check-circle text-success';
                    badgeText = 'RECOMENDADA';
                    break;
                case 'neutral':
                    containerClass = 'strategy-neutral';
                    badgeClass = 'badge-neutral';
                    iconClass = 'fas fa-circle text-muted';
                    badgeText = 'NEUTRAL';
                    break;
                case 'contraindicada':
                case 'no recomendada':
                    containerClass = 'strategy-contraindicada';
                    badgeClass = 'badge-contraindicada';
                    iconClass = 'fas fa-times-circle text-danger';
                    badgeText = 'NO RECOMENDADA';
                    break;
                default:
                    containerClass = 'strategy-neutral';
                    badgeClass = 'badge-neutral';
                    iconClass = 'fas fa-circle text-muted';
                    badgeText = 'NEUTRAL';
            }

            strategyElement.className = `strategy-item p-2 mb-2 ${containerClass}`;
            strategyElement.dataset.strategyId = strategy.id;

            strategyElement.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="form-check me-2">
                        <input class="form-check-input strategy-checkbox" type="checkbox" id="chk-${strategy.id}">
                        <label class="form-check-label" for="chk-${strategy.id}"></label>
                    </div>
                    <i class="${iconClass} mt-1" style="font-size: 1.1rem; width: 20px;"></i>
                    <div class="flex-grow-1 ms-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>${strategy.title}</strong>
                            <span class="strategy-badge ${badgeClass}">${badgeText}</span>
                        </div>
                        <p class="text-muted mb-0">${strategy.description}</p>
                    </div>
                </div>
                <div class="strategy-config-options" id="config-${strategy.id}">
                    <div class="config-options-grid mt-2">
                        <div class="config-group">
                            <label for="freq-${strategy.id}">Frecuencia</label>
                            <select class="form-select" id="freq-${strategy.id}">
                                <option value="semanal">Semanal</option>
                                <option value="quincenal">Quincenal</option>
                                <option value="mensual">Mensual</option>
                                <option value="fase-completa">Fase Completa</option>
                            </select>
                        </div>
                        <div class="config-group">
                            <label for="days-${strategy.id}">D√≠as de aplicaci√≥n</label>
                            <select class="form-select" id="days-${strategy.id}">
                                <option value="entreno">D√≠as de entreno</option>
                                <option value="descanso">D√≠as de descanso</option>
                                <option value="todos">Todos los d√≠as</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(strategyElement);

            // Configurar evento para el checkbox
            const checkbox = strategyElement.querySelector('.strategy-checkbox');
            const configOptions = strategyElement.querySelector('.strategy-config-options');

            checkbox.addEventListener('change', function () {
                configOptions.style.display = this.checked ? 'block' : 'none';

                // Si se desmarca, resetear las configuraciones
                if (!this.checked) {
                    const freqSelect = configOptions.querySelector('select');
                    freqSelect.selectedIndex = 0;
                }

                // ACTUALIZAR RECOMENDACIONES CLAVE - CORREGIDO
                const recommendationsContainer = document.getElementById('recommendations-container');
                if (recommendationsContainer) {
                    if (this.checked) {
                        // A√±adir recomendaci√≥n espec√≠fica
                        recommendationsContainer.innerHTML = agregarRecomendacionEspecifica(strategy, clasificacion);
                    } else {
                        // Eliminar recomendaci√≥n espec√≠fica
                        recommendationsContainer.innerHTML = eliminarRecomendacionEspecifica(strategy.id);
                    }
                } else {
                    console.error("El contenedor recommendations-container no existe en el DOM");
                }
            });

            // Inicialmente ocultar opciones de configuraci√≥n
            configOptions.style.display = 'none';

            // Configurar evento para mostrar detalles al hacer clic en cualquier parte de la estrategia
            strategyElement.addEventListener('click', function (e) {
                // Evitar activar el checkbox cuando se hace clic en los selects
                if (e.target.tagName !== 'SELECT' && e.target.tagName !== 'OPTION' &&
                    !e.target.closest('.form-check-input')) {
                    checkbox.checked = !checkbox.checked;
                    configOptions.style.display = checkbox.checked ? 'block' : 'none';

                    // Mostrar detalles completos de la estrategia
                    const detailsContainer = document.getElementById('macro-details-text');
                    if (detailsContainer) {
                        let detailsHTML = `
                            <h6 class="mb-2">${strategy.title}</h6>
                            <p class="mb-3">${strategy.description}</p>
                            <h6 class="mb-2">Detalles:</h6>
                            <ul class="list-group list-group-flush mb-3">
                        `;

                        // Manejar features de manera segura
                        const features = strategy.features || [];
                        if (Array.isArray(features)) {
                            features.forEach(feature => {
                                detailsHTML += `<li class="list-group-item"><i class="fas fa-circle text-muted me-2" style="font-size: 0.5em;"></i> ${feature}</li>`;
                            });
                        }

                        detailsHTML += `
                            </ul>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-1"></i> ${clasificacion.mensaje}
                            </div>
                        `;

                        detailsContainer.innerHTML = detailsHTML;
                    }

                    // ACTUALIZAR RECOMENDACIONES CLAVE - CORREGIDO
                    const recommendationsContainer = document.getElementById('recommendations-container');
                    if (recommendationsContainer) {
                        if (checkbox.checked) {
                            // A√±adir recomendaci√≥n espec√≠fica
                            recommendationsContainer.innerHTML = agregarRecomendacionEspecifica(strategy, clasificacion);
                        } else {
                            // Eliminar recomendaci√≥n espec√≠fica
                            recommendationsContainer.innerHTML = eliminarRecomendacionEspecifica(strategy.id);
                        }
                    } else {
                        console.error("El contenedor recommendations-container no existe en el DOM");
                    }
                }
            });
        } catch (error) {
            console.error(`Error al renderizar estrategia ${strategy.id}:`, error);
        }
    });
}

function updateSchedulePreview() {
    const daysContainer = document.getElementById('schedule-preview');
    daysContainer.innerHTML = '';

    const days = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
    const selectedDays = Array.from(document.querySelectorAll('#training-days .day-option.selected'))
        .map(day => day.dataset.day);

    days.forEach((day, index) => {
        const dayElement = document.createElement('div');
        dayElement.className = 'schedule-day';

        if (selectedDays.includes(day.toLowerCase().substring(0, 3))) {
            dayElement.classList.add('training');
            dayElement.innerHTML = `${day}<br><small>Entreno</small>`;
        } else {
            dayElement.classList.add('rest');
            dayElement.innerHTML = `${day}<br><small>Descanso</small>`;
        }

        daysContainer.appendChild(dayElement);
    });
}

function saveConfiguration() {
    // Aqu√≠ ir√≠a la l√≥gica para guardar la configuraci√≥n
    const selectedStrategy = document.querySelector('.radio-option.selected');
    const strategyId = selectedStrategy ? selectedStrategy.dataset.strategyId : 'Ninguna';

    const selectedStrategies = [];
    document.querySelectorAll('.strategy-checkbox:checked').forEach(checkbox => {
        const strategyId = checkbox.id.replace('chk-', '');
        selectedStrategies.push(strategyId);
    });

    const trainingDays = Array.from(document.querySelectorAll('#training-days .day-option.selected'))
        .map(day => day.dataset.day);

    const intensity = document.querySelector('.intensity-option.selected')?.dataset.intensity || 'moderada';
    const pauseFrequency = document.getElementById('pause-frequency').value;
    const reevalFrequency = document.getElementById('reeval-frequency').value;

    // En una implementaci√≥n real, aqu√≠ guardar√≠amos estos datos
    console.log('Configuraci√≥n guardada:', {
        strategyId,
        selectedStrategies,
        trainingDays,
        intensity,
        pauseFrequency,
        reevalFrequency
    });

    // Cerrar el modal
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    editModal.hide();

    // Mostrar mensaje de confirmaci√≥n
    alert('Configuraci√≥n guardada correctamente. El plan se actualizar√° con los nuevos par√°metros.');
}

// Versi√≥n especializada que NO actualiza los detalles
function updateMacroValuesWithoutDetailsUpdate() {
    const userWeightInput = document.getElementById('user-weight');
    if (!userWeightInput) return;

    const weight = parseFloat(userWeightInput.value) || 70;

    // Obtener prop√≥sito desde objetivoGeneral con mapeo correcto
    const propositoElement = document.getElementById('objetivoGeneral');
    let proposito = 'estetica'; // Valor por defecto

    if (propositoElement) {
        const propositoRaw = propositoElement.value.toLowerCase();
        if (propositoRaw.includes('salud')) proposito = 'salud';
        else if (propositoRaw.includes('estet')) proposito = 'estetica';
        else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
    }

    // Obtener fase desde el modal (almacenada en data-fase)
    const modal = document.getElementById('editModal');
    const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";

    // Obtener objetivo desde el formulario principal
    const objetivoSelect = document.getElementById('objetivo');
    const objetivo = objetivoSelect ? objetivoSelect.value.replace('1', '') : 'perdida';

    // Verificar si hay una estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');

    if (selectedStrategy) {
        try {
            // Usar la funci√≥n cient√≠ficamente validada
            const macros = actualizarMacros(objetivo, proposito, fase, weight);

            // Actualizar porcentajes en los inputs
            document.getElementById('proteinas-pct').value = macros.proteinasPct;
            document.getElementById('grasa-pct').value = macros.grasasPct;
            document.getElementById('hc-pct').value = macros.hcPct;

            // Calcular gramos basados en calor√≠as objetivo
            const calorieEstimate = parseInt(document.getElementById('goal-calories').value) || weight * 35;

            // Actualizar displays
            document.getElementById('proteinas-gr').innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                        <div class="progress-bar bg-success" style="width: ${macros.proteinasPct}%"></div>
                    </div>
                    <span>${macros.proteinasPct}% (${macros.proteinasGr})</span>
                </div>
            `;

            document.getElementById('grasa-gr').innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                        <div class="progress-bar bg-warning" style="width: ${macros.grasasPct}%"></div>
                    </div>
                    <span>${macros.grasasPct}% (${macros.grasasGr})</span>
                </div>
            `;

            document.getElementById('hc-gr').innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 10px;">
                        <div class="progress-bar bg-danger" style="width: ${macros.hcPct}%"></div>
                    </div>
                    <span>${macros.hcPct}% (${macros.hcGr})</span>
                </div>
            `;

            // Calcular y mostrar la suma de porcentajes
            actualizarSumaPorcentajes();

            return; // Salir ya que usamos la l√≥gica cient√≠fica

        } catch (error) {
            console.error("Error al actualizar macros con prop√≥sito:", proposito, error);
        }
    }

    // L√≥gica tradicional como fallback (si no hay estrategia seleccionada)
    const proteinPct = parseInt(document.getElementById('proteinas-pct').value) || 30;
    const fatPct = parseInt(document.getElementById('grasa-pct').value) || 30;
    const carbPct = parseInt(document.getElementById('hc-pct').value) || 40;

    const calorieEstimate = parseInt(document.getElementById('goal-calories').value) || weight * 35;

    const proteinGrams = Math.round((proteinPct / 100) * calorieEstimate / 4);
    const fatGrams = Math.round((fatPct / 100) * calorieEstimate / 9);
    const carbGrams = Math.round((carbPct / 100) * calorieEstimate / 4);

    const proteinPerKg = (proteinGrams / weight).toFixed(2);
    const fatPerKg = (fatGrams / weight).toFixed(2);
    const carbPerKg = (carbGrams / weight).toFixed(2);

    // Actualizar displays
    document.getElementById('proteinas-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-success" style="width: ${proteinPct}%"></div>
            </div>
            <span>${proteinPct}% (${proteinPerKg}g/kg)</span>
        </div>
    `;

    document.getElementById('grasa-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-warning" style="width: ${fatPct}%"></div>
            </div>
            <span>${fatPct}% (${fatPerKg}g/kg)</span>
        </div>
    `;

    document.getElementById('hc-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-danger" style="width: ${carbPct}%"></div>
            </div>
            <span>${carbPct}% (${carbPerKg}g/kg)</span>
        </div>
    `;
}

// Funci√≥n √∫nica y corregida - SIN DUPLICADOS
// Funci√≥n √∫nica y corregida - SIN DUPLICADOS
function reiniciarRecomendaciones(estrategiaBase, propositoKey, objetivo, faseKey) {
    console.log("Iniciando reiniciarRecomendaciones", {
        estrategiaBase: estrategiaBase?.title,
        propositoKey,
        objetivo,
        faseKey
    });

    try {
        // ASEGURAR QUE EL ESTADO EXISTA
        if (typeof recomendacionesState === 'undefined') {
            window.recomendacionesState = {
                estrategiaBase: null,
                estrategiasEspecificas: [],
                recomendaciones: {
                    base: [],
                    especificas: {}
                }
            };
        }

        // ASEGURAR QUE propositoKey EST√Å DEFINIDO
        if (!propositoKey) {
            const propositoElement = document.getElementById('objetivoGeneral');
            if (propositoElement) {
                const propositoRaw = propositoElement.value.toLowerCase();
                if (propositoRaw.includes('salud')) propositoKey = 'salud';
                else if (propositoRaw.includes('estet')) propositoKey = 'estetica';
                else if (propositoRaw.includes('rendimiento')) propositoKey = 'rendimiento';
            }
            if (!propositoKey) propositoKey = 'estetica'; // Valor por defecto
        }

        // ASEGURAR QUE faseKey EST√Å DEFINIDO
        if (!faseKey) {
            const modal = document.getElementById('editModal');
            if (modal) {
                faseKey = modal.getAttribute('data-fase') || "Fase 1 (0-12 sem)";
            } else {
                faseKey = "Fase 1 (0-12 sem)";
            }
        }

        console.log("propositoKey determinado:", propositoKey);
        console.log("faseKey determinado:", faseKey);

        // Actualizar el estado
        recomendacionesState.estrategiaBase = estrategiaBase.id;
        recomendacionesState.estrategiaBaseObj = estrategiaBase;
        recomendacionesState.estrategiasEspecificas = [];
        recomendacionesState.recomendaciones = {
            base: [],
            especificas: {}
        };

        // MANEJO SEGURO DE obtenerRecomendacionesBase
        let recomendacionesBase = [];

        if (typeof obtenerRecomendacionesBase === 'function') {
            try {
                // PASAR faseKey A LA FUNCI√ìN
                recomendacionesBase = obtenerRecomendacionesBase(estrategiaBase, propositoKey, objetivo, faseKey) || [];
            } catch (error) {
                console.error("Error al obtener recomendaciones base:", error);
            }
        }

        // Si a√∫n no hay recomendaciones, usar recomendaciones por defecto
        if (recomendacionesBase.length === 0) {
            recomendacionesBase = [
                {
                    icon: "fas fa-sync-alt",
                    title: "Metabolic Flexibility Training",
                    text: "Implementa rotaci√≥n semanal de HC (50-100g) tras 8-12 semanas para evitar adaptaci√≥n metab√≥lica"
                },
                {
                    icon: "fas fa-clock",
                    title: "Ayuno Intermitente",
                    text: "Solo tras 12 semanas de estabilidad con tu estrategia base, nunca al inicio"
                }
            ];
        }

        recomendacionesState.recomendaciones.base = recomendacionesBase;

        // USAR faseKey EN LUGAR DE "Fase 1 (0-12 sem)" FIJO
        const html = generarHTMLRecomendaciones([], estrategiaBase, faseKey, recomendacionesBase);
        console.log("HTML generado:", html);

        return html;
    } catch (error) {
        console.error("Error en reiniciarRecomendaciones:", error);
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    Error al generar recomendaciones: ${error.message}
                </div>
            </div>
        `;
    }
}















function obtenerRecomendacionesBase(estrategiaBase, propositoKey, objetivo, faseKey) {
    // Normalizar objetivo
    const objetivoKey = objetivo.toLowerCase().includes('perdida') ? 'perdida' :
        objetivo.toLowerCase().includes('ganancia') ? 'ganancia' :
            objetivo.toLowerCase().includes('mantenimiento') ? 'mantenimiento' :
                objetivo.toLowerCase().includes('mixto') ? 'mixto' : 'perdida';

    // Normalizar faseKey para coincidir con la matriz
    let faseEstandarizada = faseKey;
    const faseMap = {
        '1': 'Fase 1 (0-12 sem)',
        '2': 'Fase 2 (12-24 sem)',
        '3': 'Fase 3 Avanzada (>24 sem)',
        '4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)',
        'Fase 1': 'Fase 1 (0-12 sem)',
        'Fase 2': 'Fase 2 (12-24 sem)',
        'Fase 3': 'Fase 3 Avanzada (>24 sem)',
        'Fase 4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)'
    };

    if (faseMap[faseKey]) {
        faseEstandarizada = faseMap[faseKey];
    }

    // Buscar en la nueva matriz
    if (typeof recomendacionesBaseMatriz !== 'undefined' &&
        recomendacionesBaseMatriz[objetivoKey] &&
        recomendacionesBaseMatriz[objetivoKey][faseEstandarizada] &&
        recomendacionesBaseMatriz[objetivoKey][faseEstandarizada][estrategiaBase.title]) {

        // Convertir el array de strings a array de objetos
        return recomendacionesBaseMatriz[objetivoKey][faseEstandarizada][estrategiaBase.title].map((rec, index) => ({
            icon: index === 0 ? "fas fa-sync-alt" :
                index === 1 ? "fas fa-clock" :
                    index === 2 ? "fas fa-balance-scale" :
                        index === 3 ? "fas fa-leaf" :
                            "fas fa-star",
            title: `Recomendaci√≥n ${index + 1}`,
            text: rec
        }));
    }

    // Si no hay datos en la nueva matriz, usar el sistema anterior
    let recomendacionesBase = [];

    if (estrategiaCompleta && estrategiaCompleta[objetivoKey] && estrategiaCompleta[objetivoKey][propositoKey]) {
        recomendacionesBase = estrategiaCompleta[objetivoKey][propositoKey].resumenEjecutivo || [];
    }

    if (recomendacionesBase.length === 0 && typeof obtenerRecomendacionesEstrategia === 'function') {
        recomendacionesBase = obtenerRecomendacionesEstrategia(estrategiaBase.id, propositoKey, objetivo) || [];
    }

    if (recomendacionesBase.length === 0) {
        recomendacionesBase = [
            {
                icon: "fas fa-sync-alt",
                title: "Metabolic Flexibility Training",
                text: "Implementa rotaci√≥n semanal de HC (50-100g) tras 8-12 semanas para evitar adaptaci√≥n metab√≥lica"
            },
            {
                icon: "fas fa-clock",
                title: "Ayuno Intermitente",
                text: "Solo tras 12 semanas de estabilidad con tu estrategia base, nunca al inicio"
            }
        ];
    }

    return recomendacionesBase;
}
function agregarRecomendacionEspecifica(estrategiaEspecifica, clasificacion) {
    console.log("Agregando recomendaci√≥n espec√≠fica", {
        estrategia: estrategiaEspecifica.title,
        clasificacion: clasificacion.clasificacion
    });

    try {
        // Si ya existe, actualizar
        if (recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id]) {
            recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
                clasificacion: clasificacion,
                estrategia: estrategiaEspecifica
            };
        } else {
            // A√±adir nueva
            recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
                clasificacion: clasificacion,
                estrategia: estrategiaEspecifica
            };

            // Actualizar la lista de estrategias espec√≠ficas seleccionadas
            if (!recomendacionesState.estrategiasEspecificas.includes(estrategiaEspecifica.id)) {
                recomendacionesState.estrategiasEspecificas.push(estrategiaEspecifica.id);
            }
        }

        // Convertir el estado a formato de an√°lisis
        const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
            esCompatible: item.clasificacion.clasificacion !== 'contraindicada' &&
                item.clasificacion.clasificacion !== 'no recomendada',
            clasificacion: item.clasificacion,
            estrategia: item.estrategia
        }));

        // Obtener la estrategia base actual
        const estrategiaBase = encontrarEstrategiaBase(recomendacionesState.estrategiaBase);

        // Generar HTML para mostrar
        const html = generarHTMLRecomendaciones(
            analisis,
            estrategiaBase,
            "Fase 1 (0-12 sem)",
            recomendacionesState.recomendaciones.base
        );

        console.log("HTML generado para agregarRecomendacionEspecifica");
        return html;
    } catch (error) {
        console.error("Error en agregarRecomendacionEspecifica:", error);
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Error al agregar recomendaci√≥n: ${error.message}
                </div>
            </div>
        `;
    }
}

function agregarRecomendacionEspecifica(estrategiaEspecifica, clasificacion) {
    // ASEGURAR QUE EL ESTADO EXISTA
    if (typeof recomendacionesState === 'undefined') {
        window.recomendacionesState = {
            estrategiaBase: null,
            estrategiasEspecificas: [],
            recomendaciones: {
                base: [],
                especificas: {}
            }
        };
    }

    // Si ya existe, actualizar
    if (recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id]) {
        recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
            clasificacion: clasificacion,
            estrategia: estrategiaEspecifica
        };
    } else {
        // A√±adir nueva
        recomendacionesState.recomendaciones.especificas[estrategiaEspecifica.id] = {
            clasificacion: clasificacion,
            estrategia: estrategiaEspecifica
        };

        // Actualizar la lista de estrategias espec√≠ficas seleccionadas
        if (!recomendacionesState.estrategiasEspecificas.includes(estrategiaEspecifica.id)) {
            recomendacionesState.estrategiasEspecificas.push(estrategiaEspecifica.id);
        }
    }

    // Convertir el estado a formato de an√°lisis
    const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
        esCompatible: item.clasificacion.clasificacion !== 'contraindicada' &&
            item.clasificacion.clasificacion !== 'no recomendada',
        clasificacion: item.clasificacion,
        estrategia: item.estrategia
    }));

    // Obtener la estrategia base actual
    let estrategiaBase = recomendacionesState.estrategiaBaseObj;

    // Si no tenemos la estrategia completa guardada, buscarla
    if (!estrategiaBase && recomendacionesState.estrategiaBase) {
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === recomendacionesState.estrategiaBase);
                if (estrategia) {
                    estrategiaBase = estrategia;
                    recomendacionesState.estrategiaBaseObj = estrategia; // GUARDAR PARA FUTURAS USOS
                    break;
                }
            }
            if (estrategiaBase) break;
        }
    }

    // Generar HTML para mostrar
    return generarHTMLRecomendaciones(
        analisis,
        estrategiaBase,
        "Fase 1 (0-12 sem)",
        recomendacionesState.recomendaciones.base
    );
}

function eliminarRecomendacionEspecifica(estrategiaId) {
    // ASEGURAR QUE EL ESTADO EXISTA
    if (typeof recomendacionesState === 'undefined') {
        window.recomendacionesState = {
            estrategiaBase: null,
            estrategiasEspecificas: [],
            recomendaciones: {
                base: [],
                especificas: {}
            }
        };
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Selecciona una estrategia base para ver recomendaciones espec√≠ficas.
                </div>
            </div>
        `;
    }

    // Eliminar de las recomendaciones espec√≠ficas
    delete recomendacionesState.recomendaciones.especificas[estrategiaId];

    // Eliminar de la lista de estrategias espec√≠ficas seleccionadas
    recomendacionesState.estrategiasEspecificas = recomendacionesState.estrategiasEspecificas.filter(id => id !== estrategiaId);

    // Convertir el estado a formato de an√°lisis
    const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
        esCompatible: item.clasificacion.clasificacion !== 'contraindicada' &&
            item.clasificacion.clasificacion !== 'no recomendada',
        clasificacion: item.clasificacion,
        estrategia: item.estrategia
    }));

    // Obtener la estrategia base actual
    let estrategiaBase = recomendacionesState.estrategiaBaseObj;

    // Si no tenemos la estrategia completa guardada, buscarla
    if (!estrategiaBase && recomendacionesState.estrategiaBase) {
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === recomendacionesState.estrategiaBase);
                if (estrategia) {
                    estrategiaBase = estrategia;
                    recomendacionesState.estrategiaBaseObj = estrategia; // GUARDAR PARA FUTURAS USOS
                    break;
                }
            }
            if (estrategiaBase) break;
        }
    }

    // Generar HTML para mostrar
    return generarHTMLRecomendaciones(
        analisis,
        estrategiaBase,
        "Fase 1 (0-12 sem)",
        recomendacionesState.recomendaciones.base
    );
}

function eliminarRecomendacionEspecifica(estrategiaId) {
    // ‚úÖ ASEGURAR QUE EL ESTADO EXISTA
    if (typeof recomendacionesState === 'undefined') {
        window.recomendacionesState = {
            estrategiaBase: null,
            estrategiasEspecificas: [],
            recomendaciones: {
                base: [],
                especificas: {}
            }
        };
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> Selecciona una estrategia base para ver recomendaciones espec√≠ficas.
                </div>
            </div>
        `;
    }

    // Eliminar de las recomendaciones espec√≠ficas
    delete recomendacionesState.recomendaciones.especificas[estrategiaId];

    // Eliminar de la lista de estrategias espec√≠ficas seleccionadas
    recomendacionesState.estrategiasEspecificas = recomendacionesState.estrategiasEspecificas.filter(id => id !== estrategiaId);

    // Convertir el estado a formato de an√°lisis
    const analisis = Object.values(recomendacionesState.recomendaciones.especificas).map(item => ({
        esCompatible: item.clasificacion.clasificacion !== 'contraindicada' &&
            item.clasificacion.clasificacion !== 'no recomendada',
        clasificacion: item.clasificacion,
        estrategia: item.estrategia
    }));

    // ‚úÖ OBTENER LA ESTRATEGIA BASE DE FORMA EFICIENTE
    let estrategiaBase = recomendacionesState.estrategiaBaseObj;

    // Si no tenemos la estrategia completa guardada, buscarla
    if (!estrategiaBase && recomendacionesState.estrategiaBase) {
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === recomendacionesState.estrategiaBase);
                if (estrategia) {
                    estrategiaBase = estrategia;
                    recomendacionesState.estrategiaBaseObj = estrategia; // ‚úÖ GUARDAR PARA FUTURAS USOS
                    break;
                }
            }
            if (estrategiaBase) break;
        }
    }

    // Generar HTML para mostrar
    return generarHTMLRecomendaciones(
        analisis,
        estrategiaBase,
        "Fase 1 (0-12 sem)",
        recomendacionesState.recomendaciones.base
    );
}

function encontrarEstrategiaBase(strategyId) {
    console.log("Buscando estrategia base", { strategyId });

    try {
        // Buscar en todas las categor√≠as de estrategias base
        for (const objetivo in estrategiasBaseConfig) {
            for (const fase in estrategiasBaseConfig[objetivo]) {
                const estrategias = estrategiasBaseConfig[objetivo][fase];
                const estrategia = estrategias.find(e => e.id === strategyId);
                if (estrategia) {
                    console.log("Estrategia base encontrada", { title: estrategia.title });
                    return estrategia;
                }
            }
        }

        console.warn("No se encontr√≥ la estrategia base");
        return null;
    } catch (error) {
        console.error("Error al encontrar estrategia base:", error);
        return null;
    }
}




function generarRecomendacionesClave(objetivo, proposito, strategyId = null) {
    if (!objetivo || !proposito) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones espec√≠ficas.</div></div>`;
    }

    // Si hay una estrategia base seleccionada, obtener sus recomendaciones espec√≠ficas
    if (strategyId) {
        const recomendacionesEstrategia = obtenerRecomendacionesEstrategia(strategyId, proposito, objetivo);

        if (recomendacionesEstrategia && Array.isArray(recomendacionesEstrategia) && recomendacionesEstrategia.length > 0) {
            const items = recomendacionesEstrategia.map(rec => `
                <div class="recommendation-item mb-3">
                    <div class="d-flex">
                        <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                        <div>
                            <h6 class="mb-1">${rec.title}</h6>
                            <p class="mb-0">${rec.text}</p>
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="recommendations-section">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Espec√≠ficas</h6>
                    ${items}
                </div>
            `;
        }
    }

    // Si no hay estrategia base seleccionada o no tiene recomendaciones espec√≠ficas,
    // mostrar las recomendaciones gen√©ricas para el objetivo y prop√≥sito

    // Normalizar objetivo y prop√≥sito
    const objetivoNormalizado = objetivo.toLowerCase();
    const propositoNormalizado = proposito.toLowerCase();

    // Encontrar las claves correctas
    let objetivoKey;
    if (objetivoNormalizado.includes('perdida')) objetivoKey = 'perdida';
    else if (objetivoNormalizado.includes('ganancia')) objetivoKey = 'ganancia';
    else if (objetivoNormalizado.includes('mantenimiento')) objetivoKey = 'mantenimiento';
    else if (objetivoNormalizado.includes('mixto')) objetivoKey = 'mixto';

    let propositoKey;
    if (propositoNormalizado.includes('salud')) propositoKey = 'salud';
    else if (propositoNormalizado.includes('estet')) propositoKey = 'estetica';
    else if (propositoNormalizado.includes('rendimiento')) propositoKey = 'rendimiento';

    // Si no encontramos coincidencias, usar valores por defecto
    if (!objetivoKey || !propositoKey) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones espec√≠ficas.</div></div>`;
    }

    // Obtener el resumen ejecutivo
    const resumen = estrategiaCompleta[objetivoKey]?.[propositoKey]?.resumenEjecutivo || [];

    // Si no hay resumen ejecutivo, mostrar mensaje
    if (resumen.length === 0) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Key Points</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>No hay recomendaciones clave espec√≠ficas para esta combinaci√≥n.</div></div>`;
    }

    const items = resumen.map(rec => `
        <div class="recommendation-item mb-3">
            <div class="d-flex">
                <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                <div>
                    <h6 class="mb-1">${rec.title}</h6>
                    <p class="mb-0">${rec.text}</p>
                </div>
            </div>
        </div>
    `).join('');

    return `
        <div class="recommendations-section">
            <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
            ${items}
        </div>
    `;
}





function renderOptimalStrategyContent(objetivo, proposito, strategyId, fase) {
    // Buscar el contenedor espec√≠fico que tienes en tu HTML
    const contentContainer = document.getElementById('optimal-strategy-content');
    if (!contentContainer) {
        console.error("No se encontr√≥ el contenedor #optimal-strategy-content para Estrategia √ìptima");
        return;
    }

    try {
        // Si no hay estrategia base seleccionada, mostrar mensaje informativo
        if (!strategyId) {
            contentContainer.innerHTML = `
                <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle me-1"></i> 
                    Selecciona una estrategia base para ver la Estrategia √ìptima personalizada.
                </div>
            `;
            return;
        }

        // Mapear el objetivo a los nombres correctos en estrategiaCompleta
        const objetivoMap = {
            'perdida': 'perdida',
            'ganancia': 'ganancia',
            'mantenimiento': 'mantenimiento',
            'mixto': 'mixto'
        };

        // Mapear el prop√≥sito a los nombres correctos en estrategiaCompleta
        const propositoMap = {
            'salud': 'salud',
            'estetica': 'estetica',
            'rendimiento': 'rendimiento'
        };

        // Obtener el objetivo y prop√≥sito mapeados
        const objetivoKey = objetivoMap[objetivo] || 'perdida';
        const propositoKey = propositoMap[proposito] || 'estetica';

        // Obtener el an√°lisis completo de la matriz
        const analisis = estrategiaCompleta[objetivoKey]?.[propositoKey]?.analisisCompleto;

        if (!analisis) {
            contentContainer.innerHTML = `
                <div class="alert alert-warning mt-2">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    No se encontr√≥ informaci√≥n para esta combinaci√≥n de objetivo y prop√≥sito.
                </div>
            `;
            return;
        }

        // Generar HTML para la secci√≥n Estrategia √ìptima
        let html = `
            <div class="optimal-strategy-section mb-4">
                <!--<h5 class="text-muted mb-3"><i class="fas fa-chart-line me-2" style="color: #5e9a4f;"></i> Estrategia √ìptima</h5>-->
        `;

        // 1. Secci√≥n de Conclusi√≥n
        if (analisis.conclusion) {
            html += `
                <div class="conclusion-section mb-4">
                    <h6 class="text-success mb-2"><i class="fas fa-check-circle me-1"></i> Conclusi√≥n</h6>
                    <div class="alert alert-success">
                        ${analisis.conclusion}
                    </div>
                </div>
            `;
        }

        // 2. Secci√≥n de Contraindicaciones
        if (analisis.contraindicaciones && analisis.contraindicaciones.length > 0) {
            html += `
                <div class="contraindicaciones-section mb-4">
                    <h6 class="text-danger mb-2"><i class="fas fa-exclamation-triangle me-1"></i> Contraindicaciones</h6>
                    <ul class="list-group list-group-flush">`;

            analisis.contraindicaciones.forEach(contraindicacion => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-times-circle text-danger me-1"></i> 
                        ${contraindicacion}
                    </li>`;
            });

            html += `
                    </ul>
                </div>`;
        }

        // 3. Secci√≥n de Errores Cr√≠ticos
        if (analisis.erroresCriticos && analisis.erroresCriticos.length > 0) {
            html += `
                <div class="errores-criticos-section mb-4">
                    <h6 class="text-warning mb-2"><i class="fas fa-exclamation-circle me-1"></i> Errores Cr√≠ticos</h6>
                    <div class="accordion" id="erroresCriticosAccordion">`;

            analisis.erroresCriticos.forEach((error, index) => {
                const idCollapse = `errorCollapse${index}`;
                const idHeading = `errorHeading${index}`;

                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="${idHeading}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${idCollapse}" aria-expanded="false" aria-controls="${idCollapse}">
                                ${error.titulo}
                            </button>
                        </h2>
                        <div id="${idCollapse}" class="accordion-collapse collapse" aria-labelledby="${idHeading}" data-bs-parent="#erroresCriticosAccordion">
                            <div class="accordion-body">
                                <p>${error.descripcion}</p>
                                ${error.fuente ? `<small class="text-muted">${error.fuente}</small>` : ''}
                            </div>
                        </div>
                    </div>`;
            });

            html += `
                    </div>
                </div>`;
        }

        html += `
            </div>
        `;

        contentContainer.innerHTML = html;

        // Inicializar los acordeones de Bootstrap
        const accordions = contentContainer.querySelectorAll('.accordion');
        accordions.forEach(accordion => {
            new bootstrap.Collapse(accordion);
        });
    } catch (error) {
        console.error("Error al renderizar Estrategia √ìptima:", error);
        contentContainer.innerHTML = `
            <div class="alert alert-danger mt-2">
                <i class="fas fa-exclamation-triangle me-1"></i> 
                Error al generar contenido de Estrategia √ìptima: ${error.message}
            </div>
        `;
    }
}
// ===== FUNCIONES NUEVAS PARA VALIDACI√ìN DE MACROS =====
function normalizarEstructuraMacros(estrategiaBase, proposito) {
    // Obtener los macros para el prop√≥sito especificado
    const macrosBase = estrategiaBase.macros[`macros${proposito.charAt(0).toUpperCase() + proposito.slice(1)}`];

    // Si ya tiene la estructura completa (diasEntreno y diasDescanso), devolverla
    if (macrosBase.diasDescanso && macrosBase.diasEntreno) {
        return macrosBase;
    }

    // Caso especial: Formato de texto con "D√≠as descanso: ... | D√≠as entreno: ..."
    if (typeof macrosBase.proteinGr === 'string' && macrosBase.proteinGr.includes('|')) {
        const diasDescansoMatch = macrosBase.proteinGr.match(/D√≠as descanso: ([^|]+)/);
        const diasEntrenoMatch = macrosBase.proteinGr.match(/D√≠as entreno: ([^|]+)/);

        return {
            diasDescanso: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasDescansoMatch ? diasDescansoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ?
                    macrosBase.carbinGr.match(/D√≠as descanso: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ?
                    macrosBase.fatinGr.match(/D√≠as descanso: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            },
            diasEntreno: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasEntrenoMatch ? diasEntrenoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ?
                    macrosBase.carbinGr.match(/D√≠as entreno: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ?
                    macrosBase.fatinGr.match(/D√≠as entreno: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            }
        };
    }

    // Caso especial: Formato con semanas (semanasBajasHC, semanasAltasHC, etc.)
    if (macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase.semanasAltasHC) {
        return {
            diasDescanso: macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase,
            diasEntreno: macrosBase.semanasAltasHC || macrosBase
        };
    }

    // Caso especial: Formato con tipos de entrenamiento (fuerza, resistencia)
    if (macrosBase.fuerza || macrosBase.resistencia) {
        return {
            diasDescanso: macrosBase.resistencia || macrosBase,
            diasEntreno: macrosBase.fuerza || macrosBase
        };
    }

    // Caso especial: Formato con d√≠as de d√©ficit/super√°vit
    if (macrosBase.diasDeficit || macrosBase.diasSuperavit) {
        return {
            diasDescanso: macrosBase.diasDeficit || macrosBase,
            diasEntreno: macrosBase.diasSuperavit || macrosBase
        };
    }

    // Si no hay diferenciaci√≥n, crear una estructura est√°ndar
    return {
        diasDescanso: macrosBase,
        diasEntreno: macrosBase
    };
}
function actualizarSumaPorcentajes() {
    const proteinPct = parseInt(document.getElementById('proteinas-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pct').value) || 0;
    const total = proteinPct + fatPct + carbPct;

    // Mostrar suma de porcentajes
    const sumaElement = document.getElementById('macros-total');
    if (sumaElement) {
        sumaElement.textContent = total;

        // Cambiar color seg√∫n validez
        if (total === 100) {
            sumaElement.className = 'badge bg-success';
        } else {
            sumaElement.className = 'badge bg-warning';
        }
    }

    // Actualizar advertencias
    actualizarAdvertenciasMacros(proteinPct, fatPct, carbPct);

    // Actualizar gramos por kg
    actualizarGramosPorKg();
}

// Configurar eventos para actualizar la suma cuando cambian los inputs
document.addEventListener('DOMContentLoaded', function () {
    const proteinInput = document.getElementById('proteinas-pct');
    const fatInput = document.getElementById('grasa-pct');
    const carbInput = document.getElementById('hc-pct');

    if (proteinInput) {
        proteinInput.addEventListener('input', actualizarSumaPorcentajes);
    }
    if (fatInput) {
        fatInput.addEventListener('input', actualizarSumaPorcentajes);
    }
    if (carbInput) {
        carbInput.addEventListener('input', actualizarSumaPorcentajes);
    }

    // Inicializar la suma
    setTimeout(actualizarSumaPorcentajes, 100);
});

function actualizarAdvertenciasMacros(proteinPct, fatPct, carbPct) {
    const warningsContainer = document.getElementById('macro-warnings');
    if (!warningsContainer) return;
    let warnings = [];

    // Verificar rangos saludables generales
    if (proteinPct < 15 || proteinPct > 40) {
        warnings.push("‚ö†Ô∏è Prote√≠nas fuera del rango saludable general (15-40%)");
    }
    if (fatPct < 15 || fatPct > 70) {
        warnings.push("‚ö†Ô∏è Grasas fuera del rango saludable general (15-70%)");
    }
    if (carbPct < 5 || carbPct > 70) {
        warnings.push("‚ö†Ô∏è HC fuera del rango saludable general (5-70%)");
    }

    // Obtener la estrategia base seleccionada
    const selectedStrategy = document.querySelector('.radio-option.selected');
    if (selectedStrategy) {
        const strategyId = selectedStrategy.dataset.strategyId;

        // Buscar la estrategia en los objetos de configuraci√≥n
        const modal = document.getElementById('editModal');
        const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";
        const objetivoSelect = document.getElementById('objetivo');
        const objetivo = objetivoSelect ? objetivoSelect.value.replace('1', '') : 'perdida';

        // Obtener prop√≥sito
        const propositoElement = document.getElementById('objetivoGeneral');
        let proposito = 'estetica';
        if (propositoElement) {
            const propositoRaw = propositoElement.value.toLowerCase();
            if (propositoRaw.includes('salud')) proposito = 'salud';
            else if (propositoRaw.includes('estet')) proposito = 'estetica';
            else if (propositoRaw.includes('rendimiento')) proposito = 'rendimiento';
        }

        try {
            // Buscar la configuraci√≥n espec√≠fica de la estrategia
            const faseConfig = estrategiasBaseConfig[objetivo][fase].find(item =>
                item.id === strategyId && item.aplicable.includes(objetivo)
            );

            if (faseConfig) {
                const macros = faseConfig.macros;
                let macrosSeleccionados;

                switch (proposito) {
                    case 'salud':
                        macrosSeleccionados = macros.macrosSalud;
                        break;
                    case 'estetica':
                        macrosSeleccionados = macros.macrosEstetica;
                        break;
                    case 'rendimiento':
                        macrosSeleccionados = macros.macrosRendimiento;
                        break;
                    default:
                        macrosSeleccionados = macros.macrosEstetica;
                }

                // Funci√≥n auxiliar para extraer rangos
                const getRango = (rangoStr) => {
                    if (typeof rangoStr !== 'string') return { min: 0, max: 100 };

                    const match = rangoStr.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                    if (match) {
                        return {
                            min: parseFloat(match[1]),
                            max: parseFloat(match[2])
                        };
                    }

                    // Para casos especiales como "60-70% (d√≠as entrenamiento)| 25-35% (d√≠as descanso)"
                    if (rangoStr.includes('|')) {
                        const partes = rangoStr.split('|');
                        const primeraParte = partes[0].trim();
                        const matchPrimera = primeraParte.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                        if (matchPrimera) {
                            return {
                                min: parseFloat(matchPrimera[1]),
                                max: parseFloat(matchPrimera[2])
                            };
                        }
                    }

                    // Para casos con valores √∫nicos
                    const simpleMatch = rangoStr.match(/(\d+\.?\d*)/);
                    if (simpleMatch) {
                        const valor = parseFloat(simpleMatch[1]);
                        return { min: valor, max: valor };
                    }

                    return { min: 0, max: 100 };
                };

                // Verificar prote√≠nas
                const proteinRange = getRango(macrosSeleccionados.proteinPct);
                if (proteinPct < proteinRange.min || proteinPct > proteinRange.max) {
                    warnings.push(`‚ö†Ô∏è Prote√≠nas fuera del rango √≥ptimo para esta estrategia (${proteinRange.min}-${proteinRange.max}%)`);
                }

                // Verificar grasas
                const fatRange = getRango(macrosSeleccionados.fatPct);
                if (fatPct < fatRange.min || fatPct > fatRange.max) {
                    warnings.push(`‚ö†Ô∏è Grasas fuera del rango √≥ptimo para esta estrategia (${fatRange.min}-${fatRange.max}%)`);
                }

                // Verificar HC
                const carbRange = getRango(macrosSeleccionados.carbPct);
                if (carbPct < carbRange.min || carbPct > carbRange.max) {
                    warnings.push(`‚ö†Ô∏è HC fuera del rango √≥ptimo para esta estrategia (${carbRange.min}-${carbRange.max}%)`);
                }
            }
        } catch (error) {
            console.error("Error al verificar rangos √≥ptimos:", error);
        }
    }

    // Actualizar el contenedor de advertencias
    if (warnings.length > 0) {
        warningsContainer.innerHTML = warnings.join('<br>');
        warningsContainer.style.display = 'block';
    } else {
        warningsContainer.style.display = 'none';
    }
}

function actualizarGramosPorKg() {
    const proteinPct = parseInt(document.getElementById('proteinas-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pct').value) || 0;

    const userWeightInput = document.getElementById('user-weight');
    const weight = userWeightInput ? parseFloat(userWeightInput.value) || 70 : 70;

    // Obtener el GET real desde el campo de calor√≠as objetivo
    const goalCaloriesInput = document.getElementById('goal-calories');
    let calorieEstimate = weight * 35; // Valor por defecto

    if (goalCaloriesInput && goalCaloriesInput.value) {
        const goalCalories = parseInt(goalCaloriesInput.value);
        if (!isNaN(goalCalories) && goalCalories > 0) {
            calorieEstimate = goalCalories;
        }
    }

    // Calcular gramos totales
    const proteinGrams = Math.round((proteinPct / 100) * calorieEstimate / 4);
    const fatGrams = Math.round((fatPct / 100) * calorieEstimate / 9);
    const carbGrams = Math.round((carbPct / 100) * calorieEstimate / 4);

    // Calcular gramos por kg
    const proteinPerKg = (proteinGrams / weight).toFixed(1);
    const fatPerKg = (fatGrams / weight).toFixed(1);
    const carbPerKg = (carbGrams / weight).toFixed(1);

    // Formatear la salida como "XX% (YYYg: ZZ.Zg/kg)"
    document.getElementById('proteinas-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-success" style="width: ${proteinPct}%"></div>
            </div>
            <span>${proteinPct}% <small class="text-muted" style="font-size: 0.85em;">(${proteinGrams}g: ${proteinPerKg}g/kg)</small></span>
        </div>
    `;

    document.getElementById('grasa-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-warning" style="width: ${fatPct}%"></div>
            </div>
            <span>${fatPct}% <small class="text-muted" style="font-size: 0.85em;">(${fatGrams}g: ${fatPerKg}g/kg)</small></span>
        </div>
    `;

    document.getElementById('hc-gr').innerHTML = `
        <div class="d-flex align-items-center">
            <div class="progress flex-grow-1 me-2" style="height: 10px;">
                <div class="progress-bar bg-danger" style="width: ${carbPct}%"></div>
            </div>
            <span>${carbPct}% <small class="text-muted" style="font-size: 0.85em;">(${carbGrams}g: ${carbPerKg}g/kg)</small></span>
        </div>
    `;
}
function actualizarSumaPorcentajesPausa() {
    const proteinPct = parseInt(document.getElementById('proteinas-pausa-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasas-pausa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pausa-pct').value) || 0;

    const total = proteinPct + fatPct + carbPct;

    // Mostrar suma de porcentajes
    const sumaElement = document.getElementById('macros-pausa-total');
    if (sumaElement) {
        sumaElement.textContent = total;

        // Cambiar color seg√∫n validez
        if (Math.abs(total - 100) < 0.5) {
            sumaElement.className = 'badge bg-success';
        } else {
            sumaElement.className = 'badge bg-warning';
        }
    }

    // Actualizar advertencias
    actualizarAdvertenciasMacrosPausa(proteinPct, fatPct, carbPct);

    // Actualizar gramos por kg
    actualizarGramosPorKgPausa();
}

function actualizarAdvertenciasMacrosPausa(proteinPct, fatPct, carbPct) {
    const warningsContainer = document.getElementById('macro-pausa-warnings');
    if (!warningsContainer) return;

    let warnings = [];

    // Verificar rangos saludables para pausas
    if (proteinPct < 15 || proteinPct > 25) {
        warnings.push("‚ö†Ô∏è Prote√≠nas fuera del rango saludable para pausas (15-25%)");
    }
    if (fatPct < 25 || fatPct > 45) {
        warnings.push("‚ö†Ô∏è Grasas fuera del rango saludable para pausas (15-45%)");
    }
    if (carbPct < 25 || carbPct > 50) {
        warnings.push("‚ö†Ô∏è HC fuera del rango saludable para pausas (25-50%)");
    }

    // Verificar consistencia con la fase actual
    const modal = document.getElementById('editModal');
    const fase = modal ? modal.getAttribute('data-fase') : "Fase 1 (0-12 sem)";

    // Para fases avanzadas, los rangos pueden ser diferentes
    if (fase.includes("Avanzada") || fase.includes("Ajuste Metab√≥lico")) {
        if (proteinPct < 20 || proteinPct > 30) {
            warnings.push("‚ö†Ô∏è En fases avanzadas, el rango √≥ptimo de prote√≠nas es 20-30%");
        }
        if (fatPct < 25 || fatPct > 40) {
            warnings.push("‚ö†Ô∏è En fases avanzadas, el rango √≥ptimo de grasas es 25-40%");
        }
        if (carbPct < 30 || carbPct > 45) {
            warnings.push("‚ö†Ô∏è En fases avanzadas, el rango √≥ptimo de HC es 30-45%");
        }
    }
    // Verificar suma
    const total = proteinPct + fatPct + carbPct;
    if (Math.abs(total - 100) > 2) {
        warnings.push(`‚ö†Ô∏è La suma de porcentajes es ${total}%, deber√≠a ser cercano a 100%`);
    }

    // Actualizar el contenedor de advertencias
    if (warnings.length > 0) {
        warningsContainer.innerHTML = warnings.join('<br>');
        warningsContainer.style.display = 'block';
    } else {
        warningsContainer.style.display = 'none';
    }
}

function actualizarGramosPorKgPausa() {
    const userWeightInput = document.getElementById('user-weight');
    const weight = userWeightInput ? parseFloat(userWeightInput.value) || 70 : 70;

    // Obtener porcentajes actuales
    const proteinPct = parseInt(document.getElementById('proteinas-pausa-pct').value) || 0;
    const fatPct = parseInt(document.getElementById('grasas-pausa-pct').value) || 0;
    const carbPct = parseInt(document.getElementById('hc-pausa-pct').value) || 0;

    // ‚úÖ OBTENER EL GET REAL (NO USAR weight * 35 COMO VALOR POR DEFECTO)
    const goalCaloriesInput = document.getElementById('goal-calories');
    let calorieEstimate = weight * 35; // Valor por defecto

    if (goalCaloriesInput && goalCaloriesInput.value) {
        const goalCalories = parseInt(goalCaloriesInput.value);
        if (!isNaN(goalCalories) && goalCalories > 0) {
            calorieEstimate = goalCalories;
        }
    }

    // ‚úÖ CALCULAR GRAMOS TOTALES PRIMERO
    const proteinGrams = Math.round((proteinPct / 100) * calorieEstimate / 4);
    const fatGrams = Math.round((fatPct / 100) * calorieEstimate / 9);
    const carbGrams = Math.round((carbPct / 100) * calorieEstimate / 4);

    // ‚úÖ CALCULAR GRAMOS POR KG (DIVIDIENDO LOS GRAMOS TOTALES ENTRE EL PESO)
    const proteinPerKg = (proteinGrams / weight).toFixed(1);
    const fatPerKg = (fatGrams / weight).toFixed(1);
    const carbPerKg = (carbGrams / weight).toFixed(1);

    // Actualizar los elementos de visualizaci√≥n
    const proteinGrDisplay = document.getElementById('proteinas-pausa-gr');
    const fatGrDisplay = document.getElementById('grasas-pausa-gr');
    const carbGrDisplay = document.getElementById('hc-pausa-gr');

    if (proteinGrDisplay) {
        proteinGrDisplay.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: ${proteinPct}%"></div>
                </div>
                <span>${proteinPct}% <small class="text-muted" style="font-size: 0.85em;">(${proteinGrams}g: ${proteinPerKg}g/kg)</small></span>
            </div>
        `;
    }

    if (fatGrDisplay) {
        fatGrDisplay.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: ${fatPct}%"></div>
                </div>
                <span>${fatPct}% <small class="text-muted" style="font-size: 0.85em;">(${fatGrams}g: ${fatPerKg}g/kg)</small></span>
            </div>
        `;
    }

    if (carbGrDisplay) {
        carbGrDisplay.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-danger" style="width: ${carbPct}%"></div>
                </div>
                <span>${carbPct}% <small class="text-muted" style="font-size: 0.85em;">(${carbGrams}g: ${carbPerKg}g/kg)</small></span>
            </div>
        `;
    }
}
function setupPausaMacroListeners() {
    const proteinPausaInput = document.getElementById('proteinas-pausa-pct');
    const fatPausaInput = document.getElementById('grasas-pausa-pct');
    const carbPausaInput = document.getElementById('hc-pausa-pct');

    // Funci√≥n para retrasar la actualizaci√≥n y evitar demasiadas llamadas
    const debouncedUpdate = debounce(actualizarSumaPorcentajesPausa, 200);

    if (proteinPausaInput && fatPausaInput && carbPausaInput) {
        // Configurar listeners para los inputs de pausa
        proteinPausaInput.addEventListener('input', debouncedUpdate);
        fatPausaInput.addEventListener('input', debouncedUpdate);
        carbPausaInput.addEventListener('input', debouncedUpdate);

        // Configurar validaci√≥n de rango para cada input
        [proteinPausaInput, fatPausaInput, carbPausaInput].forEach(input => {
            input.addEventListener('change', function () {
                // Asegurar que los valores est√©n dentro de rangos razonables
                const value = parseInt(this.value);
                if (value < 5) this.value = 5;
                if (value > 80) this.value = 80;

                // Forzar actualizaci√≥n despu√©s de corregir valores
                actualizarSumaPorcentajesPausa();
            });
        });
    }
}
function actualizarValoresInicialesPausa(peso) {
    // Valores predeterminados para pausa
    const valoresPausa = {
        proteinPct: 20,
        fatPct: 35,
        carbPct: 45
    };

    // Actualizar inputs
    const proteinPctInput = document.getElementById('proteinas-pausa-pct');
    const fatPctInput = document.getElementById('grasas-pausa-pct');
    const carbPctInput = document.getElementById('hc-pausa-pct');

    if (proteinPctInput) proteinPctInput.value = valoresPausa.proteinPct;
    if (fatPctInput) fatPctInput.value = valoresPausa.fatPct;
    if (carbPctInput) carbPctInput.value = valoresPausa.carbPct;

    // Actualizar visualizaci√≥n
    actualizarSumaPorcentajesPausa();
}
// Funci√≥n auxiliar para debounce
function debounce(func, wait) {
    let timeout;
    return function () {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}
function formatStrategyDetails(detailsText, objetivo, proposito) {
    // Manejar caso donde detailsText es undefined o null
    if (!detailsText || typeof detailsText !== 'string') {
        return '<div class="strategy-main-text text-muted">No hay detalles disponibles para esta estrategia.</div>';
    }

    // Dividir el texto en secciones
    let sections = {
        main: "",
        strategies: "",
        warnings: "",
        criticalErrors: "",
        example: ""
    };

    // Normalizar saltos de l√≠nea para un procesamiento consistente
    const normalizedText = detailsText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    // Detectar y separar las diferentes secciones
    if (normalizedText.includes("ESTRATEGIAS ESPEC√çFICAS RECOMENDADAS:")) {
        const parts = normalizedText.split("ESTRATEGIAS ESPEC√çFICAS RECOMENDADAS:");
        sections.main = parts[0].trim();

        if (parts[1]?.includes("ADVERTENCIAS CIENT√çFICAS:")) {
            const strategyParts = parts[1].split("ADVERTENCIAS CIENT√çFICAS:");
            sections.strategies = strategyParts[0].trim();

            if (strategyParts[1]?.includes("ERRORES CR√çTICOS:")) {
                const warningParts = strategyParts[1].split("ERRORES CR√çTICOS:");
                sections.warnings = warningParts[0].trim();

                if (warningParts[1]?.includes("EJEMPLO PARA")) {
                    const errorParts = warningParts[1].split("EJEMPLO PARA");
                    sections.criticalErrors = errorParts[0].trim();
                    sections.example = "EJEMPLO PARA" + errorParts[1].trim();
                } else {
                    sections.criticalErrors = warningParts[1]?.trim() || "";
                }
            } else if (strategyParts[1]?.includes("EJEMPLO PARA")) {
                const warningParts = strategyParts[1].split("EJEMPLO PARA");
                sections.warnings = warningParts[0].trim();
                sections.example = "EJEMPLO PARA" + warningParts[1].trim();
            } else {
                sections.warnings = strategyParts[1]?.trim() || "";
            }
        } else if (parts[1]?.includes("ERRORES CR√çTICOS:")) {
            const strategyParts = parts[1].split("ERRORES CR√çTICOS:");
            sections.strategies = strategyParts[0].trim();

            if (strategyParts[1]?.includes("EJEMPLO PARA")) {
                const errorParts = strategyParts[1].split("EJEMPLO PARA");
                sections.criticalErrors = errorParts[0].trim();
                sections.example = "EJEMPLO PARA" + errorParts[1].trim();
            } else {
                sections.criticalErrors = strategyParts[1]?.trim() || "";
            }
        } else if (parts[1]?.includes("EJEMPLO PARA")) {
            const strategyParts = parts[1].split("EJEMPLO PARA");
            sections.strategies = strategyParts[0].trim();
            sections.example = "EJEMPLO PARA" + strategyParts[1].trim();
        } else {
            sections.strategies = parts[1]?.trim() || "";
        }
    } else if (normalizedText.includes("ADVERTENCIAS CIENT√çFICAS:")) {
        const parts = normalizedText.split("ADVERTENCIAS CIENT√çFICAS:");
        sections.main = parts[0].trim();

        if (parts[1]?.includes("ERRORES CR√çTICOS:")) {
            const warningParts = parts[1].split("ERRORES CR√çTICOS:");
            sections.warnings = warningParts[0].trim();

            if (warningParts[1]?.includes("EJEMPLO PARA")) {
                const errorParts = warningParts[1].split("EJEMPLO PARA");
                sections.criticalErrors = errorParts[0].trim();
                sections.example = "EJEMPLO PARA" + errorParts[1].trim();
            } else {
                sections.criticalErrors = warningParts[1]?.trim() || "";
            }
        } else if (parts[1]?.includes("EJEMPLO PARA")) {
            const warningParts = parts[1].split("EJEMPLO PARA");
            sections.warnings = warningParts[0].trim();
            sections.example = "EJEMPLO PARA" + warningParts[1].trim();
        } else {
            sections.warnings = parts[1]?.trim() || "";
        }
    } else if (normalizedText.includes("ERRORES CR√çTICOS:")) {
        const parts = normalizedText.split("ERRORES CR√çTICOS:");
        sections.main = parts[0].trim();

        if (parts[1]?.includes("EJEMPLO PARA")) {
            const errorParts = parts[1].split("EJEMPLO PARA");
            sections.criticalErrors = errorParts[0].trim();
            sections.example = "EJEMPLO PARA" + errorParts[1].trim();
        } else {
            sections.criticalErrors = parts[1]?.trim() || "";
        }
    } else if (normalizedText.includes("EJEMPLO PARA")) {
        const parts = normalizedText.split("EJEMPLO PARA");
        sections.main = parts[0].trim();
        sections.example = "EJEMPLO PARA" + parts[1].trim();
    } else {
        sections.main = normalizedText;
    }

    // ‚úÖ ELIMINAR EL EJEMPLO DE C√ÅLCULO DEL TEXTO DE DETALLES
    // Ya no queremos que aparezca en el texto principal
    sections.example = "";

    // Generar secciones din√°micas
    const seccionesDinamicas = generarSeccionesDinamicas(objetivo, proposito);

    // Construir el HTML formateado
    let formattedHTML = '';

    // Texto principal
    if (sections.main) {
        formattedHTML += `<div class="strategy-main-text">${sections.main.replace(/\n\n/g, '</div><div class="strategy-main-text">').replace(/\n/g, '<br>')}</div>`;
    }

    // Funci√≥n auxiliar para convertir listas de guiones a HTML
    const formatList = (listText) => {
        if (!listText || typeof listText !== 'string') return '';

        // Separar en l√≠neas
        const lines = listText.split('\n');
        let html = '<ul class="strategy-list">';

        for (const line of lines) {
            if (line.trim().startsWith('-')) {
                // Eliminar el gui√≥n y espacios al inicio
                const item = line.trim().substring(1).trim();
                if (item) {
                    html += `<li>${item}</li>`;
                }
            } else if (line.trim()) {
                // Si no es un elemento de lista, tratarlo como texto normal
                html += `<li>${line.trim()}</li>`;
            }
        }

        html += '</ul>';
        return html;
    };

    // Estrategias espec√≠ficas
    if (sections.strategies || seccionesDinamicas.recomendaciones.length > 0) {
        let strategiesContent = sections.strategies || '';

        // Si no hay estrategias en el texto original, usar las din√°micas
        if (!strategiesContent.trim() && seccionesDinamicas.recomendaciones.length > 0) {
            strategiesContent = seccionesDinamicas.recomendaciones.join('\n');
        } else if (seccionesDinamicas.recomendaciones.length > 0) {
            // Si hay ambas, combinarlas
            strategiesContent += '\n' + seccionesDinamicas.recomendaciones.join('\n');
        }

        if (strategiesContent.trim()) {
            formattedHTML += `
            <div class="strategy-section strategy-section-strategies">
                <strong><i class="fa-solid fa-chess-knight"></i> Estrategias Espec√≠ficas Recomendadas:</strong>
                <div class="strategy-content">${formatList(strategiesContent)}</div>
            </div>`;
        }
    }

    // ‚úÖ MODIFICACI√ìN CLAVE: Advertencias cient√≠ficas con formato mejorado
    if (sections.warnings) {
        const warningsLines = sections.warnings.split('\n');
        let formattedWarnings = '';

        warningsLines.forEach(line => {
            if (line.trim().startsWith('-')) {
                const cleanLine = line.trim().substring(1).trim();

                // Detectar si la l√≠nea contiene un t√≠tulo de estrategia
                const strategyTitleMatch = cleanLine.match(/^(.*?):/);

                if (strategyTitleMatch && strategyTitleMatch[1]) {
                    const strategyTitle = strategyTitleMatch[1];
                    const warningContent = cleanLine.substring(strategyTitle.length + 1).trim();

                    // Aplicar formato especial si es una estrategia espec√≠fica
                    formattedWarnings += `<li><strong class="strategy-warning-title">${strategyTitle}:</strong> ${warningContent}</li>`;
                } else {
                    formattedWarnings += `<li>${cleanLine}</li>`;
                }
            }
        });

        if (formattedWarnings) {
            formattedHTML += `
					<div class="strategy-section strategy-section-warnings">
						<strong><i class="fas fa-exclamation-triangle text-warning"></i> Advertencias Cient√≠ficas:</strong>
						<div class="strategy-content">
							<ul class="strategy-list">${formattedWarnings}</ul>
						</div>
					</div>`;
        }
    }

    // Errores cr√≠ticos
    if (sections.criticalErrors) {
        const criticalErrorsContent = sections.criticalErrors;

        if (criticalErrorsContent.trim()) {
            formattedHTML += `
					<div class="strategy-section strategy-section-critical-errors">
						<strong><i class="fas fa-exclamation-circle text-danger"></i> Errores Cr√≠ticos:</strong>
						<div class="strategy-content">${formatList(criticalErrorsContent)}</div>
					</div>`;
        }
    }






    // Si no hay contenido, mostrar mensaje por defecto
    if (!formattedHTML) {
        formattedHTML = '<div class="strategy-main-text text-muted">No hay detalles disponibles para esta estrategia.</div>';
    }

    return formattedHTML;
}

function normalizarFase(fase) {
    if (!fase) return "Fase 1 (0-12 sem)";

    // Convertir a min√∫sculas y eliminar espacios extra
    const faseLower = fase.toLowerCase().replace(/\s+/g, ' ').trim();

    // Mapeo de fases
    if (/fase\s*1|0-12\s*sem|12\s*sem/i.test(faseLower)) {
        return "Fase 1 (0-12 sem)";
    }
    if (/fase\s*2|12-24\s*sem/i.test(faseLower)) {
        return "Fase 2 (12-24 sem)";
    }
    if (/fase\s*3|avanzada|>24\s*sem/i.test(faseLower)) {
        return "Fase 3 Avanzada (>24 sem)";
    }
    if (/fase\s*4|ajuste\s*metab√≥lico|>32\s*sem/i.test(faseLower)) {
        return "Fase 4 Ajuste Metab√≥lico (>32 sem)";
    }

    // Para fases espec√≠ficas de ganancia
    if (/fase\s*1|0-8\s*sem/i.test(faseLower) && faseLower.includes("ganancia")) {
        return "Fase 1 (0-8 sem)";
    }

    // Para fases espec√≠ficas de mantenimiento
    if (/fase\s*1|0-16\s*sem/i.test(faseLower) && faseLower.includes("mantenimiento")) {
        return "Fase 1 (0-16 sem)";
    }

    // Si no coincide con ninguna fase conocida, usar la primera fase por defecto
    return "Fase 1 (0-12 sem)";
}
function encontrarCoincidenciaEstrategia(estrategiaTitle, opciones) {
    const titleLower = estrategiaTitle.toLowerCase();

    // 1. Primero intentar coincidencia exacta
    for (const opcion of opciones) {
        if (titleLower === opcion.toLowerCase()) {
            return opcion;
        }
    }

    // 2. Intentar con el mapeo de nombres
    const nombreMapeado = nombreEstrategiaEspecificaMap[estrategiaTitle] ||
        nombreEstrategiaEspecificaMap[titleLower];

    if (nombreMapeado && opciones.includes(nombreMapeado)) {
        return nombreMapeado;
    }

    // 3. Intentar coincidencia parcial (palabras clave)
    const keywords = titleLower.split(/\s+/).filter(word => word.length > 3);
    for (const opcion of opciones) {
        const opcionLower = opcion.toLowerCase();

        // Verificar si contiene palabras clave significativas
        const coincidencias = keywords.filter(word =>
            opcionLower.includes(word) &&
            // Excluir palabras comunes
            !['para', 'con', 'de', 'y', 'en', 'el', 'la'].includes(word)
        );

        if (coincidencias.length >= 2) {
            return opcion;
        }
    }

    // 4. Verificar abreviaturas
    const abreviaturas = {
        'tkd': 'Targeted Ketogenic Diet (TKD)',
        'ckd': 'Cyclic Ketogenic Diet (CKD)',
        'rkd': 'Restricted Ketogenic Diet (RKD)',
        'mkd': 'Modified Ketogenic Diet',
        'cc': 'Carb Cycling',
        'pc': 'Protein Cycling',
        'cal': 'Calorie Cycling',
        'mft': 'Metabolic Flexibility Training',
        'rs': 'Refeed Strategy'
    };

    for (const [abrev, nombreCompleto] of Object.entries(abreviaturas)) {
        if (titleLower.includes(abrev)) {
            if (opciones.includes(nombreCompleto)) {
                return nombreCompleto;
            }
        }
    }

    // 5. √öltimo recurso: coincidencia por palabras clave principales
    const palabrasClave = ['ketogenic', 'cycling', 'carb', 'protein', 'calorie', 'flexibility', 'refeed', 'timing', 'hydration'];

    for (const palabra of palabrasClave) {
        if (titleLower.includes(palabra)) {
            const coincidencia = opciones.find(opcion =>
                opcion.toLowerCase().includes(palabra)
            );

            if (coincidencia) return coincidencia;
        }
    }

    return null;
}

function obtenerClasificacion(estrategia, proposito, faseConfig, estrategiaBaseKey, estrategiaEspecificaKey) {
    // 1. Primero intentar obtener la clasificaci√≥n directa
    if (faseConfig[estrategiaBaseKey] &&
        faseConfig[estrategiaBaseKey][estrategiaEspecificaKey] &&
        faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito]) {
        return faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito];
    }

    // 2. Si no hay clasificaci√≥n espec√≠fica, intentar con "default"
    if (faseConfig[estrategiaBaseKey] &&
        faseConfig[estrategiaBaseKey][estrategiaEspecificaKey] &&
        faseConfig[estrategiaBaseKey][estrategiaEspecificaKey]["default"]) {
        return faseConfig[estrategiaBaseKey][estrategiaEspecificaKey]["default"];
    }

    // 3. Verificar en la propiedad "features" de la estrategia
    if (estrategia.features && Array.isArray(estrategia.features)) {
        // Buscar si hay incompatibilidad expl√≠cita
        const incompatibilidad = estrategia.features.some(feat =>
            feat.toLowerCase().includes("incompatibilidad") ||
            feat.toLowerCase().includes("no recomendado")
        );

        if (incompatibilidad) return "no recomendada";

        // Buscar si es espec√≠ficamente recomendado para el prop√≥sito
        const recomendado = estrategia.features.some(feat =>
            (feat.toLowerCase().includes("recomendado") ||
                feat.toLowerCase().includes("√≥ptimo")) &&
            feat.toLowerCase().includes(proposito.toLowerCase())
        );

        if (recomendado) return "recomendada";
    }

    // 4. Verificar compatibilidad general con el prop√≥sito
    const esCompatibleConProposito = verificarCompatibilidadProposito(estrategia, proposito);

    // 5. Por defecto, si pasa todas las verificaciones, es recomendada
    return esCompatibleConProposito ? "recomendada" : "no recomendada";
}

function verificarCompatibilidadProposito(estrategia, proposito) {
    if (!estrategia.aplicableProposito) return true;

    // Verificar si el prop√≥sito est√° expl√≠citamente permitido
    if (estrategia.aplicableProposito[proposito] === "recomendada") {
        return true;
    }

    // Verificar si el prop√≥sito est√° expl√≠citamente prohibido
    if (estrategia.aplicableProposito[proposito] === "no recomendada") {
        return false;
    }

    // Verificar si hay advertencias espec√≠ficas para este prop√≥sito
    if (estrategia.features && Array.isArray(estrategia.features)) {
        return !estrategia.features.some(feat =>
            (feat.toLowerCase().includes("incompatibilidad") ||
                feat.toLowerCase().includes("no recomendado")) &&
            feat.toLowerCase().includes(proposito.toLowerCase())
        );
    }

    return true;
}
function generarRecomendacionesClave(objetivo, proposito, strategyId = null, estrategiasEspecificasSeleccionadas = []) {
    if (!objetivo || !proposito) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones espec√≠ficas.</div></div>`;
    }

    // Si hay una estrategia base seleccionada
    if (strategyId) {
        const estrategiaBase = encontrarEstrategiaBase(strategyId);

        if (!estrategiaBase) {
            return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>No se encontr√≥ la estrategia base seleccionada.</div></div>`;
        }

        // Obtener fase actual del modal
        const faseElement = document.querySelector('.modal-title');
        const faseKey = faseElement ? faseElement.textContent.split('-')[1]?.trim() : "Fase 1 (0-12 sem)";

        // Analizar compatibilidad con estrategias espec√≠ficas seleccionadas
        const analisis = analizarCompatibilidad(
            estrategiaBase,
            estrategiasEspecificasSeleccionadas,
            proposito,
            faseKey
        );

        // Generar HTML para contraindicaciones y recomendaciones
        return generarHTMLRecomendaciones(analisis, estrategiaBase, faseKey);
    }

    // Si no hay estrategia base seleccionada, mostrar recomendaciones gen√©ricas
    return generarRecomendacionesGenericas(objetivo, proposito);
}



// Funci√≥n para analizar la compatibilidad din√°mica
function analizarCompatibilidad(estrategiaBase, estrategiasEspecificas, proposito, faseKey) {
    // ASEGURAR QUE estrategiasEspecificas ES UN ARRAY V√ÅLIDO
    if (!Array.isArray(estrategiasEspecificas)) {
        estrategiasEspecificas = [];
    }

    const resultados = [];

    estrategiasEspecificas.forEach(estrategia => {
        try {
            const clasificacion = clasificarEstrategia(estrategia, proposito, faseKey, estrategiaBase);

            resultados.push({
                estrategia: estrategia,
                clasificacion: clasificacion,
                esCompatible: clasificacion && (
                    clasificacion.clasificacion === 'recomendada' ||
                    clasificacion.clasificacion === 'neutral'
                )
            });
        } catch (error) {
            console.error(`Error al clasificar estrategia ${estrategia.id}:`, error);
        }
    });

    return resultados;
}

function generarHTMLRecomendaciones(analisis, estrategiaBase, faseKey, recomendacionesBase = []) {
    try {
        // ASEGURAR QUE ANALISIS ES UN ARRAY V√ÅLIDO
        if (!Array.isArray(analisis)) {
            analisis = [];
        }

        // ASEGURAR QUE RECOMENDACIONES BASE ES UN ARRAY V√ÅLIDO
        if (!Array.isArray(recomendacionesBase)) {
            recomendacionesBase = [];
        }

        // Normalizar las recomendaciones base al mismo formato que el an√°lisis
        const recomendacionesBaseNormalizadas = recomendacionesBase.map(rec => ({
            esCompatible: true,
            clasificacion: {
                clasificacion: 'recomendada',
                mensaje: rec.text,
                detalle: ''
            },
            estrategia: {
                title: rec.title
            }
        }));

        // Combinar recomendaciones base con an√°lisis
        const todasRecomendaciones = [...recomendacionesBaseNormalizadas, ...analisis];

        // Filtrar por compatibilidad
        const contraindicaciones = todasRecomendaciones.filter(item =>
            !item.esCompatible && item.clasificacion &&
            (item.clasificacion.clasificacion === 'contraindicada' ||
                item.clasificacion.clasificacion === 'no recomendada')
        );

        const recomendaciones = todasRecomendaciones.filter(item =>
            item.esCompatible && item.clasificacion &&
            item.clasificacion.clasificacion === 'recomendada' &&
            // Excluir las recomendaciones base de esta secci√≥n (ya se muestran arriba)
            !recomendacionesBase.some(base => base.title === item.estrategia.title)
        );

        const neutras = todasRecomendaciones.filter(item =>
            item.esCompatible && item.clasificacion &&
            item.clasificacion.clasificacion === 'neutral'
        );

        let html = '<div class="recommendations-section">';

        // T√≠tulo
        html += '<h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Key Points Estrategia Base Seleccionada</h6>';

        // Si no hay estrategia base, mensaje informativo
        if (!estrategiaBase) {
            html += '<div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones espec√≠ficas.</div>';
            html += '</div>';
            return html;
        }

        // Recomendaciones base  // //html += '<h6 class="text-muted mb-2">Recomendaciones Base:</h6>';
        if (recomendacionesBase.length > 0) {
            html += '<div class="base-recommendations mb-4">';


            recomendacionesBase.forEach(rec => {
                html += `
                    <div class="recommendation-item mb-2">
                        <div class="d-flex">
                            <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                            <div>
                                <h6 class="mb-1">${rec.title}</h6>
                                <p class="mb-0">${rec.text}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
        }

        // Secci√≥n: Contraindicaciones Clave
        if (contraindicaciones.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <h6 class="text-danger mb-2"><i class="fas fa-exclamation-triangle me-1"></i> Contraindicaciones Clave</h6>
                <ul class="list-group list-group-flush">`;

            contraindicaciones.forEach(item => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-times-circle text-danger me-1"></i> 
                        <strong>${item.estrategia.title}</strong>: ${item.clasificacion.mensaje}
                        ${item.clasificacion.detalle ? `<div class="small text-muted mt-1">${item.clasificacion.detalle}</div>` : ''}
                    </li>`;
            });

            html += `
                </ul>
            </div>`;
        }

        // Secci√≥n: Recomendaciones Espec√≠ficas
        if (recomendaciones.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <h6 class="text-success mb-2"><i class="fas fa-check-circle me-1"></i> Recomendaciones Espec√≠ficas</h6>
                <ul class="list-group list-group-flush">`;

            recomendaciones.forEach(item => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-check-circle text-success me-1"></i> 
                        <strong>${item.estrategia.title}</strong>: ${item.clasificacion.mensaje}
                        ${item.clasificacion.detalle ? `<div class="small text-muted mt-1">${item.clasificacion.detalle}</div>` : ''}
                    </li>`;
            });

            html += `
                </ul>
            </div>`;
        }

        // Secci√≥n: Estrategias Neutras
        if (neutras.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <h6 class="text-warning mb-2"><i class="fas fa-circle me-1"></i> Estrategias Neutras</h6>
                <ul class="list-group list-group-flush">`;

            neutras.forEach(item => {
                html += `
                    <li class="list-group-item bg-light p-2">
                        <i class="fas fa-circle text-warning me-1"></i> 
                        <strong>${item.estrategia.title}</strong>: ${item.clasificacion.mensaje}
                        ${item.clasificacion.detalle ? `<div class="small text-muted mt-1">${item.clasificacion.detalle}</div>` : ''}
                    </li>`;
            });

            html += `
                </ul>
            </div>`;
        }

        // Si no hay contraindicaciones ni recomendaciones espec√≠ficas (solo recomendaciones base)
        if (contraindicaciones.length === 0 && recomendaciones.length === 0 && neutras.length === 0 && recomendacionesBase.length > 0) {
            html += `
            <div class="optimal-strategy-section mb-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-1"></i> 
                    No hay recomendaciones espec√≠ficas adicionales para esta combinaci√≥n.
                    <div class="mt-2 small text-muted">
                        Selecciona estrategias espec√≠ficas para ver m√°s recomendaciones personalizadas.
                    </div>
                </div>
            </div>`;
        }

        html += '</div>';
        return html;
    } catch (error) {
        console.error("Error al generar HTML de recomendaciones:", error);
        return `
            <div class="recommendations-section">
                <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i> 
                    Error al generar recomendaciones: ${error.message}
                </div>
            </div>
        `;
    }
}


// Funci√≥n para generar recomendaciones gen√©ricas (cuando no hay estrategia base seleccionada)
function generarRecomendacionesGenericas(objetivo, proposito) {
    // Normalizar objetivo y prop√≥sito
    const objetivoNormalizado = objetivo.toLowerCase();
    const propositoNormalizado = proposito.toLowerCase();

    // Encontrar las claves correctas
    let objetivoKey;
    if (objetivoNormalizado.includes('perdida')) objetivoKey = 'perdida';
    else if (objetivoNormalizado.includes('ganancia')) objetivoKey = 'ganancia';
    else if (objetivoNormalizado.includes('mantenimiento')) objetivoKey = 'mantenimiento';
    else if (objetivoNormalizado.includes('mixto')) objetivoKey = 'mixto';

    let propositoKey;
    if (propositoNormalizado.includes('salud')) propositoKey = 'salud';
    else if (propositoNormalizado.includes('estet')) propositoKey = 'estetica';
    else if (propositoNormalizado.includes('rendimiento')) propositoKey = 'rendimiento';

    // Si no encontramos coincidencias, usar valores por defecto
    if (!objetivoKey || !propositoKey) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>Selecciona una estrategia base para ver recomendaciones espec√≠ficas.</div></div>`;
    }

    // Obtener el resumen ejecutivo
    const resumen = estrategiaCompleta[objetivoKey]?.[propositoKey]?.resumenEjecutivo || [];

    // Si no hay resumen ejecutivo, mostrar mensaje
    if (resumen.length === 0) {
        return `<div class="recommendations-section"><h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6><div class="alert alert-info"><i class="fas fa-info-circle me-1"></i>No hay recomendaciones clave espec√≠ficas para esta combinaci√≥n.</div></div>`;
    }

    const items = resumen.map(rec => `
        <div class="recommendation-item mb-3">
            <div class="d-flex">
                <i class="${rec.icon} me-2 mt-1" style="color: #5e9a4f; width: 20px;"></i>
                <div>
                    <h6 class="mb-1">${rec.title}</h6>
                    <p class="mb-0">${rec.text}</p>
                </div>
            </div>
        </div>
    `).join('');

    return `
        <div class="recommendations-section">
            <h6 class="mb-3"><i class="fas fa-star me-2" style="color: #5e9a4f;"></i>Recomendaciones Clave</h6>
            ${items}
        </div>
    `;
}

function obtenerRecomendacionesEstrategia(strategyId, proposito, objetivo) {
    // Buscar en todas las categor√≠as de estrategias espec√≠ficas
    const todasEstrategias = [
        ...(catalogoEstrategias.cetogenicas || []),
        ...(catalogoEstrategias.ciclado || []),
        ...(catalogoEstrategias.timing || [])
    ];

    // Buscar la estrategia base en estrategiasBaseConfig
    let estrategiaBase = null;

    // Recorrer todas las fases y objetivos en estrategiasBaseConfig
    for (const objetivoKey in estrategiasBaseConfig) {
        for (const fase in estrategiasBaseConfig[objetivoKey]) {
            const estrategias = estrategiasBaseConfig[objetivoKey][fase];
            const encontrada = estrategias.find(e => e.id === strategyId);

            if (encontrada) {
                estrategiaBase = encontrada;
                break;
            }
        }

        if (estrategiaBase) break;
    }

    // Si no se encontr√≥ en estrategiasBaseConfig, intentar con el ID directo
    if (!estrategiaBase) {
        for (const categoria in catalogoEstrategias) {
            const categoriaEstrategias = catalogoEstrategias[categoria] || [];
            const estrategia = categoriaEstrategias.find(e => e.id === strategyId);
            if (estrategia) {
                estrategiaBase = estrategia;
                break;
            }
        }
    }

    // Si no se encontr√≥ la estrategia
    if (!estrategiaBase) {
        console.warn(`Estrategia base con ID ${strategyId} no encontrada`);
        return [];
    }

    // Obtener recomendaciones espec√≠ficas de la estrategia
    const recomendaciones = [];

    // CORRECCI√ìN CLAVE: Verificar que features exista y sea un array
    if (estrategiaBase.features && Array.isArray(estrategiaBase.features)) {
        estrategiaBase.features.forEach(feature => {
            // Buscar recomendaciones espec√≠ficas para el prop√≥sito
            if (feature.includes(`PROP√ìSITO: V√°lido para ${proposito.toUpperCase()}`) ||
                feature.includes(`PROP√ìSITO: Solo v√°lido para ${proposito.toUpperCase()}`)) {

                // Buscar recomendaciones espec√≠ficas
                const recMatch = feature.match(/RECOMENDACI√ìN:\s*(.*)/);
                if (recMatch) {
                    // Intentar encontrar un icono correspondiente en el objeto global de recomendaciones
                    const icono = encontrarIconoCorrespondiente(recMatch[1], objetivo, proposito);

                    recomendaciones.push({
                        icon: icono,
                        title: "Recomendaci√≥n Espec√≠fica",
                        text: recMatch[1]
                    });
                }
            }
        });
    }

    // Si no hay recomendaciones espec√≠ficas, buscar en las estrategias espec√≠ficas compatibles
    if (recomendaciones.length === 0 && Array.isArray(todasEstrategias)) {
        todasEstrategias.forEach(estrategia => {
            // Verificar si es compatible con la estrategia base
            const esCompatible = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat =>
                feat.includes(`ESTRATEGIA BASE: ${estrategiaBase.title}`) ||
                feat.includes(`ESTRATEGIA BASE: ${estrategiaBase.id}`)
            );

            // Verificar prop√≥sito
            const tieneProposito = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat =>
                feat.includes(`PROP√ìSITO: V√°lido para ${proposito.toUpperCase()}`) ||
                feat.includes(`PROP√ìSITO: Solo v√°lido para ${proposito.toUpperCase()}`)
            );

            if (esCompatible && tieneProposito) {
                // Intentar encontrar un icono correspondiente en el objeto global de recomendaciones
                const icono = encontrarIconoCorrespondiente(estrategia.title, objetivo, proposito);

                recomendaciones.push({
                    icon: icono,
                    title: estrategia.title,
                    text: estrategia.description
                });
            }
        });
    }

    return recomendaciones;
}

// Funci√≥n auxiliar para encontrar el icono correspondiente
function encontrarIconoCorrespondiente(titulo, objetivo, proposito) {
    if (!recomendaciones[objetivo] || !recomendaciones[objetivo][proposito]) {
        return "fas fa-lightbulb";
    }

    // Buscar coincidencia parcial en los t√≠tulos de las recomendaciones
    for (const rec of recomendaciones[objetivo][proposito]) {
        if (titulo.toLowerCase().includes(rec.title.toLowerCase()) ||
            rec.title.toLowerCase().includes(titulo.toLowerCase())) {
            return rec.icon;
        }
    }

    // Si no hay coincidencia exacta, intentar con palabras clave
    const tituloLower = titulo.toLowerCase();

    if (tituloLower.includes("refeed") || tituloLower.includes("carb") || tituloLower.includes("hc")) {
        return "fas fa-fire";
    }
    if (tituloLower.includes("protein") || tituloLower.includes("prote")) {
        return "fas fa-protein";
    }
    if (tituloLower.includes("flexibility") || tituloLower.includes("cycling") ||
        tituloLower.includes("rotaci√≥n") || tituloLower.includes("ciclado")) {
        return "fas fa-sync-alt";
    }
    if (tituloLower.includes("ayuno") || tituloLower.includes("intermitente") ||
        tituloLower.includes("fasting")) {
        return "fas fa-clock";
    }
    if (tituloLower.includes("hidrataci√≥n") || tituloLower.includes("agua") ||
        tituloLower.includes("electrolitos")) {
        return "fas fa-hydrate";
    }
    if (tituloLower.includes("peso") || tituloLower.includes("balanza") ||
        tituloLower.includes("equilibrio")) {
        return "fas fa-balance-scale";
    }
    if (tituloLower.includes("caminar") || tituloLower.includes("pasos") ||
        tituloLower.includes("neat")) {
        return "fas fa-walking";
    }
    if (tituloLower.includes("entrenamiento") || tituloLower.includes("fuerza") ||
        tituloLower.includes("dumbbell")) {
        return "fas fa-dumbbell";
    }
    if (tituloLower.includes("calendario") || tituloLower.includes("periodizaci√≥n") ||
        tituloLower.includes("calendario")) {
        return "fas fa-calendar-alt";
    }

    // Icono por defecto
    return "fas fa-lightbulb";
}


function clasificarEstrategia(estrategia, proposito, faseKey, estrategiaBase) {
    try {
        // Verificar que los par√°metros esenciales existan
        if (!estrategia || !proposito) {
            throw new Error("Par√°metros insuficientes para clasificar estrategia");
        }

        // Si no hay estrategia base, usar clasificaci√≥n gen√©rica
        if (!estrategiaBase || !estrategiaBase.title) {
            // Clasificaci√≥n gen√©rica basada solo en prop√≥sito
            if (estrategia.aplicableProposito && estrategia.aplicableProposito[proposito] === 'recomendada') {
                return {
                    clasificacion: 'recomendada',
                    mensaje: 'Estrategia recomendada para este prop√≥sito',
                    detalle: '',
                    color: '#4caf50'
                };
            }

            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral para este prop√≥sito',
                detalle: '',
                color: '#9e9e9e'
            };
        }

        // Determinar el objetivo actual
        let objetivoKey = '';
        const objetivoSelect = document.getElementById('objetivo');
        if (objetivoSelect) {
            const objetivoValue = objetivoSelect.value;
            if (objetivoValue.includes('perdida')) objetivoKey = 'perdida';
            else if (objetivoValue.includes('ganancia')) objetivoKey = 'ganancia';
            else if (objetivoValue.includes('mantenimiento')) objetivoKey = 'mantenimiento';
            else if (objetivoValue.includes('mixto')) objetivoKey = 'mixto';
        }

        // Si no pudimos determinar el objetivo, usar 'perdida' por defecto
        if (!objetivoKey) objetivoKey = 'perdida';

        // Mapeo de fases a formato estandarizado
        const faseMap = {
            '1': 'Fase 1 (0-12 sem)',
            '2': 'Fase 2 (12-24 sem)',
            '3': 'Fase 3 Avanzada (>24 sem)',
            '4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)',
            'Fase 1': 'Fase 1 (0-12 sem)',
            'Fase 2': 'Fase 2 (12-24 sem)',
            'Fase 3': 'Fase 3 Avanzada (>24 sem)',
            'Fase 4': 'Fase 4 Ajuste Metab√≥lico (>32 sem)'
        };

        const faseEstandarizada = faseMap[faseKey] || faseKey;

        // Mapeo de nombres de estrategias base para compatibilidad
        // Mapeo exhaustivo de nombres de estrategias espec√≠ficas
        const nombreEstrategiaEspecificaMap = {
            // Estrategias cetog√©nicas
            "Targeted Ketogenic Diet": "Targeted Ketogenic Diet (TKD)",
            "Targeted Ketogenic Diet (TKD)": "Targeted Ketogenic Diet (TKD)",
            "TKD": "Targeted Ketogenic Diet (TKD)",

            "Cyclic Ketogenic Diet": "Cyclic Ketogenic Diet (CKD)",
            "Cyclic Ketogenic Diet (CKD)": "Cyclic Ketogenic Diet (CKD)",
            "CKD": "Cyclic Ketogenic Diet (CKD)",

            "Restricted Ketogenic Diet": "Restricted Ketogenic Diet (RKD)",
            "Restricted Ketogenic Diet (RKD)": "Restricted Ketogenic Diet (RKD)",
            "RKD": "Restricted Ketogenic Diet (RKD)",

            "Modified Ketogenic Diet": "Modified Ketogenic Diet",
            "MKD": "Modified Ketogenic Diet",

            // Estrategias de ciclado
            "Carb Cycling": "Carb Cycling",

            "Protein Cycling": "Protein Cycling",

            "Calorie Cycling": "Calorie Cycling",

            "Metabolic Flexibility Training": "Metabolic Flexibility Training",

            "Refeed Strategy": "Refeed Strategy",

            // Estrategias de timing
            //"High Carb para Deportes de Resistencia": "High Carb para Deportes de Resistencia",

            "Flexible Dieting (80/20 rule)": "Flexible Dieting (80/20 rule)",

            "Dieta Est√°ndar/Equilibrada": "Dieta Est√°ndar/Equilibrada",

            "Intermittent Fasting + Cycling": "Intermittent Fasting + Cycling",

            "Meal Timing Optimization": "Meal Timing Optimization",

            "NEAT Optimization": "NEAT Optimization",

            "Hydration Strategy": "Hydration Strategy",

            "Protein Pacing": "Protein Pacing",

            "Targeted Carb Timing": "Targeted Carb Timing"
        };

        // Obtener configuraci√≥n de la fase
        const faseConfig = matrizCompatibilidad[objetivoKey]?.[faseEstandarizada];
        if (!faseConfig) {
            console.warn(`No se encontr√≥ configuraci√≥n para ${objetivoKey}/${faseEstandarizada}`);
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral (configuraci√≥n no encontrada)',
                detalle: '',
                color: '#9e9e9e'
            };
        }

        // CORRECCI√ìN CLAVE: Usar el mapeo de nombres
        const nombreBaseMapeado = nombreEstrategiaBaseMap[estrategiaBase.title] || estrategiaBase.title;

        // Buscar estrategia base espec√≠fica - Mejor coincidencia
        const estrategiaBaseKey = Object.keys(faseConfig).find(key => {
            const baseLower = nombreBaseMapeado.toLowerCase();
            const keyLower = key.toLowerCase();

            // Verificar coincidencia exacta
            if (baseLower === keyLower) return true;

            // Verificar coincidencia parcial (cualquier direcci√≥n)
            if (baseLower.includes(keyLower) || keyLower.includes(baseLower)) return true;

            // Casos especiales para "Ciclado Metab√≥lico"
            if ((baseLower.includes("ciclado metab√≥lico") || baseLower.includes("hiperproteica")) &&
                keyLower.includes("ciclado metab√≥lico")) {
                return true;
            }

            return false;
        });

        if (!estrategiaBaseKey) {
            console.warn(`No se encontr√≥ estrategia base "${nombreBaseMapeado}" en la matriz de compatibilidad`);
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral (estrategia base no encontrada)',
                detalle: '',
                color: '#9e9e9e'
            };
        }

        // Buscar estrategia espec√≠fica - Mejor coincidencia
        const estrategiaEspecificaKey = Object.keys(faseConfig[estrategiaBaseKey]).find(key => {
            const estrategiaLower = estrategia.title.toLowerCase();
            const keyLower = key.toLowerCase();

            // Verificar coincidencia exacta
            if (estrategiaLower === keyLower) return true;

            // Verificar coincidencia parcial (cualquier direcci√≥n)
            if (estrategiaLower.includes(keyLower) || keyLower.includes(estrategiaLower)) return true;

            return false;
        });

        if (!estrategiaEspecificaKey) {
            console.warn(`No se encontr√≥ estrategia espec√≠fica "${estrategia.title}" en la matriz de compatibilidad`);
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia neutral (estrategia espec√≠fica no encontrada)',
                detalle: '',
                color: '#9e9e9e'
            };
        }

        // Obtener clasificaci√≥n para el prop√≥sito
        const clasificacion = faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito] || 'neutral';

        // EXTRAER ADVERTENCIAS ESPEC√çFICAS DE LOS FEATURES
        const advertenciasEspecificas = estrategia.features ?
            estrategia.features.filter(feat =>
                feat.includes("INCOMPATIBILIDAD") ||
                feat.includes("ADVERTENCIA") ||
                feat.includes("CONTRAINDICACI√ìN")
            ) : [];

        // Determinar mensaje y detalle basado en la clasificaci√≥n
        switch (clasificacion) {
            case 'recomendada':
                return {
                    clasificacion: 'recomendada',
                    mensaje: 'Estrategia √≥ptima para tu combinaci√≥n espec√≠fica',
                    detalle: `Esta estrategia complementa y potencia los principios de tu estrategia base "${estrategiaBase.title}"`,
                    color: '#4caf50'
                };
            case 'no recomendada':
                return {
                    clasificacion: 'no recomendada',
                    mensaje: 'Estrategia no recomendada para tu combinaci√≥n espec√≠fica',
                    detalle: advertenciasEspecificas.length > 0 ?
                        advertenciasEspecificas.join("\n") :
                        `Esta estrategia no es √≥ptima con tu estrategia base "${estrategiaBase.title}"`,
                    color: '#f44336'
                };
            case 'neutral':
                return {
                    clasificacion: 'neutral',
                    mensaje: 'Estrategia compatible, pero no espec√≠ficamente optimizada',
                    detalle: 'Esta estrategia es aplicable pero no aporta beneficios adicionales a tu estrategia base',
                    color: '#9e9e9e'
                };
            default:
                return {
                    clasificacion: 'neutral',
                    mensaje: 'Estrategia neutral (clasificaci√≥n desconocida)',
                    detalle: '',
                    color: '#9e9e9e'
                };
        }
    } catch (error) {
        console.error("Error al clasificar estrategia:", error);
        return {
            clasificacion: 'neutral',
            mensaje: 'Error al evaluar la estrategia',
            detalle: 'Se produjo un error al clasificar esta estrategia',
            color: '#9e9e9e'
        };
    }
}
function obtenerClasificacionEspecifica(estrategia, proposito, faseKey, estrategiaBase) {
    if (!estrategiaBase || !estrategiaBase.title) return null;

    // Normalizar fase
    const faseEstandarizada = normalizarFase(faseKey);

    // Determinar objetivo
    let objetivo = '';
    if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('perdida')) objetivo = 'perdida';
    else if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('ganancia')) objetivo = 'ganancia';
    else if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('mantenimiento')) objetivo = 'mantenimiento';
    else if (estrategiaBase.aplicable && estrategiaBase.aplicable.includes('mixto')) objetivo = 'mixto';

    if (!objetivo) {
        const objetivoSelect = document.getElementById('objetivo');
        if (objetivoSelect) {
            const objetivoValue = objetivoSelect.value;
            if (objetivoValue.includes('perdida')) objetivo = 'perdida';
            else if (objetivoValue.includes('ganancia')) objetivo = 'ganancia';
            else if (objetivoValue.includes('mantenimiento')) objetivo = 'mantenimiento';
            else if (objetivoValue.includes('mixto')) objetivo = 'mixto';
        }
    }

    if (!objetivo) objetivo = 'perdida';

    // Obtener configuraci√≥n de la fase
    const faseConfig = matrizCompatibilidad[objetivo]?.[faseEstandarizada];
    if (!faseConfig) {
        console.warn(`No se encontr√≥ configuraci√≥n para ${objetivo}/${faseEstandarizada}`);
        return null;
    }

    // Usar el mapeo de nombres
    const nombreBaseMapeado = nombreEstrategiaBaseMap[estrategiaBase.title] || estrategiaBase.title;

    // Buscar estrategia base espec√≠fica con coincidencia inteligente
    let estrategiaBaseKey = null;

    // Primero intentar con coincidencia exacta
    for (const key of Object.keys(faseConfig)) {
        if (key.toLowerCase() === nombreBaseMapeado.toLowerCase()) {
            estrategiaBaseKey = key;
            break;
        }
    }

    // Si no hay coincidencia exacta, intentar con coincidencia inteligente
    if (!estrategiaBaseKey) {
        const coincidencia = encontrarCoincidenciaEstrategia(nombreBaseMapeado, Object.keys(faseConfig));
        if (coincidencia) {
            estrategiaBaseKey = coincidencia;
        }
    }

    if (!estrategiaBaseKey) {
        console.warn(`No se encontr√≥ estrategia base "${nombreBaseMapeado}" en la matriz de compatibilidad`);
        return null;
    }

    // Buscar estrategia espec√≠fica con coincidencia inteligente
    const estrategiaEspecificaKey = encontrarCoincidenciaEstrategia(estrategia.title, Object.keys(faseConfig[estrategiaBaseKey]));

    if (!estrategiaEspecificaKey) {
        console.warn(`No se encontr√≥ estrategia espec√≠fica "${estrategia.title}" en la matriz de compatibilidad`);
        return null;
    }

    // Obtener clasificaci√≥n con sistema robusto
    const clasificacion = faseConfig[estrategiaBaseKey][estrategiaEspecificaKey][proposito] || 'neutral';

    // EXTRAER ADVERTENCIAS ESPEC√çFICAS DE LOS FEATURES
    const advertenciasEspecificas = estrategia.features ?
        estrategia.features.filter(feat =>
            feat.includes("INCOMPATIBILIDAD") ||
            feat.includes("ADVERTENCIA") ||
            feat.includes("CONTRAINDICACI√ìN") ||
            feat.includes("NO RECOMENDADO")
        ) : [];

    // Procesar y eliminar duplicados en las advertencias
    const advertenciasProcesadas = procesarAdvertencias(advertenciasEspecificas);

    // Usar las advertencias procesadas (sin duplicados)
    const advertenciasTexto = advertenciasProcesadas.map(adv => adv.texto);

    // Determinar mensaje y detalle basado en la clasificaci√≥n
    switch (clasificacion) {
        case 'recomendada':
            return {
                clasificacion: 'recomendada',
                mensaje: 'Estrategia √≥ptima para tu combinaci√≥n espec√≠fica',
                detalle: advertenciasEspecificas.length > 0 ?
                    advertenciasEspecificas.join("\n") :
                    `Esta estrategia complementa y potencia los principios de tu estrategia base "${estrategiaBase.title}"`,
                icono: 'fas fa-check-circle',
                color: '#4caf50'
            };
        case 'no recomendada':
            return {
                clasificacion: 'no recomendada',
                mensaje: 'Estrategia no recomendada para tu combinaci√≥n espec√≠fica',
                detalle: advertenciasEspecificas.length > 0 ?
                    advertenciasEspecificas.join("\n") :
                    `Esta estrategia no es √≥ptima con tu estrategia base "${estrategiaBase.title}"`,
                icono: 'fas fa-times-circle',
                color: '#f44336'
            };
        case 'neutral':
            return {
                clasificacion: 'neutral',
                mensaje: 'Estrategia compatible, pero no espec√≠ficamente optimizada',
                detalle: advertenciasEspecificas.length > 0 ?
                    advertenciasEspecificas.join("\n") :
                    'Esta estrategia es aplicable pero no aporta beneficios adicionales a tu estrategia base',
                icono: 'fas fa-circle',
                color: '#9e9e9e'
            };
        default:
            return null;
    }
}


function procesarAdvertencias(advertencias) {
    if (!advertencias || advertencias.length === 0) {
        return [];
    }

    // Crear un mapeo de incompatibilidades a t√≠tulos de estrategias
    const incompatibilidadMap = {};

    // Recorrer todas las categor√≠as en catalogoEstrategias
    Object.values(catalogoEstrategias).forEach(categoria => {
        categoria.forEach(estrategia => {
            // Buscar features que contengan "INCOMPATIBILIDAD:"
            estrategia.features.forEach(feature => {
                if (feature.includes("INCOMPATIBILIDAD:")) {
                    // Extraer el texto de la incompatibilidad (sin "INCOMPATIBILIDAD:")
                    const incompatibilidadText = feature.split("INCOMPATIBILIDAD:")[1].trim();

                    // Normalizar el texto para b√∫squedas m√°s flexibles
                    const normalizedKey = incompatibilidadText.toLowerCase().replace(/\s+/g, ' ');

                    // Mapear la incompatibilidad al t√≠tulo de la estrategia
                    incompatibilidadMap[normalizedKey] = {
                        title: estrategia.title,
                        purpose: "",
                        fullFeature: feature
                    };

                    // Buscar el prop√≥sito en las features
                    const purposeFeature = estrategia.features.find(f =>
                        f.includes("PROP√ìSITO:")
                    );

                    if (purposeFeature) {
                        incompatibilidadMap[normalizedKey].purpose =
                            purposeFeature.split("PROP√ìSITO:")[1].trim();
                    }
                }
            });
        });
    });

    // Funci√≥n para calcular similitud entre strings
    function calcularSimilitud(str1, str2) {
        const a = str1.toLowerCase().replace(/\s+/g, ' ');
        const b = str2.toLowerCase().replace(/\s+/g, ' ');

        // Algoritmo de similitud b√°sica (puedes mejorar esto con Levenshtein si es necesario)
        let matches = 0;
        for (let i = 0; i < Math.min(a.length, b.length); i++) {
            if (a[i] === b[i]) matches++;
        }

        return matches / Math.max(a.length, b.length);
    }

    // Procesar cada advertencia
    return advertencias.map(warning => {
        // Si la advertencia contiene "INCOMPATIBILIDAD:"
        if (warning.includes("INCOMPATIBILIDAD:")) {
            // Extraer el texto de la incompatibilidad
            const warningText = warning.split("INCOMPATIBILIDAD:")[1].trim();
            const normalizedWarning = warningText.toLowerCase().replace(/\s+/g, ' ');

            // Buscar la mejor coincidencia
            let mejorCoincidencia = null;
            let maxSimilitud = 0;

            Object.keys(incompatibilidadMap).forEach(key => {
                const similitud = calcularSimilitud(normalizedWarning, key);
                if (similitud > maxSimilitud) {
                    maxSimilitud = similitud;
                    mejorCoincidencia = key;
                }
            });

            // Considerar coincidencia v√°lida si la similitud es > 0.7
            if (mejorCoincidencia && maxSimilitud > 0.7) {
                const { title, purpose, fullFeature } = incompatibilidadMap[mejorCoincidencia];

                // Extraer prop√≥sito si est√° en la feature completa
                let purposeText = "";
                if (fullFeature.includes("PROP√ìSITO:")) {
                    purposeText = fullFeature.split("PROP√ìSITO:")[1].trim();
                }

                // Construir el nuevo formato
                let newWarning = `${title}: ${warningText}`;

                // Si hay prop√≥sito, a√±adirlo
                if (purposeText) {
                    newWarning += `. ${title}: ${purposeText}`;
                }

                return newWarning;
            }
        }

        // Si no es una incompatibilidad o no encontramos coincidencia clara, mantener la advertencia original
        return warning;
    });
}
// Funci√≥n adaptada para analizar tu campo features
function verificarContraindicacionEspecifica(estrategia, proposito, faseKey, estrategiaBase) {
    // 1. Contraindicaciones por prop√≥sito
    const contraindicacionProposito = estrategia.features.find(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") &&
            featLower.includes(proposito);
    });

    if (contraindicacionProposito) {
        return {
            mensaje: `No recomendado para prop√≥sito ${proposito}`,
            detalle: contraindicacionProposito.replace("INCOMPATIBILIDAD: ", "")
        };
    }

    // 2. Verificar si es v√°lida para esta fase
    const esFaseInicial = faseKey.includes("Fase 1") || faseKey.includes("0-12");
    const contraindicacionFase = estrategia.features.find(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") &&
            ((esFaseInicial && featLower.includes("no recomendado en fases iniciales")) ||
                (!esFaseInicial && featLower.includes("solo v√°lido para fases avanzadas")));
    });

    if (contraindicacionFase) {
        return {
            mensaje: `No recomendado en ${faseKey}`,
            detalle: contraindicacionFase.replace("INCOMPATIBILIDAD: ", "")
        };
    }

    // 3. Contraindicaciones por combinaci√≥n con estrategia base
    if (estrategiaBase) {
        const contraindicacionBase = estrategia.features.find(feat => {
            const featLower = feat.toLowerCase();
            return featLower.includes("incompatibilidad") &&
                (featLower.includes(estrategiaBase.title.toLowerCase()) ||
                    featLower.includes("estrategia base"));
        });

        if (contraindicacionBase) {
            return {
                mensaje: `Contraindicado con ${estrategiaBase.title}`,
                detalle: contraindicacionBase.replace("INCOMPATIBILIDAD: ", "")
            };
        }
    }

    // 4. Condiciones contextuales espec√≠ficas no cumplidas
    const contraindicacionCondiciones = estrategia.features.find(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") &&
            (featLower.includes("no v√°lido") || featLower.includes("no recomendado"));
    });

    if (contraindicacionCondiciones) {
        return {
            mensaje: `Condici√≥n no compatible`,
            detalle: contraindicacionCondiciones.replace("INCOMPATIBILIDAD: ", "")
        };
    }

    return null;
}

// Funci√≥n adaptada para verificar validez por prop√≥sito
function verificarValidezProposito(estrategia, proposito) {
    // Normalizar prop√≥sito
    const propositoMap = {
        'salud': 'salud',
        'estetica': 'est√©tica',
        'estet': 'est√©tica',
        'est√©tica': 'est√©tica',
        'rendimiento': 'rendimiento'
    };

    const propositoNormalizado = propositoMap[proposito] || proposito;

    // Verificar si es espec√≠ficamente v√°lido para este prop√≥sito
    const esValidoParaProposito = estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();

        // Caso 1: "PROP√ìSITO: V√°lido para SALUD"
        if (featLower.includes(`prop√≥sito: v√°lido para ${propositoNormalizado.toLowerCase()}`)) {
            return true;
        }

        // Caso 2: "PROP√ìSITO: V√°lido para SALUD y EST√âTICA"
        if (featLower.includes(`prop√≥sito: v√°lido para `) &&
            featLower.includes(propositoNormalizado.toLowerCase()) &&
            (featLower.includes(" y ") || featLower.includes(" y mixto"))) {
            return true;
        }

        // Caso 3: "PROP√ìSITO: Solo v√°lido para SALUD"
        if (featLower.includes(`prop√≥sito: solo v√°lido para ${propositoNormalizado.toLowerCase()}`)) {
            return true;
        }

        // Caso 4: "PROP√ìSITO: Solo v√°lido para EST√âTICA Y MIXTO"
        if (featLower.includes(`prop√≥sito: solo v√°lido para `) &&
            featLower.includes(propositoNormalizado.toLowerCase()) &&
            (featLower.includes(" y ") || featLower.includes(" y mixto"))) {
            return true;
        }

        // Caso 5: "PROP√ìSITO: V√°lido para todos los prop√≥sitos"
        if (featLower.includes("prop√≥sito: v√°lido para todos los prop√≥sitos")) {
            return true;
        }

        return false;
    });

    return esValidoParaProposito;
}

// Funci√≥n adaptada para verificar validez por fase
function verificarValidezFase(estrategia, faseKey) {
    // Determinar si es fase inicial o avanzada
    const esFaseInicial = faseKey.includes("Fase 1") || faseKey.includes("0-12");

    // Verificar si es v√°lida para esta fase
    const esValidoParaFase = estrategia.features.every(feat => {
        const featLower = feat.toLowerCase();

        // Si la estrategia tiene restricciones de fase, verificarlas
        if (featLower.includes("fases medias") || featLower.includes("fases avanzadas")) {
            return !esFaseInicial; // Solo v√°lido para fases no iniciales
        }
        return true; // Sin restricciones de fase
    });

    return esValidoParaFase;
}

// Funci√≥n adaptada para verificar compatibilidad con estrategia base
function verificarCompatibilidadBase(estrategia, estrategiaBase, proposito) {
    if (!estrategiaBase || !estrategiaBase.title) return true;

    // 1. Verificar si hay una contraindicaci√≥n expl√≠cita con la estrategia base
    const contraindicacionBase = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") &&
            (featLower.includes(estrategiaBase.title.toLowerCase()) ||
                featLower.includes("estrategia base"));
    });

    if (contraindicacionBase) {
        return false;
    }

    // 2. Verificar si la estrategia es espec√≠ficamente recomendada para la estrategia base
    const recomendacionEspecifica = estrategia.features && Array.isArray(estrategia.features) && estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("estrategia base") &&
            featLower.includes(estrategiaBase.title.toLowerCase()) &&
            (featLower.includes("recomendada") || featLower.includes("√≥ptima"));
    });

    if (recomendacionEspecifica) {
        return true;
    }

    // 3. Verificar compatibilidad general
    return true;
}

// Funciones auxiliares espec√≠ficas
function verificarContraindicacionEspecifica(estrategia, proposito, faseKey, estrategiaBase) {
    // 1. Contraindicaciones por prop√≥sito
    if (estrategia.prop√≥sitos && estrategia.prop√≥sitos[proposito] &&
        estrategia.prop√≥sitos[proposito].estado === "no") {
        return {
            mensaje: `No recomendado para prop√≥sito ${proposito}`,
            detalle: estrategia.prop√≥sitos[proposito].motivo
        };
    }

    // 2. Contraindicaciones por fase
    if (estrategia.fases && estrategia.fases[faseKey] &&
        estrategia.fases[faseKey].estado === "no") {
        return {
            mensaje: `No recomendado en ${faseKey}`,
            detalle: estrategia.fases[faseKey].motivo
        };
    }

    // 3. Contraindicaciones por combinaci√≥n con estrategia base
    if (estrategia.combinaciones && estrategiaBase && estrategiaBase.title &&
        estrategia.combinaciones[estrategiaBase.title] &&
        estrategia.combinaciones[estrategiaBase.title].estado === "no") {
        return {
            mensaje: `Contraindicado con ${estrategiaBase.title}`,
            detalle: estrategia.combinaciones[estrategiaBase.title].motivo
        };
    }

    // 4. Condiciones contextuales espec√≠ficas no cumplidas
    if (estrategia.condiciones) {
        for (const condicion of estrategia.condiciones) {
            if (condicion.includes("solo v√°lido") && !condicionCumplida(condicion, faseKey, estrategiaBase)) {
                return {
                    mensaje: `Requiere condici√≥n no cumplida`,
                    detalle: `Condici√≥n: ${condicion}`
                };
            }
            if (condicion.includes("no v√°lido") && condicionCumplida(condicion, faseKey, estrategiaBase)) {
                return {
                    mensaje: `Condici√≥n no compatible`,
                    detalle: `No v√°lido: ${condicion}`
                };
            }
        }
    }

    return null;
}

function condicionCumplida(condicion, faseKey, estrategiaBase) {
    // Implementaci√≥n de verificaci√≥n de condiciones contextuales
    if (condicion.includes("solo v√°lido tras entrenamiento intenso")) {
        return faseKey.includes("entrenamiento");
    }
    if (condicion.includes("solo para fases avanzadas (>12 semanas)")) {
        return faseKey.includes("Avanzada") || faseKey.includes(">24");
    }
    if (condicion.includes("no v√°lido en fases iniciales")) {
        return faseKey.includes("Fase 1");
    }
    if (condicion.includes("no v√°lido durante ganancia activa") && estrategiaBase) {
        return estrategiaBase.aplicable.includes("ganancia");
    }
    // ... m√°s condiciones
    return false;
}

function verificarValidezProposito(estrategia, proposito) {
    if (estrategia.prop√≥sitos && estrategia.prop√≥sitos[proposito] &&
        estrategia.prop√≥sitos[proposito].estado === "s√≠") {
        return true;
    }
    return false;
}

function verificarValidezFase(estrategia, faseKey) {
    if (estrategia.fases && estrategia.fases[faseKey] &&
        estrategia.fases[faseKey].estado === "s√≠") {
        return true;
    }
    return false;
}

function verificarCompatibilidadBase(estrategia, estrategiaBase) {
    if (!estrategiaBase || !estrategiaBase.title) return true;

    if (estrategia.combinaciones && estrategia.combinaciones[estrategiaBase.title] &&
        estrategia.combinaciones[estrategiaBase.title].estado === "s√≠") {
        return true;
    }
    return false;
}

function verificarCompatibilidadBase(estrategia, estrategiaBase, proposito) {
    if (!estrategiaBase || !estrategiaBase.title) return true;

    // 1. Verificar si hay una contraindicaci√≥n expl√≠cita con la estrategia base
    const contraindicacionBase = estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes("incompatibilidad") &&
            (featLower.includes(estrategiaBase.title.toLowerCase()) ||
                featLower.includes("estrategia base"));
    });

    if (contraindicacionBase) {
        return false;
    }

    // 2. Verificar si es la misma estrategia
    if (estrategia.title.toLowerCase() === estrategiaBase.title.toLowerCase()) {
        return true;
    }

    // 3. L√≥gica espec√≠fica para MKD (Modified Ketogenic Diet)
    if (estrategiaBase.title.toLowerCase().includes("mkd") ||
        estrategiaBase.title.toLowerCase().includes("modified ketogenic") ||
        estrategiaBase.title.toLowerCase().includes("fase mkd inicial")) {

        // MKD es compatible consigo misma
        if (estrategia.title.toLowerCase().includes("modified ketogenic") ||
            estrategia.title.toLowerCase().includes("mkd")) {
            return true;
        }

        // Para prop√≥sito salud:
        if (proposito === "salud") {
            // Restricted Ketogenic Diet no es compatible con prop√≥sito salud
            if (estrategia.title.toLowerCase().includes("restricted ketogenic")) {
                return false;
            }

            // High Carb para Deportes de Resistencia no es compatible con prop√≥sito salud
            if (estrategia.title.toLowerCase().includes("high carb")) {
                return false;
            }

            // Protein Cycling no es compatible en fases iniciales para prop√≥sito salud
            if (estrategia.title.toLowerCase().includes("protein cycling")) {
                return false;
            }

            // Intermittent Fasting no es compatible en fases iniciales para prop√≥sito salud
            if (estrategia.title.toLowerCase().includes("intermittent fasting")) {
                return false;
            }
        }

        // Estrategias generalmente compatibles con MKD
        const estrategiasCompatiblesConMKD = [
            "meal timing",
            "neat optimization",
            "hydration strategy",
            "refeed strategy",
            "calorie cycling"
        ];

        for (const estrategiaCompatible of estrategiasCompatiblesConMKD) {
            if (estrategia.title.toLowerCase().includes(estrategiaCompatible)) {
                return true;
            }
        }

        // Por defecto, si no es expl√≠citamente incompatible, asumir que es compatible
        return true;
    }

    // 4. Verificar prop√≥sito espec√≠fico
    const esValidoParaProposito = estrategia.features.some(feat => {
        const featLower = feat.toLowerCase();
        return featLower.includes(`prop√≥sito: v√°lido para ${proposito}`) ||
            featLower.includes(`prop√≥sito: solo v√°lido para ${proposito}`);
    });

    return esValidoParaProposito;
}
// ===== FUNCIONES AUXILIARES PARA SECCIONES DIN√ÅMICAS =====
function normalizarNombre(nombre) {
    return nombre.toLowerCase()
        .replace(/\(.*\)/g, '')
        .replace(/fase de /g, '')
        .replace(/fase /g, '')
        .replace(/low carb general/g, 'dieta low carb general')
        .replace(/low carb ciclada/g, 'dieta low carb ciclada')
        .replace(/\s+/g, ' ')
        .trim();
}

function generarSeccionesDinamicas(objetivo, proposito) {
    // Normalizar objetivo y prop√≥sito
    const objetivoNormalizado = objetivo.toLowerCase();
    const propositoNormalizado = proposito.toLowerCase();

    // Buscar el objetivo en nuestro objeto
    let objetivoKey;
    if (objetivoNormalizado.includes('perdida')) objetivoKey = 'perdida';
    else if (objetivoNormalizado.includes('ganancia')) objetivoKey = 'ganancia';
    else if (objetivoNormalizado.includes('mantenimiento')) objetivoKey = 'mantenimiento';
    else if (objetivoNormalizado.includes('mixto')) objetivoKey = 'mixto';

    // Buscar el prop√≥sito en nuestro objeto
    let propositoKey;
    if (propositoNormalizado.includes('salud')) propositoKey = 'salud';
    else if (propositoNormalizado.includes('estet')) propositoKey = 'estetica';
    else if (propositoNormalizado.includes('rendimiento')) propositoKey = 'rendimiento';

    // Si no encontramos coincidencias, usar valores por defecto
    if (!objetivoKey || !propositoKey) {
        return {
            recomendaciones: [],
            advertenciasGenerales: [],
            advertenciasDetalladas: []
        };
    }

    // CORRECCI√ìN AQU√ç: Usar nombres de variables diferentes
    const recomendaciones = estrategiasEspecificasPorObjetivoProposito[objetivoKey][propositoKey].recomendaciones || [];
    const advertenciasGenerales = estrategiasEspecificasPorObjetivoProposito[objetivoKey][propositoKey].advertencias || [];
    // Usamos 'detailedWarnings' en lugar de 'advertenciasDetalladas' para evitar el conflicto
    const detailedWarnings = advertenciasDetalladas[objetivoKey][propositoKey] || [];

    return {
        recomendaciones,
        advertenciasGenerales,
        advertenciasDetalladas: detailedWarnings  // Renombramos la propiedad
    };
}

function normalizarEstructuraMacros(estrategiaBase, proposito) {
    // Obtener los macros para el prop√≥sito especificado
    const macrosBase = estrategiaBase.macros[`macros${proposito.charAt(0).toUpperCase() + proposito.slice(1)}`];

    // Si ya tiene la estructura completa (diasEntreno y diasDescanso), devolverla
    if (macrosBase.diasDescanso && macrosBase.diasEntreno) {
        return macrosBase;
    }

    // Caso especial: Formato de texto con "D√≠as descanso: ... | D√≠as entreno: ..."
    if (typeof macrosBase.proteinGr === 'string' && macrosBase.proteinGr.includes('|')) {
        const diasDescansoMatch = macrosBase.proteinGr.match(/D√≠as descanso: ([^|]+)/);
        const diasEntrenoMatch = macrosBase.proteinGr.match(/D√≠as entreno: ([^|]+)/);

        return {
            diasDescanso: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasDescansoMatch ? diasDescansoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ?
                    macrosBase.carbinGr.match(/D√≠as descanso: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ?
                    macrosBase.fatinGr.match(/D√≠as descanso: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            },
            diasEntreno: {
                proteinPct: macrosBase.proteinPct,
                fatPct: macrosBase.fatPct,
                carbPct: macrosBase.carbPct,
                proteinGr: diasEntrenoMatch ? diasEntrenoMatch[1].trim() : macrosBase.proteinGr,
                carbinGr: macrosBase.carbinGr.includes('|') ?
                    macrosBase.carbinGr.match(/D√≠as entreno: ([^|]+)/)[1].trim() : macrosBase.carbinGr,
                fatinGr: macrosBase.fatinGr.includes('|') ?
                    macrosBase.fatinGr.match(/D√≠as entreno: ([^|]+)/)[1].trim() : macrosBase.fatinGr
            }
        };
    }

    // Caso especial: Formato con semanas (semanasBajasHC, semanasAltasHC, etc.)
    if (macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase.semanasAltasHC) {
        return {
            diasDescanso: macrosBase.semanasBajasHC || macrosBase.semanasMediasHC || macrosBase,
            diasEntreno: macrosBase.semanasAltasHC || macrosBase
        };
    }

    // Caso especial: Formato con tipos de entrenamiento (fuerza, resistencia)
    if (macrosBase.fuerza || macrosBase.resistencia) {
        return {
            diasDescanso: macrosBase.resistencia || macrosBase,
            diasEntreno: macrosBase.fuerza || macrosBase
        };
    }

    // Caso especial: Formato con d√≠as de d√©ficit/super√°vit
    if (macrosBase.diasDeficit || macrosBase.diasSuperavit) {
        return {
            diasDescanso: macrosBase.diasDeficit || macrosBase,
            diasEntreno: macrosBase.diasSuperavit || macrosBase
        };
    }

    // Si no hay diferenciaci√≥n, crear una estructura est√°ndar
    return {
        diasDescanso: macrosBase,
        diasEntreno: macrosBase
    };
}

function obtenerTipoDiaActual() {
    // Intentar obtener el tipo de d√≠a desde la interfaz de usuario
    const trainingDaysSelect = document.getElementById('trainingDays');
    if (trainingDaysSelect && trainingDaysSelect.value) {
        return trainingDaysSelect.value === 'entreno';
    }

    // Si no se encuentra el elemento, intentar con otros m√©todos
    const diaEntrenoCheckbox = document.getElementById('diaEntreno');
    if (diaEntrenoCheckbox && diaEntrenoCheckbox.checked) {
        return true;
    }

    // Si no hay informaci√≥n, verificar en el localStorage
    const tipoDia = localStorage.getItem('tipoDiaActual');
    if (tipoDia) {
        return tipoDia === 'entreno';
    }

    // Si no hay informaci√≥n, asumir que es d√≠a de entreno (m√°s com√∫n)
    return true;
}

// Configurar evento para cuando cambia el tipo de d√≠a
document.addEventListener('DOMContentLoaded', function () {
    const trainingDaysSelect = document.getElementById('trainingDays');
    if (trainingDaysSelect) {
        trainingDaysSelect.addEventListener('change', function () {
            localStorage.setItem('tipoDiaActual', this.value);
            actualizarInterfazMacros();
        });
    }
});
function actualizarVistaPreviaHorario() {
    const estrategiaBase = obtenerEstrategiaBaseSeleccionada();
    if (!estrategiaBase) return;

    // Normalizar la estructura de macros
    const estrategiaNormalizada = normalizarEstructuraMacros(estrategiaBase);
    const proposito = document.getElementById('objetivoGeneral').value.toLowerCase();

    // Obtener macros para el prop√≥sito
    const macros = estrategiaNormalizada.macros[`macros${proposito.charAt(0).toUpperCase() + proposito.slice(1)}`];

    // Actualizar la vista previa
    const schedulePreview = document.getElementById('schedule-preview');

    // Generar HTML para la vista previa
    let html = `
        <div class="schedule-day ${esDiaEntreno ? 'training-day' : 'rest-day'}">
            <h5>${esDiaEntreno ? 'D√≠a de Entreno' : 'D√≠a de Descanso'}</h5>
            <div class="macro-ranges">
                <p><strong>Prote√≠nas:</strong> ${macros[esDiaEntreno ? 'diasEntreno' : 'diasDescanso'].proteinGr}</p>
                <p><strong>Carbohidratos:</strong> ${macros[esDiaEntreno ? 'diasEntreno' : 'diasDescanso'].carbinGr}</p>
                <p><strong>Grasas:</strong> ${macros[esDiaEntreno ? 'diasEntreno' : 'diasDescanso'].fatinGr}</p>
            </div>
        </div>
    `;

    schedulePreview.innerHTML = html;
}
function actualizarInterfazMacrosConValores(macros) {
    // Actualizar porcentajes en los inputs
    const proteinasPctInput = document.getElementById('proteinas-pct');
    const grasaPctInput = document.getElementById('grasa-pct');
    const hcPctInput = document.getElementById('hc-pct');

    if (proteinasPctInput) proteinasPctInput.value = macros.proteinasPct;
    if (grasaPctInput) grasaPctInput.value = macros.grasasPct;
    if (hcPctInput) hcPctInput.value = macros.hcPct;

    // ACTUALIZAR CORRECTAMENTE LOS CAMPOS DE GRAMOS
    const proteinasGrElement = document.getElementById('proteinas-gr');
    const hcGrElement = document.getElementById('hc-gr');
    const grasasGrElement = document.getElementById('grasas-gr');

    if (proteinasGrElement) {
        proteinasGrElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: ${macros.proteinasPct}%"></div>
                </div>
                <span>${macros.proteinasPct}% (${macros.proteinasGr})</span>
            </div>
        `;
    }

    if (grasasGrElement) {
        grasasGrElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: ${macros.grasasPct}%"></div>
                </div>
                <span>${macros.grasasPct}% (${macros.grasasGr})</span>
            </div>
        `;
    }

    if (hcGrElement) {
        hcGrElement.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="progress flex-grow-1 me-2" style="height: 10px;">
                    <div class="progress-bar bg-danger" style="width: ${macros.hcPct}%"></div>
                </div>
                <span>${macros.hcPct}% (${macros.hcGr})</span>
            </div>
        `;
    }

    // Actualizar visualizaci√≥n de macros
    actualizarVisualizacionMacros(macros);
}

function actualizarVisualizacionMacros(macros) {
    // Actualizar barras de progreso
    const proteinaBar = document.querySelector('.macro-progress.proteinas .progress-bar');
    const grasaBar = document.querySelector('.macro-progress.grasas .progress-bar');
    const hcBar = document.querySelector('.macro-progress.hc .progress-bar');

    if (proteinaBar) proteinaBar.style.width = `${macros.proteinasPct}%`;
    if (grasaBar) grasaBar.style.width = `${macros.grasasPct}%`;
    if (hcBar) hcBar.style.width = `${macros.hcPct}%`;

    // Actualizar texto en las barras
    const proteinaText = document.querySelector('.macro-progress.proteinas span');
    const grasaText = document.querySelector('.macro-progress.grasas span');
    const hcText = document.querySelector('.macro-progress.hc span');

    if (proteinaText) proteinaText.textContent = `${macros.proteinasPct}% (${macros.proteinasGr})`;
    if (grasaText) grasaText.textContent = `${macros.grasasPct}% (${macros.grasasGr})`;
    if (hcText) hcText.textContent = `${macros.hcPct}% (${macros.hcGr})`;
}

//////////FUNCIONES PARA MANEJAR TOOLTIPS EN MODAL////////////////////////
// Funci√≥n para generar contenido del tooltip
// Funci√≥n para generar contenido del tooltip
function getTooltipContent(block, objetivo, proposito) {
    console.log('Debug - Input:', { block, objetivo, proposito });

    const normalizedBlock = block.toLowerCase().replace(/\s+/g, '');
    let normalizedObjetivo = objetivo.toLowerCase().replace(/\s+/g, '');

    // Normalizaci√≥n para objetivo
    if (normalizedObjetivo.includes('perdida1') || normalizedObjetivo.includes('perdida')) normalizedObjetivo = 'perdida';
    else if (normalizedObjetivo.includes('ganancia') || normalizedObjetivo.includes('ganacia')) normalizedObjetivo = 'ganancia';
    else if (normalizedObjetivo.includes('mantenimiento') || normalizedObjetivo.includes('mentenimeto')) normalizedObjetivo = 'mantenimiento';
    else if (normalizedObjetivo.includes('mixto') || normalizedObjetivo.includes('mixt0')) normalizedObjetivo = 'mixto';

    let normalizedProposito = proposito.toLowerCase().replace(/\s+/g, '');
    if (normalizedProposito.includes('salud')) normalizedProposito = 'salud';
    else if (normalizedProposito.includes('estet')) normalizedProposito = 'estetica';
    else if (normalizedProposito.includes('rendimiento')) normalizedProposito = 'rendimiento';

    console.log('Debug - Normalized:', { normalizedBlock, normalizedObjetivo, normalizedProposito });

    const data = infoMatrix[normalizedBlock]?.[normalizedObjetivo]?.[normalizedProposito];

    console.log('Debug - Data found:', !!data);

    if (!data) {
        return "Informaci√≥n no disponible para esta combinaci√≥n. Verifica objetivo/prop√≥sito.";
    }

    return `
        <strong>Fin:</strong> ${data.fin}<br>
        <strong>Prop√≥sito:</strong> ${data.proposito}<br>
        <strong>Recomendada:</strong> ${data.recomendada}<br>
        <strong>Justificaci√≥n:</strong> ${data.justificacion}
      `;
}

// Event listener para tooltips en los iconos
document.addEventListener('DOMContentLoaded', () => {
    const accordionIcons = document.querySelectorAll('.accordion-button i');

    accordionIcons.forEach(icon => {
        icon.addEventListener('mouseover', (e) => {
            const accordionButton = e.target.closest('.accordion-button');
            const accordionId = e.target.closest('.accordion').id;
            let block;
            if (accordionId === 'accordionCetogenicas') block = 'cetogenicas';
            else if (accordionId === 'accordionCiclado') block = 'ciclado';
            else if (accordionId === 'accordionTiming') block = 'timing';

            if (!block) return;

            const objetivoSelect = document.getElementById('objetivo');
            const objetivo = objetivoSelect ? objetivoSelect.value : 'perdida';

            const propositoSelect = document.getElementById('proposito');
            const proposito = propositoSelect ? propositoSelect.value : 'salud';

            const tooltipContent = getTooltipContent(block, objetivo, proposito);

            // Aplicar tooltip al bot√≥n padre para mejor posicionamiento
            accordionButton.setAttribute('data-bs-toggle', 'tooltip');
            accordionButton.setAttribute('data-bs-placement', 'top');
            accordionButton.setAttribute('data-bs-html', 'true');
            accordionButton.title = tooltipContent;

            const tooltip = new bootstrap.Tooltip(accordionButton, {
                trigger: 'manual',
                customClass: 'custom-tooltip'
            });
            tooltip.show();
        });

        icon.addEventListener('mouseout', (e) => {
            const accordionButton = e.target.closest('.accordion-button');
            const tooltip = bootstrap.Tooltip.getInstance(accordionButton);
            if (tooltip) tooltip.hide();
        });
    });
});
///////////////////////////////////////////////////////////////////////////////////////
// SECCION TABLA DE PLANIFICACION ( GENERAL Y DETALLADA//
///////////////////////////////////////////////////////////////////////////////////
/** Genera y muestra la Tabla General del Proceso Nutricional.
* @param {string} contenedorId - El ID del elemento HTML donde se insertar√° la tabla.
*/
function mostrarTablaGeneralProceso(contenedorId = 'tablaGeneralProcesoContainer') {
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error(`No se encontr√≥ el contenedor con ID '${contenedorId}' para la Tabla General.`);
        return;
    }

    // Estas variables deben estar definidas en tu aplicaci√≥n
    const semanasTotalesEstimadas = window.nonlinearProgressData_1?.tiempo?.semanasEstimadas || 0;
    const objetivoActual = document.getElementById('objetivo')?.value || 'perdida1';
    const pesoActualUsuario = window.currentWeightKg || 0;
    // const cambioPesoTotal = window.nonlinearProgressData_1?.objetivo?.metaKg || 0;
    const metaKg = window.nonlinearProgressData_1?.objetivo?.metaKg || 0;

    let cambioPesoTotal;
    if (objetivoActual === 'ganacia1') {
        cambioPesoTotal = Math.abs(metaKg);
    } else if (objetivoActual === 'perdida1') {
        cambioPesoTotal = -Math.abs(metaKg);
    } else {
        cambioPesoTotal = 0;

    }

    const edad = document.getElementById('age').value;
    const genero = window.userGender || 'male';
    const sexo = genero;
    const proposito = document.getElementById('objetivoGeneral')?.value || 'estetico';
    const porcentajeGrasa = parseFloat(document.getElementById('current-fat-percentage')?.value) || 0;
    const porcentajemusculo = parseFloat(document.getElementById('target-muscle-percentage')?.value) || 0;
    const nivelActividad = window.userActivityLevel || 1.375;
    const nivelEntrenamiento = (document.getElementById('is-athlete') || window.userActivityLevel > 1.55) ? 'avanzado' : 'principiante';

    try {
        // Verificar variables globales
        console.log('Variables globales:', {
            goalTypeGlobal: objetivoActual,
            estimatedWeeksManualGlobal: semanasTotalesEstimadas,
            currentWeightKg: pesoActualUsuario,
            weightChangeGoalManualGlobal: cambioPesoTotal,
            edad: edad,
            sexo: genero,
            porcentajeGrasa: porcentajeGrasa,
            nivelActividad: nivelActividad,
            nivelEntrenamiento: nivelEntrenamiento,
            proposito: proposito
        });

        // Esta funci√≥n debe estar definida en tu aplicaci√≥n
        const datosTablaObj = generarDatosTablaGeneral(
            objetivoActual,
            semanasTotalesEstimadas,
            pesoActualUsuario,
            cambioPesoTotal,
            edad,
            sexo,
            porcentajeGrasa,
            nivelActividad,
            nivelEntrenamiento,
            proposito
        );

        // Validar que datosTablaObj y datosTablaObj.datosTabla existan y sean un array
        if (!datosTablaObj || !Array.isArray(datosTablaObj.datosTabla) || datosTablaObj.datosTabla.length === 0) {
            console.warn("No se encontraron datos v√°lidos para la tabla general:", datosTablaObj);
            return;
        }

        const datosTabla = datosTablaObj.datosTabla;

        // Calcular m√©tricas para el resumen
        const pesoObjetivo = (parseFloat(datosTablaObj.pesoInicial) + parseFloat(cambioPesoTotal)).toFixed(1);




        // Contar fases y pausas
        const totalPausas = datosTabla.filter(fila => fila.nombreFase.includes('Pausa')).length;

        // Calcular semanas activas vs semanas de pausa
        const semanasActivas = datosTabla
            .filter(fila => !fila.nombreFase.includes('Pausa'))
            .reduce((total, fila) => total + fila.semanasAsignadas, 0);

        const semanasPausa = datosTabla
            .filter(fila => fila.nombreFase.includes('Pausa'))
            .reduce((total, fila) => total + fila.semanasAsignadas, 0);

        // Calcular correctamente la duraci√≥n de cada fase
        const duracionPorFase = {};

        datosTabla.forEach(fila => {
            if (!fila.nombreFase.includes('Pausa')) {
                // Extraer el nombre base de la fase (sin informaci√≥n de ciclo)
                const nombreBase = fila.nombreFase.split(',')[0].trim();

                if (!duracionPorFase[nombreBase]) {
                    duracionPorFase[nombreBase] = 0;
                }

                duracionPorFase[nombreBase] += fila.semanasAsignadas;
            }
        });

        // Convertir a array para mostrar
        const duracionFases = Object.keys(duracionPorFase).map(nombre => ({
            nombre: nombre,
            semanas: duracionPorFase[nombre]
        }));

        // Calcular el total de fases principales
        const totalFases = duracionFases.length;

        // Generar observaciones basadas en la condici√≥n de salud y el plan
        let observacionesPlan = '';

        // Condici√≥n de salud
        if (datosTablaObj.condicionSalud === 'pobre') {
            observacionesPlan += `<p><strong>‚ö†Ô∏è Condici√≥n de salud:</strong> Se detect√≥ una condici√≥n de salud que requiere atenci√≥n. Se recomienda consultar dengan un profesional m√©dico antes de comenzar el plan.</p>`;
        } else if (datosTablaObj.condicionSalud === 'media') {
            observacionesPlan += `<p><strong>‚ÑπÔ∏è Condici√≥n de salud:</strong> Su condici√≥n de salud es aceptable pero requiere seguimiento. El plan est√° adaptado a sus necesidades.</p>`;
        } else {
            observacionesPlan += `<p><strong>‚úÖ Condici√≥n de salud:</strong> Su condici√≥n de salud es √≥ptima para seguir este plan nutricional.</p>`;
        }

        // Tipo de obesidad
        if (datosTablaObj.tipoObesidad === 'tipo3') {
            observacionesPlan += `<p><strong>üîî Composici√≥n corporal:</strong> Se detecta un porcentaje de grasa elevado. El plan se ha ajustado para una p√©rdida de peso gradual y sostenible.</p>`;
        } else if (datosTablaObj.tipoObesidad === 'tipo2') {
            observacionesPlan += `<p><strong>üìã Composici√≥n corporal:</strong> Su porcentaje de grasa est√° por encima del recomendado. El plan incluye estrategias espec√≠ficas para mejorar su composici√≥n corporal.</p>`;
        } else if (datosTablaObj.tipoObesidad === 'tipo1') {
            observacionesPlan += `<p><strong>üìä Composici√≥n corporal:</strong> Su porcentaje de grasa est√° ligeramente por encima de lo ideal. El plan le ayudar√° a alcanzar sus objetivos.</p>`;
        }

        // Observaciones espec√≠ficas del plan
        observacionesPlan += `<p><strong>üìÖ Duraci√≥n del plan:</strong> ${datosTablaObj.semanasTotales} semanas con ${totalPausas} pausas metab√≥licas programadas.</p>`;

        if (totalPausas > 0) {
            observacionesPlan += `<p><strong>‚è∏Ô∏è Pausas metab√≥licas:</strong> El plan incluye ${totalPausas} pausas de una semana para recuperaci√≥n metab√≥lica. Durante estas pausas, mantendr√° su peso y consumir√° calor√≠as de mantenimiento.</p>`;
        }

        if (objetivoActual === 'perdida1') {
            observacionesPlan += `<p><strong>üéØ Objetivo:</strong> Plan de p√©rdida de grasa con un d√©ficit cal√≥rico controlado para preservar masa muscular.</p>`;
        } else if (objetivoActual === 'ganancia1') {
            observacionesPlan += `<p><strong>üéØ Objetivo:</strong> Plan de ganancia muscular con super√°vit cal√≥rico controlado para minimizar la ganancia de grasa.</p>`;
        } else if (objetivoActual === 'mantenimiento1') {
            observacionesPlan += `<p><strong>üéØ Objetivo:</strong> Plan de mantenimiento para conservar su composici√≥n corporal actual.</p>`;
        } else if (objetivoActual === 'mixto1') {
            observacionesPlan += `<p><strong>üéØ Objetivo:</strong> Plan mixto que alterna periodos de volumen y definici√≥n para optimizar resultados.</p>`;
        }

        // Verificar consistencia en las duraciones
        const semanasTotalesCalculadas = semanasActivas + semanasPausa;
        if (semanasTotalesCalculadas !== datosTablaObj.semanasTotales) {
            observacionesPlan += `<p><strong>üìù Nota:</strong> La duraci√≥n total del plan (${semanasTotalesCalculadas} semanas) difiere ligeramente de la estimaci√≥n inicial (${datosTablaObj.semanasTotales} semanas) debido a ajustes en la planificaci√≥n de pausas metab√≥licas.</p>`;
        }

        // Recomendaciones generales
        observacionesPlan += `<p><strong>üí° Recomendaciones:</strong> Siga las proporciones de macronutrientes indicadas, mantenga una hidrataci√≥n adecuada y ajuste el plan seg√∫n su evoluci√≥n en las reevaluaciones.</p>`;


        // Crear HTML del resumen
        const resumenHTML = `
            <div class="resumen-plan" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h4 style="color: #2e7d32; margin-bottom: 20px; border-bottom: 2px solid #4caf50; padding-bottom: 10px;">
                    <i class="bi bi-clipboard-data"></i> Resumen del Plan Nutricional
                </h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: #388e3c; margin-bottom: 15px;">Datos Personales</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Peso inicial:</strong><br>${datosTablaObj.pesoInicial} kg</p>
                                    <p><strong>Edad:</strong><br>${edad} a√±os</p>
                                    <p><strong>% Grasa:</strong><br>${porcentajeGrasa}%</p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Peso objetivo:</strong><br>${pesoObjetivo} kg</p>
                                    <p><strong>G√©nero:</strong><br>${genero === 'male' ? 'Hombre' : 'Mujer'}</p>
                                    <p><strong>% M√∫sculo:</strong><br>${porcentajemusculo}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h5 style="color: #388e3c; margin-bottom: 15px;">Estad√≠sticas del Plan</h5>
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Duraci√≥n total:</strong><br>${semanasTotalesCalculadas} semanas</p>
                                    <p><strong>Total de fases:</strong><br>${totalFases}</p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Semanas activas:</strong><br>${semanasActivas} semanas</p>
                                    <p><strong>Pausas metab√≥licas:</strong><br>${totalPausas}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="color: #388e3c; margin-bottom: 15px;">Duraci√≥n de Cada Fase</h5>
                    <div class="row">
                        ${duracionFases.map((fase, index) => `
                            <div class="col-md-${duracionFases.length > 2 ? '4' : '6'} col-sm-6">
                                <div class="fase-duracion" style="background: #f1f8e9; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: center;">
                                    <strong>${fase.nombre.split(':')[0]}</strong><br>
                                    <span style="font-size: 18px; color: #2e7d32;">${fase.semanas} semanas</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="color: #388e3c; margin-bottom: 15px;">Objetivo y Prop√≥sito</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Objetivo principal:</strong><br>
                            ${objetivoActual === 'perdida1' ? 'P√©rdida de grasa' :
                objetivoActual === 'ganancia1' ? 'Ganancia muscular' :
                    objetivoActual === 'mantenimiento1' ? 'Mantenimiento' : 'Plan mixto'}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Prop√≥sito:</strong><br>
                            ${proposito === 'estetico' ? 'Est√©tico' :
                proposito === 'rendimiento' ? 'Rendimiento' : 'Salud'}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="resumen-item" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="color: #388e3c; margin-bottom: 15px;">Observaciones del Plan</h5>
                    <div class="observaciones-plan">
                        ${observacionesPlan}
                    </div>
                </div>
            </div>
        `;

        // Agrupar fases y pausas manteniendo el orden original
        const fasesAgrupadas = agruparFasesYPausasEnOrden(datosTabla);

        let htmlCard = `
            <div class="card-body" style="margin-top: -1rem; padding-top: 0.5rem;">
                ${resumenHTML}
                <div class="table-responsive tabla-planificacion-wrapper mb-0">
                    <table id="tablaGeneralProceso" class="table table-striped table-bordered align-middle tabla-planificacion">
                        <thead>
                            <tr>
								<th scope="col" style="width: 10%;">Fase</th>
								<th scope="col" style="width: 15%;">Nombre</th>
								<th scope="col" style="width: 15%;">Duraci√≥n</th>
								<th scope="col" style="width: 10%;">Peso Inicial</th>
								<th scope="col" style="width: 10%;">Peso Final</th>
								<th scope="col" style="width: 15%;">Objetivo</th>
								<!--<th scope="col" style="width: 15%;">Acciones</th>-->
							</tr>
                        </thead>
                        <tbody>
        `;

        // Generar acordeones para cada grupo de fases
        fasesAgrupadas.forEach((grupo, index) => {
            htmlCard += generarAcordeonGrupoProfesional(grupo, index);
        });

        htmlCard += `
                        </tbody>
                    </table>
                </div>
                <p class="text-muted small mt-2"><em>* Los valores de gramos por d√≠a son estimaciones basadas en el peso inicial de la fase y una aproximaci√≥n del gasto energ√©tico. Pueden variar seg√∫n la actividad diaria.</em></p>
            </div>
        `;

        contenedor.innerHTML = htmlCard;

        // A√±adir event listeners para los acordeones
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                content.classList.toggle('show');

                // Rotar el √≠cono
                const icon = header.querySelector('.accordion-icon');
                if (icon) {
                    icon.classList.toggle('bi-chevron-down');
                    icon.classList.toggle('bi-chevron-up');
                }
            });
        });

        // ‚úÖ A√±adir estilos CSS para las filas de pausa si no existen
        if (!document.querySelector('style#tabla-estilos')) {
            const style = document.createElement('style');
            style.id = 'tabla-estilos';
            style.textContent = `
                tr.pausa {
                    background-color: #fff4e6 !important;
                    font-style: italic;
                }
                tr.pausa td {
                    color: #f39c12;
                }
                .accordion-phase {
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    margin-bottom: 10px;
                }
                .accordion-header {
                    background-color: #e9ecef;
                    padding: 12px 15px;
                    cursor: pointer;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #dee2e6;
					border-radius: 8px;
                }
                .accordion-header:hover {
                    background-color: #dee2e6;
                }
                .accordion-content {
                    display: none;
                    padding: 0;
                    overflow: hidden;
                }
                .accordion-content.show {
                    display: table-row-group;
                }
                .phase-badge {
                    background-color: #6c757d;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 15px;
                    font-size: 12px;
                    margin-left: 10px;
                }
                .pause-badge {
                    background-color: #fd7e14;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 15px;
                    font-size: 12px;
                    margin-left: 10px;
                }
                .resumen-plan {
                    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
                    padding: 20px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                }
                .resumen-item {
                    background: white;
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 15px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                }
                .fase-duracion {
                    background: #f1f8e9;
                    padding: 10px;
                    border-radius: 6px;
                    margin-bottom: 10px;
                    text-align: center;
                }
            `;
            document.head.appendChild(style);
        }
    } catch (error) {
        console.error('Error al generar la tabla:', error);
    }
}

function agruparFasesYPausasEnOrden(datosTabla) {
    const grupos = {};
    let currentGroupKey = null;

    datosTabla.forEach(fila => {
        if (!fila.nombreFase.includes('Pausa')) {
            const match = fila.nombreFase.match(/^(Fase \d+):/);
            const groupKey = match ? match[1] : fila.nombreFase.split(':')[0].trim();
            currentGroupKey = groupKey;

            let nombreFase = fila.nombreFase;
            if (fila.nombreFase.includes(':')) {
                nombreFase = fila.nombreFase.split(':').pop().trim();
            }

            if (!grupos[groupKey]) {
                grupos[groupKey] = {
                    nombre: groupKey,
                    tipo: groupKey,
                    nombreFase: nombreFase,
                    fases: [],
                    todasLasFilas: []
                };
            }

            grupos[groupKey].fases.push(fila);
            grupos[groupKey].todasLasFilas.push(fila);
        }
        else if (currentGroupKey && grupos[currentGroupKey]) {
            grupos[currentGroupKey].todasLasFilas.push(fila);
        }
    });

    return Object.values(grupos);
}

// Funci√≥n para generar el HTML de un grupo de acorde√≥n con dise√±o profesional

function generarAcordeonGrupoProfesional(grupo, index) {
    const semanasTotales = grupo.todasLasFilas.reduce((sum, fila) => sum + fila.semanasAsignadas, 0);
    const fases = grupo.fases;
    const pesoInicial = fases.length > 0 ? fases[0].pesoInicioFase : 0;
    const pesoFinal = fases.length > 0 ? fases[fases.length - 1].pesoFinFase : 0;
    const numeroFase = grupo.tipo.match(/\d+/)?.[0] || (index + 1);
    const nombreFase = grupo.nombreFase;
    // Define el mapa de iconos basado en el n√∫mero de fase
    const iconMap = {
        1: '<i class="fa-solid fa-bolt"></i>',
        2: '<i class="fa-solid fa-seedling"></i>',
        3: '<i class="fas fa-balance-scale me-2"></i>',
        4: '<i class="fas fa-exchange-alt me-2"></i>'
    };
    const phaseIcon = iconMap[numeroFase] || '';

    return `
        <tr class="accordion-phase">
			<td colspan="6" class="p-0">
				<div class="accordion-header" style="border-radius: 10px; overflow: hidden;">
					<table class="table mb-0" style="width: 100%; margin-bottom: 0 !important;">
						<tbody>
							<tr style="background-color: #f8f9fa; text-align: center;">
								<td style="width: 13%; vertical-align: middle; text-align: left;">
									${phaseIcon}
									<strong>${grupo.nombre}</strong> 
									<span class="badge bg-primary">Fase ${numeroFase}</span>
								</td>
								<td style="width: 25%; vertical-align: middle; text-align: left;">
									<strong>${nombreFase}</strong>
								</td>
								<td style="width: 19%; vertical-align: middle;">
									<strong>${semanasTotales} semanas</strong>
								</td>
								<td style="width: 15%; vertical-align: middle;">
									<strong>${pesoInicial} kg</strong>
								</td>
								<td style="width: 15%; vertical-align: middle;">
									<strong>${pesoFinal} kg</strong>
								</td>
								<td style="width: 25%; vertical-align: middle;font-size: 11px;">
									${fases.length > 0 ? fases[0].objetivoPrincipal : ''}
								</td>
								<td style="width: 15%; vertical-align: middle; text-align: center;">
									<button class="btn btn-sm btn-outline-secondary me-1" 
											data-bs-toggle="modal" 
											data-bs-target="#editModal"
											data-fase-nombre="${grupo.nombre}"
											data-fase-numero="${numeroFase}"
											onclick="openEditModal(event, this)">
										<i class="bi bi-pencil"></i>
									</button>
									<i class="bi bi-chevron-down accordion-icon" style="cursor: pointer;"></i>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
                <div class="accordion-content">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 10%">Meses</th>
                                <th scope="col" style="width: 8%">Semanas</th>
                                <th scope="col" style="width: 8%">ReEval<br><small>(Semana)</small></th>
                                <th scope="col" style="width: 15%">Fase</th>
                                <th scope="col" style="width: 10%">% Pt<br><small>(g/d√≠a)</small></th>
                                <th scope="col" style="width: 10%">% GR<br><small>(g/d√≠a)</small></th>
                                <th scope="col" style="width: 10%">% CH<br><small>(g/d√≠a)</small></th>
                                <th scope="col" style="width: 12%">Objetivo Principal</th>
                                <th scope="col" style="width: 12%">Observaciones</th>
                                <th scope="col" style="width: 5%">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generarFilasGrupoCompleto(grupo)}
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
    `;
}

// Funci√≥n para configurar el modal con la informaci√≥n de la fase
function configurarModalParaFase(nombreFase, numeroFase) {
    // Actualizar el t√≠tulo del modal con el nombre de la fase
    document.getElementById('modal-phase-title').textContent = `Configuraci√≥n de Estrategias - ${nombreFase}`;

    // Aqu√≠ puedes agregar l√≥gica adicional para preconfigurar el modal
    // seg√∫n el tipo de fase (Fase 1, 2, 3, etc.)
    console.log(`Configurando modal para: ${nombreFase} (Fase ${numeroFase})`);

    // Ejemplo: Seleccionar estrategias predeterminadas seg√∫n el tipo de fase
    if (numeroFase === 1) {
        // Configuraci√≥n para Fase 1: Inducci√≥n Cetog√©nica
        seleccionarEstrategiaBase('cetogenica');
    } else if (numeroFase === 2) {
        // Configuraci√≥n para Fase 2: Ciclado Metab√≥lico
        seleccionarEstrategiaBase('ciclado');
    } else if (numeroFase === 3) {
        // Configuraci√≥n para Fase 3: Transici√≥n a Mantenimiento
        seleccionarEstrategiaBase('mantenimiento');
    }
}

// Funci√≥n de ejemplo para seleccionar una estrategia base
function seleccionarEstrategiaBase(tipo) {
    console.log(`Seleccionando estrategia base: ${tipo}`);
    // Aqu√≠ ir√≠a la l√≥gica para seleccionar y mostrar la estrategia base en el modal
}

// A√±adir estos estilos CSS para mejorar la apariencia del modal y la tabla
if (!document.querySelector('style#tabla-estilos-mejorados')) {
    const style = document.createElement('style');
    style.id = 'tabla-estilos-mejorados';
    style.textContent = `
        .accordion-phase {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: white;
        }
        .accordion-header {
            padding: 0;
            cursor: pointer;
        }
        .accordion-header table {
            margin-bottom: 0;
        }
        .accordion-header:hover {
            background-color: #f1f3f5;
        }
        .accordion-content {
            display: none;
            padding: 0;
            overflow: hidden;
        }
        .accordion-content.show {
            display: block;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header .bi-chevron-down {
            transform: rotate(0deg);
        }
        .accordion-header .bi-chevron-up {
            transform: rotate(180deg);
        }
        tr.pausa {
            background-color: #fff4e6 !important;
            font-style: italic;
        }
        tr.pausa td {
            color: #f39c12;
        }
        .badge {
            font-size: 0.75em;
        }
        
        /* Estilos para el modal de estrategias */
        .phase-config-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .phase-config-section h5 {
            color: #2c3e50;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }
        .macro-config {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .macro-input {
            flex: 1;
            text-align: center;
        }
        .macro-input label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .macro-input input {
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: white;
        }
        .macro-values {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #6c757d;
        }
        .strategy-category {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: white;
            border: 1px solid #e9ecef;
        }
        .training-config {
            padding: 1rem;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .days-selector, .intensity-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .day-option, .intensity-option {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            flex: 1;
        }
        .day-option:hover, .intensity-option:hover {
            background-color: #e9ecef;
        }
        .day-option.selected, .intensity-option.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .schedule-days {
            display: flex;
            gap: 0.5rem;
        }
        .schedule-day {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .schedule-day.training {
            background-color: #d4edda;
            color: #155724;
        }
        .schedule-day.rest {
            background-color: #f8d7da;
            color: #721c24;
        }
        .save-config-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-config-btn:hover {
            background-color: #218838;
        }
    `;
    document.head.appendChild(style);
}

// Funci√≥n para generar todas las filas de un grupo (fases + pausas en orden)
function generarFilasGrupoCompleto(grupo) {
    let filasHTML = '';

    grupo.todasLasFilas.forEach(fila => {
        const proteinas_g_kg = fila.proteinas_g_kg || (fila.proteinas_g_dia / fila.pesoInicioFase).toFixed(1);
        const carbohidratos_g_kg = fila.carbohidratos_g_kg || (fila.carbohidratos_g_dia / fila.pesoInicioFase).toFixed(1);
        const grasas_g_kg = fila.grasas_g_kg || (fila.grasas_g_dia / fila.pesoInicioFase).toFixed(1);

        if (fila.nombreFase.includes('Pausa')) {
            const datosFaseParaJS_pausa = encodeURIComponent(JSON.stringify({
                nombreFase: fila.nombreFase,
                semanasAsignadas: fila.semanasAsignadas,
                mesesTexto: fila.mesesTexto,
                macrosBase: {
                    proteinasPct: fila.proteinasPct,
                    carbohidratosPct: fila.carbohidratosPct,
                    grasasPct: fila.grasasPct
                },
                proteinas_g_dia: fila.proteinas_g_dia,
                carbohidratos_g_dia: fila.carbohidratos_g_dia,
                grasas_g_dia: fila.grasas_g_dia,
                proteinas_g_kg: proteinas_g_kg,
                carbohidratos_g_kg: carbohidratos_g_kg,
                grasas_g_kg: grasas_g_kg,
                pesoInicioFase: fila.pesoInicioFase,
                pesoFinFase: fila.pesoFinFase,
                objetivoPrincipal: fila.objetivoPrincipal,
                observaciones: fila.observaciones,
                semanaReevaluacion: fila.semanaReevaluacion
            }));
            // Es una pausa
            filasHTML += `
                <tr class="pausa">
                    <td>${fila.mesesTexto}</td>
                    <td>${fila.semanasAsignadas}</td>
                    <td class="text-center">${fila.semanaReevaluacion ? `${fila.semanaReevaluacion}¬™ sem` : 'N/A'}</td>
                    <td><strong>${fila.nombreFase}</strong> <span class="pause-badge">Pausa</span></td>
                    <td class="text-center">
                        <strong>${fila.proteinasPct}%</strong><br>
                        <small>${fila.proteinas_g_dia}g (${proteinas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.grasasPct}%</strong><br>
                        <small>${fila.grasas_g_dia}g (${grasas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.carbohidratosPct}%</strong><br>
                        <small>${fila.carbohidratos_g_dia}g (${carbohidratos_g_kg}g/kg)</small>
                    </td>
                    <td>${fila.objetivoPrincipal}</td>
                    <td class="small">${fila.observaciones}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary ver-detalles-fase-btn" 
                                data-fase-info="${datosFaseParaJS_pausa}"
                                onclick="verDetallesFase(this)">Ver Detalles Semanales</button>
                    </td>
                </tr>
            `;
        } else {
            // Es una fase normal
            const datosFaseParaJS = encodeURIComponent(JSON.stringify({
                nombreFase: fila.nombreFase,
                semanasAsignadas: fila.semanasAsignadas,
                mesesTexto: fila.mesesTexto,
                macrosBase: {
                    proteinasPct: fila.proteinasPct,
                    carbohidratosPct: fila.carbohidratosPct,
                    grasasPct: fila.grasasPct
                },
                proteinas_g_dia: fila.proteinas_g_dia,
                carbohidratos_g_dia: fila.carbohidratos_g_dia,
                grasas_g_dia: fila.grasas_g_dia,
                proteinas_g_kg: proteinas_g_kg,
                carbohidratos_g_kg: carbohidratos_g_kg,
                grasas_g_kg: grasas_g_kg,
                pesoInicioFase: fila.pesoInicioFase,
                pesoFinFase: fila.pesoFinFase,
                objetivoPrincipal: fila.objetivoPrincipal,
                observaciones: fila.observaciones,
                semanaReevaluacion: fila.semanaReevaluacion
            }));

            filasHTML += `
                <tr>
                    <td>${fila.mesesTexto}</td>
                    <td>${fila.semanasAsignadas}</td>
                    <td class="text-center">${fila.semanaReevaluacion ? `${fila.semanaReevaluacion}¬™ sem` : 'N/A'}</td>
                    <td><strong>${fila.nombreFase}</strong></td>
                    <td class="text-center">
                        <strong>${fila.proteinasPct}%</strong><br>
                        <small>${fila.proteinas_g_dia}g (${proteinas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.grasasPct}%</strong><br>
                        <small>${fila.grasas_g_dia}g (${grasas_g_kg}g/kg)</small>
                    </td>
                    <td class="text-center">
                        <strong>${fila.carbohidratosPct}%</strong><br>
                        <small>${fila.carbohidratos_g_dia}g (${carbohidratos_g_kg}g/kg)</small>
                    </td>
                    <td>${fila.objetivoPrincipal}</td>
                    <td class="small">${fila.observaciones}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary ver-detalles-fase-btn" 
                                data-fase-info="${datosFaseParaJS}"
                                onclick="verDetallesFase(this)">Ver Detalles Semanales</button>
                    </td>
                </tr>
            `;
        }
    });

    return filasHTML;
}











/* Genera los datos para la Tabla General del Proceso Nutricional,
* adaptando las fases seg√∫n el objetivo del usuario (p√©rdida, ganancia, mantenimiento, mixto).
* @returns {Object|null} Un objeto con fases, datosTabla, semanasTotales, pesoInicial, etc., o null si hay error.
*/
/**
 * Genera los datos para la Tabla General del Proceso Nutricional,
 * adaptando las fases seg√∫n el objetivo del usuario (p√©rdida, ganancia, mantenimiento, mixto).
 * @returns {Object|null} Un objeto con fases, datosTabla, semanasTotales, pesoInicial, etc., o null si hay error.
 */
function generarDatosTablaGeneral() {
    // --- 1. Recuperar datos desde DOM y variables globales ---
    const goalTypeGlobal = document.getElementById('objetivo')?.value || 'perdida1';
    const objetivoActual = goalTypeGlobal;
    const pesoActualUsuario = window.nonlinearProgressData_1?.objetivo?.pesoInicial || 0;
    const metaKg = window.nonlinearProgressData_1?.objetivo?.metaKg || 0;

    // ‚úÖ Ajustar el signo de cambioPesoTotal seg√∫n el objetivo
    const cambioPesoTotal = goalTypeGlobal === 'perdida1'
        ? -Math.abs(metaKg)
        : metaKg;

    const edad = userAge || 0;
    const genero = userGender || 'male';
    const proposito = document.getElementById('objetivoGeneral')?.value || 'estetico';
    const porcentajeGrasa = parseFloat(document.getElementById('current-fat-percentage')?.value) || null;
    const nivelActividad = userActivityLevel || 1.375;
    const nivelEntrenamiento = document.getElementById('is-athlete') || nivelActividad > 1.55 ? 'avanzado' : 'principiante';
    const semanasTotalesEstimadas_Nolineal = window.nonlinearProgressData_1?.tiempo?.semanasEstimadas;

    window.semanasTotalesEstimadas = semanasTotalesEstimadas_Nolineal;

    // --- 2. Validaci√≥n inicial mejorada ---
    const variables = {
        semanasTotalesEstimadas: window.nonlinearProgressData_1?.tiempo?.semanasEstimadas || 0,
        cambioPesoTotal,
        pesoActualUsuario,
        objetivoActual,
        porcentajeGrasa,
        genero,
        edad
    };

    let hayVariablesInvalidas = false;
    let variablesInvalidas = [];

    // Permite n√∫meros negativos, solo verifica que no sea NaN y que no sea null/undefined
    Object.entries(variables).forEach(([key, value]) => {
        if (value === null || value === undefined || (typeof value === 'number' && isNaN(value))) {
            hayVariablesInvalidas = true;
            variablesInvalidas.push(key);
        }
    });

    if (hayVariablesInvalidas) {
        console.warn("‚ö†Ô∏è No se puede generar la Tabla General. Variables con problemas:", variablesInvalidas);
        return null;
    }

    // Convertir a n√∫mero
    const semanas = parseFloat(variables.semanasTotalesEstimadas);
    const cambio = parseFloat(cambioPesoTotal);
    const peso = parseFloat(pesoActualUsuario);

    if (isNaN(semanas) || isNaN(cambio) || isNaN(peso) || isNaN(porcentajeGrasa) || porcentajeGrasa < 0 || porcentajeGrasa > 100) {
        console.warn("Valores no num√©ricos o inv√°lidos.");
        return null;
    }

    // --- 3. Diagn√≥stico de salud ---
    function determinarCondicionSalud() {
        const esHombre = genero === 'male';
        const umbralTipo1 = esHombre ? 27 : 26;
        const umbralTipo2 = esHombre ? 35 : 34;
        const umbralTipo3 = esHombre ? 36 : 35;

        let tipoObesidad = null;
        let condicion = '√≥ptima';

        if (porcentajeGrasa >= umbralTipo3) {
            tipoObesidad = 'tipo3';
            condicion = 'pobre';
        } else if (porcentajeGrasa >= umbralTipo2) {
            tipoObesidad = 'tipo2';
            condicion = 'pobre';
        } else if (porcentajeGrasa >= umbralTipo1) {
            tipoObesidad = 'tipo1';
            condicion = 'media';
        } else {
            tipoObesidad = 'normal';
            condicion = '√≥ptima';
        }

        if (edad > 60 && (tipoObesidad === 'tipo2' || tipoObesidad === 'tipo3')) {
            condicion = 'pobre';
        }
        if (nivelActividad < 1.375 && (tipoObesidad === 'tipo2' || tipoObesidad === 'tipo3')) {
            condicion = 'pobre';
        }
        if (objetivoActual === 'perdida1' && Math.abs(cambio) > 1.0 && semanas < 8) {
            condicion = 'pobre';
        }
        if (nivelEntrenamiento !== 'avanzado') {
            const umbralGrasaBaja = genero === 'female' ? 18 : 10;
            if (porcentajeGrasa < umbralGrasaBaja && peso < 50) {
                condicion = 'pobre';
            }
        }

        return { tipoObesidad, condicion };
    }

    const resultado = determinarCondicionSalud();
    const tipoObesidad = resultado.tipoObesidad;
    const condicionSalud = resultado.condicion;

    window.condicionSalud = condicionSalud;

    if (condicionSalud === 'pobre') {
        console.warn("üö® Condiciones de salud: 'pobre'. Se recomienda consulta m√©dica antes de continuar.");
        alert("‚ö†Ô∏è Se detectaron condiciones de salud de alto riesgo. Se recomienda consultar a un profesional antes de generar el plan.");

    }

    // --- 4. Inicializar objetos globales (CRUCIAL) ---
    window.planConfig = window.planConfig || {};
    window.pausas = window.pausas || {};

    // --- 5. Definir plantillas de fases ---
    const plantillasFases = {
        ganancia1: [
            { id: 'evaluacion_base', nombre: "Fase 1: Evaluaci√≥n y Base", duracionPredeterminadaSemanas: 4, objetivoPrincipal: "Evaluar estado inicial, establecer h√°bitos, preparar el cuerpo" },
            { id: 'volumen_progresivo', nombre: "Fase 2: Volumen Progresivo", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Maximizar hipertrofia con super√°vit controlado" },
            { id: 'mantenimiento_reajuste', nombre: "Fase 3: Mantenimiento y Reajuste", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Consolidar ganancias, prevenir exceso de grasa" },
            { id: 'optimizacion_avanzada', nombre: "Fase 4: Optimizaci√≥n y Volumen Avanzado", duracionPredeterminadaSemanas: 16, objetivoPrincipal: "Afinar hipertrofia en atletas intermedios/avanzados" }
        ],
        perdida1: [
            { id: 'induccion_cetogenica', nombre: "Fase 1: Inducci√≥n Perdida Peso", duracionPredeterminadaSemanas: 6, objetivoPrincipal: "Reset metab√≥lico, inicio de p√©rdida de grasa, reducci√≥n de insulina" },
            { id: 'ciclado_metabolico', nombre: "Fase 2: Ciclado Metab√≥lico", duracionPredeterminadaSemanas: 10, objetivoPrincipal: "Continuar p√©rdida de peso, mantener rendimiento f√≠sico, evitar estancamiento" },
            { id: 'transicion_mantenimiento', nombre: "Fase 3: Transici√≥n a Mantenimiento", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Mantener peso perdido, favorecer adherencia social y equilibrio nutricional" }
        ],
        mantenimiento1: [
            { id: 'transicion_mantenimiento', nombre: "Subfase 1: Transici√≥n al Mantenimiento", duracionPredeterminadaSemanas: 3, objetivoPrincipal: "Estabilizar peso corporal tras volumen o definici√≥n" },
            { id: 'mantenimiento_estable', nombre: "Subfase 2: Mantenimiento Estable", duracionPredeterminadaSemanas: 6, objetivoPrincipal: "Preservar masa muscular y optimizar rendimiento" },
            { id: 'reevaluacion_preparacion', nombre: "Subfase 3: Reevaluaci√≥n y Preparaci√≥n", duracionPredeterminadaSemanas: 3, objetivoPrincipal: "Evaluar progreso y preparar pr√≥ximo ciclo (volumen o definici√≥n)" }
        ],
        mixto1: [
            { id: 'volumen_controlado', nombre: "Fase 1: Volumen Controlado", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Ganancia muscular con m√≠nimo aumento de grasa" },
            { id: 'definicion_controlada', nombre: "Fase 2: Definici√≥n Controlada", duracionPredeterminadaSemanas: 8, objetivoPrincipal: "Reducir grasa corporal con preservaci√≥n muscular √≥ptima" },
            { id: 'mantenimiento_metabolico', nombre: "Fase 3: Mantenimiento Metab√≥lico", duracionPredeterminadaSemanas: 6, objetivoPrincipal: "Estabilizar metabolismo, mejorar adherencia y prevenir rebote" },
            { id: 'ajuste_metabolico', nombre: "Fase 4: Ajuste Metab√≥lico", duracionPredeterminadaSemanas: 4, objetivoPrincipal: "Recuperaci√≥n adaptativa, mejora de sensibilidad hormonal y sostenibilidad a largo plazo" }
        ]
    };

    // --- 6. Configurar par√°metros por objetivo ---
    let fasesParaPlan = [];
    let ratios = [];
    let minSemanasPorFase = [];
    let maxSemanasPorFase = [];
    let caloriasAjustadasBase = 0;
    let semanasPausaPorCiclo = 1;
    let cicloFase2 = 8;
    let cicloFase4 = 8;

    // Inicializar pausas para este objetivo (si no existe)
    window.pausas[objetivoActual] = window.pausas[objetivoActual] || {};
    window.pausas[objetivoActual].semanasPausaFase2 = 0;
    window.pausas[objetivoActual].semanasPausaFase4 = 0;

    // --- 7. L√≥gica espec√≠fica por objetivo ---
    if (objetivoActual === 'mantenimiento1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas < 24;
        const isLarga = semanas >= 24;

        ratios = isCorta ? [1, 2] : isMedia ? [1, 3, 2] : [1, 3, 2, 1];
        minSemanasPorFase = [4, 6, 4, 4];
        maxSemanasPorFase = [6, 16, 24, 12];

        fasesParaPlan = isCorta ? plantillasFases.mantenimiento1.slice(0, 2) :
            isMedia ? plantillasFases.mantenimiento1.slice(0, 3) :
                plantillasFases.mantenimiento1;

        caloriasAjustadasBase = 0;

        cicloFase2 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        cicloFase4 = proposito === 'estetico' ? 12 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : (proposito === 'salud' ? 0 : 1);

    } else if (objetivoActual === 'ganancia1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas < 24;
        const isLarga = semanas >= 24;

        ratios = isCorta ? [1, 2] : isMedia ? [proposito === 'rendimiento' ? 2 : 1, 4, 2] : [proposito === 'rendimiento' ? 2 : 1, 4, 2, 2];
        minSemanasPorFase = [edad > 60 ? 6 : 4, 6, 4, 6];
        maxSemanasPorFase = [edad > 60 ? 8 : 6, 20, 12, 12];

        fasesParaPlan = isCorta ? plantillasFases.ganancia1.slice(0, 2) :
            isMedia ? plantillasFases.ganancia1.slice(0, 3) :
                plantillasFases.ganancia1;

        caloriasAjustadasBase = proposito === 'salud' ? 0.05 : proposito === 'estetico' ? 0.10 : 0.15;

        cicloFase2 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        cicloFase4 = proposito === 'estetico' ? 12 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : (proposito === 'salud' ? 0 : 1);



    } else if (objetivoActual === 'perdida1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas < 24;
        const isLarga = semanas >= 24;

        ratios = isCorta ? [1, 2] : isMedia ? [proposito === 'rendimiento' ? 2 : 1, 4, 2] : [proposito === 'rendimiento' ? 2 : 1, 4, 2, 1];
        minSemanasPorFase = [4, 6, 4, 4];
        maxSemanasPorFase = [6, 16, 12, 12];

        fasesParaPlan = isCorta ? plantillasFases.perdida1.slice(0, 2) :
            isMedia ? plantillasFases.perdida1.slice(0, 3) :
                plantillasFases.perdida1;

        caloriasAjustadasBase = proposito === 'salud' ? -0.05 : proposito === 'estetico' ? -0.10 : -0.15;

        cicloFase2 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        cicloFase4 = proposito === 'estetico' ? 12 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : (proposito === 'salud' ? 0 : 1);



    } else if (objetivoActual === 'mixto1') {
        const isCorta = semanas < 12;
        const isMedia = semanas >= 12 && semanas <= 36;
        const isLarga = semanas > 36;

        const genderMap = { 'male': 'HOMBRE', 'female': 'MUJER' };
        const generoUppercase = genderMap[genero.toLowerCase()] || 'HOMBRE';

        const RANGOS_MASA_MUSCULAR = {
            HOMBRE: {
                '18-25': { min: 38, max: 54, optimo: 46 },
                '26-35': { min: 36, max: 52, optimo: 44 },
                '36-45': { min: 34, max: 50, optimo: 42 },
                '46-55': { min: 32, max: 48, optimo: 40 },
                '56-65': { min: 30, max: 46, optimo: 38 },
                '65+': { min: 28, max: 44, optimo: 36 }
            },
            MUJER: {
                '18-25': { min: 28, max: 42, optimo: 35 },
                '26-35': { min: 26, max: 40, optimo: 33 },
                '36-45': { min: 24, max: 38, optimo: 31 },
                '46-55': { min: 22, max: 36, optimo: 29 },
                '56-65': { min: 20, max: 34, optimo: 27 },
                '65+': { min: 18, max: 32, optimo: 25 }
            }
        };

        const rangoEdad = edad >= 18 && edad <= 25 ? '18-25' :
            edad >= 26 && edad <= 35 ? '26-35' :
                edad >= 36 && edad <= 45 ? '36-45' :
                    edad >= 46 && edad <= 55 ? '46-55' :
                        edad >= 56 && edad <= 65 ? '56-65' : '65+';

        const rangos = RANGOS_MASA_MUSCULAR[generoUppercase]?.[rangoEdad];
        if (!rangos) throw new Error('Rango de masa muscular no encontrado');

        const factorActividad = {
            1.2: 0.8, 1.375: 0.9, 1.55: 1.0, 1.75: 1.1, 1.9: 1.2
        }[nivelActividad] || 1.0;

        let porcentajeMasaMuscularObjetivo = 0;
        const porcentajeMasaMuscularActual = parseFloat(document.getElementById('target-muscle-percentage')?.value) || 0;

        if (porcentajeMasaMuscularActual) {
            porcentajeMasaMuscularObjetivo = Math.min(
                porcentajeMasaMuscularActual + (rangos.optimo - porcentajeMasaMuscularActual) * 0.6 * factorActividad,
                rangos.max
            );
        } else {
            porcentajeMasaMuscularObjetivo = rangos.optimo * factorActividad;
        }

        porcentajeMasaMuscularObjetivo = Math.max(
            Math.min(Math.round(porcentajeMasaMuscularObjetivo * 10) / 10, rangos.max),
            rangos.min
        );

        let gananciaMuscularObjetivoKg = parseFloat(document.getElementById('desired-lean-mass-gain')?.value) || 0;
        if (!gananciaMuscularObjetivoKg) {
            gananciaMuscularObjetivoKg = (porcentajeMasaMuscularObjetivo / 100 * (peso + (porcentajeMasaMuscularObjetivo - porcentajeMasaMuscularActual) / 100 * peso) - porcentajeMasaMuscularActual / 100 * peso);
        }

        const semanasPorKgMusculo = 12;
        const semanasPorReduccionGrasa = 10;
        const tiempoMusculo = gananciaMuscularObjetivoKg > 0 ? gananciaMuscularObjetivoKg * semanasPorKgMusculo : 0;
        const grasaAEliminarKg = peso * (porcentajeGrasa / 100 - (document.getElementById('target-fat-percentage')?.value || 0) / 100);
        const tiempoGrasa = grasaAEliminarKg > 0 ? Math.ceil(grasaAEliminarKg / (peso * 0.005)) : 0;

        let semanasTotalEstimadas = Math.max(tiempoMusculo, tiempoGrasa) + 12;

        const ratiosBase = isCorta ? [1, 2] : isMedia ? [2, 3, 2] : [2, 3, 2, 2];
        const proporcionTotal = ratiosBase.reduce((a, b) => a + b, 0);
        let ratioVolumen = ratiosBase[0];
        let ratioDefinicion = ratiosBase[1];

        if (gananciaMuscularObjetivoKg > grasaAEliminarKg) ratioVolumen += 1;
        else if (grasaAEliminarKg > gananciaMuscularObjetivoKg) ratioDefinicion += 1;

        ratios = isCorta ? [1, 2] : isMedia ? [ratioVolumen, ratioDefinicion, 2] : [ratioVolumen, ratioDefinicion, 2, 2];
        const nuevaProporcionTotal = ratios.reduce((a, b) => a + b, 0);

        minSemanasPorFase = [
            edad > 60 && proposito === 'salud' ? 6 : 4,
            edad > 60 && proposito === 'salud' ? 8 : 6,
            edad > 60 && proposito === 'salud' ? 6 : 4,
            edad > 60 && proposito === 'salud' ? 6 : 4
        ];
        maxSemanasPorFase = [
            edad > 60 && proposito === 'salud' ? 10 : 8,
            edad > 60 && proposito === 'salud' ? 20 : 16,
            edad > 60 && proposito === 'salud' ? 16 : 12,
            edad > 60 && proposito === 'salud' ? 16 : 12
        ];

        fasesParaPlan = isCorta ? plantillasFases.mixto1.slice(0, 2) :
            isMedia ? plantillasFases.mixto1.slice(0, 3) :
                plantillasFases.mixto1;

        caloriasAjustadasBase = 0;

        cicloFase2 = proposito === 'estetico' ? 6 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 8;
        cicloFase4 = proposito === 'estetico' ? 8 : proposito === 'rendimiento' ? 6 : (proposito === 'salud' && edad > 60) ? 0 : 12;
        semanasPausaPorCiclo = (proposito === 'salud' && edad > 60) ? 0 : 1;
        if (proposito === 'salud' && edad > 60) {
            semanasPausaPorCiclo = 0;
        } else if (isCorta) {
            semanasPausaPorCiclo = 0;
        } else {
            semanasPausaPorCiclo = 1;
        }

        // Calcular pausas una sola vez
        const semanasFase2Estimadas = Math.round((ratios[1] / nuevaProporcionTotal) * semanasTotalEstimadas);
        window.pausas[objetivoActual].semanasPausaFase2 = cicloFase2 > 0 ? Math.floor(semanasFase2Estimadas / cicloFase2) * semanasPausaPorCiclo : 0;

        if (isLarga && ratios[3]) {
            const semanasFase4Estimadas = Math.round((ratios[3] / nuevaProporcionTotal) * semanasTotalEstimadas);
            if (semanasFase4Estimadas >= cicloFase4) {
                window.pausas[objetivoActual].semanasPausaFase4 = Math.floor(semanasFase4Estimadas / cicloFase4) * semanasPausaPorCiclo;
            }
        }

        const semanasTotalesEstimadas = Math.round(semanasTotalEstimadas);

        let semTotales;


    }

    if (semanasTotalesEstimadas_Nolineal > semanasTotalesEstimadas) {
        semTotales = semanasTotalesEstimadas_Nolineal;
    } else {
        semTotales = semanasTotalesEstimadas;
    }
    window.semanasTotalesEstimadas = semTotales;


    // --- 8. Calcular pausas para todas las fases ---
    const proporcionTotal = ratios.reduce((a, b) => a + b, 0);
    const datosTabla = [];
    let semanasAsignadasAcumuladas = 0;
    let pesoAcumulado = peso;
    const numeroFases = fasesParaPlan.length;

    if (numeroFases === 0) {
        console.error("No hay fases definidas para el objetivo seleccionado.");
        return null;
    }

    const fasesCalculadas = [];

    // --- 9. Bucle principal: forEach sobre fases ---
    // --- 9. Bucle principal: forEach sobre fases ---
    fasesParaPlan.forEach((fase, index) => {
        // Si ya hemos alcanzado el l√≠mite de semanas, no procesar m√°s fases
        if (semanasAsignadasAcumuladas >= semanasTotalesEstimadas) {
            return;
        }

        let semanasParaEstaFase;
        const factorProporcion = ratios[index] || 1;
        const proporcion = factorProporcion / proporcionTotal;

        const semanasDisponibles = semanasTotalesEstimadas -
            (window.pausas[objetivoActual]?.semanasPausaFase2 || 0) -
            (index === 3 ? (window.pausas[objetivoActual]?.semanasPausaFase4 || 0) : 0);

        semanasParaEstaFase = Math.round(proporcion * semanasDisponibles);

        if (index === numeroFases - 1) {
            semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas -
                (window.pausas[objetivoActual]?.semanasPausaFase2 || 0) -
                (window.pausas[objetivoActual]?.semanasPausaFase4 || 0);
            semanasParaEstaFase = Math.max(0, semanasParaEstaFase);
        }

        // Asegurar que no excedamos el total de semanas
        if (semanasAsignadasAcumuladas + semanasParaEstaFase > semanasTotalesEstimadas) {
            semanasParaEstaFase = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
        }

        // Si no hay semanas disponibles, salir
        if (semanasParaEstaFase <= 0) {
            return;
        }

        // --- 10. Pausas metab√≥licas dentro de la fase ---
        let numeroPausas = 0;

        // ‚úÖ Calcular n√∫mero de pausas
        if (semanasParaEstaFase >= 8) {
            numeroPausas = 1; // Primera pausa en semana 8
            if (semanasParaEstaFase > 8) {
                numeroPausas += Math.floor((semanasParaEstaFase - 8) / 6); // Pausa cada 6 semanas
            }
        } else if (semanasParaEstaFase >= cicloFase2 && semanasPausaPorCiclo > 0) {
            numeroPausas = Math.floor(semanasParaEstaFase / cicloFase2);
        }

        // Ajustar el n√∫mero de pausas si excede las semanas disponibles
        const semanasPausaTotal = numeroPausas;
        if (semanasAsignadasAcumuladas + semanasParaEstaFase + semanasPausaTotal > semanasTotalesEstimadas) {
            numeroPausas = Math.max(0, semanasTotalesEstimadas - semanasAsignadasAcumuladas - semanasParaEstaFase);
        }

        // --- Nuevo enfoque: generar array de bloques (fase y pausas) ---
        let blocks = [];
        let currentWeek = 1;
        const firstBlockLength = 7;
        const nextBlockLength = 6;

        if (numeroPausas > 0) {
            // Primer bloque de fase
            let blockLength = Math.min(firstBlockLength, semanasParaEstaFase);
            blocks.push({ type: 'phase', start: currentWeek, end: currentWeek + blockLength - 1 });
            currentWeek += blockLength;

            for (let p = 0; p < numeroPausas; p++) {
                if (currentWeek > semanasParaEstaFase || semanasAsignadasAcumuladas + currentWeek > semanasTotalesEstimadas) {
                    break;
                }

                // Agregar pausa
                blocks.push({ type: 'pause', start: currentWeek, end: currentWeek });
                currentWeek += 1;

                if (currentWeek > semanasParaEstaFase || semanasAsignadasAcumuladas + currentWeek > semanasTotalesEstimadas) {
                    break;
                }

                // Agregar siguiente bloque de fase
                blockLength = Math.min(nextBlockLength, semanasParaEstaFase - currentWeek + 1);
                // Ajustar si excede el total de semanas
                if (semanasAsignadasAcumuladas + currentWeek + blockLength - 1 > semanasTotalesEstimadas) {
                    blockLength = semanasTotalesEstimadas - semanasAsignadasAcumuladas - currentWeek + 1;
                }

                blocks.push({ type: 'phase', start: currentWeek, end: currentWeek + blockLength - 1 });
                currentWeek += blockLength;
            }
        } else {
            // Sin pausas
            let blockLength = semanasParaEstaFase;
            // Ajustar si excede el total de semanas
            if (semanasAsignadasAcumuladas + blockLength > semanasTotalesEstimadas) {
                blockLength = semanasTotalesEstimadas - semanasAsignadasAcumuladas;
            }
            blocks.push({ type: 'phase', start: 1, end: blockLength });
        }

        // --- 11. Generar la fase con pausas integradas usando blocks array ---
        let pauseIndex = 0;

        // ‚úÖ CALCULO CORREGIDO: Guardar el acumulado inicial de esta fase
        const semanasAcumuladasInicioFase = semanasAsignadasAcumuladas;

        blocks.forEach(block => {
            // Verificar si hemos alcanzado el l√≠mite de semanas
            if (semanasAsignadasAcumuladas >= semanasTotalesEstimadas) {
                return;
            }

            const semanasEnEsteBloque = block.end - block.start + 1;

            // ‚úÖ Calcular cambio de peso para este bloque
            const cambioPesoEnEstaFase = cambioPesoTotal * (semanasEnEsteBloque / semanasTotalesEstimadas);

            // ‚úÖ CALCULO CORREGIDO: Calcular semana global de inicio y fin
            // Usar el acumulado actual para el inicio del bloque
            const semanaGlobalInicio = semanasAsignadasAcumuladas + 1;
            const semanaGlobalFin = semanasAsignadasAcumuladas + semanasEnEsteBloque;

            // ‚úÖ CALCULO CORREGIDO: Calcular meses correctamente
            const calcularMesDesdeSemana = (semanaGlobal) => {
                return Math.floor((semanaGlobal - 1) / 4) + 1;
            };

            const mesInicio = calcularMesDesdeSemana(semanaGlobalInicio);
            const mesFin = calcularMesDesdeSemana(semanaGlobalFin);

            // ‚úÖ FORMATO CORREGIDO: Asegurar que los meses se muestren correctamente
            let mesesTexto = "";
            if (block.type === 'pause') {
                mesesTexto = "Pausa";
            } else {
                if (mesInicio === mesFin) {
                    mesesTexto = `${mesInicio}`;
                } else {
                    mesesTexto = `${mesInicio}‚Äì${mesFin}`;
                }
            }

            // ‚úÖ CALCULO CORREGIDO: Asegurar que la semana de reevaluaci√≥n sea correcta
            const semanaReevaluacion = semanaGlobalInicio;

            if (block.type === 'pause') {
                pauseIndex++;
                // Bloque de pausa
                const nombrePausa = `Pausa Metab√≥lica (tras ${fase.nombre}, Ciclo ${pauseIndex})`;

                // ‚úÖ Insertar pausa como fila dentro de la fase
                datosTabla.push({
                    mesesTexto: mesesTexto,
                    nombreFase: nombrePausa,
                    proteinasPct: 25,
                    carbohidratosPct: 40,
                    grasasPct: 35,
                    proteinas_g_dia: Math.round(1.8 * pesoAcumulado),
                    carbohidratos_g_dia: Math.round(4.0 * pesoAcumulado),
                    grasas_g_dia: Math.round(1.0 * pesoAcumulado),
                    proteinas_g_kg: 1.8,
                    carbohidratos_g_kg: 4.0,
                    grasas_g_kg: 1.0,
                    pesoInicioFase: pesoAcumulado,
                    pesoFinFase: pesoAcumulado,
                    objetivoPrincipal: "Recuperaci√≥n metab√≥lica y descanso",
                    observaciones: "Mantener calor√≠as al nivel de GET. Reducir intensidad de entrenamiento. Priorizar recuperaci√≥n y sue√±o.",
                    semanasAsignadas: 1,
                    semanasPausa: 0,
                    semanaReevaluacion: semanaReevaluacion,
                    mes: mesInicio,
                    semanaEnMes: ((semanaGlobalInicio - 1) % 4) + 1
                });

                // ‚úÖ Guardar datos de pausa en window.planConfig
                window.planConfig[nombrePausa] = {
                    semanasPausa: 0,
                    ratios: ratios,
                    numeroFases: numeroFases,
                    semanasTotales: semanasTotalesEstimadas
                };

                // Actualizar estado acumulado para la pausa (1 semana)
                semanasAsignadasAcumuladas += 1;
            } else {
                // Bloque de fase normal
                const nombreFase = fase.nombre;

                // --- Validar pesoAcumulado ---
                if (isNaN(pesoAcumulado) || pesoAcumulado === null || pesoAcumulado === undefined) {
                    console.error("Peso acumulado inv√°lido:", pesoAcumulado);
                    pesoAcumulado = 0; // Valor por defecto
                }

                const pesoFase = pesoAcumulado;

                // --- 13. Macros y observaciones ---
                // ... (todo el c√≥digo de macros y observaciones se mantiene igual) ...
                // --- 13. Macros y observaciones ---
                let caloriasAjustadas = caloriasAjustadasBase;
                let proteinasPct = 25;
                let proteinas_g_kg = 2.0;
                let carbohidratosPct = 40;
                let carbohidratos_g_kg = 4.0;
                let grasasPct = 35;
                let grasas_g_kg = 0.8;
                let observacionesNutricionales = fase.nombre;

                if (objetivoActual === 'mantenimiento1') {
                    if (index === 0) {
                        caloriasAjustadas = 0;
                        proteinasPct = 20;
                        proteinas_g_kg = 1.8;
                        carbohidratosPct = 50;
                        carbohidratos_g_kg = 5.0;
                        grasasPct = 30;
                        grasas_g_kg = 0.6;
                        observacionesNutricionales += " Transici√≥n: estabilizar peso post-ciclo. Timing: 20-40g prote√≠na post-entreno.";
                    } else if (index === 1) {
                        caloriasAjustadas = 0;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.0;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Mantenimiento estable: mantener masa muscular.";
                    } else if (index === 2) {
                        caloriasAjustadas = 0;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.0;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Reevaluaci√≥n: preparar pr√≥ximo ciclo.";
                    }
                } else if (objetivoActual === 'ganancia1') {
                    if (index === 0) {
                        caloriasAjustadas = 0.15;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.2;
                        carbohidratosPct = 45;
                        carbohidratos_g_kg = 4.0;
                        grasasPct = 30;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Volumen: ganancia controlada.";
                    } else if (index === 1) {
                        caloriasAjustadas = 0.10;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.4;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Hipertrofia avanzada.";
                    } else if (index === 2) {
                        caloriasAjustadas = 0.05;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.4;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Consolidaci√≥n de ganancias.";
                    } else if (index === 3) {
                        caloriasAjustadas = 0.05;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.4;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Optimizaci√≥n avanzada.";
                    }
                } else if (objetivoActual === 'perdida1') {
                    if (index === 0) {
                        caloriasAjustadas = -0.15;
                        proteinasPct = 30;
                        proteinas_g_kg = 2.6;
                        carbohidratosPct = 30;
                        carbohidratos_g_kg = 2.5;
                        grasasPct = 40;
                        grasas_g_kg = 1.0;
                        observacionesNutricionales += " Reset metab√≥lico.";
                    } else if (index === 1) {
                        caloriasAjustadas = -0.10;
                        proteinasPct = 30;
                        proteinas_g_kg = 2.6;
                        carbohidratosPct = 35;
                        carbohidratos_g_kg = 3.0;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Continuar p√©rdida de grasa.";
                    } else if (index === 2) {
                        caloriasAjustadas = -0.05;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.2;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Transici√≥n a mantenimiento.";
                    }
                } else if (objetivoActual === 'mixto1') {
                    if (index === 0) {
                        caloriasAjustadas = 0.10;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.6;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 4.0;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Ganancia muscular con m√≠nimo aumento de grasa.";
                    } else if (index === 1) {
                        caloriasAjustadas = -0.05;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.6;
                        carbohidratosPct = 45;
                        carbohidratos_g_kg = 4.0;
                        grasasPct = 30;
                        grasas_g_kg = 0.6;
                        observacionesNutricionales += " Reducir grasa corporal con preservaci√≥n muscular √≥ptima.";
                    } else if (index === 2) {
                        caloriasAjustadas = 0;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.4;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Estabilizar metabolismo.";
                    } else if (index === 3) {
                        caloriasAjustadas = 0.05;
                        proteinasPct = 25;
                        proteinas_g_kg = 2.4;
                        carbohidratosPct = 40;
                        carbohidratos_g_kg = 3.5;
                        grasasPct = 35;
                        grasas_g_kg = 0.8;
                        observacionesNutricionales += " Recuperaci√≥n adaptativa.";
                    }
                }

                // --- 13. Calcular valores base ---
                let proteinas_g_dia = Math.round(proteinas_g_kg * pesoFase);
                let carbohidratos_g_dia = Math.round(carbohidratos_g_kg * pesoFase);
                let grasas_g_dia = Math.round(grasas_g_kg * pesoFase);

                // --- 14. Calcular g/kg ---
                let proteinas_g_kg_actual = Math.round(proteinas_g_dia / pesoFase * 10) / 10;
                let carbohidratos_g_kg_actual = Math.round(carbohidratos_g_dia / pesoFase * 10) / 10;
                let grasas_g_kg_actual = Math.round(grasas_g_dia / pesoFase * 10) / 10;

                // Ajustar valores extremos
                if (proteinas_g_kg < 1.5) proteinas_g_kg = 1.5;
                if (carbohidratos_g_kg < 2.0) carbohidratos_g_kg = 2.0;
                if (grasas_g_kg < 0.5) grasas_g_kg = 0.5;

                // Ajustar % para sumar 100
                const totalPct = proteinasPct + carbohidratosPct + grasasPct;
                if (totalPct !== 100) {
                    const factor = 100 / totalPct;
                    proteinasPct = parseFloat((proteinasPct * factor).toFixed(1));
                    carbohidratosPct = parseFloat((carbohidratosPct * factor).toFixed(1));
                    grasasPct = parseFloat((100 - proteinasPct - carbohidratosPct).toFixed(1));
                }

                // Observaciones personalizadas
                let observacionesPersonalizadas = "";
                if (objetivoActual === 'mantenimiento1') {
                    observacionesPersonalizadas = "Calor√≠as: 0% super√°vit (igual al GET). Flexibilidad selectiva (80/20).";
                    if (index === 0) observacionesPersonalizadas += " Transici√≥n: estabilizar peso post-ciclo. Timing: 20-40g prote√≠na post-entreno.";
                    else if (index === 1) observacionesPersonalizadas += " Mantenimiento estable: mantener masa muscular.";
                    else if (index === 2) observacionesPersonalizadas += " Reevaluaci√≥n: preparar pr√≥ximo ciclo.";
                } else if (objetivoActual === 'ganancia1') {
                    observacionesPersonalizadas = "Calor√≠as: +5-10% sobre GET. Volumen: ganancia controlada.";
                    if (index === 0) observacionesPersonalizadas += " Estrategia: Volumen controlado.";
                    else if (index === 1) observacionesPersonalizadas += " Estrategia: Hipertrofia avanzada.";
                    else if (index === 2) observacionesPersonalizadas += " Estrategia: Consolidaci√≥n.";
                    else if (index === 3) observacionesPersonalizadas += " Estrategia: Optimizaci√≥n avanzada.";
                } else if (objetivoActual === 'perdida1') {
                    observacionesPersonalizadas = "Calor√≠as: 0-5% bajo GET. Definici√≥n: reducir grasa.";
                    if (index === 0) observacionesPersonalizadas += " Estrategia: Reset metab√≥lico.";
                    else if (index === 1) observacionesPersonalizadas += " Estrategia: Ciclado metab√≥lico.";
                    else if (index === 2) observacionesPersonalizadas += " Estrategia: Transici√≥n a mantenimiento.";
                } else if (objetivoActual === 'mixto1') {
                    observacionesPersonalizadas = "Calor√≠as: ";
                    if (index === 0) observacionesPersonalizadas += "+5-10% sobre GET. Volumen: ganancia controlada.";
                    else if (index === 1) observacionesPersonalizadas += "0-5% bajo GET. Definici√≥n: reducir grasa.";
                    else if (index === 2) observacionesPersonalizadas += "0% (GET). Mantenimiento: equilibrio metab√≥lico.";
                    else if (index === 3) observacionesPersonalizadas += "0-5% (GET). Ajuste: recuperaci√≥n adaptativa.";
                }

                if (nivelEntrenamiento === 'principiante') {
                    if (index === 0) {
                        proteinasPct = Math.min(proteinasPct + 5, 35);
                        carbohidratosPct = Math.max(carbohidratosPct - 5, 20);
                        grasasPct = 100 - proteinasPct - carbohidratosPct;
                    }
                }

                if (nivelActividad < 1.375) {
                    grasasPct = Math.min(grasasPct + 10, 50);
                    carbohidratosPct = Math.max(carbohidratosPct - 10, 10);
                    proteinasPct = 100 - grasasPct - carbohidratosPct;
                }

                if (edad > 60) {
                    proteinasPct = Math.min(proteinasPct + 5, 35);
                    grasasPct = Math.max(grasasPct - 5, 10);
                    carbohidratosPct = 100 - proteinasPct - grasasPct;
                }

                if (genero === 'female' && edad > 50) {
                    proteinasPct = Math.min(proteinasPct + 5, 35);
                    carbohidratosPct = Math.max(carbohidratosPct - 5, 10);
                    grasasPct = 100 - proteinasPct - carbohidratosPct;
                }

                if (porcentajeGrasa > (genero === 'female' ? 30 : 25)) {
                    carbohidratosPct = Math.max(carbohidratosPct - 10, 10);
                    grasasPct = Math.min(grasasPct + 10, 50);
                    proteinasPct = 100 - carbohidratosPct - grasasPct;
                }

                if (porcentajeGrasa < (genero === 'female' ? 18 : 10)) {
                    carbohidratosPct = Math.min(carbohidratosPct + 10, 60);
                    grasasPct = Math.max(grasasPct - 10, 10);
                    proteinasPct = 100 - carbohidratosPct - grasasPct;
                }

                if (numeroPausas > 0) {
                    observacionesPersonalizadas += ` Incluye ${numeroPausas} pausas metab√≥licas de 1 semana cada una para recuperaci√≥n metab√≥lica.`;
                }

                if (proposito === 'estetico') {
                    observacionesPersonalizadas += " Enfoque en definici√≥n muscular.";
                } else if (proposito === 'rendimiento') {
                    observacionesPersonalizadas += " Optimizaci√≥n de fuerza y rendimiento.";
                } else if (proposito === 'salud') {
                    observacionesPersonalizadas += " Mejora de salud y funcionalidad.";
                }

                if (edad > 60) {
                    observacionesPersonalizadas += " Prote√≠nas altas para prevenir sarcopenia.";
                }

                if (genero === 'female' && edad > 50) {
                    observacionesPersonalizadas += " Mayor √©nfasis en prote√≠nas para posmenop√°usicas.";
                }

                let observaciones = observacionesPersonalizadas + " " + observacionesNutricionales;
                // --- Finalizar fase ---
                const pesoInicioFaseCalculado = parseFloat(pesoAcumulado.toFixed(2));
                const pesoFinFaseCalculado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));

                // Agregar a fasesCalculadas
                fasesCalculadas.push({
                    id: fase.id,
                    nombre: fase.nombre,
                    duracionPredeterminadaSemanas: semanasParaEstaFase,
                    mesesTexto: mesesTexto,
                    macrosBase: {
                        proteinasPct: proteinasPct,
                        carbohidratosPct: carbohidratosPct,
                        grasasPct: grasasPct,
                        proteinas_g_dia: Math.round(proteinas_g_kg * pesoFase),
                        carbohidratos_g_dia: Math.round(carbohidratos_g_kg * pesoFase),
                        grasas_g_dia: Math.round(grasas_g_kg * pesoFase),
                        proteinas_g_kg: Math.round(proteinas_g_dia / pesoFase * 10) / 10,
                        carbohidratos_g_kg: Math.round(carbohidratos_g_dia / pesoFase * 10) / 10,
                        grasas_g_kg: Math.round(grasas_g_dia / pesoFase * 10) / 10
                    },
                    objetivoPrincipal: fase.objetivoPrincipal,
                    observaciones: observacionesNutricionales,
                    semanaReevaluacion: semanaReevaluacion
                });

                window.planConfig[fase.nombre] = {
                    semanasPausa: 0,
                    ratios: ratios,
                    numeroFases: numeroFases,
                    semanasTotales: semanasTotalesEstimadas
                };

                datosTabla.push({
                    mesesTexto: mesesTexto,
                    nombreFase: nombreFase,
                    proteinasPct: proteinasPct,
                    proteinas_g_dia: Math.round(proteinas_g_kg * pesoFase),
                    proteinas_g_kg: Math.round(proteinas_g_dia / pesoFase * 10) / 10,
                    carbohidratosPct: carbohidratosPct,
                    carbohidratos_g_dia: Math.round(carbohidratos_g_kg * pesoFase),
                    carbohidratos_g_kg: Math.round(carbohidratos_g_dia / pesoFase * 10) / 10,
                    grasasPct: grasasPct,
                    grasas_g_dia: Math.round(grasas_g_kg * pesoFase),
                    grasas_g_kg: Math.round(grasas_g_dia / pesoFase * 10) / 10,
                    pesoInicioFase: pesoInicioFaseCalculado,
                    pesoFinFase: pesoFinFaseCalculado,
                    objetivoPrincipal: fase.objetivoPrincipal,
                    observaciones: observacionesNutricionales,
                    semanasAsignadas: semanasEnEsteBloque,
                    semanasPausa: 0,
                    semanaReevaluacion: semanaReevaluacion
                });

                // Actualizar estado acumulado para el bloque de fase
                pesoAcumulado = parseFloat((pesoAcumulado + cambioPesoEnEstaFase).toFixed(2));
                semanasAsignadasAcumuladas += semanasEnEsteBloque;
            }
        });
    }); // <- Cierre del forEach

    // --- 16. Retornar resultados ---
    return {
        fases: fasesCalculadas,
        datosTabla,
        semanasTotales: Math.min(semanasAsignadasAcumuladas, semanasTotalesEstimadas), // No exceder el l√≠mite
        pesoInicial: peso,
        objetivoActual,
        proposito,
        tipoObesidad,
        condicionSalud
    };
}

/**
 * Se ejecuta cuando el usuario hace clic en "Ver Detalles Semanales" en la Tabla General.
 * @param {HTMLElement} boton - El bot√≥n que fue clickeado.
 */
function verDetallesFase(boton) {
    // Obtener los datos de la fase del atributo data-fase-info
    const datosFaseEncoded = boton.getAttribute('data-fase-info');
    if (!datosFaseEncoded) {
        console.error("No se encontraron datos de fase en el bot√≥n.");
        return;
    }

    let datosFase;
    try {
        datosFase = JSON.parse(decodeURIComponent(datosFaseEncoded));
    } catch (e) {
        console.error("Error al parsear datos de fase:", e);
        return;
    }

    console.log("Fase seleccionada para detalles:", datosFase);

    // --- Llamar a la funci√≥n que generar√° y mostrar√° la tabla detallada ---
    // Pasamos los datos de la fase y el ID del contenedor donde se mostrar√°
    generarYMostrarTablaDetallada(datosFase, 'tablaDetalladaFaseContainer');
}

/* Genera y muestra la Tabla Detallada por Semanas para una fase espec√≠fica, con controles interactivos.
* @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
* @param {string} contenedorId - El ID del elemento HTML donde se insertar√° la tabla detallada.
*/
function crearSelectActividad(indiceFila, actividadSeleccionada) {
    // Mapa de valores de actividad a nombres legibles
    const opcionesActividad = {
        1.2: 'Sedentario',
        1.375: 'Ligero (1-3 d√≠as/semana)',
        1.55: 'Moderado (3-5 d√≠as/semana)',
        1.725: 'Activo (6-7 d√≠as/semana)',
        1.9: 'Muy Activo (Intenso/Diario)'
    };

    let opcionesHTML = '';
    for (const [valor, nombre] of Object.entries(opcionesActividad)) {
        const valorNumerico = parseFloat(valor);
        const seleccionado = valorNumerico === actividadSeleccionada ? 'selected' : '';
        // --- CORRECCI√ìN: Envolver indiceFila entre comillas simples ---
        opcionesHTML += `<option value="${valorNumerico}" ${seleccionado}>${nombre}</option>`;
    }

    // --- CORRECCI√ìN: Envolver indiceFila entre comillas simples ---
    return `
        <select id="select-actividad-${indiceFila}" class="form-select form-select-sm"
                onchange="actualizarFilaPorActividad('${indiceFila}', this.value)">
            ${opcionesHTML}
        </select>
    `;
}
/**
 * Genera y muestra la Tabla Detallada por Semanas para una fase espec√≠fica, con controles interactivos.
 * @param {Object} datosFase - Los datos de la fase seleccionada desde la Tabla General.
 * @param {string} contenedorId - El ID del elemento HTML donde se insertar√° la tabla detallada.
 */
function generarYMostrarTablaDetallada(datosFase, contenedorId = 'tablaDetalladaFaseContainer') {
    // --- 1. Validar argumentos ---
    if (!datosFase || typeof datosFase !== 'object') {
        console.error("Error: datosFase no es un objeto v√°lido en generarYMostrarTablaDetallada.", datosFase);
        return;
    }
    if (!contenedorId || typeof contenedorId !== 'string') {
        console.error("Error: contenedorId no es una cadena v√°lida en generarYMostrarTablaDetallada.", contenedorId);
        return;
    }

    // Obtener semanas totales del plan
    const semanasTotalesPlan = window.nonlinearProgressData_1?.tiempo?.semanasEstimadas || 30;

    // --- 2. Obtener el contenedor donde se mostrar√° la tabla ---
    const contenedor = document.getElementById(contenedorId);
    if (!contenedor) {
        console.error(`No se encontr√≥ el contenedor con ID '${contenedorId}' para la Tabla Detallada.`);
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = `Error: No se encontr√≥ el contenedor para mostrar los detalles de la fase.`;
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // --- 3. Mostrar un mensaje de carga mientras se generan los datos ---
    contenedor.innerHTML = '<p class="info-message">Generando detalles de la fase... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></p>';
    contenedor.style.display = 'block';

    try {
        // --- 4. Generar los datos para la tabla detallada ---
        const resultadoGeneracion = generarDatosTablaDetallada(datosFase);
        if (!resultadoGeneracion || typeof resultadoGeneracion !== 'object') {
            throw new Error("generarDatosTablaDetallada no devolvi√≥ un objeto v√°lido.");
        }

        const datosPorMes = resultadoGeneracion.datosPorMes;
        const estrategiasDisponibles = resultadoGeneracion.estrategiasDisponibles || [];
        const semanasTotalesPlanCalculadas = resultadoGeneracion.semanasTotalesPlan || semanasTotalesPlan;

        if (!Array.isArray(datosPorMes) || datosPorMes.length === 0) {
            throw new Error("No se generaron datos de meses para la tabla detallada o el array est√° vac√≠o.");
        }

        // --- 5. Determinar si es una pausa metab√≥lica ---
        const esPausaFase = datosFase.nombreFase.includes('Pausa');

        // --- 6. Calcular el mes global inicial basado en la semana de reevaluaci√≥n ---
        const semanaInicioFase = datosFase.semanaReevaluacion;
        const mesGlobalInicio = Math.ceil(semanaInicioFase / 4);

        // --- 7. Construir el HTML del accordion ---
        let htmlTablaDetallada = `
            <div class="card mb-1">
                <div class="card-header" style="background-color: #e8f5e9; border-bottom: 1px solid #c8e6c9;">
                    <h2 class="mb-0"><i class="fas fa-list"></i>  Detalles de la Fase: ${datosFase.nombreFase} (${datosFase.mesesTexto})</h2>
                    <p class="mb-0"><small>Peso estimado: ${datosFase.pesoInicioFase.toFixed(1)} kg ‚Üí ${datosFase.pesoFinFase.toFixed(1)} kg | Objetivo: ${datosFase.objetivoPrincipal}</small></p>
                </div>
                <div class="card-body">
                    <div class="accordion" id="accordionMeses">
        `;

        datosPorMes.forEach((mesData, mesIndex) => {
            // Calcular posici√≥n global del mes
            const mesGlobal = mesGlobalInicio + mesIndex;

            // --- Estilo especial si es fase de pausa ---
            const estiloMesHeader = esPausaFase
                ? 'style="color: rgb(243, 156, 18); font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Helvetica, Arial, sans-serif, \'Apple Color Emoji\', \'Segoe UI Emoji\', \'Segoe UI Symbol\'; font-size: 28.8px; font-weight: 600; font-style: normal; line-height: 34.56px; text-align: start; text-decoration: none; text-transform: none; white-space: normal;"'
                : '';

            htmlTablaDetallada += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingMes${mesData.mes}">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseMes${mesData.mes}" aria-expanded="${mesIndex === 0 ? 'true' : 'false'}"
                                aria-controls="collapseMes${mesData.mes}" ${estiloMesHeader}>
                            Mes ${mesData.mes} - Posici√≥n Global: Mes ${mesGlobal}
                        </button>
                    </h2>
                    <div id="collapseMes${mesData.mes}" class="accordion-collapse collapse ${mesIndex === 0 ? 'show' : ''}"
                         aria-labelledby="headingMes${mesData.mes}" data-bs-parent="#accordionMeses">
                        <div class="accordion-body">
                            <div class="accordion" id="accordionSemanasMes${mesData.mes}">
            `;

            mesData.semanas.forEach((semanaData, semanaIndex) => {
                // --- Obtener estrategias globales ---
                let estrategiasGlobalesSeleccionadas = [];
                try {
                    if (typeof getSelectedStrategies === 'function') {
                        estrategiasGlobalesSeleccionadas = getSelectedStrategies();
                        if (estrategiasGlobalesSeleccionadas.length === 1 && estrategiasGlobalesSeleccionadas[0] === 'ninguna') {
                            estrategiasGlobalesSeleccionadas = [];
                        }
                    } else {
                        console.warn("Funci√≥n getSelectedStrategies no encontrada al generar la tabla.");
                    }
                } catch (e) {
                    console.error("Error al obtener estrategias globales en generarYMostrarTablaDetallada:", e);
                    estrategiasGlobalesSeleccionadas = [];
                }

                const textoEstrategiasMostrar = estrategiasGlobalesSeleccionadas.length > 0
                    ? estrategiasGlobalesSeleccionadas.join(', ')
                    : 'ninguna';

                // --- Datos semana ---
                const semanaGlobal = semanaData.semana;
                const esPausa = semanaData.esPausaMetabolica;
                const pesoInicioSemana = semanaData.pesoInicioSemana;
                const pesoFinSemana = semanaData.pesoFinSemana;

                // --- Generar headerText ---
                const headerText = esPausa
                    ? `Semana ${semanaData.semanaEnMes} (Pausa Metab√≥lica, Peso: ${pesoInicioSemana.toFixed(2)} kg)`
                    : `Semana ${semanaData.semanaEnMes} (Peso: ${pesoInicioSemana.toFixed(2)} ‚Üí ${pesoFinSemana.toFixed(2)} kg)`;

                const headerTextCompleto = `${headerText} | Ubicaci√≥n: Semana n¬∫ ${semanaGlobal} del Plan (Total: ${semanasTotalesPlanCalculadas} semanas)`;

                // --- Estilo especial si es semana de pausa metab√≥lica ---
                const estiloHeaderSemana = esPausa

                    ? 'style="color: rgb(243, 156, 18) font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, Helvetica, Arial, sans-serif, \'Apple Color Emoji\', \'Segoe UI Emoji\', \'Segoe UI Symbol\'; font-size: 24px; font-weight: 600; font-style: normal; line-height: 28.8px; text-align: start; text-decoration: none; text-transform: none; white-space: normal;"'
                    : '';
                htmlTablaDetallada += `
                    <div class="accordion-item">
                        <h3 class="accordion-header" id="headingSemana${semanaData.semana}">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseSemana${semanaData.semana}" aria-expanded="${semanaIndex === 0 ? 'true' : 'false'}"
                                    aria-controls="collapseSemana${semanaData.semana}" ${estiloHeaderSemana}>
                                ${headerTextCompleto}
                            </button>
                        </h3>
                        <div id="collapseSemana${semanaData.semana}" class="accordion-collapse collapse ${semanaIndex === 0 ? 'show' : ''}"
                             aria-labelledby="headingSemana${semanaData.semana}" data-bs-parent="#accordionSemanasMes${mesData.mes}">
                            <div class="accordion-body">
                                <div class="table-responsive tabla-planificacion-wrapper">
                                    <table id="tablaDetalladaSemana${semanaData.semana}" class="table table-striped table-bordered align-middle tabla-planificacion">
                                        <thead>
                                            <tr>
                                                <th scope="col" style="text-align: start;">D√≠a</th>
                                                <th scope="col" style="text-align: start;">Actividad</th>
                                                <th scope="col" style="text-align: start;">Kcal/dia</th>
                                                <th scope="col" style="text-align: center;">% Pt<br><small>(g/d√≠a)</small></th>
                                                <th scope="col" style="text-align: center;">% CH<br><small>(g/d√≠a)</small></th>
                                                <th scope="col" style="text-align: center;">% GR<br><small>(g/d√≠a)</small></th>
                                                <th scope="col" style="text-align: start;">Peso Estimado</th>
                                                <th scope="col" style="text-align: start;">Estrategias</th>
                                                <th scope="col" style="text-align: start;">Notas</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                `;

                semanaData.dias.forEach((item, diaIndex) => {
                    const indiceFila = `${mesData.mes}-${semanaData.semana}-${diaIndex}`;
                    const selectActividadHTML = crearSelectActividad(indiceFila, item.actividad);

                    // Aplicar estilos inline en celdas
                    htmlTablaDetallada += `
                        <tr id="fila-detalle-${indiceFila}" data-indice-fila="${indiceFila}">
                            <td style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.dia}
                            </td>
                            <td style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${selectActividadHTML}
                            </td> 
                            <td style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.calorias}
                            </td>
                            <td  style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                <strong>${item.proteinasPct}%</strong><br>
                                <small>${item.proteinas}g</small>
                            </td>
                            <td  style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                <strong>${item.carbohidratosPct}%</strong><br>
                                <small>${item.carbohidratos}g</small>
                            </td>
                            <td  style="text-align: center; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                <strong>${item.grasasPct}%</strong><br>
                                <small>${item.grasas}g</small>
                            </td>
                            <td style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.pesoEstimado.toFixed(1)}
                            </td>
                            <td id="celda-estrategias-${indiceFila}" class="small" style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${textoEstrategiasMostrar}
                            </td>
                            <td id="notas-${indiceFila}" class="small" style="text-align: start; font-size: 14.4px; font-weight: 400; text-decoration: none; text-transform: none; line-height: 23.04px; white-space: normal;">
                                ${item.notas}
                            </td>
                        </tr>
                    `;
                });

                htmlTablaDetallada += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            htmlTablaDetallada += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        // --- 8. Insertar el HTML en el contenedor ---
        contenedor.innerHTML = htmlTablaDetallada;

        // --- 9. Adjuntar datos a las tablas para acceso futuro ---
        datosPorMes.forEach((mesData) => {
            mesData.semanas.forEach((semanaData) => {
                const tablaElement = document.getElementById(`tablaDetalladaSemana${semanaData.semana}`);
                if (tablaElement) {
                    tablaElement.datosFaseBase = datosFase;
                    tablaElement.datosFilasOriginales = semanaData.dias;
                    tablaElement.estrategiasDisponibles = estrategiasDisponibles;
                }
            });
        });

        console.log("Tabla detallada generada y mostrada con √©xito para la fase:", datosFase.nombreFase);

    } catch (error) {
        console.error("Error al generar o mostrar la tabla detallada:", error);
        contenedor.innerHTML = `<p class="error-message">‚ùå Error al generar los detalles para la fase <strong>${datosFase?.nombreFase || 'desconocida'}</strong>: ${error.message}</p>`;
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = `Error al generar la tabla detallada: ${error.message}`;
            errorMsgElement.style.display = 'block';
        }
    }
}

// --- Funciones auxiliares para crear controles interactivos ---



/**
* Actualiza una fila de la tabla detallada cuando cambia el nivel de actividad.
* Recalcula TDEE, Kcal/d√≠a y macros.
* @param {string|number} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia" o un n√∫mero).
* @param {string} nuevoNivelActividadStr - El nuevo valor del multiplicador de actividad (como string).
* @param {number|null} ajusteCaloriasDiarioManual - (Opcional) Un ajuste manual de calor√≠as diarias que anula el global.
*/
function actualizarFilaPorActividad(indiceFila, nuevoNivelActividadStr, ajusteCaloriasDiarioManual = null) {
    console.log(`Actualizando fila ${indiceFila} por cambio de actividad a ${nuevoNivelActividadStr}. Ajuste manual: ${ajusteCaloriasDiarioManual}`);

    try {
        // --- 1. Validar y convertir la entrada ---
        const nuevoNivelActividad = parseFloat(nuevoNivelActividadStr);
        if (isNaN(nuevoNivelActividad)) {
            console.error("Nivel de actividad inv√°lido recibido:", nuevoNivelActividadStr);
            return;
        }

        // --- 2. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;

        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`√çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            return;
        }

        // --- 4. Recalcular TMB y TDEE para el peso estimado actual de la fila ---
        // Obtenemos el peso estimado actual directamente de los datos originales de la fila.
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;

        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
            console.error("Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
            return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calcular TDEE usando el TMB reci√©n calculado y la nueva actividad
        const nuevoTDEE = tmbActual * nuevoNivelActividad;

        console.log(`Fila ${indiceFila}: TMB calculado=${tmbActual.toFixed(2)}, Nuevo TDEE=${nuevoTDEE.toFixed(2)}, Nueva Actividad=${nuevoNivelActividad}`);

        // --- 5. Calcular nuevas calor√≠as diarias objetivo ---
        let nuevasCaloriasDiarias = nuevoTDEE;
        if (ajusteCaloriasDiarioManual !== null) {
            nuevasCaloriasDiarias += ajusteCaloriasDiarioManual;
            console.log(`Usando ajuste de calor√≠as manual: ${ajusteCaloriasDiarioManual} kcal/d√≠a`);
        } else {
            const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
            const ajusteCaloriasDiarioGlobal = ajusteCaloriasSemanal !== null ? ajusteCaloriasSemanal / 7 : 0;
            nuevasCaloriasDiarias += ajusteCaloriasDiarioGlobal;
            console.log(`Usando ajuste de calor√≠as global: ${ajusteCaloriasDiarioGlobal} kcal/d√≠a`);
        }

        // --- 6. Obtener macros base promedio de la fase ---
        const parsearRangoPorcentaje = (rangoStr) => {
            if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
            const partes = rangoStr.replace('%', '').split('-').map(Number);
            return partes.length === 2 ? partes : [partes[0], partes[0]];
        };

        let rangoProteinasPct = [25, 25];
        let rangoCarbohidratosPct = [40, 40];
        let rangoGrasasPct = [35, 35];
        try {
            rangoProteinasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.proteinasPct);
            rangoCarbohidratosPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.carbohidratosPct);
            rangoGrasasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.grasasPct);
        } catch (e) {
            console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
        }

        let proteinasPctPromedio = Number(document.getElementById('protein-percentage')?.value) || Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
        let carbohidratosPctPromedio = Number(document.getElementById('carb-percentage')?.value) || Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
        let grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

        // --- 7. Inicializar macros del d√≠a con los promedios de la fase ---
        let nuevasProteinasPctDia = proteinasPctPromedio;
        let nuevasCarbohidratosPctDia = carbohidratosPctPromedio;
        let nuevasGrasasPctDia = grasasPctPromedio;

        // --- 8. Asegurar que los porcentajes sumen 100% ---
        const totalPct = nuevasProteinasPctDia + nuevasCarbohidratosPctDia + nuevasGrasasPctDia;
        if (Math.abs(totalPct - 100) > 0.1) {
            const diff = 100 - totalPct;
            nuevasGrasasPctDia += diff;
            console.warn(`Porcentajes ajustados en Fila ${indiceFila} para sumar 100%.`);
        }

        // --- 9. Calcular nuevos gramos de macros ---
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 10. Asegurar un m√≠nimo de calor√≠as por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`Calor√≠as ajustadas en Fila ${indiceFila} por debajo del l√≠mite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 11. Actualizar la UI ---
        // Actualizar celda de calor√≠as
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // Actualizar celdas de macros (% y g)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // --- 12. Actualizar celda de notas (manteniendo estrategias) ---
        const celdaNotas = document.getElementById(`notas-${indiceFila}`);
        if (celdaNotas) {
            // a. Obtener el texto actual completo de la celda de notas
            const textoNotasActual = celdaNotas.textContent || "";

            // b. Intentar extraer la parte de "Estrategias aplicadas" del texto actual
            // Creamos una expresi√≥n regular para encontrar el fragmento que empieza con ". Estrategias aplicadas: "
            // y capturar todo lo que le sigue hasta el final del string.
            // Ejemplo: Si textoNotasActual es "Basado en... Ajuste diario: -500 kcal.. Estrategias aplicadas: IF 16:8 aplicado."
            // matchEstrategiasCapturadas[1] ser√° "IF 16:8 aplicado."
            const regexEstrategias = /\. Estrategias aplicadas: (.+)$/;
            const matchEstrategiasCapturadas = textoNotasActual.match(regexEstrategias);
            let parteEstrategiasExistente = "";
            if (matchEstrategiasCapturadas && matchEstrategiasCapturadas[1]) {
                // Si se encontr√≥, reconstruimos la parte con el formato correcto
                parteEstrategiasExistente = `. Estrategias aplicadas: ${matchEstrategiasCapturadas[1]}`;
                console.log(`[Actualizar Actividad] Parte de estrategias extra√≠da para ${indiceFila}:`, parteEstrategiasExistente);
            } else {
                // Si no se encontr√≥ (puede ser la primera vez o porque no hay estrategias), se deja vac√≠o
                console.log(`[Actualizar Actividad] No se encontr√≥ parte de estrategias en notas-${indiceFila}.`);
            }

            // c. Generar la NUEVA parte base de la nota (TDEE, ajuste)
            let nuevaNotaBase = `Basado en TDEE estimado (${nuevoTDEE.toFixed(0)} kcal)`;
            if (ajusteCaloriasDiarioManual !== null) {
                nuevaNotaBase += ` y ajuste manual.`;
                nuevaNotaBase += ` Ajuste diario: ${ajusteCaloriasDiarioManual > 0 ? '+' : ''}${ajusteCaloriasDiarioManual.toFixed(0)} kcal.`;
            } else {
                nuevaNotaBase += ` y ajuste objetivo.`;
                const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal;
                if (ajusteCaloriasSemanal !== null) {
                    nuevaNotaBase += ` Ajuste diario: ${ajusteCaloriasSemanal > 0 ? '+' : ''}${(ajusteCaloriasSemanal / 7).toFixed(0)} kcal.`;
                }
                // Si no hay ajuste semanal global, no se a√±ade nada m√°s a la parte base.
            }

            // d. Combinar la nueva parte base con la parte de estrategias existente
            const notaCompletaActualizada = nuevaNotaBase + parteEstrategiasExistente;

            // e. Registrar el estado antes y despu√©s de la actualizaci√≥n
            console.log(`[Actualizar Actividad] ANTES de actualizar notas-${indiceFila}:`, textoNotasActual);
            celdaNotas.textContent = notaCompletaActualizada; // Actualizar la celda
            console.log(`[Actualizar Actividad] DESPU√âS de actualizar notas-${indiceFila}:`, celdaNotas.textContent);
        }
        // ... (resto del c√≥digo de la funci√≥n) ...
        console.log(`Fila ${indiceFila} actualizada con √©xito por cambio de actividad.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g
        });

    } catch (error) {
        console.error("Error al actualizar la fila por cambio de actividad:", error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert("Hubo un error al actualizar los c√°lculos. Por favor, int√©ntalo de nuevo.");
    }
}

function crearControlEstrategias_eliminada(indiceFila, estrategiasAplicadas = [], estrategiasDisponibles = []) {
    // Asegurarse de que estrategiasAplicadas sea un array
    const estrategiasActuales = Array.isArray(estrategiasAplicadas) ? estrategiasAplicadas : [];

    // Crear las opciones del <select>
    let opcionesHtml = `<option value="">ninguna</option>`; // Opci√≥n por defecto
    estrategiasDisponibles.forEach(estrategia => {
        // Evitar agregar "ninguna" como opci√≥n seleccionable si ya est√° en la lista
        // Asumimos que "ninguna" es un valor especial que representa un array vac√≠o o null
        if (estrategia.toLowerCase() === "ninguna") return;

        // Comprobar si esta estrategia est√° en la lista de aplicadas
        // Usamos 'includes' para comparar el nombre de la estrategia
        const seleccionada = estrategiasActuales.includes(estrategia) ? 'selected' : '';
        opcionesHtml += `<option value="${estrategia}" ${seleccionada}>${estrategia}</option>`;
    });

    // Devolver el HTML del <select multiple> y el texto de ayuda
    return `
        <select id="select-estrategias-${indiceFila}" class="form-control form-control-sm" multiple
                onchange="actualizarFilaPorEstrategias('${indiceFila}', Array.from(this.selectedOptions).map(option => option.value))">
            ${opcionesHtml}
        </select>
        <small class="form-text text-muted">Mant√©n presionada Ctrl (Cmd en Mac) para seleccionar varias.</small>
    `;
}

/*
// Ejemplo de c√≥mo podr√≠a ser con checkboxes (m√°s complejo de implementar)
// let checkboxesHTML = '';
// estrategiasDisponibles.forEach(estrategia => {
//     const checked = estrategiasAplicadas.includes(estrategia) ? 'checked' : '';
//     checkboxesHTML += `
//         <div class="form-check form-check-inline">
//             <input class="form-check-input" type="checkbox" id="chk-${indiceFila}-${estrategia}" 
//                    value="${estrategia}" ${checked} 
//                    onchange="manejarCambioCheckboxEstrategia(${indiceFila}, '${estrategia}', this.checked)">
//             <label class="form-check-label small" for="chk-${indiceFila}-${estrategia}">${estrategia}</label>
//         </div>
//     `;
// });
// return `<div>${checkboxesHTML}</div>`;
*/

/**
 * Actualiza una fila de la tabla detallada cuando cambian las estrategias seleccionadas.
 * Recalcula Kcal/d√≠a, % y gramos de macros, y notas.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {Array<string>|string} valorEstrategias - Array de estrategias seleccionadas o string separado por comas.
 */
/**
 * Actualiza una fila de la tabla detallada cuando cambian las estrategias seleccionadas.
 * Recalcula Kcal/d√≠a, % y gramos de macros, y notas.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {Array<string>} arrayEstrategias - Array de nombres de estrategias seleccionadas.
 * @param {number|null} [ajusteCaloriasDiarioManual=null] - (Opcional) Un ajuste manual de calor√≠as diarias que puede haberse aplicado.
 */
function actualizarFilaPorEstrategias(indiceFila, arrayEstrategias, ajusteCaloriasDiarioManual = null) {
    console.log(`[Modal Avanzado] Actualizando fila ${indiceFila} por cambio de estrategias a:`, arrayEstrategias, `. Ajuste manual: ${ajusteCaloriasDiarioManual}`);

    try {
        // --- 1. Procesar el valor de entrada ---
        let estrategiasAplicadasArray = [];

        if (Array.isArray(arrayEstrategias)) {
            // Caso 1: Recibimos directamente el array del select multiple (viejo) o checkboxes (modal)
            estrategiasAplicadasArray = arrayEstrategias.filter(item => item && item.trim() !== "");
        } else if (typeof arrayEstrategias === 'string') {
            // Caso 2: Recibimos una cadena (del viejo input)
            // Separar por coma y limpiar
            estrategiasAplicadasArray = arrayEstrategias.split(',')
                .map(item => item.trim())
                .filter(item => item && item.toLowerCase() !== "ninguna");
        }

        // --- 2. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales espec√≠ficos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`[Modal Avanzado] √çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`[Modal Avanzado] No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            return;
        }

        // --- 4. Obtener el nivel de actividad actual de la fila ---
        // Este paso es crucial para recalcular el TDEE
        const selectActividadElement = document.getElementById(`select-actividad-${indiceFila}`);
        let actividadActual = datosFilaOriginal.actividad; // Valor por defecto del dato original
        if (selectActividadElement) {
            actividadActual = parseFloat(selectActividadElement.value);
            if (isNaN(actividadActual)) {
                console.warn(`[Modal Avanzado] Nivel de actividad inv√°lido en select para fila ${indiceFila}. Usando original.`);
                actividadActual = datosFilaOriginal.actividad;
            }
        }

        // --- 5. Recalcular TMB y TDEE usando el peso estimado actual de la fila ---
        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        // y el peso estimado de la fila (que ya refleja la estimaci√≥n para el inicio de la semana)
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;
        if (pesoEstimadoKg === undefined) {
            console.error(`[Modal Avanzado] Peso estimado no encontrado para la fila ${indiceFila}.`);
            return; // No se puede recalcular sin peso
        }

        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
            console.error("[Modal Avanzado] Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
            return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        const tdeeActual = tmbActual * actividadActual;

        // --- 6. Calcular nuevas calor√≠as diarias objetivo ---
        let nuevasCaloriasDiarias = tdeeActual;
        // Priorizar el ajuste manual si se proporciona
        if (ajusteCaloriasDiarioManual !== null) {
            nuevasCaloriasDiarias += ajusteCaloriasDiarioManual;
            console.log(`[Modal Avanzado] Usando ajuste de calor√≠as manual en estrategias: ${ajusteCaloriasDiarioManual} kcal/d√≠a`);
        } else {
            // Si no hay ajuste manual, usar el ajuste semanal global
            const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
            const ajusteCaloriasDiarioGlobal = ajusteCaloriasSemanal !== null ? ajusteCaloriasSemanal / 7 : 0;
            nuevasCaloriasDiarias += ajusteCaloriasDiarioGlobal;
            console.log(`[Modal Avanzado] Usando ajuste de calor√≠as global en estrategias: ${ajusteCaloriasDiarioGlobal} kcal/d√≠a`);
        }

        // --- 7. Obtener macros base promedio de la fase ---
        const parsearRangoPorcentaje = (rangoStr) => {
            if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
            const partes = rangoStr.replace('%', '').split('-').map(Number);
            return partes.length === 2 ? partes : [partes[0], partes[0]];
        };

        let rangoProteinasPct = [25, 25];
        let rangoCarbohidratosPct = [40, 40];
        let rangoGrasasPct = [35, 35];
        try {
            rangoProteinasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.proteinasPct);
            rangoCarbohidratosPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.carbohidratosPct);
            rangoGrasasPct = parsearRangoPorcentaje(datosFaseBase.macrosBase.grasasPct);
        } catch (e) {
            console.warn("[Modal Avanzado] Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
        }

        // Usar los valores del input range si existen, sino calcular promedio
        let proteinasPctPromedio = Number(document.getElementById('protein-percentage')?.value) || Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
        let carbohidratosPctPromedio = Number(document.getElementById('carb-percentage')?.value) || Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
        let grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

        // --- 8. Inicializar macros del d√≠a con los promedios de la fase ---
        let nuevasProteinasPctDia = proteinasPctPromedio;
        let nuevasCarbohidratosPctDia = carbohidratosPctPromedio;
        let nuevasGrasasPctDia = grasasPctPromedio;
        let nuevasNotasEstrategias = [];

        // --- 9. Aplicar modificaciones por las NUEVAS estrategias seleccionadas ---
        const diaNombre = datosFilaOriginal.dia;
        const diaNumero = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'].indexOf(diaNombre) + 1;

        // NOTA: Esta parte requiere que las estrategiasDisponibles tengan nombres consistentes
        // con los usados en los checkboxes del modal y en los if's siguientes.
        // Asumimos que los nombres son 'refeed', 'carb_cycling', 'protein_cycling', etc.

        if (estrategiasAplicadasArray.includes('refeed') && diaNombre === 'Domingo') {
            nuevasCarbohidratosPctDia = Math.min(95, nuevasCarbohidratosPctDia + 20);
            nuevasGrasasPctDia = Math.max(5, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasCaloriasDiarias = Math.round(nuevasCaloriasDiarias * 1.05);
            nuevasNotasEstrategias.push('D√≠a de Refeed');
        }

        if (estrategiasAplicadasArray.includes('carb_cycling') && (diaNumero % 2 === 0)) {
            nuevasCarbohidratosPctDia = Math.min(90, nuevasCarbohidratosPctDia + 15);
            nuevasGrasasPctDia = Math.max(5, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasNotasEstrategias.push('D√≠a alto en HC (Carb Cycling)');
        }

        if (estrategiasAplicadasArray.includes('protein_cycling') && diaNombre === 'Domingo') {
            nuevasProteinasPctDia = Math.max(15, nuevasProteinasPctDia - 10);
            nuevasGrasasPctDia = 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia;
            nuevasNotasEstrategias.push('D√≠a bajo en prote√≠na (Protein Cycling)');
        }

        if (estrategiasAplicadasArray.includes('ckd') && (diaNombre === 'S√°bado' || diaNombre === 'Domingo')) {
            nuevasCarbohidratosPctDia = Math.min(95, nuevasCarbohidratosPctDia + 30);
            nuevasGrasasPctDia = Math.max(2, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasCaloriasDiarias = Math.round(nuevasCaloriasDiarias * 1.1);
            nuevasNotasEstrategias.push('D√≠a de Carb-Loading (CKD)');
        }

        const diasEntrenoTKD = ['Lunes', 'Mi√©rcoles', 'Viernes'];
        if (estrategiasAplicadasArray.includes('tkd') && diasEntrenoTKD.includes(diaNombre)) {
            nuevasCarbohidratosPctDia = Math.min(85, nuevasCarbohidratosPctDia + 10);
            nuevasGrasasPctDia = Math.max(5, 100 - nuevasProteinasPctDia - nuevasCarbohidratosPctDia);
            nuevasNotasEstrategias.push('Targeted Keto (TKD)');
        }

        if (estrategiasAplicadasArray.includes('if_16_8')) {
            nuevasNotasEstrategias.push('IF 16:8 aplicado');
        }
        if (estrategiasAplicadasArray.includes('timing')) {
            nuevasNotasEstrategias.push('Timing Nutricional considerado');
        }
        if (estrategiasAplicadasArray.includes('flexible_dieting')) {
            nuevasNotasEstrategias.push('Flexible Dieting (80/20)');
        }
        if (estrategiasAplicadasArray.includes('Cetosis estricta')) {
            nuevasNotasEstrategias.push('Cetosis estricta (<50g HC/d√≠a)');
        }
        if (estrategiasAplicadasArray.includes('Hiperproteica')) {
            nuevasNotasEstrategias.push('Dieta Hiperproteica (1.8-2.5g/kg prote√≠na)');
        }

        // --- 10. Asegurar que los porcentajes sumen 100% ---
        const totalPct = nuevasProteinasPctDia + nuevasCarbohidratosPctDia + nuevasGrasasPctDia;
        if (Math.abs(totalPct - 100) > 0.1) {
            const diff = 100 - totalPct;
            nuevasGrasasPctDia += diff;
            console.warn(`[Modal Avanzado] Porcentajes ajustados en Fila ${indiceFila} para sumar 100%.`);
        }

        // --- 11. Calcular nuevos gramos de macros ---
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 12. Asegurar un m√≠nimo de calor√≠as por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`[Modal Avanzado] Calor√≠as ajustadas en Fila ${indiceFila} por debajo del l√≠mite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 13. Actualizar la UI ---
        // a. Actualizar celda de calor√≠as
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // b. Actualizar celdas de macros (% y g)
        // Celda % Pt y g (primera .text-center)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        // Celda % CH y g (segunda .text-center)
        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        // Celda % GR y g (tercera .text-center)
        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // --- 14. Actualizar celda de notas ---
        const celdaNotas = document.getElementById(`notas-${indiceFila}`);
        if (celdaNotas) {
            // a. Generar la nota base (TDEE, ajuste)
            let notaBaseOriginal = `Basado en TDEE estimado (${tdeeActual.toFixed(0)} kcal)`;
            if (ajusteCaloriasDiarioManual !== null) {
                notaBaseOriginal += ` y ajuste manual.`;
                notaBaseOriginal += ` Ajuste diario: ${ajusteCaloriasDiarioManual > 0 ? '+' : ''}${ajusteCaloriasDiarioManual.toFixed(0)} kcal.`;
            } else {
                notaBaseOriginal += ` y ajuste objetivo.`;
                const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
                if (ajusteCaloriasSemanal !== null) {
                    notaBaseOriginal += ` Ajuste diario: ${ajusteCaloriasSemanal > 0 ? '+' : ''}${(ajusteCaloriasSemanal / 7).toFixed(0)} kcal.`;
                }
            }

            // b. Construir la parte de estrategias aplicadas
            let parteEstrategias = "";
            if (nuevasNotasEstrategias.length > 0) {
                parteEstrategias = `. Estrategias aplicadas: ${nuevasNotasEstrategias.join(', ')}.`;
            }

            // c. Combinar y actualizar
            const nuevaNotaCompleta = notaBaseOriginal + parteEstrategias;
            celdaNotas.textContent = nuevaNotaCompleta;
        }

        console.log(`[Modal Avanzado] Fila ${indiceFila} actualizada con √©xito por cambio de estrategias.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g,
            nota: celdaNotas ? celdaNotas.textContent : 'Celda de notas no encontrada'
        });

    } catch (error) {
        console.error(`[Modal Avanzado] Error al actualizar la fila ${indiceFila} por cambio de estrategias:`, error);
        alert("Hubo un error al actualizar los c√°lculos por estrategias. Por favor, int√©ntalo de nuevo.");
    }
}

/**
 * Genera los datos para la Tabla Detallada por Semanas de una fase espec√≠fica.
 * @param {Object} datosFase - Los datos de la fase seleccionada.
 * @returns {Array<Object>} Un array de objetos, cada uno representando un d√≠a de una semana.
 */

function generarDatosTablaDetallada(datosFase) {
    console.log("1. generarDatosTablaDetallada recibi√≥:", datosFase);

    // --- Determinar si es una pausa metab√≥lica completa ---
    const esPausaMetabolicaFase = datosFase.nombreFase.includes('Pausa Metab√≥lica');

    // --- Datos necesarios del contexto global ---
    const pesoInicialFase = datosFase.pesoInicioFase;
    const cambioPesoTotalFase = datosFase.pesoFinFase - datosFase.pesoInicioFase;
    const semanasEnFase = datosFase.semanasAsignadas;
    const nombreFase = datosFase.nombreFase;
    const mesesTexto = datosFase.mesesTexto;
    const objetivo = document.getElementById('objetivo').value;

    // --- Calcular semana global inicial ---
    let semanaGlobalInicial;

    // ‚úÖ Solo para la primera fase (asumimos que semanaReevaluacion = 1)
    if (datosFase.semanaReevaluacion === 1) {
        semanaGlobalInicial = datosFase.semanaReevaluacion; // ‚úÖ Empieza en 1
    } else {
        semanaGlobalInicial = datosFase.semanaReevaluacion - datosFase.semanasAsignadas + 1;
    }

    // --- Validar que sea positivo ---
    if (semanaGlobalInicial < 1) {
        console.warn("semanaGlobalInicial ajustada a 1 para evitar valores negativos.");
        semanaGlobalInicial = 1;
    }

    // --- Calcular meses anteriores ---
    const mesesAnteriores = Math.floor((semanaGlobalInicial - 1) / 4); // ‚úÖ Usar floor, no ceil
    const mesInicioPlan = Math.max(1, mesesAnteriores + 1);

    // --- Validaci√≥n de semanasAsignadas ---
    if (semanasEnFase === undefined || semanasEnFase === null || semanasEnFase <= 0) {
        console.error("Duraci√≥n de fase inv√°lida (semanasAsignadas):", semanasEnFase);
        throw new Error(`Duraci√≥n de fase inv√°lida: semanasAsignadas=${semanasEnFase}`);
    }

    // --- üî• NUEVO: Preparar para modelo no lineal ---
    const useNonLinear = window.nonlinearProgressData_1?.evolucionSemanal?.length > 0;
    let acumuladoInicioFase = 0;

    if (useNonLinear) {
        // Calcular el peso acumulado AL FINAL de la semana anterior a la fase
        if (semanaGlobalInicial > 1) {
            const weekDataInicioFase = window.nonlinearProgressData_1.evolucionSemanal.find(
                w => w.Semana === semanaGlobalInicial - 1
            );
            if (weekDataInicioFase) {
                // Para p√©rdida, el acumulado debe ser negativo
                acumuladoInicioFase = objetivo === "perdida1"
                    ? -Math.abs(weekDataInicioFase["Peso Acumulado (kg)"])
                    : weekDataInicioFase["Peso Acumulado (kg)"];
            } else {
                console.warn(`‚ö†Ô∏è Semana ${semanaGlobalInicial - 1} no encontrada en datos no lineales. Usando 0.`);
                acumuladoInicioFase = 0;
            }
        }
        // Si es la primera semana del plan, acumuladoInicioFase = 0 (sin cambios previos)
    }

    // --- Calcular cambio de peso por semana (solo para fallback lineal) ---
    const cambioPesoPorSemana = cambioPesoTotalFase / semanasEnFase;

    // --- Obtener estrategias seleccionadas por el usuario ---
    const estrategiasSeleccionadas = getSelectedStrategies(); // Tu funci√≥n existente
    const estrategiasDisponibles = [
        'ninguna', 'refeed', 'carb_cycling', 'protein_cycling', 'ckd', 'tkd',
        'if_16_8', 'timing', 'flexible_dieting', 'hiperproteica'
    ];

    // --- Calcular macros base de la fase ---
    const parsearRangoPorcentaje = (rangoStr) => {
        if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
        const partes = rangoStr.replace('%', '').split('-').map(Number);
        return partes.length === 2 ? partes : [partes[0], partes[0]];
    };

    let rangoProteinasPct = [25, 25];
    let rangoCarbohidratosPct = [40, 40];
    let rangoGrasasPct = [35, 35];
    try {
        rangoProteinasPct = parsearRangoPorcentaje(datosFase.macrosBase.proteinasPct);
        rangoCarbohidratosPct = parsearRangoPorcentaje(datosFase.macrosBase.carbohidratosPct);
        rangoGrasasPct = parsearRangoPorcentaje(datosFase.macrosBase.grasasPct);
    } catch (e) {
        console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
    }

    // --- Obtener configuraci√≥n global desde window.planConfig ---
    if (!window.planConfig || !window.planConfig[nombreFase]) {
        console.error("Configuraci√≥n del plan no disponible para la fase:", nombreFase);
        throw new Error("Debe ejecutar generarTablaGeneral primero para inicializar window.planConfig.");
    }
    const planConfig = window.planConfig[nombreFase];
    const semanasPausaEstaFase = planConfig.semanasPausa || 0;
    const ratios = planConfig.ratios || [1, 2];
    const numeroFases = planConfig.numeroFases || 2;
    const semanasTotalesPlan = planConfig.semanasTotales || window.estimatedWeeksManualGlobal || 30;

    // --- Calcular meses ---
    const mesInicio = mesInicioPlan;
    const mesFin = mesInicioPlan + Math.ceil((semanasEnFase + semanasPausaEstaFase) / 4) - 1;

    // --- Calcular semanas de pausa metab√≥lica usando datos globales ---
    const semanasPausa = [];
    if (!esPausaMetabolicaFase && semanasPausaEstaFase > 0) {
        const intervaloPausa = Math.floor(semanasEnFase / (semanasPausaEstaFase + 1));

        for (let i = 0; i < semanasPausaEstaFase; i++) {
            const semanaLocalPausa = (i + 1) * intervaloPausa;
            const mesPausa = mesInicio + Math.floor((semanaLocalPausa - 1) / 4);
            semanasPausa.push({ mes: mesPausa, semanaLocal: (semanaLocalPausa - 1) % 4 + 1 });
        }
    }

    const datosPorMes = [];
    let semanasRestantes = semanasEnFase + semanasPausaEstaFase;

    // --- Iterar por meses ---
    for (let mes = mesInicio; mes <= mesFin && semanasRestantes > 0; mes++) {
        const semanasEnMes = Math.min(4, semanasRestantes);
        const datosSemanas = [];

        for (let semana = 1; semana <= semanasEnMes; semana++) {
            // --- Calcular semana global ---
            const semanaGlobalActual = semanaGlobalInicial + (mes - mesInicioPlan) * 4 + (semana - 1);
            window.semanaGlobalActual = semanaGlobalActual;

            // --- Determinar si esta semana es una pausa metab√≥lica ---
            const esPausaMetabolicaSemana = semanasPausa.some(p => p.mes === mes && p.semanaLocal === semana);

            // --- Calcular mes y semana dentro del mes ---
            const mesActual = Math.floor((window.semanaGlobalActual - 1) / 4) + 1;
            const semanaEnMes = (window.semanaGlobalActual - 1) % 4 + 1;

            if (window.semanaGlobalActual < 1) continue;

            const estrategiasActivas = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? getSelectedStrategies().filter(estrategia => ['if_16_8', 'timing', 'flexible_dieting', 'hiperproteica'].includes(estrategia))
                : getSelectedStrategies();

            // --- Calcular macros para esta semana ---
            let proteinasPctPromedio = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? 25
                : (Number(document.getElementById('protein-percentage')?.value) || 25);
            let carbohidratosPctPromedio = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? 40
                : (Number(document.getElementById('carb-percentage')?.value) || 20);
            let grasasPctPromedio = esPausaMetabolicaFase || esPausaMetabolicaSemana
                ? 35
                : (100 - proteinasPctPromedio - carbohidratosPctPromedio);

            // --- Validar macros ---
            const totalPctBase = proteinasPctPromedio + carbohidratosPctPromedio + grasasPctPromedio;
            if (Math.abs(totalPctBase - 100) > 0.1) {
                const factor = 100 / totalPctBase;
                proteinasPctPromedio = Math.round(proteinasPctPromedio * factor);
                carbohidratosPctPromedio = Math.round(carbohidratosPctPromedio * factor);
                grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;
                console.warn("Macros ajustados para sumar 100%:", { proteinasPctPromedio, carbohidratosPctPromedio, grasasPctPromedio });
            }

            // --- üî• C√°lculo NO LINEAL (prioritario) ---
            let pesoEstimadoInicioSemana, pesoEstimadoFinSemana, tdeeDelDia;

            if (useNonLinear) {
                const weekData = window.nonlinearProgressData_1.evolucionSemanal.find(
                    w => w.Semana === semanaGlobalActual
                );

                if (weekData) {
                    // Ajustar los signos seg√∫n el objetivo
                    let pesoAcumulado = weekData["Peso Acumulado (kg)"];
                    let tasaSemanal = weekData["Tasa Semanal (kg)"];
                    if (objetivo === "perdida1") {
                        pesoAcumulado = -Math.abs(pesoAcumulado);
                        tasaSemanal = -Math.abs(tasaSemanal);
                    }

                    // El peso acumulado es al FINAL de la semana, por lo que el inicio de la semana es pesoAcumulado - tasaSemanal
                    const pesoAcumuladoInicioSemana = pesoAcumulado - tasaSemanal;

                    // Ajustar al inicio de la FASE (no al inicio del plan)
                    pesoEstimadoInicioSemana = pesoInicialFase + (pesoAcumuladoInicioSemana - acumuladoInicioFase);
                    pesoEstimadoFinSemana = pesoInicialFase + (pesoAcumulado - acumuladoInicioFase);

                    // Usar TDEE precalculado (ya incluye d√©ficit/super√°vit)
                    tdeeDelDia = weekData["TDEE Estimado (kcal/d√≠a)"];
                } else {
                    // Fallback a lineal (semana fuera de rango)
                    const semanasActivas = window.semanaGlobalActual - semanaGlobalInicial -
                        semanasPausa.filter(p => p.mes < mes || (p.mes === mes && p.semanaLocal < semana)).length;

                    pesoEstimadoInicioSemana = pesoInicialFase + (cambioPesoPorSemana * semanasActivas);
                    pesoEstimadoFinSemana = pesoEstimadoInicioSemana + cambioPesoPorSemana;

                    // Calcular TDEE lineal (Harris-Benedict)
                    let tmbAproximado = (window.userGender === 'male')
                        ? (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 175)) - (5 * (window.userAge || 30)) + 5
                        : (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 165)) - (5 * (window.userAge || 30)) - 161;

                    tdeeDelDia = tmbAproximado * (window.userActivityLevel || 1.375);
                }
            } else {
                // Fallback a lineal (datos no disponibles)
                const semanasActivas = window.semanaGlobalActual - semanaGlobalInicial -
                    semanasPausa.filter(p => p.mes < mes || (p.mes === mes && p.semanaLocal < semana)).length;

                pesoEstimadoInicioSemana = pesoInicialFase + (cambioPesoPorSemana * semanasActivas);
                pesoEstimadoFinSemana = pesoEstimadoInicioSemana + cambioPesoPorSemana;

                // Calcular TDEE lineal
                let tmbAproximado = (window.userGender === 'male')
                    ? (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 175)) - (5 * (window.userAge || 30)) + 5
                    : (10 * pesoEstimadoInicioSemana) + (6.25 * (window.userHeightCm || 165)) - (5 * (window.userAge || 30)) - 161;

                tdeeDelDia = tmbAproximado * (window.userActivityLevel || 1.375);
            }


            // --- üî• AJUSTE ESPECIAL PARA PAUSAS METAB√ìLICAS ---
            if (esPausaMetabolicaFase || esPausaMetabolicaSemana) {
                const nivelAFElement = document.getElementById('activity');
                let nivelAF = 1.375; // Valor por defecto

                if (nivelAFElement) {
                    nivelAF = parseFloat(nivelAFElement.value) || 1.375;
                } else {
                    console.warn("Elemento 'activity' no encontrado. Usando nivelAF por defecto (1.375)");
                }

                // Si el nivel de actividad es > 1.33, ajustamos el TDEE para pausa
                if (nivelAF > 1.33) {
                    // Primero calculamos el BMR (Metabolismo Basal)
                    const bmr = tdeeDelDia / nivelAF;

                    // Luego calculamos el TDEE para pausa usando factor 1.33
                    tdeeDelDia = bmr * 1.33;

                    console.log(`üîÑ Ajuste de pausa metab√≥lica: nivelAF=${nivelAF.toFixed(2)} ‚Üí TDEE recalculado=${tdeeDelDia.toFixed(0)} kcal`);
                }
                // Si nivelAF <= 1.33, no se necesita ajuste (ya est√° en mantenimiento)
            }

            const datosDias = [];

            // --- Generar datos por d√≠a ---
            for (let diaIndex = 0; diaIndex < 7; diaIndex++) {
                const diaNombre = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'][diaIndex];
                const diaNumero = diaIndex + 1;

                // --- üî• Calor√≠as diarias (cr√≠tico: NO sumar ajuste en no lineal) ---
                let caloriasDiarias = tdeeDelDia;

                // Solo en MODO LINEAL y NO en pausa, aplicar ajuste cal√≥rico
                if (!useNonLinear && !(esPausaMetabolicaFase || esPausaMetabolicaSemana) &&
                    window.weeklyCalorieDiffManualGlobal !== null) {
                    const ajusteDiarioKcal = Number(document.getElementById('weekly-calorie-diff')?.value || 0) / 7;
                    caloriasDiarias = tdeeDelDia + ajusteDiarioKcal;
                }

                let proteinasPctDia = proteinasPctPromedio;
                let carbohidratosPctDia = carbohidratosPctPromedio;
                let grasasPctDia = grasasPctPromedio;
                let notasEstrategias = [];

                if (!(esPausaMetabolicaFase || esPausaMetabolicaSemana)) {
                    if (estrategiasActivas.includes('refeed') && diaNombre === 'Domingo') {
                        carbohidratosPctDia = Math.min(95, carbohidratosPctDia + 20);
                        grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                        caloriasDiarias = Math.round(caloriasDiarias * 1.05);
                        notasEstrategias.push('D√≠a de Refeed');
                    }
                    if (estrategiasActivas.includes('carb_cycling') && (diaNumero % 2 === 0)) {
                        carbohidratosPctDia = Math.min(90, carbohidratosPctDia + 15);
                        grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                        notasEstrategias.push('D√≠a alto en HC (Carb Cycling)');
                    }
                    if (estrategiasActivas.includes('protein_cycling') && diaNombre === 'Domingo') {
                        proteinasPctDia = Math.max(15, proteinasPctDia - 10);
                        grasasPctDia = 100 - proteinasPctDia - carbohidratosPctDia;
                        notasEstrategias.push('D√≠a bajo en prote√≠na (Protein Cycling)');
                    }
                    if (estrategiasActivas.includes('ckd') && (diaNombre === 'S√°bado' || diaNombre === 'Domingo')) {
                        carbohidratosPctDia = Math.min(95, carbohidratosPctDia + 30);
                        grasasPctDia = Math.max(2, 100 - proteinasPctDia - carbohidratosPctDia);
                        caloriasDiarias = Math.round(caloriasDiarias * 1.1);
                        notasEstrategias.push('D√≠a de Carb-Loading (CKD)');
                    }
                    if (estrategiasActivas.includes('tkd') && ['Lunes', 'Mi√©rcoles', 'Viernes'].includes(diaNombre)) {
                        carbohidratosPctDia = Math.min(85, carbohidratosPctDia + 10);
                        grasasPctDia = Math.max(5, 100 - proteinasPctDia - carbohidratosPctDia);
                        notasEstrategias.push('Targeted Keto (TKD)');
                    }
                }

                if (estrategiasActivas.includes('if_16_8')) notasEstrategias.push('IF 16:8 aplicado');
                if (estrategiasActivas.includes('timing')) notasEstrategias.push('Timing Nutricional');
                if (estrategiasActivas.includes('flexible_dieting')) notasEstrategias.push('Flexible Dieting (80/20)');
                if (estrategiasActivas.includes('hiperproteica')) {
                    const proteinasMinimas = pesoEstimadoInicioSemana * 1.8;
                    if ((caloriasDiarias * proteinasPctDia / 100) / 4 < proteinasMinimas) {
                        proteinasPctDia = Math.round((proteinasMinimas * 4 / caloriasDiarias) * 100);
                        grasasPctDia = 100 - proteinasPctDia - carbohidratosPctDia;
                        notasEstrategias.push('Ajuste por Hiperproteica (1.8-2.5g/kg prote√≠na)');
                    }
                    notasEstrategias.push('Dieta Hiperproteica');
                }

                const totalPct = proteinasPctDia + carbohidratosPctDia + grasasPctDia;
                if (Math.abs(totalPct - 100) > 0.1) {
                    const diff = 100 - totalPct;
                    grasasPctDia += diff;
                    console.warn(`Porcentajes ajustados en Semana ${semanaGlobalActual}, D√≠a ${diaNombre} para sumar 100%.`);
                }

                const proteinas_g = Math.round((caloriasDiarias * proteinasPctDia / 100) / 4);
                const carbohidratos_g = Math.round((caloriasDiarias * carbohidratosPctDia / 100) / 4);
                const grasas_g = Math.round((caloriasDiarias * grasasPctDia / 100) / 9);

                const limiteCaloriasMin = window.userGender === 'female' ? 1200 : 1500;
                if (caloriasDiarias < limiteCaloriasMin) {
                    console.warn(`Calor√≠as ajustadas en Semana ${semanaGlobalActual}, D√≠a ${diaNombre} por debajo del l√≠mite (${limiteCaloriasMin}).`);
                    caloriasDiarias = limiteCaloriasMin;
                }

                let notasDia = esPausaMetabolicaFase || esPausaMetabolicaSemana
                    ? `Pausa metab√≥lica: ${datosFase.observaciones || 'Mantener calor√≠as al nivel de TDEE, reducir intensidad de entrenamiento.'}`
                    : `Basado en ${useNonLinear ? 'TDEE del modelo no lineal (ya ajustado)' : 'TDEE estimado'} (${tdeeDelDia.toFixed(0)} kcal)${useNonLinear ? '' : ' y ajuste objetivo'}.`;

                if (!useNonLinear && !(esPausaMetabolicaFase || esPausaMetabolicaSemana) && window.weeklyCalorieDiffManualGlobal !== null) {
                    notasDia += ` Ajuste diario: ${window.weeklyCalorieDiffManualGlobal > 0 ? '+' : ''}${(window.weeklyCalorieDiffManualGlobal / 7).toFixed(0)} kcal.`;
                }
                if (notasEstrategias.length > 0) {
                    notasDia += ` Estrategias aplicadas: ${notasEstrategias.join(', ')}.`;
                }

                // --- A√±adir datos del d√≠a ---
                datosDias.push({
                    dia: diaNombre,
                    actividad: window.userActivityLevel || 1.375,
                    calorias: Math.round(caloriasDiarias),
                    proteinasPct: Math.round(proteinasPctDia),
                    carbohidratosPct: Math.round(carbohidratosPctDia),
                    grasasPct: Math.round(grasasPctDia),
                    proteinas: proteinas_g,
                    carbohidratos: carbohidratos_g,
                    grasas: grasas_g,
                    pesoEstimado: parseFloat(pesoEstimadoInicioSemana.toFixed(2)),
                    estrategias: notasEstrategias.join(', '),
                    notas: notasDia
                });
            }

            const esPausaMetabolica6Semana = (window.semanaGlobalActual % 6 === 0); // ‚úÖ Cada 6 semanas
            datosSemanas.push({
                semana: window.semanaGlobalActual,
                semanaEnMes: semanaEnMes,
                esPausaMetabolica: esPausaMetabolicaFase || esPausaMetabolica6Semana || esPausaMetabolicaSemana,
                pesoInicioSemana: parseFloat(pesoEstimadoInicioSemana.toFixed(2)),
                pesoFinSemana: parseFloat(pesoEstimadoFinSemana.toFixed(2)),
                dias: datosDias
            });

            // ‚úÖ Solo restar si no es pausa
            if (!esPausaMetabolicaSemana) {
                semanasRestantes--;
            }
        }

        datosPorMes.push({
            mes: mes,
            semanas: datosSemanas
        });
    }

    if (datosPorMes.length === 0) {
        console.error("No se generaron datos de meses:", { mesInicio, mesFin, semanasEnFase, semanasPausaEstaFase });
    }

    return {
        datosPorMes: datosPorMes,
        estrategiasDisponibles: estrategiasDisponibles,
        semanasTotalesPlan: semanasTotalesPlan
    };
}

///////!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!Ultima seccion Calculos segun Objetivo!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
let chartInstance = null;
let weeklyMacros = [];

function toggleOpcionesObjetivo() {
    const objetivo = document.getElementById('objetivo').value;
    // IDs de las secciones a ocultar/mostrar
    const opciones = {
        'perdida1': 'opcionesPerdida1',
        'ganancia1': 'opcionesGanancia1',
        'mantenimiento1': 'opcionesMantenimiento1',
        'mixto1': 'opcionesMixto1'
    };

    // Ocultar todas las secciones primero
    Object.values(opciones).forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.display = 'none';
        } else {
            console.warn(`Elemento con ID '${id}' no encontrado.`);
        }
    });


    Object.values(opciones).forEach(id => document.getElementById(id).style.display = 'none');
    if (opciones[objetivo]) document.getElementById(opciones[objetivo]).style.display = 'block';

    // Resetear checkboxes
    document.querySelectorAll('.strategy-checkboxes input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = checkbox.value === 'ninguna';
    });
}


function validarEntradas() {
    let valido = true;

    // Verificar suma de macros = 100%
    const p = parseInt(document.getElementById("protein-percentage")?.value || 0);
    const c = parseInt(document.getElementById("carb-percentage")?.value || 0);
    const f = parseInt(document.getElementById("fat-percentage")?.value || 0);
    const total = p + c + f;

    const errorMacros = document.getElementById("errorMacros");
    if (total !== 100) {
        valido = false;
        if (errorMacros) {
            errorMacros.style.display = "block";
            errorMacros.innerText = "‚ö†Ô∏è La suma de macronutrientes debe ser 100% (actual: " + total + "%).";
        } else {
            console.warn("Falta el contenedor #errorMacros en el HTML");
        }
    } else if (errorMacros) {
        errorMacros.style.display = "none";
    }

    // Validar distribuci√≥n de comidas = 100%
    const b = parseInt(document.getElementById("breakfast-perc")?.value || 0);
    const s1 = parseInt(document.getElementById("snack1-perc")?.value || 0);
    const l = parseInt(document.getElementById("lunch-perc")?.value || 0);
    const s2 = parseInt(document.getElementById("snack2-perc")?.value || 0);
    const d = parseInt(document.getElementById("dinner-perc")?.value || 0);
    const totalMeals = b + s1 + l + s2 + d;

    const errorMeals = document.getElementById("errorMeals");
    if (totalMeals !== 100) {
        valido = false;
        if (errorMeals) {
            errorMeals.style.display = "block";
            errorMeals.innerText = "‚ö†Ô∏è La distribuci√≥n de comidas debe sumar 100% (actual: " + totalMeals + "%).";
        } else {
            console.warn("Falta el contenedor #errorMeals en el HTML");
        }
    } else if (errorMeals) {
        errorMeals.style.display = "none";
    }

    return valido;
}



function calcularTMB(peso, altura, edad, sexo) {
    return sexo === 'Masculino' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
}

//function getSelectedStrategies(prefix) {
//return Array.from(document.querySelectorAll(`#${prefix} input[type="checkbox"]:checked`)).map(checkbox => checkbox.value).filter(val => val !== 'ninguna');
//}

// Corregido: Asegurarse de que el contenedor tiene un ID √∫nico y se usa correctamente
//function getSelectedStrategies(containerId) {
// Selecciona checkboxes dentro del contenedor espec√≠fico
// const container = document.getElementById(containerId);
// if (!container) {
// console.warn(`Contenedor ${containerId} no encontrado para estrategias.`);
// return ['ninguna']; // Valor por defecto si no se encuentra
//}
// const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
//const strategies = Array.from(checkedBoxes).map(checkbox => checkbox.value).filter(val => val !== 'ninguna');
// return strategies.length > 0 ? strategies : ['ninguna'];
//}
/**
* Obtiene las estrategias seleccionadas seg√∫n el objetivo.
* @returns {Array<string>} Un array con los valores de las estrategias seleccionadas.
*                          Si no hay ninguna seleccionada (adem√°s de 'ninguna'), devuelve ['ninguna'].
*/
function getSelectedStrategies() {
    const objetivo = document.getElementById('objetivo').value;
    let containerId = '';

    // Determinar el ID del contenedor de checkboxes basado en el objetivo
    switch (objetivo) {
        case 'perdida1':
            containerId = 'opcionesPerdida1';
            break;
        case 'ganancia1':
            containerId = 'opcionesGanancia1';
            break;
        case 'mantenimiento1':
            containerId = 'opcionesMantenimiento1';
            break;
        case 'mixto1':
            containerId = 'opcionesMixto1';
            break;
        default:
            console.warn('Objetivo no reconocido para obtener estrategias:', objetivo);
            return ['ninguna'];
    }

    // Seleccionar el contenedor
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Contenedor de estrategias '${containerId}' no encontrado.`);
        return ['ninguna'];
    }

    // Obtener checkboxes marcados dentro del contenedor
    const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');

    // Extraer los valores, excluyendo 'ninguna'
    const strategies = Array.from(checkedBoxes)
        .map(checkbox => checkbox.value)
        .filter(val => val !== 'ninguna');

    // Si no hay estrategias seleccionadas (adem√°s de 'ninguna'), devolver ['ninguna']
    return strategies.length > 0 ? strategies : ['ninguna'];
}

/**
* Calcula los macronutrientes basados en objetivo, fase y estrategias.
* @param {number} peso - El peso del usuario en kg.
* @param {number} gastoEnergetico - El TDEE (Gasto Energ√©tico Total) calculado.
* @param {string} objetivo - El objetivo seleccionado ('perdida1', 'ganancia1', etc.).
* @returns {Object|null} Un objeto con los resultados del c√°lculo o null si hay error.
*/
function formatearNombreCodigo(codigo) {
    const mapaCodigos = {
        // Objetivos
        'perdida1': 'p√©rdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        // Fases de P√©rdida
        'induccion_cetogenica1': 'inducci√≥n cetog√©nica',
        'ciclado_metabolico1': 'ciclado metab√≥lico',
        'transicion_mantenimiento1': 'transici√≥n a mantenimiento',
        'ketoadaptation': 'ketoadaptaci√≥n',
        // Fases de Ganancia
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        // Enfoques de Mantenimiento
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social',
        // Fases de Mixto (asumiendo que pueden reusar algunos nombres o tienen espec√≠ficos)
        // Puedes a√±adir m√°s mapeos aqu√≠ si es necesario
        // Por defecto, intentar formatear el c√≥digo si no est√° en el mapa
    };

    if (mapaCodigos[codigo]) {
        return mapaCodigos[codigo];
    }

    // Formateo b√°sico por si acaso: reemplazar guiones bajos por espacios y convertir a min√∫sculas
    // Esto ayuda si se a√±aden nuevas fases sin actualizar el mapa.
    return codigo ? codigo.replace(/_/g, ' ') : 'no especificado';
}
/**
 * Calcula los macronutrientes basados en objetivo, fase y estrategias.
 * @param {number} peso - El peso del usuario en kg.
 * @param {number} gastoEnergetico - El TDEE (Gasto Energ√©tico Total) calculado.
 * @param {string} objetivo - El objetivo seleccionado ('perdida1', 'ganancia1', etc.).
 * @returns {Object|null} Un objeto con los resultados del c√°lculo o null si hay error.
 */

function calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase) {
    // Validar entrada
    if (isNaN(peso) || isNaN(gastoEnergetico) || !objetivo || peso <= 0 || gastoEnergetico <= 0) {
        console.error("Entrada inv√°lida en calcularMacronutrientes", { peso, gastoEnergetico, objetivo, fase });
        return null;
    }

    // === 1. Definir rangos de macronutrientes por OBJETIVO y FASE ===
    const macroRanges = {
        // --- P√©rdida de peso ---
        perdida1: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [70, 75] },
        induccion_cetogenica1: { proteinas: [20, 25], carbohidratos: [5, 10], grasas: [70, 75] },
        ciclado_metabolico1: { proteinas: [22, 28], carbohidratos: [8, 20], grasas: [60, 70] },
        transicion_mantenimiento1: { proteinas: [25, 30], carbohidratos: [20, 25], grasas: [40, 50] },

        // --- Ganancia de peso ---
        ganancia1: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [25, 35] },
        volumen1: { proteinas: [25, 30], carbohidratos: [40, 50], grasas: [25, 35] },
        masa1: { proteinas: [25, 30], carbohidratos: [35, 45], grasas: [30, 35] },

        // --- Mantenimiento ---
        mantenimiento1: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
        equilibrio1: { proteinas: [20, 25], carbohidratos: [35, 45], grasas: [30, 35] },
        social1: { proteinas: [20, 25], carbohidratos: [30, 50], grasas: [25, 40] }, // m√°s flexible

        // --- Mixto/Combinado ---
        mixto1: { proteinas: [20, 25], carbohidratos: [30, 40], grasas: [35, 50] },
        definicion1: { proteinas: [25, 35], carbohidratos: [10, 25], grasas: [40, 55] },
        // 'volumen1' ya est√° definido arriba
        // 'mantenimiento1' tambi√©n
    };

    // === 2. Decidir qu√© c√≥digo usar: fase > objetivo
    const codigo = fase && fase !== 'sel' && macroRanges[fase] ? fase : objetivo;

    // === 3. Obtener rangos
    const ranges = macroRanges[codigo] || macroRanges[objetivo] || {
        proteinas: [25, 30],
        carbohidratos: [40, 50],
        grasas: [25, 35]
    };

    // === 4. Calcular porcentajes promedio (usamos el valor ajustado ya en gastoEnergetico)
    const proteinasPct = Math.round((ranges.proteinas[0] + ranges.proteinas[1]) / 2);
    const carbohidratosPct = Math.round((ranges.carbohidratos[0] + ranges.carbohidratos[1]) / 2);
    const grasasPct = 100 - proteinasPct - carbohidratosPct;

    // Validar grasas
    if (grasasPct < 15) {
        const diff = 15 - grasasPct;
        carbohidratosPct = Math.max(0, carbohidratosPct - diff);
        grasasPct = 15;
    }

    // === 5. Calor√≠as: usamos el gastoEnergetico (ya ajustado por fase/objetivo)
    const calorias = gastoEnergetico; // ‚úÖ Este es el valor final ajustado

    // === 6. Calcular gramos
    const proteinas = Math.round((calorias * proteinasPct / 100) / 4);
    const carbohidratos = Math.round((calorias * carbohidratosPct / 100) / 4);
    const grasas = Math.round((calorias * grasasPct / 100) / 9);

    // === 7. Validaci√≥n
    if (isNaN(proteinas) || isNaN(carbohidratos) || isNaN(grasas) || proteinas < 0 || carbohidratos < 0 || grasas < 0) {
        console.error("Errores en c√°lculo de macros", { calorias, proteinasPct, carbohidratosPct, grasasPct });
        return null;
    }
    const mapaCodigos1 = {
        // Objetivos
        'perdida1': 'p√©rdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        // Fases de P√©rdida
        'induccion_cetogenica1': 'inducci√≥n cetog√©nica',
        'ciclado_metabolico1': 'ciclado metab√≥lico',
        'transicion_mantenimiento1': 'transici√≥n a mantenimiento',
        'ketoadaptation': 'ketoadaptaci√≥n',
        // Fases de Ganancia
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        // Fases de Mantenimiento
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social'
    };
    // === 8. Recomendaciones personalizadas
    const objetivoLegible = mapaCodigos1[objetivo] || objetivo;
    const faseLegible = mapaCodigos1[codigo] || codigo;

    let recomendaciones = `Basado en tu objetivo de <strong>${objetivoLegible}</strong> y fase <strong>${faseLegible}</strong>.<br><br>`;
    recomendaciones += `<strong>Distribuci√≥n de macronutrientes:</strong><br>`;
    recomendaciones += `‚Ä¢ <strong>Prote√≠nas:</strong> ${proteinasPct}% (${proteinas} g, ${peso ? (proteinas / peso).toFixed(1) : '?'} g/kg)<br>`;
    recomendaciones += `‚Ä¢ <strong>Carbohidratos:</strong> ${carbohidratosPct}% (${carbohidratos} g)<br>`;
    recomendaciones += `‚Ä¢ <strong>Grasas:</strong> ${grasasPct}% (${grasas} g)<br><br>`;

    // Notas por objetivo
    if (objetivo === 'perdida1') {
        recomendaciones += `<em>Enfoque en preservar masa muscular con prote√≠na adecuada y ajuste progresivo del d√©ficit.</em>`;
    } else if (objetivo === 'ganancia1') {
        recomendaciones += `<em>Super√°vit controlado para maximizar la hipertrofia con m√≠nimo almacenamiento graso.</em>`;
    } else if (objetivo === 'mantenimiento1') {
        recomendaciones += `<em>Equilibrio sostenible con flexibilidad para mantener adherencia a largo plazo.</em>`;
    } else if (objetivo === 'mixto1') {
        recomendaciones += `<em>Plan c√≠clico: alterna fases de volumen, definici√≥n y mantenimiento para optimizar progresi√≥n.</em>`;
    }

    // === 9. Devolver resultados
    return {
        calorias,
        proteinas,
        carbohidratos,
        grasas,
        proteinasPct,
        carbohidratosPct,
        grasasPct,
        recomendaciones,
        faseUsada: faseLegible,
        codigoUsado: codigo
    };
}


// --- Aseg√∫rate de que getCombinedRangesConModal est√© definida en el mismo archivo o cargada antes ---
// Si no la tienes definida por separado, aqu√≠ la incluyo para que funcione:

/**
 * (Definici√≥n de getCombinedRangesConModal)
 * Esta funci√≥n debe estar disponible globalmente o definida antes de ser usada por calcularMacronutrientes.
 * Combina los rangos de macronutrientes de m√∫ltiples estrategias y maneja incompatibilidades con un modal.
 * @param {Array<string>} strategies - Array de nombres de estrategias seleccionadas.
 * @param {Object} estrategiaMap - El mapa de estrategias con sus rangos.
 * @param {string} contexto - "macros" o "plan" para determinar d√≥nde mostrar el error.
 * @returns {Object|null} Un objeto con los rangos combinados o null si son incompatibles.
 */
function getCombinedRangesConModal(strategies, estrategiaMap, contexto = "plan") {
    if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
        return estrategiaMap.ninguna;
    }

    const activeStrats = strategies.filter(s => s !== 'ninguna');
    if (activeStrats.length === 0) return estrategiaMap.ninguna;

    try {
        const combinedRanges = {
            grasas: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
            ],
            proteinas: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
            ],
            carbohidratos: [
                Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
            ],
            deficit: [ // Para d√©ficit/super√°vit
                Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
            ],
            notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
        };

        // Validar que los rangos combinados sean v√°lidos
        const rangosInvalidos = {};
        let hayIncompatibilidad = false;
        for (const [macro, rango] of Object.entries(combinedRanges)) {
            // 'notas' y 'deficit' no se validan como rangos de porcentajes
            if (macro !== 'notas' && macro !== 'deficit' && rango[0] > rango[1]) {
                rangosInvalidos[macro] = rango;
                hayIncompatibilidad = true;
            }
        }

        if (hayIncompatibilidad) {
            console.error('Rangos de macronutrientes incompatibles detectados:', rangosInvalidos);
            // Llamar al modal de incompatibilidad SOLO si es para macros
            if (contexto === "macros") {
                mostrarModalIncompatibilidad(activeStrats, rangosInvalidos);
            }
            // Devolver null para indicar error al c√≥digo que llam√≥ a esta funci√≥n
            return null;
        }

        return combinedRanges;
    } catch (error) {
        console.error('Error al combinar rangos de estrategias:', error, strategies);
        return null;
    }
}

// --- Aseg√∫rate tambi√©n de que formatearNombreCodigo est√© definida ---
// Si no la tienes, aqu√≠ la incluyo:

/**
 * Formatea los c√≥digos internos de objetivo y fase a nombres legibles.
 * @param {string} codigo - El c√≥digo interno (e.g., 'perdida1', 'induccion_cetogenica1').
 * @returns {string} El nombre formateado (e.g., 'p√©rdida de peso', 'inducci√≥n cetog√©nica').
 */
/**
* Formatea un c√≥digo interno en un nombre legible para el usuario.
* @param {string} codigo - El c√≥digo interno a formatear.
* @returns {string} El nombre legible.
*/
function formatearNombreCodigo(codigo) {
    // --- Mejora: Asegurar que el c√≥digo sea un string ---
    if (typeof codigo !== 'string') {
        console.warn(`[Formateador] C√≥digo no es string:`, codigo);
        return 'no especificado';
    }

    const mapaCodigos = {
        // Objetivos
        'perdida1': 'p√©rdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        // Fases de P√©rdida
        'induccion_cetogenica1': 'inducci√≥n cetog√©nica',
        'ciclado_metabolico1': 'ciclado metab√≥lico',
        'transicion_mantenimiento1': 'transici√≥n a mantenimiento',
        'ketoadaptation': 'ketoadaptaci√≥n',
        // Fases de Ganancia
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        // Enfoques de Mantenimiento
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social',
        // Estrategias (si quieres que se formateen en las recomendaciones)
        'ninguna': 'Ninguna',
        'tkd': 'TKD',
        'ckd': 'CKD',
        'if_16_8': 'IF 16:8',
        'refeed': 'Refeed',
        'hiperproteica': 'Hiperproteica',
        'carb_cycling': 'Carb Cycling',
        'protein_cycling': 'Protein Cycling',
        'timing': 'Timing Nutricional',
        'flexible_dieting': 'Flexible Dieting',
        'induccion_cetogenica': 'Inducci√≥n Cetog√©nica', // A√±adido
        'baja_en_hc': 'Baja en HC', // A√±adido
        'hipercalorica': 'Hipercal√≥rica', // A√±adido
        'equilibrada_nutricional': 'Equilibrada Nutricional', // A√±adido
        'calorie_cycling': 'Calorie Cycling', // A√±adido
        'protein_cycling': 'Protein Cycling', // A√±adido
        'carb_loading': 'Carb-loading', // A√±adido
        'mft': 'MFT', // A√±adido
        'reverse_dieting': 'Reverse Dieting', // A√±adido
        'adaptive_periodization': 'Adaptive Periodization', // A√±adido
        'metabolic_flexibility_training': 'Metabolic Flexibility Training', // A√±adido
        // Por defecto, intentar formatear el c√≥digo si no est√° en el mapa
    };

    // --- Mejora: Intentar formatear el c√≥digo si no est√° en el mapa ---
    if (mapaCodigos[codigo]) {
        return mapaCodigos[codigo];
    }

    // Si no est√° en el mapa, intentar una formateo b√°sico:
    // Reemplazar _ por espacio, capitalizar primera letra de cada palabra
    try {
        return codigo.replace(/_/g, ' ')
            .replace(/\b\w/g, function (char) { return char.toUpperCase(); });
    } catch (e) {
        console.error(`[Formateador] Error al formatear c√≥digo '${codigo}':`, e);
        return codigo ? codigo.replace(/_/g, ' ') : 'no especificado';
    }
}


function crearGrafico(datos) {
    const ctx = document.getElementById('chartMacros').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Grasas', 'Prote√≠nas', 'Carbohidratos'],
            datasets: [{
                data: datos,
                backgroundColor: ['#4CAF50', '#2196F3', '#FF9800'],
                borderColor: ['#388E3C', '#1976D2', '#F57C00'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { color: '#333', font: { size: 12 } } },
                tooltip: { callbacks: { label: function (context) { return `${context.label}: ${context.raw}%`; } } }
            }
        }
    });
}

function actualizarUI(resultados, gastoEnergetico) {
    if (!resultados) return;
    document.getElementById('gastoEnergetico').textContent = document.getElementById('get-calories').value//gastoEnergetico.toLocaleString('es-ES');
    document.getElementById('calorias').textContent = resultados.calorias.toLocaleString('es-ES');
    document.getElementById('proteinas').textContent = resultados.proteinas;
    document.getElementById('proteinasPct').textContent = resultados.proteinasPct;
    document.getElementById('carbohidratos').textContent = resultados.carbohidratos;
    document.getElementById('carbohidratosPct').textContent = resultados.carbohidratosPct;
    document.getElementById('grasas').textContent = resultados.grasas;
    document.getElementById('grasasPct').textContent = resultados.grasasPct;
    document.getElementById('recomendaciones').innerHTML = resultados.recomendaciones;
    document.getElementById('resultados').style.display = 'block';
    if (typeof Chart !== 'undefined') {
        crearGrafico([resultados.grasasPct, resultados.proteinasPct, resultados.carbohidratosPct]);
    } else {
        console.error('Chart.js no est√° disponible.');
        document.getElementById('errorMessage').textContent = 'No se pudo cargar el gr√°fico. Verifique su conexi√≥n a internet.';
        document.getElementById('errorMessage').style.display = 'block';
    }
    document.getElementById('planificacionTemporal').style.display = 'block';
    actualizarPlanificacion();
    // Mostrar/Ocultar secci√≥n de planificaci√≥n
    document.getElementById('planificacionTemporal').style.display = 'block';

    // --- NUEVO: Mostrar la Tabla General del Proceso ---
    // Esta funci√≥n crear√°/mostrar√° la tabla general SI los datos del Paso 6 est√°n disponibles
    mostrarTablaGeneralProceso('tablaGeneralProcesoContainer');
    // -----------------------------------------------

    // Actualizar la tabla semanal detallada (la actual)
    actualizarPlanificacion();
}

function crearSemana(semanaNum, fase, dieta, estrategias, calorias, proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas) {
    if (!validarEntradas(parseFloat(document.getElementById('weight').value), parseFloat(document.getElementById('height').value), parseFloat(document.getElementById('age').value), calorias, proteinasPct, carbohidratosPct, grasasPct)) {
        return null;
    }
    const proteinas = Math.round((calorias * proteinasPct / 100) / 4);
    const carbohidratos = Math.round((calorias * carbohidratosPct / 100) / 4);
    const grasas = Math.round((calorias * grasasPct / 100) / 9);
    if (grasas < 0 || isNaN(grasas) || proteinas < 0 || isNaN(proteinas) || carbohidratos < 0 || isNaN(carbohidratos)) {
        document.getElementById('errorMessage').textContent = `Error en Semana ${semanaNum}: Error en el c√°lculo de macronutrientes. Verifique los valores.`;
        document.getElementById('errorMessage').style.display = 'block';
        return null;
    }
    return { semana: `Sem ${semanaNum}`, fase, dieta, estrategias, calorias, proteinasPct, carbohidratosPct, grasasPct, proteinas, carbohidratos, grasas, entrenoDias, notas };
}

// --- Reemplaza tu funci√≥n generarPlanPerdida actual con esta ---
function generarPlanPerdida(periodo, peso, gastoEnergetico) {
    const plan = [];

    /// --- 1. Obtener selecciones del usuario ---
    const fasePerdida = document.getElementById('fasePerdida1')?.value || 'induccion_cetogenica1';
    const estrategiasPerdida = getSelectedStrategies(); // Asumiendo que esta funci√≥n ya maneja el objetivo 'perdida1'

    // --- 2. Validaci√≥n b√°sica ---
    if (!gastoEnergetico || gastoEnergetico <= 0) {
        console.error("Gasto energ√©tico inv√°lido para generar plan de p√©rdida.");
        return plan;
    }


    // --- 3. Definir constantes ---
    const semanas = periodo === 'mensual' ? 12 : 4;
    // Mapa de nombres formateados para las fases
    const nombresFase = {
        'induccion_cetogenica1': 'Inducci√≥n Cetog√©nica',
        'ciclado_metabolico1': 'Ciclado Metab√≥lico',
        'transicion_mantenimiento1': 'Transici√≥n a Mantenimiento',
        'ketoadaptation': 'Ketoadaptation'
    };
    const nombreFaseLegible = nombresFase[fasePerdida] || 'Fase no especificada';

    // --- 4. Definir el mapa de estrategias (debe coincidir con el de calcularMacronutrientes) ---
    const estrategiaMap = {
        ninguna: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: 'Cetosis estricta <50g HC/d√≠a' },
        tkd: { grasas: [65, 70], proteinas: [20, 25], carbohidratos: [8, 12], deficit: [0.8, 0.85], nota: '25-50g HC pre/post entreno' },
        ckd: { grasas: [60, 70], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.85, 0.9], nota: '2 d√≠as carb-loading (150-200g HC)' },
        if_16_8: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 15], deficit: [0.75, 0.85], nota: 'Ventana de alimentaci√≥n 8 horas' },
        refeed: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.9, 0.95], nota: '1-2 d√≠as/semana HC alto' },
        hiperproteica: { grasas: [60, 65], proteinas: [28, 32], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: '2-2.5 g/kg peso prote√≠na' },
        carb_cycling: { grasas: [60, 70], proteinas: [22, 28], carbohidratos: [8, 20], deficit: [0.8, 0.9], nota: 'D√≠as altos (100-130g)/bajos HC (<50g)' },
        protein_cycling: { grasas: [60, 70], proteinas: [18, 30], carbohidratos: [5, 15], deficit: [0.8, 0.9], nota: '4 semanas altas + 1 baja prote√≠na' },
        timing: { grasas: [50, 60], proteinas: [28, 35], carbohidratos: [10, 20], deficit: [0.85, 0.9], nota: 'HC post-entreno' },
        flexible_dieting: { grasas: [30, 40], proteinas: [25, 35], carbohidratos: [30, 45], deficit: [0.9, 1.0], nota: '80/20 regla: 80% saludable, 20% flexible' }
    };


    // --- 5. Definir dietas base ---
    const dietasBase = {
        cetogenica: { nombre: 'Cetog√©nica', proteinasPct: 20, carbohidratosPct: 5, grasasPct: 75 },
        hiperproteica_dieta: { nombre: 'Hiperproteica', proteinasPct: 30, carbohidratosPct: 5, grasasPct: 65 }, // Valores base
        // Las dem√°s se derivar√°n de las estrategias o se usar√°n valores por defecto

        moderada_en_hc: { nombre: 'Moderada en HC', proteinasPct: 25, carbohidratosPct: 40, grasasPct: 35 },
        carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 20, grasasPct: 55 } // Valor base, se ajusta
        // Valor base, se ajusta
    };
    // --- 5. Definir dietas base ---
    const nombresDietas = {
        cetogenica: 'Cetog√©nica',
        protein_cycling_dieta: 'Protein Cycling',
        carb_cycling_dieta: 'Carb Cycling',
        hiperproteica_dieta: 'Hiperproteica',
        moderada_en_hc: 'Moderada en HC'


    };
    // --- 6. Determinar la dieta base principal ---
    // Prioridad: Hiperproteica y Protein Cycling como dietas base, luego Carb Cycling, luego Cetog√©nica por defecto.
    let dietaBaseKey = 'cetogenica'; // Valor por defecto para p√©rdida de peso
    if (estrategiasPerdida.includes('hiperproteica')) {
        dietaBaseKey = 'hiperproteica_dieta';
        // Esta estrategia define directamente la dieta base como Hiperproteica (2.5-3.0 g/kg peso prote√≠na)
    } else if (estrategiasPerdida.includes('protein_cycling')) {
        dietaBaseKey = 'hiperproteica_dieta'; // Protein Cycling se basa en una dieta hiperproteica
        // La variaci√≥n de prote√≠na se manejar√° semana a semana
    } else if (estrategiasPerdida.includes('carb_cycling')) {

        dietaBaseKey = 'carb_cycling_dieta';
    } else if (estrategiasPerdida.includes('flexible_dieting')) {
        dietaBaseKey = 'flexible_dieting_dieta';
        // Para Carb Cycling en fase de p√©rdida, la base puede seguir siendo cetogenica o moderada
        // pero la estrategia implica variar los carbohidratos.
        // Mantenemos cetogenica como base y ajustamos seg√∫n la estrategia.
        // Si prefieres una base espec√≠fica para carb cycling, def√≠nela en dietasBase y √∫sala aqu√≠.
    }
    // Para otras estrategias como 'ninguna', 'if_16_8', 'timing', 'flexible_dieting',
    // la base sigue siendo cetogenica en el contexto de una fase de p√©rdida de peso cetog√©nica o similar.
    // Las modificaciones espec√≠ficas se aplican semana a semana m√°s adelante.

    const nombreDietaBase = dietasBase[dietaBaseKey] ? dietasBase[dietaBaseKey].nombre : dietasBase['cetogenica'].nombre;

    // --- 7. Combinar rangos de estrategias para obtener par√°metros base ---
    function getCombinedParams(strategies) {
        if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
            return estrategiaMap.ninguna;
        }
        const activeStrats = strategies.filter(s => s !== 'ninguna');
        if (activeStrats.length === 0) return estrategiaMap.ninguna;

        try {
            const combinedRanges = {
                grasas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
                ],
                proteinas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
                ],
                carbohidratos: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
                ],
                deficit: [
                    Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                    Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
                ],
                notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
            };

            if (combinedRanges.grasas[0] > combinedRanges.grasas[1] ||
                combinedRanges.proteinas[0] > combinedRanges.proteinas[1] ||
                combinedRanges.carbohidratos[0] > combinedRanges.carbohidratos[1]) {
                console.error('Rangos de macronutrientes incompatibles al generar plan:', combinedRanges);
                return null; // Indicar error
            }
            return combinedRanges;
        } catch (error) {
            console.error('Error al combinar rangos para el plan:', error, strategies);
            return null;
        }
    }


    const paramsBase = getCombinedParams(estrategiasPerdida);
    if (!paramsBase) {
        // Manejar error
        return plan;
    }

    // --- 8. Generar semanas ---
    for (let i = 0; i < semanas; i++) {
        const semanaNum = i + 1;

        // --- Valores iniciales para la semana basados en estrategias combinadas ---
        let faseSemana = nombreFaseLegible;
        let dietaSemana = nombreDietaBase; // Empieza con la dieta base
        let proteinasPct = Math.round((paramsBase.proteinas[0] + paramsBase.proteinas[1]) / 2);
        let carbohidratosPct = Math.round((paramsBase.carbohidratos[0] + paramsBase.carbohidratos[1]) / 2);
        let grasasPct = 100 - proteinasPct - carbohidratosPct; // Asegurar 100%

        // Ajustar si grasas es negativo
        if (grasasPct < 0) {
            const diff = -grasasPct;
            carbohidratosPct = Math.max(0, carbohidratosPct - diff);
            grasasPct = 0;
        }

        let calMult = (paramsBase.deficit[0] + paramsBase.deficit[1]) / 2;
        let calorias = Math.round(gastoEnergetico * calMult);
        let entrenoDias = '4 d√≠as entreno, 3 d√≠as descanso'; // Valor por defecto
        let notasSemana = paramsBase.notas || 'Sin estrategias especiales';

        // --- 9. Aplicar modificaciones por estrategias espec√≠ficas en semanas espec√≠ficas ---

        // --- Refeed Semanal ---
        if (estrategiasPerdida.includes('refeed') && (semanaNum % 4 === 0 || semanaNum === semanas)) {
            // Aumentar carbohidratos, reducir grasas
            carbohidratosPct = Math.min(95, carbohidratosPct + 20); // Ejemplo de ajuste
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.0, calMult * 1.05); // Peque√±o aumento de calor√≠as
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta']; // Cambiar dieta para la semana
            notasSemana = `D√≠a de Refeed (${carbohidratosPct}% HC). ` + notasSemana;
            entrenoDias = 'D√≠a de Refeed';
        }
        // --- Carb Cycling (ej: semanas pares) ---
        else if (estrategiasPerdida.includes('carb_cycling') && (semanaNum % 2 === 0)) {
            // D√≠a alto en carbohidratos
            carbohidratosPct = Math.min(90, carbohidratosPct + 15); // Ejemplo de ajuste
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            notasSemana = `D√≠a alto HC (${carbohidratosPct}%). ` + notasSemana;
            entrenoDias = 'D√≠a alto HC';
        }
        // --- Protein Cycling (ej: cada 5 semanas) ---
        else if (estrategiasPerdida.includes('protein_cycling') && (semanaNum % 5 === 0)) {
            // Reducir prote√≠na
            const proteinasPctBaja = Math.max(15, proteinasPct - 10); // Ejemplo de ajuste
            proteinasPct = proteinasPctBaja;
            grasasPct = 100 - proteinasPct - carbohidratosPct; // Recalcular grasas
            notasSemana = `Semana baja prote√≠na (${proteinasPct}%). ` + notasSemana;
            entrenoDias = 'Entreno ligero esta semana';
        }
        // --- CKD (ej: semanas 4, 8, 12) ---
        else if (estrategiasPerdida.includes('ckd') && (semanaNum % 4 === 0)) {
            // Similar a refeed, pero m√°s extremo y espec√≠fico
            carbohidratosPct = Math.min(95, carbohidratosPct + 30); // Aumento muy alto
            grasasPct = Math.max(2, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.0, calMult * 1.1); // Aumento de calor√≠as
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta']; // Tambien alta en HC
            notasSemana = `CKD - 2 d√≠as carb-loading (150-200g HC). ` + notasSemana;
            entrenoDias = '2 d√≠as carb-loading';
        }

        // --- IF 16:8, TKD, Timing, Flexible Dieting ---
        // Estas estrategias afectan m√°s el timing o la adherencia que los macros brutos semanales.
        // Sus notas ya est√°n incluidas en paramsBase.notas. Podemos enfatizarlas:
        // else if (estrategiasPerdida.includes('if_16_8')) { ... }
        // else if (estrategiasPerdida.includes('tkd')) { ... }
        // else if (estrategiasPerdida.includes('timing')) { ... }
        // else if (estrategiasPerdida.includes('flexible_dieting')) { ... }

        // --- 10. Validaci√≥n final de calor√≠as ---
        // (Opcional, puedes reutilizar la l√≥gica de l√≠mites m√≠nimos si la ten√≠as)

        // --- 11. Crear objeto de semana ---
        const semanaObj = crearSemana(
            semanaNum,
            faseSemana, // Fase legible como "Inducci√≥n Cetog√©nica"
            dietaSemana, // Dieta derivada de estrategias como "Hiperproteica"
            estrategiasPerdida.join(', '), // Todas las estrategias aplicables
            calorias,
            proteinasPct,
            carbohidratosPct,
            grasasPct,
            entrenoDias,
            notasSemana // Notas espec√≠ficas de la semana + generales
        );

        if (semanaObj) {
            plan.push(semanaObj);
        }
    }

    return plan;
}



function generarPlanGanancia(periodo, peso, gastoEnergetico) {
    const plan = [];

    // --- 1. Obtener selecciones del usuario ---
    const estrategiasGanancia = getSelectedStrategies(); // Usar tu funci√≥n que ya funciona
    // Para ganancia, no hay una "fase" como tal en tu HTML, pero podemos definir un nombre gen√©rico
    const faseGanancia = 'Volumen Muscular'; // O como se defina en tu contexto

    // --- 2. Validaci√≥n b√°sica ---
    if (!gastoEnergetico || gastoEnergetico <= 0) {
        console.error("Gasto energ√©tico inv√°lido para generar plan de ganancia.");
        return plan;
    }

    // --- 3. Definir constantes ---
    const semanas = periodo === 'mensual' ? 12 : 4;

    // --- 4. Definir el mapa de estrategias (debe coincidir con el de calcularMacronutrientes) ---
    const estrategiaMap = {

        ninguna: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: 'Cetosis estricta <50g HC/d√≠a' },
        tkd: { grasas: [65, 70], proteinas: [20, 25], carbohidratos: [8, 12], deficit: [0.8, 0.85], nota: '25-50g HC pre/post entreno' },
        ckd: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.85, 0.9], nota: '2 d√≠as carb-loading (150-200g HC)' },
        if_16_8: { grasas: [70, 75], proteinas: [20, 25], carbohidratos: [5, 15], deficit: [0.75, 0.85], nota: 'Ventana de alimentaci√≥n 8 horas' },
        refeed: { grasas: [60, 65], proteinas: [20, 25], carbohidratos: [12, 18], deficit: [0.9, 0.95], nota: '1-2 d√≠as/semana HC alto' },
        hiperproteica: { grasas: [60, 65], proteinas: [28, 32], carbohidratos: [5, 10], deficit: [0.8, 0.85], nota: '1.8-2.5 g/kg peso prote√≠na' },
        carb_cycling: { grasas: [60, 70], proteinas: [22, 28], carbohidratos: [8, 20], deficit: [0.8, 0.9], nota: 'D√≠as altos (100-130g)/bajos HC (<50g)' },
        protein_cycling: { grasas: [60, 70], proteinas: [18, 30], carbohidratos: [5, 15], deficit: [0.8, 0.9], nota: '4 semanas altas + 1 baja prote√≠na' },
        timing: { grasas: [50, 60], proteinas: [28, 35], carbohidratos: [10, 20], deficit: [0.85, 0.9], nota: 'HC post-entreno' },
        flexible_dieting: { grasas: [30, 40], proteinas: [25, 35], carbohidratos: [30, 45], deficit: [0.9, 1.0], nota: '80/20 regla: 80% saludable, 20% flexible' }

    };

    // --- 5. Definir dietas base ---
    const nombresDietas = {
        protein_cycling_dieta: 'Protein Cycling',
        carb_cycling_dieta: 'Carb Cycling',
        hiperproteica_dieta: 'Hiperproteica',
        moderada_en_hc: 'Moderada en HC',
        refeed_dieta: 'Refeed (Alta HC)',
        timing_dieta: 'Timing Nutricional',
        flexible_dieting_dieta: 'Flexible Dieting'
        //ckd: 'CDK 2 dias'

    };

    // --- 6. Determinar la dieta base principal ---
    let dietaBaseKey = ' protein_cycling_dieta'; // Valor por defecto para ganancia
    if (estrategiasGanancia.includes('carb_cycling')) {
        dietaBaseKey = 'carb_cycling_dieta';
    } else if (estrategiasGanancia.includes('refeed')) {
        dietaBaseKey = 'refeed_dieta';
    } else if (estrategiasGanancia.includes('timing')) {
        dietaBaseKey = 'timing_dieta';
    } else if (estrategiasGanancia.includes('flexible_dieting')) {
        dietaBaseKey = 'flexible_dieting_dieta';
    } else if (estrategiasGanancia.includes('protein_cycling')) {
        dietaBaseKey = 'moderada_en_hc';
    }
    const nombreDietaBase = nombresDietas[dietaBaseKey] || nombresDietas['protein_cycling_dieta'];

    // --- 7. Combinar rangos de estrategias para obtener par√°metros base ---
    function getCombinedParams(strategies) {
        if (!strategies || strategies.length === 0 || (strategies.length === 1 && strategies.includes('ninguna'))) {
            return estrategiaMap.ninguna;
        }
        const activeStrats = strategies.filter(s => s !== 'ninguna');
        if (activeStrats.length === 0) return estrategiaMap.ninguna;

        try {
            const combinedRanges = {
                grasas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].grasas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].grasas[1]))
                ],
                proteinas: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].proteinas[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].proteinas[1]))
                ],
                carbohidratos: [
                    Math.max(...activeStrats.map(s => estrategiaMap[s].carbohidratos[0])),
                    Math.min(...activeStrats.map(s => estrategiaMap[s].carbohidratos[1]))
                ],
                deficit: [ // En este contexto, deficit es super√°vit
                    Math.min(...activeStrats.map(s => estrategiaMap[s].deficit[0])),
                    Math.max(...activeStrats.map(s => estrategiaMap[s].deficit[1]))
                ],
                notas: activeStrats.map(s => estrategiaMap[s].nota).join('; ')
            };

            if (combinedRanges.grasas[0] > combinedRanges.grasas[1] ||
                combinedRanges.proteinas[0] > combinedRanges.proteinas[1] ||
                combinedRanges.carbohidratos[0] > combinedRanges.carbohidratos[1]) {
                console.error('Rangos de macronutrientes incompatibles al generar plan de ganancia:', combinedRanges);
                return null;
            }
            return combinedRanges;
        } catch (error) {
            console.error('Error al combinar rangos para el plan de ganancia:', error, strategies);
            return null;
        }
    }

    const paramsBase = getCombinedParams(estrategiasGanancia);
    if (!paramsBase) {
        console.error("No se pudieron combinar los par√°metros de las estrategias para el plan de ganancia.");
        return plan;
    }

    // --- 8. Generar semanas ---
    for (let i = 0; i < semanas; i++) {
        const semanaNum = i + 1;

        // --- Valores iniciales para la semana basados en estrategias combinadas ---
        let faseSemana = faseGanancia; // 'Volumen Muscular'
        let dietaSemana = nombreDietaBase;
        let proteinasPct = Math.round((paramsBase.proteinas[0] + paramsBase.proteinas[1]) / 2);
        let carbohidratosPct = Math.round((paramsBase.carbohidratos[0] + paramsBase.carbohidratos[1]) / 2);
        let grasasPct = 100 - proteinasPct - carbohidratosPct;

        if (grasasPct < 0) {
            const diff = -grasasPct;
            carbohidratosPct = Math.max(0, carbohidratosPct - diff);
            grasasPct = 0;
        }

        let calMult = (paramsBase.deficit[0] + paramsBase.deficit[1]) / 2;
        let calorias = Math.round(gastoEnergetico * calMult);
        let entrenoDias = '4 d√≠as entreno, 3 d√≠as descanso';
        let notasSemana = paramsBase.notas || 'Sin estrategias especiales';

        // --- 9. Aplicar modificaciones por estrategias espec√≠ficas en semanas espec√≠ficas ---

        // --- Refeed Semanal ---
        if (estrategiasGanancia.includes('refeed') && (semanaNum % 4 === 0 || semanaNum === semanas)) {
            carbohidratosPct = Math.min(95, carbohidratosPct + 15);
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            calMult = Math.min(1.25, calMult * 1.05);
            calorias = Math.round(gastoEnergetico * calMult);
            dietaSemana = nombresDietas['refeed_dieta'];
            notasSemana = `D√≠a de Refeed (${carbohidratosPct}% HC). ` + notasSemana;
            entrenoDias = 'D√≠a de Refeed';
        }
        // --- Carb Cycling (ej: semanas pares) ---
        else if (estrategiasGanancia.includes('carb_cycling') && (semanaNum % 2 === 0)) {
            carbohidratosPct = Math.min(90, carbohidratosPct + 10);
            grasasPct = Math.max(5, 100 - proteinasPct - carbohidratosPct);
            notasSemana = `D√≠a alto HC (${carbohidratosPct}%). ` + notasSemana;
            entrenoDias = 'D√≠a alto HC';
        }
        // --- Timing Nutricional ---
        // Se refleja en las notas generales y en la distribuci√≥n de comidas
        // else if (estrategiasGanancia.includes('timing')) { ... }

        // --- 10. Crear objeto de semana ---
        const semanaObj = crearSemana(
            semanaNum,
            faseSemana,
            dietaSemana,
            estrategiasGanancia.join(', '),
            calorias,
            proteinasPct,
            carbohidratosPct,
            grasasPct,
            entrenoDias,
            notasSemana
        );

        if (semanaObj) {
            plan.push(semanaObj);
        }
    }

    return plan;
}

function generarPlanMantenimiento(periodo, peso, gastoEnergetico) {
    const plan = [];
    const estrategiasMantenimiento = getSelectedStrategies('opcionesMantenimiento');
    const semanas = periodo === 'mensual' ? 12 : 4;

    const dietas = {
        flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 30, carbohidratosPct: 35, grasasPct: 35 },
        if_16_8: { nombre: 'Intermittent Fasting (16:8)', proteinasPct: 25, carbohidratosPct: 30, grasasPct: 45 },
        refeed: { nombre: 'Refeed', proteinasPct: 24, carbohidratosPct: 40, grasasPct: 36 },
        carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 35, grasasPct: 40 }
    };

    const estrategiaMap = {
        ninguna: { dieta: 'flexible_dieting', calMult: 1.0, notas: 'Equilibrio nutricional', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' },
        flexible_dieting: { dieta: 'flexible_dieting', calMult: 1.0, notas: '80/20 regla: 80% saludable, 20% flexible', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' },
        if_16_8: { dieta: 'if_16_8', calMult: 1.0, notas: 'Ventana de alimentaci√≥n 8 horas', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' },
        refeed: { dieta: 'refeed', calMult: 1.05, notas: 'D√≠as altos HC (150-200g)', entrenoDias: '2 d√≠as refeed' },
        carb_cycling: { dieta: 'carb_cycling', calMult: 1.0, notas: 'D√≠as altos/bajos HC', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' }
    };

    for (let semana = 1; semana <= semanas; semana++) {
        let dieta = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].nombre;
        let estrategias = estrategiasMantenimiento;
        let proteinasPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].proteinasPct;
        let carbohidratosPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].carbohidratosPct;
        let grasasPct = dietas[estrategiasMantenimiento.length ? estrategiaMap[estrategiasMantenimiento[0]].dieta : 'flexible_dieting'].grasasPct;
        let calMult = Math.max(...estrategiasMantenimiento.map(s => estrategiaMap[s].calMult));
        let entrenoDias = estrategiasMantenimiento.map(s => estrategiaMap[s].entrenoDias).join('; ');
        let notas = estrategiasMantenimiento.map(s => estrategiaMap[s].notas).join('; ');

        if (estrategias.includes('refeed') && (semana === 4 || semana === 8 || semana === 12)) {
            dieta = dietas.refeed.nombre;
            proteinasPct = dietas.refeed.proteinasPct;
            carbohidratosPct = dietas.refeed.carbohidratosPct;
            grasasPct = dietas.refeed.grasasPct;
            calMult = 1.05;
            notas = 'D√≠as altos HC (150-200g)' + (notas ? '; ' + notas : '');
            entrenoDias = '2 d√≠as refeed';
        } else if (estrategias.includes('carb_cycling') && semana % 2 === 0) {
            dieta = dietas.carb_cycling.nombre;
            proteinasPct = dietas.carb_cycling.proteinasPct;
            carbohidratosPct = 45;
            grasasPct = 30;
            calMult = 1.05;
            notas = 'D√≠as altos HC' + (notas ? '; ' + notas : '');
            entrenoDias = '4 d√≠as entreno';
        }

        const semanaObj = crearSemana(semana, 'Mantenimiento', dieta, estrategias.join(', '), Math.round(gastoEnergetico * calMult), proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas);
        if (semanaObj) plan.push(semanaObj);
    }

    return plan;
}

function generarPlanMixto(periodo, peso, gastoEnergetico) {
    const plan = [];
    const estrategiasMixto = getSelectedStrategies('opcionesMixto');
    const semanas = periodo === 'mensual' ? 12 : 4;

    const dietas = {
        moderada: { nombre: 'Moderada en HC', proteinasPct: 25, carbohidratosPct: 45, grasasPct: 30 },
        carb_cycling: { nombre: 'Carb Cycling', proteinasPct: 25, carbohidratosPct: 35, grasasPct: 40 },
        refeed: { nombre: 'Refeed', proteinasPct: 24, carbohidratosPct: 40, grasasPct: 36 },
        timing: { nombre: 'Timing Nutricional', proteinasPct: 28, carbohidratosPct: 35, grasasPct: 37 },
        flexible_dieting: { nombre: 'Flexible Dieting', proteinasPct: 30, carbohidratosPct: 35, grasasPct: 35 }
    };

    const estrategiaMap = {
        ninguna: { dieta: 'moderada', calMult: 1.0, notas: 'Balance nutricional', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' },
        carb_cycling: { dieta: 'carb_cycling', calMult: 1.0, notas: 'D√≠as altos/bajos HC', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' },
        refeed: { dieta: 'refeed', calMult: 1.05, notas: 'D√≠as altos HC (150-200g)', entrenoDias: '2 d√≠as refeed' },
        timing: { dieta: 'timing', calMult: 1.0, notas: 'HC post-entreno', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' },
        flexible_dieting: { dieta: 'flexible_dieting', calMult: 1.0, notas: '80/20 regla: 80% saludable, 20% flexible', entrenoDias: '4 d√≠as entreno, 3 d√≠as descanso' }
    };

    const periodization = [
        { semana: 1, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 2, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 3, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 4, fase: 'Definici√≥n', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 5, fase: 'Definici√≥n', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 6, fase: 'Definici√≥n', dieta: estrategiasMixto.includes('carb_cycling') ? 'carb_cycling' : 'moderada', estrategias: estrategiasMixto, calMult: 0.85, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 7, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 8, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 9, fase: 'Mantenimiento', dieta: 'flexible_dieting', estrategias: estrategiasMixto, calMult: 1.0, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 10, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 11, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') },
        { semana: 12, fase: 'Volumen', dieta: 'moderada', estrategias: estrategiasMixto, calMult: 1.1, entrenoDias: estrategiasMixto.map(s => estrategiaMap[s].entrenoDias).join('; '), notas: estrategiasMixto.map(s => estrategiaMap[s].notas).join('; ') }
    ];

    for (let semana = 1; semana <= semanas; semana++) {
        let semanaConfig = periodization[semana - 1] || periodization[periodization.length - 1];
        let dieta = dietas[semanaConfig.dieta].nombre;
        let estrategias = semanaConfig.estrategias;
        let proteinasPct = dietas[semanaConfig.dieta].proteinasPct;
        let carbohidratosPct = dietas[semanaConfig.dieta].carbohidratosPct;
        let grasasPct = dietas[semanaConfig.dieta].grasasPct;
        let calMult = semanaConfig.calMult;
        let entrenoDias = semanaConfig.entrenoDias;
        let notas = semanaConfig.notas;

        if (estrategias.includes('refeed') && (semana === 4 || semana === 8 || semana === 12)) {
            dieta = dietas.refeed.nombre;
            proteinasPct = dietas.refeed.proteinasPct;
            carbohidratosPct = dietas.refeed.carbohidratosPct;
            grasasPct = dietas.refeed.grasasPct;
            calMult = 1.05;
            notas = 'D√≠as altos HC (150-200g)' + (notas ? '; ' + notas : '');
            entrenoDias = '2 d√≠as refeed';
        } else if (estrategias.includes('carb_cycling') && semana % 2 === 0) {
            dieta = dietas.carb_cycling.nombre;
            proteinasPct = dietas.carb_cycling.proteinasPct;
            carbohidratosPct = 45;
            grasasPct = 30;
            calMult = 1.05;
            notas = 'D√≠as altos HC' + (notas ? '; ' + notas : '');
            entrenoDias = '4 d√≠as entreno';
        }

        const semanaObj = crearSemana(semana, semanaConfig.fase, dieta, estrategias.join(', '), Math.round(gastoEnergetico * calMult), proteinasPct, carbohidratosPct, grasasPct, entrenoDias, notas);
        if (semanaObj) plan.push(semanaObj);
    }

    return plan;
}


function ajustarEntrenoDias(semanaNum, valor) {
    const planificacion = JSON.parse(JSON.stringify(weeklyMacros));
    const semana = planificacion.find(item => item.semana === `Sem ${semanaNum}`);
    if (!semana) return;

    // Actualizar los d√≠as de entrenamiento
    semana.entrenoDias = valor;

    weeklyMacros = planificacion;
    actualizarPlanificacion();
}

function actualizarPlanificacion() {
    const tbody = document.getElementById('tablaPlanificacionBody');
    tbody.innerHTML = '';
    weeklyMacros.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
                <td>${item.semana}</td>
                <td><span class="badge bg-${getBadgeClass(item.fase)}">${item.fase}</span><br><span class="badge bg-${getBadgeClass(item.dieta)}">${item.dieta}</span></td>
                <td><span class="badge bg-${getBadgeClass(item.estrategias)}">${item.estrategias || 'Ninguna'}</span></td>
                <td>${item.calorias.toLocaleString('es-ES')}</td>
                <td><input type="number" class="macro-input form-control" value="${item.proteinasPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'proteinas', this.value)"></td>
                <td><input type="number" class="macro-input form-control" value="${item.carbohidratosPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'carbohidratos', this.value)"></td>
                <td><input type="number" class="macro-input form-control" value="${item.grasasPct}" min="0" max="100" oninput="ajustarMacros(${item.semana.replace('Sem ', '')}, 'grasas', this.value)"></td>
                <td>${isNaN(item.proteinas) ? '-' : item.proteinas}</td>
                <td>${isNaN(item.carbohidratos) ? '-' : item.carbohidratos}</td>
                <td>${isNaN(item.grasas) ? '-' : item.grasas}</td>
                <td>
                    <select class="form-control" onchange="ajustarEntrenoDias(${item.semana.replace('Sem ', '')}, this.value)">
                        <option value="0 d√≠as entreno" ${item.entrenoDias === '0 d√≠as entreno' ? 'selected' : ''}>0 d√≠as</option>
                        <option value="1 d√≠a entreno, 6 d√≠as descanso" ${item.entrenoDias === '1 d√≠a entreno, 6 d√≠as descanso' ? 'selected' : ''}>1 d√≠a</option>
                        <option value="2 d√≠as entreno, 5 d√≠as descanso" ${item.entrenoDias === '2 d√≠as entreno, 5 d√≠as descanso' ? 'selected' : ''}>2 d√≠as</option>
                        <option value="3 d√≠as entreno, 4 d√≠as descanso" ${item.entrenoDias === '3 d√≠as entreno, 4 d√≠as descanso' ? 'selected' : ''}>3 d√≠as</option>
                        <option value="4 d√≠as entreno, 3 d√≠as descanso" ${item.entrenoDias === '4 d√≠as entreno, 3 d√≠as descanso' ? 'selected' : ''}>4 d√≠as</option>
                        <option value="5 d√≠as entreno, 2 d√≠as descanso" ${item.entrenoDias === '5 d√≠as entreno, 2 d√≠as descanso' ? 'selected' : ''}>5 d√≠as</option>
                        <option value="6 d√≠as entreno, 1 d√≠a descanso" ${item.entrenoDias === '6 d√≠as entreno, 1 d√≠a descanso' ? 'selected' : ''}>6 d√≠as</option>
                        <option value="7 d√≠as entreno" ${item.entrenoDias === '7 d√≠as entreno' ? 'selected' : ''}>7 d√≠as</option>
                    </select>
                </td>
                <td class="strategy-note">${item.notas}</td>
            `;
        tbody.appendChild(row);
        // Agregar div de error para cada fila
        const errorDiv = document.createElement('div');
        errorDiv.id = `errorMessageSem${item.semana.replace('Sem ', '')}`;
        errorDiv.className = 'alert alert-danger mt-2';
        errorDiv.style.display = 'none';
        row.appendChild(errorDiv);
    });
}



function ajustarMacros(semanaNum, macro, valor) {
    const planificacion = JSON.parse(JSON.stringify(weeklyMacros));
    const semana = planificacion.find(item => item.semana === `Sem ${semanaNum}`);
    if (!semana) return;

    // Actualizar el porcentaje seg√∫n el macro ajustado
    if (macro === 'proteinas') semana.proteinasPct = parseInt(valor) || 0;
    if (macro === 'carbohidratos') semana.carbohidratosPct = parseInt(valor) || 0;
    if (macro === 'grasas') semana.grasasPct = parseInt(valor) || 0;

    // Calcular gramos de macronutrientes basados en los porcentajes actuales
    semana.proteinas = Math.round((semana.calorias * semana.proteinasPct / 100) / 4);
    semana.carbohidratos = Math.round((semana.calorias * semana.carbohidratosPct / 100) / 4);
    semana.grasas = Math.round((semana.calorias * semana.grasasPct / 100) / 9);

    const errorDiv = document.getElementById(`errorMessageSem${semanaNum}`);
    if (!errorDiv) {
        const newErrorDiv = document.createElement('div');
        newErrorDiv.id = `errorMessageSem${semanaNum}`;
        newErrorDiv.className = 'alert alert-danger mt-2';
        newErrorDiv.style.display = 'none';
        document.getElementById('tablaPlanificacionBody').querySelector(`tr:nth-child(${semanaNum})`).appendChild(newErrorDiv);
    }

    // Validar que los porcentajes sumen 100%
    const totalPct = semana.proteinasPct + semana.carbohidratosPct + semana.grasasPct;
    if (totalPct !== 100) {
        document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Los porcentajes deben sumar 100% (actual: ${totalPct}%).`;
        document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
        return;
    } else {
        document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'none';
    }

    const dietaRanges = {
        'Cetog√©nica': { carbohidratos: [5, 20], proteinas: [20, 35], grasas: [55, 75] },
        'Hiperproteica': { carbohidratos: [40, 50], proteinas: [25, 35], grasas: [30, 40] },
        'Carb Cycling': { carbohidratos: [20, 50], proteinas: [20, 35], grasas: [30, 60] },
        'Intermittent Fasting (16:8)': { carbohidratos: [5, 40], proteinas: [20, 35], grasas: [35, 75] },
        'Refeed': { carbohidratos: [20, 50], proteinas: [20, 32], grasas: [30, 60] },
        'Ketoadaptation': { carbohidratos: [5, 25], proteinas: [18, 30], grasas: [55, 75] },
        'Flexible Dieting': { carbohidratos: [25, 45], proteinas: [25, 40], grasas: [30, 50] },
        'Moderada en HC': { carbohidratos: [25, 45], proteinas: [20, 30], grasas: [30, 40] },
        'Timing Nutricional': { carbohidratos: [10, 20], proteinas: [28, 35], grasas: [50, 60] }
    };

    // Validar l√≠mite de prote√≠nas (2.5 g/kg) para d√≠as altos de prote√≠na
    const peso = parseFloat(document.getElementById('weight').value);
    const isHighProtein = semana.dieta === 'Hiperproteica' || semana.estrategias.includes('hiperproteica');
    if (isHighProtein && !isNaN(peso) && semana.proteinas > 2.5 * peso) {
        document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Las prote√≠nas no deben exceder 2.5 g/kg de peso corporal (${(2.5 * peso).toFixed(1)} g).`;
        document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
        return;
    }

    // Validar rangos de macronutrientes
    const combinedRanges = dietaRanges[semana.dieta];
    if (
        semana.carbohidratosPct < combinedRanges.carbohidratos[0] || semana.carbohidratosPct > combinedRanges.carbohidratos[1] ||
        semana.proteinasPct < combinedRanges.proteinas[0] || semana.proteinasPct > combinedRanges.proteinas[1] ||
        semana.grasasPct < combinedRanges.grasas[0] || semana.grasasPct > combinedRanges.grasas[1]
    ) {
        document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Los porcentajes deben estar dentro de los rangos de ${semana.dieta} (Carbohidratos: ${combinedRanges.carbohidratos.join('-')}%, Prote√≠nas: ${combinedRanges.proteinas.join('-')}%, Grasas: ${combinedRanges.grasas.join('-')}%).`;
        document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
        return;
    }

    if (semana.calorias < (document.getElementById('gender').value === 'Femenino' ? 1200 : 1500)) {
        document.getElementById(`errorMessageSem${semanaNum}`).textContent = `Error en Semana ${semanaNum}: Las calor√≠as no pueden ser inferiores a ${document.getElementById('gender').value === 'Femenino' ? 1200 : 1500} kcal sin supervisi√≥n m√©dica.`;
        document.getElementById(`errorMessageSem${semanaNum}`).style.display = 'block';
        return;
    }

    weeklyMacros = planificacion;
    actualizarPlanificacion();
}



function getBadgeClass(faseOrDieta) {
    const badgeClasses = {
        'Inducci√≥n Cetog√©nica': 'danger',
        'Ciclado Metab√≥lico': 'warning',
        'Transici√≥n a Mantenimiento': 'success',
        'Ketoadaptation': 'info',
        'Volumen': 'primary',
        'Definici√≥n': 'info',
        'Mantenimiento': 'secondary',
        'Cetog√©nica': 'danger',
        'Hiperproteica': 'primary',
        'Carb Cycling': 'warning',
        'Intermittent Fasting (16:8)': 'info',
        'Refeed': 'success',
        'Flexible Dieting': 'secondary',
        'Moderada en HC': 'success',
        'Timing Nutricional': 'primary',
        'ninguna': 'secondary',
        'tkd': 'danger',
        'ckd': 'warning',
        'if_16_8': 'info',
        'refeed': 'success',
        'hiperproteica': 'primary',
        'carb_cycling': 'warning',
        'protein_cycling': 'primary',
        'timing': 'info',
        'flexible_dieting': 'secondary',
        'ketoadaptation_tkd': 'danger',
        'ketoadaptation_if': 'info',
        'ketoadaptation_refeed': 'success',
        'ketoadaptation_protein_cycling': 'primary'
    };
    return badgeClasses[faseOrDieta] || 'secondary';
}

function calcularTMB(peso, altura, edad, sexo) {
    // Calculates TMB using Mifflin-St Jeor equation
    // peso: kilograms, altura: centimeters, edad: years
    return sexo === 'Masculino' ? 10 * peso + 6.25 * altura - 5 * edad + 5 : 10 * peso + 6.25 * altura - 5 * edad - 161;
}

//// CALCULAR MACROS -1¬∫ MODAL SEGUNDO AUTOMATICA///////////////////////////////////////


function calcularMacros(useManual = false) {
    // Debug: Log all required elements
    console.log('Checking DOM elements:');
    const ids = ['weight', 'height', 'age', 'gender', 'activity', 'objetivo', 'periodoPlanificacion'];
    ids.forEach(id => {
        console.log(`${id} element:`, document.getElementById(id));
    });

    if (typeof window.macrosConfiguracionManual === 'undefined') {
        window.macrosConfiguracionManual = {};
    }
    // Retry if activity-level is not found (dynamic content)
    const activitySelect = document.getElementById('activity');
    if (!activitySelect) {
        console.warn('activity-level not found. Retrying in 100ms...');
        return;
    }

    // Check all required DOM elements
    for (const id of ids) {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`Element with ID "${id}" not found.`);
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.textContent = `Error: No se encontr√≥ el elemento con ID "${id}".`;
                errorMessage.style.display = 'block';
            }
            return;
        }
    }

    // Patch <select id="activity-level"> options
    activitySelect.innerHTML = `
        <option value="1.2">Sedentario (poco o nada)</option>
        <option value="1.375">Ligero (1-3 d√≠as/semana)</option>
        <option value="1.55" selected>Moderado (3-5 d√≠as/semana)</option>
        <option value="1.725">Activo (6-7 d√≠as/semana)</option>
        <option value="1.9">Muy activo (entrenamiento intenso)</option>
    `;

    // Get values from form
    const peso = parseFloat(document.getElementById('weight').value);
    const height = parseFloat(document.getElementById('height').value);
    const altura = height * 100; // Convert to centimeters
    const edad = parseInt(document.getElementById('age').value);
    const sexo = document.getElementById('gender').value;
    const actividad = parseFloat(document.getElementById('activity').value);
    const objetivo = document.getElementById('objetivo').value;

    // --- Validaci√≥n de fase seleccionada ---
    let faseValida = true;
    let nombreSelectFase = '';

    switch (objetivo) {
        case 'perdida1':
            const fasePerdida = document.getElementById('fasePerdida1')?.value;
            if (!fasePerdida || fasePerdida.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase de P√©rdida de Peso';
            }
            break;
        case 'ganancia1':
            const faseGanancia = document.getElementById('faseGanancia1')?.value;
            if (!faseGanancia || faseGanancia.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase de Ganancia de Peso';
            }
            break;
        case 'mantenimiento1':
            const enfoqueMantenimiento = document.getElementById('enfoqueMantenimiento1')?.value;
            if (!enfoqueMantenimiento || enfoqueMantenimiento.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Enfoque de Mantenimiento';
            }
            break;
        case 'mixto1':
            const faseMixto = document.getElementById('faseMixto1')?.value;
            if (!faseMixto || faseMixto.startsWith('sel')) {
                faseValida = false;
                nombreSelectFase = 'Fase del Plan Mixto';
            }
            break;
        default:
            break;
    }

    if (!faseValida) {
        const errorMsg = `Por favor, selecciona una opci√≥n v√°lida en "${nombreSelectFase}" antes de calcular.`;
        console.error(errorMsg);
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = errorMsg;
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // Validate inputs
    if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !sexo || isNaN(actividad) || !objetivo) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Por favor, completa todos los campos obligatorios en el Paso 1.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    // Validate activity level
    const validActivityLevels = [1.2, 1.375, 1.55, 1.725, 1.9];
    if (!validActivityLevels.includes(actividad)) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Nivel de actividad no v√°lido.';
            errorMessage.style.display = 'block';
        }
        console.error("Invalid activity level:", actividad);
        return;
    }

    // === 1. Calcular TMB (Mifflin-St Jeor) ===
    function calcularTMB(peso, altura, edad, sexo) {
        if (isNaN(peso) || isNaN(altura) || isNaN(edad) || !peso || !altura || !edad) return NaN;
        return sexo === 'Masculino'
            ? 10 * peso + 6.25 * altura - 5 * edad + 5
            : 10 * peso + 6.25 * altura - 5 * edad - 161;
    }

    // === 2. Mapa de c√≥digos a nombres legibles ===
    const mapaCodigos1 = {
        'perdida1': 'p√©rdida de peso',
        'ganancia1': 'ganancia de peso',
        'mantenimiento1': 'mantenimiento',
        'mixto1': 'plan mixto',
        'sel': 'no seleccionado',
        'induccion_cetogenica1': 'inducci√≥n cetog√©nica',
        'ciclado_metabolico1': 'ciclado metab√≥lico',
        'transicion_mantenimiento1': 'transici√≥n a mantenimiento',
        'volumen1': 'volumen muscular',
        'masa1': 'enfoque en masa muscular',
        'equilibrio1': 'equilibrio flexible',
        'social1': 'adherencia social'
    };

    // === 3. Reglas de ajuste cal√≥rico por objetivo y fase ===
    const reglasTDEE = {
        perdida1: { factor: 0.85, nota: 'D√©ficit moderado' },
        induccion_cetogenica1: { factor: 0.80, nota: 'D√©ficit mayor' },
        ciclado_metabolico1: { factor: 0.85, nota: 'D√©ficit moderado' },
        transicion_mantenimiento1: { factor: 0.95, nota: 'D√©ficit ligero' },
        ganancia1: { factor: 1.05, nota: 'Super√°vit controlado' },
        volumen1: { factor: 1.10, nota: 'Super√°vit alto' },
        masa1: { factor: 1.07, nota: 'Super√°vit moderado' },
        mantenimiento1: { factor: 1.00, nota: 'Equilibrio' },
        equilibrio1: { factor: 1.00, nota: 'Equilibrio' },
        social1: { factor: 1.00, nota: 'Flexibilidad' },
        mixto1: { factor: 1.02, nota: 'Base para ciclado' }
    };

    // === 4. Funci√≥n para obtener la fase ===
    function getSelectedPhase(objetivo) {
        switch (objetivo) {
            case 'perdida1': return document.getElementById('fasePerdida1')?.value || 'sel1';
            case 'ganancia1': return document.getElementById('faseGanancia1')?.value || 'sel2';
            case 'mantenimiento1': return document.getElementById('enfoqueMantenimiento1')?.value || 'sel3';
            case 'mixto1': return document.getElementById('faseMixto1')?.value || 'sel4';
            default: return 'sel';
        }
    }

    const faseRaw = getSelectedPhase(objetivo);
    const fase = faseRaw.startsWith('sel') ? 'sel' : faseRaw;

    // === 5. Calcular TMB y TDEE ===
    const tmb = calcularTMB(peso, altura, edad, sexo);
    if (isNaN(tmb) || tmb <= 0) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Error al calcular el TMB.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    const tdeeBase = tmb * actividad;
    const codigo = fase !== 'sel' ? fase : objetivo;
    const regla = reglasTDEE[codigo] || { factor: 1.0 };
    const gastoEnergetico = document.getElementById('goal-calories').value  //Math.round(tdeeBase * regla.factor);

    if (isNaN(gastoEnergetico) || gastoEnergetico <= 0) {
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = 'Error al calcular el gasto energ√©tico.';
            errorMessage.style.display = 'block';
        }
        return;
    }

    // Guardar en ventana global
    window.tmb = Math.round(tmb);
    window.tdeeBase = Math.round(tdeeBase);
    window.gastoEnergetico = gastoEnergetico;
    window.faseNombre = mapaCodigos1[codigo] || 'Sin fase';
    window.ajusteNota = regla.nota;

    // === 6. Calcular macros: Manual o Autom√°tico ===
    let resultados;

    if (useManual) {
        const config = window.macrosConfiguracionManual?.[objetivo]?.[fase];
        if (config) {
            console.log("‚úÖ C√°lculo MANUAL activado");
            console.log("Objetivo:", objetivo, "Fase:", fase);
            console.log("Config:", config);

            const proteinasPct = parseFloat(config.proteinas);
            const carbohidratosPct = parseFloat(config.carbohidratos);
            if (isNaN(proteinasPct) || isNaN(carbohidratosPct)) {
                console.error("Valores inv√°lidos en config manual:", config);
                resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
            } else {
                const grasasPct = Math.max(10, 100 - proteinasPct - carbohidratosPct);
                const proteinas = Math.round((gastoEnergetico * proteinasPct / 100) / 4);
                const carbohidratos = Math.round((gastoEnergetico * carbohidratosPct / 100) / 4);
                const grasas = Math.round((gastoEnergetico * grasasPct / 100) / 9);

                // Actualizar inputs
                document.getElementById('protein-percentage').value = proteinasPct;
                document.getElementById('carb-percentage').value = carbohidratosPct;
                document.getElementById('fat-percentage').value = grasasPct;

                resultados = {
                    calorias: gastoEnergetico,
                    proteinas,
                    carbohidratos,
                    grasas,
                    proteinasPct,
                    carbohidratosPct,
                    grasasPct,
                    recomendaciones: `<strong>üéØ Usando tu configuraci√≥n manual para ${mapaCodigos1[fase] || mapaCodigos1[objetivo]}.</strong>`
                };
            }
        } else {
            console.log("‚ö†Ô∏è No hay configuraci√≥n manual para este objetivo/fase. Usando autom√°tico.");
            resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
        }
    } else {
        console.log("üìä C√°lculo AUTOM√ÅTICO activado");
        resultados = calcularMacronutrientes(peso, gastoEnergetico, objetivo, fase);
    }

    // === 7. Generar plan semanal ===
    weeklyMacros = [];
    const periodo = document.getElementById('periodoPlanificacion').value;
    switch (objetivo) {
        case 'perdida1':
            weeklyMacros = generarPlanPerdida(periodo, peso, gastoEnergetico);
            break;
        case 'ganancia1':
            weeklyMacros = generarPlanGanancia(periodo, peso, gastoEnergetico);
            break;
        case 'mantenimiento1':
            weeklyMacros = generarPlanMantenimiento(periodo, peso, gastoEnergetico);
            break;
        case 'mixto1':
            weeklyMacros = generarPlanMixto(periodo, peso, gastoEnergetico);
            break;
        default:
            console.log("Objetivo no requiere plan semanal autom√°tico.");
            break;
    }

    // === 8. Actualizar UI ===
    actualizarUI(resultados, gastoEnergetico);

    // === 9. Guardar resultados globales ===
    window.macrosResult = resultados;
    window.weeklyMacros = weeklyMacros;
}


////////////////////////////////////////////////////////////////////////////////

function mostrarFasePorObjetivo(objetivo) {
    // Ocultar todos los selects y labels de fase
    const elementosFase = [
        'fasePerdida1', 'labelFasePerdida1',
        'faseGanancia1', 'labelFaseGanancia1',
        'enfoqueMantenimiento1', 'labelEnfoqueMantenimiento1',
        'faseMixto1', 'labelFaseMixto1'
    ];

    elementosFase.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.display = 'none';
        }
    });

    // Mostrar el select correspondiente al objetivo

    switch (objetivo) {
        case 'perdida1':
            if (document.getElementById('fasePerdida1')) {
                document.getElementById('fasePerdida1').style.display = 'block';
                // Aseg√∫rate de que el label tambi√©n exista
                const label = document.getElementById('labelFasePerdida1');
                if (label) label.style.display = 'block';
            }
            break;
        case 'ganancia1':
            if (document.getElementById('faseGanancia1')) {
                document.getElementById('faseGanancia1').style.display = 'block';
                const label = document.getElementById('labelFaseGanancia1');
                if (label) label.style.display = 'block';
            }
            break;
        case 'mantenimiento1':
            if (document.getElementById('enfoqueMantenimiento1')) {
                document.getElementById('enfoqueMantenimiento1').style.display = 'block';
                const label = document.getElementById('labelEnfoqueMantenimiento1');
                if (label) label.style.display = 'block';
            }
            break;
        case 'mixto1':
            if (document.getElementById('faseMixto1')) {
                document.getElementById('faseMixto1').style.display = 'block';
                const label = document.getElementById('labelFaseMixto1');
                if (label) label.style.display = 'block';
            }
            break;
        case 'sel':
        default:
            // Opcional: Mostrar un mensaje indicando que deben seleccionar un objetivo
            // No es necesario hacer nada aqu√≠ ya que todos los selects est√°n ocultos
            break;
    }
}


// Funci√≥n para actualizar los porcentajes de macros seg√∫n la fase seleccionada

function actualizarMacrosPorFase() {
    const objetivoSelect = document.getElementById('objetivo');
    if (!objetivoSelect) return;

    const objetivo = objetivoSelect.value;
    let faseSeleccionada = '';

    // Corregido: usar los nuevos valores de objetivo
    if (objetivo === 'perdida1' && document.getElementById('fasePerdida1')) {
        faseSeleccionada = document.getElementById('fasePerdida1').value;
    } else if (objetivo === 'ganancia1' && document.getElementById('faseGanancia1')) {
        faseSeleccionada = document.getElementById('faseGanancia1').value;
    } else if (objetivo === 'mantenimiento1' && document.getElementById('enfoqueMantenimiento1')) {
        faseSeleccionada = document.getElementById('enfoqueMantenimiento1').value;
    } else if (objetivo === 'mixto1' && document.getElementById('faseMixto1')) {
        faseSeleccionada = document.getElementById('faseMixto1').value;
    }

    // Definir las distribuciones de macros para cada fase

    const distribuciones = {
        // P√©rdida de peso
        'induccion_cetogenica1': { protein: 20, carb: 10, fat: 70 },
        'ciclado_metabolico1': { protein: 25, carb: 20, fat: 55 },
        'transicion_mantenimiento1': { protein: 25, carb: 35, fat: 40 },

        // Ganancia de peso
        'volumen1': { protein: 20, carb: 55, fat: 25 },
        'masa1': { protein: 25, carb: 50, fat: 25 },

        // Mantenimiento
        'equilibrio1': { protein: 25, carb: 40, fat: 35 },
        'social1': { protein: 25, carb: 45, fat: 30 },

        // Mixto
        'volumen1_mixto': { protein: 25, carb: 50, fat: 25 },
        'definicion1': { protein: 30, carb: 25, fat: 45 },
        'mantenimiento1_mixto': { protein: 25, carb: 45, fat: 30 } // Cambiado para evitar conflicto
    };

    // Actualizar los valores en los inputs

    if (distribuciones[faseSeleccionada]) {
        if (document.getElementById('protein-percentage')) {
            document.getElementById('protein-percentage').value = distribuciones[faseSeleccionada].protein;
        }
        if (document.getElementById('carb-percentage')) {
            document.getElementById('carb-percentage').value = distribuciones[faseSeleccionada].carb;
        }
        if (document.getElementById('fat-percentage')) {
            document.getElementById('fat-percentage').value = distribuciones[faseSeleccionada].fat;
        }

        // Opcional: Actualizar el total de porcentajes
        const proteinValue = parseFloat(document.getElementById('protein-percentage').value) || 0;
        const carbValue = parseFloat(document.getElementById('carb-percentage').value) || 0;
        const fatValue = parseFloat(document.getElementById('fat-percentage').value) || 0;
        const total = proteinValue + carbValue + fatValue;

        const macroPercentageTotalDiv = document.getElementById('macro-percentage-total');
        if (macroPercentageTotalDiv) {
            macroPercentageTotalDiv.textContent = `Total: ${total}%`;
            macroPercentageTotalDiv.className = total === 100 ? 'total-valid' : 'total-invalid';
        }
    }
}






document.getElementById('objetivo').addEventListener('change', toggleOpcionesObjetivo);

document.addEventListener('DOMContentLoaded', () => {
    toggleOpcionesObjetivo();
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no est√° disponible.');
        document.getElementById('errorMessage').textContent = 'No se pudo cargar Chart.js. Algunas funcionalidades estar√°n limitadas.';
        document.getElementById('errorMessage').style.display = 'block';
    }
    // Agregar event listeners a los selects de fase
    const selectsFase = ['fasePerdida1', 'faseGanancia1', 'enfoqueMantenimiento1', 'faseMixto1'];
    selectsFase.forEach(selectId => {
        const elemento = document.getElementById(selectId);
        if (elemento) {
            elemento.addEventListener('change', actualizarMacrosPorFase);
        }
    });
    // Agregar event listener para el cambio de objetivo
    // Agregar event listener para el cambio de objetivo
    const objetivoSelect = document.getElementById('objetivo');
    if (objetivoSelect) {
        objetivoSelect.addEventListener('change', function () {
            const objetivo = this.value;
            mostrarFasePorObjetivo(objetivo); // ‚Üê Descomentado y corregido
            // Aqu√≠ tambi√©n puedes llamar a actualizarMacrosPorFase() si la tienes
        });
    }

});
// --- Variables Globales para Configuraci√≥n Manual ---
// Almacena los valores de macros introducidos manualmente por el usuario.
// Formato: { estrategia1: { proteinas: X, carbohidratos: Y, grasas: Z }, estrategia2: {...} }
let macrosConfiguracionManual = {};

/**
 * Muestra el modal de incompatibilidad de estrategias.
 * @param {Array<string>} estrategias - Las estrategias seleccionadas.
 * @param {Object} rangosConflicto - (Opcional) Informaci√≥n detallada de los rangos que causan conflicto.
 */
function mostrarModalIncompatibilidad(estrategias, rangosConflicto = null) {
    const modal = document.getElementById('modalIncompatibilidad');
    const mensajeElement = document.getElementById('mensajeIncompatibilidad');
    const guiaElement = document.getElementById('guiaCompatibilidad');

    if (!modal || !mensajeElement || !guiaElement) {
        console.error("No se encontraron los elementos del modal de incompatibilidad.");
        // Fallback: mostrar mensaje de error b√°sico
        const errorMsgElement = document.getElementById('errorMessage');
        if (errorMsgElement) {
            errorMsgElement.textContent = 'Las estrategias seleccionadas son incompatibles. Por favor, selecciona una combinaci√≥n v√°lida.';
            errorMsgElement.style.display = 'block';
        }
        return;
    }

    // 1. Construir mensaje principal
    let mensaje = `<p>Las estrategias que has seleccionado (<strong>${estrategias.join(', ')}</strong>) tienen requerimientos nutricionales contradictorios y no se pueden combinar autom√°ticamente para calcular un rango v√°lido de macronutrientes.</p>`;

    // 2. (Opcional) A√±adir detalles t√©cnicos si se proporcionan
    if (rangosConflicto) {
        mensaje += `<p><strong>Detalles del conflicto:</strong></p><ul>`;
        for (const [macro, rango] of Object.entries(rangosConflicto)) {
            if (Array.isArray(rango) && rango[0] > rango[1]) {
                mensaje += `<li><strong>${macro.charAt(0).toUpperCase() + macro.slice(1)}:</strong> Rango resultante inv√°lido [${rango[0]}, ${rango[1]}].</li>`;
            }
        }
        mensaje += `</ul>`;
    }
    mensajeElement.innerHTML = mensaje;

    // 3. Construir gu√≠a de compatibilidad
    // Esta es una gu√≠a b√°sica. Puedes ampliarla o hacerla m√°s din√°mica.
    let guiaHTML = `
			<p><strong>Para el objetivo de P√©rdida de Peso:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>hiperproteica</code></li>
				<li><code>carb_cycling</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>carb_cycling</code>)</li>
				<li><code>flexible_dieting</code> (mejor sin otras estrategias de extremos)</li>
			</ul>
			<p><strong>Para el objetivo de Ganancia de Peso:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>hiperproteica</code></li>
				<li><code>carb_cycling</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>carb_cycling</code>)</li>
			</ul>
			<p><strong>Para el objetivo de Mantenimiento:</strong></p>
			<ul>
				<li><code>ninguna</code> + <code>flexibilidad_selectiva</code></li>
				<li><code>ciclado_ch_suave</code> (evitar combinar con <code>refeed</code>)</li>
				<li><code>refeed</code> (evitar combinar con <code>ciclado_ch_suave</code>)</li>
			</ul>
			<p><i>Nota: Las estrategias como <code>timing</code>, <code>if_16_8</code>, etc., suelen ser compatibles con varias otras.</i></p>
		`;
    guiaElement.innerHTML = guiaHTML;

    // 4. Mostrar el modal
    modal.style.display = 'flex'; // Usamos flex para centrarlo como en el CSS
}

/**
 * Cierra un modal espec√≠fico.
 * @param {string} modalId - El ID del modal a cerrar.
 */
function cerrarModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

/**
 * Abre el modal de configuraci√≥n manual de macronutrientes.
 */
function abrirModalConfiguracionManual() {
    // Primero, cerrar el modal de incompatibilidad
    cerrarModal('modalIncompatibilidad');

    const modal = document.getElementById('modalConfiguracionManual');
    const contenedor = document.getElementById('contenedorEntradasManuales');
    const errorElement = document.getElementById('errorConfiguracionManual');

    if (!modal || !contenedor) {
        console.error("No se encontraron los elementos del modal de configuraci√≥n manual.");
        return;
    }

    // Limpiar mensajes de error anteriores
    if (errorElement) {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
    }

    // Obtener estrategias seleccionadas
    // Asumimos que getSelectedStrategies() ya sabe c√≥mo obtenerlas bas√°ndose en el objetivo actual
    const estrategias = getSelectedStrategies();
    const estrategiasActivas = estrategias.filter(s => s !== 'ninguna');

    if (estrategiasActivas.length === 0) {
        if (errorElement) {
            errorElement.textContent = 'No hay estrategias seleccionadas para configurar.';
            errorElement.style.display = 'block';
        }
        modal.style.display = 'flex';
        return;
    }

    // 1. Generar bloques de entrada para cada estrategia
    contenedor.innerHTML = ''; // Limpiar contenido previo
    estrategiasActivas.forEach(estrategia => {
        const bloqueId = `bloque_${estrategia}`;
        const inputProteinaId = `manual_proteina_${estrategia}`;
        const inputCarbohidratosId = `manual_carbohidratos_${estrategia}`;
        const inputGrasasId = `manual_grasas_${estrategia}`;

        // Intentar obtener valores guardados previamente o usar valores por defecto razonables
        const configGuardada = macrosConfiguracionManual[estrategia];
        const valorProteina = configGuardada?.proteinas ?? 25;
        const valorCarbohidratos = configGuardada?.carbohidratos ?? 40;
        const valorGrasas = configGuardada?.grasas ?? 35;
        const totalInicial = valorProteina + valorCarbohidratos + valorGrasas;

        const bloqueHTML = `
				<div class="bloque-estrategia-manual mb-3 p-3 border rounded" id="${bloqueId}" data-estrategia="${estrategia}">
					<h6>Estrategia: <span class="nombre-estrategia fw-bold">${estrategia}</span></h6>
					<div class="row">
						<div class="col-md-4 mb-2">
							<label for="${inputProteinaId}" class="form-label">Prote√≠na (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputProteinaId}" name="${inputProteinaId}" 
								   data-estrategia="${estrategia}" data-macro="proteinas" 
								   min="0" max="100" value="${valorProteina}" required>
						</div>
						<div class="col-md-4 mb-2">
							<label for="${inputCarbohidratosId}" class="form-label">Carbohidratos (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputCarbohidratosId}" name="${inputCarbohidratosId}" 
								   data-estrategia="${estrategia}" data-macro="carbohidratos" 
								   min="0" max="100" value="${valorCarbohidratos}" required>
						</div>
						<div class="col-md-4 mb-2">
							<label for="${inputGrasasId}" class="form-label">Grasas (%)</label>
							<input type="number" class="form-control input-macro-manual" id="${inputGrasasId}" name="${inputGrasasId}" 
								   data-estrategia="${estrategia}" data-macro="grasas" 
								   min="0" max="100" value="${valorGrasas}" required>
						</div>
					</div>
					<div class="total-macro-manual mt-2">
						<strong>Total: <span class="valor-total">${totalInicial}</span>%</strong>
						<span class="estado-total text-success" style="${totalInicial === 100 ? 'display:inline;' : 'display:none;'}">‚úì Correcto</span>
						<span class="estado-total text-danger" style="${totalInicial !== 100 ? 'display:inline;' : 'display:none;'}">‚úó Debe ser 100%</span>
					</div>
				</div>
			`;
        contenedor.insertAdjacentHTML('beforeend', bloqueHTML);
    });

    // 2. A√±adir event listeners a los inputs reci√©n creados para validaci√≥n en tiempo real
    document.querySelectorAll('.input-macro-manual').forEach(input => {
        input.addEventListener('input', function () {
            // Encontrar el bloque padre de esta estrategia
            const bloque = this.closest('.bloque-estrategia-manual');
            if (!bloque) return;

            const estrategia = bloque.dataset.estrategia;
            const inputs = bloque.querySelectorAll('.input-macro-manual');
            let total = 0;
            inputs.forEach(inp => {
                const val = parseInt(inp.value) || 0; // Convertir a n√∫mero, 0 si NaN
                // Asegurar que est√© dentro del rango 0-100
                if (val < 0) inp.value = 0;
                if (val > 100) inp.value = 100;
                total += parseInt(inp.value) || 0;
            });

            const totalElement = bloque.querySelector('.valor-total');
            const estadoCorrecto = bloque.querySelector('.estado-total.text-success');
            const estadoError = bloque.querySelector('.estado-total.text-danger');

            if (totalElement) totalElement.textContent = total;
            if (estadoCorrecto) estadoCorrecto.style.display = total === 100 ? 'inline' : 'none';
            if (estadoError) estadoError.style.display = total !== 100 ? 'inline' : 'none';
        });
    });

    // 3. Mostrar el modal
    modal.style.display = 'flex';
}

/**
 * Valida y aplica la configuraci√≥n manual de macronutrientes.
 * Almacena los valores en `macrosConfiguracionManual` y cierra el modal.
 */
function aplicarConfiguracionManual() {
    const contenedor = document.getElementById('contenedorEntradasManuales');
    const errorElement = document.getElementById('errorConfiguracionManual');
    const modal = document.getElementById('modalConfiguracionManual');

    if (!contenedor || !errorElement || !modal) {
        console.error("No se encontraron elementos necesarios para aplicar la configuraci√≥n manual.");
        return;
    }

    // Limpiar mensajes de error
    errorElement.style.display = 'none';
    errorElement.textContent = '';

    // Obtener todos los bloques
    const bloques = contenedor.querySelectorAll('.bloque-estrategia-manual');
    const nuevaConfiguracion = {};

    let todoValido = true;

    bloques.forEach(bloque => {
        const estrategia = bloque.dataset.estrategia;
        const inputProteina = bloque.querySelector(`#manual_proteina_${estrategia}`);
        const inputCarbohidratos = bloque.querySelector(`#manual_carbohidratos_${estrategia}`);
        const inputGrasas = bloque.querySelector(`#manual_grasas_${estrategia}`);

        const p = parseInt(inputProteina.value) || 0;
        const c = parseInt(inputCarbohidratos.value) || 0;
        const g = parseInt(inputGrasas.value) || 0;
        const total = p + c + g;

        if (total !== 100) {
            todoValido = false;
            // Resaltar el bloque con error
            bloque.style.borderColor = '#dc3545'; // Rojo de Bootstrap
            bloque.style.backgroundColor = '#f8d7da'; // Fondo rojo claro
            // Asegurarse de que el mensaje de error del bloque sea visible
            const estadoError = bloque.querySelector('.estado-total.text-danger');
            if (estadoError) estadoError.style.display = 'inline';
        } else {
            // Restaurar estilo si es v√°lido
            bloque.style.borderColor = '';
            bloque.style.backgroundColor = '';
            nuevaConfiguracion[estrategia] = {
                proteinas: p,
                carbohidratos: c,
                grasas: g
            };
        }
    });

    if (!todoValido) {
        errorElement.textContent = 'Por favor, corrige los errores. La suma de macros para cada estrategia debe ser 100%.';
        errorElement.style.display = 'block';
        return;
    }

    // Si todo es v√°lido, almacenar la configuraci√≥n
    macrosConfiguracionManual = nuevaConfiguracion;
    console.log("Configuraci√≥n manual aplicada:", macrosConfiguracionManual);

    // Cerrar el modal
    modal.style.display = 'none';

    // Opcional: Mostrar un mensaje de confirmaci√≥n o disparar el c√°lculo
    // Por ejemplo, podr√≠as llamar a calcularMacros() aqu√≠ si quieres que se recalcule inmediatamente
    // calcularMacros(); 
    // O simplemente mostrar un mensaje
    const confirmMsg = document.getElementById('errorMessage'); // Reusamos el div de error para mensajes
    if (confirmMsg) {
        confirmMsg.textContent = 'Configuraci√≥n manual de macronutrientes guardada. Puedes ahora calcular tus macros.';
        confirmMsg.className = 'alert alert-success'; // Cambiar clase para que parezca √©xito
        confirmMsg.style.display = 'block';
        // Opcional: ocultar el mensaje despu√©s de unos segundos
        // setTimeout(() => { confirmMsg.style.display = 'none'; }, 5000);
    }
}

// /////////modal macros/////////////////////////////////


const mapaCodigos2 = {
    // Objetivos
    'perdida1': 'p√©rdida de peso',
    'ganancia1': 'ganancia de peso',
    'mantenimiento1': 'mantenimiento',
    'mixto1': 'plan mixto',
    'sel': 'no seleccionado',
    // Fases de P√©rdida
    'induccion_cetogenica1': 'inducci√≥n cetog√©nica',
    'ciclado_metabolico1': 'ciclado metab√≥lico',
    'transicion_mantenimiento1': 'transici√≥n a mantenimiento',
    'ketoadaptation': 'ketoadaptaci√≥n',
    // Fases de Ganancia
    'volumen1': 'volumen muscular',
    'masa1': 'enfoque en masa muscular',
    // Fases de Mantenimiento
    'equilibrio1': 'equilibrio flexible',
    'social1': 'adherencia social'
};


function getSelectedPhase2(objetivo) {
    switch (objetivo) {
        case 'perdida1':
            return document.getElementById('fasePerdida1')?.value || 'sel1';
        case 'ganancia1':
            return document.getElementById('faseGanancia1')?.value || 'sel2';
        case 'mantenimiento1':
            return document.getElementById('enfoqueMantenimiento1')?.value || 'sel3';
        case 'mixto1':
            return document.getElementById('faseMixto1')?.value || 'sel4';
        default:
            return 'sel';
    }
}


//////MODAL PASO 4 CALCULAR MACRONUTRIENTES ///////////////
function abrirModalMacros() {
    const objetivo = document.getElementById('objetivo').value;
    const fase = getSelectedPhase2(objetivo);
    const faseLimpia = fase && fase.startsWith('sel') ? 'sel' : fase;

    const modal = new bootstrap.Modal(document.getElementById('modalMacros'));
    const modalWarning = document.getElementById('modal-warning');
    const modalContent = document.getElementById('modal-content');

    // Validar objetivo y fase
    if (objetivo === 'sel' || faseLimpia === 'sel') {
        modalWarning.style.display = 'block';
        modalContent.style.display = 'none';
        document.getElementById('modal-objetivo').textContent = 'No seleccionado';
        document.getElementById('modal-fase').textContent = 'No seleccionada';
        modal.show();
        return; // Salir temprano si no es v√°lido
    }

    modalWarning.style.display = 'none';
    modalContent.style.display = 'block';
    const boton = document.getElementById('botonCalcular');
    if (boton) {
        boton.style.display = 'block';
    }


    // Mostrar objetivo y fase
    document.getElementById('modal-objetivo').textContent = mapaCodigos2[objetivo] || objetivo;
    document.getElementById('modal-fase').textContent = mapaCodigos2[faseLimpia] || faseLimpia;

    // === 1. Obtener valores de los inputs (si existen) ===
    let inputProteina = parseInt(document.getElementById('protein-percentage').value) || 30; // let en lugar de const
    let inputCarbo = parseInt(document.getElementById('carb-percentage').value) || 40;     // let en lugar de const
    let inputGrasa = parseInt(document.getElementById('fat-percentage').value) || 30;       // let en lugar de const

    // Validar que sumen 100%
    const total = inputProteina + inputCarbo + inputGrasa;
    if (Math.abs(total - 100) > 0.1) {
        console.warn("Los porcentajes no suman 100%. Ajustando grasas.");
        const diff = 100 - inputProteina - inputCarbo;
        const ajusteGrasa = Math.max(10, Math.min(80, diff)); // rango razonable
        document.getElementById('fat-percentage').value = ajusteGrasa;
        // Actualizamos inputGrasa para usarlo (ahora es let, por eso se puede reasignar)
        inputGrasa = ajusteGrasa;
    }

    // === 2. Mostrar rangos recomendados (igual que antes) ===
    const rangos = {
        // P√©rdida
        perdida1: { p: [20, 30], c: [10, 25], g: [50, 70] },
        induccion_cetogenica1: { p: [20, 25], c: [5, 10], g: [70, 75] },
        ciclado_metabolico1: { p: [22, 28], c: [8, 20], g: [60, 70] },
        transicion_mantenimiento1: { p: [25, 30], c: [20, 25], g: [40, 50] },
        // Ganancia
        ganancia1: { p: [25, 30], c: [40, 50], g: [25, 35] },
        volumen1: { p: [25, 30], c: [40, 50], g: [25, 35] },
        masa1: { p: [25, 30], c: [35, 45], g: [30, 35] },
        // Mantenimiento
        mantenimiento1: { p: [20, 25], c: [35, 45], g: [30, 35] },
        equilibrio1: { p: [20, 25], c: [35, 45], g: [30, 35] },
        social1: { p: [20, 25], c: [30, 50], g: [25, 40] },
        // Mixto
        mixto1: { p: [20, 25], c: [30, 40], g: [35, 50] },
        definicion1: { p: [25, 35], c: [10, 25], g: [40, 55] }
    };

    const codigo = rangos[faseLimpia] ? faseLimpia : objetivo;
    const r = rangos[codigo] || { p: [25, 35], c: [30, 50], g: [25, 40] };

    // Mostrar rangos recomendados
    document.getElementById('proteinasRango').textContent = `${r.p[0]}-${r.p[1]}%`;
    document.getElementById('carbohidratosRango').textContent = `${r.c[0]}-${r.c[1]}%`;
    document.getElementById('grasasRango').textContent = `${r.g[0]}-${r.g[1]}%`;

    // === 3. Establecer valores iniciales desde los inputs ===
    document.getElementById('proteinasRange').value = inputProteina;
    document.getElementById('carbohidratosRange').value = inputCarbo;
    document.getElementById('grasasRange').value = inputGrasa;

    document.getElementById('proteinasValue').textContent = inputProteina;
    document.getElementById('carbohidratosValue').textContent = inputCarbo;
    document.getElementById('grasasValue').textContent = inputGrasa;

    // === 4. Consejo por objetivo ===
    const consejos = {
        perdida1: 'Prioriza prote√≠na para preservar m√∫sculo.',
        ganancia1: 'Carbohidratos altos en d√≠as de entreno mejoran la hipertrofia.',
        mantenimiento1: 'Equilibrio flexible mejora la adherencia a largo plazo.',
        mixto1: 'Alterna d√≠as de HC alto y bajo para mantener metabolismo activo.'
    };
    document.getElementById('modal-consejo').textContent = consejos[objetivo] || 'Ajusta los macros seg√∫n tu objetivo.';

    // === 5. Sincronizar sliders con inputs y total ===
    function actualizarSliders() {
        const p = +document.getElementById('proteinasRange').value;
        const c = +document.getElementById('carbohidratosRange').value;
        let g = 100 - p - c;

        if (g < 10) {
            g = 10;
            const diff = 10 - g;
            const restante = 100 - p - 10;
            if (c > restante) {
                document.getElementById('carbohidratosRange').value = restante;
                document.getElementById('carbohidratosValue').textContent = restante;
            }
        }

        document.getElementById('grasasRange').value = g;
        document.getElementById('proteinasValue').textContent = p;
        document.getElementById('carbohidratosValue').textContent = c;
        document.getElementById('grasasValue').textContent = g;

        // Actualizar input ocultos (opcional)
        document.getElementById('protein-percentage').value = p;
        document.getElementById('carb-percentage').value = c;
        document.getElementById('fat-percentage').value = g;

        // Actualizar total visual
        document.getElementById('macro-percentage-total').textContent = `Total: ${p + c + g}%`;
        if (p + c + g !== 100) {
            document.getElementById('macro-percentage-total').style.color = 'red';
        } else {
            document.getElementById('macro-percentage-total').style.color = 'green';
        }
    } // <--- CIERRA LA LLAVE DE actualizarSliders

    // Asignar eventos (ahora est√° claramente fuera de actualizarSliders)
    ['proteinas', 'carbohidratos', 'grasas'].forEach(nut => {
        document.getElementById(`${nut}Range`).oninput = actualizarSliders;
    });

    // Llamar una vez para inicializar
    actualizarSliders();

    modal.show();
} // <--- CIERRA LA LLAVE DE abrirModalMacros



//////Guardar y llamar a calcularMacros()/////////////////
document.getElementById('guardarMacros').addEventListener('click', function () {
    const objetivo = document.getElementById('objetivo').value;
    const fase = getSelectedPhase2(objetivo);
    const faseLimpia = fase && fase.startsWith('sel') ? 'sel' : fase;

    if (objetivo === 'sel' || faseLimpia === 'sel') {
        alert('Por favor, selecciona primero un objetivo y una fase.');
        return;
    }

    const proteinas = parseInt(document.getElementById('proteinasRange').value);
    const carbohidratos = parseInt(document.getElementById('carbohidratosRange').value);
    const grasas = parseInt(document.getElementById('grasasRange').value);

    // ‚úÖ Actualizar inputs
    document.getElementById('protein-percentage').value = proteinas;
    document.getElementById('carb-percentage').value = carbohidratos;
    document.getElementById('fat-percentage').value = grasas;

    // ‚úÖ Guardar en objeto global
    if (!window.macrosConfiguracionManual[objetivo]) {
        window.macrosConfiguracionManual[objetivo] = {};
    }
    window.macrosConfiguracionManual[objetivo][faseLimpia] = { proteinas, carbohidratos, grasas };

    // Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('modalMacros')).hide();

    // Llamar a calcularMacros con modo manual
    calcularMacros(true);
    // Mostrar el bot√≥n despu√©s de cerrar el modal
    const boton = document.getElementById('calcularPlanificacionBtn');
    if (boton) {
        boton.style.display = 'block';
        boton.style.opacity = '0';
        setTimeout(() => {
            boton.style.transition = 'opacity 0.4s ease';
            boton.style.opacity = '1';
        }, 50);
    }

});

// === VARIABLES GLOBALES ===


// === FUNCIONES DE MODAL ===

// Funci√≥n para poblar los inputs del modal
function poblarModal() {
    try {
        // Poblar campos del modal con valores del formulario principal
        document.getElementById('weightGoalModal').value = document.getElementById('weight-change-goal').value;
        document.getElementById('weeklyCalorieDiffModal').value = document.getElementById('weekly-calorie-diff').value;
        document.getElementById('currentWeightModal').value = document.getElementById('weight').value;

        document.getElementById('userGenderModal').value = document.getElementById('gender').value;
        document.getElementById('userAgeModal').value = document.getElementById('age').value;
        document.getElementById('currentFatPercModal').value = document.getElementById('current-fat-percentage').value;

        // Sincronizar checkbox - del select 'yes'/'no' al checkbox
        const isAthleteSelect = document.getElementById('is-athlete');
        if (isAthleteSelect) {
            document.getElementById('isAthleteModal').checked = (isAthleteSelect.value === 'yes');
        }

        // Sincronizar selects - de un select a otro
        const activitySelect = document.getElementById('activity');
        if (activitySelect) {
            document.getElementById('activityLevelModal').value = activitySelect.value;
        }

        return true;
    } catch (error) {
        console.error('Error al poblar el modal:', error);
        return false;
    }
}

// Funci√≥n para abrir el modal program√°ticamente
function abrirModalConfiguracion() {
    // Primero: poblar los campos del modal
    if (poblarModal()) {
        // Segundo: abrir el modal
        const modalElement = document.getElementById('modalCalculadoraNoLineal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            aplicarEstilosModal();

        }
    } else {
        alert('Error al cargar la configuraci√≥n en el modal.');
    }

}

// Funci√≥n para guardar y calcular (desde el modal)
function guardarYCalcularModal() {
    if (event) event.preventDefault(); // ‚Üê Esto evita el submit
    try {
        // Obtener valores del formulario modal
        const weightChangeGoal = parseFloat(document.getElementById('weightGoalModal').value);
        const weeklyCalorieDiff = parseFloat(document.getElementById('weeklyCalorieDiffModal').value);
        const currentWeightKg = parseFloat(document.getElementById('currentWeightModal').value);

        const userData = {
            userGender: document.getElementById('userGenderModal').value,
            userAge: parseInt(document.getElementById('userAgeModal').value),
            currentFatPerc: parseFloat(document.getElementById('currentFatPercModal').value),
            isAthlete: document.getElementById('isAthleteModal').checked,
            activityLevel: document.getElementById('activityLevelModal').value
        };

        // Validaciones b√°sicas
        if ([weightChangeGoal, weeklyCalorieDiff, currentWeightKg].some(isNaN)) {
            alert('Por favor, complete todos los campos num√©ricos correctamente.');
            return;
        }

        if (userData.currentFatPerc < 5 || userData.currentFatPerc > 60) {
            alert('El porcentaje de grasa corporal debe estar entre 5% y 60%.');
            return;
        }

        // Calcular
        const resultado = calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData);

        // Guardar datos globalmente
        /**
         * Almacena el resultado completo del c√°lculo no lineal para reutilizarlo en otras funciones.
         * Contiene:
         *   - semanas: array con el detalle semanal { numero, pesoAcumulado, tasa, tdee }
         *   - totalSemanas: n√∫mero total de semanas hasta alcanzar la meta
         *   - metaAlcanzada: booleano que indica si se alcanz√≥ la meta de peso
         *   - tasaInicial: tasa de cambio de peso inicial (kg/semana)
         *   - finalTDEE: valor final del gasto energ√©tico total ajustado por adaptaci√≥n metab√≥lica
         *   - esPerdida: indica si el objetivo fue p√©rdida (true) o ganancia (false) de peso
         *   - metaAbs: cantidad absoluta de peso a cambiar (kg)
         *   - tdeeInicial: gasto energ√©tico inicial antes de adaptaciones
         *
         * Ejemplo de uso:
         *   window.resultadoTiempoNoLineal.semanas[0].pesoAcumulado ‚Üí peso en la semana 1
         *   window.resultadoTiempoNoLineal.totalSemanas ‚Üí duraci√≥n total del plan
         *   window.resultadoTiempoNoLineal.finalTDEE ‚Üí TDEE al final del proceso
         */
        window.resultadoTiempoNoLineal = resultado;

        // Mostrar resumen (si aplica)
        //document.getElementById('resumen-plan-modal').style.display = 'block';
        document.getElementById('resumen-plan-modal').textContent =
            `Meta: ${Math.abs(weightChangeGoal)} kg en ${resultado.totalSemanas} semanas`;
        document.getElementById('resumen-velocidad-modal').textContent =
            `Tasa inicial: ${resultado.tasaInicial.toFixed(3)} kg/semana`;

        // Llenar la tabla en el nuevo modal
        if (typeof crearTablaProgresoModal === 'function') {
            crearTablaProgresoModal(resultado);
        } else {
            console.warn('Funci√≥n crearTablaProgresoModal no encontrada');
        }

        // ‚úÖ Mostrar mensaje de √©xito
        alert('‚úÖ C√°lculo completado correctamente');

        // ‚úÖ Abrir el nuevo modal con la tabla
        const modalTabla = new bootstrap.Modal(document.getElementById('modalTablaProgreso'));
        modalTabla.show();

    } catch (error) {
        console.error('Error en guardarYCalcularModal:', error);
        alert('Error al realizar el c√°lculo. Por favor, verifique los datos.');
    }
}



function exportarTablaProgreso() {
    if (!window.resultadoTiempoNoLineal) {
        alert('No hay datos para exportar.');
        return;
    }

    const { semanas } = window.resultadoTiempoNoLineal;
    let csv = 'Semana,Peso Acumulado (kg),Tasa (kg),TDEE (kcal)\n';

    semanas.forEach(s => {
        csv += `${s.numero},${s.pesoAcumulado},${s.tasa},${s.tdee}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'progreso_semanal.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// === C√ÅLCULO NO LINEAL (realista) - MEPNL v2.1 ===
function calcularTiempoNoLineal(weightChangeGoal, weeklyCalorieDiff, currentWeightKg, userData) {
    const { userGender, userAge, currentFatPerc, isAthlete, activityLevel } = userData;
    const esHombre = userGender === 'male';
    const esPerdida = weightChangeGoal < 0;
    const metaAbs = Math.abs(weightChangeGoal);
    const kcalPerKg = 7700;

    // --- 1. Estimar TDEE y NEAT (simplificado) ---
    const AF_FACTORS = {
        'sedentario': 1.2,
        'leve': 1.4,
        'moderate': 1.6,
        'active': 1.75,
        'very-active': 1.9
    };
    const afFactor = AF_FACTORS[activityLevel] || 1.4;

    // BMR (Mifflin-St Jeor - asumiendo altura promedio si no est√° disponible)
    const alturaEstimada = esHombre ? 175 : 162; // cm
    const bmr = esHombre
        ? (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) + 5
        : (10 * currentWeightKg) + (6.25 * alturaEstimada) - (5 * userAge) - 161;

    const neatExtra = isAthlete ? 500 : (afFactor >= 1.6 ? 300 : 150);
    const tdee = bmr * afFactor + neatExtra;

    // --- 2. Ajustes personalizados ---
    const esDeportista = isAthlete;
    const porcentajeGrasa = currentFatPerc;

    // Factor de adherencia
    const adherencia = 0.8;

    // Factor de correcci√≥n por tipo de tejido (simplificado)
    const goalTypeGlobal = 'ganancia1'; // Valor por defecto
    const fc = esPerdida
        ? 1.0
        : (goalTypeGlobal === 'ganancia1' ? 1.25 : 0.85);

    // Calor√≠a efectiva semanal (ajustada por adherencia)
    const weeklyCalorieDiffEffective = adherencia * weeklyCalorieDiff;

    // Tasa inicial (kg/semana)
    const r0 = Math.abs(weeklyCalorieDiffEffective) / (kcalPerKg * fc);

    // --- 3. Par√°metros personalizados por usuario ---
    let k, alpha, beta;

    if (esPerdida) {
        // P√©rdida: adaptaci√≥n metab√≥lica
        alpha = Math.max(0.5, 0.4 * (1 - 0.01 * porcentajeGrasa));
        k = 0.02; // Ralentizaci√≥n m√°s lenta
    } else {
        // Ganancia: progresi√≥n decreciente
        beta = Math.max(0.3, 0.4 * (1 - 0.004 * userAge + (esDeportista ? 0.1 : 0)));
        k = 0.06 * (1 + (false ? 0.4 : 0) - (esDeportista ? 0.2 : 0)); // isAdvanced hardcodeado a false
    }

    // --- 4. Simular semana a semana ---
    const semanas = [];
    let pesoAcumulado = 0;
    let semana = 0;
    let currentTDEE = tdee;

    while (pesoAcumulado < metaAbs && semana < 100) {
        semana++;

        // Ajuste del TDEE por p√©rdida de peso (adaptaci√≥n metab√≥lica)
        if (esPerdida && semana > 4) {
            const pesoPerdidoHastaAhora = (pesoAcumulado / metaAbs) * Math.abs(weightChangeGoal);
            const edad = +document.getElementById('userAgeModal').value
            // Factor de adaptaci√≥n m√°s agresivo para personas mayores
            const factorAdaptacion = 0.25 + (edad > 50 ? 0.1 : 0); // 0.35 para 55 a√±os
            currentTDEE = tdee * (1 - factorAdaptacion * (pesoPerdidoHastaAhora / currentWeightKg));
        }

        // Tasa semanal con decaimiento
        let factorProgresion;
        if (esPerdida) {
            factorProgresion = Math.max(alpha, 1 - k * (semana - 1));
        } else {
            factorProgresion = Math.max(beta || 0.4, 1 - k * (semana - 1));
        }

        let tasaSemanal = r0 * factorProgresion;

        // Ajuste adicional para deportistas en ganancia
        if (!esPerdida && esDeportista) {
            tasaSemanal *= 1.15;
        }

        pesoAcumulado += tasaSemanal;
        semanas.push({
            numero: semana,
            pesoAcumulado: parseFloat(pesoAcumulado.toFixed(2)),
            tasa: parseFloat(tasaSemanal.toFixed(2)),
            tdee: parseFloat(currentTDEE.toFixed(0))
        });
    }

    return {
        semanas,
        totalSemanas: semana,
        metaAlcanzada: pesoAcumulado >= metaAbs,
        tasaInicial: r0,
        finalTDEE: currentTDEE,
        esPerdida: esPerdida,
        metaAbs: metaAbs,
        tdeeInicial: tdee
    };
}

// === FUNCIONES DE VISUALIZACI√ìN ===
// Funci√≥n para calcular la velocidad a la mitad del proceso
function calcularVelocidadMitad(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return 0;

    // Buscar la semana donde se alcanza la mitad del peso objetivo
    const metaMitad = resultado.metaAbs / 2;
    let semanaMitad = 0;

    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].pesoAcumulado >= metaMitad) {
            semanaMitad = i;
            break;
        }
    }

    // Si no se encuentra, usar la semana del medio
    if (semanaMitad === 0) {
        semanaMitad = Math.floor(resultado.semanas.length / 2);
    }

    return resultado.semanas[semanaMitad].tasa;
}

// Funci√≥n para calcular la reducci√≥n porcentual
function calcularReduccionVelocidad(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0 || resultado.tasaInicial === 0) return 0;

    const velocidadFinal = resultado.semanas[resultado.semanas.length - 1].tasa;
    return ((resultado.tasaInicial - velocidadFinal) / resultado.tasaInicial * 100);
}

// Funci√≥n para calcular la velocidad promedio
function calcularVelocidadPromedio(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return 0;

    const suma = resultado.semanas.reduce((total, semana) => total + semana.tasa, 0);
    return suma / resultado.semanas.length;
}

// Funci√≥n para encontrar la semana donde se alcanza el 50%
function encontrarSemana50PorCiento(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return null;

    const meta50PorCiento = resultado.metaAbs * 0.5;

    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].pesoAcumulado >= meta50PorCiento) {
            return {
                semana: i + 1, // +1 porque los arrays empiezan en 0
                pesoAcumulado: resultado.semanas[i].pesoAcumulado,
                tasa: resultado.semanas[i].tasa
            };
        }
    }

    // Si no se alcanza el 50% (no deber√≠a pasar normalmente)
    return {
        semana: resultado.semanas.length,
        pesoAcumulado: resultado.semanas[resultado.semanas.length - 1].pesoAcumulado,
        tasa: resultado.semanas[resultado.semanas.length - 1].tasa
    };
}

// === FUNCIONES DE AN√ÅLISIS AVANZADO ===

/**
 * Encuentra el punto de inflexi√≥n donde la tasa de cambio deja de disminuir significativamente
 * @param {Object} resultado - Resultado del c√°lculo no lineal
 * @param {number} umbralDerivada - Umbral para considerar que la tasa se ha estabilizado (por defecto 0.001)
 * @returns {Object|null} Informaci√≥n sobre el punto de inflexi√≥n o null si no se encuentra
 */
function encontrarPuntoInflexion(resultado, umbralDerivada = 0.001) {
    if (!resultado.semanas || resultado.semanas.length < 3) return null;

    const semanas = resultado.semanas;

    // Calcular las derivadas segundas (curvatura) para encontrar puntos de inflexi√≥n
    for (let i = 1; i < semanas.length - 1; i++) {
        const tasaAnterior = semanas[i - 1].tasa;
        const tasaActual = semanas[i].tasa;
        const tasaSiguiente = semanas[i + 1].tasa;

        // Primera derivada (cambio en la tasa)
        const derivada1Anterior = tasaActual - tasaAnterior;
        const derivada1Siguiente = tasaSiguiente - tasaActual;

        // Segunda derivada (cambio en la pendiente)
        const derivada2 = derivada1Siguiente - derivada1Anterior;

        // Si la segunda derivada cambia de signo o se aproxima a cero,
        // estamos cerca de un punto de inflexi√≥n
        if (Math.abs(derivada2) < umbralDerivada) {
            return {
                semana: semanas[i].numero,
                tasa: semanas[i].tasa,
                tasaAnterior: tasaAnterior,
                tasaSiguiente: tasaSiguiente,
                derivadaSegunda: derivada2,
                pesoAcumulado: semanas[i].pesoAcumulado,
                porcentajeMeta: ((semanas[i].pesoAcumulado / resultado.metaAbs) * 100).toFixed(1)
            };
        }
    }

    return null;
}

/**
 * Encuentra el punto de estabilizaci√≥n donde la tasa de cambio se vuelve casi constante
 * @param {Object} resultado - Resultado del c√°lculo no lineal
 * @param {number} ventana - Ventana de semanas para calcular promedio m√≥vil
 * @param {number} umbralVariacion - Umbral de variaci√≥n para considerar estabilidad
 * @returns {Object|null} Informaci√≥n sobre el punto de estabilizaci√≥n
 */
function encontrarPuntoEstabilizacion(resultado, ventana = 5, umbralVariacion = 0.005) {
    if (!resultado.semanas || resultado.semanas.length < ventana * 2) return null;

    const semanas = resultado.semanas;

    // Buscar donde la variaci√≥n en una ventana se vuelve m√≠nima
    for (let i = ventana; i < semanas.length - ventana; i++) {
        // Calcular tasas en la ventana
        const tasasVentana = [];
        for (let j = i - Math.floor(ventana / 2); j <= i + Math.floor(ventana / 2); j++) {
            if (j >= 0 && j < semanas.length) {
                tasasVentana.push(semanas[j].tasa);
            }
        }

        if (tasasVentana.length === 0) continue;

        // Calcular promedio y desviaci√≥n est√°ndar
        const promedio = tasasVentana.reduce((sum, tasa) => sum + tasa, 0) / tasasVentana.length;
        const varianza = tasasVentana.reduce((sum, tasa) => sum + Math.pow(tasa - promedio, 2), 0) / tasasVentana.length;
        const desviacion = Math.sqrt(varianza);

        // Si la desviaci√≥n es menor que el umbral, hemos encontrado estabilidad
        if (desviacion < umbralVariacion) {
            return {
                semana: semanas[i].numero,
                tasa: semanas[i].tasa,
                promedioVentana: promedio,
                desviacion: desviacion,
                pesoAcumulado: semanas[i].pesoAcumulado,
                porcentajeMeta: ((semanas[i].pesoAcumulado / resultado.metaAbs) * 100).toFixed(1)
            };
        }
    }

    return null;
}

/**
 * Encuentra el punto donde la tasa de cambio se reduce a un porcentaje espec√≠fico de la inicial
 * @param {Object} resultado - Resultado del c√°lculo no lineal
 * @param {number} porcentajeReduccion - Porcentaje de la tasa inicial (ej: 50 para 50%)
 * @returns {Object|null} Informaci√≥n sobre el punto de reducci√≥n
 */
function encontrarPuntoReduccionTasa(resultado, porcentajeReduccion = 50) {
    if (!resultado.semanas || resultado.semanas.length === 0 || resultado.tasaInicial === 0) return null;

    const tasaObjetivo = resultado.tasaInicial * (porcentajeReduccion / 100);

    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].tasa <= tasaObjetivo) {
            return {
                semana: resultado.semanas[i].numero,
                tasa: resultado.semanas[i].tasa,
                tasaInicial: resultado.tasaInicial,
                porcentajeReduccion: porcentajeReduccion,
                pesoAcumulado: resultado.semanas[i].pesoAcumulado,
                porcentajeMeta: ((resultado.semanas[i].pesoAcumulado / resultado.metaAbs) * 100).toFixed(1)
            };
        }
    }

    return null;
}

/**
 * An√°lisis completo de puntos cr√≠ticos en la curva
 * @param {Object} resultado - Resultado del c√°lculo no lineal
 * @returns {Object} Objeto con todos los puntos cr√≠ticos encontrados
 */
function analizarPuntosCriticos(resultado) {
    return {
        puntoInflexion: encontrarPuntoInflexion(resultado),
        puntoEstabilizacion: encontrarPuntoEstabilizacion(resultado),
        puntoMitadTasa: encontrarPuntoReduccionTasa(resultado, 50),
        puntoCuartoTasa: encontrarPuntoReduccionTasa(resultado, 25),
        puntoOctavoTasa: encontrarPuntoReduccionTasa(resultado, 12.5)
    };
}

// === FUNCIONES DE VISUALIZACI√ìN MEJORADAS ===

/**
 * Funci√≥n para mostrar informaci√≥n de puntos cr√≠ticos en el resumen del modal
 * @param {Object} resultado - Resultado del c√°lculo no lineal
 */
function mostrarPuntosCriticos(resultado) {
    const puntos = analizarPuntosCriticos(resultado);
    const contenedor = document.getElementById('resumen-puntos-criticos');

    if (!contenedor) return;

    let html = '<div class="puntos-criticos-resumen"><h6>Puntos Cr√≠ticos del Progreso</h6>';

    if (puntos.puntoInflexion) {
        html += `
            <p><strong>Punto de Inflexi√≥n:</strong> Semana ${puntos.puntoInflexion.semana} 
            (${puntos.puntoInflexion.porcentajeMeta}% de la meta) - 
            Tasa: ${puntos.puntoInflexion.tasa.toFixed(3)} kg/semana</p>
        `;
    }

    if (puntos.puntoEstabilizacion) {
        html += `
            <p><strong>Estabilizaci√≥n:</strong> Semana ${puntos.puntoEstabilizacion.semana} 
            (${puntos.puntoEstabilizacion.porcentajeMeta}% de la meta) - 
            Tasa estable: ~${puntos.puntoEstabilizacion.tasa.toFixed(3)} kg/semana</p>
        `;
    }

    if (puntos.puntoMitadTasa) {
        html += `
            <p><strong>50% de Tasa Inicial:</strong> Semana ${puntos.puntoMitadTasa.semana} 
            (${puntos.puntoMitadTasa.porcentajeMeta}% de la meta)</p>
        `;
    }

    html += '</div>';

    contenedor.innerHTML = html;
}




// Funci√≥n para crear la tabla de progreso en el modal
function crearTablaProgresoModal(resultado) {
    try {
        const contenedor = document.getElementById('tabla-progreso-container-modal');

        // Calcular meses a partir de semanas
        const totalMeses = (resultado.totalSemanas / 4.34524).toFixed(1);

        let html = `
            <h5 class="mb-3">üìÖ Progreso Semanal Estimado - ${resultado.semanas.length} semanas</h5>
            <p class="text-muted"><small>Desliza hacia abajo para ver todas las semanas. El encabezado permanece fijo.</small></p>
            
            <div class="tabla-contenedor" style="height: 400px; overflow-y: auto; position: relative; border: 1px solid #dee2e6; border-radius: 8px; background: white; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                <table class="table" style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 0;">
                    <thead style="position: sticky; top: 0; z-index: 1000;">
                        <tr style="position: sticky; top: 0; z-index: 1000;">
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                Semana
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                ${resultado.esPerdida ? 'P√©rdida' : 'Ganancia'} Acumulada
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                ${resultado.esPerdida ? 'P√©rdida' : 'Ganancia'} Semanal
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                TDEE Ajustado
                            </th>
                            <th style="background: linear-gradient(135deg, #3c9141 0%, #2e7d32 100%) !important; color: white !important; padding: 12px 8px; font-weight: 600; text-align: center; border-bottom: 2px solid rgba(255, 255, 255, 0.3); position: sticky; top: 0; font-size: 0.85rem; white-space: nowrap; z-index: 1001; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-radius: 8px 8px 0 0;">
                                Cambio TDEE
                            </th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Mostrar TODAS las semanas
        resultado.semanas.forEach(semana => {
            const signo = resultado.esPerdida ? "-" : "+";
            const clase = resultado.esPerdida ? "negative-change" : "positive-change";
            const cambioTDEE = resultado.tdeeInicial - semana.tdee;
            const cambioTDEEText = cambioTDEE > 0 ? `-${cambioTDEE}` : `+${Math.abs(cambioTDEE)}`;

            html += `
                <tr style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center;" 
                    onmouseover="this.style.background='linear-gradient(90deg, #e8f5e9 0%, #d4edda 100%)'; this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 15px rgba(60, 145, 65, 0.2)'; this.style.zIndex='10'; this.style.position='relative'; this.style.borderLeft='3px solid #3c9141'; this.style.borderRight='3px solid #3c9141';"
                    onmouseout="this.style.background=''; this.style.transform='scale(1)'; this.style.boxShadow=''; this.style.zIndex=''; this.style.position=''; this.style.borderLeft=''; this.style.borderRight='';">
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;"><strong>${semana.numero}</strong></td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;" class="${clase}">${signo}${semana.pesoAcumulado.toFixed(2)} kg</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;" class="${clase}">${signo}${semana.tasa.toFixed(2)} kg</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;">${semana.tdee} kcal</td>
                    <td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; vertical-align: middle; text-align: center; font-size: 0.85rem; transition: all 0.2s ease;">${cambioTDEE !== 0 ? cambioTDEEText : '0'} kcal</td>
                </tr>
            `;
        });

        html += `</tbody></table></div>`;

        // Actualizar res√∫menes
        const semana50 = encontrarSemana50PorCiento(resultado);

        document.getElementById('resumen-plan-modal').innerHTML = `
            <strong>${resultado.totalSemanas} semanas (${totalMeses} meses)</strong> para
            ${resultado.esPerdida ? 'perder' : 'ganar'} 
            <strong>${resultado.metaAbs.toFixed(1)} kg</strong><br>
            TDEE inicial: <strong>${resultado.tdeeInicial.toFixed(0)} kcal</strong><br>
            TDEE final: <strong>${resultado.finalTDEE.toFixed(0)} kcal</strong><br>
            ${resultado.esPerdida ? 'P√©rdida' : 'Ganancia'} al 50%: <strong>Semana n¬∫${semana50 ? semana50.semana : 'N/A'}</strong> (${semana50 ? semana50.pesoAcumulado.toFixed(1) : 'N/A'} kg)<br>
        `;

        // An√°lisis de puntos cr√≠ticos
        const puntosCriticos = analizarPuntosCriticos(resultado);

        // A√±adir informaci√≥n de puntos cr√≠ticos y estrategias diet√©ticas
        let estrategiasHtml = '<div class="mt-3 estrategias-info">';

        if (resultado.esPerdida) {
            // ESTRATEGIAS PARA P√âRDIDA DE PESO
            if (puntosCriticos.puntoEstabilizacion) {
                estrategiasHtml += `
                    <div class="alert alert-warning">
                        <h6><strong>‚ö†Ô∏è Punto de Estabilizaci√≥n Detectado</strong></h6>
                        <p><strong>Semana ${puntosCriticos.puntoEstabilizacion.semana}</strong> 
                        (${puntosCriticos.puntoEstabilizacion.porcentajeMeta}% de tu objetivo) - 
                        Velocidad estable: <strong>${puntosCriticos.puntoEstabilizacion.tasa.toFixed(3)} kg/semana</strong></p>
                    </div>
                    
                    <div class="card" style="border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);">
                        <div class="card-header" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-bottom: 1px solid #ffc107; padding: 12px 15px;">
                            <h6 style="margin: 0; color: #856404; font-weight: 600;">
                                <i class="bi bi-lightbulb-fill"></i> Estrategias Diet√©ticas para Superar la Meseta (P√©rdida de Peso)
                            </h6>
                        </div>
                        <div class="card-body" style="padding: 15px;">
                            
                            <div class="alert alert-warning" style="font-size: 0.85rem; margin-bottom: 20px; border-radius: 6px;">
                                <strong>‚ö†Ô∏è Estrategias Proactivas desde el Inicio:</strong> Implementar estas t√°cticas desde el principio puede prevenir adaptaciones metab√≥licas excesivas y mantener una velocidad de p√©rdida m√°s constante (~0.2-0.3 kg/semana).
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>1. üéØ D√©ficit Cal√≥rico Moderado y Din√°mico</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Inicio:</strong> D√©ficit moderado (~500 kcal/d√≠a) para preservar metabolismo</li>
                                    <li><strong>Beneficio:</strong> Evita adaptaci√≥n metab√≥lica r√°pida y fatiga diet√©tica</li>
                                    <li><strong>Prevenci√≥n:</strong> Mantiene velocidad ~0.2-0.3 kg/semana, evita ca√≠das a 0.18 kg/semana</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>2. ü•© Alta Ingesta de Prote√≠na desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Dosis:</strong> 1.8-2.2 g/kg de peso corporal (190-230g para 105kg)</li>
                                    <li><strong>Beneficio:</strong> Preserva masa muscular y metabolismo basal</li>
                                    <li><strong>Efecto t√©rmico:</strong> 20-30% de calor√≠as se gastan en digesti√≥n</li>
                                    <li><strong>Avanzado:</strong> Implementar Protein Cycling tras 12-16 semanas</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>3. üí™ Entrenamiento de Fuerza desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Frecuencia:</strong> 2-3 sesiones semanales</li>
                                    <li><strong>Beneficio:</strong> Preserva masa muscular, aumenta TDEE, mejora sensibilidad insul√≠nica</li>
                                    <li><strong>Importante:</strong> Contrarresta sarcopenia a los 55 a√±os</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>4. üö∂ Incorporar NEAT desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Objetivo:</strong> 10,000-12,000 pasos/d√≠a</li>
                                    <li><strong>Beneficio:</strong> Aumenta d√©ficit sin reducir ingesta</li>
                                    <li><strong>Prevenci√≥n:</strong> Compensa reducci√≥n natural del TDEE</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>5. üîÅ Ciclado Cal√≥rico desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Estrategia:</strong> Alternar d√≠as de d√©ficit con d√≠as de mantenimiento/refeed</li>
                                    <li><strong>Beneficio:</strong> Previene adaptaci√≥n metab√≥lica y mejora leptina</li>
                                    <li><strong>Psicol√≥gico:</strong> Reduce fatiga diet√©tica y mejora adherencia</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>6. üçû Carb Cycling desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Patr√≥n:</strong> D√≠as altos (300g) con entrenamiento, bajos (100-150g) en descanso</li>
                                    <li><strong>Beneficio:</strong> Optimiza gluc√≥geno y rendimiento</li>
                                    <li><strong>Metab√≥lico:</strong> Fomenta oxidaci√≥n de grasas</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>7. üîÑ Fases de Mantenimiento Planificadas</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Timing:</strong> 1-2 semanas cada 8-12 semanas</li>
                                    <li><strong>Hormonal:</strong> Restablece leptina, tiroides y gasto energ√©tico</li>
                                    <li><strong>Prevenci√≥n:</strong> Reduce termog√©nesis adaptativa</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>8. üìã Flexible Dieting (Regla 80/20) desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Principio:</strong> 80% alimentos saludables, 20% flexibilidad</li>
                                    <li><strong>Beneficio:</strong> Mejora adherencia y evita abandono</li>
                                    <li><strong>Social:</strong> Facilita participaci√≥n en eventos</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>9. üõå Optimizaci√≥n del Estilo de Vida desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Sue√±o:</strong> 7-9 horas de calidad (regula cortisol y leptina)</li>
                                    <li><strong>Hidrataci√≥n:</strong> 2-3 L/d√≠a (apoya metabolismo)</li>
                                    <li><strong>Estr√©s:</strong> T√©cnicas de manejo (reduce cortisol)</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #e8f4f8; border-radius: 6px; border-left: 3px solid #17a2b8;">
                                <h6 style="color: #0c5460; margin-top: 0; margin-bottom: 10px;">
                                    <strong>10. üìä Monitoreo Proactivo desde el Inicio</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Peso:</strong> Semanalmente (lunes, ayunas, mismas condiciones)</li>
                                    <li><strong>Grasa:</strong> Cada 6 semanas (calibradores/bioimpedancia)</li>
                                    <li><strong>Ajuste:</strong> Si < 0.2 kg/semana ‚Üí aumentar d√©ficit o refeed adicional</li>
                                    <li><strong>Beneficio:</strong> Reacci√≥n r√°pida evita mesetas prolongadas</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-success" style="margin-top: 15px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
                                <strong>üåü Resultado Esperado:</strong> Con estas estrategias proactivas, la velocidad de p√©rdida puede mantenerse cerca de 0.2-0.3 kg/semana, retrasando significativamente la estabilizaci√≥n m√°s all√° de la semana 27. La clave es la implementaci√≥n temprana y consistente.
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 10px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
                                <strong>üí° Consejo Clave:</strong> Las mesetas son normales, pero con planificaci√≥n proactiva pueden ser m√°s cortas y menos pronunciadas. Combina estrategias preventivas con t√°cticas correctivas para mantener el progreso de forma sostenible.
                            </div>
                        </div>
						<div class="alert alert-success" style="margin-top: 15px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
							<strong>üìã Cronograma a Largo Plazo (P√©rdida de Peso):</strong><br>
							
							<strong>Semanas 1-${Math.min(12, resultado.totalSemanas)}:</strong> D√©ficit moderado (~500 kcal/d√≠a) con estrategias proactivas<br>
							<em>‚Ä¢ Semanas 1-${Math.min(4, resultado.totalSemanas)}:</em> Ciclado cal√≥rico, alta prote√≠na, NEAT<br>
							<em>‚Ä¢ Semanas ${Math.min(5, resultado.totalSemanas)}-${Math.min(8, resultado.totalSemanas)}:</em> Carb cycling, entrenamiento fuerza<br>
							<em>‚Ä¢ Semanas ${Math.min(9, resultado.totalSemanas)}-${Math.min(12, resultado.totalSemanas)}:</em> Flexible dieting, optimizaci√≥n sue√±o<br>
							
							${resultado.totalSemanas >= 13 ?
                        `<strong>Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(14, resultado.totalSemanas)}:</strong> Fase de mantenimiento planificada<br>
							<em>‚Ä¢ Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(14, resultado.totalSemanas)}:</em> TDEE completo, refeed estrat√©gico<br>` : ''}
							
							${resultado.totalSemanas >= 15 ?
                        `<strong>Semanas ${Math.min(15, resultado.totalSemanas)}-${Math.min(26, resultado.totalSemanas)}:</strong> Ajuste din√°mico seg√∫n progreso<br>
							<em>‚Ä¢ Semanas ${Math.min(15, resultado.totalSemanas)}-${Math.min(18, resultado.totalSemanas)}:</em> Aumentar d√©ficit si < 0.2 kg/semana<br>
							<em>‚Ä¢ Semanas ${Math.min(19, resultado.totalSemanas)}-${Math.min(22, resultado.totalSemanas)}:</em> Protein cycling, refeeds semanales<br>
							<em>‚Ä¢ Semanas ${Math.min(23, resultado.totalSemanas)}-${Math.min(26, resultado.totalSemanas)}:</em> Evaluaci√≥n completa<br>` : ''}
							
							${resultado.totalSemanas >= 27 ?
                        `<strong>Semanas ${Math.min(27, resultado.totalSemanas)}-${resultado.totalSemanas}:</strong> Continuaci√≥n con monitoreo proactivo<br>
							<em>‚Ä¢ Semanas ${Math.min(27, resultado.totalSemanas)}-${Math.min(36, resultado.totalSemanas)}:</em> Ciclos 4 semanas + 1 mantenimiento<br>
							<em>‚Ä¢ Semanas ${Math.min(37, resultado.totalSemanas)}-${Math.min(48, resultado.totalSemanas)}:</em> Ajustes mensuales TDEE<br>
							<em>‚Ä¢ Semanas ${Math.min(49, resultado.totalSemanas)}-${resultado.totalSemanas}:</em> Enfoque sostenibilidad<br>` : ''}
						</div>
                    </div>
                `;
            }
        } else {
            // ESTRATEGIAS PARA GANANCIA DE MASA MUSCULAR
            if (puntosCriticos.puntoEstabilizacion) {
                estrategiasHtml += `
                    <div class="alert alert-warning">
                        <h6><strong>‚ö†Ô∏è Punto de Estabilizaci√≥n Detectado</strong></h6>
                        <p><strong>Semana ${puntosCriticos.puntoEstabilizacion.semana}</strong> 
                        (${puntosCriticos.puntoEstabilizacion.porcentajeMeta}% de tu objetivo) - 
                        Velocidad estable: <strong>${puntosCriticos.puntoEstabilizacion.tasa.toFixed(3)} kg/semana</strong></p>
                    </div>
                    
                    <div class="card" style="border: 1px solid #ffc107; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.15);">
                        <div class="card-header" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-bottom: 1px solid #ffc107; padding: 12px 15px;">
                            <h6 style="margin: 0; color: #856404; font-weight: 600;">
                                <i class="bi bi-lightbulb-fill"></i> Estrategias para la Ganancia de Masa Muscular
                            </h6>
                        </div>
                        <div class="card-body" style="padding: 15px;">
                            
                            <div class="alert alert-warning" style="font-size: 0.85rem; margin-bottom: 20px; border-radius: 6px;">
                                <strong>‚ö†Ô∏è Estrategias Proactivas desde el Inicio:</strong> Implementar estas t√°cticas desde el principio puede optimizar la ganancia muscular (~0.1-0.2 kg/semana) y minimizar la acumulaci√≥n de grasa.
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>1. üéØ Super√°vit Cal√≥rico Controlado</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Inicio:</strong> Super√°vit moderado (~300-500 kcal/d√≠a)</li>
                                    <li><strong>Progresi√≥n:</strong> Aumentar a 500 kcal si ganancia < 0.05 kg/semana</li>
                                    <li><strong>Beneficio:</strong> Energ√≠a para s√≠ntesis muscular sin exceso de grasa</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>2. üí™ Entrenamiento de Fuerza Progresivo</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Principio:</strong> Sobrecarga progresiva como est√≠mulo principal</li>
                                    <li><strong>Frecuencia:</strong> 3-5 sesiones semanales</li>
                                    <li><strong>Variaci√≥n:</strong> Cambiar rutina cada 4-6 semanas</li>
                                    <li><strong>Beneficio:</strong> Estimula hipertrofia y aumenta TDEE</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>3. ü•© Alta Ingesta de Prote√≠na</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Dosis:</strong> 1.8-2.2 g/kg de peso corporal</li>
                                    <li><strong>Beneficio:</strong> Optimiza hipertrofia y preserva masa magra</li>
                                    <li><strong>Edad:</strong> Especialmente importante a los 55 a√±os</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>4. üîÅ Ciclado Cal√≥rico y Carbohidratos</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>D√≠as altos:</strong> 3-4 d√≠as entrenamiento (~3500 kcal, 450-500g carbohidratos)</li>
                                    <li><strong>D√≠as bajos:</strong> 3-4 d√≠as descanso (~3000 kcal, 300-350g carbohidratos)</li>
                                    <li><strong>Beneficio:</strong> Optimiza gluc√≥geno y minimiza grasa</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>5. üîÑ Fases de Mantenimiento Peri√≥dicas</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Timing:</strong> 1-2 semanas cada 8-12 semanas</li>
                                    <li><strong>Objetivo:</strong> Controlar grasa y mejorar sensibilidad insul√≠nica</li>
                                    <li><strong>Beneficio:</strong> Reduce acumulaci√≥n de grasa y permite recuperaci√≥n</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>6. üìã Flexible Dieting (Regla 80/20)</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Principio:</strong> 80% alimentos nutritivos, 20% para caprichos</li>
                                    <li><strong>Beneficio:</strong> Mejora adherencia psicol√≥gica</li>
                                    <li><strong>Social:</strong> 1-2 comidas semanales de flexibilidad</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #fff9e6; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <h6 style="color: #856404; margin-top: 0; margin-bottom: 10px;">
                                    <strong>7. üõå Optimizaci√≥n del Estilo de Vida</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Sue√±o:</strong> 7-9 horas de calidad (recuperaci√≥n muscular)</li>
                                    <li><strong>Hidrataci√≥n:</strong> 3-4 L diarios (m√°s durante entrenamientos)</li>
                                    <li><strong>Estr√©s:</strong> 10-15 min meditaci√≥n/yoga diarios</li>
                                    <li><strong>Micronutrientes:</strong> Magnesio, zinc, vitamina D</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #e8f4f8; border-radius: 6px; border-left: 3px solid #17a2b8;">
                                <h6 style="color: #0c5460; margin-top: 0; margin-bottom: 10px;">
                                    <strong>8. üìä Monitoreo Proactivo</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Peso y grasa:</strong> Cada 4-6 semanas (calibradores/bioimpedancia)</li>
                                    <li><strong>Fuerza:</strong> Evaluar aumentos en pesos levantados</li>
                                    <li><strong>Medidas:</strong> B√≠ceps, cu√°driceps, cintura</li>
                                    <li><strong>Ajuste:</strong> Si < 0.05 kg/semana ‚Üí aumentar super√°vit</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-info" style="margin-top: 20px; margin-bottom: 15px; font-size: 0.85rem; border-radius: 6px;">
                                <h6><strong>‚ö†Ô∏è ¬øPor qu√© ocurren mesetas?</strong></h6>
                                <ul style="margin-bottom: 0; padding-left: 20px;">
                                    <li><strong>Adaptaci√≥n muscular:</strong> M√∫sculos se adaptan al est√≠mulo (~0.05 kg/semana en semana 20-26)</li>
                                    <li><strong>L√≠mite gen√©tico:</strong> Potencial menor a los 55 a√±os por edad y hormonas</li>
                                    <li><strong>Super√°vit insuficiente:</strong> Errores en seguimiento cal√≥rico</li>
                                    <li><strong>Recuperaci√≥n:</strong> Sue√±o deficiente o sobreentrenamiento</li>
                                    <li><strong>Acumulaci√≥n de grasa:</strong> Super√°vit excesivo reduce eficiencia anab√≥lica</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 15px; padding: 10px; background-color: #d4edda; border-radius: 6px; border-left: 3px solid #28a745;">
                                <h6 style="color: #155724; margin-top: 0; margin-bottom: 10px;">
                                    <<strong>üîß Estrategias para Superar Mesetas (alrededor de la Semana ${puntosCriticos.puntoEstabilizacion.semana})</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 8px;">
                                    <li><strong>Aumentar super√°vit:</strong> 500-700 kcal/d√≠a (~3273-3473 kcal) durante 4-6 semanas</li>
                                    <li><strong>Modificar entrenamiento:</strong> T√©cnicas avanzadas (drop sets, superseries) o aumentar volumen</li>
                                    <li><strong>Protein cycling:</strong> 4 semanas altas, 1 semana moderada</li>
                                    <li><strong>Deload:</strong> 1 semana cada 8-12 semanas con menor volumen/intensidad</li>
                                </ul>
                            </div>
                            
                            <div class="strategy-section" style="margin-bottom: 0; padding: 10px; background-color: #f8d7da; border-radius: 6px; border-left: 3px solid #dc3545;">
                                <h6 style="color: #721c24; margin-top: 0; margin-bottom: 10px;">
                                    <strong>üö® Fase de Corte Temporal</strong>
                                </h6>
                                <ul style="font-size: 0.85rem; padding-left: 20px; margin-bottom: 0;">
                                    <li><strong>Indicaci√≥n:</strong> Si grasa corporal > 35%</li>
                                    <li><strong>Duraci√≥n:</strong> 4-6 semanas de d√©ficit (~500 kcal/d√≠a)</li>
                                    <li><strong>Retorno:</strong> Regresar al super√°vit despu√©s</li>
                                </ul>
                            </div>
                            
                           <div class="alert alert-success" style="margin-top: 15px; margin-bottom: 0; font-size: 0.8rem; border-radius: 6px;">
								<strong>üìã Cronograma a Largo Plazo (Ganancia de Masa Muscular):</strong><br>
								
								<strong>Semanas 1-${Math.min(10, resultado.totalSemanas)}:</strong> Super√°vit con ciclado cal√≥rico<br>
								<em>‚Ä¢ Semanas 1-${Math.min(4, resultado.totalSemanas)}:</em> Super√°vit moderado (300-500 kcal), alta prote√≠na<br>
								<em>‚Ä¢ Semanas ${Math.min(5, resultado.totalSemanas)}-${Math.min(8, resultado.totalSemanas)}:</em> Carb cycling, entrenamiento progresivo<br>
								<em>‚Ä¢ Semanas ${Math.min(9, resultado.totalSemanas)}-${Math.min(10, resultado.totalSemanas)}:</em> Evaluaci√≥n inicial, ajuste super√°vit<br>
								
								${resultado.totalSemanas >= 11 ?
                        `<strong>Semanas ${Math.min(11, resultado.totalSemanas)}-${Math.min(12, resultado.totalSemanas)}:</strong> Fase de mantenimiento<br>
								<em>‚Ä¢ Semanas ${Math.min(11, resultado.totalSemanas)}-${Math.min(12, resultado.totalSemanas)}:</em> Control grasa, recuperaci√≥n hormonal<br>` : ''}
								
								${resultado.totalSemanas >= 13 ?
                        `<strong>Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(20, resultado.totalSemanas)}:</strong> Ajuste super√°vit seg√∫n progreso<br>
								<em>‚Ä¢ Semanas ${Math.min(13, resultado.totalSemanas)}-${Math.min(16, resultado.totalSemanas)}:</em> Aumentar a 500-700 kcal si < 0.05 kg/semana<br>
								<em>‚Ä¢ Semanas ${Math.min(17, resultado.totalSemanas)}-${Math.min(20, resultado.totalSemanas)}:</em> Evaluaci√≥n composici√≥n corporal<br>` : ''}
								
								${resultado.totalSemanas >= 21 ?
                        `<strong>Semanas ${Math.min(21, resultado.totalSemanas)}-${Math.min(22, resultado.totalSemanas)}:</strong> Deload (reducci√≥n volumen)<br>
								<em>‚Ä¢ Semanas ${Math.min(21, resultado.totalSemanas)}-${Math.min(22, resultado.totalSemanas)}:</em> 50% volumen, enfoque recuperaci√≥n<br>` : ''}
								
								${resultado.totalSemanas >= 23 ?
                        `<strong>Semanas ${Math.min(23, resultado.totalSemanas)}-${Math.min(26, resultado.totalSemanas)}:</strong> Protein cycling<br>
								<em>‚Ä¢ Semanas ${Math.min(23, resultado.totalSemanas)}-${Math.min(25, resultado.totalSemanas)}:</em> Prote√≠na alta (1.8-2.2 g/kg)<br>
								<em>‚Ä¢ Semanas ${Math.min(26, resultado.totalSemanas)}:</em> Prote√≠na moderada (1.4-1.6 g/kg)<br>` : ''}
								
								${resultado.totalSemanas >= 27 ?
                        `<strong>Semanas ${Math.min(27, resultado.totalSemanas)}-${resultado.totalSemanas}:</strong> Repetir ciclos adaptativos<br>
								<em>‚Ä¢ Semanas ${Math.min(27, resultado.totalSemanas)}-${Math.min(36, resultado.totalSemanas)}:</em> Ciclos 8 semanas super√°vit + 2 mantenimiento<br>
								<em>‚Ä¢ Semanas ${Math.min(37, resultado.totalSemanas)}-${Math.min(48, resultado.totalSemanas)}:</em> Ajustes seg√∫n acumulaci√≥n grasa<br>
								<em>‚Ä¢ Semanas ${Math.min(49, resultado.totalSemanas)}-${resultado.totalSemanas}:</em> Optimizaci√≥n largo plazo<br>` : ''}
							</div>
                        </div>
                    </div>
                `;
            }
        }

        estrategiasHtml += '</div>';

        // A√±adir estrategias al final del contenido HTML
        html += estrategiasHtml;

        document.getElementById('resumen-velocidad-modal').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Vel. Inicio:</strong> ${resultado.tasaInicial.toFixed(2)} kg/sem
                </div>
                <div class="col-md-6">
                    <strong>Vel Mitad:</strong> ${calcularVelocidadMitad(resultado).toFixed(2)} kg/sem
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Vel Final:</strong> ${resultado.semanas[resultado.semanas.length - 1].tasa.toFixed(2)} kg/sem
                </div>
                <div class="col-md-6">
                    <strong>Vel Media:</strong> ${calcularVelocidadPromedio(resultado).toFixed(2)} kg/sem
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Reducci√≥n Vel:</strong> ${calcularReduccionVelocidad(resultado).toFixed(1)}%
                </div>
            </div>
        `;

        contenedor.innerHTML = html;
        // document.getElementById('result-container-modal').style.display = 'flex';



    } catch (error) {
        console.error('Error en crearTablaProgresoModal:', error);
        alert('Error al mostrar los resultados.');
    }
}

// Funci√≥n auxiliar para encontrar semana al 50%
function encontrarSemana50PorCiento(resultado) {
    if (!resultado.semanas || resultado.semanas.length === 0) return null;

    const meta50PorCiento = resultado.metaAbs * 0.5;

    for (let i = 0; i < resultado.semanas.length; i++) {
        if (resultado.semanas[i].pesoAcumulado >= meta50PorCiento) {
            return {
                semana: i + 1,
                pesoAcumulado: resultado.semanas[i].pesoAcumulado,
                tasa: resultado.semanas[i].tasa
            };
        }
    }

    return null;
}

// === INICIALIZACI√ìN ===

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function () {
    // Event listener para cuando el modal principal se abre
    const modalCalculadora = document.getElementById('modalCalculadoraNoLineal');
    if (modalCalculadora) {
        modalCalculadora.addEventListener('show.bs.modal', function () {
            // ‚úÖ Poblar autom√°ticamente los campos del formulario
            poblarModal();

            // ‚úÖ Resetear solo los resultados visuales del modal principal
            // (resumen, no la tabla)
            //document.getElementById('result-container-modal').style.display = 'none';
            //document.getElementById('resumen-plan-modal').textContent = '';
            //document.getElementById('resumen-velocidad-modal').textContent = '';
        });
    }

    // ‚úÖ Event listener para el nuevo modal de tabla (opcional)
    const modalTabla = document.getElementById('modalTablaProgreso');
    if (modalTabla) {
        modalTabla.addEventListener('show.bs.modal', function () {
            // ‚úÖ Opcional: Actualizar la tabla cada vez que se abre
            // (por si los datos cambiaron)
            if (window.resultadoTiempoNoLineal && typeof crearTablaProgresoModal === 'function') {
                crearTablaProgresoModal(window.resultadoTiempoNoLineal);
            } else {
                // Mostrar mensaje si no hay datos
                document.getElementById('tabla-progreso-container-modal').innerHTML = `
                    <div class="alert alert-warning text-center">
                        <p>No hay datos de progreso. Por favor, realiza un c√°lculo primero.</p>
                    </div>
                `;
            }
        });

        // ‚úÖ Opcional: Al cerrar, no limpiar (los datos persisten)
        // Si quieres limpiar al cerrar, descomenta:
        /*
        modalTabla.addEventListener('hidden.bs.modal', function () {
            // Limpiar tabla al cerrar (opcional)
            document.getElementById('tabla-progreso-container-modal').innerHTML = `
                <div class="alert alert-info text-center">
                    <p>Los resultados se mostrar√°n aqu√≠ despu√©s de calcular.</p>
                </div>
            `;
        });
        */
    }
});

// === FUNCI√ìN PARA CERRAR EL MODAL ===
function cerrarModalCalculadora() {
    const modalElement = document.getElementById('modalCalculadoraNoLineal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }
}

// --- Definici√≥n de Macros Predeterminados por Estrategia ---
// Clave: nombre de la estrategia (tal como aparece en el value del checkbox)
// Valor: objeto con claves 'proteinas', 'carbohidratos', 'grasas' y valores num√©ricos (%)
const MACROS_POR_ESTRATEGIA = {
    'ninguna': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // Valores base de la fase
    'refeed': { proteinas: 20, carbohidratos: 60, grasas: 20 }, // Alta en CH, baja en GR
    'carb_cycling': { proteinas: 25, carbohidratos: 50, grasas: 25 }, // Balance medio-alto CH
    'protein_cycling': { proteinas: 35, carbohidratos: 35, grasas: 30 }, // Alta en Pt
    'ckd': { proteinas: 30, carbohidratos: 50, grasas: 20 }, // CKD: D√≠as de carga alta en CH
    'tkd': { proteinas: 30, carbohidratos: 40, grasas: 30 }, // TKD: CH alrededor del entreno
    'if_16_8': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // IF: Igual que base
    'timing': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // Timing: Igual que base
    'flexible_dieting': { proteinas: 25, carbohidratos: 40, grasas: 35 }, // 80/20: Igual que base
    'hiperproteica': { proteinas: 35, carbohidratos: 35, grasas: 30 }, // Alta Pt
    // Puedes a√±adir m√°s estrategias y sus macros predeterminados aqu√≠
};


///////////////////MODAL PARA FILA DATOS TABLA DETALLADA//////////////////////
// --- Mapeo de objetivo descriptivo a clave simple ---
const MAPEO_OBJETIVO_A_SIMPLE = {
    // P√©rdida de Peso
    'perdida1': [
        'Reset metab√≥lico', 'inicio de p√©rdida de grasa', 'reducci√≥n de insulina',
        'Continuar p√©rdida de peso', 'mantener rendimiento f√≠sico', 'evitar estancamiento',
        'Mantener peso perdido', 'favorecer adherencia social', 'equilibrio nutricional',
        'Ajuste din√°mico seg√∫n progreso', 'Afinar hipertrofia en atletas intermedios/avanzados'
    ],
    // Ganancia de Masa Muscular
    'ganancia1': [
        'Evaluar estado inicial', 'establecer h√°bitos', 'preparar el cuerpo',
        'Maximizar hipertrofia con super√°vit controlado',
        'Consolidar ganancias', 'prevenir exceso de grasa',
        'Afinar hipertrofia en atletas intermedios/avanzados'
    ],
    // Mantenimiento de Peso
    'mantenimiento1': [
        'Estabilizar peso corporal', 'tras volumen o definici√≥n',
        'Preservar masa muscular y optimizar rendimiento',
        'Evaluar progreso y preparar pr√≥ximo ciclo'
    ],
    // Mixto
    'mixto1': [
        'P√©rdida de grasa con preservaci√≥n muscular',
        'Ganancia de masa muscular con m√≠nimo de grasa',
        'Fase de mantenimiento planificada'
    ]
};


// --- Definici√≥n de Estrategias por Objetivo ---
// Clave: objetivoUsuario (perdida1, ganancia1, mantenimiento1, mixto1)
// Valor: objeto con claves 'base', 'recomendadas' y 'fases'
const ESTRATEGIAS_POR_OBJETIVO = {
    perdida1: {
        base: ['Hiperproteica', 'Cetogenica', 'Baja en HC'],
        recomendadas: [
            'Carb Cycling',
            'Refeed Strategy',
            'Intermittent Fasting + Cycling',
            'Cyclic Ketogenic Diet (CKD)',
            'Targeted Ketogenic Diet (TKD)',
            'Protein Cycling',
            'Flexible Dieting Integration'
        ],
        fases: [
            {
                nombre: 'Fase 1: Inducci√≥n Cetog√©nica',
                semanas: '1‚Äì8',
                objetivoPrincipal: 'Reset metab√≥lico, inicio de p√©rdida de grasa, reducci√≥n de insulina',
                duracionSemanas: '4',
                macrosBase: { proteinasPct: '20-25%', carbohidratosPct: '5-10%', grasasPct: '65-75%' },
                observaciones: 'D√©ficit: 15-20% bajo GET (300-500 kcal/d√≠a). VLCKD: ‚Üì50g HC/d√≠a. 80/20 Rule: 80% alimentos integrales, 20% flexibles. Timing: 20-40g prote√≠na post-entreno. Intuitivo: Ajustar por hambre. Suplementos: Electrolitos, fibra. Monitorizar l√≠pidos, glucosa, cetonas (0.5-3 mmol/L).'
            },
            {
                nombre: 'Fase 2: Ciclado Metab√≥lico',
                semanas: '8‚Äì16',
                objetivoPrincipal: 'Continuar p√©rdida de peso, mantener rendimiento f√≠sico, evitar estancamiento',
                duracionSemanas: '4',

                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '10-25%', grasasPct: '50-65%' },
                observaciones: 'D√©ficit: 10-15% bajo GET (300-400 kcal/d√≠a). TKD: 20-50g HC pre/post entreno. Carb Cycling: 80-120g HC d√≠as entreno, 30-50g descanso. Periodizaci√≥n: Ajustar HC seg√∫n intensidad entreno. 80/20 Rule. Intuitivo: Ajustar por hambre/saciedad. Fraccionamiento: 4-5 comidas/d√≠a.'
            },
            {
                nombre: 'Fase 3: Transici√≥n a Mantenimiento',
                semanas: '16‚Äì24',
                objetivoPrincipal: 'Mantener peso perdido, favorecer adherencia social y equilibrio nutricional',
                duracionSemanas: '2',

                macrosBase: { proteinasPct: '22-25%', carbohidratosPct: '33-40%', grasasPct: '40-45%' },
                observaciones: 'D√©ficit: 0-5% bajo GET (0-100 kcal/d√≠a). Moderate-carb: 100-150g HC/d√≠a. Intuitivo: Ajustar por necesidades sociales. 80/20 Rule. Timing: 20-40g prote√≠na post-entreno. Evaluar composici√≥n corporal (bioimpedancia, plicometr√≠a). Suplementos: Creatina (3-5g/d√≠a), omega-3 (1-2g/d√≠a).'
            }
        ]
    },
    ganancia1: {
        base: ['Hiperproteica', 'Hipercalorica'],
        recomendadas: [
            'High Protein + Metabolic Cycling',
            'Refeed Strategy',
            'Meal Timing Optimization',
            'Carb-loading',
            'CKD: 5+2',
            'Performance Enhancement',
            'Protein Cycling'
        ],
        fases: [
            {
                nombre: 'Fase 1: Evaluaci√≥n y Base',
                semanas: '1‚Äì4',
                objetivoPrincipal: 'Evaluar estado inicial, establecer h√°bitos, preparar el cuerpo',
                duracionSemanas: '2',

                macrosBase: { proteinasPct: '16-22%', carbohidratosPct: '40-50%', grasasPct: '25-35%' },
                observaciones: 'Super√°vit moderado: +10-15% sobre GET (300-500 kcal/d√≠a). Iniciar entrenamiento de fuerza progresivo, priorizar alimentos integrales, sue√±o 7-9 h.'
            },
            {
                nombre: 'Fase 2: Volumen Progresivo',
                semanas: '8‚Äì16',
                objetivoPrincipal: 'Maximizar hipertrofia con super√°vit controlado',
                duracionSemanas: '4',

                macrosBase: { proteinasPct: '16-22%', carbohidratosPct: '50-60%', grasasPct: '20-30%' },
                observaciones: 'Super√°vit: +10-20% sobre GET. Ajustar seg√∫n ganancia (0.5-1 kg/mes). Aumentar intensidad del entrenamiento. Composici√≥n corporal cada 4-6 semanas.'
            },
            {
                nombre: 'Fase 3: Mantenimiento y Reajuste',
                semanas: '4‚Äì8',
                objetivoPrincipal: 'Consolidar ganancias, prevenir exceso de grasa',
                duracionSemanas: '2',

                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '40-50%', grasasPct: '25-35%' },
                observaciones: 'Super√°vit leve: +5-10% o mantenimiento si %grasa >15-20%. Evaluar fuerza, composici√≥n corporal, rendimiento. Considerar ciclado cal√≥rico.'
            },
            {
                nombre: 'Fase 4: Optimizaci√≥n y Volumen Avanzado',
                semanas: '8‚Äì24',
                objetivoPrincipal: 'Afinar hipertrofia en atletas intermedios/avanzados',
                duracionSemanas: '4',

                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '50-65%', grasasPct: 'Variable (6-8g entreno, 3-4g descanso)g' },
                observaciones: 'Super√°vit moderado: +10-15% o c√≠clico. Progreso cada 6-8 semanas. Periodizaci√≥n avanzada, suplementos (beta-alanina, citrulina), gestionar estr√©s.'
            }
        ]
    },
    mantenimiento1: {
        base: ['Equilibrada Nutricional', 'Calorie Cycling'],
        recomendadas: [
            'Flexible Dieting (80/20)',
            'Meal Timing Optimization',
            'Metabolic Flexibility Training',
            'Intermittent Fasting + Cycling',
            'Reverse Dieting',
            'Adaptive Periodization'
        ],
        fases: [
            {
                nombre: 'Subfase 1: Transici√≥n al Mantenimiento',
                semanas: '1‚Äì8',
                objetivoPrincipal: 'Estabilizar peso corporal tras volumen o definici√≥n',
                duracionSemanas: '2',


                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '30-40%', grasasPct: '30-40%' },
                observaciones: 'Calor√≠as: 0% super√°vit (igual al GET). Flexibilidad selectiva (80/20): 80% alimentos integrales, 20% flexibles. Timing: 20-40g prote√≠na post-entreno. Intuitivo: Ajustar por hambre/saciedad. Fraccionamiento: 4-5 comidas/d√≠a.'
            },
            {
                nombre: 'Subfase 2: Mantenimiento Estable',
                semanas: '8‚Äì12',
                objetivoPrincipal: 'Preservar masa muscular y optimizar rendimiento',
                duracionSemanas: '3',

                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '40-50%', grasasPct: '25-35%' },
                observaciones: 'Calor√≠as: 0% super√°vit, ajustar ¬±100-200 kcal si peso var√≠a ‚Üë 1 kg. CKD (5+2): 5 d√≠as 3-4g/kg HC, 2 d√≠as 6-8g/kg. TKD: 20-50g HC pre-entreno para atletas de fuerza. Ciclado CH suave: ¬±10% kcal seg√∫n entreno. Periodizaci√≥n: Ajustar HC a intensidad. 80/20 Rule. Intuitivo. Timing: 20-40g prote√≠na + 30-60g HC post-entreno.'
            },
            {
                nombre: 'Subfase 3: Reevaluaci√≥n y Preparaci√≥n',
                semanas: '8‚Äì12',
                objetivoPrincipal: 'Evaluar progreso y preparar pr√≥ximo ciclo (volumen o definici√≥n)',
                duracionSemanas: '2',

                macrosBase: { proteinasPct: '18-22%', carbohidratosPct: '30-40%', grasasPct: '30-40%' },
                observaciones: 'Calor√≠as: 0% super√°vit, ajustar seg√∫n pr√≥ximo objetivo. Flexibilidad selectiva (80/20). Intuitivo: Ajustar por se√±ales corporales. Periodizaci√≥n: Ajustar HC seg√∫n pr√≥ximo ciclo. Suplementos: Creatina (3-5g/d√≠a), omega-3 (1-2g/d√≠a).'
            }
        ]
    },
    mixto1: {
        base: ['Flexible Dieting (80/20)', 'Hiperproteica', 'Baja en HC', 'Ciclado metab√≥lico'],
        recomendadas: [
            'Carb Cycling',
            'Cyclic Ketogenic Diet (CKD)',
            'Refeed Strategy',
            'Intermittent Fasting + Cycling',
            'MFT (Keto ‚Üí moderate carb ‚Üí high carb)',
            'Adaptive Periodization'
        ],
        fases: [
            {
                nombre: 'Fase 1: P√©rdida de Peso',
                semanas: '4‚Äì12',
                objetivoPrincipal: 'P√©rdida de grasa con preservaci√≥n muscular',
                duracionSemanas: '4',

                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '10-20%', grasasPct: '55-65%' },
                observaciones: 'D√©ficit: 10-15% bajo GET (300-400 kcal/d√≠a). Carb Cycling: 30-80g HC d√≠as entreno, 10-30g descanso. Protein Cycling: 1.8-2.2g/kg prote√≠na. Timing: 20-40g prote√≠na post-entreno.'
            },
            {
                nombre: 'Fase 2: Ganancia Muscular',
                semanas: '12‚Äì24',
                objetivoPrincipal: 'Ganancia de masa muscular con m√≠nimo de grasa',
                duracionSemanas: '4',

                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '50-60%', grasasPct: '20-25%' },
                observaciones: 'Super√°vit: +5-10% sobre GET (200-300 kcal/d√≠a). Carb Cycling: 100-150g HC d√≠as fuerza, 60-80g d√≠as cardio. Protein Cycling: 2.0-2.5g/kg prote√≠na. Timing: 20-40g prote√≠na post-entreno.'
            },
            {
                nombre: 'Fase 3: Mantenimiento y Transici√≥n',
                semanas: '4-12',
                objetivoPrincipal: 'Fase de mantenimiento planificada',
                duracionSemanas: '1',

                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '45-55%', grasasPct: '25-30%' },
                observaciones: 'TDEE completo. Refeed estrat√©gico: 1 d√≠a/semana HC alto. Evaluaci√≥n fuerza, composici√≥n corporal. Ajuste fino: ¬±100-200 kcal seg√∫n tendencia.'
            },
            {
                nombre: 'Fase 4: Ajuste Din√°mico',
                semanas: '4-12',
                objetivoPrincipal: 'Ajuste din√°mico seg√∫n progreso',
                duracionSemanas: '3',

                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '45-55%', grasasPct: '25-30%' },
                observaciones: 'Ajuste semanal: ¬±200-300 kcal seg√∫n velocidad cambio. MFT: Rotar entre cetosis, moderate carb y high carb. Evaluaci√≥n completa: Semanas 35-38.'
            },
            {
                nombre: 'Fase 5: Continuaci√≥n Sostenible',
                semanas: '4-12',
                objetivoPrincipal: 'Continuaci√≥n con monitoreo proactivo',
                duracionSemanas: '5',

                macrosBase: { proteinasPct: '25-30%', carbohidratosPct: '45-55%', grasasPct: '25-30%' },
                observaciones: 'Ciclos 4 semanas + 1 mantenimiento. Ajustes mensuales TDEE. Enfoque sostenibilidad. Monitorizaci√≥n trimestral par√°metros fisiol√≥gicos.'
            }
        ]
    }
};
const MACROS_POR_ESTRATEGIA_AJUSTADO = {
    // --- P√©rdida de Peso ---
    'Carb Cycling': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Preserva m√∫sculo (30% prote√≠nas), controla calor√≠as (40% CH), saciedad/hormonas (30% grasas).

    'Refeed Strategy': { proteinas: 25, carbohidratos: 55, grasas: 20 },
    // Prote√≠nas moderadas (25%) para d√≠as de recarga, alta en CH (55%) para gluc√≥geno, baja en grasas (20%).

    'Intermittent Fasting + Cycling': { proteinas: 30, carbohidratos: 35, grasas: 35 },
    // Prote√≠nas altas (30%) para recuperaci√≥n en ayuno, CH moderados (35%) para flexibilidad, grasas (35%) para energ√≠a.

    'Cyclic Ketogenic Diet (CKD)': { proteinas: 30, carbohidratos: 15, grasas: 55 },
    // Cetosis: baja CH (15%), alta grasas (55%), prote√≠nas (30%) para m√∫sculo.

    'Targeted Ketogenic Diet (TKD)': { proteinas: 30, carbohidratos: 25, grasas: 45 },
    // CH peri-entreno (25%), grasas altas (45%) para cetosis, prote√≠nas (30%) para m√∫sculo.

    'Protein Cycling': { proteinas: 40, carbohidratos: 30, grasas: 30 },
    // Alta prote√≠na (40%) para s√≠ntesis muscular, CH y grasas balanceados (30%) para d√©ficit.

    'Flexible Dieting Integration': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Balanceado: prote√≠nas (30%) para m√∫sculo, CH (40%) y grasas (30%) para adherencia.

    // --- Ganancia de Masa Muscular ---
    'High Protein + Metabolic Cycling': { proteinas: 35, carbohidratos: 45, grasas: 20 },
    // Alta prote√≠na (35%) y CH (45%) para anabolismo, grasas bajas (20%) para priorizar CH.

    'Meal Timing Optimization': { proteinas: 30, carbohidratos: 45, grasas: 25 },
    // Prote√≠nas (30%) y CH (45%) para recuperaci√≥n/gluc√≥geno, grasas moderadas (25%).

    'Carb-loading': { proteinas: 25, carbohidratos: 60, grasas: 15 },
    // Alta CH (60%) para gluc√≥geno, prote√≠nas moderadas (25%), grasas bajas (15%).

    'CKD: 5+2': { proteinas: 30, carbohidratos: 15, grasas: 55 },
    // Cetosis en d√≠as bajos: CH (15%), grasas altas (55%), prote√≠nas (30%) para m√∫sculo.

    'Performance Enhancement': { proteinas: 30, carbohidratos: 50, grasas: 20 },
    // CH altos (50%) para rendimiento, prote√≠nas (30%) para recuperaci√≥n, grasas bajas (20%).

    // --- Mantenimiento de Peso ---
    'Flexible Dieting (80/20)': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Balanceado: prote√≠nas (30%) para m√∫sculo, CH (40%) y grasas (30%) para flexibilidad.

    'Metabolic Flexibility Training': { proteinas: 30, carbohidratos: 45, grasas: 25 },
    // Prote√≠nas (30%) para m√∫sculo, CH (45%) para flexibilidad metab√≥lica, grasas (25%).

    'Reverse Dieting': { proteinas: 30, carbohidratos: 45, grasas: 25 },
    // Prote√≠nas (30%) y CH (45%) para metabolismo, grasas (25%) para balance.

    // --- Estrategias Faltantes Agregadas ---
    'Adaptive Periodization': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Balanceado para mantenimiento: prote√≠nas (30%) para m√∫sculo, CH (40%) y grasas (30%) para ajustes din√°micos.

    'MFT (Keto ‚Üí moderate carb ‚Üí high carb)': { proteinas: 30, carbohidratos: 35, grasas: 35 }
    // Promedio para transici√≥n metab√≥lica: prote√≠nas (30%) para m√∫sculo, CH (35%) y grasas (35%) para flexibilidad.
};
const MACROS_POR_ESTRATEGIAS_BASE = {
    // Estrategias base para todos los objetivos
    'Hiperproteica': { proteinas: 40, carbohidratos: 30, grasas: 30 },
    // Alta prote√≠na (40%) para preservar/construir m√∫sculo, CH y grasas balanceados (30%) para flexibilidad.

    'Cetogenica': { proteinas: 25, carbohidratos: 5, grasas: 70 },
    // Muy baja en CH (5%) para cetosis, alta en grasas (70%) para energ√≠a, prote√≠nas moderadas (25%) para m√∫sculo.

    'Baja en HC': { proteinas: 35, carbohidratos: 25, grasas: 40 },
    // Prote√≠nas altas (35%) para m√∫sculo, CH bajos (25%) para control cal√≥rico, grasas moderadas (40%) para energ√≠a.

    'Hipercalorica': { proteinas: 25, carbohidratos: 55, grasas: 20 },
    // Alta en CH (55%) para anabolismo y energ√≠a, prote√≠nas moderadas (25%) para hipertrofia, grasas bajas (20%).

    'Equilibrada Nutricional': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Balanceada para mantenimiento: prote√≠nas (30%) para m√∫sculo, CH (40%) y grasas (30%) para sostenibilidad.

    'Calorie Cycling': { proteinas: 30, carbohidratos: 45, grasas: 25 },
    // Similar a equilibrada, con CH elevados (45%) para flexibilidad metab√≥lica, prote√≠nas (30%), grasas moderadas (25%).

    'Flexible Dieting (80/20)': { proteinas: 30, carbohidratos: 40, grasas: 30 },
    // Equilibrada para adherencia: prote√≠nas (30%) para m√∫sculo, CH (40%) y grasas (30%) para flexibilidad.

    'Ciclado metab√≥lico': { proteinas: 30, carbohidratos: 35, grasas: 35 }
    // Promedio para transiciones metab√≥licas: prote√≠nas (30%) para m√∫sculo, CH (35%) y grasas (35%) para flexibilidad.
};
// --- Definici√≥n del Mapeo de Estrategias Base por Objetivo ---


const MAPEO_ESTRATEGIAS_BASE = {
    perdida1: {
        base: [
            { nombre: 'Hiperproteica', mapeo: 'hiperproteica' },
            { nombre: 'Cetogenica', mapeo: 'induccion_cetogenica' },
            { nombre: 'Baja en HC', mapeo: 'baja_en_hc' } // Asumiendo que existe 'baja_en_hc' en estrategiasDisponibles
        ]
    },
    ganancia1: {
        base: [
            { nombre: 'Hiperproteica', mapeo: 'hiperproteica' },
            { nombre: 'High Protein + Metabolic Cycling', mapeo: 'protein_cycling' }, // Asumiendo que 'protein_cycling' es el equivalente
            { nombre: 'Protein Cycling', mapeo: 'protein_cycling' }, // Duplicado, pero lo dejo por tu descripci√≥n
            { nombre: 'Hipercalorica', mapeo: 'hipercalorica' }
        ]
    },
    mantenimiento1: {
        base: [
            { nombre: 'Equilibrada Nutricional', mapeo: 'equilibrada_nutricional' }, // Asumiendo que existe
            { nombre: 'Ninguna (Equilibrio nutricional)', mapeo: 'ninguna' },
            { nombre: 'Calorie Cycling', mapeo: 'calorie_cycling' } // Asumiendo que existe
        ]
    },
    mixto1: {
        base: [
            { nombre: 'Hiperproteica', mapeo: 'hiperproteica' },
            { nombre: 'protein cycling', mapeo: 'protein_cycling' }, // Min√∫scula como en estrategiasDisponibles
            { nombre: 'Ciclado metab√≥lico', mapeo: ['carb_cycling', 'ckd', 'tkd', 'mft', 'refeed', 'if_16_8'] }, // M√∫ltiples mapeos
            { nombre: 'Baja en HC', mapeo: 'baja_en_hc' } // Asumiendo que existe
        ]
    }
};

// --- Mapeo de Estrategias para Checkboxes del Modal ---
// Clave: valor del checkbox (como aparece en estrategiasDisponibles o en ESTRATEGIAS_POR_OBJETIVO.base/recomendadas)
// Valor: nombre legible para mostrar al usuario
const MAPEO_ESTRATEGIAS_CHECKBOX = {
    // --- Estrategias Base y Recomendadas de ESTRATEGIAS_POR_OBJETIVO ---
    // P√©rdida de Peso (perdida1)
    'Hiperproteica': 'Hiperproteica',
    'Cetogenica': 'Cetog√©nica',
    'Baja en HC': 'Baja en Hidratos de Carbono',
    'Carb Cycling': 'Carb Cycling',
    'Refeed Strategy': 'Refeed Strategy',
    'Intermittent Fasting + Cycling': 'Intermittent Fasting + Cycling',
    'Cyclic Ketogenic Diet (CKD)': 'Cyclic Ketogenic Diet (CKD)',
    'Targeted Ketogenic Diet (TKD)': 'Targeted Ketogenic Diet (TKD)',
    'Protein Cycling': 'Protein Cycling',
    'Flexible Dieting Integration': 'Flexible Dieting Integration',

    // Ganancia de Masa Muscular (ganancia1)
    'Hipercalorica': 'Hipercal√≥rica',
    'High Protein + Metabolic Cycling': 'High Protein + Metabolic Cycling',
    'Meal Timing Optimization': 'Meal Timing Optimization',
    'Carb-loading': 'Carb-loading',
    'CKD: 5+2': 'CKD: 5+2',
    'Performance Enhancement': 'Performance Enhancement',

    // Mantenimiento de Peso (mantenimiento1)
    'Equilibrada Nutricional': 'Equilibrada Nutricional',
    'Calorie Cycling': 'Calorie Cycling',
    'Flexible Dieting (80/20)': 'Flexible Dieting (80/20)',
    'Metabolic Flexibility Training': 'Metabolic Flexibility Training',
    'Reverse Dieting': 'Reverse Dieting',
    'Adaptive Periodization': 'Adaptive Periodization',

    // Mixto (mixto1)
    'Ciclado metab√≥lico': 'Ciclado Metab√≥lico',
    'MFT (Keto ‚Üí moderate carb ‚Üí high carb)': 'MFT (Keto ‚Üí moderate carb ‚Üí high carb)',

    // --- Estrategias Disponibles Originales (de los checkboxes actuales) ---
    'ninguna': 'Ninguna',
    'refeed': 'Refeed',
    'carb_cycling': 'Carb Cycling',
    'protein_cycling': 'Protein Cycling',
    'ckd': 'Cyclic Ketogenic Diet (CKD)',
    'tkd': 'Targeted Ketogenic Diet (TKD)',
    'if_16_8': 'Intermittent Fasting 16:8 (IF 16:8)',
    'timing': 'Timing Nutricional',
    'flexible_dieting': 'Flexible Dieting (80/20)',
    'hiperproteica': 'Dieta Hiperproteica',

    // --- Estrategias Adicionales Potenciales (para futuras expansiones) ---
    // Tipos de dieta
    'keto': 'Dieta Cetog√©nica',
    'low_carb': 'Baja en Carbohidratos',
    'high_protein': 'Alta en Prote√≠nas',
    'high_fat': 'Alta en Grasas',
    'paleo': 'Dieta Paleo',
    'mediterranean': 'Dieta Mediterr√°nea',
    'vegan': 'Dieta Vegana',
    'vegetarian': 'Dieta Vegetariana',

    // Estrategias de ayuno
    'if_14_10': 'Intermittent Fasting 14:10',
    'if_18_6': 'Intermittent Fasting 18:6',
    'if_20_4': 'Intermittent Fasting 20:4 (OMAD)',
    'alternate_day_fasting': 'Ayuno Intermitente Alterno',
    'extended_fasting': 'Ayuno Extendido',

    // Estrategias de entrenamiento nutricional
    'pre_workout_nutrition': 'Nutrici√≥n Pre-Entreno',
    'post_workout_nutrition': 'Nutrici√≥n Post-Entreno',
    'intra_workout_nutrition': 'Nutrici√≥n Intra-Entreno',
    'fasted_training': 'Entrenamiento en Ayunas',

    // Estrategias de macronutrientes espec√≠ficos
    'high_protein_low_carb': 'Alta Prote√≠na, Bajo Carbo',
    'high_carb_low_fat': 'Alto Carbo, Baja Grasa',
    'zone_diet': 'Dieta Zona (40-30-30)',
    'ketogenic_ratio': 'Ratio Cetog√©nico (3:1, 4:1)',

    // Estrategias de timing
    'meal_timing': 'Timing de Comidas',
    'nutrient_timing': 'Timing de Nutrientes',
    'caloric_timing': 'Timing Cal√≥rico',

    // Estrategias de flexibilidad
    'cheat_meals': 'Comidas de Enga√±o',
    'refeeds': 'Refeeds Cal√≥ricos',
    'carb_backloading': 'Carb Backloading',
    'fat_backloading': 'Fat Backloading',

    // Estrategias para condiciones espec√≠ficas
    'diabetes_management': 'Manejo de Diabetes',
    'pcos_friendly': 'Amigable con SOP',
    'heart_health': 'Salud Card√≠aca',
    'gut_health': 'Salud Intestinal',
    'immune_support': 'Soporte Inmunol√≥gico',

    // Estrategias avanzadas
    'precision_nutrition': 'Nutrici√≥n de Precisi√≥n',
    'metabolic_confusion': 'Confusi√≥n Metab√≥lica',
    'calorie_shifting': 'Shifting Cal√≥rico',
    'nutrient_density': 'Densidad Nutricional',
    'micronutrient_optimization': 'Optimizaci√≥n de Micronutrientes',

    // Estrategias de ciclo
    'macro_cycling': 'Ciclado de Macronutrientes',
    'micro_cycling': 'Ciclado de Micronutrientes',
    'periodized_nutrition': 'Nutrici√≥n Periodizada',
    'reverse_cycling': 'Ciclado Inverso',

    // Estrategias de control
    'portion_control': 'Control de Porciones',
    'mindful_eating': 'Alimentaci√≥n Consciente',
    'behavioral_nutrition': 'Nutrici√≥n Conductual',
};

//// FUNCIONES DEPENDIENTES  /////

/**
 * Genera el HTML y el contenido para el gr√°fico de progreso estimado en el modal.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El n√∫mero de semana actual dentro del plan.
 * @param {number} pesoEstimadoActual - El peso estimado para la semana actual.
 * @returns {string} El HTML del gr√°fico de progreso (placeholder o vac√≠o, ya que el canvas se dibuja por JS).
 */
function generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual) {
    console.log(`[Modal Avanzado] Generando gr√°fico de progreso para fase '${datosFaseBase.nombreFase}', semana ${semanaActual}, peso ${pesoEstimadoActual}kg.`);

    try {
        // --- 1. Validar argumentos ---
        if (!datosFaseBase || typeof datosFaseBase !== 'object') {
            throw new Error("datosFaseBase no es un objeto v√°lido.");
        }
        if (isNaN(semanaActual) || semanaActual < 1) {
            throw new Error("semanaActual no es un n√∫mero v√°lido.");
        }
        if (isNaN(pesoEstimadoActual) || pesoEstimadoActual <= 0) {
            throw new Error("pesoEstimadoActual no es un n√∫mero v√°lido.");
        }

        // --- 2. Obtener datos base de la fase ---
        const pesoInicioFase = datosFaseBase.pesoInicioFase;
        const pesoFinFase = datosFaseBase.pesoFinFase;
        const totalSemanasFase = datosFaseBase.semanasAsignadas || 12;
        const objetivoUsuario = datosFaseBase.objetivoPrincipal;

        // --- 3. Popular elementos existentes ---
        const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
        const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
        const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
        const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

        if (elementoPesoInicio) elementoPesoInicio.textContent = pesoInicioFase.toFixed(1);
        if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
        if (elementoPesoMeta) elementoPesoMeta.textContent = pesoFinFase.toFixed(1);

        if (barraProgresoGeneral) {
            const progresoPorcentaje = ((pesoInicioFase - pesoEstimadoActual) / (pesoInicioFase - pesoFinFase)) * 100;
            const progresoAjustado = Math.max(0, Math.min(100, progresoPorcentaje)); // Asegurar entre 0 y 100
            barraProgresoGeneral.style.width = `${progresoAjustado.toFixed(2)}%`;
            barraProgresoGeneral.setAttribute('aria-valuenow', progresoAjustado.toFixed(2));
            barraProgresoGeneral.textContent = `Progreso: ${progresoAjustado.toFixed(0)}%`;
        }

        // --- 4. Generar gr√°fico detallado en canvas ---
        // Esta parte se har√° con una funci√≥n auxiliar que trabaje directamente con el canvas
        // Llamar a la funci√≥n que dibuja el gr√°fico en el canvas
        setTimeout(() => {
            dibujarGraficoDetalladoEnCanvas(datosFaseBase, semanaActual, pesoEstimadoActual);
        }, 100); // Peque√±o retraso para asegurar que el canvas est√© en el DOM

        // --- 5. Devolver HTML placeholder ---
        // Como el gr√°fico se dibuja en el canvas, no necesitamos devolver HTML complejo aqu√≠.
        // El contenedor y el canvas ya est√°n en el HTML del modal.
        return ''; // O '<p class="text-muted small">Gr√°fico de evoluci√≥n cargado.</p>';

    } catch (error) {
        console.error(`[Modal Avanzado] Error al generar el gr√°fico de progreso para fase '${datosFaseBase?.nombreFase || 'desconocida'}':`, error);
        return '<p class="text-danger small">‚ùå Error al cargar el gr√°fico de progreso.</p>';
    }
}

/**
 * Dibuja el gr√°fico detallado de evoluci√≥n de peso en el canvas del modal.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El n√∫mero de semana actual dentro del plan.
 * @param {number} pesoEstimadoActual - El peso estimado para la semana actual.
 */
function dibujarGraficoDetalladoEnCanvas(datosFaseBase, semanaActual, pesoEstimadoActual) {
    console.log(`[Modal Avanzado] Dibujando gr√°fico detallado en canvas para fase '${datosFaseBase.nombreFase}', semana ${semanaActual}.`);

    try {
        // --- 1. Obtener el elemento canvas ---
        const canvas = document.getElementById('modalCanvasGraficoDetallado');
        if (!canvas) {
            console.warn("[Modal Avanzado] Canvas para gr√°fico detallado no encontrado.");
            return;
        }

        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error("[Modal Avanzado] No se pudo obtener el contexto 2D del canvas.");
            return;
        }

        // --- 2. Obtener datos base de la fase ---
        const pesoInicioFase = datosFaseBase.pesoInicioFase;
        const pesoFinFase = datosFaseBase.pesoFinFase;
        const totalSemanasFase = datosFaseBase.semanasAsignadas || 12;
        const objetivoUsuario = datosFaseBase.objetivoPrincipal;

        // --- 3. Generar datos de ejemplo para el gr√°fico ---
        // En una implementaci√≥n completa, estos datos vendr√≠an de `calcularTiempoNoLineal`
        // Por ahora, generamos una curva de ejemplo
        const datosGrafico = [];
        for (let s = 1; s <= totalSemanasFase; s++) {
            // Simular una curva no lineal (ej: p√©rdida que se desacelera)
            const progreso = (s - 1) / (totalSemanasFase - 1);
            // Curva suave (ej: easeOutQuad)
            const progresoSuavizado = 1 - Math.pow(1 - progreso, 2);
            const pesoEnSemana = pesoInicioFase - (pesoInicioFase - pesoFinFase) * progresoSuavizado;
            datosGrafico.push({ semana: s, peso: pesoEnSemana });
        }

        // --- 4. Definir fases para el gr√°fico (ejemplo) ---
        // En una implementaci√≥n completa, estas vendr√≠an de `generarFasesEscaladas`
        const fasesParaGrafico = [
            { nombre: 'Fase 1: Inducci√≥n', inicio: 1, fin: 4, color: '#28a745' }, // Verde
            { nombre: 'Fase 2: Ciclado', inicio: 5, fin: 8, color: '#17a2b8' }, // Celeste
            { nombre: 'Fase 3: Transici√≥n', inicio: 9, fin: 12, color: '#ffc107' } // Amarillo
        ];

        // --- 5. Dibujar el gr√°fico en el canvas ---
        const ancho = canvas.width;
        const alto = canvas.height;
        const margen = 20;
        const anchoGrafico = ancho - 2 * margen;
        const altoGrafico = alto - 2 * margen;

        // a. Limpiar canvas
        ctx.clearRect(0, 0, ancho, alto);

        // b. Dibujar fondo
        ctx.fillStyle = '#f8f9fa';
        ctx.fillRect(0, 0, ancho, alto);

        // c. Encontrar m√≠nimos y m√°ximos para escalar
        const pesos = datosGrafico.map(d => d.peso);
        const pesoMin = Math.min(...pesos);
        const pesoMax = Math.max(...pesos);
        const rangoPeso = pesoMax - pesoMin;
        const semanas = datosGrafico.map(d => d.semana);
        const semanaMin = Math.min(...semanas);
        const semanaMax = Math.max(...semanas);
        const rangoSemana = semanaMax - semanaMin;

        // d. Dibujar ejes
        ctx.strokeStyle = '#6c757d';
        ctx.lineWidth = 1;
        // Eje X (Semanas)
        ctx.beginPath();
        ctx.moveTo(margen, alto - margen);
        ctx.lineTo(ancho - margen, alto - margen);
        ctx.stroke();
        // Eje Y (Peso)
        ctx.beginPath();
        ctx.moveTo(margen, margen);
        ctx.lineTo(margen, alto - margen);
        ctx.stroke();

        // e. Dibujar etiquetas de ejes
        ctx.fillStyle = '#495057';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        // Etiquetas X
        ctx.fillText(`Sem ${semanaMin}`, margen, alto - 5);
        ctx.fillText(`Sem ${semanaMax}`, ancho - margen, alto - 5);
        // Etiquetas Y
        ctx.textAlign = 'right';
        ctx.fillText(`${pesoMax.toFixed(1)}kg`, margen - 5, margen + 5);
        ctx.fillText(`${pesoMin.toFixed(1)}kg`, margen - 5, alto - margen - 5);

        // f. Dibujar √°reas de fases
        fasesParaGrafico.forEach(fase => {
            const xInicio = margen + ((fase.inicio - semanaMin) / rangoSemana) * anchoGrafico;
            const xFin = margen + ((fase.fin - semanaMin) / rangoSemana) * anchoGrafico;
            const anchoFase = xFin - xInicio;

            ctx.fillStyle = fase.color + '40'; // A√±adir transparencia (40 = 25%)
            ctx.fillRect(xInicio, margen, anchoFase, altoGrafico);

            // Etiqueta de fase (opcional)
            ctx.fillStyle = fase.color;
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(fase.nombre, xInicio + anchoFase / 2, margen + 15);
        });

        // g. Dibujar l√≠nea de evoluci√≥n
        ctx.beginPath();
        ctx.strokeStyle = '#007bff'; // Azul Bootstrap
        ctx.lineWidth = 2;
        datosGrafico.forEach((dato, index) => {
            const x = margen + ((dato.semana - semanaMin) / rangoSemana) * anchoGrafico;
            const y = margen + (1 - (dato.peso - pesoMin) / rangoPeso) * altoGrafico; // Invertir Y

            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        ctx.stroke();

        // h. Dibujar punto actual
        const xActual = margen + ((semanaActual - semanaMin) / rangoSemana) * anchoGrafico;
        const yActual = margen + (1 - (pesoEstimadoActual - pesoMin) / rangoPeso) * altoGrafico; // Invertir Y
        ctx.beginPath();
        ctx.arc(xActual, yActual, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#dc3545'; // Rojo Bootstrap
        ctx.fill();
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.stroke();

        // i. Dibujar l√≠nea vertical en semana actual
        ctx.beginPath();
        ctx.strokeStyle = '#6c757d';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 3]); // L√≠nea punteada
        ctx.moveTo(xActual, margen);
        ctx.lineTo(xActual, alto - margen);
        ctx.stroke();
        ctx.setLineDash([]); // Resetear estilo de l√≠nea

        // j. Popular leyenda (opcional)
        const leyendaElement = document.getElementById('modalLeyendaGraficoDetallado');
        if (leyendaElement) {
            let htmlLeyenda = '<div class="d-flex flex-wrap">';
            fasesParaGrafico.forEach(fase => {
                htmlLeyenda += `
                    <div class="me-3 mb-1">
                        <span class="badge" style="background-color: ${fase.color};">${fase.nombre}</span>
                    </div>
                `;
            });
            htmlLeyenda += `
                <div class="me-3 mb-1">
                    <span class="badge bg-primary">Evoluci√≥n de Peso</span>
                </div>
                <div class="me-3 mb-1">
                    <span class="badge bg-danger">D√≠a Actual (Sem ${semanaActual})</span>
                </div>
            `;
            htmlLeyenda += '</div>';
            leyendaElement.innerHTML = htmlLeyenda;
        }

        console.log(`[Modal Avanzado] Gr√°fico detallado dibujado con √©xito en canvas para fase '${datosFaseBase.nombreFase}'.`);

    } catch (error) {
        console.error(`[Modal Avanzado] Error al dibujar el gr√°fico detallado en canvas para fase '${datosFaseBase?.nombreFase || 'desconocida'}':`, error);
        // Opcional: Mostrar mensaje de error en el canvas o en la leyenda
        const canvas = document.getElementById('modalCanvasGraficoDetallado');
        const ctx = canvas?.getContext('2d');
        if (ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#dc3545';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Error al dibujar el gr√°fico', canvas.width / 2, canvas.height / 2);
        }
    }
}
/**
 * Genera un array de fases escaladas basado en el objetivo y la duraci√≥n total.
 * @param {string} objetivoUsuario - La clave del objetivo (perdida1, ganancia1, mantenimiento1, mixto1).
 * @param {number} totalSemanasFase - El n√∫mero total de semanas asignadas a esta fase/objetivo.
 * @returns {Array<Object>} Un array de objetos de fase con duraciones escaladas.
 */
/**
 * Genera un array de fases escaladas basado en el objetivo y la duraci√≥n total.
 * @param {string} objetivoUsuario - La clave del objetivo (perdida1, ganancia1, mantenimiento1, mixto1).
 * @param {number} totalSemanasFase - El n√∫mero total de semanas asignadas a esta fase/objetivo.
 * @returns {Array<Object>} Un array de objetos de fase con duraciones y pesos escalados.
 */
/**
 * Genera un array de fases escaladas basado en los datos del progreso no lineal almacenados globalmente.
 * Lee directamente de window.nonlinearProgressData_1.
 * @returns {Array<Object>} Un array de objetos de fase con duraciones y pesos escalados.
 */
function generarFasesEscaladas() {
    console.log(`[Cronograma] Generando fases escaladas usando datos globales de window.nonlinearProgressData_1.`);

    try {
        // --- 1. Validar datos globales ---
        if (!window.nonlinearProgressData_1 || typeof window.nonlinearProgressData_1 !== 'object') {
            console.error("[Cronograma] window.nonlinearProgressData_1 no est√° definido o no es un objeto v√°lido.");
            return [];
        }

        // --- 2. Obtener datos base del objeto global ---
        const datosGlobales = window.nonlinearProgressData_1;
        const objetivoTipo = datosGlobales.objetivo?.tipo; // "Ganancia" o "P√©rdida"
        const totalSemanasFase = datosGlobales.tiempo?.semanasEstimadas; // N√∫mero total de semanas
        const pesoInicialFase = datosGlobales.objetivo?.pesoInicial; // Peso inicial del plan
        const pesoFinalFase = datosGlobales.objetivo?.pesoFinal; // Peso final estimado del plan

        if (isNaN(totalSemanasFase) || totalSemanasFase <= 0) {
            console.error("[Cronograma] Total de semanas inv√°lido en window.nonlinearProgressData_1:", totalSemanasFase);
            return [];
        }

        if (pesoInicialFase === undefined || pesoFinalFase === undefined) {
            console.error("[Cronograma] Peso inicial o final no encontrado en window.nonlinearProgressData_1.");
            return [];
        }

        // --- 3. Mapear objetivo a clave de ESTRATEGIAS_POR_OBJETIVO ---
        let claveObjetivoSimple = 'perdida1'; // Valor por defecto
        if (objetivoTipo) {
            if (objetivoTipo.toLowerCase().includes('p√©rdida')) {
                claveObjetivoSimple = 'perdida1';
            } else if (objetivoTipo.toLowerCase().includes('ganancia')) {
                claveObjetivoSimple = 'ganancia1';
            } else if (objetivoTipo.toLowerCase().includes('mantenimiento')) {
                claveObjetivoSimple = 'mantenimiento1';
            } else {
                console.warn(`[Cronograma] Tipo de objetivo desconocido '${objetivoTipo}'. Usando 'perdida1' por defecto.`);
                claveObjetivoSimple = 'perdida1';
            }
        } else {
            console.warn("[Cronograma] Tipo de objetivo no encontrado en window.nonlinearProgressData_1. Usando 'perdida1' por defecto.");
        }

        console.log(`[Cronograma] Objetivo '${objetivoTipo}' mapeado a clave simple '${claveObjetivoSimple}'. Total semanas: ${totalSemanasFase}`);

        // --- 4. Obtener fases base del cat√°logo ---
        const estrategiasObjetivo = ESTRATEGIAS_POR_OBJETIVO[claveObjetivoSimple];
        if (!estrategiasObjetivo || !Array.isArray(estrategiasObjetivo.fases) || estrategiasObjetivo.fases.length === 0) {
            console.error(`[Cronograma] No se encontraron fases para el objetivo '${claveObjetivoSimple}' en ESTRATEGIAS_POR_OBJETIVO.`);
            return [];
        }

        let fasesBase = [...estrategiasObjetivo.fases]; // Copia para no mutar el original

        // --- 5. Aplicar ajustes din√°micos basados en la duraci√≥n total ---
        if (claveObjetivoSimple === 'perdida1' && totalSemanasFase < 12) {
            // Para p√©rdida, si es muy corto, quitar Fase 3 (Transici√≥n a Mantenimiento)
            console.log("[Cronograma] Duraci√≥n corta para 'perdida1'. Eliminando Fase 3 (Transici√≥n a Mantenimiento).");
            fasesBase = fasesBase.filter(fase => fase.nombre !== 'Fase 3: Transici√≥n a Mantenimiento');
        } else if (claveObjetivoSimple === 'ganancia1' && totalSemanasFase < 8) {
            // Para ganancia, si es muy corto, quitar Fase 1 (Evaluaci√≥n y Base)
            console.log("[Cronograma] Duraci√≥n corta para 'ganancia1'. Eliminando Fase 1 (Evaluaci√≥n y Base).");
            fasesBase = fasesBase.filter(fase => fase.nombre !== 'Fase 1: Evaluaci√≥n y Base');
        } else if (claveObjetivoSimple === 'mantenimiento1' && totalSemanasFase < 8) {
            // Para mantenimiento, si es muy corto, quitar Subfase 1 (Transici√≥n al Mantenimiento)
            console.log("[Cronograma] Duraci√≥n corta para 'mantenimiento1'. Eliminando Subfase 1 (Transici√≥n al Mantenimiento).");
            fasesBase = fasesBase.filter(fase => fase.nombre !== 'Subfase 1: Transici√≥n al Mantenimiento');
        } else if (claveObjetivoSimple === 'mixto1' && totalSemanasFase < 20) {
            // Para mixto, si es muy corto, quitar Fase 4 y 5 (Ajuste Din√°mico y Continuaci√≥n Sostenible)
            console.log("[Cronograma] Duraci√≥n corta para 'mixto1'. Eliminando Fase 4 (Ajuste Din√°mico) y Fase 5 (Continuaci√≥n Sostenible).");
            fasesBase = fasesBase.filter(fase =>
                fase.nombre !== 'Fase 4: Ajuste Din√°mico' &&
                fase.nombre !== 'Fase 5: Continuaci√≥n Sostenible'
            );
        }

        if (fasesBase.length === 0) {
            console.error(`[Cronograma] Despu√©s de aplicar ajustes din√°micos, no quedan fases para el objetivo '${claveObjetivoSimple}'.`);
            return [];
        }

        // --- 6. Calcular duraci√≥n escalada para las fases restantes ---
        // --- 4. Calcular duraci√≥n escalada para las fases restantes ---
        // a. Obtener ratios de duraci√≥n REAL de las fases base y validarlos
        const ratios = fasesBase.map(fase => {
            // Asegurarse de que fase.duracionSemanas sea un n√∫mero v√°lido
            const ratio = parseFloat(fase.duracionSemanas);
            if (isNaN(ratio) || ratio <= 0) {
                console.warn(`[Cronograma] Ratio inv√°lido encontrado para fase '${fase.nombre}':`, fase.duracionSemanas, ". Usando 1 como fallback.");
                return 1; // Fallback
            }
            return ratio;
        });
        console.log(`[Cronograma] Ratios de duraci√≥n para ${claveObjetivoSimple}:`, ratios);

        // b. Calcular suma total de ratios
        const sumaRatios = ratios.reduce((acc, ratio) => acc + ratio, 0);
        console.log(`[Cronograma] Suma total de ratios: ${sumaRatios}`);

        // c. Distribuir semanas totales y pesos proporcionalmente
        let semanasAcumuladas = 0;
        let pesoAcumulado = 0; // Variable para llevar la cuenta del cambio de peso
        // Obtener peso inicial y final del PLAN COMPLETO
        let pesoInicialPlan = 0;
        let pesoFinalPlan = 0;
        try {
            if (window.nonlinearProgressData_1 && window.nonlinearProgressData_1.objetivo) {
                pesoInicialPlan = window.nonlinearProgressData_1.objetivo.pesoInicial;
                pesoFinalPlan = window.nonlinearProgressData_1.objetivo.pesoFinal;
                console.log(`[Cronograma] Pesos del PLAN COMPLETO obtenidos de nonlinearProgressData_1: Inicio=${pesoInicialPlan}kg, Fin=${pesoFinalPlan}kg`);
            } else {
                // Fallback: Usar de datosFaseBase o de la fila original
                pesoInicialPlan = datosFaseBase.pesoInicioFase;
                pesoFinalPlan = datosFaseBase.pesoFinFase;
                console.warn(`[Cronograma] nonlinearProgressData_1 no disponible. Usando pesos de datosFaseBase: Inicio=${pesoInicialPlan}kg, Fin=${pesoFinalPlan}kg`);
            }
        } catch (e) {
            console.error(`[Cronograma] Error al obtener pesos del plan:`, e);
            // Valores por defecto
            pesoInicialPlan = datosFilaOriginal.pesoEstimado; // Peso actual de la fila
            pesoFinalPlan = pesoInicialPlan - 10; // Ejemplo de p√©rdida
        }
        const diferenciaPesoTotal = pesoFinalPlan - pesoInicialPlan;

        const fasesEscaladas = fasesBase.map((fase, index) => {
            // --- Calcular semanas asignadas a esta fase basadas en el ratio REAL ---
            const semanasParaEstaFase = Math.round((ratios[index] / sumaRatios) * totalSemanasFase);

            // --- Asegurar un m√≠nimo de 1 semana por fase, si es posible ---
            const semanasAsignadas = Math.max(1, semanasParaEstaFase);

            // --- Calcular rango de semanas para esta fase ---
            const semanaInicio = semanasAcumuladas + 1;
            const semanaFin = semanasAcumuladas + semanasAsignadas;
            const semanasTexto = `${semanaInicio}‚Äì${semanaFin}`;

            // --- Calcular pesos estimados para esta fase ---
            // Distribuir el cambio de peso total proporcionalmente al n√∫mero de semanas asignadas
            const cambioPesoParaEstaFase = (semanasAsignadas / totalSemanasFase) * diferenciaPesoTotal;
            const pesoInicioFaseItem = pesoInicialPlan + pesoAcumulado;
            const pesoFinFaseItem = pesoInicioFaseItem + cambioPesoParaEstaFase;
            pesoAcumulado += cambioPesoParaEstaFase;

            semanasAcumuladas += semanasAsignadas;

            // --- Devolver una copia del objeto fase con la duraci√≥n escalada, el rango de semanas y los pesos ---
            return {
                ...fase,
                duracionSemanas: semanasAsignadas,
                semanasTexto: semanasTexto,
                pesoInicioFase: parseFloat(pesoInicioFaseItem.toFixed(2)),
                pesoFinFase: parseFloat(pesoFinFaseItem.toFixed(2))
            };
        });

        // d. Ajustar posibles errores de redondeo para que la suma sea exactamente totalSemanasFase
        const semanasTotalesAsignadas = fasesEscaladas.reduce((acc, fase) => acc + fase.duracionSemanas, 0);
        const diferencia = totalSemanasFase - semanasTotalesAsignadas;
        if (Math.abs(diferencia) > 0.1 && fasesEscaladas.length > 0) {
            // A√±adir o restar la diferencia a la √∫ltima fase
            const ultimaFase = fasesEscaladas[fasesEscaladas.length - 1];
            ultimaFase.duracionSemanas += diferencia;
            // Recalcular semanasTexto para la √∫ltima fase
            const semanaInicioUltima = semanasTotalesAsignadas - (fasesEscaladas[fasesEscaladas.length - 2]?.duracionSemanas || 0) + 1;
            const semanaFinUltima = semanaInicioUltima + ultimaFase.duracionSemanas - 1;
            ultimaFase.semanasTexto = `${semanaInicioUltima}‚Äì${semanaFinUltima}`;
            console.log(`[Cronograma] Ajustando √∫ltima fase por diferencia de redondeo: ${diferencia} semanas.`);
        }
        console.log(`[Cronograma] Fases escaladas generadas con √©xito usando datos globales para objetivo '${claveObjetivoSimple}':`, fasesEscaladas);
        return fasesEscaladas;

    } catch (error) {
        console.error(`[Cronograma] Error al generar fases escaladas usando datos globales:`, error);
        return [];
    }
}
/**
 * Popula la secci√≥n "üìä Recordatorio de la Evoluci√≥n" del modal con datos din√°micos.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */
/**
 * Popula la secci√≥n "üìä Recordatorio de la Evoluci√≥n" del modal con datos din√°micos.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */

function popularSeccionRecordatorioEvolucion(indiceFila) {
    console.log(`[Modal Avanzado] Popular secci√≥n de Recordatorio de Evoluci√≥n para fila: ${indiceFila}`);

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;

        // Encontrar los datos originales espec√≠ficos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`[Modal Avanzado] √çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`[Modal Avanzado] No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Calcular informaci√≥n din√°mica ---
        // a. Fase Actual (ya la tenemos de datosFaseBase)
        const faseActual = datosFaseBase.nombreFase;

        // b. Semana/D√≠a Actual (desde el √≠ndice de la fila)
        const mes = parseInt(partesIndice[0], 10);
        const semana = parseInt(partesIndice[1], 10);
        const dia = parseInt(partesIndice[2], 10);
        const diaActual = datosFilaOriginal.dia; // Nombre del d√≠a (Lunes, Martes, etc.)
        const diaNumero = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'].indexOf(diaActual) + 1;
        const semanaActual = semana;

        // c. Total de Semanas en el PLAN COMPLETO (NO solo en la fase actual)
        // Cambio crucial: Usar el totalSemanasFase del plan completo, no de la fase mes 1-2
        let totalSemanasFase = 0;
        try {
            // ACCESO CORRECTO: Usar nonlinearProgressData_1.tiempo.semanasEstimadas
            if (window.nonlinearProgressData_1 && window.nonlinearProgressData_1.tiempo && window.nonlinearProgressData_1.tiempo.semanasEstimadas) {
                totalSemanasFase = window.nonlinearProgressData_1.tiempo.semanasEstimadas;
                console.log(`[Modal Avanzado] Total de semanas del PLAN COMPLETO obtenido de nonlinearProgressData_1: ${totalSemanasFase}`);
            } else {
                // Fallback: Intentar calcular desde datosFaseBase.mesesTexto si nonlinearProgressData_1 no est√° disponible
                const meses = datosFaseBase.mesesTexto.split('‚Äì').map(m => parseInt(m.trim()));
                const mesInicio = meses[0];
                const mesFin = meses.length > 1 ? meses[1] : mesInicio;
                totalSemanasFase = Math.round((mesFin - mesInicio + 1) * 4.34524);
                if (totalSemanasFase <= 0) {
                    throw new Error("N√∫mero de semanas inv√°lido calculado desde mesesTexto.");
                }
                console.warn(`[Modal Avanzado] nonlinearProgressData_1 no disponible. Usando c√°lculo desde mesesTexto: ${totalSemanasFase} semanas.`);
            }
        } catch (e) {
            console.error(`[Modal Avanzado] Error al calcular totalSemanasFase:`, e);
            // Valor por defecto seguro
            totalSemanasFase = datosFaseBase.semanasAsignadas || 12;
        }

        // d. D√≠as Restantes en la Fase
        // Calcular d√≠a global (1-97) dentro de la fase
        const semanasPorMes = 4.34524;
        const semanaGlobal = Math.floor((mes - 1) * semanasPorMes) + semana;
        const diaGlobal = ((semanaGlobal - 1) * 7) + diaNumero;
        const totalDiasFase = totalSemanasFase * 7;
        const diasRestantesFase = totalDiasFase - diaGlobal;

        // e. Peso Estimado Actual (desde datosFilaOriginal)
        const pesoEstimadoActual = datosFilaOriginal.pesoEstimado;

        // f. Peso Inicial y Final de la Fase (desde datosFaseBase)
        const pesoInicialFase = datosFaseBase.pesoInicioFase;
        const pesoFinalFase = datosFaseBase.pesoFinFase;
        const cambioPesoAcumulado = pesoInicialFase - pesoEstimadoActual; // Para p√©rdida, ser√° positivo

        // g. Velocidad de Cambio (semanal, respecto al inicio de la fase)
        // Asumimos una duraci√≥n promedio de semana para calcular una velocidad instant√°nea
        const velocidadCambioSemanal = (cambioPesoAcumulado / (semanaGlobal - 1 + (diaNumero / 7))) || 0; // kg/semana

        // h. Pr√≥ximo Cambio de Fase (estimado)
        // Asumimos que el cambio de fase ocurre al finalizar las semanas de la fase actual
        const semanasRestantesFase = totalSemanasFase - semanaActual;
        const proximoCambioFase = `En ${semanasRestantesFase} semanas (Semana ${totalSemanasFase + 1})`;

        // i. Pr√≥xima Reevaluaci√≥n
        // Asumimos reevaluaci√≥n cada 12 semanas, o 8 si es m√°s corto
        const intervaloReevaluacion = 12; // semanas
        const proximaReevaluacionSemanas = Math.ceil(semanaActual / intervaloReevaluacion) * intervaloReevaluacion;
        const proximaReevaluacion = `Semana ${proximaReevaluacionSemanas} - Par√°metros fisiol√≥gicos`;

        // --- 4. Generar HTML del Cronograma Din√°mico ---
        console.log(`[Modal Avanzado] Generando cronograma para fila ${indiceFila}. Datos:`, { datosFaseBase, semanaActual });
        let htmlCronograma = '<p class="text-muted">Cargando cronograma...</p>';

        if (typeof generarCronogramaHTML === 'function') {
            try {
                htmlCronograma = generarCronogramaHTML(datosFaseBase, semanaActual);
                console.log(`[Modal Avanzado] HTML del cronograma generado con √©xito para fila ${indiceFila}:`, htmlCronograma.substring(0, 200) + '...'); // Mostrar solo los primeros 200 caracteres
            } catch (e) {
                console.error(`[Modal Avanzado] Error al ejecutar generarCronogramaHTML para fila ${indiceFila}:`, e);
                // --- MOVIDO AQU√ç: Contenido est√°tico como fallback en caso de error ---
                htmlCronograma = `<ul class="mb-0 ps-3 small">
                    <li><strong>Semanas 1-12:</strong> D√©ficit moderado (~500 kcal/d√≠a) con estrategias proactivas
                        <ul class="ps-3">
                            <li>Semanas 1-4: Ciclado cal√≥rico, alta prote√≠na, NEAT</li>
                            <li>Semanas 5-8: Carb cycling, entrenamiento fuerza</li>
                            <li>Semanas 9-12: Flexible dieting, optimizaci√≥n sue√±o</li>
                        </ul>
                    </li>
                    <li><strong>Semanas 13-14:</strong> Fase de mantenimiento planificada
                        <ul class="ps-3">
                            <li>Semanas 13-14: TDEE completo, refeed estrat√©gico</li>
                        </ul>
                    </li>
                    <li><strong>Semanas 15-26:</strong> Ajuste din√°mico seg√∫n progreso
                        <ul class="ps-3">
                            <li>Semanas 15-18: Aumentar d√©ficit si < 0.2 kg/semana</li>
                            <li>Semanas 19-22: Protein cycling, refeeds semanales</li>
                            <li>Semanas 23-26: Evaluaci√≥n completa</li>
                        </ul>
                    </li>
                    <li><strong>Semanas 27-97:</strong> Continuaci√≥n con monitoreo proactivo
                        <ul class="ps-3">
                            <li>Semanas 27-36: Ciclos 4 semanas + 1 mantenimiento</li>
                            <li>Semanas 37-48: Ajustes mensuales TDEE</li>
                            <li>Semanas 49-97: Enfoque sostenibilidad</li>
                        </ul>
                    </li>
                </ul>`;
                // --- FIN DE MOVIDO AQU√ç ---
            }
        } else {
            console.warn("[Modal Avanzado] Funci√≥n 'generarCronogramaHTML' no encontrada. Se usar√° contenido est√°tico.");
            // --- MOVIDO AQU√ç: Contenido est√°tico como fallback cuando la funci√≥n no existe ---
            htmlCronograma = `<ul class="mb-0 ps-3 small">
                <li><strong>Semanas 1-12:</strong> D√©ficit moderado (~500 kcal/d√≠a) con estrategias proactivas
                    <ul class="ps-3">
                        <li>Semanas 1-4: Ciclado cal√≥rico, alta prote√≠na, NEAT</li>
                        <li>Semanas 5-8: Carb cycling, entrenamiento fuerza</li>
                        <li>Semanas 9-12: Flexible dieting, optimizaci√≥n sue√±o</li>
                    </ul>
                </li>
                <li><strong>Semanas 13-14:</strong> Fase de mantenimiento planificada
                    <ul class="ps-3">
                        <li>Semanas 13-14: TDEE completo, refeed estrat√©gico</li>
                    </ul>
                </li>
                <li><strong>Semanas 15-26:</strong> Ajuste din√°mico seg√∫n progreso
                    <ul class="ps-3">
                        <li>Semanas 15-18: Aumentar d√©ficit si < 0.2 kg/semana</li>
                        <li>Semanas 19-22: Protein cycling, refeeds semanales</li>
                        <li>Semanas 23-26: Evaluaci√≥n completa</li>
                    </ul>
                </li>
                <li><strong>Semanas 27-97:</strong> Continuaci√≥n con monitoreo proactivo
                    <ul class="ps-3">
                        <li>Semanas 27-36: Ciclos 4 semanas + 1 mantenimiento</li>
                        <li>Semanas 37-48: Ajustes mensuales TDEE</li>
                        <li>Semanas 49-97: Enfoque sostenibilidad</li>
                    </ul>
                </li>
            </ul>`;
            // --- FIN DE MOVIDO AQU√ç ---
        }


        // --- 5. Generar HTML del Gr√°fico de Progreso (Placeholder) ---
        let htmlGrafico = '<p class="mb-0 text-muted"><i class="fas fa-chart-line me-1"></i> Gr√°fico de progreso estimado</p>';
        if (typeof generarGraficoProgresoHTML === 'function') {
            htmlGrafico = generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual);
        } else {
            console.warn("[Modal Avanzado] Funci√≥n 'generarGraficoProgresoHTML' no encontrada. Se usar√° placeholder.");
            // Placeholder: Gr√°fico de l√≠nea simple con CSS o canvas
            htmlGrafico = `<div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: ${(semanaActual / totalSemanasFase * 100).toFixed(2)}%"
                     aria-valuenow="${semanaActual}" aria-valuemin="0" aria-valuemax="${totalSemanasFase}">
                    ${semanaActual}/${totalSemanasFase} semanas
                </div>
            </div>
            <div class="d-flex justify-content-between small mt-1">
                <span>${pesoInicialFase.toFixed(1)} kg</span>
                <span>${pesoEstimadoActual.toFixed(1)} kg</span>
                <span>${pesoFinalFase.toFixed(1)} kg</span>
            </div>`;

            // b. Cronograma Din√°mico
            const contenedorCronograma = document.getElementById('modalCronogramaDinamico');
            if (contenedorCronograma) {
                console.log(`[Modal Avanzado] Insertando HTML del cronograma en el contenedor para fila ${indiceFila}.`);
                contenedorCronograma.innerHTML = htmlCronograma;
            } else {
                console.error("[Modal Avanzado] Contenedor '#modalCronogramaDinamico' no encontrado en el modal.");
            }
        }



        // --- 6. Popular elementos del DOM ---
        // a. Informaci√≥n de Progreso
        document.getElementById('modalFaseActual').textContent = faseActual;
        document.getElementById('modalSemanaActual').textContent = semanaActual;
        document.getElementById('modalTotalSemanas').textContent = totalSemanasFase;
        document.getElementById('modalDiaActual').textContent = diaActual;
        document.getElementById('modalDiasRestantesFase').textContent = diasRestantesFase > 0 ? diasRestantesFase : 0;

        // b. Cronograma Din√°mico
        const contenedorCronograma = document.getElementById('modalCronogramaDinamico');
        if (contenedorCronograma) {
            contenedorCronograma.innerHTML = htmlCronograma;
            console.log(`[Modal Avanzado] Cronograma insertado en el DOM para fila ${indiceFila}.`);
        } else {
            console.error("[Modal Avanzado] Contenedor '#modalCronogramaDinamico' no encontrado en el modal.");
        }

        // c. Gr√°fico de Progreso
        const contenedorGrafico = document.getElementById('modalGraficoProgreso');
        if (contenedorGrafico) {
            contenedorGrafico.innerHTML = htmlGrafico;
        }

        // d. Informaci√≥n de Cambio de Fase
        document.getElementById('modalInfoCambioFase').textContent = proximoCambioFase;


        // e. Reevaluaci√≥n
        const elementoProximaReevaluacion = document.getElementById('modalProximaReevaluacion'); // <-- ID CORRECTO del span
        if (elementoProximaReevaluacion) {
            elementoProximaReevaluacion.textContent = `Semana ${proximaReevaluacionSemanas} - Par√°metros fisiol√≥gicos`;
        } else {
            console.warn("[Modal Avanzado] Elemento con id 'modalProximaReevaluacion' no encontrado en el modal.");
        }

        // --- Fin de l√≠neas corregidas ---
        console.log(`[Modal Avanzado] Secci√≥n de Recordatorio de Evoluci√≥n popularizada con √©xito para fila ${indiceFila}.`);
        console.log({
            faseActual,
            semanaActual,
            totalSemanasFase,
            diaActual,
            diasRestantesFase,
            pesoEstimadoActual,
            pesoInicialFase,
            pesoFinalFase,
            cambioPesoAcumulado,
            velocidadCambioSemanal,
            proximoCambioFase,
            proximaReevaluacion
        });

    } catch (error) {
        console.error(`[Modal Avanzado] Error al popular la secci√≥n de Recordatorio de Evoluci√≥n para fila ${indiceFila}:`, error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert("Hubo un error al cargar la informaci√≥n de evoluci√≥n. Por favor, int√©ntalo de nuevo.");
    }
}

// --- Funciones auxiliares para generar contenido din√°mico (placeholders) ---

/**
 * Genera el HTML para el cronograma din√°mico basado en la fase y la semana actual.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El n√∫mero de semana actual dentro del plan.
 * @returns {string} El HTML del cronograma.
 */
/**
 * Genera el HTML para el cronograma din√°mico basado en la fase y la semana actual.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El n√∫mero de semana actual dentro del plan.
 * @returns {string} El HTML del cronograma.
 */
function generarCronogramaHTML(datosFaseBase, semanaActual) {
    console.log(`[Modal Avanzado] Generando cronograma HTML para fase '${datosFaseBase.nombreFase}' y semana ${semanaActual}.`);

    try {
        // --- 1. Validar argumentos ---
        if (!datosFaseBase || typeof datosFaseBase !== 'object') {
            console.error("[Modal Avanzado] datosFaseBase no es un objeto v√°lido en generarCronogramaHTML.", datosFaseBase);
            return '<p class="text-danger">‚ùå Error: Datos de fase inv√°lidos para generar el cronograma.</p>';
        }
        if (isNaN(semanaActual) || semanaActual < 1) {
            console.error("[Modal Avanzado] semanaActual no es un n√∫mero v√°lido en generarCronogramaHTML.", semanaActual);
            return '<p class="text-danger">‚ùå Error: Semana actual inv√°lida para generar el cronograma.</p>';
        }

        // --- 2. Obtener informaci√≥n de contexto y mapear objetivo ---
        // a. Obtener el objetivo principal descriptivo de la FASE BASE
        const objetivoFaseBaseDescriptivo = datosFaseBase.objetivoPrincipal; // Ej: "Reset metab√≥lico, inicio de p√©rdida de grasa, reducci√≥n de insulina"

        // b. Mapear objetivo descriptivo a la clave del cat√°logo ESTRATEGIAS_POR_OBJETIVO
        let claveObjetivoSimple = 'perdida1'; // Valor por defecto
        let objetivoEncontrado = false;
        for (const [claveSimple, palabrasClave] of Object.entries(MAPEO_OBJETIVO_A_SIMPLE)) {
            if (palabrasClave.some(palabra => objetivoFaseBaseDescriptivo.toLowerCase().includes(palabra.toLowerCase()))) {
                claveObjetivoSimple = claveSimple;
                objetivoEncontrado = true;
                break;
            }
        }

        if (!objetivoEncontrado) {
            console.warn(`[Modal Avanzado] Objetivo descriptivo '${objetivoFaseBaseDescriptivo}' no mapeado. Usando 'perdida1' por defecto.`);
            claveObjetivoSimple = 'perdida1'; // Fallback
        }

        const objetivoUsuario = claveObjetivoSimple; // <-- Esta es la clave correcta para ESTRATEGIAS_POR_OBJETIVO
        console.log(`[Modal Avanzado] Generando cronograma HTML para fase '${datosFaseBase.nombreFase}' y semana ${semanaActual}.`);
        // console.log(`[Modal Avanzado] IndiceFila (si existiera): ${indiceFila}`); // <-- Comentado o eliminado

        const nombreFase = datosFaseBase.nombreFase; // "Fase 1: Inducci√≥n Cetog√©nica"
        const mesesTexto = datosFaseBase.mesesTexto; // "1‚Äì2"
        const totalSemanasFase = datosFaseBase.semanasAsignadas || 12; // N√∫mero total de semanas asignadas a esta fase

        // --- 3. Generar fases escaladas ---
        const fasesEscaladas = generarFasesEscaladas(); // <-- Sin argumentos
        if (!fasesEscaladas || fasesEscaladas.length === 0) {
            console.warn(`[Modal Avanzado] No se generaron fases escaladas usando datos globales.`);
            return '<p class="text-muted">No hay fases definidas o datos insuficientes.</p>';
        }

        // --- 4. Generar HTML del cronograma ---
        let htmlCronograma = '<div class="cronograma-dinamico-wrapper">'; // Contenedor para el cronograma

        fasesEscaladas.forEach((fase, index) => {
            // --- a. Extraer informaci√≥n de la fase ---
            const nombreFaseItem = fase.nombre || `Fase ${index + 1}`;
            const objetivoFaseItem = fase.objetivoPrincipal || 'Objetivo no especificado';
            const duracionSemanasItem = fase.duracionSemanas || 0;
            const semanasTextoItem = fase.semanasTexto || 'Semanas no especificadas';
            // --- CORRECCI√ìN: Asegurar que pesoInicioFase y pesoFinFase est√©n definidos ---
            const pesoInicioFaseItem = fase.pesoInicioFase !== undefined ? fase.pesoInicioFase.toFixed(1) : 'N/A';
            const pesoFinFaseItem = fase.pesoFinFase !== undefined ? fase.pesoFinFase.toFixed(1) : 'N/A';
            // --- FIN DE CORRECCI√ìN ---
            const observacionesItem = fase.observaciones || 'Sin observaciones.';

            // --- b. Parsear macros base promedio de la fase ---
            const parsearRangoPorcentaje = (rangoStr) => {
                if (!rangoStr || typeof rangoStr !== 'string') return [25, 25];
                const partes = rangoStr.replace('%', '').split('-').map(Number);
                return partes.length === 2 ? partes : [partes[0], partes[0]];
            };

            let rangoProteinasPct = [25, 25];
            let rangoCarbohidratosPct = [40, 40];
            let rangoGrasasPct = [35, 35];
            try {
                rangoProteinasPct = parsearRangoPorcentaje(fase.macrosBase.proteinasPct);
                rangoCarbohidratosPct = parsearRangoPorcentaje(fase.macrosBase.carbohidratosPct);
                rangoGrasasPct = parsearRangoPorcentaje(fase.macrosBase.grasasPct);
            } catch (e) {
                console.warn("Error al parsear rangos de macros de la fase, usando valores por defecto.", e);
            }

            const proteinasPctPromedio = Math.round((rangoProteinasPct[0] + rangoProteinasPct[1]) / 2);
            const carbohidratosPctPromedio = Math.round((rangoCarbohidratosPct[0] + rangoCarbohidratosPct[1]) / 2);
            const grasasPctPromedio = 100 - proteinasPctPromedio - carbohidratosPctPromedio;

            // --- c. Calcular progreso dentro de esta fase ---
            // Parsear semanasTextoItem para obtener semanaInicio y semanaFin
            let semanaInicioFase = 1;
            let semanaFinFase = duracionSemanasItem;
            try {
                const partesSemanas = semanasTextoItem.split('‚Äì').map(Number);
                if (partesSemanas.length === 2) {
                    semanaInicioFase = partesSemanas[0];
                    semanaFinFase = partesSemanas[1];
                }
            } catch (e) {
                console.warn(`[Modal Avanzado] Error al parsear semanasTextoItem '${semanasTextoItem}' para fase '${nombreFaseItem}'. Usando valores por defecto.`, e);
            }

            const totalSemanasFaseItem = semanaFinFase - semanaInicioFase + 1;

            // Determinar si la semanaActual est√° dentro del rango de esta fase
            const esFaseActual = semanaActual >= semanaInicioFase && semanaActual <= semanaFinFase;

            // Calcular porcentaje de progreso dentro de esta fase
            let progresoFaseItem = 0;
            if (esFaseActual) {
                // Si es la fase actual, calcular progreso basado en la semana actual
                progresoFaseItem = ((semanaActual - semanaInicioFase + 1) / totalSemanasFaseItem) * 100;
            } else if (semanaActual > semanaFinFase) {
                // Si la semana actual es posterior, la fase est√° completada
                progresoFaseItem = 100;
            } else {
                // Si la semana actual es anterior, la fase a√∫n no ha comenzado
                progresoFaseItem = 0;
            }

            // Asegurar que el porcentaje est√© entre 0 y 100
            progresoFaseItem = Math.max(0, Math.min(100, progresoFaseItem));

            // --- d. Construir HTML para esta fase ---
            // Clase CSS para resaltar la fase actual
            const claseFaseActual = esFaseActual ? 'fase-actual' : '';

            htmlCronograma += `
                <div class="mb-3 p-2 border rounded ${claseFaseActual}" style="background-color: ${esFaseActual ? '#e8f5e9' : '#f8f9fa'};">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-primary ${esFaseActual ? 'fw-bold' : ''}">${nombreFaseItem}</h6>
                        <span class="badge bg-secondary">${semanasTextoItem}</span>
                    </div>
                    <p class="mb-1 small text-muted"><strong>Objetivo:</strong> ${objetivoFaseItem}</p>
                    <p class="mb-1 small"><strong>Duraci√≥n:</strong> ${duracionSemanasItem} semanas</p>
                    <p class="mb-1 small"><strong>Peso:</strong> ${pesoInicioFaseItem} kg ‚Üí ${pesoFinFaseItem} kg</p>
                    <p class="mb-2 small"><strong>Macros Base:</strong> Pt: ${proteinasPctPromedio}%, CH: ${carbohidratosPctPromedio}%, GR: ${grasasPctPromedio}%</p>
                    
                    <div class="progress mb-1" style="height: 15px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: ${progresoFaseItem.toFixed(2)}%" 
                             aria-valuenow="${progresoFaseItem.toFixed(2)}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${progresoFaseItem > 0 ? `${progresoFaseItem.toFixed(0)}%` : ''}
                        </div>
                    </div>
                </div>
            `;
        });

        htmlCronograma += '</div>'; // Cerrar contenedor

        console.log(`[Modal Avanzado] Cronograma HTML generado con √©xito para fase '${nombreFase}' y semana ${semanaActual}.`);
        return htmlCronograma;

    } catch (error) {
        console.error(`[Modal Avanzado] Error al generar el cronograma HTML para fase '${datosFaseBase?.nombreFase || 'desconocida'}' y semana ${semanaActual}:`, error);
        return '<p class="text-danger">‚ùå Error al generar el cronograma. Por favor, int√©ntalo de nuevo.</p>';
    }
}

/**
 * Genera el HTML para el gr√°fico de progreso estimado.
 * @param {Object} datosFaseBase - Los datos base de la fase.
 * @param {number} semanaActual - El n√∫mero de semana actual.
 * @param {number} pesoEstimadoActual - El peso estimado actual.
 * @returns {string} El HTML del gr√°fico.
 */
function generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual) {
    // Placeholder: Usar una barra de progreso simple de Bootstrap
    const pesoInicial = datosFaseBase.pesoInicioFase;
    const pesoFinal = datosFaseBase.pesoFinFase;
    const totalSemanas = datosFaseBase.semanasAsignadas || 12; // Asumir 12 si no est√°

    // Calcular porcentaje completado
    const pctCompletado = (semanaActual / totalSemanas) * 100;
    const pctCompletadoLimitado = Math.min(100, Math.max(0, pctCompletado)); // Limitar entre 0 y 100

    return `
        <div class="progress" style="height: 20px;">
          <div class="progress-bar bg-success" role="progressbar" 
               style="width: ${pctCompletadoLimitado.toFixed(2)}%" 
               aria-valuenow="${semanaActual}" aria-valuemin="0" aria-valuemax="${totalSemanas}">
            ${semanaActual}/${totalSemanas} semanas
          </div>
        </div>
        <div class="d-flex justify-content-between small mt-1">
          <span>${pesoInicial.toFixed(1)} kg (Inicio)</span>
          <span>${pesoEstimadoActual.toFixed(1)} kg (Actual)</span>
          <span>${pesoFinal.toFixed(1)} kg (Objetivo)</span>
        </div>
    `;
}
/**
 * Crea el HTML para la fila de configuraci√≥n de macros de una estrategia espec√≠fica.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 * @returns {HTMLElement|null} El elemento div que representa la fila de configuraci√≥n, o null si hay error.
 */
function crearFilaConfiguracionEstrategia(indiceFila, nombreEstrategia) {
    if (!indiceFila || !nombreEstrategia) {
        console.error("Error: Faltan par√°metros para crear la fila de configuraci√≥n de estrategia.");
        return null;
    }

    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;
    const filaConfigId = `fila-config-${idBase}`;

    // Crear el contenedor de la fila
    const divFila = document.createElement('div');
    divFila.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia'; // Clase CSS del CSS proporcionado
    divFila.setAttribute('data-estrategia-id', nombreEstrategia); // Para identificar la estrategia
    divFila.id = filaConfigId;

    // Crear el encabezado de la fila (nombre + bot√≥n cerrar)
    const divHeader = document.createElement('div');
    divHeader.className = 'd-flex justify-content-between align-items-center mb-2';

    const h6Nombre = document.createElement('h6');
    h6Nombre.className = 'mb-0 text-primary nombre-estrategia'; // Clase CSS del CSS proporcionado
    h6Nombre.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia'; // Clase CSS del CSS proporcionado
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    // A√±adir evento para eliminar esta fila espec√≠fica y desmarcar el checkbox
    botonCerrar.addEventListener('click', function () {
        const filaAEliminar = document.getElementById(filaConfigId);
        if (filaAEliminar) {
            filaAEliminar.remove();
            // Desmarcar el checkbox correspondiente
            const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
            const checkboxCorrespondiente = document.getElementById(checkboxId);
            if (checkboxCorrespondiente) {
                checkboxCorrespondiente.checked = false;
            }
            // Mostrar/Ocultar mensaje de "sin estrategias" si no quedan m√°s
            const contenedorConfig = document.getElementById('modalConfiguracionMacrosPorEstrategia');
            const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
            if (mensajeSinEstrategias && contenedorConfig && contenedorConfig.children.length === 0) {
                mensajeSinEstrategias.style.display = 'block';
            }
        }
    });

    divHeader.appendChild(h6Nombre);
    divHeader.appendChild(botonCerrar);
    divFila.appendChild(divHeader);

    // Crear el grupo de inputs de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia'; // Clase CSS del CSS proporcionado

    // Input Prote√≠nas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Prote√≠nas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm'; // Clase CSS del CSS proporcionado
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`; // A√±adir name para facilidad de acceso
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.step = '1';
    inputPt.value = '25'; // Valor por defecto o extra√≠do si se tuviera

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Input Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.step = '1';
    inputCh.value = '50'; // Valor por defecto o extra√≠do si se tuviera

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Input Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.step = '1';
    inputGr.value = '25'; // Valor por defecto o extra√≠do si se tuviera

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma de macros
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia'; // Clase CSS del CSS proporcionado
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = 'Suma: 100%'; // Valor inicial

    // A√±adir listener para actualizar la suma en tiempo real
    const actualizarSuma = () => {
        const pt_val = parseInt(inputPt.value) || 0;
        const ch_val = parseInt(inputCh.value) || 0;
        const gr_val = parseInt(inputGr.value) || 0;
        const suma_val = pt_val + ch_val + gr_val;
        divTextoSuma.textContent = `Suma: ${suma_val}%`;
        // Opcional: A√±adir clases para feedback visual (ok/error)
        divTextoSuma.classList.remove('text-success', 'text-danger');
        if (suma_val === 100) {
            divTextoSuma.classList.add('text-success');
        } else {
            divTextoSuma.classList.add('text-danger');
        }
    };
    inputPt.addEventListener('input', actualizarSuma);
    inputCh.addEventListener('input', actualizarSuma);
    inputGr.addEventListener('input', actualizarSuma);
    // Llamar una vez para inicializar
    actualizarSuma();

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFila.appendChild(divGrupoMacros);

    // Crear la secci√≥n de "Aplicar tambi√©n a:" (d√≠as de la semana)
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia'; // Clase CSS del CSS proporcionado

    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelAplicarA.textContent = 'Aplicar tambi√©n a:'; // Texto de la etiqueta

    const divCheckboxesDias = document.createElement('div');
    // Ejemplo de d√≠as (deber√≠a ser din√°mico seg√∫n los d√≠as de la semana de la fila)
    // Para simplificar, usamos una lista fija. En una implementaci√≥n completa,
    // esto podr√≠a obtenerse del contexto de la fila o de la semana.
    const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    diasSemana.forEach(dia => {
        // Excluir el d√≠a actual de la fila
        if (dia !== datosFilaOriginal.dia) {
            const divCheckInline = document.createElement('div');
            divCheckInline.className = 'form-check form-check-inline'; // Clase CSS del CSS proporcionado

            const inputCheckDia = document.createElement('input');
            inputCheckDia.className = 'form-check-input'; // Clase CSS del CSS proporcionado
            inputCheckDia.type = 'checkbox';
            inputCheckDia.id = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
            inputCheckDia.name = `modalAplicarA_${idBase}`; // Mismo name para agrupar si es necesario
            inputCheckDia.value = dia;

            const labelCheckDia = document.createElement('label');
            labelCheckDia.className = 'form-check-label small'; // Clase CSS del CSS proporcionado
            labelCheckDia.htmlFor = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
            labelCheckDia.textContent = dia;

            divCheckInline.appendChild(inputCheckDia);
            divCheckInline.appendChild(labelCheckDia);
            divCheckboxesDias.appendChild(divCheckInline);
        }
    });

    divAplicarA.appendChild(labelAplicarA);
    divAplicarA.appendChild(divCheckboxesDias);
    divFila.appendChild(divAplicarA);

    return divFila;
}



/**
 * Obtiene la estrategia base seg√∫n el objetivo del usuario cuando se selecciona "ninguna".
 * @param {string} objetivoUsuario - El objetivo principal del usuario.
 * @returns {string} El nombre de la estrategia base correspondiente.
 */
function obtenerEstrategiaBasePorObjetivo(objetivoUsuario) {
    const mapeoObjetivoAEstrategiaBase = {
        'perdida1': 'Induccion Cetogenica',
        'ganancia1': 'Hiperproteica',
        'mantenimiento1': 'Equilibrada HC',
        'mixto1': 'Balance nutricional'
    };

    return mapeoObjetivoAEstrategiaBase[objetivoUsuario] || 'Estrategia base por defecto';
}
/**
 * Popula el modal de edici√≥n avanzado con los datos de la fila y la fase.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */
function popularModalEdicionAvanzado(indiceFila) {
    console.log(`[Modal Avanzado] Popular modal para fila: ${indiceFila}`);

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales espec√≠ficos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`[Modal Avanzado] √çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`[Modal Avanzado] No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            return;
        }
        const pesoEstimadoActual = datosFilaOriginal.pesoEstimado;
        const semanaActual = datosFilaOriginal.semana;

        // --- 3. Popular secci√≥n de Contexto del Plan ---
        // --- 5. Popular secci√≥n de Contexto del Plan ---
        try {
            const datosProgresoNoLineal = window.nonlinearProgressData_1;
            const fechaInicioPlan = new Date(); // Asumiendo que el plan empieza hoy
            const fechaActual = new Date();

            // Obtener datos de la fase actual
            const faseActual = datosFaseBase.nombreFase;
            const objetivoPrincipal = datosFaseBase.objetivoPrincipal;
            const totalSemanasFase = datosFaseBase.semanasAsignadas || 12; // N√∫mero de semanas de la fase actual
            const diasTranscurridos = parseInt(partesIndice[2], 10); // D√≠a dentro de la semana

            // Obtener datos globales del plan no lineal
            let pesoInicialGlobal = 0;
            let pesoFinalGlobal = 0;
            let totalSemanasGlobal = 0;
            let tasaInicialGlobal = 0;

            if (datosProgresoNoLineal && typeof datosProgresoNoLineal === 'object') {
                pesoInicialGlobal = datosProgresoNoLineal.objetivo?.pesoInicial || datosFilaOriginal.pesoEstimado;
                pesoFinalGlobal = datosProgresoNoLineal.objetivo?.pesoFinal || datosFilaOriginal.pesoEstimado;
                totalSemanasGlobal = datosProgresoNoLineal.tiempo?.semanasEstimadas || totalSemanasFase;
                tasaInicialGlobal = datosProgresoNoLineal.parametros?.tasaInicialKgPorSemana || 0.25; // kg/semana
            } else {
                // Fallback si nonlinearProgressData_1 no est√° disponible
                pesoInicialGlobal = datosFilaOriginal.pesoEstimado;
                pesoFinalGlobal = pesoInicialGlobal - 10; // Ejemplo de p√©rdida
                totalSemanasGlobal = totalSemanasFase;
                tasaInicialGlobal = 0.25;
            }

            // Calcular datos espec√≠ficos de la fase actual
            const pesoInicialFase = datosFaseBase.pesoInicioFase;
            const pesoFinalFase = datosFaseBase.pesoFinFase;
            const pesoActualEstimado = pesoEstimadoActual;

            // Calcular peso perdido hasta ahora
            const pesoPerdido = pesoInicialGlobal - pesoActualEstimado;

            // Calcular velocidad de p√©rdida promedio
            const diasTranscurridosDesdeInicio = (totalSemanasGlobal * 7) - (totalSemanasGlobal - semanaActual) * 7 + diaNumero; // Simplificado
            const velocidadPerdidaPromedio = pesoPerdido / (diasTranscurridosDesdeInicio / 7); // kg/semana

            // Popular elementos del DOM
            const elementoInfoFase = document.getElementById('modalInfoFase');
            const elementoInfoObjetivo = document.getElementById('modalInfoObjetivo');
            const elementoInfoDuracion = document.getElementById('modalInfoDuracion');
            const elementoInfoSemanasFase = document.getElementById('modalInfoSemanasFase');
            const elementoInfoDiasTranscurridos = document.getElementById('modalInfoDiasTranscurridos');
            const elementoInfoPesoPerdido = document.getElementById('modalInfoPesoPerdido');
            const elementoInfoVelocidadPerdida = document.getElementById('modalInfoVelocidadPerdida');
            const elementoInfoPesoInicialFase = document.getElementById('modalInfoPesoInicialFase');
            const elementoInfoPesoActualEstimado = document.getElementById('modalInfoPesoActualEstimado');
            const elementoInfoPesoFinalEstimado = document.getElementById('modalInfoPesoFinalEstimado');

            if (elementoInfoFase) elementoInfoFase.textContent = faseActual;
            if (elementoInfoObjetivo) elementoInfoObjetivo.textContent = objetivoPrincipal;
            if (elementoInfoDuracion) elementoInfoDuracion.textContent = `${Math.floor(totalSemanasFase / 4)}-${Math.ceil(totalSemanasFase / 4)} meses`;
            if (elementoInfoSemanasFase) elementoInfoSemanasFase.textContent = totalSemanasFase.toString();
            if (elementoInfoDiasTranscurridos) elementoInfoDiasTranscurridos.textContent = diasTranscurridos.toString();
            if (elementoInfoPesoPerdido) elementoInfoPesoPerdido.textContent = `${pesoPerdido.toFixed(1)} kg`;
            if (elementoInfoVelocidadPerdida) elementoInfoVelocidadPerdida.textContent = `${velocidadPerdidaPromedio.toFixed(2)} kg/semana`;
            if (elementoInfoPesoInicialFase) elementoInfoPesoInicialFase.textContent = `${pesoInicialFase.toFixed(1)} kg`;
            if (elementoInfoPesoActualEstimado) elementoInfoPesoActualEstimado.textContent = `${pesoActualEstimado.toFixed(1)} kg`;
            if (elementoInfoPesoFinalEstimado) elementoInfoPesoFinalEstimado.textContent = `${pesoFinalFase.toFixed(1)} kg`;

            console.log(`[Modal Avanzado] Secci√≥n de Contexto del Plan populada con √©xito para fila ${indiceFila}.`);
        } catch (e) {
            console.error(`[Modal Avanzado] Error al popular la secci√≥n de Contexto del Plan para fila ${indiceFila}:`, e);
            // Aqu√≠ puedes a√±adir un fallback con valores por defecto o mostrar un mensaje de error.
        }


        // --- 4. Popular secci√≥n de Posibles Estrategias ---
        // a. Obtener el objetivo principal del USUARIO (no de la fase)
        // Opci√≥n 1: Desde el select global

        let objetivoUsuario = document.getElementById('objetivo')?.value;
        if (!objetivoUsuario) {
            console.warn(`[Modal Avanzado] No se pudo obtener el objetivo principal del usuario. Usando 'perdida1' por defecto.`);
            objetivoUsuario = 'perdida1'; // Valor por defecto o manejo de error
        }
        console.log(`[Modal Avanzado] Objetivo principal del usuario detectado: ${objetivoUsuario}`);


        // b. Mapear objetivoUsuario a la clave del cat√°logo ESTRATEGIAS_POR_OBJETIVO
        // Asumimos que el objetivoUsuario ya est√° en el formato correcto (perdida1, ganancia1, etc.)
        // Si no, necesitar√≠as un mapeo adicional aqu√≠.

        const claveObjetivo = objetivoUsuario; // Ajusta si es necesario

        let estrategiasBaseParaMostrar = [];
        let estrategiasRecomendadasParaMostrar = [];

        if (ESTRATEGIAS_POR_OBJETIVO && ESTRATEGIAS_POR_OBJETIVO[claveObjetivo]) {
            estrategiasBaseParaMostrar = ESTRATEGIAS_POR_OBJETIVO[claveObjetivo].base || [];
            estrategiasRecomendadasParaMostrar = ESTRATEGIAS_POR_OBJETIVO[claveObjetivo].recomendadas || [];
            console.log(`[Modal Avanzado] Estrategias encontradas para clave '${claveObjetivo}':`, { base: estrategiasBaseParaMostrar, recomendadas: estrategiasRecomendadasParaMostrar });
        } else {
            console.warn(`[Modal Avanzado] No se encontraron estrategias para el objetivo '${claveObjetivo}' en ESTRATEGIAS_POR_OBJETIVO.`);
            // Valores por defecto o vac√≠os
            estrategiasBaseParaMostrar = ['Estrategias generales'];
            estrategiasRecomendadasParaMostrar = ['Consulta personalizada'];
        }


        // Mostrar las estrategias en el modal
        document.getElementById('modalEstrategiasBase').textContent = estrategiasBaseParaMostrar.join(', ');
        document.getElementById('modalEstrategiasRecomendadas').textContent = estrategiasRecomendadasParaMostrar.join(', ');
        // NOTA: modalEstrategiaBaseActual se poblar√° m√°s abajo con las estrategias aplicadas espec√≠ficas


        // --- 5. Popular checkboxes de Estrategias Espec√≠ficas ---

        console.log(`[Modal Avanzado] Estrategias disponibles para fila ${indiceFila}:`, estrategiasDisponibles);

        const contenedorCheckboxes = document.getElementById('modalCheckboxesEstrategias');
        let estrategiasAplicadasArray = []; // Declarar aqu√≠ para que est√© disponible

        if (contenedorCheckboxes) {
            contenedorCheckboxes.innerHTML = ''; // Limpiar antes de llenar

            // Excluir "ninguna" de la lista de checkboxes
            const estrategiasParaCheckboxes = estrategiasDisponibles.filter(e => e.toLowerCase() !== "ninguna");

            // --- Obtener estrategias aplicadas a esta fila ---
            // a. Intentar obtener desde el modal (por si ya se han hecho cambios)

            const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');






            // --- NUEVO BLOQUE PARA OBTENER ESTRATEGIAS APLICADAS ---
            // Obtener estrategias ya aplicadas a esta fila espec√≠fica
            let estrategiasAplicadasArray = [];
            if (datosFilaOriginal.estrategias && typeof datosFilaOriginal.estrategias === 'string') {
                const estrategiasStr = datosFilaOriginal.estrategias;
                if (estrategiasStr.toLowerCase().includes('ninguna')) {
                    // Caso 1: La fila tiene expl√≠citamente "ninguna"
                    console.log(`[Modal Avanzado] Fila ${indiceFila} tiene estrategia 'ninguna'.`);
                    // estrategiasAplicadasArray ya es [] por la inicializaci√≥n anterior
                } else {
                    // Caso 2: La fila tiene estrategias espec√≠ficas aplicadas
                    estrategiasAplicadasArray = estrategiasStr.split(',')
                        .map(s => s.trim())
                        .filter(s => s && s.toLowerCase() !== "ninguna");
                    console.log(`[Modal Avanzado] Estrategias aplicadas encontradas para fila ${indiceFila}:`, estrategiasAplicadasArray);
                }
            } else {
                // Caso 3: datosFilaOriginal.estrategias es null, undefined o no es string
                console.log(`[Modal Avanzado] No se encontr√≥ informaci√≥n de estrategias para fila ${indiceFila} o el formato es inv√°lido.`);
                // estrategiasAplicadasArray sigue siendo []
            }
            // --- FIN NUEVO BLOQUE ---

            // --- Generar checkboxes ---
            estrategiasParaCheckboxes.forEach(estrategia => {
                const checkboxId = `modalCheckbox_${estrategia.replace(/\s+/g, '_')}`;
                const isChecked = estrategiasAplicadasArray.includes(estrategia);

                const divCheckbox = document.createElement('div');
                divCheckbox.classList.add('form-check', 'form-check-inline');

                const inputCheckbox = document.createElement('input'); // <-- DECLARACI√ìN
                inputCheckbox.classList.add('form-check-input');
                inputCheckbox.type = 'checkbox';
                inputCheckbox.id = checkboxId;
                inputCheckbox.value = estrategia;
                if (isChecked) inputCheckbox.checked = true;

                const labelCheckbox = document.createElement('label');
                labelCheckbox.classList.add('form-check-label');
                labelCheckbox.htmlFor = checkboxId;
                // Usar mapeo para nombres legibles si existe
                const nombreLegibleEstrategia = MAPEO_ESTRATEGIAS_CHECKBOX ? MAPEO_ESTRATEGIAS_CHECKBOX[estrategia] || estrategia : estrategia;
                labelCheckbox.textContent = nombreLegibleEstrategia;

                divCheckbox.appendChild(inputCheckbox);
                divCheckbox.appendChild(labelCheckbox);
                contenedorCheckboxes.appendChild(divCheckbox);



                // --- 6. A√±adir evento para crear/eliminar filas de configuraci√≥n ---
                // Este evento se a√±ade aqu√≠ porque necesitamos acceso a `indiceFila` y otras variables del scope.
                // CORRECCI√ìN: El event listener debe estar DENTRO del forEach, justo despu√©s de crear inputCheckbox
                inputCheckbox.addEventListener('change', function () { // <-- AHORA EST√Å BIEN UBICADO
                    const estrategiaValor = this.value;
                    if (this.checked) {
                        // Crear la fila de configuraci√≥n si se marca el checkbox
                        crearFilaConfiguracionEstrategiaEnModal(indiceFila, estrategiaValor);
                    } else {
                        // Eliminar la fila de configuraci√≥n si se desmarca el checkbox
                        eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, estrategiaValor);
                    }
                });
                // --- FIN DEL EVENT LISTENER ---
            });

            // --- Popular modalEstrategiaBaseActual con las estrategias aplicadas ---
            // --- Popular modalEstrategiaBaseActual con las estrategias aplicadas ---
            let estrategiasBaseActualesMostrar = '';
            if (estrategiasAplicadasArray.length > 0) {
                // Si hay estrategias aplicadas, mostrarlas mapeadas
                estrategiasBaseActualesMostrar = estrategiasAplicadasArray
                    .map(e => MAPEO_ESTRATEGIAS_CHECKBOX ? MAPEO_ESTRATEGIAS_CHECKBOX[e] || e : e)
                    .join(', ');
            } else {
                // Si no hay estrategias aplicadas (array vac√≠o), mostrar solo la estrategia base por objetivo
                // Sin el prefijo "ninguna (" ni el sufijo ")"
                const objetivoUsuario = document.getElementById('objetivo')?.value || 'perdida1'; // Obtener objetivo global
                const estrategiaBasePorObjetivo = obtenerEstrategiaBasePorObjetivo(objetivoUsuario);
                estrategiasBaseActualesMostrar = estrategiaBasePorObjetivo; // Mostrar solo el nombre de la estrategia base
            }
            const elementoEstrategiaBaseActual = document.getElementById('modalEstrategiaBaseActual');
            if (elementoEstrategiaBaseActual) {
                elementoEstrategiaBaseActual.textContent = estrategiasBaseActualesMostrar;
            } else {
                console.warn("[Modal Avanzado] Elemento con id 'modalEstrategiaBaseActual' no encontrado.");
            }


        } else {
            console.warn("[Modal Avanzado] Contenedor de checkboxes no encontrado.");
        }







        // --- 7. Popular secci√≥n de Configurar Macros por Estrategia ---
        const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
        const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
        if (contenedorConfiguracionMacros) {
            contenedorConfiguracionMacros.innerHTML = ''; // Limpiar configuraciones anteriores
        }
        if (mensajeSinEstrategias) {
            mensajeSinEstrategias.style.display = 'block'; // Mostrar mensaje inicial
        }

        // Precargar filas de configuraci√≥n para estrategias ya aplicadas
        if (contenedorConfiguracionMacros && estrategiasAplicadasArray.length > 0) {
            estrategiasAplicadasArray.forEach(estrategia => {
                // Solo crear la fila si la estrategia es v√°lida y est√° en las disponibles
                if (estrategiasDisponibles.includes(estrategia)) {
                    // Pasar ajusteCaloriasDiarioManual como par√°metro adicional
                    const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
                    let ajusteCaloriasDiarioManual = null;
                    if (inputAjusteCalorias && inputAjusteCalorias.value !== "") {
                        const valorIngresado = parseFloat(inputAjusteCalorias.value);
                        if (!isNaN(valorIngresado)) {
                            ajusteCaloriasDiarioManual = valorIngresado;
                            console.log(`[Modal Avanzado] Ajuste de calor√≠as manual detectado al precargar fila: ${ajusteCaloriasDiarioManual} kcal/d√≠a`);
                        } else {
                            console.warn("[Modal Avanzado] Valor inv√°lido en el input de ajuste de calor√≠as al precargar fila. Se ignorar√°.");
                        }
                    }
                    crearFilaConfiguracionEstrategiaEnModal(indiceFila, estrategia, ajusteCaloriasDiarioManual);
                }
            });
            // Ocultar mensaje de "sin estrategias" si se crearon filas
            if (mensajeSinEstrategias && contenedorConfiguracionMacros.children.length > 0) {
                mensajeSinEstrategias.style.display = 'none';
            }
        }

        // --- 8. Popular secci√≥n de Recordatorio de Evoluci√≥n ---
        // (Esto ya est√° contenido en el HTML del modal como texto est√°tico)

        // --- 9. Popular Select de Actividad ---
        const selectActividadElement = document.getElementById('modalSelectActividad');
        if (selectActividadElement) {
            // Asegurarse de que el valor exista en las opciones del select antes de asignarlo
            if (selectActividadElement.querySelector(`option[value="${datosFilaOriginal.actividad}"]`)) {
                selectActividadElement.value = datosFilaOriginal.actividad;
            } else {
                console.warn(`El valor de actividad ${datosFilaOriginal.actividad} no se encontr√≥ en las opciones del modal. Se deja el valor predeterminado del select.`);
            }
        } else {
            console.error("Elemento con id 'modalSelectActividad' no encontrado en el modal.");
        }

        // --- 10. Popular Input de Ajuste de Calor√≠as ---
        const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
        if (inputAjusteCalorias) {
            // Aqu√≠ puedes poner el valor actual si lo tienes almacenado
            // Por ahora lo dejamos vac√≠o o con un valor por defecto
            inputAjusteCalorias.value = ''; // O alg√∫n valor almacenado
        }

        // --- 11. Popular secci√≥n de Recordatorio de Evoluci√≥n ---
        popularSeccionRecordatorioEvolucion(indiceFila);
        // --- Fin de Popular secci√≥n de Recordatorio de Evoluci√≥n ---
        console.log(`[Modal Avanzado] Modal popularizado con √©xito para fila ${indiceFila}.`);

        // --- 6. Popular secci√≥n de Progreso Estimado ---
        // Esta secci√≥n se actualiza din√°micamente cada vez que se abre el modal
        // Pasamos datosFaseBase, semanaActual y pesoEstimadoActual
        //const semanaActual = datosFilaOriginal.semana; // Asumiendo que datosFilaOriginal tiene una propiedad 'semana'
        //const pesoEstimadoActual = datosFilaOriginal.pesoEstimado;

        if (typeof generarGraficoProgresoHTML === 'function') {
            const htmlGraficoProgreso = generarGraficoProgresoHTML(datosFaseBase, semanaActual, pesoEstimadoActual);
            // El HTML generado puede ser un placeholder o vac√≠o, ya que el canvas se dibuja por JS
            // La funci√≥n se encarga de popular los elementos del DOM directamente
            console.log(`[Modal Avanzado] Gr√°fico de progreso generado para fila ${indiceFila}.`);
        } else {
            console.warn("[Modal Avanzado] Funci√≥n 'generarGraficoProgresoHTML' no encontrada. Se usar√° placeholder.");
            // Opcional: Mostrar un mensaje de error o placeholder en el contenedor
            const contenedorGrafico = document.getElementById('modalGraficoProgreso');
            if (contenedorGrafico) {
                contenedorGrafico.innerHTML = '<p class="text-muted small">Gr√°fico de progreso no disponible.</p>';
            }
        }


        // --- 14. --- NUEVO --- Popular secci√≥n de Progreso Estimado de la Fase ---
        // Usar datos del c√°lculo no lineal global (window.nonlinearProgressData_1) para mayor precisi√≥n
        try {
            const datosProgresoNoLineal = window.nonlinearProgressData_1;
            if (datosProgresoNoLineal && typeof datosProgresoNoLineal === 'object') {
                console.log(`[Modal Avanzado] Datos de progreso no lineal disponibles para fila ${indiceFila}:`, datosProgresoNoLineal);

                // a. Obtener pesos iniciales y finales del c√°lculo no lineal
                const pesoInicialNoLineal = datosProgresoNoLineal.objetivo?.pesoInicial;
                const pesoFinalNoLineal = datosProgresoNoLineal.objetivo?.pesoFinal;
                const objetivoTipoNoLineal = datosProgresoNoLineal.objetivo?.tipo;

                if (pesoInicialNoLineal !== undefined && pesoFinalNoLineal !== undefined) {
                    // b. Popular elementos de peso
                    const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
                    const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
                    const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');

                    if (elementoPesoInicio) elementoPesoInicio.textContent = pesoInicialNoLineal.toFixed(1);
                    if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1); // Seguimos usando pesoEstimadoActual de la fila
                    if (elementoPesoMeta) elementoPesoMeta.textContent = pesoFinalNoLineal.toFixed(1);

                    console.log(`[Modal Avanzado] Pesos populados desde datos no lineales para fila ${indiceFila}: Inicio=${pesoInicialNoLineal.toFixed(1)}kg, Actual=${pesoEstimadoActual.toFixed(1)}kg, Meta=${pesoFinalNoLineal.toFixed(1)}kg`);

                    // c. Popular barra de progreso general
                    const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');
                    if (barraProgresoGeneral) {
                        // Calcular progreso basado en el c√°lculo no lineal
                        const cambioPesoTotalNoLineal = Math.abs(pesoInicialNoLineal - pesoFinalNoLineal);
                        const cambioPesoAcumuladoNoLineal = Math.abs(pesoInicialNoLineal - pesoEstimadoActual);

                        // Asegurar que el progreso est√© entre 0 y 100
                        let progresoPorcentajeNoLineal = (cambioPesoAcumuladoNoLineal / cambioPesoTotalNoLineal) * 100;
                        if (isNaN(progresoPorcentajeNoLineal) || !isFinite(progresoPorcentajeNoLineal)) {
                            progresoPorcentajeNoLineal = 0;
                        }
                        const progresoAjustadoNoLineal = Math.max(0, Math.min(100, progresoPorcentajeNoLineal));

                        barraProgresoGeneral.style.width = `${progresoAjustadoNoLineal.toFixed(2)}%`;
                        barraProgresoGeneral.setAttribute('aria-valuenow', progresoAjustadoNoLineal.toFixed(2));
                        barraProgresoGeneral.textContent = `Progreso: ${progresoAjustadoNoLineal.toFixed(0)}%`;

                        console.log(`[Modal Avanzado] Barra de progreso general actualizada para fila ${indiceFila}: ${progresoAjustadoNoLineal.toFixed(2)}%`);
                    } else {
                        console.warn("[Modal Avanzado] Elemento '#modalBarraProgresoGeneral' no encontrado en el modal.");
                    }

                    // d. (Opcional) Popular gr√°fico detallado en canvas
                    // Llamar a la funci√≥n que dibuja el gr√°fico en el canvas
                    setTimeout(() => {
                        dibujarGraficoDetalladoEnCanvas(datosFaseBase, semanaActual, pesoEstimadoActual);
                    }, 150); // Peque√±o retraso para asegurar que el canvas est√© en el DOM

                } else {
                    console.warn(`[Modal Avanzado] Pesos iniciales o finales no encontrados en datosProgresoNoLineal para fila ${indiceFila}.`);
                    // Fallback: Usar datos de la fila original
                    const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
                    const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
                    const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
                    const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

                    if (elementoPesoInicio) elementoPesoInicio.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);
                    if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
                    if (elementoPesoMeta) elementoPesoMeta.textContent = datosFilaOriginal.pesoEstimado.toFixed(1); // Meta = Actual como fallback

                    if (barraProgresoGeneral) {
                        barraProgresoGeneral.style.width = '0%';
                        barraProgresoGeneral.setAttribute('aria-valuenow', '0');
                        barraProgresoGeneral.textContent = 'Progreso: 0%';
                    }
                }
            } else {
                console.warn(`[Modal Avanzado] window.nonlinearProgressData_1 no disponible o inv√°lido para fila ${indiceFila}. Usando datos de la fila.`);
                // Fallback: Usar datos de la fila original
                const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
                const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
                const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
                const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

                if (elementoPesoInicio) elementoPesoInicio.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);
                if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
                if (elementoPesoMeta) elementoPesoMeta.textContent = datosFilaOriginal.pesoEstimado.toFixed(1); // Meta = Actual como fallback

                if (barraProgresoGeneral) {
                    barraProgresoGeneral.style.width = '0%';
                    barraProgresoGeneral.setAttribute('aria-valuenow', '0');
                    barraProgresoGeneral.textContent = 'Progreso: 0%';
                }
            }
        } catch (e) {
            console.error(`[Modal Avanzado] Error al popular la secci√≥n de Progreso Estimado de la Fase para fila ${indiceFila}:`, e);
            // Fallback en caso de error
            const elementoPesoInicio = document.getElementById('modalPesoInicioGrafico');
            const elementoPesoActual = document.getElementById('modalPesoActualGrafico');
            const elementoPesoMeta = document.getElementById('modalPesoMetaGrafico');
            const barraProgresoGeneral = document.getElementById('modalBarraProgresoGeneral');

            if (elementoPesoInicio) elementoPesoInicio.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);
            if (elementoPesoActual) elementoPesoActual.textContent = pesoEstimadoActual.toFixed(1);
            if (elementoPesoMeta) elementoPesoMeta.textContent = datosFilaOriginal.pesoEstimado.toFixed(1);

            if (barraProgresoGeneral) {
                barraProgresoGeneral.style.width = '0%';
                barraProgresoGeneral.setAttribute('aria-valuenow', '0');
                barraProgresoGeneral.textContent = 'Progreso: 0% (Error)';
            }
        }
        // --- FIN NUEVO BLOQUE ---
    } catch (error) {
        console.error(`[Modal Avanzado] Error al popular el modal para fila ${indiceFila}:`, error);
        alert("Hubo un error al cargar los datos en el editor. Por favor, int√©ntalo de nuevo.");
    }
}

/**
 * Crea una fila de configuraci√≥n de macros para una estrategia espec√≠fica en el modal.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
function crearFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia) {
    console.log(`[Modal Avanzado] Creando fila de configuraci√≥n para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);

    const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
    const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
    if (!contenedorConfiguracionMacros) {
        console.error("[Modal Avanzado] Contenedor de configuraci√≥n de macros no encontrado.");
        return;
    }

    // Crear un ID √∫nico para la fila
    const idFilaConfig = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Evitar crear duplicados
    if (document.getElementById(idFilaConfig)) {
        console.warn(`[Modal Avanzado] La fila de configuraci√≥n para '${nombreEstrategia}' en fila ${indiceFila} ya existe.`);
        return;
    }

    // Obtener macros predeterminados para esta estrategia
    // Asumimos que MACROS_POR_ESTRATEGIA_AJUSTADO y MACROS_POR_ESTRATEGIAS_BASE est√°n definidos globalmente
    const macrosPredeterminados = MACROS_POR_ESTRATEGIA_AJUSTADO[nombreEstrategia] ||
        MACROS_POR_ESTRATEGIAS_BASE[nombreEstrategia] ||
        { proteinas: 25, carbohidratos: 40, grasas: 35 }; // Fallback

    // Crear la fila de configuraci√≥n
    const divFilaConfig = document.createElement('div');
    divFilaConfig.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia';
    divFilaConfig.id = idFilaConfig;
    divFilaConfig.setAttribute('data-estrategia-id', nombreEstrategia);

    // Cabecera de la fila
    const divCabecera = document.createElement('div');
    divCabecera.className = 'd-flex justify-content-between align-items-center mb-2 cabecera-fila-estrategia';

    const h6NombreEstrategia = document.createElement('h6');
    h6NombreEstrategia.className = 'mb-0 text-primary nombre-estrategia';
    h6NombreEstrategia.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia';
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    botonCerrar.addEventListener('click', function () {
        eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia);
        // Desmarcar el checkbox correspondiente
        const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
        const checkboxCorrespondiente = document.getElementById(checkboxId);
        if (checkboxCorrespondiente) {
            checkboxCorrespondiente.checked = false;
        }
    });

    divCabecera.appendChild(h6NombreEstrategia);
    divCabecera.appendChild(botonCerrar);
    divFilaConfig.appendChild(divCabecera);

    // Grupo de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia';

    // Inputs de macros con IDs √∫nicos
    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Prote√≠nas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1';
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Prote√≠nas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm';
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`;
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.step = '1';
    inputPt.value = macrosPredeterminados.proteinas;

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.step = '1';
    inputCh.value = macrosPredeterminados.carbohidratos;

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.step = '1';
    inputGr.value = macrosPredeterminados.grasas;

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia';
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = `Suma: ${(macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas)}%`;
    // A√±adir clases de estado
    const suma = macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas;
    divTextoSuma.classList.remove('text-success', 'text-danger');
    if (suma === 100) {
        divTextoSuma.classList.add('text-success');
    } else {
        divTextoSuma.classList.add('text-danger');
    }

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFilaConfig.appendChild(divGrupoMacros);

    // Secci√≥n de "Aplicar tambi√©n a:" (solo si es relevante, por ejemplo, para d√≠as de entreno)
    // Esta secci√≥n puede requerir l√≥gica adicional para determinar qu√© d√≠as son relevantes.
    // Por ahora, la omitimos o la dejamos como placeholder.
    /*
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia';
 
    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1';
    labelAplicarA.textContent = 'Aplicar tambi√©n a:';
    divAplicarA.appendChild(labelAplicarA);
 
     const divCheckboxesDias = document.createElement('div');
        
            // El formato de indiceFila es "mes-semana-dia" (ej: "1-1-0")
            const partesIndice = indiceFila.toString().split('-');
            const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10); // √öltimo elemento: indice del dia (0-6)
 
            // Mapear √≠ndice de d√≠a a nombre de d√≠a
            const nombresDiasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            const nombreDiaActual = nombresDiasSemana[indiceDiaArray] || 'D√≠a desconocido';
            
   
            const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
            diasSemana.forEach(dia => {
                
                if (dia !== nombreDiaActual) {// datosFilaOriginal debe estar disponible en este scope
            
            const divCheckInline = document.createElement('div');
            divCheckInline.className = 'form-check form-check-inline';
 
            const inputCheckDia = document.createElement('input');
            inputCheckDia.className = 'form-check-input';
            inputCheckDia.type = 'checkbox';
        	
             // --- MODIFICACI√ìN: ID √∫nico basado en indiceFila y nombre del d√≠a ---
              inputCheckDia.id = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
              // --- FIN MODIFICACI√ìN ---
            inputCheckDia.name = `modalAplicarA_${idBase}`;
            inputCheckDia.value = dia;
 
            const labelCheckDia = document.createElement('label');
            labelCheckDia.className = 'form-check-label small';
        	
        	
             // --- MODIFICACI√ìN: htmlFor √∫nico basado en indiceFila y nombre del d√≠a ---
              labelCheckDia.htmlFor = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
              // --- FIN MODIFICACI√ìN ---
            labelCheckDia.textContent = dia;
 
            divCheckInline.appendChild(inputCheckDia);
            divCheckInline.appendChild(labelCheckDia);
            divCheckboxesDias.appendChild(divCheckInline);
        // }
    });
 
    divAplicarA.appendChild(divCheckboxesDias);
    divFilaConfig.appendChild(divAplicarA);
    */

    // A√±adir la fila al contenedor
    contenedorConfiguracionMacros.appendChild(divFilaConfig);

    // Mostrar/Ocultar mensaje de "sin estrategias"
    if (mensajeSinEstrategias) {
        mensajeSinEstrategias.style.display = 'none';
    }

    // A√±adir listeners para actualizar la suma en tiempo real
    const inputsMacros = [inputPt, inputCh, inputGr];
    inputsMacros.forEach(input => {
        input.addEventListener('input', function () {
            actualizarSumaMacrosEnModal(idBase);
        });
    });

    console.log(`[Modal Avanzado] Fila de configuraci√≥n creada para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);
}
/**
 * Crea una fila de configuraci√≥n de macros para una estrategia espec√≠fica en el modal.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
/**
 * Crea una fila de configuraci√≥n de macros para una estrategia espec√≠fica en el modal.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
function crearFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia) {
    console.log(`[Modal Avanzado] Creando fila de configuraci√≥n para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);

    const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
    const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');
    if (!contenedorConfiguracionMacros) {
        console.error("[Modal Avanzado] Contenedor de configuraci√≥n de macros no encontrado.");
        return;
    }

    // Crear un ID √∫nico para la fila
    const idFilaConfig = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Evitar crear duplicados
    if (document.getElementById(idFilaConfig)) {
        console.warn(`[Modal Avanzado] La fila de configuraci√≥n para '${nombreEstrategia}' en fila ${indiceFila} ya existe.`);
        return;
    }

    // Obtener macros predeterminados para esta estrategia
    const macrosPredeterminados = MACROS_POR_ESTRATEGIA_AJUSTADO[nombreEstrategia] ||
        MACROS_POR_ESTRATEGIAS_BASE[nombreEstrategia] ||
        { proteinas: 25, carbohidratos: 40, grasas: 35 }; // Fallback

    // Crear la fila de configuraci√≥n
    const divFilaConfig = document.createElement('div');
    divFilaConfig.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia';
    divFilaConfig.id = idFilaConfig;
    divFilaConfig.setAttribute('data-estrategia-id', nombreEstrategia);

    // Cabecera de la fila
    const divCabecera = document.createElement('div');
    divCabecera.className = 'd-flex justify-content-between align-items-center mb-2 cabecera-fila-estrategia';

    const h6NombreEstrategia = document.createElement('h6');
    h6NombreEstrategia.className = 'mb-0 text-primary nombre-estrategia';
    h6NombreEstrategia.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia';
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    botonCerrar.addEventListener('click', function () {
        eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia);
        // Desmarcar el checkbox correspondiente
        const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
        const checkboxCorrespondiente = document.getElementById(checkboxId);
        if (checkboxCorrespondiente) {
            checkboxCorrespondiente.checked = false;
        }
    });

    divCabecera.appendChild(h6NombreEstrategia);
    divCabecera.appendChild(botonCerrar);
    divFilaConfig.appendChild(divCabecera);

    // Grupo de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia';

    // Inputs de macros con IDs √∫nicos
    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Prote√≠nas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1';
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Prote√≠nas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm';
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`;
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.step = '1';
    inputPt.value = macrosPredeterminados.proteinas;

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.step = '1';
    inputCh.value = macrosPredeterminados.carbohidratos;

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.step = '1';
    inputGr.value = macrosPredeterminados.grasas;

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia';
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = `Suma: ${(macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas)}%`;
    // A√±adir clases de estado
    const suma = macrosPredeterminados.proteinas + macrosPredeterminados.carbohidratos + macrosPredeterminados.grasas;
    divTextoSuma.classList.remove('text-success', 'text-danger');
    if (suma === 100) {
        divTextoSuma.classList.add('text-success');
    } else {
        divTextoSuma.classList.add('text-danger');
    }

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFilaConfig.appendChild(divGrupoMacros);

    // Secci√≥n de "Aplicar tambi√©n a:"
    // Secci√≥n de "Aplicar tambi√©n a:" (d√≠as de la semana)
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia';

    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1';
    labelAplicarA.textContent = 'Aplicar tambi√©n a:';
    divAplicarA.appendChild(labelAplicarA);

    const divCheckboxesDias = document.createElement('div');
    // --- MODIFICACI√ìN: Obtener el d√≠a actual de la fila desde indiceFila ---
    // El formato de indiceFila es "mes-semana-dia" (ej: "1-1-0")
    const partesIndice = indiceFila.toString().split('-');
    const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10); // √öltimo elemento: indice del dia (0-6)

    // Mapear √≠ndice de d√≠a a nombre de d√≠a
    const nombresDiasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    const nombreDiaActual = nombresDiasSemana[indiceDiaArray] || 'D√≠a desconocido';
    // --- FIN MODIFICACI√ìN ---

    // Ejemplo de d√≠as (din√°mico seg√∫n los d√≠as de la semana)
    const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
    diasSemana.forEach(dia => {
        // --- MODIFICACI√ìN: Excluir el d√≠a actual de la fila ---
        if (dia !== nombreDiaActual) {
            // --- FIN MODIFICACI√ìN ---
            const divCheckInline = document.createElement('div');
            divCheckInline.className = 'form-check form-check-inline';

            const inputCheckDia = document.createElement('input');
            inputCheckDia.className = 'form-check-input';
            inputCheckDia.type = 'checkbox';
            // --- MODIFICACI√ìN: ID √∫nico basado en indiceFila y nombre del d√≠a ---
            inputCheckDia.id = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
            // --- FIN MODIFICACI√ìN ---
            inputCheckDia.name = `modalAplicarA_${idBase}`;
            inputCheckDia.value = dia;

            const labelCheckDia = document.createElement('label');
            labelCheckDia.className = 'form-check-label small';
            // --- MODIFICACI√ìN: htmlFor √∫nico basado en indiceFila y nombre del d√≠a ---
            labelCheckDia.htmlFor = `modalAplicarA${dia.replace(/\s+/g, '_')}_${idBase}`;
            // --- FIN MODIFICACI√ìN ---
            labelCheckDia.textContent = dia;

            divCheckInline.appendChild(inputCheckDia);
            divCheckInline.appendChild(labelCheckDia);
            divCheckboxesDias.appendChild(divCheckInline);
        }
    });

    divAplicarA.appendChild(divCheckboxesDias);
    divFilaConfig.appendChild(divAplicarA);

    // A√±adir la fila al contenedor
    contenedorConfiguracionMacros.appendChild(divFilaConfig);

    // Mostrar/Ocultar mensaje de "sin estrategias"
    if (mensajeSinEstrategias) {
        mensajeSinEstrategias.style.display = 'none';
    }

    // A√±adir listeners para actualizar la suma en tiempo real
    const inputsMacros = [inputPt, inputCh, inputGr];
    inputsMacros.forEach(input => {
        input.addEventListener('input', function () {
            actualizarSumaMacrosEnModal(idBase);
        });
    });

    console.log(`[Modal Avanzado] Fila de configuraci√≥n creada para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);
}


/**
 * Elimina una fila de configuraci√≥n de macros para una estrategia espec√≠fica en el modal.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 */
function eliminarFilaConfiguracionEstrategiaEnModal(indiceFila, nombreEstrategia) {
    console.log(`[Modal Avanzado] Eliminando fila de configuraci√≥n para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);

    const idFilaConfig = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;
    const filaAEliminar = document.getElementById(idFilaConfig);
    const contenedorConfiguracionMacros = document.getElementById('modalConfiguracionMacrosPorEstrategia');
    const mensajeSinEstrategias = document.getElementById('modalMensajeSinEstrategias');

    if (filaAEliminar) {
        filaAEliminar.remove();
        console.log(`[Modal Avanzado] Fila de configuraci√≥n eliminada para estrategia '${nombreEstrategia}' en fila ${indiceFila}.`);
    } else {
        console.warn(`[Modal Avanzado] No se encontr√≥ la fila de configuraci√≥n para '${nombreEstrategia}' en fila ${indiceFila}.`);
    }

    // Mostrar/Ocultar mensaje de "sin estrategias" si no quedan m√°s
    if (contenedorConfiguracionMacros && mensajeSinEstrategias) {
        if (contenedorConfiguracionMacros.children.length === 0) {
            mensajeSinEstrategias.style.display = 'block';
        }
    }
}

/**
 * Actualiza el mensaje de suma de macros en una fila de configuraci√≥n del modal.
 * @param {string} idBase - El ID base para los elementos de macros (sin prefijo modalMacro).
 */
function actualizarSumaMacrosEnModal(idBase) {
    // console.log(`[Modal Avanzado] Actualizando suma de macros para idBase: ${idBase}`);

    const inputPt = document.getElementById(`modalMacroPt_${idBase}`);
    const inputCh = document.getElementById(`modalMacroCh_${idBase}`);
    const inputGr = document.getElementById(`modalMacroGr_${idBase}`);
    const mensajeElement = document.getElementById(`modalSumaMacros_${idBase}`);

    if (!inputPt || !inputCh || !inputGr || !mensajeElement) {
        // console.warn(`[Modal Avanzado] No se encontraron elementos para actualizar suma de macros con idBase: ${idBase}`);
        return; // Silencioso si no se encuentran los elementos (puede pasar durante la creaci√≥n/eliminaci√≥n)
    }

    const pt = parseInt(inputPt.value) || 0;
    const ch = parseInt(inputCh.value) || 0;
    const gr = parseInt(inputGr.value) || 0;
    const suma = pt + ch + gr;

    mensajeElement.textContent = `Suma: ${suma}%`;
    mensajeElement.classList.remove('text-success', 'text-danger');
    if (suma === 100) {
        mensajeElement.classList.add('text-success');
        // console.log(`[Modal Avanzado] Suma de macros para ${idBase} es v√°lida: 100%`);
    } else {
        mensajeElement.classList.add('text-danger');
        // console.log(`[Modal Avanzado] Suma de macros para ${idBase} es inv√°lida: ${suma}%`);
    }
}

/**
 * Aplica los cambios realizados en el modal de edici√≥n avanzado a la fila correspondiente.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */
function aplicarCambiosDesdeModalAvanzado(indiceFila) {
    console.log(`[Modal Avanzado] Aplicando cambios desde el modal para la fila: ${indiceFila}`);

    try {
        // --- 1. Recoger valores del modal ---

        // a. Nivel de Actividad
        const modalSelectActividad = document.getElementById('modalSelectActividad');
        const nuevaActividadStr = modalSelectActividad ? modalSelectActividad.value : null;
        const nuevaActividad = nuevaActividadStr ? parseFloat(nuevaActividadStr) : null;
        if (nuevaActividad === null || isNaN(nuevaActividad)) {
            alert("Error: Nivel de actividad inv√°lido.");
            return;
        }

        // b. Estrategias seleccionadas
        const checkboxesEstrategias = document.querySelectorAll('#modalCheckboxesEstrategias input[type="checkbox"]:checked');
        const nuevasEstrategias = Array.from(checkboxesEstrategias).map(cb => cb.value);
        console.log("[Modal Avanzado] Estrategias seleccionadas:", nuevasEstrategias);

        // c. Ajuste de Calor√≠as Diario Manual
        let ajusteCaloriasDiarioManual = null; // null indica que no se cambia
        const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
        if (inputAjusteCalorias && inputAjusteCalorias.value !== "") {
            const valorIngresado = parseFloat(inputAjusteCalorias.value);
            if (!isNaN(valorIngresado)) {
                ajusteCaloriasDiarioManual = valorIngresado;
                console.log(`[Modal Avanzado] Ajuste de calor√≠as manual solicitado: ${ajusteCaloriasDiarioManual} kcal/d√≠a`);
            } else {
                console.warn("[Modal Avanzado] Valor inv√°lido en el input de ajuste de calor√≠as. Se ignorar√°.");
                // Opcional: alert("Advertencia: El valor ingresado para el ajuste de calor√≠as no es un n√∫mero v√°lido. Se ignorar√°.");
            }
        }

        // d. Macros por estrategia (si se configuraron)
        const filasConfiguracion = document.querySelectorAll('.fila-configuracion-estrategia');
        const macrosPorEstrategia = {};
        filasConfiguracion.forEach(fila => {
            const nombreEstrategia = fila.getAttribute('data-estrategia-id');
            if (nombreEstrategia) {
                const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;
                const inputPt = document.getElementById(`modalMacroPt_${idBase}`);
                const inputCh = document.getElementById(`modalMacroCh_${idBase}`);
                const inputGr = document.getElementById(`modalMacroGr_${idBase}`);

                if (inputPt && inputCh && inputGr) {
                    const pt = parseInt(inputPt.value) || 0;
                    const ch = parseInt(inputCh.value) || 0;
                    const gr = parseInt(inputGr.value) || 0;
                    const suma = pt + ch + gr;

                    if (suma === 100) {
                        macrosPorEstrategia[nombreEstrategia] = { proteinas: pt, carbohidratos: ch, grasas: gr };
                        console.log(`[Modal Avanzado] Macros configurados para ${nombreEstrategia}: Pt=${pt}%, CH=${ch}%, GR=${gr}%`);
                    } else {
                        alert(`Error: La suma de macros para la estrategia '${nombreEstrategia}' debe ser 100%. Actual: ${suma}%.`);
                        console.error(`[Modal Avanzado] Suma de macros inv√°lida para ${nombreEstrategia}: ${suma}%`);
                        // Resaltar el mensaje de error
                        actualizarSumaMacrosEnModal(idBase);
                        const mensajeElement = document.getElementById(`modalSumaMacros_${idBase}`);
                        if (mensajeElement) mensajeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return; // Detener la aplicaci√≥n de cambios
                    }
                }
            }
        });

        // --- 2. Aplicar cambios ---

        // a. Cambiar actividad (esto recalcula TDEE y calor√≠as base)
        // Pasamos el ajuste manual como par√°metro adicional
        if (typeof actualizarFilaPorActividad === 'function') {
            actualizarFilaPorActividad(indiceFila, nuevaActividad.toString(), ajusteCaloriasDiarioManual);
        } else {
            console.error("[Modal Avanzado] La funci√≥n 'actualizarFilaPorActividad' no est√° definida.");
        }

        // b. Cambiar estrategias (esto recalcula lo necesario basado en las nuevas estrategias)
        // Pasamos un array de strings directamente Y el ajuste manual para que actualice la nota correctamente
        if (typeof actualizarFilaPorEstrategias === 'function') {
            actualizarFilaPorEstrategias(indiceFila, nuevasEstrategias, ajusteCaloriasDiarioManual);
        } else {
            console.error("[Modal Avanzado] La funci√≥n 'actualizarFilaPorEstrategias' no est√° definida.");
        }

        // c. Cambiar macros manualmente por estrategia (si se configuraron)
        // Esta parte requiere una nueva funci√≥n o modificar la existente para manejar macros por estrategia
        // Por ahora, solo registramos los valores recogidos.
        if (Object.keys(macrosPorEstrategia).length > 0) {
            console.log("[Modal Avanzado] Macros por estrategia configurados:", macrosPorEstrategia);
            // Aqu√≠ ir√≠a la l√≥gica para aplicar estos macros espec√≠ficos por estrategia
            // Por ejemplo, podr√≠as llamar a una nueva funci√≥n:
            // if (typeof aplicarMacrosPorEstrategia === 'function') {
            //     aplicarMacrosPorEstrategia(indiceFila, macrosPorEstrategia);
            // }
        } else {
            console.log("[Modal Avanzado] No se configuraron macros espec√≠ficos por estrategia.");
        }

        console.log(`[Modal Avanzado] Cambios aplicados con √©xito desde el modal para la fila ${indiceFila}.`);

        // Cerrar el modal
        const modalElement = document.getElementById('editarFilaModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }

    } catch (error) {
        console.error(`[Modal Avanzado] Error al aplicar cambios desde el modal para la fila ${indiceFila}:`, error);
        alert("Hubo un error al aplicar los cambios. Por favor, int√©ntalo de nuevo.");
    }
}
// --- MODAL DOBLECK CLICK MODIFICAR DATOS FILA tABLA DETALLADA ---

/**
 * Abre el modal de edici√≥n para una fila espec√≠fica.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */

/**
 * Abre el modal de edici√≥n mejorado para una fila espec√≠fica.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */
/**
 * Abre el modal de edici√≥n avanzado para una fila espec√≠fica.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */
function abrirModalEdicion(indiceFila) {
    console.log(`[Modal Edici√≥n] Intentando abrir modal para fila: ${indiceFila}`);

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Edici√≥n] No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            alert("Error: No se pudo encontrar la fila para editar.");
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Edici√≥n] No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            alert("Error: No se pudo encontrar la tabla asociada.");
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales espec√≠ficos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`[Modal Edici√≥n] √çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            alert("Error: √çndice de fila inv√°lido.");
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`[Modal Edici√≥n] No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            alert("Error: No se encontraron datos base para esta fila.");
            return;
        }

        // --- 3. --- NUEVO --- Popular el modal con los nuevos datos ---
        // Esta es la funci√≥n central que hace todo el trabajo de llenar el modal
        popularModalEdicionAvanzado(indiceFila);

        // --- 4. --- NUEVO --- Asociar el √≠ndice de fila al bot√≥n de aplicar ---
        // Esto es crucial para que aplicarCambiosDesdeModalAvanzado sepa qu√© fila actualizar
        const botonAplicar = document.getElementById('modalBotonAplicar');
        if (botonAplicar) {
            botonAplicar.setAttribute('data-indice-fila', indiceFila);
            console.log(`[Modal Edici√≥n] √çndice de fila ${indiceFila} asociado al bot√≥n 'Aplicar Cambios'.`);
        } else {
            console.error("[Modal Edici√≥n] Bot√≥n 'Aplicar Cambios' no encontrado en el modal.");
        }

        // --- 5. Mostrar el modal ---
        const modalElement = document.getElementById('editarFilaModal');
        if (modalElement) {
            const modalInstance = new bootstrap.Modal(modalElement);
            modalInstance.show();
            console.log(`[Modal Edici√≥n] Modal mostrado para fila ${indiceFila}.`);
        } else {
            console.error("[Modal Edici√≥n] Elemento del modal principal '#editarFilaModal' no encontrado.");
            alert("Error: No se pudo abrir el editor. El modal no se encontr√≥.");
        }

    } catch (error) {
        console.error(`[Modal Edici√≥n] Error al abrir el modal para la fila ${indiceFila}:`, error);
        alert("Hubo un error al abrir el editor. Por favor, int√©ntalo de nuevo.");
    }
}

// --- Funci√≥n auxiliar para crear la fila de configuraci√≥n de una estrategia ---
// Esta funci√≥n se llamar√° desde el event listener del checkbox.
/**
 * Crea el HTML para la fila de configuraci√≥n de macros de una estrategia espec√≠fica.
 * @param {string} indiceFila - El √≠ndice de la fila.
 * @param {string} nombreEstrategia - El nombre de la estrategia.
 * @returns {HTMLElement|null} El elemento div que representa la fila de configuraci√≥n, o null si hay error.
 */
function crearFilaConfiguracionEstrategia(indiceFila, nombreEstrategia) {
    if (!indiceFila || !nombreEstrategia) {
        console.error("Error: Faltan par√°metros para crear la fila de configuraci√≥n.");
        return null;
    }

    const filaConfigId = `fila-config-${indiceFila}-${nombreEstrategia.replace(/\s+/g, '_')}`;
    const idBase = `${indiceFila}_${nombreEstrategia.replace(/\s+/g, '_')}`;

    // Crear el contenedor de la fila
    const divFila = document.createElement('div');
    divFila.className = 'border rounded p-3 mb-3 bg-white shadow-sm fila-configuracion-estrategia'; // Clase CSS del CSS proporcionado
    divFila.setAttribute('data-estrategia-id', nombreEstrategia); // Para identificar la estrategia
    divFila.id = filaConfigId;

    // Crear el encabezado de la fila (nombre + bot√≥n cerrar)
    const divHeader = document.createElement('div');
    divHeader.className = 'd-flex justify-content-between align-items-center mb-2';

    const h6Nombre = document.createElement('h6');
    h6Nombre.className = 'mb-0 text-primary nombre-estrategia'; // Clase CSS del CSS proporcionado
    h6Nombre.textContent = nombreEstrategia;

    const botonCerrar = document.createElement('button');
    botonCerrar.type = 'button';
    botonCerrar.className = 'btn-close boton-cerrar-fila-estrategia'; // Clase CSS del CSS proporcionado
    botonCerrar.setAttribute('aria-label', 'Eliminar');
    botonCerrar.title = 'Eliminar estrategia';
    // A√±adir evento para eliminar esta fila espec√≠fica
    botonCerrar.addEventListener('click', function () {
        const filaAEliminar = document.getElementById(filaConfigId);
        if (filaAEliminar) {
            filaAEliminar.remove();
            // Desmarcar el checkbox correspondiente
            const checkboxId = `modalCheckbox_${nombreEstrategia.replace(/\s+/g, '_')}`;
            const checkboxCorrespondiente = document.getElementById(checkboxId);
            if (checkboxCorrespondiente) {
                checkboxCorrespondiente.checked = false;
            }
            // Mostrar/Ocultar mensaje de "sin estrategias" si no quedan m√°s
            const contenedorConfig = document.getElementById('modalConfiguracionMacrosPorEstrategia');
            if (contenedorConfig && contenedorConfig.children.length === 0) {
                document.getElementById('modalMensajeSinEstrategias').style.display = 'block';
            }
        }
    });

    divHeader.appendChild(h6Nombre);
    divHeader.appendChild(botonCerrar);
    divFila.appendChild(divHeader);

    // Crear el grupo de inputs de macros
    const divGrupoMacros = document.createElement('div');
    divGrupoMacros.className = 'row g-2 align-items-end grupo-macros-estrategia'; // Clase CSS del CSS proporcionado

    // Input Prote√≠nas
    const divColPt = document.createElement('div');
    divColPt.className = 'col-md-3';
    const labelPt = document.createElement('label');
    labelPt.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelPt.htmlFor = `modalMacroPt_${idBase}`;
    labelPt.textContent = '% Prote√≠nas';
    const inputPt = document.createElement('input');
    inputPt.type = 'number';
    inputPt.className = 'form-control form-control-sm'; // Clase CSS del CSS proporcionado
    inputPt.id = `modalMacroPt_${idBase}`;
    inputPt.name = `modalMacroPt_${idBase}`; // A√±adir name para facilidad de acceso
    inputPt.min = '0';
    inputPt.max = '100';
    inputPt.value = '20'; // Valor por defecto o extra√≠do si se tuviera

    divColPt.appendChild(labelPt);
    divColPt.appendChild(inputPt);
    divGrupoMacros.appendChild(divColPt);

    // Input Carbohidratos
    const divColCh = document.createElement('div');
    divColCh.className = 'col-md-3';
    const labelCh = document.createElement('label');
    labelCh.className = 'form-label small mb-1';
    labelCh.htmlFor = `modalMacroCh_${idBase}`;
    labelCh.textContent = '% Carbohidratos';
    const inputCh = document.createElement('input');
    inputCh.type = 'number';
    inputCh.className = 'form-control form-control-sm';
    inputCh.id = `modalMacroCh_${idBase}`;
    inputCh.name = `modalMacroCh_${idBase}`;
    inputCh.min = '0';
    inputCh.max = '100';
    inputCh.value = '40';

    divColCh.appendChild(labelCh);
    divColCh.appendChild(inputCh);
    divGrupoMacros.appendChild(divColCh);

    // Input Grasas
    const divColGr = document.createElement('div');
    divColGr.className = 'col-md-3';
    const labelGr = document.createElement('label');
    labelGr.className = 'form-label small mb-1';
    labelGr.htmlFor = `modalMacroGr_${idBase}`;
    labelGr.textContent = '% Grasas';
    const inputGr = document.createElement('input');
    inputGr.type = 'number';
    inputGr.className = 'form-control form-control-sm';
    inputGr.id = `modalMacroGr_${idBase}`;
    inputGr.name = `modalMacroGr_${idBase}`;
    inputGr.min = '0';
    inputGr.max = '100';
    inputGr.value = '40';

    divColGr.appendChild(labelGr);
    divColGr.appendChild(inputGr);
    divGrupoMacros.appendChild(divColGr);

    // Texto de suma de macros
    const divColSuma = document.createElement('div');
    divColSuma.className = 'col-md-3';
    const divTextoSuma = document.createElement('div');
    divTextoSuma.className = 'form-text text-muted small texto-suma-macros-estrategia'; // Clase CSS del CSS proporcionado
    divTextoSuma.id = `modalSumaMacros_${idBase}`;
    divTextoSuma.textContent = 'Suma: 100%'; // Valor inicial

    // A√±adir listener para actualizar la suma en tiempo real
    const actualizarSuma = () => {
        const pt_val = parseInt(inputPt.value) || 0;
        const ch_val = parseInt(inputCh.value) || 0;
        const gr_val = parseInt(inputGr.value) || 0;
        const suma_val = pt_val + ch_val + gr_val;
        divTextoSuma.textContent = `Suma: ${suma_val}%`;
        // Opcional: A√±adir clases para feedback visual (ok/error)
        divTextoSuma.classList.remove('text-success', 'text-danger');
        if (suma_val === 100) {
            divTextoSuma.classList.add('text-success');
        } else {
            divTextoSuma.classList.add('text-danger');
        }
    };
    inputPt.addEventListener('input', actualizarSuma);
    inputCh.addEventListener('input', actualizarSuma);
    inputGr.addEventListener('input', actualizarSuma);
    // Llamar una vez para inicializar
    actualizarSuma();

    divColSuma.appendChild(divTextoSuma);
    divGrupoMacros.appendChild(divColSuma);

    divFila.appendChild(divGrupoMacros);

    // Crear la secci√≥n de "Aplicar tambi√©n a:"
    const divAplicarA = document.createElement('div');
    divAplicarA.className = 'mt-2 seccion-aplicar-a-estrategia'; // Clase CSS del CSS proporcionado

    const labelAplicarA = document.createElement('label');
    labelAplicarA.className = 'form-label small mb-1'; // Clase CSS del CSS proporcionado
    labelAplicarA.textContent = 'Aplicar tambi√©n a:'; // Texto de la etiqueta

    const divCheckboxesDias = document.createElement('div');
    // Ejemplo de d√≠as (deber√≠a ser din√°mico seg√∫n los d√≠as de la semana)
    const diasSemana = ['Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado']; // Excluyendo Lunes y Domingo como ejemplo
    diasSemana.forEach(dia => {
        const divCheckInline = document.createElement('div');
        divCheckInline.className = 'form-check form-check-inline'; // Clase CSS del CSS proporcionado

        const inputCheckDia = document.createElement('input');
        inputCheckDia.className = 'form-check-input'; // Clase CSS del CSS proporcionado
        inputCheckDia.type = 'checkbox';
        inputCheckDia.id = `modalAplicarA${dia}_${idBase}`;
        inputCheckDia.name = `modalAplicarA_${idBase}`; // Mismo name para agrupar si es necesario
        inputCheckDia.value = dia;

        const labelCheckDia = document.createElement('label');
        labelCheckDia.className = 'form-check-label small'; // Clase CSS del CSS proporcionado
        labelCheckDia.htmlFor = `modalAplicarA${dia}_${idBase}`;
        labelCheckDia.textContent = dia;

        divCheckInline.appendChild(inputCheckDia);
        divCheckInline.appendChild(labelCheckDia);
        divCheckboxesDias.appendChild(divCheckInline);
    });

    divAplicarA.appendChild(labelAplicarA);
    divAplicarA.appendChild(divCheckboxesDias);
    divFila.appendChild(divAplicarA);

    return divFila;
}


// --- Funciones auxiliares para el modal (ya existentes, posiblemente modificadas) ---

/**
 * Actualiza el mensaje de suma de macros en el modal.
 * (Esta funci√≥n puede ser redundante con la l√≥gica de suma por fila, pero la mantengo por si acaso)
 */
function actualizarMensajeSumaMacros() {
    // Esta funci√≥n podr√≠a quedar obsoleta o modificada para funcionar
    // con los nuevos inputs si se decide mantener los inputs generales.
    // Por ahora, la dejo como est√°, pero probablemente no se use.
    const inputPt = document.getElementById('modalInputProteinasPct');
    const inputCh = document.getElementById('modalInputCarbohidratosPct');
    const inputGr = document.getElementById('modalInputGrasasPct');
    const mensajeElement = document.getElementById('modalMensajeSumaMacros');

    if (!inputPt || !inputCh || !inputGr || !mensajeElement) return;

    const pt = parseInt(inputPt.value) || 0;
    const ch = parseInt(inputCh.value) || 0;
    const gr = parseInt(inputGr.value) || 0;
    const suma = pt + ch + gr;

    mensajeElement.textContent = `Suma actual: ${suma}%`;
    mensajeElement.classList.remove('error', 'ok');
    if (suma === 100) {
        mensajeElement.classList.add('ok');
    } else {
        mensajeElement.classList.add('error');
    }
}

/**
 * Aplica los porcentajes de macros configurados para una estrategia espec√≠fica a una fila de la tabla.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {string} estrategiaId - El ID √∫nico de la estrategia (ej: 'carb_cycling').
 * @param {Object} porcentajes - Un objeto con las claves 'proteinas', 'carbohidratos', 'grasas' y valores num√©ricos (%).
 */
function aplicarMacrosPorEstrategia(indiceFila, estrategiaId, porcentajes) {
    console.log(`[Modal Avanzado] Aplicando macros por estrategia '${estrategiaId}' para la fila ${indiceFila}:`, porcentajes);

    try {
        // --- 1. Validar argumentos ---
        if (!indiceFila || !estrategiaId || !porcentajes) {
            console.error("[Modal Avanzado] Faltan argumentos para aplicar macros por estrategia:", { indiceFila, estrategiaId, porcentajes });
            return;
        }

        if (typeof porcentajes !== 'object' || porcentajes === null) {
            console.error("[Modal Avanzado] 'porcentajes' debe ser un objeto v√°lido.", porcentajes);
            return;
        }

        const pt_pct = parseFloat(porcentajes.proteinas);
        const ch_pct = parseFloat(porcentajes.carbohidratos);
        const gr_pct = parseFloat(porcentajes.grasas);

        if (isNaN(pt_pct) || isNaN(ch_pct) || isNaN(gr_pct)) {
            console.error("[Modal Avanzado] Todos los porcentajes deben ser n√∫meros v√°lidos.", porcentajes);
            return;
        }

        const suma = pt_pct + ch_pct + gr_pct;
        if (Math.abs(suma - 100) > 0.1) { // Tolerancia para errores de punto flotante
            console.warn(`[Modal Avanzado] Advertencia: La suma de porcentajes (${suma}%) para la estrategia '${estrategiaId}' no es 100%. Se proceder√° con el c√°lculo.`);
            // O decidir si quieres detener la ejecuci√≥n aqu√≠.
            // alert(`Advertencia: La suma de porcentajes (${suma}%) para la estrategia '${estrategiaId}' no es 100%.`);
        }

        // --- 2. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`[Modal Avanzado] No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;
        const estrategiasDisponibles = tablaElement.estrategiasDisponibles || [];

        // Encontrar los datos originales espec√≠ficos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`[Modal Avanzado] √çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`[Modal Avanzado] No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            return;
        }

        // --- 4. Obtener el nivel de actividad actual de la fila ---
        const selectActividadElement = document.getElementById(`select-actividad-${indiceFila}`);
        let actividadActual = datosFilaOriginal.actividad; // Valor por defecto
        if (selectActividadElement) {
            actividadActual = parseFloat(selectActividadElement.value);
            if (isNaN(actividadActual)) {
                console.warn(`[Modal Avanzado] Nivel de actividad inv√°lido en select para fila ${indiceFila}. Usando original.`);
                actividadActual = datosFilaOriginal.actividad;
            }
        }

        // --- 5. Recalcular TMB y TDEE usando el peso estimado actual de la fila ---
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;

        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
            console.error("[Modal Avanzado] Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
            return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calcular TDEE usando el TMB reci√©n calculado y la actividad actual
        const tdeeActual = tmbActual * actividadActual;

        // --- 6. Calcular nuevas calor√≠as diarias objetivo ---
        let nuevasCaloriasDiarias = tdeeActual;
        // Aqu√≠ no aplicamos ajusteCaloriasDiarioManual porque esta funci√≥n se llama desde el modal
        // y el ajuste ya se aplic√≥ en actualizarFilaPorActividad o actualizarFilaPorEstrategias.
        // Si se necesita aplicar un ajuste espec√≠fico de esta estrategia, se har√≠a aqu√≠.
        // Por ahora, asumimos que las calor√≠as ya est√°n ajustadas por otras funciones.

        // --- 7. Usar los nuevos porcentajes proporcionados ---
        let nuevasProteinasPctDia = pt_pct;
        let nuevasCarbohidratosPctDia = ch_pct;
        let nuevasGrasasPctDia = gr_pct;

        // --- 8. Asegurar que los porcentajes sumen 100% ---
        // Ya se valid√≥ la suma, pero si se quiere forzar ajuste:
        /*
        const totalPct = nuevasProteinasPctDia + nuevasCarbohidratosPctDia + nuevasGrasasPctDia;
        if (Math.abs(totalPct - 100) > 0.1) {
            const diff = 100 - totalPct;
            nuevasGrasasPctDia += diff;
            console.warn(`[Modal Avanzado] Porcentajes ajustados en Fila ${indiceFila} para sumar 100%.`);
        }
        */

        // --- 9. Calcular nuevos gramos de macros ---
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 10. Asegurar un m√≠nimo de calor√≠as por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`[Modal Avanzado] Calor√≠as ajustadas en Fila ${indiceFila} por debajo del l√≠mite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 11. Actualizar la UI ---
        // a. Actualizar celda de calor√≠as
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // b. Actualizar celdas de macros (% y g)
        // Celda % Pt y g (primera .text-center)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        // Celda % CH y g (segunda .text-center)
        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        // Celda % GR y g (tercera .text-center)
        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // c. (Opcional) Actualizar celda de notas para indicar el cambio de macros por estrategia
        // Esta parte es m√°s compleja porque implica parsear y reconstruir la nota.
        // Se puede hacer, pero requiere m√°s l√≥gica para identificar y reemplazar la parte de macros.
        // Por ahora, se omite o se deja para una actualizaci√≥n posterior de la nota completa.

        console.log(`[Modal Avanzado] Macros aplicados con √©xito por estrategia '${estrategiaId}' en fila ${indiceFila}.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g
        });

    } catch (error) {
        console.error(`[Modal Avanzado] Error al aplicar macros por estrategia '${estrategiaId}' en fila ${indiceFila}:`, error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert(`Hubo un error al aplicar los macros para la estrategia '${estrategiaId}'. Por favor, int√©ntalo de nuevo.`);
    }
}
// --- Event Listeners (ya existentes, posiblemente modificadas) ---

// A√±adir listeners para actualizar el mensaje de suma en tiempo real (inputs generales)
// (Este listener podr√≠a eliminarse si los inputs generales se eliminan por completo)
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('editarFilaModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function () {
            const inputsMacros = modal.querySelectorAll('#modalInputProteinasPct, #modalInputCarbohidratosPct, #modalInputGrasasPct');
            inputsMacros.forEach(input => {
                input.addEventListener('input', actualizarMensajeSumaMacros);
            });
            // Inicializar mensaje
            actualizarMensajeSumaMacros();
        });
    }
});

// Manejador del bot√≥n "Aplicar Cambios" del modal
document.addEventListener('click', function (event) {
    if (event.target && event.target.id === 'modalBotonAplicar') {
        event.preventDefault();
        const indiceFila = event.target.getAttribute('data-indice-fila');
        if (indiceFila) {
            aplicarCambiosDesdeModal(indiceFila);
        } else {
            console.error("No se encontr√≥ el √≠ndice de fila en el bot√≥n Aplicar.");
            alert("Error al aplicar cambios: √çndice de fila no encontrado.");
        }
    }
});

/**
 * Recoge los valores del modal y aplica los cambios a la fila correspondiente.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 */
function aplicarCambiosDesdeModal(indiceFila) {
    console.log(`Aplicando cambios desde el modal para la fila: ${indiceFila}`);

    // --- 1. Recoger valores del modal ---
    const nuevaActividad = parseFloat(document.getElementById('modalSelectActividad').value);
    if (isNaN(nuevaActividad)) {
        alert("Error: Nivel de actividad inv√°lido.");
        return;
    }

    // Recoger estrategias seleccionadas
    const checkboxesEstrategias = document.querySelectorAll('#modalCheckboxesEstrategias input[type="checkbox"]:checked');
    const nuevasEstrategias = Array.from(checkboxesEstrategias).map(cb => cb.value);
    console.log("Estrategias seleccionadas en el modal:", nuevasEstrategias);

    // Recoger macros
    const inputPt = document.getElementById('modalInputProteinasPct');
    const inputCh = document.getElementById('modalInputCarbohidratosPct');
    const inputGr = document.getElementById('modalInputGrasasPct');

    let nuevosPorcentajes = null;
    if (inputPt && inputCh && inputGr) {
        const pt = parseInt(inputPt.value);
        const ch = parseInt(inputCh.value);
        const gr = parseInt(inputGr.value);
        const suma = pt + ch + gr;

        if (!isNaN(pt) && !isNaN(ch) && !isNaN(gr)) {
            if (suma === 100) {
                nuevosPorcentajes = { proteinas: pt, carbohidratos: ch, grasas: gr };
            } else {
                alert(`Error: La suma de los porcentajes de macros debe ser 100%. Actual: ${suma}%.`);
                // Resaltar el mensaje de error
                actualizarMensajeSumaMacros();
                const mensajeElement = document.getElementById('modalMensajeSumaMacros');
                if (mensajeElement) mensajeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return; // Detener la aplicaci√≥n de cambios
            }
        } else {
            // Si los inputs est√°n vac√≠os o no son n√∫meros v√°lidos, no se aplican cambios de macros
            console.log("Valores de macros inv√°lidos o vac√≠os, no se aplicar√°n cambios de macros.");
        }
    }

    // (Nuevo) Recoger Ajuste de Calor√≠as
    let ajusteCaloriasDiarioManual = null; // null indica que no se cambia
    const inputAjusteCalorias = document.getElementById('modalInputAjusteCalorias');
    if (inputAjusteCalorias && inputAjusteCalorias.value !== "") {
        const valorIngresado = parseFloat(inputAjusteCalorias.value);
        if (!isNaN(valorIngresado)) {
            ajusteCaloriasDiarioManual = valorIngresado;
            console.log(`Ajuste de calor√≠as manual solicitado: ${ajusteCaloriasDiarioManual} kcal/d√≠a`);
        } else {
            console.warn("Valor inv√°lido en el input de ajuste de calor√≠as. Se ignorar√°.");
        }
    }

    // --- 2. Aplicar cambios ---
    try {
        // a. Cambiar actividad (esto recalcular√° calor√≠as y macros base)
        // Pasamos el ajuste manual como par√°metro adicional

        actualizarFilaPorActividad(indiceFila, nuevaActividad.toString(), ajusteCaloriasDiarioManual);

        // b. Cambiar estrategias (esto recalcula lo necesario basado en las nuevas estrategias y puede ajustar calor√≠as/macros)
        // Pasamos un array de strings directamente Y el ajuste manual para que actualice la nota correctamente
        actualizarFilaPorEstrategias(indiceFila, nuevasEstrategias);

        // c. Cambiar macros manualmente (si se proporcionaron)
        // Esto se hace al final para que sobrescriba cualquier c√°lculo previo de macros
        if (nuevosPorcentajes) {
            if (typeof actualizarFilaPorMacros === 'function') {
                // Pasamos el ajuste manual a esta funci√≥n tambi√©n
                actualizarFilaPorMacros(indiceFila, nuevosPorcentajes, ajusteCaloriasDiarioManual);
            } else {
                console.warn("La funci√≥n 'actualizarFilaPorMacros' no est√° definida. Los cambios de macros manuales no se aplicar√°n.");
                // Opcional: alert("Nota: Los ajustes manuales de macros no se pudieron aplicar...");
            }
        }

        console.log("Cambios aplicados con √©xito desde el modal.");
        // Cerrar el modal
        const modalElement = document.getElementById('editarFilaModal');
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) {
            modalInstance.hide();
        }

    } catch (error) {
        console.error("Error al aplicar cambios desde el modal:", error);
        alert("Hubo un error al aplicar los cambios. Por favor, int√©ntalo de nuevo.");
    }
}

// --- A√±adir doble clic a las celdas de D√≠a ---
// Usando delegaci√≥n de eventos en el documento (se ejecuta una vez cargado el DOM)
document.addEventListener('dblclick', function (event) {
    // Verificar si el elemento clickeado (o un ancestro) es una celda <td> de la primera columna (D√≠a)
    const celdaDia = event.target.closest('tbody td:first-child');

    if (celdaDia) {
        // Encontrar la fila <tr> contenedora
        const fila = celdaDia.closest('tr');
        if (fila && fila.id && fila.id.startsWith('fila-detalle-')) {
            // Extraer el indiceFila del ID de la fila
            const indiceFila = fila.id.replace('fila-detalle-', '');
            if (indiceFila) {
                console.log(`Doble clic detectado en la fila: ${indiceFila}`);
                abrirModalEdicion(indiceFila);
            }
        }
    }
});

/**
 * Actualiza una fila de la tabla detallada cuando se cambian los porcentajes de macros manualmente.
 * Recalcula gramos de macros y calor√≠as basados en los nuevos porcentajes y el TDEE actual.
 * @param {string} indiceFila - El √≠ndice de la fila (formato "mes-semana-dia").
 * @param {Object} nuevosPorcentajes - Un objeto con las nuevas claves `proteinas`, `carbohidratos`, `grasas` (valores enteros o float).
 */
// Modifica la firma de la funci√≥n
function actualizarFilaPorMacros(indiceFila, nuevosPorcentajes, ajusteCaloriasDiarioManual = null) {
    console.log(`Actualizando fila ${indiceFila} por cambio manual de macros a:`, nuevosPorcentajes, `. Ajuste manual: ${ajusteCaloriasDiarioManual}`);
    // ... resto de la funci√≥n ...

    // --- Validaci√≥n de entrada ---
    if (!nuevosPorcentajes || typeof nuevosPorcentajes !== 'object') {
        console.error("Error: nuevosPorcentajes debe ser un objeto con claves 'proteinas', 'carbohidratos', 'grasas'.");
        // Opcional: alert("Error: Formato de porcentajes inv√°lido.");
        return;
    }

    const pt_pct = parseFloat(nuevosPorcentajes.proteinas);
    const ch_pct = parseFloat(nuevosPorcentajes.carbohidratos);
    const gr_pct = parseFloat(nuevosPorcentajes.grasas);

    if (isNaN(pt_pct) || isNaN(ch_pct) || isNaN(gr_pct)) {
        console.error("Error: Todos los porcentajes deben ser n√∫meros v√°lidos.", nuevosPorcentajes);
        // Opcional: alert("Error: Porcentajes de macros inv√°lidos.");
        return;
    }

    const suma = pt_pct + ch_pct + gr_pct;
    if (Math.abs(suma - 100) > 0.1) { // Tolerancia para errores de punto flotante
        console.warn(`Advertencia: La suma de porcentajes (${suma}%) no es exactamente 100%. Se proceder√° con el c√°lculo.`);
        // O decidir si quieres detener la ejecuci√≥n aqu√≠.
        // alert(`Advertencia: La suma de porcentajes (${suma}%) no es 100%.`);
    }

    try {
        // --- 1. Encontrar la fila y la tabla contenedora ---
        const filaElement = document.getElementById(`fila-detalle-${indiceFila}`);
        if (!filaElement) {
            console.error(`No se encontr√≥ la fila con ID 'fila-detalle-${indiceFila}'.`);
            return;
        }

        const tablaElement = filaElement.closest('table.tabla-planificacion');
        if (!tablaElement) {
            console.error(`No se encontr√≥ la tabla contenedora para la fila ${indiceFila}.`);
            return;
        }

        // --- 2. Obtener datos base almacenados en la tabla ---
        const datosFaseBase = tablaElement.datosFaseBase;
        const datosFilasOriginales = tablaElement.datosFilasOriginales;

        // Encontrar los datos originales espec√≠ficos para esta fila
        const partesIndice = indiceFila.toString().split('-');
        const indiceDiaArray = parseInt(partesIndice[partesIndice.length - 1], 10);

        if (isNaN(indiceDiaArray) || indiceDiaArray < 0 || indiceDiaArray > 6) {
            console.error(`√çndice de d√≠a inv√°lido en 'data-indice-fila': ${indiceFila}`);
            return;
        }

        const datosFilaOriginal = datosFilasOriginales[indiceDiaArray];
        if (!datosFilaOriginal) {
            console.error(`No se encontraron datos originales para el d√≠a ${indiceDiaArray} en la fila ${indiceFila}.`);
            return;
        }

        // --- 3. Recalcular TMB y TDEE para el peso estimado actual de la fila ---
        // Obtenemos el peso estimado actual directamente de los datos originales de la fila.
        // Este peso ya refleja la estimaci√≥n para el inicio de la semana a la que pertenece el d√≠a.
        const pesoEstimadoKg = datosFilaOriginal.pesoEstimado;

        // Obtenemos la actividad actual del select de la fila.
        const selectActividadElement = document.getElementById(`select-actividad-${indiceFila}`);
        let actividadActual = datosFilaOriginal.actividad; // Valor por defecto
        if (selectActividadElement) {
            actividadActual = parseFloat(selectActividadElement.value);
            if (isNaN(actividadActual)) {
                console.warn(`Nivel de actividad inv√°lido en select para fila ${indiceFila}. Usando original.`);
                actividadActual = datosFilaOriginal.actividad;
            }
        }

        // Recalcular TMB usando las variables globales userGender, userHeightCm, userAge
        // que se asume est√°n disponibles (igual que en generarDatosTablaDetallada).
        let tmbActual = 0;
        if (typeof userGender === 'undefined' || typeof userHeightCm === 'undefined' || typeof userAge === 'undefined') {
            console.error("Variables de usuario (userGender, userHeightCm, userAge) no definidas. No se puede calcular TMB.");
            return;
        }
        if (userGender === 'male') {
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) + 5;
        } else { // Asumimos 'female' si no es 'male'
            tmbActual = (10 * pesoEstimadoKg) + (6.25 * userHeightCm) - (5 * userAge) - 161;
        }

        // Calcular TDEE usando el TMB reci√©n calculado y la actividad actual
        const tdeeActual = tmbActual * actividadActual;

        console.log(`Fila ${indiceFila}: TMB calculado=${tmbActual.toFixed(2)}, TDEE calculado=${tdeeActual.toFixed(2)}, Actividad=${actividadActual}`);

        // --- 4. Calcular nuevas calor√≠as diarias objetivo ---
        // Aplicar el ajuste cal√≥rico semanal existente
        let nuevasCaloriasDiarias = tdeeActual;
        // Priorizar el ajuste manual si se proporciona
        if (ajusteCaloriasDiarioManual !== null) {
            nuevasCaloriasDiarias += ajusteCaloriasDiarioManual;
            console.log(`Usando ajuste de calor√≠as manual: ${ajusteCaloriasDiarioManual} kcal/d√≠a`);
        } else {
            // Si no hay ajuste manual, usar el ajuste semanal global
            const ajusteCaloriasSemanal = weeklyCalorieDiffManualGlobal; // Puede ser null/number
            const ajusteCaloriasDiarioGlobal = ajusteCaloriasSemanal !== null ? ajusteCaloriasSemanal / 7 : 0;
            nuevasCaloriasDiarias += ajusteCaloriasDiarioGlobal;
            console.log(`Usando ajuste de calor√≠as global: ${ajusteCaloriasDiarioGlobal} kcal/d√≠a`);
        }

        // --- 5. Usar los nuevos porcentajes proporcionados ---
        let nuevasProteinasPctDia = pt_pct;
        let nuevasCarbohidratosPctDia = ch_pct;
        let nuevasGrasasPctDia = gr_pct;

        // --- 6. Calcular nuevos gramos de macros ---
        // Nota: Si decides que los porcentajes deben redistribuirse para sumar 100%,
        // puedes hacerlo aqu√≠. Pero por ahora, asumimos que el usuario sabe lo que hace
        // o que la validaci√≥n en el modal lo forz√≥ a 100%.
        const nuevasProteinas_g = Math.round((nuevasCaloriasDiarias * nuevasProteinasPctDia / 100) / 4);
        const nuevasCarbohidratos_g = Math.round((nuevasCaloriasDiarias * nuevasCarbohidratosPctDia / 100) / 4);
        const nuevasGrasas_g = Math.round((nuevasCaloriasDiarias * nuevasGrasasPctDia / 100) / 9);

        // --- 7. Asegurar un m√≠nimo de calor√≠as por seguridad ---
        const limiteCaloriasMin = (typeof userGender !== 'undefined' && userGender === 'female') ? 1200 : 1500;
        if (nuevasCaloriasDiarias < limiteCaloriasMin) {
            console.warn(`Calor√≠as ajustadas en Fila ${indiceFila} por debajo del l√≠mite (${limiteCaloriasMin}).`);
            nuevasCaloriasDiarias = limiteCaloriasMin;
        }

        // --- 8. Actualizar la UI ---
        // Actualizar celda de calor√≠as
        const celdaCalorias = document.getElementById(`calorias-${indiceFila}`);
        if (celdaCalorias) {
            celdaCalorias.textContent = Math.round(nuevasCaloriasDiarias);
        }

        // Actualizar celdas de macros (% y g)
        // Celda % Pt y g (primera .text-center)
        const celdasPt = filaElement.querySelectorAll('td.text-center')[0];
        if (celdasPt) {
            celdasPt.innerHTML = `<strong>${Math.round(nuevasProteinasPctDia)}%</strong><br><small>${nuevasProteinas_g}g</small>`;
        }

        // Celda % CH y g (segunda .text-center)
        const celdasCH = filaElement.querySelectorAll('td.text-center')[1];
        if (celdasCH) {
            celdasCH.innerHTML = `<strong>${Math.round(nuevasCarbohidratosPctDia)}%</strong><br><small>${nuevasCarbohidratos_g}g</small>`;
        }

        // Celda % GR y g (tercera .text-center)
        const celdasGR = filaElement.querySelectorAll('td.text-center')[2];
        if (celdasGR) {
            celdasGR.innerHTML = `<strong>${Math.round(nuevasGrasasPctDia)}%</strong><br><small>${nuevasGrasas_g}g</small>`;
        }

        // Opcional: Actualizar celda de notas para indicar el cambio manual
        // Actualizar celda de notas para reflejar los cambios
        const celdaNotas = document.getElementById(`notas-${indiceFila}`);
        if (celdaNotas) {
            // Intentar reconstruir la nota base con el nuevo ajuste
            let notaActual = celdaNotas.textContent || "";
            // Extraer TDEE de la nota actual o usar tdeeActual calculado
            let tdeeMostrado = tdeeActual; // Por defecto, el calculado
            const matchTDEE = notaActual.match(/TDEE estimado \((\d+) kcal\)/);
            if (matchTDEE) {
                tdeeMostrado = parseFloat(matchTDEE[1]) || tdeeMostrado;
            }

            let nuevaNotaBase = `Basado en TDEE estimado (${tdeeMostrado.toFixed(0)} kcal)`;
            if (ajusteCaloriasDiarioManual !== null) {
                nuevaNotaBase += ` y ajuste manual.`;
                nuevaNotaBase += ` Ajuste diario: ${ajusteCaloriasDiarioManual > 0 ? '+' : ''}${ajusteCaloriasDiarioManual.toFixed(0)} kcal.`;
            } else {
                // Si no se aplic√≥ un ajuste manual nuevo, intentar conservar el ajuste anterior de la nota
                const matchAjusteAnterior = notaActual.match(/Ajuste diario: ([+-]?\d+) kcal/);
                if (matchAjusteAnterior) {
                    nuevaNotaBase += ` y ajuste objetivo.`;
                    nuevaNotaBase += ` Ajuste diario: ${matchAjusteAnterior[1]} kcal.`;
                } else {
                    nuevaNotaBase += `.`; // Punto final si no hay ajuste
                }
            }
            // Extraer estrategias aplicadas de la nota actual
            let parteEstrategias = "";
            const matchEstrategias = notaActual.match(/Estrategias aplicadas: (.+)/);
            if (matchEstrategias) {
                parteEstrategias = `. Estrategias aplicadas: ${matchEstrategias[1]}`;
            }

            // Combinar todo
            const notaCompletaActualizada = nuevaNotaBase + parteEstrategias;
            celdaNotas.textContent = notaCompletaActualizada;
        }

        console.log(`Fila ${indiceFila} actualizada con √©xito por macros manuales.`);
        console.log({
            nuevasCaloriasDiarias,
            nuevasProteinasPctDia,
            nuevasCarbohidratosPctDia,
            nuevasGrasasPctDia,
            nuevasProteinas_g,
            nuevasCarbohidratos_g,
            nuevasGrasas_g
        });

    } catch (error) {
        console.error("Error al actualizar la fila por cambio de macros:", error);
        // Opcional: Mostrar mensaje de error al usuario
        // alert("Hubo un error al actualizar los macros. Por favor, int√©ntalo de nuevo.");
    }
}




// --- Event Listener para el bot√≥n "Aplicar Cambios" del modal ---
document.addEventListener('click', function (event) {
    if (event.target && event.target.id === 'modalBotonAplicar') {
        event.preventDefault();
        console.log("[Modal Edici√≥n] Bot√≥n 'Aplicar Cambios' clickeado.");

        // Obtener el √≠ndice de fila asociado al bot√≥n
        const indiceFila = event.target.getAttribute('data-indice-fila');
        if (indiceFila) {
            // Llamar a la nueva funci√≥n que recoge datos del modal y aplica cambios
            aplicarCambiosDesdeModalAvanzado(indiceFila);
        } else {
            console.error("[Modal Edici√≥n] No se encontr√≥ el √≠ndice de fila en el bot√≥n Aplicar.");
            alert("Error al aplicar cambios: √çndice de fila no encontrado.");
        }
    }
});


function inicializarBotonColapsarTodo() {
    const btn = document.getElementById('btnColapsarTodo');
    const planificacionTemporal = document.getElementById('planificacionTemporal');
    const tablaDetalladaFase = document.getElementById('tablaDetalladaFaseContainer');

    if (!btn) {
        console.warn("Bot√≥n 'btnColapsarTodo' no encontrado.");
        return;
    }

    btn.addEventListener('click', function () {
        // Verificar si al menos uno de los dos contenedores est√° visible (display !== 'none')
        const estaVisible =
            planificacionTemporal.style.display !== 'none' ||
            (tablaDetalladaFase && tablaDetalladaFase.style.display !== 'none');

        // Decidimos la acci√≥n: si alguno est√° visible ‚Üí colapsar, si ambos est√°n ocultos ‚Üí expandir
        if (estaVisible) {
            // COLAPSAR: ocultar ambos
            if (planificacionTemporal) planificacionTemporal.style.display = 'none';
            if (tablaDetalladaFase) tablaDetalladaFase.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-expand"></i> Expandir Todo';
        } else {
            // EXPANDIR: mostrar ambos solo si tienen contenido
            // Nota: no cambiamos a 'block' si nunca fueron mostrados antes, pero aqu√≠ forzamos si tienen innerHTML
            if (planificacionTemporal && planificacionTemporal.innerHTML.trim() !== '') {
                planificacionTemporal.style.display = 'block';
            }
            if (tablaDetalladaFase && tablaDetalladaFase.innerHTML.trim() !== '' && !tablaDetalladaFase.querySelector('.info-message')) {
                tablaDetalladaFase.style.display = 'block';
            }

            btn.innerHTML = '<i class="fas fa-compress"></i> Colapsar Todo';
        }
    });
}


// Llama a la funci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function () {
    inicializarBotonColapsarTodo();
});



//////////////////////////////////////////////////////////
// Funci√≥n para depurar faseData
function debugFaseData() {
    const modal = document.getElementById('editModal');
    if (!modal) {
        console.log("‚ö†Ô∏è Modal no encontrado en el DOM");
        return;
    }

    console.log("üîç Iniciando depuraci√≥n de faseData...");

    // 1. Mostrar todos los atributos data del modal
    console.log("üìå Atributos data del modal:");
    const dataAttributes = {};
    for (let i = 0; i < modal.attributes.length; i++) {
        const attr = modal.attributes[i];
        if (attr.name.startsWith('data-')) {
            dataAttributes[attr.name] = attr.value;
        }
    }
    console.log(dataAttributes);

    // 2. Obtener y mostrar faseDataStr
    const faseDataStr = modal.getAttribute('data-fase-data');
    console.log("\nüìù Contenido crudo de data-fase-data:");
    console.log(faseDataStr || "(vac√≠o)");

    // 3. Intentar parsear faseDataStr
    try {
        if (faseDataStr) {
            const faseData = JSON.parse(faseDataStr);
            console.log("\n‚úÖ faseData parseado correctamente:");
            console.dir(faseData);

            // 4. Mostrar estructura detallada
            console.log("\nüîç Estructura detallada de faseData:");
            if (faseData.pesoInicial) console.log(`- pesoInicial: ${faseData.pesoInicial} kg`);
            if (faseData.objetivo) console.log(`- objetivo: ${faseData.objetivo}`);
            if (faseData.fase) console.log(`- fase: ${faseData.fase}`);
            if (faseData.strategyId) console.log(`- strategyId: ${faseData.strategyId}`);
            if (faseData.kcalObjetivo) console.log(`- kcalObjetivo: ${faseData.kcalObjetivo} kcal`);
            if (faseData.porcentajeGrasaInicial !== undefined) {
                console.log(`- porcentajeGrasaInicial: ${faseData.porcentajeGrasaInicial}%`);
            }
            if (faseData.estrategiaBase) {
                console.log("- estrategiaBase:", {
                    id: faseData.estrategiaBase.id,
                    title: faseData.estrategiaBase.title,
                    aplicable: faseData.estrategiaBase.aplicable
                });
            }
        } else {
            console.warn("‚ö†Ô∏è data-fase-data est√° vac√≠o. El modal no tiene datos de fase almacenados.");

            // 5. Mostrar d√≥nde deber√≠a estar almacenado
            console.log("\nüí° Posibles causas:");
            console.log("- No se llam√≥ a openEditModal correctamente");
            console.log("- No se estableci√≥ data-fase-data al abrir el modal");
            console.log("- Se est√° intentando acceder a faseData antes de que se inicialice");
        }
    } catch (error) {
        console.error("\n‚ùå Error al parsear data-fase-data:", error);
        console.log("Contenido que caus√≥ el error:", faseDataStr);
        console.log("\nüí° Posibles causas del error de parseo:");
        console.log("- El JSON est√° mal formateado");
        console.log("- Hay caracteres no v√°lidos en el string JSON");
        console.log("- El objeto fue serializado incorrectamente");
    }

    // 6. Mostrar d√≥nde se deber√≠a estar llamando esta funci√≥n
    console.log("\nüìå Para que esto funcione correctamente:");
    console.log("- Llama a debugFaseData() despu√©s de que el modal se haya abierto");
    console.log("- La mejor ubicaci√≥n es en el evento 'shown.bs.modal'");
    console.log("Ejemplo: editModal.addEventListener('shown.bs.modal', debugFaseData);");
}

// Configurar para que se ejecute cuando el modal se muestra
document.addEventListener('DOMContentLoaded', function () {
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('shown.bs.modal', function () {
            setTimeout(debugFaseData, 100); // Peque√±o retraso para asegurar que los datos est√©n listos
        });
    }
});
//////////////////////FUNCIONES PARA NUTRIPLAN WEB////////////////////
// FUNCIONALIDAD PDF
document.getElementById("save-pdf-button").addEventListener("click", async function () {
    // Convertir gr√°ficos a im√°genes
    const charts = document.querySelectorAll('canvas');
    const promises = Array.from(charts).map(chart => {
        return new Promise(resolve => {
            const image = new Image();
            image.src = chart.toDataURL();
            image.onload = () => {
                const img = document.createElement('img');
                img.src = image.src;
                img.style.maxWidth = '90%';
                chart.parentNode.replaceChild(img, chart);
                resolve();
            };
        });
    });

    await Promise.all(promises);

    const opt = {
        margin: [5, 5, 5, 5],
        filename: 'Plan_Nutricional.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: {
            scale: 2,
            scrollY: 0,
            useCORS: true,
            allowTaint: true,
            logging: true
        },
        jsPDF: {
            unit: 'mm',
            format: 'a4',
            orientation: 'portrait'
        },
        pagebreak: { mode: 'avoid-all' }
    };

    const element = document.documentElement;
    html2pdf().set(opt).from(element).save().then(() => {
        // Restaurar los canvas despu√©s de la exportaci√≥n
        charts.forEach((chart, index) => {
            const img = chart.parentNode.querySelector('img');
            if (img) img.replaceWith(chart);
        });
    });
});

// --- PDF Generation ---
function guardarComoPDF2() {
    if (!calculatedTDEE) {
        alert("Por favor, completa al menos el Paso 1 (C√°lculo de Necesidades) antes de generar el PDF.");
        return;
    }

    const mainElement = document.querySelector('main');
    const headerElement = document.querySelector('header');
    const footerElement = document.querySelector('footer');
    const allButtons = document.querySelectorAll('button'); // Select all buttons

    // Hide elements not needed in PDF
    if (headerElement) headerElement.style.display = 'none';
    if (footerElement) footerElement.style.display = 'none';
    allButtons.forEach(btn => btn.style.display = 'none');

    // Temporarily make chart containers visible if they have content
    const chartContainers = document.querySelectorAll('#chart-container, #weight-chart-container, #time-estimation-chart-container');
    const originalDisplayStyles = [];
    chartContainers.forEach(container => {
        originalDisplayStyles.push(container.style.display);
        if (container.querySelector('canvas') && container.style.display === 'none') {
            container.style.display = 'block';
        }
    });

    const opt = {
        margin: [15, 10, 15, 10],
        filename: 'NutriPlan_Plan_Dietetico_Personalizado.pdf',
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: { scale: 2, useCORS: true, logging: false, windowWidth: mainElement.scrollWidth, windowHeight: mainElement.scrollHeight },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.plan-step' }
    };

    console.log("Generating PDF...");
    html2pdf().from(mainElement).set(opt).save().then(() => {
        console.log("PDF generated successfully.");
        // Restore visibility
        if (headerElement) headerElement.style.display = 'flex';
        if (footerElement) footerElement.style.display = 'block';
        allButtons.forEach(btn => btn.style.display = 'block');
        chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
    }).catch(err => {
        console.error("Error generating PDF:", err);
        alert("Hubo un error al generar el PDF. Revisa la consola del navegador (F12) para m√°s detalles.");
        // Restore visibility even on error
        if (headerElement) headerElement.style.display = 'flex';
        if (footerElement) footerElement.style.display = 'block';
        allButtons.forEach(btn => btn.style.display = 'block');
        chartContainers.forEach((container, index) => { container.style.display = originalDisplayStyles[index]; });
    });
}


// Ensure Firebase is loaded
if (typeof firebase === 'undefined') {
    console.error('Firebase SDK not loaded. Ensure firebase-app.js and firebase-auth.js are included in the <head>.');
    var errorDiv = document.createElement('div');
    errorDiv.style.color = 'red';
    errorDiv.style.marginBottom = '10px';
    errorDiv.style.fontSize = '14px';
    errorDiv.style.textAlign = 'center';
    errorDiv.textContent = 'Error: No se pudo cargar Firebase. Contacta al administrador.';
    document.querySelector('main').insertBefore(errorDiv, document.querySelector('main').firstChild);
} else {
    // Initialize UI
    function initializeUI() {
        document.getElementById('logo').addEventListener('click', function (event) {
            event.preventDefault();
            var dropdown = document.getElementById('dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', function (event) {
            var dropdown = document.getElementById('dropdown');
            var logo = document.getElementById('logo');
            if (!logo.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        window.logout = logout;
    }

    // Logout function needs to be defined or imported. 
    // Since it was inline, we define it here or rely on it being global if we move it to config (but config shouldn't have app logic).
    // Actually, the logout function uses 'auth' which is now initialized in config.
    // We need to make sure 'auth' is available. 
    // In the original code 'auth' was var auth = firebase.auth();
    // We should add that line back or ensure it's accessible.

    var auth = firebase.auth();
    initializeUI();
}
